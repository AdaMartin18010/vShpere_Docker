# 高可用架构设计

> **返回**: [混合架构设计首页](README.md) | [混合部署架构首页](../README.md) | [部署指南首页](../../00_索引导航/README.md)

---

## 📋 目录

- [高可用架构设计](#高可用架构设计)
  - [📋 目录](#-目录)
  - [1. 跨平台高可用](#1-跨平台高可用)
  - [2. 容灾方案](#2-容灾方案)
  - [3. 故障切换](#3-故障切换)
  - [4. 灰度发布](#4-灰度发布)

---

## 1. 跨平台高可用

**虚拟机高可用 (VMware HA)**:

```yaml
vSphere HA 配置:
  - 故障检测: 心跳+数据存储
  - 主机隔离响应: 关闭虚拟机
  - VM重启优先级: 高/中/低
  - 准入控制: 预留25%资源
```

**Kubernetes高可用**:

```yaml
控制平面HA:
  - Master节点: 3/5节点 (etcd quorum)
  - API Server: 多副本 + LB
  - etcd: 集群部署 (Raft协议)

应用层HA:
  - Deployment: replicas ≥ 3
  - PodDisruptionBudget: maxUnavailable=1
  - 反亲和性: 跨节点部署
```

**跨平台故障转移**:

```text
方案1: DNS切换
  VM故障 → 更新DNS → 容器接管流量

方案2: 服务网格
  Istio故障注入 → 自动切换到备用服务

方案3: 数据库读写分离
  主库(VM)故障 → 只读副本(容器)提升为主
```

---

## 2. 容灾方案

**同城双活**:

```text
数据中心A (主)          数据中心B (备)
├─ VM集群 (50%)    ←→  VM集群 (50%)
├─ K8s集群 (50%)   ←→  K8s集群 (50%)
└─ 存储同步复制 (vSAN + Ceph)
```

**异地灾备**:

```text
生产中心 (RPO=0, RTO=15min)
  ├─ 同步复制 → 同城灾备中心
  └─ 异步复制 → 异地灾备中心 (RPO=1h, RTO=4h)
```

**备份策略**:

- **VM备份**: Veeam全量+增量
- **容器备份**: Velero (应用+PV)
- **数据库备份**: 每日全量 + 每小时增量

---

## 3. 故障切换

**自动故障切换**:

```yaml
# Kubernetes健康检查
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  periodSeconds: 5
```

**手动故障切换**:

```bash
# 流量从VM切换到容器
# 1. 更新Istio VirtualService权重
kubectl patch virtualservice app \
  --type merge \
  -p '{"spec":{"http":[{"route":[{"destination":{"host":"app-vm"},"weight":0},{"destination":{"host":"app-k8s"},"weight":100}]}]}}'

# 2. 验证流量
kubectl logs -f deploy/app-k8s

# 3. 监控告警
curl http://prometheus:9090/api/v1/query?query=up{job="app"}
```

---

## 4. 灰度发布

**金丝雀发布 (Canary)**:

```yaml
# Istio金丝雀发布
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: app-canary
spec:
  hosts:
  - app.example.com
  http:
  - match:
    - headers:
        user-type:
          exact: "internal"  # 内部用户测试新版本
    route:
    - destination:
        host: app
        subset: v2-canary
  - route:
    - destination:
        host: app
        subset: v1-stable
      weight: 95
    - destination:
        host: app
        subset: v2-canary
      weight: 5  # 5%流量到新版本
```

**蓝绿发布 (Blue-Green)**:

```text
Blue环境 (当前版本) ← 100%流量
Green环境 (新版本) ← 0%流量
→ 验证通过后，一次性切换100%流量到Green
→ Blue环境保留，可快速回滚
```

**A/B测试**:

```yaml
# 基于用户标签的流量分割
- match:
  - headers:
      user-group:
        exact: "A"
  route:
  - destination:
      host: app
      subset: version-a
- match:
  - headers:
      user-group:
        exact: "B"
  route:
  - destination:
      host: app
      subset: version-b
```

---

**更新时间**: 2025-10-19  
**文档版本**: v1.0  
**状态**: ✅ 完成
