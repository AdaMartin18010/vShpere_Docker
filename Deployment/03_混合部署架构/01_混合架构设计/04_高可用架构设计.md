# é«˜å¯ç”¨æ¶æ„è®¾è®¡

> **è¿”å›**: [æ··åˆæ¶æ„è®¾è®¡é¦–é¡µ](README.md) | [æ··åˆéƒ¨ç½²æ¶æ„é¦–é¡µ](../README.md) | [éƒ¨ç½²æŒ‡å—é¦–é¡µ](../../00_ç´¢å¼•å¯¼èˆª/README.md)

---

## ğŸ“‹ ç›®å½•

- [é«˜å¯ç”¨æ¶æ„è®¾è®¡](#é«˜å¯ç”¨æ¶æ„è®¾è®¡)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. è·¨å¹³å°é«˜å¯ç”¨](#1-è·¨å¹³å°é«˜å¯ç”¨)
  - [2. å®¹ç¾æ–¹æ¡ˆ](#2-å®¹ç¾æ–¹æ¡ˆ)
  - [3. æ•…éšœåˆ‡æ¢](#3-æ•…éšœåˆ‡æ¢)
  - [4. ç°åº¦å‘å¸ƒ](#4-ç°åº¦å‘å¸ƒ)

---

## 1. è·¨å¹³å°é«˜å¯ç”¨

**è™šæ‹Ÿæœºé«˜å¯ç”¨ (VMware HA)**:

```yaml
vSphere HA é…ç½®:
  - æ•…éšœæ£€æµ‹: å¿ƒè·³+æ•°æ®å­˜å‚¨
  - ä¸»æœºéš”ç¦»å“åº”: å…³é—­è™šæ‹Ÿæœº
  - VMé‡å¯ä¼˜å…ˆçº§: é«˜/ä¸­/ä½
  - å‡†å…¥æ§åˆ¶: é¢„ç•™25%èµ„æº
```

**Kubernetesé«˜å¯ç”¨**:

```yaml
æ§åˆ¶å¹³é¢HA:
  - MasterèŠ‚ç‚¹: 3/5èŠ‚ç‚¹ (etcd quorum)
  - API Server: å¤šå‰¯æœ¬ + LB
  - etcd: é›†ç¾¤éƒ¨ç½² (Raftåè®®)

åº”ç”¨å±‚HA:
  - Deployment: replicas â‰¥ 3
  - PodDisruptionBudget: maxUnavailable=1
  - åäº²å’Œæ€§: è·¨èŠ‚ç‚¹éƒ¨ç½²
```

**è·¨å¹³å°æ•…éšœè½¬ç§»**:

```text
æ–¹æ¡ˆ1: DNSåˆ‡æ¢
  VMæ•…éšœ â†’ æ›´æ–°DNS â†’ å®¹å™¨æ¥ç®¡æµé‡

æ–¹æ¡ˆ2: æœåŠ¡ç½‘æ ¼
  Istioæ•…éšœæ³¨å…¥ â†’ è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡

æ–¹æ¡ˆ3: æ•°æ®åº“è¯»å†™åˆ†ç¦»
  ä¸»åº“(VM)æ•…éšœ â†’ åªè¯»å‰¯æœ¬(å®¹å™¨)æå‡ä¸ºä¸»
```

---

## 2. å®¹ç¾æ–¹æ¡ˆ

**åŒåŸåŒæ´»**:

```text
æ•°æ®ä¸­å¿ƒA (ä¸»)          æ•°æ®ä¸­å¿ƒB (å¤‡)
â”œâ”€ VMé›†ç¾¤ (50%)    â†â†’  VMé›†ç¾¤ (50%)
â”œâ”€ K8sé›†ç¾¤ (50%)   â†â†’  K8sé›†ç¾¤ (50%)
â””â”€ å­˜å‚¨åŒæ­¥å¤åˆ¶ (vSAN + Ceph)
```

**å¼‚åœ°ç¾å¤‡**:

```text
ç”Ÿäº§ä¸­å¿ƒ (RPO=0, RTO=15min)
  â”œâ”€ åŒæ­¥å¤åˆ¶ â†’ åŒåŸç¾å¤‡ä¸­å¿ƒ
  â””â”€ å¼‚æ­¥å¤åˆ¶ â†’ å¼‚åœ°ç¾å¤‡ä¸­å¿ƒ (RPO=1h, RTO=4h)
```

**å¤‡ä»½ç­–ç•¥**:

- **VMå¤‡ä»½**: Veeamå…¨é‡+å¢é‡
- **å®¹å™¨å¤‡ä»½**: Velero (åº”ç”¨+PV)
- **æ•°æ®åº“å¤‡ä»½**: æ¯æ—¥å…¨é‡ + æ¯å°æ—¶å¢é‡

---

## 3. æ•…éšœåˆ‡æ¢

**è‡ªåŠ¨æ•…éšœåˆ‡æ¢**:

```yaml
# Kuberneteså¥åº·æ£€æŸ¥
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  periodSeconds: 5
```

**æ‰‹åŠ¨æ•…éšœåˆ‡æ¢**:

```bash
# æµé‡ä»VMåˆ‡æ¢åˆ°å®¹å™¨
# 1. æ›´æ–°Istio VirtualServiceæƒé‡
kubectl patch virtualservice app \
  --type merge \
  -p '{"spec":{"http":[{"route":[{"destination":{"host":"app-vm"},"weight":0},{"destination":{"host":"app-k8s"},"weight":100}]}]}}'

# 2. éªŒè¯æµé‡
kubectl logs -f deploy/app-k8s

# 3. ç›‘æ§å‘Šè­¦
curl http://prometheus:9090/api/v1/query?query=up{job="app"}
```

---

## 4. ç°åº¦å‘å¸ƒ

**é‡‘ä¸é›€å‘å¸ƒ (Canary)**:

```yaml
# Istioé‡‘ä¸é›€å‘å¸ƒ
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: app-canary
spec:
  hosts:
  - app.example.com
  http:
  - match:
    - headers:
        user-type:
          exact: "internal"  # å†…éƒ¨ç”¨æˆ·æµ‹è¯•æ–°ç‰ˆæœ¬
    route:
    - destination:
        host: app
        subset: v2-canary
  - route:
    - destination:
        host: app
        subset: v1-stable
      weight: 95
    - destination:
        host: app
        subset: v2-canary
      weight: 5  # 5%æµé‡åˆ°æ–°ç‰ˆæœ¬
```

**è“ç»¿å‘å¸ƒ (Blue-Green)**:

```text
Blueç¯å¢ƒ (å½“å‰ç‰ˆæœ¬) â† 100%æµé‡
Greenç¯å¢ƒ (æ–°ç‰ˆæœ¬) â† 0%æµé‡
â†’ éªŒè¯é€šè¿‡åï¼Œä¸€æ¬¡æ€§åˆ‡æ¢100%æµé‡åˆ°Green
â†’ Blueç¯å¢ƒä¿ç•™ï¼Œå¯å¿«é€Ÿå›æ»š
```

**A/Bæµ‹è¯•**:

```yaml
# åŸºäºç”¨æˆ·æ ‡ç­¾çš„æµé‡åˆ†å‰²
- match:
  - headers:
      user-group:
        exact: "A"
  route:
  - destination:
      host: app
      subset: version-a
- match:
  - headers:
      user-group:
        exact: "B"
  route:
  - destination:
      host: app
      subset: version-b
```

---

**æ›´æ–°æ—¶é—´**: 2025-10-19  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… å®Œæˆ
