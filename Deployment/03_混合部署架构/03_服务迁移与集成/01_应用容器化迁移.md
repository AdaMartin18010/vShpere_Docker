# åº”ç”¨å®¹å™¨åŒ–è¿ç§»

> **è¿”å›ž**: [æœåŠ¡è¿ç§»ä¸Žé›†æˆé¦–é¡µ](README.md) | [æ··åˆéƒ¨ç½²æž¶æž„é¦–é¡µ](../README.md) | [éƒ¨ç½²æŒ‡å—é¦–é¡µ](../../00_ç´¢å¼•å¯¼èˆª/README.md)

---

## ðŸ“‹ ç›®å½•

- [åº”ç”¨å®¹å™¨åŒ–è¿ç§»](#åº”ç”¨å®¹å™¨åŒ–è¿ç§»)
  - [ðŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. è¿ç§»è¯„ä¼°](#1-è¿ç§»è¯„ä¼°)
  - [2. æ”¹é€ ç­–ç•¥](#2-æ”¹é€ ç­–ç•¥)
  - [3. åˆ†æ­¥è¿ç§»](#3-åˆ†æ­¥è¿ç§»)
  - [4. å›žæ»šæ–¹æ¡ˆ](#4-å›žæ»šæ–¹æ¡ˆ)

---

## 1. è¿ç§»è¯„ä¼°

**12å› å­åº”ç”¨è¯„ä¼°**:

| å› å­ | è¦æ±‚ | VMåº”ç”¨çŽ°çŠ¶ | æ”¹é€ å»ºè®® |
|-----|------|----------|---------|
| **ä»£ç åº“** | å•ä¸€ä»£ç åº“ | âœ… å·²æ»¡è¶³ | æ— éœ€æ”¹é€  |
| **ä¾èµ–** | æ˜¾å¼å£°æ˜Žä¾èµ– | âš ï¸ ç³»ç»Ÿä¾èµ– | Dockerfileå£°æ˜Ž |
| **é…ç½®** | çŽ¯å¢ƒå˜é‡å­˜å‚¨ | âŒ é…ç½®æ–‡ä»¶ | ConfigMap/Secret |
| **åŽç«¯æœåŠ¡** | èµ„æºé™„åŠ  | âš ï¸ ç¡¬ç¼–ç IP | æœåŠ¡å‘çŽ° |
| **æž„å»ºå‘å¸ƒè¿è¡Œ** | ä¸¥æ ¼åˆ†ç¦» | âŒ æ‰‹åŠ¨éƒ¨ç½² | CI/CDæµæ°´çº¿ |
| **è¿›ç¨‹** | æ— çŠ¶æ€è¿›ç¨‹ | âŒ æœ¬åœ°ä¼šè¯ | Rediså­˜å‚¨ä¼šè¯ |
| **ç«¯å£ç»‘å®š** | å¯¼å‡ºæœåŠ¡ | âœ… å·²æ»¡è¶³ | æ— éœ€æ”¹é€  |
| **å¹¶å‘** | æ°´å¹³æ‰©å±• | âŒ åž‚ç›´æ‰©å±• | Kubernetes HPA |
| **æ˜“å¤„ç†** | å¿«é€Ÿå¯åŠ¨å…³é—­ | âš ï¸ å¯åŠ¨æ…¢ | ä¼˜åŒ–å¯åŠ¨æ—¶é—´ |
| **çŽ¯å¢ƒä¸€è‡´** | å¼€å‘ç”Ÿäº§ä¸€è‡´ | âŒ çŽ¯å¢ƒå·®å¼‚ | å®¹å™¨åŒ–ç»Ÿä¸€ |
| **æ—¥å¿—** | äº‹ä»¶æµ | âš ï¸ æ–‡ä»¶æ—¥å¿— | stdout/stderr |
| **ç®¡ç†è¿›ç¨‹** | ä¸€æ¬¡æ€§ä»»åŠ¡ | âš ï¸ cronä»»åŠ¡ | Kubernetes Job |

**è¿ç§»éš¾åº¦è¯„ä¼°**:

```text
ä½Žéš¾åº¦ (1-2å‘¨):
  - æ— çŠ¶æ€åº”ç”¨
  - æ ‡å‡†æŠ€æœ¯æ ˆ (Java/Python/Node.js)
  - é…ç½®ç®€å•

ä¸­ç­‰éš¾åº¦ (3-4å‘¨):
  - æœ‰çŠ¶æ€åº”ç”¨ (éœ€è¦å­˜å‚¨æ–¹æ¡ˆ)
  - å¤æ‚é…ç½®
  - å¤šæœåŠ¡ä¾èµ–

é«˜éš¾åº¦ (2-3ä¸ªæœˆ):
  - å•ä½“åº”ç”¨ (éœ€è¦æ‹†åˆ†)
  - å•†ä¸šè½¯ä»¶ (è®¸å¯è¯é™åˆ¶)
  - ç´§è€¦åˆæž¶æž„
```

---

## 2. æ”¹é€ ç­–ç•¥

**ç­–ç•¥1: Lift and Shift (ç›´æŽ¥è¿ç§»)**:

```dockerfile
# æœ€å°æ”¹é€ 
FROM ubuntu:20.04
COPY legacy-app /opt/app
COPY config /etc/app
CMD ["/opt/app/start.sh"]
```

**ä¼˜ç‚¹**: å¿«é€Ÿè¿ç§»  
**ç¼ºç‚¹**: æœªå……åˆ†åˆ©ç”¨å®¹å™¨ä¼˜åŠ¿

**ç­–ç•¥2: Replatform (è½»åº¦æ”¹é€ )**:

```dockerfile
# åŸºäºŽå®˜æ–¹é•œåƒ
FROM openjdk:11-jre
COPY app.jar /app/
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/app/app.jar"]
---
# ConfigMapå¤–éƒ¨åŒ–é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  application.properties: |
    server.port=8080
    db.url=jdbc:mysql://db:3306/app
```

**ä¼˜ç‚¹**: å¹³è¡¡é€Ÿåº¦ä¸Žä¼˜åŒ–  
**ç¼ºç‚¹**: éƒ¨åˆ†æ—§æž¶æž„é—ç•™

**ç­–ç•¥3: Refactor (é‡æž„)**:

```text
å•ä½“åº”ç”¨ â†’ å¾®æœåŠ¡
  â”œâ”€ APIç½‘å…³
  â”œâ”€ ç”¨æˆ·æœåŠ¡
  â”œâ”€ è®¢å•æœåŠ¡
  â””â”€ æ”¯ä»˜æœåŠ¡

é…ç½®é‡æž„:
  â”œâ”€ Spring Cloud Config
  â”œâ”€ Consul
  â””â”€ etcd
```

**ä¼˜ç‚¹**: å……åˆ†äº‘åŽŸç”Ÿ  
**ç¼ºç‚¹**: å‘¨æœŸé•¿ã€æˆæœ¬é«˜

---

## 3. åˆ†æ­¥è¿ç§»

**Phase 1: å®¹å™¨åŒ–æ‰“åŒ…**:

```bash
# 1. ç¼–å†™Dockerfile
cat > Dockerfile << 'EOF'
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "app.py"]
EOF

# 2. æž„å»ºé•œåƒ
docker build -t myapp:v1 .

# 3. æœ¬åœ°æµ‹è¯•
docker run -p 8080:8080 myapp:v1
```

**Phase 2: Kuberneteséƒ¨ç½²**:

```yaml
# Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 1  # åˆå§‹å•å‰¯æœ¬
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: myapp:v1
        ports:
        - containerPort: 8080
        env:
        - name: DB_HOST
          value: "legacy-db.vm.local"  # å…ˆè¿žæŽ¥VMæ•°æ®åº“
---
# Service
apiVersion: v1
kind: Service
metadata:
  name: myapp
spec:
  selector:
    app: myapp
  ports:
  - port: 80
    targetPort: 8080
```

**Phase 3: ç°åº¦éªŒè¯**:

```yaml
# Istio VirtualService
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: myapp
spec:
  hosts:
  - myapp.example.com
  http:
  - match:
    - headers:
        x-canary:
          exact: "true"  # å†…éƒ¨æµ‹è¯•
    route:
    - destination:
        host: myapp
        subset: v2-k8s
  - route:
    - destination:
        host: myapp-vm
        subset: v1-vm
      weight: 90
    - destination:
        host: myapp
        subset: v2-k8s
      weight: 10  # 10%æµé‡
```

**Phase 4: å…¨é‡åˆ‡æ¢**:

```yaml
# é€æ­¥å¢žåŠ æƒé‡
weight: 10 â†’ 30 â†’ 50 â†’ 80 â†’ 100
```

---

## 4. å›žæ»šæ–¹æ¡ˆ

**å¿«é€Ÿå›žæ»š (DNS)**:

```bash
# å›žæ»šåˆ°VM
kubectl patch svc myapp -p '{"spec":{"type":"ExternalName","externalName":"myapp-vm.legacy.local"}}'
```

**Kuberneteså›žæ»š**:

```bash
# å›žæ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/myapp

# å›žæ»šåˆ°æŒ‡å®šç‰ˆæœ¬
kubectl rollout undo deployment/myapp --to-revision=2

# æŸ¥çœ‹å›žæ»šåŽ†å²
kubectl rollout history deployment/myapp
```

**æ•°æ®å›žæ»š**:

```bash
# æ¢å¤æ•°æ®åº“å¿«ç…§
mysql -h db.legacy.local < backup-2024-01-01.sql

# æ¢å¤PVæ•°æ®
velero restore create --from-backup backup-2024-01-01
```

---

**æ›´æ–°æ—¶é—´**: 2025-10-19  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… å®Œæˆ
