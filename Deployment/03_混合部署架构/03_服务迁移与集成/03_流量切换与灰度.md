# 流量切换与灰度

> **返回**: [服务迁移与集成首页](README.md) | [混合部署架构首页](../README.md) | [部署指南首页](../../00_索引导航/README.md)

---

## 📋 目录

- [流量切换与灰度](#流量切换与灰度)
  - [📋 目录](#-目录)
  - [1. 流量引流策略](#1-流量引流策略)
  - [2. 灰度发布](#2-灰度发布)
  - [3. 流量回切](#3-流量回切)
  - [4. 监控验证](#4-监控验证)

---

## 1. 流量引流策略

**DNS切换**:

```bash
# 阶段1: VM环境 (100%流量)
app.example.com → 172.16.1.100 (VM)

# 阶段2: 双跑验证 (内部测试)
test.app.example.com → 10.0.1.100 (K8s)

# 阶段3: 灰度切换 (10%流量)
app.example.com → 
  ├─ 172.16.1.100 (VM, 90%)
  └─ 10.0.1.100 (K8s, 10%)

# 阶段4: 全量切换
app.example.com → 10.0.1.100 (K8s, 100%)
```

**Nginx流量分割**:

```nginx
upstream backend {
    server vm-app:8080 weight=90;      # VM 90%
    server k8s-app:8080 weight=10;     # K8s 10%
}

server {
    listen 80;
    server_name app.example.com;
    
    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**HAProxy流量分割**:

```text
frontend http_front
    bind *:80
    default_backend servers

backend servers
    balance roundrobin
    server vm-app 172.16.1.100:8080 check weight 90
    server k8s-app 10.0.1.100:8080 check weight 10
```

---

## 2. 灰度发布

**Istio金丝雀发布**:

```yaml
# 阶段1: 5%流量到新版本
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: app-canary
spec:
  hosts:
  - app.example.com
  http:
  - match:
    - headers:
        x-internal-user:
          exact: "true"
    route:
    - destination:
        host: app
        subset: v2-k8s
      weight: 100  # 内部用户100%到新版本
  - route:
    - destination:
        host: app
        subset: v1-vm
      weight: 95
    - destination:
        host: app
        subset: v2-k8s
      weight: 5  # 5%流量到新版本
---
# DestinationRule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: app
spec:
  host: app
  subsets:
  - name: v1-vm
    labels:
      version: v1
  - name: v2-k8s
    labels:
      version: v2
```

**Flagger自动化金丝雀**:

```yaml
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: app
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: app
  service:
    port: 8080
  analysis:
    interval: 1m
    threshold: 5
    maxWeight: 50
    stepWeight: 10
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: 99
      interval: 1m
    - name: request-duration
      thresholdRange:
        max: 500
      interval: 1m
  webhooks:
  - name: load-test
    url: http://flagger-loadtester/
    metadata:
      cmd: "hey -z 1m -q 10 -c 2 http://app-canary:8080/"
```

**蓝绿发布**:

```yaml
# 蓝色环境 (当前版本)
apiVersion: v1
kind: Service
metadata:
  name: app
spec:
  selector:
    app: app
    version: blue  # 流量指向蓝色
  ports:
  - port: 80
    targetPort: 8080
---
# 绿色环境 (新版本)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-green
spec:
  replicas: 3
  selector:
    matchLabels:
      app: app
      version: green
  template:
    metadata:
      labels:
        app: app
        version: green
    spec:
      containers:
      - name: app
        image: app:v2
---
# 切换流量 (修改selector)
kubectl patch service app \
  -p '{"spec":{"selector":{"version":"green"}}}'
```

---

## 3. 流量回切

**快速回滚 (Istio)**:

```bash
# 立即回滚到VM版本
kubectl patch virtualservice app --type merge -p '
{
  "spec": {
    "http": [{
      "route": [{
        "destination": {
          "host": "app",
          "subset": "v1-vm"
        },
        "weight": 100
      }]
    }]
  }
}'
```

**分步回滚**:

```bash
# 1. 降低K8s流量
weight: 50 → 30 → 10 → 0

# 2. 观察监控指标

# 3. 完全切回VM
kubectl patch virtualservice app \
  --type merge \
  -p '{"spec":{"http":[{"route":[{"destination":{"host":"app","subset":"v1-vm"},"weight":100}]}]}}'
```

---

## 4. 监控验证

**关键指标监控**:

```yaml
# Prometheus告警规则
groups:
- name: canary_alerts
  rules:
  - alert: HighErrorRate
    expr: |
      rate(http_requests_total{code=~"5.."}[5m]) / 
      rate(http_requests_total[5m]) > 0.05
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "High error rate detected"
      description: "Error rate is {{ $value }}%"
  
  - alert: HighLatency
    expr: |
      histogram_quantile(0.99, 
        rate(http_request_duration_seconds_bucket[5m])
      ) > 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High latency detected"
      description: "P99 latency is {{ $value }}s"
```

**实时监控仪表盘**:

```yaml
# Grafana Dashboard配置
{
  "panels": [
    {
      "title": "Traffic Distribution",
      "targets": [{
        "expr": "sum by (version) (rate(http_requests_total[5m]))"
      }]
    },
    {
      "title": "Error Rate",
      "targets": [{
        "expr": "rate(http_requests_total{code=~\"5..\"}[5m])"
      }]
    },
    {
      "title": "Latency P99",
      "targets": [{
        "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))"
      }]
    }
  ]
}
```

**A/B测试分析**:

```sql
-- 对比新旧版本转化率
SELECT
  version,
  COUNT(DISTINCT user_id) as users,
  COUNT(DISTINCT CASE WHEN converted=1 THEN user_id END) as conversions,
  COUNT(DISTINCT CASE WHEN converted=1 THEN user_id END)*100.0 / COUNT(DISTINCT user_id) as conversion_rate
FROM events
WHERE timestamp > NOW() - INTERVAL '7 days'
GROUP BY version;
```

---

**更新时间**: 2025-10-19  
**文档版本**: v1.0  
**状态**: ✅ 完成
