# æ•°æ®åº“ä¸ä¸­é—´ä»¶è¿ç§»

> **è¿”å›**: [æœåŠ¡è¿ç§»ä¸é›†æˆé¦–é¡µ](README.md) | [æ··åˆéƒ¨ç½²æ¶æ„é¦–é¡µ](../README.md) | [éƒ¨ç½²æŒ‡å—é¦–é¡µ](../../00_ç´¢å¼•å¯¼èˆª/README.md)

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“ä¸ä¸­é—´ä»¶è¿ç§»](#æ•°æ®åº“ä¸ä¸­é—´ä»¶è¿ç§»)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ•°æ®åº“å®¹å™¨åŒ–](#1-æ•°æ®åº“å®¹å™¨åŒ–)
  - [2. æ¶ˆæ¯é˜Ÿåˆ—è¿ç§»](#2-æ¶ˆæ¯é˜Ÿåˆ—è¿ç§»)
  - [3. ç¼“å­˜æœåŠ¡è¿ç§»](#3-ç¼“å­˜æœåŠ¡è¿ç§»)
  - [4. æ•°æ®åŒæ­¥](#4-æ•°æ®åŒæ­¥)

---

## 1. æ•°æ®åº“å®¹å™¨åŒ–

**è¿ç§»ç­–ç•¥**:

```text
æ ¸å¿ƒç”Ÿäº§åº“: ä¿ç•™VM (ç¨³å®šæ€§ä¼˜å…ˆ)
  â”œâ”€ Oracle RAC
  â”œâ”€ SQL Serveré›†ç¾¤
  â””â”€ å…³é”®ä¸šåŠ¡MySQL

å¼€å‘æµ‹è¯•åº“: å®¹å™¨åŒ– (å¿«é€Ÿéƒ¨ç½²)
  â”œâ”€ PostgreSQL (Kubernetes)
  â”œâ”€ MySQL (Kubernetes)
  â””â”€ MongoDB (Kubernetes)

åªè¯»å‰¯æœ¬: å®¹å™¨åŒ– (è¯»å†™åˆ†ç¦»)
  â”œâ”€ ä¸»åº“ (VM)
  â””â”€ ä»åº“ (Kubernetes StatefulSet)
```

**MySQLå®¹å™¨åŒ–éƒ¨ç½²**:

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
spec:
  serviceName: mysql
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        ports:
        - containerPort: 3306
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: password
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: rook-ceph-block
      resources:
        requests:
          storage: 100Gi
```

**æ•°æ®è¿ç§»**:

```bash
# 1. å¤‡ä»½VMæ•°æ®åº“
mysqldump -h vm-mysql \
  --single-transaction \
  --quick \
  --lock-tables=false \
  app_db > app_db.sql

# 2. æ¢å¤åˆ°Kubernetes
kubectl exec -i mysql-0 -- \
  mysql -uroot -p${MYSQL_ROOT_PASSWORD} < app_db.sql

# 3. éªŒè¯æ•°æ®
kubectl exec mysql-0 -- \
  mysql -uroot -p${MYSQL_ROOT_PASSWORD} \
  -e "SELECT COUNT(*) FROM app_db.users;"
```

---

## 2. æ¶ˆæ¯é˜Ÿåˆ—è¿ç§»

**Kafkaè¿ç§» (é›¶åœæœº)**:

```yaml
# 1. éƒ¨ç½²Kubernetes Kafkaé›†ç¾¤
apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    version: 3.5.0
    replicas: 3
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: false
      - name: tls
        port: 9093
        type: internal
        tls: true
    storage:
      type: jbod
      volumes:
      - id: 0
        type: persistent-claim
        size: 100Gi
        class: rook-ceph-block
  zookeeper:
    replicas: 3
    storage:
      type: persistent-claim
      size: 10Gi
```

**è¿ç§»æ­¥éª¤**:

```bash
# 1. é…ç½®MirrorMaker 2.0 (åŒå‘åŒæ­¥)
kubectl apply -f - << EOF
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: vm-to-k8s-mirror
spec:
  version: 3.5.0
  replicas: 1
  connectCluster: "k8s-cluster"
  clusters:
  - alias: "vm-cluster"
    bootstrapServers: vm-kafka:9092
  - alias: "k8s-cluster"
    bootstrapServers: my-cluster-kafka-bootstrap:9092
  mirrors:
  - sourceCluster: "vm-cluster"
    targetCluster: "k8s-cluster"
    sourceConnector: {}
    heartbeatConnector: {}
    checkpointConnector: {}
EOF

# 2. éªŒè¯æ¶ˆæ¯åŒæ­¥
kafka-console-consumer --bootstrap-server my-cluster-kafka-bootstrap:9092 \
  --topic test --from-beginning

# 3. é€æ­¥åˆ‡æ¢ç”Ÿäº§è€…/æ¶ˆè´¹è€…åˆ°K8sé›†ç¾¤
```

---

## 3. ç¼“å­˜æœåŠ¡è¿ç§»

**Redisè¿ç§»**:

```yaml
# Redis Clusteréƒ¨ç½²
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
spec:
  serviceName: redis
  replicas: 6  # 3ä¸»3ä»
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7.0-alpine
        ports:
        - containerPort: 6379
        - containerPort: 16379
        command:
        - redis-server
        - --cluster-enabled
        - "yes"
        - --cluster-config-file
        - /data/nodes.conf
        volumeMounts:
        - name: data
          mountPath: /data
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
```

**æ•°æ®è¿ç§» (RIOT - Redis IO Tools)**:

```bash
# åœ¨çº¿è¿ç§» (æºVM Redis â†’ ç›®æ ‡K8s Redis)
docker run -it --rm \
  redislabs/riot-redis \
  replicate \
  --source redis://vm-redis:6379 \
  --target redis://k8s-redis:6379

# éªŒè¯æ•°æ®
redis-cli -h k8s-redis -p 6379 INFO keyspace
```

---

## 4. æ•°æ®åŒæ­¥

**MySQLä¸»ä»åŒæ­¥ (VMä¸» â†’ K8sä»)**:

```yaml
# Kubernetes MySQLä»åº“
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-slave
spec:
  template:
    spec:
      initContainers:
      - name: init-slave
        image: mysql:8.0
        command:
        - bash
        - "-c"
        - |
          # é…ç½®ä¸»ä»å¤åˆ¶
          mysql -h vm-mysql-master -uroot -p${MYSQL_ROOT_PASSWORD} \
            -e "GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' IDENTIFIED BY '${REPL_PASSWORD}';"
          
          # è·å–binlogä½ç½®
          MASTER_LOG_FILE=$(mysql -h vm-mysql-master -uroot -p${MYSQL_ROOT_PASSWORD} \
            -e "SHOW MASTER STATUS\G" | grep File | awk '{print $2}')
          MASTER_LOG_POS=$(mysql -h vm-mysql-master -uroot -p${MYSQL_ROOT_PASSWORD} \
            -e "SHOW MASTER STATUS\G" | grep Position | awk '{print $2}')
          
          # é…ç½®ä»åº“
          mysql -uroot -p${MYSQL_ROOT_PASSWORD} << EOF
          CHANGE MASTER TO
            MASTER_HOST='vm-mysql-master',
            MASTER_USER='repl',
            MASTER_PASSWORD='${REPL_PASSWORD}',
            MASTER_LOG_FILE='${MASTER_LOG_FILE}',
            MASTER_LOG_POS=${MASTER_LOG_POS};
          START SLAVE;
          EOF
      containers:
      - name: mysql
        image: mysql:8.0
        # ... (åŒä¸Š)
```

**CDC (Change Data Capture) - Debezium**:

```yaml
# Debezium MySQL Connector
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: mysql-connector
  labels:
    strimzi.io/cluster: connect-cluster
spec:
  class: io.debezium.connector.mysql.MySqlConnector
  config:
    database.hostname: vm-mysql
    database.port: 3306
    database.user: debezium
    database.password: ${DEBEZIUM_PASSWORD}
    database.server.id: 184054
    database.server.name: vm-mysql
    database.whitelist: app_db
    database.history.kafka.bootstrap.servers: my-cluster-kafka:9092
    database.history.kafka.topic: schema-changes.app_db
```

---

**æ›´æ–°æ—¶é—´**: 2025-10-19  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… å®Œæˆ
