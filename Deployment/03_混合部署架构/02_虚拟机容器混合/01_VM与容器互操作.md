# VMä¸å®¹å™¨äº’æ“ä½œ

> **è¿”å›**: [è™šæ‹Ÿæœºå®¹å™¨æ··åˆé¦–é¡µ](README.md) | [æ··åˆéƒ¨ç½²æ¶æ„é¦–é¡µ](../README.md) | [éƒ¨ç½²æŒ‡å—é¦–é¡µ](../../00_ç´¢å¼•å¯¼èˆª/README.md)

---

## ğŸ“‹ ç›®å½•

- [VMä¸å®¹å™¨äº’æ“ä½œ](#vmä¸å®¹å™¨äº’æ“ä½œ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ç½‘ç»œäº’é€šæ–¹æ¡ˆ](#1-ç½‘ç»œäº’é€šæ–¹æ¡ˆ)
  - [2. å­˜å‚¨å…±äº«æ–¹æ¡ˆ](#2-å­˜å‚¨å…±äº«æ–¹æ¡ˆ)
  - [3. æœåŠ¡å‘ç°](#3-æœåŠ¡å‘ç°)
  - [4. ç»Ÿä¸€ç›‘æ§](#4-ç»Ÿä¸€ç›‘æ§)

---

## 1. ç½‘ç»œäº’é€šæ–¹æ¡ˆ

**æ–¹æ¡ˆ1: Calico BGPæ¨¡å¼**:

```yaml
# Calicoä¸ç‰©ç†ç½‘ç»œBGPå¯¹ç­‰
apiVersion: projectcalico.org/v3
kind: BGPConfiguration
metadata:
  name: default
spec:
  logSeverityScreen: Info
  nodeToNodeMeshEnabled: false
  asNumber: 64512
---
# BGP Peeré…ç½® (ä¸VMç½‘ç»œè·¯ç”±å™¨å¯¹ç­‰)
apiVersion: projectcalico.org/v3
kind: BGPPeer
metadata:
  name: vm-network-peer
spec:
  peerIP: 172.16.0.1  # VMç½‘ç»œç½‘å…³
  asNumber: 65000
```

**æ–¹æ¡ˆ2: VXLAN Overlay**:

```yaml
# Calico VXLANæ¨¡å¼
kind: IPPool
apiVersion: projectcalico.org/v3
metadata:
  name: default-ipv4-ippool
spec:
  cidr: 172.16.16.0/20
  vxlanMode: Always
  natOutgoing: true
```

**VMè®¿é—®å®¹å™¨æœåŠ¡**:

```yaml
# é€šè¿‡NodePortæš´éœ²æœåŠ¡
apiVersion: v1
kind: Service
metadata:
  name: app
spec:
  type: NodePort
  ports:
  - port: 80
    targetPort: 8080
    nodePort: 30080
  selector:
    app: myapp
# VMé€šè¿‡ http://<any-k8s-node>:30080 è®¿é—®
```

---

## 2. å­˜å‚¨å…±äº«æ–¹æ¡ˆ

**æ–¹æ¡ˆ1: NFSå…±äº«å­˜å‚¨**:

```yaml
# Kubernetesä½¿ç”¨NFS (VMæä¾›)
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nfs-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
  - ReadWriteMany
  nfs:
    server: 172.16.1.10  # VMä¸Šçš„NFSæœåŠ¡å™¨
    path: /exports/data
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nfs-pvc
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
```

**æ–¹æ¡ˆ2: S3å…¼å®¹å¯¹è±¡å­˜å‚¨ (MinIO)**:

```yaml
# MinIOéƒ¨ç½² (å®¹å™¨)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: minio
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: minio
        image: minio/minio:latest
        args:
        - server
        - /data
        - --console-address
        - ":9001"
        ports:
        - containerPort: 9000  # S3 API
        - containerPort: 9001  # Console
# VMé€šè¿‡S3 SDKè®¿é—®MinIO
```

**æ–¹æ¡ˆ3: Cephç»Ÿä¸€å­˜å‚¨**:

```text
Cephé›†ç¾¤ (ç‰©ç†æœºæˆ–VM)
  â”œâ”€ RBD â†’ Kubernetes PV (å—å­˜å‚¨)
  â”œâ”€ CephFS â†’ Kubernetes PV (æ–‡ä»¶å­˜å‚¨)
  â””â”€ RGW â†’ VMåº”ç”¨ (å¯¹è±¡å­˜å‚¨ï¼ŒS3å…¼å®¹)
```

---

## 3. æœåŠ¡å‘ç°

**æ–¹æ¡ˆ1: DNSé›†æˆ**:

```yaml
# å®¹å™¨æœåŠ¡DNSè®°å½•
# è‡ªåŠ¨åˆ›å»º: app.default.svc.cluster.local
# é…ç½®VM DNSæŒ‡å‘K8s CoreDNS

# VMæœåŠ¡æ³¨å†Œåˆ°Kubernetes
apiVersion: v1
kind: Service
metadata:
  name: legacy-db
spec:
  type: ExternalName
  externalName: db.vm.local  # VMä¸Šçš„æ•°æ®åº“DNSå
# å®¹å™¨é€šè¿‡ legacy-db.default.svc.cluster.local è®¿é—®VMæ•°æ®åº“
```

**æ–¹æ¡ˆ2: ConsulæœåŠ¡æ³¨å†Œ**:

```bash
# VMæœåŠ¡æ³¨å†Œåˆ°Consul
curl -X PUT http://consul:8500/v1/agent/service/register \
  -d '{
    "ID": "legacy-app-1",
    "Name": "legacy-app",
    "Address": "172.16.1.100",
    "Port": 8080
  }'

# KubernetesæœåŠ¡æ³¨å†Œåˆ°Consul (consul-k8s)
kubectl apply -f consul-connect-inject.yaml
```

**æ–¹æ¡ˆ3: IstioæœåŠ¡ç½‘æ ¼**:

```yaml
# VMæœåŠ¡æ³¨å†Œåˆ°Istio
apiVersion: networking.istio.io/v1beta1
kind: WorkloadEntry
metadata:
  name: legacy-app-vm
spec:
  address: 172.16.1.100
  labels:
    app: legacy-app
    version: v1
  serviceAccount: legacy-sa
---
# Serviceå®šä¹‰ (VM+å®¹å™¨ç»Ÿä¸€)
apiVersion: v1
kind: Service
metadata:
  name: legacy-app
spec:
  ports:
  - port: 8080
  selector:
    app: legacy-app
```

---

## 4. ç»Ÿä¸€ç›‘æ§

**Prometheusç»Ÿä¸€ç›‘æ§**:

```yaml
# VMç›‘æ§ (Node Exporter)
# åœ¨VMä¸Šå®‰è£…
wget https://github.com/prometheus/node_exporter/releases/download/v1.6.1/node_exporter-1.6.1.linux-amd64.tar.gz
./node_exporter --web.listen-address=":9100"

# Prometheusé…ç½®æŠ“å–VM
scrape_configs:
- job_name: 'vm-nodes'
  static_configs:
  - targets: ['172.16.1.10:9100', '172.16.1.11:9100']
    labels:
      env: 'vm'
- job_name: 'kubernetes-pods'
  kubernetes_sd_configs:
  - role: pod
  relabel_configs:
  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
    action: keep
    regex: true
```

**ç»Ÿä¸€æ—¥å¿—æ”¶é›† (ELK/Loki)**:

```yaml
# Filebeatéƒ¨ç½²åœ¨VM
filebeat.inputs:
- type: log
  paths:
    - /var/log/app/*.log
output.elasticsearch:
  hosts: ["elasticsearch.k8s.local:9200"]

# Promtailéƒ¨ç½²åœ¨Kubernetes
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: promtail
spec:
  template:
    spec:
      containers:
      - name: promtail
        image: grafana/promtail:2.9.0
        volumeMounts:
        - name: logs
          mountPath: /var/log
```

**ç»Ÿä¸€å‘Šè­¦ (Alertmanager)**:

```yaml
# Alertmanagerè§„åˆ™
groups:
- name: hybrid_alerts
  rules:
  - alert: HighCPUUsage
    expr: node_cpu_seconds_total > 0.9
    labels:
      severity: warning
    annotations:
      summary: "High CPU on {{ $labels.instance }}"
      description: "CPU usage is above 90%"
```

---

**æ›´æ–°æ—¶é—´**: 2025-10-19  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… å®Œæˆ
