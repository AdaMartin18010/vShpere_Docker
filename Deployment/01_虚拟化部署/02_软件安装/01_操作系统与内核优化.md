# 操作系统与内核优化

> **返回**: [软件安装目录](README.md) | [虚拟化部署首页](../README.md) | [部署指南首页](../../00_索引导航/README.md)

---

## 📋 目录

- [操作系统与内核优化](#操作系统与内核优化)
  - [📋 目录](#-目录)
  - [操作系统要求](#操作系统要求)
    - [虚拟化宿主机OS](#虚拟化宿主机os)
  - [容器宿主机OS](#容器宿主机os)
  - [系统初始化脚本](#系统初始化脚本)
  - [内核参数优化](#内核参数优化)
    - [网络优化](#网络优化)
    - [性能优化](#性能优化)
    - [文件系统优化](#文件系统优化)
  - [资源限制配置](#资源限制配置)
  - [必要服务配置](#必要服务配置)
    - [防火墙配置](#防火墙配置)
    - [SELinux配置](#selinux配置)
    - [Swap配置](#swap配置)
  - [时间同步配置](#时间同步配置)
  - [内核模块加载](#内核模块加载)
  - [相关文档](#相关文档)

---

## 操作系统要求

### 虚拟化宿主机OS

```yaml
VMware ESXi:
  版本要求:
    推荐: 8.0 U2 (最新稳定版)
    支持: 7.0 U3
    ⚠️  不推荐: 6.x (已停止支持)
  
  硬件要求:
    最小内存: 8GB
    推荐内存: 16GB+
    最小磁盘: 32GB
    推荐磁盘: 140GB+
    网络: 1Gbps+
  
  下载地址:
    官方: https://my.vmware.com
    文件名: VMware-VMvisor-Installer-8.0U2-xxx.iso
    大小: ~500MB
  
  许可类型:
    免费版: vSphere Hypervisor (功能受限)
    标准版: vSphere Standard
    企业版: vSphere Enterprise Plus
    VSAN: 需单独许可

Linux KVM:
  支持发行版:
    Ubuntu Server:
      版本: 22.04 LTS (推荐), 20.04 LTS
      支持: 2027年 / 2025年
      包管理: apt
    
    CentOS Stream:
      版本: 9 (推荐), 8
      支持: 滚动更新
      包管理: dnf
    
    RHEL (Red Hat):
      版本: 9.3, 8.9
      支持: 商业支持
      包管理: dnf
    
    Rocky Linux:
      版本: 9.3, 8.9
      支持: RHEL兼容
      包管理: dnf
    
    openEuler (国产):
      版本: 22.03 LTS SP3
      支持: 华为支持
      包管理: dnf
  
  内核要求:
    最低版本: 5.10
    推荐版本: 5.15+ (Ubuntu 22.04)
    推荐版本: 5.14+ (Rocky Linux 9)
    特性要求:
      ✅ KVM模块支持
      ✅ 虚拟化扩展 (VT-x/AMD-V)
      ✅ IOMMU支持 (VT-d/AMD-Vi)
  
  软件要求:
    QEMU: 6.2+ (推荐7.0+)
    libvirt: 8.0+
    virt-manager: 4.0+ (图形界面)
    virsh: 命令行工具

Windows Hyper-V:
  操作系统:
    Windows Server 2022 (推荐)
    Windows Server 2019
    Windows 10/11 Pro/Enterprise (开发测试)
  
  硬件要求:
    最小内存: 16GB
    推荐内存: 32GB+
    磁盘: 100GB+
    网络: 1Gbps+
  
  角色要求:
    必须: Hyper-V角色
    可选: Failover Clustering (HA)
    可选: Hyper-V PowerShell模块
  
  功能特性:
    ✅ Live Migration
    ✅ Storage Migration
    ✅ Replica (容灾)
    ✅ Shielded VMs (加密)
```

---

## 容器宿主机OS

```yaml
推荐Linux发行版:
  Ubuntu Server:
    版本: 22.04 LTS (首选)
    内核: 5.15
    支持: 2027年
    优势:
      ✅ 最新内核特性
      ✅ 丰富软件源
      ✅ 社区支持好
      ✅ 容器生态完善
  
  RHEL/Rocky Linux:
    版本: 9.3 (企业首选)
    内核: 5.14
    支持: 10年
    优势:
      ✅ 企业级稳定
      ✅ 商业支持
      ✅ SELinux集成
      ✅ 认证完善
  
  CentOS Stream:
    版本: 9
    内核: 5.14+
    支持: 滚动更新
    优势:
      ✅ RHEL上游
      ✅ 最新特性
      ✅ 免费使用
  
  Debian:
    版本: 12 (Bookworm)
    内核: 6.1
    支持: 2026年
    优势:
      ✅ 极度稳定
      ✅ 轻量级
      ✅ 纯开源

内核要求:
  最低版本: 5.10
  推荐版本: 5.15+ (Ubuntu 22.04)
  推荐版本: 6.1+ (Debian 12)
  
  必须特性:
    ✅ cgroup v2支持 (内核5.8+)
    ✅ namespace支持
    ✅ overlay2文件系统
    ✅ eBPF支持 (Cilium需要)
    ✅ bridge netfilter

容器运行时版本:
  Docker:
    推荐: 24.0+
    支持: 23.0+
    仓库: https://download.docker.com
  
  containerd:
    推荐: 1.7+
    支持: 1.6+
    仓库: https://github.com/containerd/containerd
  
  Podman:
    推荐: 4.9+
    支持: 4.5+
    仓库: https://podman.io
  
  CRI-O:
    推荐: 1.30+
    支持: 1.28+
    仓库: https://cri-o.io

编排系统版本:
  Kubernetes:
    稳定: 1.30 (2024年4月)
    推荐: 1.29 (LTS)
    支持: 1.28, 1.27
    ⚠️  不推荐: <1.27
  
  K3s:
    版本: 对应K8s版本
    推荐: v1.29+
    优势: 轻量级、边缘友好
  
  OpenShift:
    版本: 4.15
    支持: 4.13+
    基于: Kubernetes 1.28
```

---

## 系统初始化脚本

```bash
#!/bin/bash
# 系统初始化和软件安装脚本
# 适用于: Ubuntu 22.04 / Rocky Linux 9
# 用途: 虚拟化/容器化宿主机初始化

set -e

echo "========================================="
echo "  系统初始化脚本"
echo "  适用: Ubuntu 22.04 / Rocky Linux 9"
echo "========================================="

# 检测操作系统
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
    VER=$VERSION_ID
else
    echo "❌ 无法检测操作系统"
    exit 1
fi

echo "✅ 检测到系统: $OS $VER"

# 更新系统
echo ""
echo "=== 步骤1: 更新系统 ==="
if [ "$OS" = "ubuntu" ]; then
    apt update && apt upgrade -y
    apt install -y software-properties-common apt-transport-https ca-certificates
elif [ "$OS" = "rocky" ] || [ "$OS" = "centos" ] || [ "$OS" = "rhel" ]; then
    dnf update -y
    dnf install -y epel-release
else
    echo "⚠️  不支持的操作系统: $OS"
    exit 1
fi

# 安装基础工具
echo ""
echo "=== 步骤2: 安装基础工具 ==="
if [ "$OS" = "ubuntu" ]; then
    apt install -y \
        curl wget git vim nano \
        htop iotop iftop \
        net-tools iputils-ping dnsutils \
        build-essential cmake \
        python3 python3-pip \
        jq yq \
        tree lsof tcpdump \
        tmux screen \
        zip unzip tar gzip bzip2
elif [ "$OS" = "rocky" ] || [ "$OS" = "centos" ] || [ "$OS" = "rhel" ]; then
    dnf install -y \
        curl wget git vim nano \
        htop iotop iftop \
        net-tools iputils bind-utils \
        gcc gcc-c++ make cmake \
        python3 python3-pip \
        jq yq \
        tree lsof tcpdump \
        tmux screen \
        zip unzip tar gzip bzip2
fi

# 配置时区
echo ""
echo "=== 步骤3: 配置时区 ==="
timedatectl set-timezone Asia/Shanghai
echo "✅ 时区已设置为: $(timedatectl | grep 'Time zone')"

# 安装和配置NTP
echo ""
echo "=== 步骤4: 配置时间同步 (NTP) ==="
if [ "$OS" = "ubuntu" ]; then
    apt install -y chrony
elif [ "$OS" = "rocky" ] || [ "$OS" = "centos" ] || [ "$OS" = "rhel" ]; then
    dnf install -y chrony
fi

# 配置Chrony
cat > /etc/chrony/chrony.conf <<EOF
# 使用阿里云NTP服务器
server ntp.aliyun.com iburst
server ntp1.aliyun.com iburst
server ntp2.aliyun.com iburst

# 备用NTP服务器
server time.cloudflare.com iburst
server time.google.com iburst

# 允许本地网络查询 (如果作为NTP服务器)
allow 192.168.0.0/16
allow 10.0.0.0/8

# 日志
logdir /var/log/chrony
EOF

systemctl enable chrony
systemctl restart chrony
echo "✅ NTP已配置并启动"
sleep 2
chronyc sources

# 禁用防火墙 (可选，生产环境应配置规则而不是禁用)
echo ""
echo "=== 步骤5: 配置防火墙 ==="
read -p "是否禁用防火墙? (y/n，生产环境建议输入n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    if [ "$OS" = "ubuntu" ]; then
        systemctl stop ufw || true
        systemctl disable ufw || true
        echo "✅ UFW已禁用"
    elif [ "$OS" = "rocky" ] || [ "$OS" = "centos" ] || [ "$OS" = "rhel" ]; then
        systemctl stop firewalld || true
        systemctl disable firewalld || true
        echo "✅ firewalld已禁用"
    fi
else
    echo "⚠️  防火墙保持启用状态，请手动配置规则"
fi

# 禁用SELinux (仅RHEL系)
if [ "$OS" = "rocky" ] || [ "$OS" = "centos" ] || [ "$OS" = "rhel" ]; then
    echo ""
    echo "=== 步骤6: 配置SELinux ==="
    read -p "是否禁用SELinux? (y/n，生产环境建议输入n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        setenforce 0 || true
        sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
        echo "✅ SELinux已设置为Permissive模式"
    else
        echo "⚠️  SELinux保持Enforcing模式"
    fi
fi

# 禁用Swap (K8s必须)
echo ""
echo "=== 步骤7: 禁用Swap ==="
read -p "是否禁用Swap? (Kubernetes必须禁用，y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    swapoff -a
    sed -i '/swap/d' /etc/fstab
    echo "✅ Swap已禁用"
else
    echo "⚠️  Swap保持启用状态"
fi

# 加载内核模块
echo ""
echo "=== 步骤8: 加载必要的内核模块 ==="
cat > /etc/modules-load.d/k8s.conf <<EOF
# 容器化必需模块
overlay
br_netfilter

# KVM虚拟化模块 (如需)
# kvm
# kvm_intel  # Intel CPU
# kvm_amd    # AMD CPU
EOF

modprobe overlay
modprobe br_netfilter
echo "✅ 内核模块已加载"
lsmod | grep -E 'overlay|br_netfilter'

# 配置内核参数
echo ""
echo "=== 步骤9: 优化内核参数 ==="
cat > /etc/sysctl.d/99-kubernetes.conf <<EOF
# 网络优化
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.conf.all.forwarding = 1

# 性能优化
vm.swappiness = 0
vm.overcommit_memory = 1
vm.panic_on_oom = 0
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 10

# 文件句柄
fs.file-max = 2097152
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 512

# 网络连接
net.netfilter.nf_conntrack_max = 1048576
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 8192
net.core.netdev_max_backlog = 16384

# TCP优化
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_tw_reuse = 1
EOF

sysctl --system
echo "✅ 内核参数已优化"

# 配置资源限制
echo ""
echo "=== 步骤10: 配置资源限制 ==="
cat > /etc/security/limits.d/99-kubernetes.conf <<EOF
* soft nofile 655360
* hard nofile 655360
* soft nproc 655360
* hard nproc 655360
* soft memlock unlimited
* hard memlock unlimited
EOF

echo "✅ 资源限制已配置"

# 完成
echo ""
echo "========================================="
echo "  ✅ 系统初始化完成！"
echo "========================================="
echo ""
echo "下一步操作:"
echo "  1. 重启系统: reboot"
echo "  2. 验证配置: sysctl -a | grep -E 'ip_forward|bridge-nf'"
echo "  3. 安装容器运行时 (Docker/containerd)"
echo "  4. 安装Kubernetes或虚拟化软件"
echo ""
echo "重启后继续..."
```

---

## 内核参数优化

### 网络优化

```bash
# /etc/sysctl.d/99-network.conf

# IP转发 (必须，容器/虚拟化网络)
net.ipv4.ip_forward = 1
net.ipv4.conf.all.forwarding = 1
net.ipv6.conf.all.forwarding = 1

# Bridge netfilter (必须，Kubernetes CNI)
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-arptables = 1

# Conntrack优化 (大规模集群)
net.netfilter.nf_conntrack_max = 1048576
net.netfilter.nf_conntrack_tcp_timeout_established = 86400
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 3600

# TCP连接队列
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 8192
net.core.netdev_max_backlog = 16384

# TCP性能优化
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 10

# TCP缓冲区
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# 拥塞控制 (BBR，需内核4.9+)
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr
```

### 性能优化

```bash
# /etc/sysctl.d/99-performance.conf

# 内存管理
vm.swappiness = 0                    # 禁用swap (K8s必须)
vm.overcommit_memory = 1             # 允许内存超配
vm.panic_on_oom = 0                  # OOM时不panic
vm.dirty_ratio = 40                  # 脏页比例
vm.dirty_background_ratio = 10       # 后台刷新比例

# 文件句柄
fs.file-max = 2097152                # 最大打开文件数
fs.inotify.max_user_watches = 524288 # inotify监控数
fs.inotify.max_user_instances = 512  # inotify实例数
fs.aio-max-nr = 1048576              # 异步I/O

# 进程管理
kernel.pid_max = 4194304             # 最大PID数
kernel.threads-max = 4194304         # 最大线程数
```

### 文件系统优化

```bash
# /etc/sysctl.d/99-filesystem.conf

# 文件系统
fs.file-max = 2097152
fs.nr_open = 2097152

# inotify (容器监控)
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 512
fs.inotify.max_queued_events = 32768

# 目录项缓存
fs.dentry-state = 0 0 45 0 0 0
```

---

## 资源限制配置

```bash
# /etc/security/limits.d/99-nofile.conf

# 所有用户
* soft nofile 655360
* hard nofile 655360
* soft nproc 655360
* hard nproc 655360
* soft memlock unlimited
* hard memlock unlimited

# Root用户
root soft nofile 655360
root hard nofile 655360
root soft nproc 655360
root hard nproc 655360

# 验证
# ulimit -n  (应显示655360)
# ulimit -u  (应显示655360)
```

---

## 必要服务配置

### 防火墙配置

```bash
# Ubuntu (UFW)
# 禁用 (开发测试)
systemctl stop ufw
systemctl disable ufw

# 或配置规则 (生产环境)
ufw allow 22/tcp      # SSH
ufw allow 6443/tcp    # K8s API
ufw allow 2379:2380/tcp  # etcd
ufw allow 10250/tcp   # Kubelet
ufw enable

# Rocky Linux / RHEL (firewalld)
# 禁用 (开发测试)
systemctl stop firewalld
systemctl disable firewalld

# 或配置规则 (生产环境)
firewall-cmd --permanent --add-port=22/tcp
firewall-cmd --permanent --add-port=6443/tcp
firewall-cmd --permanent --add-port=2379-2380/tcp
firewall-cmd --permanent --add-port=10250/tcp
firewall-cmd --reload
```

### SELinux配置

```bash
# 查看状态
getenforce

# 临时禁用
setenforce 0

# 永久禁用 (不推荐生产环境)
sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

# 或设置为Permissive模式 (推荐)
sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

# 重启后生效
reboot
```

### Swap配置

```bash
# Kubernetes必须禁用Swap

# 临时禁用
swapoff -a

# 永久禁用
sed -i '/swap/d' /etc/fstab

# 验证
free -h  # Swap一行应为0

# 如果必须保留Swap (不推荐)
# Kubernetes 1.28+ 支持Swap，但需特殊配置
```

---

## 时间同步配置

```bash
# 安装Chrony (推荐，比ntpd更精确)
# Ubuntu
apt install -y chrony

# Rocky Linux
dnf install -y chrony

# 配置NTP服务器
cat > /etc/chrony/chrony.conf <<EOF
# 国内NTP服务器
server ntp.aliyun.com iburst
server ntp1.aliyun.com iburst
server ntp2.aliyun.com iburst

# 备用NTP服务器
server time.cloudflare.com iburst
server time.google.com iburst

# 允许本地网络查询 (如果作为NTP服务器)
allow 192.168.0.0/16
allow 10.0.0.0/8

# 时钟快速同步
makestep 1.0 3

# 日志
logdir /var/log/chrony
EOF

# 启动服务
systemctl enable chrony
systemctl restart chrony

# 验证
chronyc sources
chronyc tracking

# 强制同步 (如果时间偏差过大)
chronyc makestep
```

---

## 内核模块加载

```bash
# /etc/modules-load.d/k8s.conf

# 容器化必需模块
overlay                 # OverlayFS (容器存储驱动)
br_netfilter            # Bridge netfilter

# 网络模块
ip_vs                   # IPVS (K8s kube-proxy)
ip_vs_rr                # IPVS轮询
ip_vs_wrr               # IPVS加权轮询
ip_vs_sh                # IPVS源地址哈希
nf_conntrack            # 连接跟踪

# KVM虚拟化模块 (如需)
# kvm
# kvm_intel             # Intel CPU
# kvm_amd               # AMD CPU

# 加载模块
modprobe overlay
modprobe br_netfilter
modprobe ip_vs
modprobe ip_vs_rr
modprobe ip_vs_wrr
modprobe ip_vs_sh
modprobe nf_conntrack

# 验证
lsmod | grep overlay
lsmod | grep br_netfilter
lsmod | grep ip_vs
```

---

## 相关文档

- [VMware ESXi安装与配置](02_VMware_ESXi安装与配置.md)
- [KVM安装与配置](03_KVM安装与配置.md)
- [Hyper-V安装与配置](04_Hyper-V安装与配置.md)
- [BIOS/固件配置清单](../01_硬件规范/06_BIOS固件配置清单.md)
- [硬件兼容性清单](../01_硬件规范/07_硬件兼容性清单.md)

---

**更新时间**: 2025-10-19  
**文档版本**: v3.0  
**状态**: ✅ 生产就绪
