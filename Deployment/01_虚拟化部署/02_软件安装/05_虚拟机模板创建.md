# 虚拟机模板创建与管理

> **返回**: [软件安装目录](README.md) | [虚拟化部署首页](../README.md) | [部署指南首页](../../00_索引导航/README.md)

---

## 📋 目录

- [虚拟机模板创建与管理](#虚拟机模板创建与管理)
  - [📋 目录](#-目录)
  - [模板概述](#模板概述)
  - [VMware虚拟机模板](#vmware虚拟机模板)
    - [Windows Server 2022模板](#windows-server-2022模板)
    - [Linux (Rocky Linux 9) 模板](#linux-rocky-linux-9-模板)
    - [模板转换与克隆](#模板转换与克隆)
  - [KVM虚拟机模板](#kvm虚拟机模板)
    - [使用virt-sysprep创建模板](#使用virt-sysprep创建模板)
    - [Cloud-init模板](#cloud-init模板)
  - [容器化OS模板](#容器化os模板)
    - [CoreOS/Flatcar模板](#coreosflatcar模板)
    - [Ubuntu Cloud Image模板](#ubuntu-cloud-image模板)
  - [模板管理最佳实践](#模板管理最佳实践)
  - [自动化模板部署](#自动化模板部署)

---

## 模板概述

虚拟机模板是预配置的虚拟机镜像，用于快速部署标准化虚拟机，具有以下优势：

```yaml
模板优势:
  标准化:
    - 统一操作系统版本
    - 统一软件包版本
    - 统一安全配置
    - 统一优化参数
  
  效率:
    - 快速部署 (秒级到分钟级)
    - 批量部署能力
    - 减少人工操作
    - 降低出错率
  
  管理:
    - 集中版本管理
    - 易于更新维护
    - 便于合规审计
    - 可追溯性

模板类型:
  基础模板:
    - 最小化OS安装
    - 基础工具包
    - 系统优化配置
    - 适用: 作为其他模板的基础
  
  应用模板:
    - 基础模板 + 应用软件
    - 如: Web服务器、数据库服务器
    - 适用: 特定用途快速部署
  
  容器宿主模板:
    - 容器运行时预安装
    - Docker/containerd/CRI-O
    - Kubernetes节点就绪
    - 适用: 容器化环境
```

---

## VMware虚拟机模板

### Windows Server 2022模板

**阶段1: 创建基础虚拟机**:

```yaml
虚拟机配置:
  名称: Template-Win2022-Std
  虚拟硬件版本: 20 (ESXi 8.0)
  
  计算资源:
    vCPU: 2核
    内存: 4GB
    CPU预留: 0 (模板不需要预留)
  
  存储:
    磁盘1: 60GB (精简置备)
    磁盘类型: SCSI
    SCSI控制器: VMware Paravirtual (PVSCSI)
  
  网络:
    网卡1: VMXNET3
    网络: PG-Production
    连接: 开机时连接
  
  其他设备:
    CD/DVD: 客户端设备 (用于安装)
    软驱: 删除
```

**阶段2: 安装Windows Server 2022**:

```powershell
# 安装过程:
# 1. 挂载Windows Server 2022 ISO
# 2. 启动虚拟机，按照安装向导操作
# 3. 选择: Windows Server 2022 Standard (桌面体验/Core)
# 4. 分区: 使用整个磁盘
# 5. 设置管理员密码 (安装后需重置)

# 安装完成后，进入系统配置阶段
```

**阶段3: 安装VMware Tools**:

```powershell
# 在vCenter中: VM -> 客户机 -> 安装VMware Tools
# 在虚拟机内安装VMware Tools:
# - 挂载VMware Tools ISO
# - 运行 D:\setup64.exe
# - 完整安装 (包含所有组件)
# - 重启虚拟机

# 验证安装:
Get-Service -Name VMTools
# 状态应为: Running
```

**阶段4: Windows系统优化**:

```powershell
# ===================================
# Windows Server 2022 模板优化脚本
# ===================================

# 1. 设置计算机名 (部署时会重置)
Rename-Computer -NewName "TEMPLATE" -Force

# 2. 配置时区
Set-TimeZone -Id "China Standard Time"

# 3. 禁用IPv6 (如果不使用)
Get-NetAdapterBinding -ComponentID ms_tcpip6 | Disable-NetAdapterBinding

# 4. 配置Windows Update为手动
Set-Service -Name wuauserv -StartupType Manual
Stop-Service -Name wuauserv

# 5. 禁用休眠
powercfg /h off

# 6. 设置电源计划为高性能
$PowerPlan = Get-CimInstance -Name root\cimv2\power -Class win32_PowerPlan -Filter "ElementName = 'High performance'"
$PowerPlan | Invoke-CimMethod -MethodName Activate

# 7. 禁用不必要的服务
$DisableServices = @(
    "WSearch",           # Windows Search
    "Spooler",           # 打印后台处理程序 (如不需要打印)
    "RemoteRegistry",    # 远程注册表
    "WerSvc"             # Windows错误报告
)

foreach ($service in $DisableServices) {
    Set-Service -Name $service -StartupType Disabled
    Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
}

# 8. 优化网络参数
# 禁用IPv6组件 (如果已禁用IPv6)
New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters" `
    -Name "DisabledComponents" -Value 0xffffffff -PropertyType DWord -Force

# 9. 配置远程桌面
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
    -Name "fDenyTSConnections" -Value 0
Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

# 10. 配置Windows防火墙基本规则
# 允许ICMPv4 (ping)
New-NetFirewallRule -DisplayName "ICMPv4-In" -Protocol ICMPv4 -IcmpType 8 -Enabled True -Direction Inbound

# 11. 安装常用工具 (使用Chocolatey)
Set-ExecutionPolicy Bypass -Scope Process -Force
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

# 安装常用软件
choco install -y `
    7zip `
    notepadplusplus `
    putty `
    winscp `
    googlechrome

# 12. 清理临时文件
Remove-Item -Path "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item -Path "C:\Windows\Temp\*" -Recurse -Force -ErrorAction SilentlyContinue

# 13. 运行Windows Update (获取最新补丁)
Install-Module PSWindowsUpdate -Force
Get-WindowsUpdate -Install -AcceptAll -AutoReboot

Write-Host "Windows优化完成！请检查后运行Sysprep。"
```

**阶段5: 运行Sysprep**:

```powershell
# Sysprep (系统准备工具) - 用于通用化Windows映像

# 方法1: 使用图形界面
C:\Windows\System32\Sysprep\sysprep.exe
# 选项:
#   系统清理操作: 进入系统全新体验(OOBE)
#   通用: 勾选
#   关机选项: 关机

# 方法2: 使用命令行 (推荐自动化)
C:\Windows\System32\Sysprep\sysprep.exe /oobe /generalize /shutdown /mode:vm

# Sysprep做什么:
# - 删除唯一标识符 (SID)
# - 删除系统还原点
# - 删除事件日志
# - 删除临时文件
# - 重置激活信息

# ⚠️ 注意事项:
# - Sysprep后VM会自动关机
# - 不要再启动此VM，直接转换为模板
# - Windows最多只能运行3次Sysprep (重置计数器需特殊方法)
```

**阶段6: 转换为模板**:

```yaml
# 在vCenter中操作:

方法1: 转换为模板 (推荐生产环境)
  操作: 右键VM -> 模板 -> 转换为模板
  结果: 
    - VM消失，变为模板对象
    - 不能直接启动
    - 需要部署(克隆)才能使用
  优点:
    - 防止误操作启动
    - 节省资源
  
方法2: 克隆为模板 (推荐测试环境)
  操作: 右键VM -> 克隆 -> 克隆为模板
  结果:
    - 原VM保留
    - 新建模板对象
  优点:
    - 可以保留源VM继续测试
    - 更灵活

# 模板命名规范示例:
# Template-Win2022-Std-v1.0-20251019
# 含义: 模板-系统版本-版本号-日期

# 模板存储位置:
# 建议创建专门的"Templates"文件夹存放所有模板
```

### Linux (Rocky Linux 9) 模板

**阶段1: 创建基础虚拟机**:

```yaml
虚拟机配置:
  名称: Template-Rocky9-Base
  虚拟硬件版本: 20
  
  计算资源:
    vCPU: 2核
    内存: 2GB
  
  存储:
    磁盘1: 30GB (精简置备)
    磁盘类型: SCSI (PVSCSI)
  
  网络:
    网卡1: VMXNET3
    网络: PG-Production
```

**阶段2: 安装Rocky Linux 9**:

```bash
# 使用最小化安装 + 标准工具
# 分区方案:
/boot/efi  512MB   (EFI系统分区)
/boot      1GB     (XFS)
/          剩余空间 (XFS, LVM)

# 网络配置: DHCP (后续Cloud-init会重新配置)
# Root密码: 设置临时密码 (后续删除)
```

**阶段3: 系统优化脚本**:

```bash
#!/bin/bash
# ===============================================
# Rocky Linux 9 虚拟机模板优化脚本
# ===============================================

set -e

echo "开始优化Rocky Linux 9模板..."

# 1. 更新系统到最新
echo "1/15 更新系统..."
dnf update -y

# 2. 安装基础工具包
echo "2/15 安装基础工具..."
dnf install -y \
    vim \
    wget \
    curl \
    net-tools \
    bind-utils \
    telnet \
    tcpdump \
    lsof \
    strace \
    sysstat \
    iotop \
    htop \
    tree \
    git \
    rsync \
    screen \
    tmux \
    bash-completion \
    yum-utils \
    device-mapper-persistent-data \
    lvm2

# 3. 安装open-vm-tools (VMware Tools开源版本)
echo "3/15 安装VMware Tools..."
dnf install -y open-vm-tools
systemctl enable --now vmtoolsd

# 4. 配置SSH
echo "4/15 配置SSH..."
cat >> /etc/ssh/sshd_config << 'EOF'

# 优化SSH配置
UseDNS no
GSSAPIAuthentication no
PermitRootLogin yes
PubkeyAuthentication yes
PasswordAuthentication yes
ClientAliveInterval 60
ClientAliveCountMax 3
EOF

systemctl restart sshd

# 5. 配置网络
echo "5/15 配置网络..."
# 确保网络连接自动启动
nmcli connection modify $(nmcli -t -f NAME connection show | head -1) connection.autoconnect yes

# 6. 配置时间同步
echo "6/15 配置时间同步..."
timedatectl set-timezone Asia/Shanghai
systemctl enable --now chronyd

# 7. 禁用SELinux (可选，根据安全策略决定)
echo "7/15 配置SELinux..."
# 生产环境建议设置为enforcing
sed -i 's/^SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
setenforce 0 2>/dev/null || true

# 8. 配置防火墙
echo "8/15 配置防火墙..."
# 开启防火墙并配置基本规则
systemctl enable --now firewalld
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-icmp-block-inversion
firewall-cmd --reload

# 9. 内核参数优化
echo "9/15 优化内核参数..."
cat >> /etc/sysctl.d/99-vm-tuning.conf << 'EOF'
# 网络优化
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_tw_reuse = 1
net.ipv4.ip_local_port_range = 1024 65000
net.core.somaxconn = 32768
net.core.netdev_max_backlog = 32768

# 性能优化
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
fs.file-max = 2097152

# 安全优化
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
EOF

sysctl -p /etc/sysctl.d/99-vm-tuning.conf

# 10. 资源限制配置
echo "10/15 配置资源限制..."
cat >> /etc/security/limits.conf << 'EOF'

# 提高资源限制
* soft nofile 65536
* hard nofile 65536
* soft nproc 65536
* hard nproc 65536
* soft memlock unlimited
* hard memlock unlimited
EOF

# 11. 配置日志轮转
echo "11/15 配置日志轮转..."
cat > /etc/logrotate.d/custom << 'EOF'
/var/log/messages /var/log/secure /var/log/maillog /var/log/cron {
    daily
    rotate 7
    missingok
    notifempty
    compress
    sharedscripts
    postrotate
        /usr/bin/systemctl kill -s HUP rsyslog.service >/dev/null 2>&1 || true
    endscript
}
EOF

# 12. 禁用不必要的服务
echo "12/15 禁用不必要的服务..."
systemctl disable postfix 2>/dev/null || true

# 13. 配置GRUB
echo "13/15 优化GRUB配置..."
# 减少GRUB超时时间
sed -i 's/^GRUB_TIMEOUT=.*/GRUB_TIMEOUT=1/' /etc/default/grub
grub2-mkconfig -o /boot/grub2/grub.cfg

# 14. 安装并配置qemu-guest-agent (如果使用KVM)
echo "14/15 安装qemu-guest-agent..."
dnf install -y qemu-guest-agent
systemctl enable --now qemu-guest-agent

# 15. 清理系统
echo "15/15 清理系统..."
# 清理yum缓存
dnf clean all
rm -rf /var/cache/dnf/*

# 清理临时文件
rm -rf /tmp/*
rm -rf /var/tmp/*

# 清理日志
find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
> /var/log/wtmp
> /var/log/btmp
> /var/log/lastlog

# 清理历史记录
history -c
rm -f /root/.bash_history
rm -f /home/*/.bash_history

# 清理SSH密钥 (重要! 每个VM需要唯一密钥)
rm -f /etc/ssh/ssh_host_*

# 清理machine-id (重要! 每个VM需要唯一ID)
truncate -s 0 /etc/machine-id
rm -f /var/lib/dbus/machine-id

# 清理网络配置中的UUID和MAC地址
sed -i '/^UUID=/d' /etc/sysconfig/network-scripts/ifcfg-*
sed -i '/^HWADDR=/d' /etc/sysconfig/network-scripts/ifcfg-*

echo "======================================"
echo "Rocky Linux 9 模板优化完成!"
echo "请关机并转换为模板。"
echo "======================================"
```

**阶段4: 安装Cloud-init (推荐)**:

```bash
# Cloud-init 用于VM首次启动时的自动化配置
# 包括: 主机名、网络、SSH密钥、用户创建等

# 安装cloud-init
dnf install -y cloud-init cloud-utils-growpart

# 配置cloud-init
cat > /etc/cloud/cloud.cfg << 'EOF'
# Cloud-init配置
users:
 - default

disable_root: false
ssh_pwauth: true

mount_default_fields: [~, ~, 'auto', 'defaults,nofail', '0', '2']
resize_rootfs_tmp: /dev
ssh_deletekeys: true
ssh_genkeytypes: ['rsa', 'ecdsa', 'ed25519']

cloud_init_modules:
 - migrator
 - seed_random
 - bootcmd
 - write-files
 - growpart
 - resizefs
 - disk_setup
 - mounts
 - set_hostname
 - update_hostname
 - update_etc_hosts
 - ca-certs
 - rsyslog
 - users-groups
 - ssh

cloud_config_modules:
 - emit_upstart
 - ssh-import-id
 - locale
 - set-passwords
 - grub-dpkg
 - apt-pipelining
 - apt-configure
 - timezone
 - runcmd

cloud_final_modules:
 - package-update-upgrade-install
 - scripts-vendor
 - scripts-per-once
 - scripts-per-boot
 - scripts-per-instance
 - scripts-user
 - ssh-authkey-fingerprints
 - keys-to-console
 - final-message

# VMware数据源配置
datasource_list: [ VMware, OVF, None ]
datasource:
  VMware:
    vmware_cust_file_max_wait: 25
EOF

# 启用cloud-init
systemctl enable cloud-init cloud-init-local cloud-config cloud-final

# 清理cloud-init状态 (确保新VM重新运行cloud-init)
cloud-init clean --logs --seed

# 关机
poweroff
```

**阶段5: 转换为模板**:

```bash
# 在vCenter中: 右键VM -> 模板 -> 转换为模板
# 或使用PowerCLI:
Get-VM "Template-Rocky9-Base" | Set-VM -ToTemplate -Confirm:$false
```

### 模板转换与克隆

**从模板部署虚拟机 (vCenter Web界面)**:

```yaml
部署新虚拟机:
  步骤:
    1. 右键模板 -> 新虚拟机(从此模板)
    
    2. 选择名称和文件夹:
       名称: web-server-01
       文件夹: Production/Web-Servers
    
    3. 选择计算资源:
       集群: Prod-Cluster
       主机: (自动分配)
    
    4. 选择存储:
       数据存储: vsanDatastore
       存储策略: vSAN-Standard-FTT1
    
    5. 选择克隆选项:
       克隆类型: 
         - 完整克隆 (独立副本, 推荐)
         - 链接克隆 (依赖模板, 节省空间)
       
       自定义操作系统: 是
       
    6. 自定义规范 (Guest Customization):
       Windows:
         计算机名: web-server-01
         产品密钥: (可选)
         管理员密码: 设置新密码
         时区: (GMT+08:00) 北京,重庆,香港,乌鲁木齐
         网络:
           IP地址: 192.168.20.100
           子网掩码: 255.255.255.0
           网关: 192.168.20.1
           DNS: 192.168.10.53, 192.168.10.54
       
       Linux:
         主机名: web-server-01
         DNS后缀: company.local
         网络:
           (同Windows)
    
    7. 完成部署
```

**使用PowerCLI批量部署**:

```powershell
# ========================================
# PowerCLI批量部署脚本
# ========================================

# 连接vCenter
Connect-VIServer -Server vcenter.company.local -User administrator@vsphere.local

# 定义VM列表
$VMs = @(
    @{Name="web-01"; IP="192.168.20.101"; Gateway="192.168.20.1"},
    @{Name="web-02"; IP="192.168.20.102"; Gateway="192.168.20.1"},
    @{Name="web-03"; IP="192.168.20.103"; Gateway="192.168.20.1"}
)

# 模板名称
$Template = "Template-Rocky9-Base"

# 目标数据存储
$Datastore = "vsanDatastore"

# 目标集群
$Cluster = "Prod-Cluster"

# 网络
$Network = "PG-Production"

# 循环部署
foreach ($VM in $VMs) {
    Write-Host "部署虚拟机: $($VM.Name)"
    
    # 创建自定义规范
    $CustomSpec = New-OSCustomizationSpec -Name "Temp-$($VM.Name)" -OSType Linux -Domain company.local -DnsServer "192.168.10.53","192.168.10.54" -NamingScheme Fixed -NamingPrefix $VM.Name
    
    # 配置网络
    Get-OSCustomizationNicMapping -OSCustomizationSpec $CustomSpec | Set-OSCustomizationNicMapping -IpMode UseStaticIp -IpAddress $VM.IP -SubnetMask "255.255.255.0" -DefaultGateway $VM.Gateway
    
    # 从模板部署
    New-VM -Name $VM.Name -Template $Template -ResourcePool $Cluster -Datastore $Datastore -OSCustomizationSpec $CustomSpec -Location "Production"
    
    # 启动VM
    Start-VM -VM $VM.Name
    
    # 删除临时规范
    Remove-OSCustomizationSpec -OSCustomizationSpec $CustomSpec -Confirm:$false
    
    Write-Host "虚拟机 $($VM.Name) 部署完成并已启动"
}

Write-Host "所有虚拟机部署完成!"
```

---

## KVM虚拟机模板

### 使用virt-sysprep创建模板

```bash
# virt-sysprep 是libguestfs工具集的一部分
# 用于重置/清理VM以用作模板

# 1. 安装工具
dnf install -y libguestfs-tools virt-manager

# 2. 创建基础VM (使用virt-install)
virt-install \
  --name rocky9-template \
  --memory 2048 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/rocky9-template.qcow2,size=30,format=qcow2 \
  --cdrom /var/lib/libvirt/images/Rocky-9.3-x86_64-dvd.iso \
  --os-variant rhel9.0 \
  --network bridge=br0 \
  --graphics vnc \
  --console pty,target_type=serial

# 3. 安装OS并优化 (参考前面的优化脚本)

# 4. 关闭VM
virsh shutdown rocky9-template

# 5. 使用virt-sysprep清理
virt-sysprep -d rocky9-template

# virt-sysprep会自动执行:
# - 删除SSH主机密钥
# - 删除machine-id
# - 清理日志
# - 删除临时文件
# - 清理bash历史
# - 重置hostname
# - 清理网络配置
# ... 等等40多个操作

# 6. 查看virt-sysprep会执行的操作
virt-sysprep --list-operations

# 7. 自定义virt-sysprep操作
virt-sysprep -d rocky9-template \
  --operations dhcp-client-state,dhcp-server-state,logfiles,machine-id,ssh-hostkeys,ssh-userdir,tmp-files

# 8. 压缩磁盘映像 (节省空间)
virt-sparsify --compress /var/lib/libvirt/images/rocky9-template.qcow2 \
  /var/lib/libvirt/images/rocky9-template-sparse.qcow2

# 9. 将清理后的VM作为模板使用
# 方法1: 克隆
virt-clone --original rocky9-template --name web-server-01 --file /var/lib/libvirt/images/web-server-01.qcow2

# 方法2: 基于模板创建新VM (使用backing file)
qemu-img create -f qcow2 -F qcow2 -b /var/lib/libvirt/images/rocky9-template.qcow2 \
  /var/lib/libvirt/images/web-server-02.qcow2

virt-install \
  --name web-server-02 \
  --memory 4096 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/web-server-02.qcow2 \
  --import \
  --os-variant rhel9.0 \
  --network bridge=br0 \
  --graphics vnc \
  --noautoconsole
```

### Cloud-init模板

```bash
# Cloud-init允许通过元数据自动配置VM

# 1. 下载官方Cloud Image (已经包含cloud-init)
wget https://download.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2 \
  -O /var/lib/libvirt/images/rocky9-cloud-template.qcow2

# 2. 准备cloud-init配置文件

# user-data.yaml - 用户配置
cat > /tmp/user-data.yaml << 'EOF'
#cloud-config
hostname: web-server-01
fqdn: web-server-01.company.local

# 用户配置
users:
  - name: admin
    groups: wheel
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABA... your-public-key

# SSH配置
ssh_pwauth: true
disable_root: false

# 时区
timezone: Asia/Shanghai

# 安装软件包
packages:
  - vim
  - wget
  - curl
  - git

# 运行命令
runcmd:
  - systemctl enable --now chronyd
  - echo "Cloud-init配置完成" > /root/cloud-init-done.txt
EOF

# meta-data.yaml - 元数据
cat > /tmp/meta-data.yaml << 'EOF'
instance-id: web-server-01
local-hostname: web-server-01
EOF

# network-config.yaml - 网络配置
cat > /tmp/network-config.yaml << 'EOF'
version: 2
ethernets:
  eth0:
    addresses:
      - 192.168.20.101/24
    gateway4: 192.168.20.1
    nameservers:
      addresses:
        - 192.168.10.53
        - 192.168.10.54
      search:
        - company.local
EOF

# 3. 创建Cloud-init ISO
cloud-localds /var/lib/libvirt/images/web-server-01-cloud-init.iso \
  /tmp/user-data.yaml /tmp/meta-data.yaml \
  --network-config=/tmp/network-config.yaml

# 4. 创建VM磁盘 (基于Cloud Image)
qemu-img create -f qcow2 -F qcow2 \
  -b /var/lib/libvirt/images/rocky9-cloud-template.qcow2 \
  /var/lib/libvirt/images/web-server-01.qcow2 50G

# 5. 部署VM
virt-install \
  --name web-server-01 \
  --memory 4096 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/web-server-01.qcow2,device=disk,bus=virtio \
  --disk path=/var/lib/libvirt/images/web-server-01-cloud-init.iso,device=cdrom \
  --os-variant rhel9.0 \
  --network bridge=br0,model=virtio \
  --graphics vnc \
  --import \
  --noautoconsole

# 6. VM启动后，cloud-init会自动:
# - 扩展磁盘分区
# - 配置主机名
# - 配置网络
# - 创建用户
# - 安装软件包
# - 运行自定义脚本
# 全程无需人工干预!

# 7. 连接VM
# 等待2-3分钟让cloud-init完成配置
ssh admin@192.168.20.101
```

---

## 容器化OS模板

### CoreOS/Flatcar模板

```bash
# Flatcar Container Linux 是CoreOS的继任者
# 专为容器优化的不可变OS

# 1. 下载Flatcar镜像
wget https://stable.release.flatcar-linux.net/amd64-usr/current/flatcar_production_qemu_image.img.bz2
bunzip2 flatcar_production_qemu_image.img.bz2

# 转换为qcow2格式
qemu-img convert -f raw -O qcow2 flatcar_production_qemu_image.img \
  /var/lib/libvirt/images/flatcar-template.qcow2

# 2. 创建Ignition配置 (Flatcar使用Ignition而非Cloud-init)
cat > /tmp/flatcar-ignition.json << 'EOF'
{
  "ignition": {
    "version": "3.3.0"
  },
  "passwd": {
    "users": [
      {
        "name": "core",
        "sshAuthorizedKeys": [
          "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABA... your-public-key"
        ]
      }
    ]
  },
  "storage": {
    "files": [
      {
        "path": "/etc/hostname",
        "mode": 420,
        "contents": {
          "source": "data:,k8s-node-01"
        }
      }
    ]
  },
  "systemd": {
    "units": [
      {
        "name": "docker.service",
        "enabled": true
      }
    ]
  }
}
EOF

# 3. 创建Ignition配置磁盘
mkisofs -output /var/lib/libvirt/images/flatcar-ignition.iso \
  -volid ignition /tmp/flatcar-ignition.json

# 4. 部署Flatcar VM
virt-install \
  --name k8s-node-01 \
  --memory 4096 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/flatcar-k8s-node-01.qcow2,format=qcow2,size=50,backing_store=/var/lib/libvirt/images/flatcar-template.qcow2 \
  --disk path=/var/lib/libvirt/images/flatcar-ignition.iso,device=cdrom \
  --os-variant generic \
  --network bridge=br0 \
  --graphics vnc \
  --import \
  --noautoconsole
```

### Ubuntu Cloud Image模板

```bash
# Ubuntu官方提供优化的Cloud Image

# 1. 下载Ubuntu 22.04 Cloud Image
wget https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-amd64.img \
  -O /var/lib/libvirt/images/ubuntu2204-cloud-template.img

# 转换为qcow2并调整大小
qemu-img convert -f qcow2 -O qcow2 ubuntu-22.04-server-cloudimg-amd64.img \
  /var/lib/libvirt/images/ubuntu2204-cloud-template.qcow2
qemu-img resize /var/lib/libvirt/images/ubuntu2204-cloud-template.qcow2 50G

# 2. 创建Cloud-init配置 (Ubuntu格式)
cat > /tmp/ubuntu-user-data.yaml << 'EOF'
#cloud-config
hostname: ubuntu-vm-01

users:
  - name: ubuntu
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABA...

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - vim
  - git

runcmd:
  - systemctl enable --now docker
  - usermod -aG docker ubuntu
EOF

# 3. 创建network配置
cat > /tmp/ubuntu-network-config.yaml << 'EOF'
version: 2
ethernets:
  enp1s0:
    dhcp4: false
    addresses: [192.168.20.110/24]
    gateway4: 192.168.20.1
    nameservers:
      addresses: [192.168.10.53, 8.8.8.8]
EOF

# 4. 生成cloud-init ISO
cloud-localds /var/lib/libvirt/images/ubuntu-vm-01-cloud-init.iso \
  /tmp/ubuntu-user-data.yaml \
  --network-config=/tmp/ubuntu-network-config.yaml

# 5. 部署Ubuntu VM
virt-install \
  --name ubuntu-vm-01 \
  --memory 4096 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/ubuntu-vm-01.qcow2,format=qcow2,size=50,backing_store=/var/lib/libvirt/images/ubuntu2204-cloud-template.qcow2 \
  --disk path=/var/lib/libvirt/images/ubuntu-vm-01-cloud-init.iso,device=cdrom \
  --os-variant ubuntu22.04 \
  --network bridge=br0,model=virtio \
  --graphics vnc \
  --import \
  --noautoconsole

# 几分钟后即可SSH登录
ssh ubuntu@192.168.20.110
```

---

## 模板管理最佳实践

```yaml
版本管理:
  命名规范:
    格式: Template-<OS>-<Version>-v<X.Y>-<Date>
    示例: 
      - Template-Win2022-Std-v1.0-20251019
      - Template-Rocky9-Base-v2.3-20251019
      - Template-Ubuntu2204-K8s-v1.5-20251019
  
  版本控制:
    主版本号 (X): 大版本更新 (OS升级、重大变更)
    次版本号 (Y): 小版本更新 (补丁、软件更新)
    日期: YYYYMMDD格式
  
  变更日志:
    记录每个版本的变更内容
    包括: 补丁列表、软件版本、配置变更
    存储: vCenter注释 / 独立文档

存储管理:
  专用文件夹:
    路径: /Templates/Windows, /Templates/Linux, /Templates/Containers
    权限: 只读 (防止误修改)
  
  存储策略:
    VMware: 使用高性能存储策略
    KVM: 存储在高速SSD池
    备份: 定期备份模板文件
  
  清理策略:
    保留: 最新2个版本
    归档: 旧版本移动到归档存储
    删除: 超过1年的旧版本

更新流程:
  定期更新 (建议每季度):
    1. 克隆现有模板为工作副本
    2. 启动工作副本并打补丁
    3. 运行安全扫描
    4. 测试验证
    5. 转换为新版本模板
    6. 更新文档和变更日志
    7. 通知团队新版本可用
  
  紧急更新 (安全补丁):
    1. 评估影响范围
    2. 快速创建补丁版本
    3. 加速测试流程
    4. 快速部署
    5. 事后总结

测试验证:
  功能测试:
    - 从模板部署VM能否正常启动
    - 网络配置是否正确应用
    - 定制化参数是否生效
    - SSH/RDP是否可访问
  
  性能测试:
    - 启动时间
    - 资源占用
    - I/O性能
    - 网络性能
  
  安全测试:
    - 漏洞扫描 (Nessus/OpenVAS)
    - 合规性检查
    - 最小化服务验证
    - 防火墙规则验证

文档化:
  模板清单:
    - 模板名称和版本
    - 用途和适用场景
    - 预装软件列表
    - 资源配置
    - 网络要求
    - 特殊配置说明
  
  部署指南:
    - 从模板部署步骤
    - 自定义配置说明
    - 故障排查
    - FAQ
```

---

## 自动化模板部署

**Terraform + vSphere Provider**:

```hcl
# =============================================
# Terraform配置 - 从模板部署VM
# =============================================

# provider.tf
terraform {
  required_providers {
    vsphere = {
      source = "hashicorp/vsphere"
      version = "~> 2.5"
    }
  }
}

provider "vsphere" {
  user                 = var.vsphere_user
  password             = var.vsphere_password
  vsphere_server       = var.vsphere_server
  allow_unverified_ssl = true
}

# variables.tf
variable "vsphere_server" {
  default = "vcenter.company.local"
}

variable "vsphere_user" {
  default = "administrator@vsphere.local"
}

variable "vsphere_password" {
  sensitive = true
}

# main.tf
data "vsphere_datacenter" "dc" {
  name = "Company-DC"
}

data "vsphere_compute_cluster" "cluster" {
  name          = "Prod-Cluster"
  datacenter_id = data.vsphere_datacenter.dc.id
}

data "vsphere_datastore" "datastore" {
  name          = "vsanDatastore"
  datacenter_id = data.vsphere_datacenter.dc.id
}

data "vsphere_network" {
  name          = "PG-Production"
  datacenter_id = data.vsphere_datacenter.dc.id
}

data "vsphere_virtual_machine" "template" {
  name          = "Template-Rocky9-Base-v1.0"
  datacenter_id = data.vsphere_datacenter.dc.id
}

# 部署Web服务器集群
resource "vsphere_virtual_machine" "web" {
  count            = 3
  name             = "web-server-${count.index + 1}"
  resource_pool_id = data.vsphere_compute_cluster.cluster.resource_pool_id
  datastore_id     = data.vsphere_datastore.datastore.id
  
  num_cpus = 4
  memory   = 8192
  guest_id = data.vsphere_virtual_machine.template.guest_id
  
  network_interface {
    network_id   = data.vsphere_network.network.id
    adapter_type = data.vsphere_virtual_machine.template.network_interface_types[0]
  }
  
  disk {
    label            = "disk0"
    size             = 50
    thin_provisioned = true
  }
  
  clone {
    template_uuid = data.vsphere_virtual_machine.template.id
    
    customize {
      linux_options {
        host_name = "web-server-${count.index + 1}"
        domain    = "company.local"
      }
      
      network_interface {
        ipv4_address = "192.168.20.${101 + count.index}"
        ipv4_netmask = 24
      }
      
      ipv4_gateway = "192.168.20.1"
      dns_server_list = ["192.168.10.53", "192.168.10.54"]
    }
  }
}

# outputs.tf
output "web_server_ips" {
  value = vsphere_virtual_machine.web[*].default_ip_address
}

# 部署:
# terraform init
# terraform plan
# terraform apply -var="vsphere_password=YourPassword"
```

**Ansible Playbook批量部署**:

```yaml
# deploy-from-template.yml
---
- name: 从模板批量部署虚拟机
  hosts: localhost
  gather_facts: no
  
  vars:
    vcenter_hostname: "vcenter.company.local"
    vcenter_username: "administrator@vsphere.local"
    vcenter_password: "YourPassword"
    datacenter: "Company-DC"
    cluster: "Prod-Cluster"
    datastore: "vsanDatastore"
    template_name: "Template-Rocky9-Base-v1.0"
    network: "PG-Production"
    
    vms:
      - name: app-server-01
        ip: 192.168.20.121
        cpu: 4
        memory: 8192
      - name: app-server-02
        ip: 192.168.20.122
        cpu: 4
        memory: 8192
      - name: app-server-03
        ip: 192.168.20.123
        cpu: 4
        memory: 8192
  
  tasks:
    - name: 从模板部署虚拟机
      vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: no
        
        datacenter: "{{ datacenter }}"
        cluster: "{{ cluster }}"
        name: "{{ item.name }}"
        template: "{{ template_name }}"
        
        hardware:
          num_cpus: "{{ item.cpu }}"
          memory_mb: "{{ item.memory }}"
        
        networks:
          - name: "{{ network }}"
            ip: "{{ item.ip }}"
            netmask: "255.255.255.0"
            gateway: "192.168.20.1"
            dns_servers:
              - 192.168.10.53
              - 192.168.10.54
        
        customization:
          hostname: "{{ item.name }}"
          domain: company.local
        
        datastore: "{{ datastore }}"
        state: poweredon
        wait_for_ip_address: yes
      
      loop: "{{ vms }}"
      delegate_to: localhost
      register: deploy_result
    
    - name: 显示部署结果
      debug:
        msg: "VM {{ item.item.name }} 已部署，IP: {{ item.instance.ipv4 }}"
      loop: "{{ deploy_result.results }}"

# 执行:
# ansible-playbook deploy-from-template.yml
```

---

**文档版本**: v1.0  
**创建时间**: 2025-10-19  
**适用平台**: VMware vSphere 7.0+, KVM/QEMU, Cloud-init  
**状态**: ✅ 生产就绪
