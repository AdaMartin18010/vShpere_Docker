# è™šæ‹Ÿæœºæ¨¡æ¿åˆ›å»ºä¸ç®¡ç†

> **è¿”å›**: [è½¯ä»¶å®‰è£…ç›®å½•](README.md) | [è™šæ‹ŸåŒ–éƒ¨ç½²é¦–é¡µ](../README.md) | [éƒ¨ç½²æŒ‡å—é¦–é¡µ](../../00_ç´¢å¼•å¯¼èˆª/README.md)

---

## ğŸ“‹ ç›®å½•

- [è™šæ‹Ÿæœºæ¨¡æ¿åˆ›å»ºä¸ç®¡ç†](#è™šæ‹Ÿæœºæ¨¡æ¿åˆ›å»ºä¸ç®¡ç†)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¨¡æ¿æ¦‚è¿°](#æ¨¡æ¿æ¦‚è¿°)
  - [VMwareè™šæ‹Ÿæœºæ¨¡æ¿](#vmwareè™šæ‹Ÿæœºæ¨¡æ¿)
    - [Windows Server 2022æ¨¡æ¿](#windows-server-2022æ¨¡æ¿)
    - [Linux (Rocky Linux 9) æ¨¡æ¿](#linux-rocky-linux-9-æ¨¡æ¿)
    - [æ¨¡æ¿è½¬æ¢ä¸å…‹éš†](#æ¨¡æ¿è½¬æ¢ä¸å…‹éš†)
  - [KVMè™šæ‹Ÿæœºæ¨¡æ¿](#kvmè™šæ‹Ÿæœºæ¨¡æ¿)
    - [ä½¿ç”¨virt-sysprepåˆ›å»ºæ¨¡æ¿](#ä½¿ç”¨virt-sysprepåˆ›å»ºæ¨¡æ¿)
    - [Cloud-initæ¨¡æ¿](#cloud-initæ¨¡æ¿)
  - [å®¹å™¨åŒ–OSæ¨¡æ¿](#å®¹å™¨åŒ–osæ¨¡æ¿)
    - [CoreOS/Flatcaræ¨¡æ¿](#coreosflatcaræ¨¡æ¿)
    - [Ubuntu Cloud Imageæ¨¡æ¿](#ubuntu-cloud-imageæ¨¡æ¿)
  - [æ¨¡æ¿ç®¡ç†æœ€ä½³å®è·µ](#æ¨¡æ¿ç®¡ç†æœ€ä½³å®è·µ)
  - [è‡ªåŠ¨åŒ–æ¨¡æ¿éƒ¨ç½²](#è‡ªåŠ¨åŒ–æ¨¡æ¿éƒ¨ç½²)

---

## æ¨¡æ¿æ¦‚è¿°

è™šæ‹Ÿæœºæ¨¡æ¿æ˜¯é¢„é…ç½®çš„è™šæ‹Ÿæœºé•œåƒï¼Œç”¨äºå¿«é€Ÿéƒ¨ç½²æ ‡å‡†åŒ–è™šæ‹Ÿæœºï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

```yaml
æ¨¡æ¿ä¼˜åŠ¿:
  æ ‡å‡†åŒ–:
    - ç»Ÿä¸€æ“ä½œç³»ç»Ÿç‰ˆæœ¬
    - ç»Ÿä¸€è½¯ä»¶åŒ…ç‰ˆæœ¬
    - ç»Ÿä¸€å®‰å…¨é…ç½®
    - ç»Ÿä¸€ä¼˜åŒ–å‚æ•°
  
  æ•ˆç‡:
    - å¿«é€Ÿéƒ¨ç½² (ç§’çº§åˆ°åˆ†é’Ÿçº§)
    - æ‰¹é‡éƒ¨ç½²èƒ½åŠ›
    - å‡å°‘äººå·¥æ“ä½œ
    - é™ä½å‡ºé”™ç‡
  
  ç®¡ç†:
    - é›†ä¸­ç‰ˆæœ¬ç®¡ç†
    - æ˜“äºæ›´æ–°ç»´æŠ¤
    - ä¾¿äºåˆè§„å®¡è®¡
    - å¯è¿½æº¯æ€§

æ¨¡æ¿ç±»å‹:
  åŸºç¡€æ¨¡æ¿:
    - æœ€å°åŒ–OSå®‰è£…
    - åŸºç¡€å·¥å…·åŒ…
    - ç³»ç»Ÿä¼˜åŒ–é…ç½®
    - é€‚ç”¨: ä½œä¸ºå…¶ä»–æ¨¡æ¿çš„åŸºç¡€
  
  åº”ç”¨æ¨¡æ¿:
    - åŸºç¡€æ¨¡æ¿ + åº”ç”¨è½¯ä»¶
    - å¦‚: WebæœåŠ¡å™¨ã€æ•°æ®åº“æœåŠ¡å™¨
    - é€‚ç”¨: ç‰¹å®šç”¨é€”å¿«é€Ÿéƒ¨ç½²
  
  å®¹å™¨å®¿ä¸»æ¨¡æ¿:
    - å®¹å™¨è¿è¡Œæ—¶é¢„å®‰è£…
    - Docker/containerd/CRI-O
    - KubernetesèŠ‚ç‚¹å°±ç»ª
    - é€‚ç”¨: å®¹å™¨åŒ–ç¯å¢ƒ
```

---

## VMwareè™šæ‹Ÿæœºæ¨¡æ¿

### Windows Server 2022æ¨¡æ¿

**é˜¶æ®µ1: åˆ›å»ºåŸºç¡€è™šæ‹Ÿæœº**:

```yaml
è™šæ‹Ÿæœºé…ç½®:
  åç§°: Template-Win2022-Std
  è™šæ‹Ÿç¡¬ä»¶ç‰ˆæœ¬: 20 (ESXi 8.0)
  
  è®¡ç®—èµ„æº:
    vCPU: 2æ ¸
    å†…å­˜: 4GB
    CPUé¢„ç•™: 0 (æ¨¡æ¿ä¸éœ€è¦é¢„ç•™)
  
  å­˜å‚¨:
    ç£ç›˜1: 60GB (ç²¾ç®€ç½®å¤‡)
    ç£ç›˜ç±»å‹: SCSI
    SCSIæ§åˆ¶å™¨: VMware Paravirtual (PVSCSI)
  
  ç½‘ç»œ:
    ç½‘å¡1: VMXNET3
    ç½‘ç»œ: PG-Production
    è¿æ¥: å¼€æœºæ—¶è¿æ¥
  
  å…¶ä»–è®¾å¤‡:
    CD/DVD: å®¢æˆ·ç«¯è®¾å¤‡ (ç”¨äºå®‰è£…)
    è½¯é©±: åˆ é™¤
```

**é˜¶æ®µ2: å®‰è£…Windows Server 2022**:

```powershell
# å®‰è£…è¿‡ç¨‹:
# 1. æŒ‚è½½Windows Server 2022 ISO
# 2. å¯åŠ¨è™šæ‹Ÿæœºï¼ŒæŒ‰ç…§å®‰è£…å‘å¯¼æ“ä½œ
# 3. é€‰æ‹©: Windows Server 2022 Standard (æ¡Œé¢ä½“éªŒ/Core)
# 4. åˆ†åŒº: ä½¿ç”¨æ•´ä¸ªç£ç›˜
# 5. è®¾ç½®ç®¡ç†å‘˜å¯†ç  (å®‰è£…åéœ€é‡ç½®)

# å®‰è£…å®Œæˆåï¼Œè¿›å…¥ç³»ç»Ÿé…ç½®é˜¶æ®µ
```

**é˜¶æ®µ3: å®‰è£…VMware Tools**:

```powershell
# åœ¨vCenterä¸­: VM -> å®¢æˆ·æœº -> å®‰è£…VMware Tools
# åœ¨è™šæ‹Ÿæœºå†…å®‰è£…VMware Tools:
# - æŒ‚è½½VMware Tools ISO
# - è¿è¡Œ D:\setup64.exe
# - å®Œæ•´å®‰è£… (åŒ…å«æ‰€æœ‰ç»„ä»¶)
# - é‡å¯è™šæ‹Ÿæœº

# éªŒè¯å®‰è£…:
Get-Service -Name VMTools
# çŠ¶æ€åº”ä¸º: Running
```

**é˜¶æ®µ4: Windowsç³»ç»Ÿä¼˜åŒ–**:

```powershell
# ===================================
# Windows Server 2022 æ¨¡æ¿ä¼˜åŒ–è„šæœ¬
# ===================================

# 1. è®¾ç½®è®¡ç®—æœºå (éƒ¨ç½²æ—¶ä¼šé‡ç½®)
Rename-Computer -NewName "TEMPLATE" -Force

# 2. é…ç½®æ—¶åŒº
Set-TimeZone -Id "China Standard Time"

# 3. ç¦ç”¨IPv6 (å¦‚æœä¸ä½¿ç”¨)
Get-NetAdapterBinding -ComponentID ms_tcpip6 | Disable-NetAdapterBinding

# 4. é…ç½®Windows Updateä¸ºæ‰‹åŠ¨
Set-Service -Name wuauserv -StartupType Manual
Stop-Service -Name wuauserv

# 5. ç¦ç”¨ä¼‘çœ 
powercfg /h off

# 6. è®¾ç½®ç”µæºè®¡åˆ’ä¸ºé«˜æ€§èƒ½
$PowerPlan = Get-CimInstance -Name root\cimv2\power -Class win32_PowerPlan -Filter "ElementName = 'High performance'"
$PowerPlan | Invoke-CimMethod -MethodName Activate

# 7. ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡
$DisableServices = @(
    "WSearch",           # Windows Search
    "Spooler",           # æ‰“å°åå°å¤„ç†ç¨‹åº (å¦‚ä¸éœ€è¦æ‰“å°)
    "RemoteRegistry",    # è¿œç¨‹æ³¨å†Œè¡¨
    "WerSvc"             # Windowsé”™è¯¯æŠ¥å‘Š
)

foreach ($service in $DisableServices) {
    Set-Service -Name $service -StartupType Disabled
    Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
}

# 8. ä¼˜åŒ–ç½‘ç»œå‚æ•°
# ç¦ç”¨IPv6ç»„ä»¶ (å¦‚æœå·²ç¦ç”¨IPv6)
New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters" `
    -Name "DisabledComponents" -Value 0xffffffff -PropertyType DWord -Force

# 9. é…ç½®è¿œç¨‹æ¡Œé¢
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
    -Name "fDenyTSConnections" -Value 0
Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

# 10. é…ç½®Windowsé˜²ç«å¢™åŸºæœ¬è§„åˆ™
# å…è®¸ICMPv4 (ping)
New-NetFirewallRule -DisplayName "ICMPv4-In" -Protocol ICMPv4 -IcmpType 8 -Enabled True -Direction Inbound

# 11. å®‰è£…å¸¸ç”¨å·¥å…· (ä½¿ç”¨Chocolatey)
Set-ExecutionPolicy Bypass -Scope Process -Force
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

# å®‰è£…å¸¸ç”¨è½¯ä»¶
choco install -y `
    7zip `
    notepadplusplus `
    putty `
    winscp `
    googlechrome

# 12. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
Remove-Item -Path "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item -Path "C:\Windows\Temp\*" -Recurse -Force -ErrorAction SilentlyContinue

# 13. è¿è¡ŒWindows Update (è·å–æœ€æ–°è¡¥ä¸)
Install-Module PSWindowsUpdate -Force
Get-WindowsUpdate -Install -AcceptAll -AutoReboot

Write-Host "Windowsä¼˜åŒ–å®Œæˆï¼è¯·æ£€æŸ¥åè¿è¡ŒSysprepã€‚"
```

**é˜¶æ®µ5: è¿è¡ŒSysprep**:

```powershell
# Sysprep (ç³»ç»Ÿå‡†å¤‡å·¥å…·) - ç”¨äºé€šç”¨åŒ–Windowsæ˜ åƒ

# æ–¹æ³•1: ä½¿ç”¨å›¾å½¢ç•Œé¢
C:\Windows\System32\Sysprep\sysprep.exe
# é€‰é¡¹:
#   ç³»ç»Ÿæ¸…ç†æ“ä½œ: è¿›å…¥ç³»ç»Ÿå…¨æ–°ä½“éªŒ(OOBE)
#   é€šç”¨: å‹¾é€‰
#   å…³æœºé€‰é¡¹: å…³æœº

# æ–¹æ³•2: ä½¿ç”¨å‘½ä»¤è¡Œ (æ¨èè‡ªåŠ¨åŒ–)
C:\Windows\System32\Sysprep\sysprep.exe /oobe /generalize /shutdown /mode:vm

# Sysprepåšä»€ä¹ˆ:
# - åˆ é™¤å”¯ä¸€æ ‡è¯†ç¬¦ (SID)
# - åˆ é™¤ç³»ç»Ÿè¿˜åŸç‚¹
# - åˆ é™¤äº‹ä»¶æ—¥å¿—
# - åˆ é™¤ä¸´æ—¶æ–‡ä»¶
# - é‡ç½®æ¿€æ´»ä¿¡æ¯

# âš ï¸ æ³¨æ„äº‹é¡¹:
# - SysprepåVMä¼šè‡ªåŠ¨å…³æœº
# - ä¸è¦å†å¯åŠ¨æ­¤VMï¼Œç›´æ¥è½¬æ¢ä¸ºæ¨¡æ¿
# - Windowsæœ€å¤šåªèƒ½è¿è¡Œ3æ¬¡Sysprep (é‡ç½®è®¡æ•°å™¨éœ€ç‰¹æ®Šæ–¹æ³•)
```

**é˜¶æ®µ6: è½¬æ¢ä¸ºæ¨¡æ¿**:

```yaml
# åœ¨vCenterä¸­æ“ä½œ:

æ–¹æ³•1: è½¬æ¢ä¸ºæ¨¡æ¿ (æ¨èç”Ÿäº§ç¯å¢ƒ)
  æ“ä½œ: å³é”®VM -> æ¨¡æ¿ -> è½¬æ¢ä¸ºæ¨¡æ¿
  ç»“æœ: 
    - VMæ¶ˆå¤±ï¼Œå˜ä¸ºæ¨¡æ¿å¯¹è±¡
    - ä¸èƒ½ç›´æ¥å¯åŠ¨
    - éœ€è¦éƒ¨ç½²(å…‹éš†)æ‰èƒ½ä½¿ç”¨
  ä¼˜ç‚¹:
    - é˜²æ­¢è¯¯æ“ä½œå¯åŠ¨
    - èŠ‚çœèµ„æº
  
æ–¹æ³•2: å…‹éš†ä¸ºæ¨¡æ¿ (æ¨èæµ‹è¯•ç¯å¢ƒ)
  æ“ä½œ: å³é”®VM -> å…‹éš† -> å…‹éš†ä¸ºæ¨¡æ¿
  ç»“æœ:
    - åŸVMä¿ç•™
    - æ–°å»ºæ¨¡æ¿å¯¹è±¡
  ä¼˜ç‚¹:
    - å¯ä»¥ä¿ç•™æºVMç»§ç»­æµ‹è¯•
    - æ›´çµæ´»

# æ¨¡æ¿å‘½åè§„èŒƒç¤ºä¾‹:
# Template-Win2022-Std-v1.0-20251019
# å«ä¹‰: æ¨¡æ¿-ç³»ç»Ÿç‰ˆæœ¬-ç‰ˆæœ¬å·-æ—¥æœŸ

# æ¨¡æ¿å­˜å‚¨ä½ç½®:
# å»ºè®®åˆ›å»ºä¸“é—¨çš„"Templates"æ–‡ä»¶å¤¹å­˜æ”¾æ‰€æœ‰æ¨¡æ¿
```

### Linux (Rocky Linux 9) æ¨¡æ¿

**é˜¶æ®µ1: åˆ›å»ºåŸºç¡€è™šæ‹Ÿæœº**:

```yaml
è™šæ‹Ÿæœºé…ç½®:
  åç§°: Template-Rocky9-Base
  è™šæ‹Ÿç¡¬ä»¶ç‰ˆæœ¬: 20
  
  è®¡ç®—èµ„æº:
    vCPU: 2æ ¸
    å†…å­˜: 2GB
  
  å­˜å‚¨:
    ç£ç›˜1: 30GB (ç²¾ç®€ç½®å¤‡)
    ç£ç›˜ç±»å‹: SCSI (PVSCSI)
  
  ç½‘ç»œ:
    ç½‘å¡1: VMXNET3
    ç½‘ç»œ: PG-Production
```

**é˜¶æ®µ2: å®‰è£…Rocky Linux 9**:

```bash
# ä½¿ç”¨æœ€å°åŒ–å®‰è£… + æ ‡å‡†å·¥å…·
# åˆ†åŒºæ–¹æ¡ˆ:
/boot/efi  512MB   (EFIç³»ç»Ÿåˆ†åŒº)
/boot      1GB     (XFS)
/          å‰©ä½™ç©ºé—´ (XFS, LVM)

# ç½‘ç»œé…ç½®: DHCP (åç»­Cloud-initä¼šé‡æ–°é…ç½®)
# Rootå¯†ç : è®¾ç½®ä¸´æ—¶å¯†ç  (åç»­åˆ é™¤)
```

**é˜¶æ®µ3: ç³»ç»Ÿä¼˜åŒ–è„šæœ¬**:

```bash
#!/bin/bash
# ===============================================
# Rocky Linux 9 è™šæ‹Ÿæœºæ¨¡æ¿ä¼˜åŒ–è„šæœ¬
# ===============================================

set -e

echo "å¼€å§‹ä¼˜åŒ–Rocky Linux 9æ¨¡æ¿..."

# 1. æ›´æ–°ç³»ç»Ÿåˆ°æœ€æ–°
echo "1/15 æ›´æ–°ç³»ç»Ÿ..."
dnf update -y

# 2. å®‰è£…åŸºç¡€å·¥å…·åŒ…
echo "2/15 å®‰è£…åŸºç¡€å·¥å…·..."
dnf install -y \
    vim \
    wget \
    curl \
    net-tools \
    bind-utils \
    telnet \
    tcpdump \
    lsof \
    strace \
    sysstat \
    iotop \
    htop \
    tree \
    git \
    rsync \
    screen \
    tmux \
    bash-completion \
    yum-utils \
    device-mapper-persistent-data \
    lvm2

# 3. å®‰è£…open-vm-tools (VMware Toolså¼€æºç‰ˆæœ¬)
echo "3/15 å®‰è£…VMware Tools..."
dnf install -y open-vm-tools
systemctl enable --now vmtoolsd

# 4. é…ç½®SSH
echo "4/15 é…ç½®SSH..."
cat >> /etc/ssh/sshd_config << 'EOF'

# ä¼˜åŒ–SSHé…ç½®
UseDNS no
GSSAPIAuthentication no
PermitRootLogin yes
PubkeyAuthentication yes
PasswordAuthentication yes
ClientAliveInterval 60
ClientAliveCountMax 3
EOF

systemctl restart sshd

# 5. é…ç½®ç½‘ç»œ
echo "5/15 é…ç½®ç½‘ç»œ..."
# ç¡®ä¿ç½‘ç»œè¿æ¥è‡ªåŠ¨å¯åŠ¨
nmcli connection modify $(nmcli -t -f NAME connection show | head -1) connection.autoconnect yes

# 6. é…ç½®æ—¶é—´åŒæ­¥
echo "6/15 é…ç½®æ—¶é—´åŒæ­¥..."
timedatectl set-timezone Asia/Shanghai
systemctl enable --now chronyd

# 7. ç¦ç”¨SELinux (å¯é€‰ï¼Œæ ¹æ®å®‰å…¨ç­–ç•¥å†³å®š)
echo "7/15 é…ç½®SELinux..."
# ç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ç½®ä¸ºenforcing
sed -i 's/^SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
setenforce 0 2>/dev/null || true

# 8. é…ç½®é˜²ç«å¢™
echo "8/15 é…ç½®é˜²ç«å¢™..."
# å¼€å¯é˜²ç«å¢™å¹¶é…ç½®åŸºæœ¬è§„åˆ™
systemctl enable --now firewalld
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-icmp-block-inversion
firewall-cmd --reload

# 9. å†…æ ¸å‚æ•°ä¼˜åŒ–
echo "9/15 ä¼˜åŒ–å†…æ ¸å‚æ•°..."
cat >> /etc/sysctl.d/99-vm-tuning.conf << 'EOF'
# ç½‘ç»œä¼˜åŒ–
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_tw_reuse = 1
net.ipv4.ip_local_port_range = 1024 65000
net.core.somaxconn = 32768
net.core.netdev_max_backlog = 32768

# æ€§èƒ½ä¼˜åŒ–
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
fs.file-max = 2097152

# å®‰å…¨ä¼˜åŒ–
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
EOF

sysctl -p /etc/sysctl.d/99-vm-tuning.conf

# 10. èµ„æºé™åˆ¶é…ç½®
echo "10/15 é…ç½®èµ„æºé™åˆ¶..."
cat >> /etc/security/limits.conf << 'EOF'

# æé«˜èµ„æºé™åˆ¶
* soft nofile 65536
* hard nofile 65536
* soft nproc 65536
* hard nproc 65536
* soft memlock unlimited
* hard memlock unlimited
EOF

# 11. é…ç½®æ—¥å¿—è½®è½¬
echo "11/15 é…ç½®æ—¥å¿—è½®è½¬..."
cat > /etc/logrotate.d/custom << 'EOF'
/var/log/messages /var/log/secure /var/log/maillog /var/log/cron {
    daily
    rotate 7
    missingok
    notifempty
    compress
    sharedscripts
    postrotate
        /usr/bin/systemctl kill -s HUP rsyslog.service >/dev/null 2>&1 || true
    endscript
}
EOF

# 12. ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡
echo "12/15 ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡..."
systemctl disable postfix 2>/dev/null || true

# 13. é…ç½®GRUB
echo "13/15 ä¼˜åŒ–GRUBé…ç½®..."
# å‡å°‘GRUBè¶…æ—¶æ—¶é—´
sed -i 's/^GRUB_TIMEOUT=.*/GRUB_TIMEOUT=1/' /etc/default/grub
grub2-mkconfig -o /boot/grub2/grub.cfg

# 14. å®‰è£…å¹¶é…ç½®qemu-guest-agent (å¦‚æœä½¿ç”¨KVM)
echo "14/15 å®‰è£…qemu-guest-agent..."
dnf install -y qemu-guest-agent
systemctl enable --now qemu-guest-agent

# 15. æ¸…ç†ç³»ç»Ÿ
echo "15/15 æ¸…ç†ç³»ç»Ÿ..."
# æ¸…ç†yumç¼“å­˜
dnf clean all
rm -rf /var/cache/dnf/*

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf /tmp/*
rm -rf /var/tmp/*

# æ¸…ç†æ—¥å¿—
find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
> /var/log/wtmp
> /var/log/btmp
> /var/log/lastlog

# æ¸…ç†å†å²è®°å½•
history -c
rm -f /root/.bash_history
rm -f /home/*/.bash_history

# æ¸…ç†SSHå¯†é’¥ (é‡è¦! æ¯ä¸ªVMéœ€è¦å”¯ä¸€å¯†é’¥)
rm -f /etc/ssh/ssh_host_*

# æ¸…ç†machine-id (é‡è¦! æ¯ä¸ªVMéœ€è¦å”¯ä¸€ID)
truncate -s 0 /etc/machine-id
rm -f /var/lib/dbus/machine-id

# æ¸…ç†ç½‘ç»œé…ç½®ä¸­çš„UUIDå’ŒMACåœ°å€
sed -i '/^UUID=/d' /etc/sysconfig/network-scripts/ifcfg-*
sed -i '/^HWADDR=/d' /etc/sysconfig/network-scripts/ifcfg-*

echo "======================================"
echo "Rocky Linux 9 æ¨¡æ¿ä¼˜åŒ–å®Œæˆ!"
echo "è¯·å…³æœºå¹¶è½¬æ¢ä¸ºæ¨¡æ¿ã€‚"
echo "======================================"
```

**é˜¶æ®µ4: å®‰è£…Cloud-init (æ¨è)**:

```bash
# Cloud-init ç”¨äºVMé¦–æ¬¡å¯åŠ¨æ—¶çš„è‡ªåŠ¨åŒ–é…ç½®
# åŒ…æ‹¬: ä¸»æœºåã€ç½‘ç»œã€SSHå¯†é’¥ã€ç”¨æˆ·åˆ›å»ºç­‰

# å®‰è£…cloud-init
dnf install -y cloud-init cloud-utils-growpart

# é…ç½®cloud-init
cat > /etc/cloud/cloud.cfg << 'EOF'
# Cloud-inité…ç½®
users:
 - default

disable_root: false
ssh_pwauth: true

mount_default_fields: [~, ~, 'auto', 'defaults,nofail', '0', '2']
resize_rootfs_tmp: /dev
ssh_deletekeys: true
ssh_genkeytypes: ['rsa', 'ecdsa', 'ed25519']

cloud_init_modules:
 - migrator
 - seed_random
 - bootcmd
 - write-files
 - growpart
 - resizefs
 - disk_setup
 - mounts
 - set_hostname
 - update_hostname
 - update_etc_hosts
 - ca-certs
 - rsyslog
 - users-groups
 - ssh

cloud_config_modules:
 - emit_upstart
 - ssh-import-id
 - locale
 - set-passwords
 - grub-dpkg
 - apt-pipelining
 - apt-configure
 - timezone
 - runcmd

cloud_final_modules:
 - package-update-upgrade-install
 - scripts-vendor
 - scripts-per-once
 - scripts-per-boot
 - scripts-per-instance
 - scripts-user
 - ssh-authkey-fingerprints
 - keys-to-console
 - final-message

# VMwareæ•°æ®æºé…ç½®
datasource_list: [ VMware, OVF, None ]
datasource:
  VMware:
    vmware_cust_file_max_wait: 25
EOF

# å¯ç”¨cloud-init
systemctl enable cloud-init cloud-init-local cloud-config cloud-final

# æ¸…ç†cloud-initçŠ¶æ€ (ç¡®ä¿æ–°VMé‡æ–°è¿è¡Œcloud-init)
cloud-init clean --logs --seed

# å…³æœº
poweroff
```

**é˜¶æ®µ5: è½¬æ¢ä¸ºæ¨¡æ¿**:

```bash
# åœ¨vCenterä¸­: å³é”®VM -> æ¨¡æ¿ -> è½¬æ¢ä¸ºæ¨¡æ¿
# æˆ–ä½¿ç”¨PowerCLI:
Get-VM "Template-Rocky9-Base" | Set-VM -ToTemplate -Confirm:$false
```

### æ¨¡æ¿è½¬æ¢ä¸å…‹éš†

**ä»æ¨¡æ¿éƒ¨ç½²è™šæ‹Ÿæœº (vCenter Webç•Œé¢)**:

```yaml
éƒ¨ç½²æ–°è™šæ‹Ÿæœº:
  æ­¥éª¤:
    1. å³é”®æ¨¡æ¿ -> æ–°è™šæ‹Ÿæœº(ä»æ­¤æ¨¡æ¿)
    
    2. é€‰æ‹©åç§°å’Œæ–‡ä»¶å¤¹:
       åç§°: web-server-01
       æ–‡ä»¶å¤¹: Production/Web-Servers
    
    3. é€‰æ‹©è®¡ç®—èµ„æº:
       é›†ç¾¤: Prod-Cluster
       ä¸»æœº: (è‡ªåŠ¨åˆ†é…)
    
    4. é€‰æ‹©å­˜å‚¨:
       æ•°æ®å­˜å‚¨: vsanDatastore
       å­˜å‚¨ç­–ç•¥: vSAN-Standard-FTT1
    
    5. é€‰æ‹©å…‹éš†é€‰é¡¹:
       å…‹éš†ç±»å‹: 
         - å®Œæ•´å…‹éš† (ç‹¬ç«‹å‰¯æœ¬, æ¨è)
         - é“¾æ¥å…‹éš† (ä¾èµ–æ¨¡æ¿, èŠ‚çœç©ºé—´)
       
       è‡ªå®šä¹‰æ“ä½œç³»ç»Ÿ: æ˜¯
       
    6. è‡ªå®šä¹‰è§„èŒƒ (Guest Customization):
       Windows:
         è®¡ç®—æœºå: web-server-01
         äº§å“å¯†é’¥: (å¯é€‰)
         ç®¡ç†å‘˜å¯†ç : è®¾ç½®æ–°å¯†ç 
         æ—¶åŒº: (GMT+08:00) åŒ—äº¬,é‡åº†,é¦™æ¸¯,ä¹Œé²æœ¨é½
         ç½‘ç»œ:
           IPåœ°å€: 192.168.20.100
           å­ç½‘æ©ç : 255.255.255.0
           ç½‘å…³: 192.168.20.1
           DNS: 192.168.10.53, 192.168.10.54
       
       Linux:
         ä¸»æœºå: web-server-01
         DNSåç¼€: company.local
         ç½‘ç»œ:
           (åŒWindows)
    
    7. å®Œæˆéƒ¨ç½²
```

**ä½¿ç”¨PowerCLIæ‰¹é‡éƒ¨ç½²**:

```powershell
# ========================================
# PowerCLIæ‰¹é‡éƒ¨ç½²è„šæœ¬
# ========================================

# è¿æ¥vCenter
Connect-VIServer -Server vcenter.company.local -User administrator@vsphere.local

# å®šä¹‰VMåˆ—è¡¨
$VMs = @(
    @{Name="web-01"; IP="192.168.20.101"; Gateway="192.168.20.1"},
    @{Name="web-02"; IP="192.168.20.102"; Gateway="192.168.20.1"},
    @{Name="web-03"; IP="192.168.20.103"; Gateway="192.168.20.1"}
)

# æ¨¡æ¿åç§°
$Template = "Template-Rocky9-Base"

# ç›®æ ‡æ•°æ®å­˜å‚¨
$Datastore = "vsanDatastore"

# ç›®æ ‡é›†ç¾¤
$Cluster = "Prod-Cluster"

# ç½‘ç»œ
$Network = "PG-Production"

# å¾ªç¯éƒ¨ç½²
foreach ($VM in $VMs) {
    Write-Host "éƒ¨ç½²è™šæ‹Ÿæœº: $($VM.Name)"
    
    # åˆ›å»ºè‡ªå®šä¹‰è§„èŒƒ
    $CustomSpec = New-OSCustomizationSpec -Name "Temp-$($VM.Name)" -OSType Linux -Domain company.local -DnsServer "192.168.10.53","192.168.10.54" -NamingScheme Fixed -NamingPrefix $VM.Name
    
    # é…ç½®ç½‘ç»œ
    Get-OSCustomizationNicMapping -OSCustomizationSpec $CustomSpec | Set-OSCustomizationNicMapping -IpMode UseStaticIp -IpAddress $VM.IP -SubnetMask "255.255.255.0" -DefaultGateway $VM.Gateway
    
    # ä»æ¨¡æ¿éƒ¨ç½²
    New-VM -Name $VM.Name -Template $Template -ResourcePool $Cluster -Datastore $Datastore -OSCustomizationSpec $CustomSpec -Location "Production"
    
    # å¯åŠ¨VM
    Start-VM -VM $VM.Name
    
    # åˆ é™¤ä¸´æ—¶è§„èŒƒ
    Remove-OSCustomizationSpec -OSCustomizationSpec $CustomSpec -Confirm:$false
    
    Write-Host "è™šæ‹Ÿæœº $($VM.Name) éƒ¨ç½²å®Œæˆå¹¶å·²å¯åŠ¨"
}

Write-Host "æ‰€æœ‰è™šæ‹Ÿæœºéƒ¨ç½²å®Œæˆ!"
```

---

## KVMè™šæ‹Ÿæœºæ¨¡æ¿

### ä½¿ç”¨virt-sysprepåˆ›å»ºæ¨¡æ¿

```bash
# virt-sysprep æ˜¯libguestfså·¥å…·é›†çš„ä¸€éƒ¨åˆ†
# ç”¨äºé‡ç½®/æ¸…ç†VMä»¥ç”¨ä½œæ¨¡æ¿

# 1. å®‰è£…å·¥å…·
dnf install -y libguestfs-tools virt-manager

# 2. åˆ›å»ºåŸºç¡€VM (ä½¿ç”¨virt-install)
virt-install \
  --name rocky9-template \
  --memory 2048 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/rocky9-template.qcow2,size=30,format=qcow2 \
  --cdrom /var/lib/libvirt/images/Rocky-9.3-x86_64-dvd.iso \
  --os-variant rhel9.0 \
  --network bridge=br0 \
  --graphics vnc \
  --console pty,target_type=serial

# 3. å®‰è£…OSå¹¶ä¼˜åŒ– (å‚è€ƒå‰é¢çš„ä¼˜åŒ–è„šæœ¬)

# 4. å…³é—­VM
virsh shutdown rocky9-template

# 5. ä½¿ç”¨virt-sysprepæ¸…ç†
virt-sysprep -d rocky9-template

# virt-sysprepä¼šè‡ªåŠ¨æ‰§è¡Œ:
# - åˆ é™¤SSHä¸»æœºå¯†é’¥
# - åˆ é™¤machine-id
# - æ¸…ç†æ—¥å¿—
# - åˆ é™¤ä¸´æ—¶æ–‡ä»¶
# - æ¸…ç†bashå†å²
# - é‡ç½®hostname
# - æ¸…ç†ç½‘ç»œé…ç½®
# ... ç­‰ç­‰40å¤šä¸ªæ“ä½œ

# 6. æŸ¥çœ‹virt-sysprepä¼šæ‰§è¡Œçš„æ“ä½œ
virt-sysprep --list-operations

# 7. è‡ªå®šä¹‰virt-sysprepæ“ä½œ
virt-sysprep -d rocky9-template \
  --operations dhcp-client-state,dhcp-server-state,logfiles,machine-id,ssh-hostkeys,ssh-userdir,tmp-files

# 8. å‹ç¼©ç£ç›˜æ˜ åƒ (èŠ‚çœç©ºé—´)
virt-sparsify --compress /var/lib/libvirt/images/rocky9-template.qcow2 \
  /var/lib/libvirt/images/rocky9-template-sparse.qcow2

# 9. å°†æ¸…ç†åçš„VMä½œä¸ºæ¨¡æ¿ä½¿ç”¨
# æ–¹æ³•1: å…‹éš†
virt-clone --original rocky9-template --name web-server-01 --file /var/lib/libvirt/images/web-server-01.qcow2

# æ–¹æ³•2: åŸºäºæ¨¡æ¿åˆ›å»ºæ–°VM (ä½¿ç”¨backing file)
qemu-img create -f qcow2 -F qcow2 -b /var/lib/libvirt/images/rocky9-template.qcow2 \
  /var/lib/libvirt/images/web-server-02.qcow2

virt-install \
  --name web-server-02 \
  --memory 4096 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/web-server-02.qcow2 \
  --import \
  --os-variant rhel9.0 \
  --network bridge=br0 \
  --graphics vnc \
  --noautoconsole
```

### Cloud-initæ¨¡æ¿

```bash
# Cloud-initå…è®¸é€šè¿‡å…ƒæ•°æ®è‡ªåŠ¨é…ç½®VM

# 1. ä¸‹è½½å®˜æ–¹Cloud Image (å·²ç»åŒ…å«cloud-init)
wget https://download.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2 \
  -O /var/lib/libvirt/images/rocky9-cloud-template.qcow2

# 2. å‡†å¤‡cloud-inité…ç½®æ–‡ä»¶

# user-data.yaml - ç”¨æˆ·é…ç½®
cat > /tmp/user-data.yaml << 'EOF'
#cloud-config
hostname: web-server-01
fqdn: web-server-01.company.local

# ç”¨æˆ·é…ç½®
users:
  - name: admin
    groups: wheel
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABA... your-public-key

# SSHé…ç½®
ssh_pwauth: true
disable_root: false

# æ—¶åŒº
timezone: Asia/Shanghai

# å®‰è£…è½¯ä»¶åŒ…
packages:
  - vim
  - wget
  - curl
  - git

# è¿è¡Œå‘½ä»¤
runcmd:
  - systemctl enable --now chronyd
  - echo "Cloud-inité…ç½®å®Œæˆ" > /root/cloud-init-done.txt
EOF

# meta-data.yaml - å…ƒæ•°æ®
cat > /tmp/meta-data.yaml << 'EOF'
instance-id: web-server-01
local-hostname: web-server-01
EOF

# network-config.yaml - ç½‘ç»œé…ç½®
cat > /tmp/network-config.yaml << 'EOF'
version: 2
ethernets:
  eth0:
    addresses:
      - 192.168.20.101/24
    gateway4: 192.168.20.1
    nameservers:
      addresses:
        - 192.168.10.53
        - 192.168.10.54
      search:
        - company.local
EOF

# 3. åˆ›å»ºCloud-init ISO
cloud-localds /var/lib/libvirt/images/web-server-01-cloud-init.iso \
  /tmp/user-data.yaml /tmp/meta-data.yaml \
  --network-config=/tmp/network-config.yaml

# 4. åˆ›å»ºVMç£ç›˜ (åŸºäºCloud Image)
qemu-img create -f qcow2 -F qcow2 \
  -b /var/lib/libvirt/images/rocky9-cloud-template.qcow2 \
  /var/lib/libvirt/images/web-server-01.qcow2 50G

# 5. éƒ¨ç½²VM
virt-install \
  --name web-server-01 \
  --memory 4096 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/web-server-01.qcow2,device=disk,bus=virtio \
  --disk path=/var/lib/libvirt/images/web-server-01-cloud-init.iso,device=cdrom \
  --os-variant rhel9.0 \
  --network bridge=br0,model=virtio \
  --graphics vnc \
  --import \
  --noautoconsole

# 6. VMå¯åŠ¨åï¼Œcloud-initä¼šè‡ªåŠ¨:
# - æ‰©å±•ç£ç›˜åˆ†åŒº
# - é…ç½®ä¸»æœºå
# - é…ç½®ç½‘ç»œ
# - åˆ›å»ºç”¨æˆ·
# - å®‰è£…è½¯ä»¶åŒ…
# - è¿è¡Œè‡ªå®šä¹‰è„šæœ¬
# å…¨ç¨‹æ— éœ€äººå·¥å¹²é¢„!

# 7. è¿æ¥VM
# ç­‰å¾…2-3åˆ†é’Ÿè®©cloud-initå®Œæˆé…ç½®
ssh admin@192.168.20.101
```

---

## å®¹å™¨åŒ–OSæ¨¡æ¿

### CoreOS/Flatcaræ¨¡æ¿

```bash
# Flatcar Container Linux æ˜¯CoreOSçš„ç»§ä»»è€…
# ä¸“ä¸ºå®¹å™¨ä¼˜åŒ–çš„ä¸å¯å˜OS

# 1. ä¸‹è½½Flatcaré•œåƒ
wget https://stable.release.flatcar-linux.net/amd64-usr/current/flatcar_production_qemu_image.img.bz2
bunzip2 flatcar_production_qemu_image.img.bz2

# è½¬æ¢ä¸ºqcow2æ ¼å¼
qemu-img convert -f raw -O qcow2 flatcar_production_qemu_image.img \
  /var/lib/libvirt/images/flatcar-template.qcow2

# 2. åˆ›å»ºIgnitioné…ç½® (Flatcarä½¿ç”¨Ignitionè€ŒéCloud-init)
cat > /tmp/flatcar-ignition.json << 'EOF'
{
  "ignition": {
    "version": "3.3.0"
  },
  "passwd": {
    "users": [
      {
        "name": "core",
        "sshAuthorizedKeys": [
          "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABA... your-public-key"
        ]
      }
    ]
  },
  "storage": {
    "files": [
      {
        "path": "/etc/hostname",
        "mode": 420,
        "contents": {
          "source": "data:,k8s-node-01"
        }
      }
    ]
  },
  "systemd": {
    "units": [
      {
        "name": "docker.service",
        "enabled": true
      }
    ]
  }
}
EOF

# 3. åˆ›å»ºIgnitioné…ç½®ç£ç›˜
mkisofs -output /var/lib/libvirt/images/flatcar-ignition.iso \
  -volid ignition /tmp/flatcar-ignition.json

# 4. éƒ¨ç½²Flatcar VM
virt-install \
  --name k8s-node-01 \
  --memory 4096 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/flatcar-k8s-node-01.qcow2,format=qcow2,size=50,backing_store=/var/lib/libvirt/images/flatcar-template.qcow2 \
  --disk path=/var/lib/libvirt/images/flatcar-ignition.iso,device=cdrom \
  --os-variant generic \
  --network bridge=br0 \
  --graphics vnc \
  --import \
  --noautoconsole
```

### Ubuntu Cloud Imageæ¨¡æ¿

```bash
# Ubuntuå®˜æ–¹æä¾›ä¼˜åŒ–çš„Cloud Image

# 1. ä¸‹è½½Ubuntu 22.04 Cloud Image
wget https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-amd64.img \
  -O /var/lib/libvirt/images/ubuntu2204-cloud-template.img

# è½¬æ¢ä¸ºqcow2å¹¶è°ƒæ•´å¤§å°
qemu-img convert -f qcow2 -O qcow2 ubuntu-22.04-server-cloudimg-amd64.img \
  /var/lib/libvirt/images/ubuntu2204-cloud-template.qcow2
qemu-img resize /var/lib/libvirt/images/ubuntu2204-cloud-template.qcow2 50G

# 2. åˆ›å»ºCloud-inité…ç½® (Ubuntuæ ¼å¼)
cat > /tmp/ubuntu-user-data.yaml << 'EOF'
#cloud-config
hostname: ubuntu-vm-01

users:
  - name: ubuntu
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABA...

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - vim
  - git

runcmd:
  - systemctl enable --now docker
  - usermod -aG docker ubuntu
EOF

# 3. åˆ›å»ºnetworké…ç½®
cat > /tmp/ubuntu-network-config.yaml << 'EOF'
version: 2
ethernets:
  enp1s0:
    dhcp4: false
    addresses: [192.168.20.110/24]
    gateway4: 192.168.20.1
    nameservers:
      addresses: [192.168.10.53, 8.8.8.8]
EOF

# 4. ç”Ÿæˆcloud-init ISO
cloud-localds /var/lib/libvirt/images/ubuntu-vm-01-cloud-init.iso \
  /tmp/ubuntu-user-data.yaml \
  --network-config=/tmp/ubuntu-network-config.yaml

# 5. éƒ¨ç½²Ubuntu VM
virt-install \
  --name ubuntu-vm-01 \
  --memory 4096 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/ubuntu-vm-01.qcow2,format=qcow2,size=50,backing_store=/var/lib/libvirt/images/ubuntu2204-cloud-template.qcow2 \
  --disk path=/var/lib/libvirt/images/ubuntu-vm-01-cloud-init.iso,device=cdrom \
  --os-variant ubuntu22.04 \
  --network bridge=br0,model=virtio \
  --graphics vnc \
  --import \
  --noautoconsole

# å‡ åˆ†é’Ÿåå³å¯SSHç™»å½•
ssh ubuntu@192.168.20.110
```

---

## æ¨¡æ¿ç®¡ç†æœ€ä½³å®è·µ

```yaml
ç‰ˆæœ¬ç®¡ç†:
  å‘½åè§„èŒƒ:
    æ ¼å¼: Template-<OS>-<Version>-v<X.Y>-<Date>
    ç¤ºä¾‹: 
      - Template-Win2022-Std-v1.0-20251019
      - Template-Rocky9-Base-v2.3-20251019
      - Template-Ubuntu2204-K8s-v1.5-20251019
  
  ç‰ˆæœ¬æ§åˆ¶:
    ä¸»ç‰ˆæœ¬å· (X): å¤§ç‰ˆæœ¬æ›´æ–° (OSå‡çº§ã€é‡å¤§å˜æ›´)
    æ¬¡ç‰ˆæœ¬å· (Y): å°ç‰ˆæœ¬æ›´æ–° (è¡¥ä¸ã€è½¯ä»¶æ›´æ–°)
    æ—¥æœŸ: YYYYMMDDæ ¼å¼
  
  å˜æ›´æ—¥å¿—:
    è®°å½•æ¯ä¸ªç‰ˆæœ¬çš„å˜æ›´å†…å®¹
    åŒ…æ‹¬: è¡¥ä¸åˆ—è¡¨ã€è½¯ä»¶ç‰ˆæœ¬ã€é…ç½®å˜æ›´
    å­˜å‚¨: vCenteræ³¨é‡Š / ç‹¬ç«‹æ–‡æ¡£

å­˜å‚¨ç®¡ç†:
  ä¸“ç”¨æ–‡ä»¶å¤¹:
    è·¯å¾„: /Templates/Windows, /Templates/Linux, /Templates/Containers
    æƒé™: åªè¯» (é˜²æ­¢è¯¯ä¿®æ”¹)
  
  å­˜å‚¨ç­–ç•¥:
    VMware: ä½¿ç”¨é«˜æ€§èƒ½å­˜å‚¨ç­–ç•¥
    KVM: å­˜å‚¨åœ¨é«˜é€ŸSSDæ± 
    å¤‡ä»½: å®šæœŸå¤‡ä»½æ¨¡æ¿æ–‡ä»¶
  
  æ¸…ç†ç­–ç•¥:
    ä¿ç•™: æœ€æ–°2ä¸ªç‰ˆæœ¬
    å½’æ¡£: æ—§ç‰ˆæœ¬ç§»åŠ¨åˆ°å½’æ¡£å­˜å‚¨
    åˆ é™¤: è¶…è¿‡1å¹´çš„æ—§ç‰ˆæœ¬

æ›´æ–°æµç¨‹:
  å®šæœŸæ›´æ–° (å»ºè®®æ¯å­£åº¦):
    1. å…‹éš†ç°æœ‰æ¨¡æ¿ä¸ºå·¥ä½œå‰¯æœ¬
    2. å¯åŠ¨å·¥ä½œå‰¯æœ¬å¹¶æ‰“è¡¥ä¸
    3. è¿è¡Œå®‰å…¨æ‰«æ
    4. æµ‹è¯•éªŒè¯
    5. è½¬æ¢ä¸ºæ–°ç‰ˆæœ¬æ¨¡æ¿
    6. æ›´æ–°æ–‡æ¡£å’Œå˜æ›´æ—¥å¿—
    7. é€šçŸ¥å›¢é˜Ÿæ–°ç‰ˆæœ¬å¯ç”¨
  
  ç´§æ€¥æ›´æ–° (å®‰å…¨è¡¥ä¸):
    1. è¯„ä¼°å½±å“èŒƒå›´
    2. å¿«é€Ÿåˆ›å»ºè¡¥ä¸ç‰ˆæœ¬
    3. åŠ é€Ÿæµ‹è¯•æµç¨‹
    4. å¿«é€Ÿéƒ¨ç½²
    5. äº‹åæ€»ç»“

æµ‹è¯•éªŒè¯:
  åŠŸèƒ½æµ‹è¯•:
    - ä»æ¨¡æ¿éƒ¨ç½²VMèƒ½å¦æ­£å¸¸å¯åŠ¨
    - ç½‘ç»œé…ç½®æ˜¯å¦æ­£ç¡®åº”ç”¨
    - å®šåˆ¶åŒ–å‚æ•°æ˜¯å¦ç”Ÿæ•ˆ
    - SSH/RDPæ˜¯å¦å¯è®¿é—®
  
  æ€§èƒ½æµ‹è¯•:
    - å¯åŠ¨æ—¶é—´
    - èµ„æºå ç”¨
    - I/Oæ€§èƒ½
    - ç½‘ç»œæ€§èƒ½
  
  å®‰å…¨æµ‹è¯•:
    - æ¼æ´æ‰«æ (Nessus/OpenVAS)
    - åˆè§„æ€§æ£€æŸ¥
    - æœ€å°åŒ–æœåŠ¡éªŒè¯
    - é˜²ç«å¢™è§„åˆ™éªŒè¯

æ–‡æ¡£åŒ–:
  æ¨¡æ¿æ¸…å•:
    - æ¨¡æ¿åç§°å’Œç‰ˆæœ¬
    - ç”¨é€”å’Œé€‚ç”¨åœºæ™¯
    - é¢„è£…è½¯ä»¶åˆ—è¡¨
    - èµ„æºé…ç½®
    - ç½‘ç»œè¦æ±‚
    - ç‰¹æ®Šé…ç½®è¯´æ˜
  
  éƒ¨ç½²æŒ‡å—:
    - ä»æ¨¡æ¿éƒ¨ç½²æ­¥éª¤
    - è‡ªå®šä¹‰é…ç½®è¯´æ˜
    - æ•…éšœæ’æŸ¥
    - FAQ
```

---

## è‡ªåŠ¨åŒ–æ¨¡æ¿éƒ¨ç½²

**Terraform + vSphere Provider**:

```hcl
# =============================================
# Terraformé…ç½® - ä»æ¨¡æ¿éƒ¨ç½²VM
# =============================================

# provider.tf
terraform {
  required_providers {
    vsphere = {
      source = "hashicorp/vsphere"
      version = "~> 2.5"
    }
  }
}

provider "vsphere" {
  user                 = var.vsphere_user
  password             = var.vsphere_password
  vsphere_server       = var.vsphere_server
  allow_unverified_ssl = true
}

# variables.tf
variable "vsphere_server" {
  default = "vcenter.company.local"
}

variable "vsphere_user" {
  default = "administrator@vsphere.local"
}

variable "vsphere_password" {
  sensitive = true
}

# main.tf
data "vsphere_datacenter" "dc" {
  name = "Company-DC"
}

data "vsphere_compute_cluster" "cluster" {
  name          = "Prod-Cluster"
  datacenter_id = data.vsphere_datacenter.dc.id
}

data "vsphere_datastore" "datastore" {
  name          = "vsanDatastore"
  datacenter_id = data.vsphere_datacenter.dc.id
}

data "vsphere_network" {
  name          = "PG-Production"
  datacenter_id = data.vsphere_datacenter.dc.id
}

data "vsphere_virtual_machine" "template" {
  name          = "Template-Rocky9-Base-v1.0"
  datacenter_id = data.vsphere_datacenter.dc.id
}

# éƒ¨ç½²WebæœåŠ¡å™¨é›†ç¾¤
resource "vsphere_virtual_machine" "web" {
  count            = 3
  name             = "web-server-${count.index + 1}"
  resource_pool_id = data.vsphere_compute_cluster.cluster.resource_pool_id
  datastore_id     = data.vsphere_datastore.datastore.id
  
  num_cpus = 4
  memory   = 8192
  guest_id = data.vsphere_virtual_machine.template.guest_id
  
  network_interface {
    network_id   = data.vsphere_network.network.id
    adapter_type = data.vsphere_virtual_machine.template.network_interface_types[0]
  }
  
  disk {
    label            = "disk0"
    size             = 50
    thin_provisioned = true
  }
  
  clone {
    template_uuid = data.vsphere_virtual_machine.template.id
    
    customize {
      linux_options {
        host_name = "web-server-${count.index + 1}"
        domain    = "company.local"
      }
      
      network_interface {
        ipv4_address = "192.168.20.${101 + count.index}"
        ipv4_netmask = 24
      }
      
      ipv4_gateway = "192.168.20.1"
      dns_server_list = ["192.168.10.53", "192.168.10.54"]
    }
  }
}

# outputs.tf
output "web_server_ips" {
  value = vsphere_virtual_machine.web[*].default_ip_address
}

# éƒ¨ç½²:
# terraform init
# terraform plan
# terraform apply -var="vsphere_password=YourPassword"
```

**Ansible Playbookæ‰¹é‡éƒ¨ç½²**:

```yaml
# deploy-from-template.yml
---
- name: ä»æ¨¡æ¿æ‰¹é‡éƒ¨ç½²è™šæ‹Ÿæœº
  hosts: localhost
  gather_facts: no
  
  vars:
    vcenter_hostname: "vcenter.company.local"
    vcenter_username: "administrator@vsphere.local"
    vcenter_password: "YourPassword"
    datacenter: "Company-DC"
    cluster: "Prod-Cluster"
    datastore: "vsanDatastore"
    template_name: "Template-Rocky9-Base-v1.0"
    network: "PG-Production"
    
    vms:
      - name: app-server-01
        ip: 192.168.20.121
        cpu: 4
        memory: 8192
      - name: app-server-02
        ip: 192.168.20.122
        cpu: 4
        memory: 8192
      - name: app-server-03
        ip: 192.168.20.123
        cpu: 4
        memory: 8192
  
  tasks:
    - name: ä»æ¨¡æ¿éƒ¨ç½²è™šæ‹Ÿæœº
      vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: no
        
        datacenter: "{{ datacenter }}"
        cluster: "{{ cluster }}"
        name: "{{ item.name }}"
        template: "{{ template_name }}"
        
        hardware:
          num_cpus: "{{ item.cpu }}"
          memory_mb: "{{ item.memory }}"
        
        networks:
          - name: "{{ network }}"
            ip: "{{ item.ip }}"
            netmask: "255.255.255.0"
            gateway: "192.168.20.1"
            dns_servers:
              - 192.168.10.53
              - 192.168.10.54
        
        customization:
          hostname: "{{ item.name }}"
          domain: company.local
        
        datastore: "{{ datastore }}"
        state: poweredon
        wait_for_ip_address: yes
      
      loop: "{{ vms }}"
      delegate_to: localhost
      register: deploy_result
    
    - name: æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
      debug:
        msg: "VM {{ item.item.name }} å·²éƒ¨ç½²ï¼ŒIP: {{ item.instance.ipv4 }}"
      loop: "{{ deploy_result.results }}"

# æ‰§è¡Œ:
# ansible-playbook deploy-from-template.yml
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-19  
**é€‚ç”¨å¹³å°**: VMware vSphere 7.0+, KVM/QEMU, Cloud-init  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
