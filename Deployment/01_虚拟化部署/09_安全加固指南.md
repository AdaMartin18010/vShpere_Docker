# 虚拟化平台安全加固指南

> **返回**: [虚拟化部署首页](README.md) | [部署指南首页](../00_索引导航/README.md)

---

## 📋 目录

- [虚拟化平台安全加固指南](#虚拟化平台安全加固指南)
  - [📋 目录](#-目录)
  - [安全加固概述](#安全加固概述)
  - [ESXi主机安全加固](#esxi主机安全加固)
    - [1. 访问控制](#1-访问控制)
    - [2. 网络安全](#2-网络安全)
    - [3. 日志与审计](#3-日志与审计)
    - [4. 补丁管理](#4-补丁管理)
    - [5. 高级安全配置](#5-高级安全配置)
  - [vCenter Server安全加固](#vcenter-server安全加固)
    - [1. VCSA (vCenter Server Appliance) 加固](#1-vcsa-vcenter-server-appliance-加固)
    - [2. SSO (Single Sign-On) 配置](#2-sso-single-sign-on-配置)
    - [3. 角色与权限管理](#3-角色与权限管理)
    - [4. vCenter审计](#4-vcenter审计)
  - [KVM主机安全加固](#kvm主机安全加固)
  - [虚拟机安全加固](#虚拟机安全加固)
  - [网络安全加固](#网络安全加固)
  - [数据加密](#数据加密)
  - [审计与合规](#审计与合规)
  - [安全加固检查清单](#安全加固检查清单)

---

## 安全加固概述

```yaml
安全加固原则:

最小权限原则:
  ✅ 只授予必需的权限
  ✅ 定期审查权限
  ✅ 使用角色基础访问控制(RBAC)

纵深防御:
  ✅ 多层安全控制
  ✅ 网络隔离
  ✅ 访问控制
  ✅ 数据加密

持续监控:
  ✅ 实时安全监控
  ✅ 日志收集与分析
  ✅ 异常检测与告警

合规要求:
  ✅ 等保2.0 (中国)
  ✅ PCI-DSS (金融)
  ✅ GDPR (欧盟)
  ✅ HIPAA (医疗)

威胁模型:

外部威胁:
  - 网络攻击
  - DDoS攻击
  - 恶意软件
  - 勒索软件

内部威胁:
  - 误操作
  - 权限滥用
  - 内部人员恶意行为

虚拟化特有威胁:
  - VM逃逸
  - Hypervisor漏洞
  - 虚拟网络攻击
  - 资源耗尽攻击
```

---

## ESXi主机安全加固

### 1. 访问控制

```bash
# 1.1 禁用root直接登录 (使用个人账户)

# 创建管理员账户
esxcli system account add -i admin-user -p 'Strong@Pass123' -d "Admin User"

# 赋予管理员权限 (通过vCenter)
# vCenter → 主机 → 权限 → 添加权限
# 角色: 管理员

# 1.2 配置账户锁定策略

# 设置密码策略
cat > /etc/pam.d/passwd << EOF
password requisite pam_passwdqc.so retry=3 min=disabled,disabled,disabled,12,12
password sufficient pam_unix.so use_authtok sha512 shadow try_first_pass
password required pam_deny.so
EOF

# 配置账户锁定 (5次失败后锁定15分钟)
esxcli system account set --id=root --password-expires-days=90

# 1.3 配置SSH访问

# 编辑SSH配置
vi /etc/ssh/sshd_config

# 修改以下配置:
PermitRootLogin no               # 禁止root直接登录
PasswordAuthentication no        # 禁用密码认证(使用密钥)
PubkeyAuthentication yes         # 启用密钥认证
ClientAliveInterval 300          # 5分钟超时
ClientAliveCountMax 3
MaxAuthTries 3                   # 最多3次认证尝试
Protocol 2                       # 使用SSH v2
Banner /etc/issue                # 登录Banner

# 重启SSH
/etc/init.d/SSH restart

# 1.4 配置SSH密钥认证

# 在管理机生成密钥对
ssh-keygen -t ed25519 -C "admin@company.local"

# 上传公钥到ESXi
cat ~/.ssh/id_ed25519.pub | ssh root@esxi-01 "cat >> /etc/ssh/keys-root/authorized_keys"

# 设置权限
ssh root@esxi-01 "chmod 600 /etc/ssh/keys-root/authorized_keys"

# 1.5 禁用不必要的服务

# 默认只启用必要服务
# SSH: 仅在需要时启用
# Shell: 仅在需要时启用

# 查看服务状态
esxcli system service list

# 禁用SSH和Shell (生产环境)
esxcli system service disable --name=SSH
esxcli system service disable --name=ESXi Shell

# 临时启用 (自动在1小时后禁用)
vim-cmd hostsvc/enable_ssh
vim-cmd hostsvc/start_ssh
```

### 2. 网络安全

```bash
# 2.1 配置防火墙

# 查看防火墙状态
esxcli network firewall get

# 启用防火墙
esxcli network firewall set --enabled true

# 查看所有规则集
esxcli network firewall ruleset list

# 只启用必要的规则集
esxcli network firewall ruleset set --ruleset-id=sshServer --enabled=true
esxcli network firewall ruleset set --ruleset-id=vSphereClient --enabled=true

# 禁用不需要的规则集
esxcli network firewall ruleset set --ruleset-id=ftpServer --enabled=false
esxcli network firewall ruleset set --ruleset-id=httpClient --enabled=false

# 2.2 限制管理访问IP

# 只允许特定IP访问SSH
esxcli network firewall ruleset set --ruleset-id=sshServer --allowed-all=false
esxcli network firewall ruleset allowedip add --ruleset-id=sshServer --ip-address=192.168.10.0/24

# 只允许特定IP访问vSphere Client
esxcli network firewall ruleset set --ruleset-id=vSphereClient --allowed-all=false
esxcli network firewall ruleset allowedip add --ruleset-id=vSphereClient --ip-address=192.168.10.0/24

# 2.3 禁用IPv6 (如不使用)

# 检查IPv6状态
esxcli network ip get

# 禁用IPv6
esxcli network ip set --ipv6-enabled=false

# 2.4 配置管理网络VLAN隔离

# 管理vmkernel接口应在独立VLAN
# 与VM网络隔离
```

### 3. 日志与审计

```bash
# 3.1 配置远程日志服务器

# 配置syslog
esxcli system syslog config set --loghost='tcp://192.168.10.100:514,tcp://192.168.10.101:514'

# 启用日志转发
esxcli system syslog reload

# 验证配置
esxcli system syslog config get

# 3.2 配置日志级别

# 设置详细日志 (用于安全审计)
esxcli system syslog config set --default-rotate=20 --default-size=10240

# 3.3 开启Shell访问日志

# 所有Shell访问会记录到 /var/log/shell.log

# 3.4 配置登录Banner

# 创建登录警告
cat > /etc/issue << EOF
********************************************************************
*                        WARNING                                   *
*  UNAUTHORIZED ACCESS TO THIS SYSTEM IS FORBIDDEN AND WILL BE     *
*  PROSECUTED BY LAW. BY ACCESSING THIS SYSTEM, YOU AGREE THAT     *
*  YOUR ACTIONS MAY BE MONITORED AND RECORDED.                     *
********************************************************************
EOF

# 应用到SSH
vi /etc/ssh/sshd_config
# 添加: Banner /etc/issue
```

### 4. 补丁管理

```yaml
补丁管理策略:

定期更新:
  - 每月检查安全公告
  - 季度更新周期
  - 关键安全补丁立即应用

测试流程:
  1. 在测试环境先验证
  2. 选择维护窗口
  3. 备份主机配置
  4. 使用Update Manager批量更新
  5. 验证更新后状态

ESXi更新方法:

方法1: 使用vCenter Update Manager
  - 最推荐的方法
  - 可批量更新
  - 支持自动化

方法2: 手动命令行更新
  # 下载补丁包
  # 进入维护模式
  esxcli system maintenanceMode set --enable true
  
  # 安装补丁
  esxcli software vib install -d /vmfs/volumes/datastore1/patches/ESXi-patch.zip
  
  # 重启
  reboot
  
  # 退出维护模式
  esxcli system maintenanceMode set --enable false

订阅安全公告:
  - VMware Security Advisories (VMSA)
  - https://www.vmware.com/security/advisories.html
  - 邮件订阅通知
```

### 5. 高级安全配置

```bash
# 5.1 禁用不安全的协议

# 禁用TLS 1.0/1.1, 只使用TLS 1.2+
esxcli system settings encryption set --min-tls-version=TLS1.2

# 5.2 配置超时时间

# 设置Shell超时 (10分钟)
esxcli system settings advanced set -o /UserVars/ESXiShellTimeOut -i 600

# 设置SSH超时 (10分钟)
esxcli system settings advanced set -o /UserVars/SSHClientAliveCountMax -i 3
esxcli system settings advanced set -o /UserVars/SSHClientAliveInterval -i 200

# 5.3 禁用MOB (Managed Object Browser)

# MOB用于调试,生产环境应禁用
vim-cmd proxysvc/remove_service "/mob" "httpsWithRedirect"

# 5.4 DCUI超时

# 设置DCUI (Direct Console UI) 超时
esxcli system settings advanced set -o /UserVars/DcuiTimeOut -i 600

# 5.5 禁用CIM服务 (如不使用硬件监控)

esxcli system wbem set --enable false
```

---

## vCenter Server安全加固

### 1. VCSA (vCenter Server Appliance) 加固

```bash
# 1.1 访问vCenter管理界面
# https://vcenter.company.local:5480

# 1.2 启用自动备份

# 管理界面 → 备份 → 配置备份
# 位置: SFTP/FTP/HTTP/HTTPS
# 频率: 每日
# 保留: 7天

# 1.3 配置NTP

# 管理界面 → 时间 → 编辑
# 添加NTP服务器:
#   ntp1.aliyun.com
#   ntp2.aliyun.com

# 1.4 更新vCenter

# 管理界面 → 更新 → 检查更新
# 应用所有安全补丁

# 1.5 配置证书

# 使用企业CA签发的证书
# 管理界面 → 证书 → 证书管理

# 或使用Let's Encrypt (外网环境)
```

### 2. SSO (Single Sign-On) 配置

```yaml
SSO安全配置:

密码策略:
  路径: vCenter → 管理 → Single Sign-On → 配置 → 本地账户 → 密码策略
  
  建议设置:
    最小长度: 12字符
    最大长度: 20字符
    最小大写字母: 1
    最小小写字母: 1
    最小数字: 1
    最小特殊字符: 1
    最大有效期: 90天
    限制重用: 5个历史密码

锁定策略:
  路径: vCenter → 管理 → Single Sign-On → 配置 → 本地账户 → 锁定策略
  
  建议设置:
    失败尝试次数: 5次
    失败间隔: 900秒 (15分钟)
    解锁时间: 1800秒 (30分钟)

Token策略:
  路径: vCenter → 管理 → Single Sign-On → 配置 → Token策略
  
  建议设置:
    Token生命周期: 480分钟 (8小时)
    刷新Token生命周期: 1440分钟 (24小时)

集成AD/LDAP:
  路径: vCenter → 管理 → Single Sign-On → 配置 → 身份源
  
  步骤:
    1. 添加身份源 → Active Directory
    2. 输入域名: company.local
    3. 输入AD管理员账户
    4. 测试连接
    5. 添加AD组到vCenter角色
```

### 3. 角色与权限管理

```yaml
RBAC最佳实践:

内置角色:
  - Administrator: 完全控制 (最小化使用)
  - Read-Only: 只读访问
  - No Access: 无访问权限

自定义角色示例:

VM管理员角色:
  权限:
    - VM: 所有VM操作权限
    - 数据存储: 浏览/分配空间
    - 网络: 分配网络
  
  适用: 日常VM管理员

网络管理员角色:
  权限:
    - 网络: 所有网络权限
    - VM: 网络配置权限
  
  适用: 网络团队

备份操作员角色:
  权限:
    - VM: 快照管理
    - 数据存储: 浏览
  
  适用: 备份系统账户

权限分配原则:
  ✅ 最小权限原则
  ✅ 使用AD组而非个人账户
  ✅ 定期审查权限
  ✅ 记录权限变更
  ✅ 使用权限继承 (从数据中心级别)

示例权限结构:
  Datacenter (Company-DC)
    ├─ 权限: AD-Group-Admins → Administrator
    ├─ 生产环境文件夹
    │   └─ 权限: AD-Group-ProdOps → VM管理员
    └─ 测试环境文件夹
        └─ 权限: AD-Group-DevOps → VM管理员
```

### 4. vCenter审计

```bash
# 4.1 启用审计日志

# vCenter事件自动记录到数据库
# 查看事件: vCenter → 监控器 → 事件

# 4.2 配置告警

# 关键安全事件告警:
# - 用户账户创建/删除
# - 权限变更
# - VM删除
# - 配置变更
# - 登录失败

# 创建告警示例:
# vCenter → 配置 → 告警定义 → 添加
# 名称: 用户权限变更
# 目标: vCenter
# 触发器: 权限变更事件
# 操作: 发送邮件

# 4.3 导出审计日志

# 使用PowerCLI导出事件
Get-VIEvent -Start (Get-Date).AddDays(-7) | Export-Csv -Path "events-$(Get-Date -Format 'yyyyMMdd').csv"

# 4.4 集成SIEM

# 转发vCenter日志到SIEM
# 工具: Splunk / ELK / QRadar
# 协议: Syslog / API
```

---

## KVM主机安全加固

```bash
# 1. 系统加固

# 1.1 SELinux配置

# 启用SELinux (推荐enforcing模式)
vi /etc/selinux/config
SELINUX=enforcing
SELINUXTYPE=targeted

# 重启生效
reboot

# 验证
getenforce  # 应显示Enforcing

# SELinux策略
# 允许libvirt/KVM必要的访问

# 1.2 防火墙配置

# 使用firewalld
systemctl enable --now firewalld

# 只开放必要端口
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=libvirt
firewall-cmd --permanent --add-service=libvirt-tls

# 限制SSH访问源IP
firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.10.0/24" service name="ssh" accept'

# 移除default accept
firewall-cmd --permanent --remove-service=ssh
firewall-cmd --reload

# 1.3 SSH加固

# 编辑SSH配置
vi /etc/ssh/sshd_config

PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
X11Forwarding no
MaxAuthTries 3
ClientAliveInterval 300
ClientAliveCountMax 0
AllowUsers admin-user@192.168.10.*

# 重启SSH
systemctl restart sshd

# 1.4 审计配置

# 启用auditd
systemctl enable --now auditd

# 配置审计规则
cat >> /etc/audit/rules.d/kvm.rules << EOF
# 监控VM配置文件变更
-w /etc/libvirt/ -p wa -k libvirt-config
-w /var/lib/libvirt/ -p wa -k libvirt-data

# 监控VM启动/停止
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/virsh -k virsh-commands

# 监控关键系统调用
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
-w /etc/passwd -p wa -k passwd-changes
-w /etc/shadow -p wa -k shadow-changes
EOF

# 重启auditd
service auditd restart

# 查看审计日志
ausearch -k virsh-commands

# 2. libvirt安全配置

# 2.1 启用TLS认证

# 生成CA证书
certtool --generate-privkey > cakey.pem
cat > ca.info << EOF
cn = Company CA
ca
cert_signing_key
expiration_days = 3650
EOF
certtool --generate-self-signed --load-privkey cakey.pem --template ca.info --outfile cacert.pem

# 生成服务器证书
certtool --generate-privkey > serverkey.pem
cat > server.info << EOF
cn = kvm-host-01.company.local
tls_www_server
encryption_key
signing_key
expiration_days = 3650
EOF
certtool --generate-certificate --load-privkey serverkey.pem --load-ca-certificate cacert.pem --load-ca-privkey cakey.pem --template server.info --outfile servercert.pem

# 安装证书
cp cacert.pem /etc/pki/CA/cacert.pem
cp servercert.pem /etc/pki/libvirt/servercert.pem
cp serverkey.pem /etc/pki/libvirt/private/serverkey.pem

# 配置libvirtd使用TLS
vi /etc/libvirt/libvirtd.conf
listen_tls = 1
listen_tcp = 0
tls_port = "16514"
cert_file = "/etc/pki/libvirt/servercert.pem"
key_file = "/etc/pki/libvirt/private/serverkey.pem"

# 重启libvirtd
systemctl restart libvirtd

# 2.2 配置SASL认证

# 安装cyrus-sasl
dnf install -y cyrus-sasl cyrus-sasl-md5

# 配置libvirt使用SASL
vi /etc/libvirt/libvirtd.conf
auth_unix_rw = "sasl"
auth_tls = "sasl"

# 创建SASL用户
saslpasswd2 -a libvirt admin-user

# 3. VM安全配置

# 3.1 VM隔离

# sVirt (SELinux for Virtualization)
# 自动为每个VM分配唯一的SELinux标签
# 确保VM间隔离

# 查看VM的SELinux标签
ps -eZ | grep qemu

# 3.2 VM资源限制

# 防止资源耗尽攻击
virsh edit vm-name

<domain>
  <cputune>
    <shares>1000</shares>
    <quota>100000</quota>
    <period>100000</period>
  </cputune>
  <memtune>
    <hard_limit unit='GiB'>16</hard_limit>
  </memtune>
</domain>

# 3.3 禁用不必要的设备

# 移除软驱/串口等不需要的设备
# 减少攻击面

# 3.4 VM磁盘加密

# 使用LUKS加密VM磁盘
<encryption format='luks'>
  <secret type='passphrase' uuid='f52a81b2-424e-490c-823d-6bd4235bc6de'/>
</encryption>
```

---

## 虚拟机安全加固

```yaml
VM安全加固清单:

1. Guest OS加固:
  
  Linux:
    ✅ 最小化安装
    ✅ 及时更新补丁
    ✅ 配置SELinux/AppArmor
    ✅ 配置防火墙 (firewalld/iptables)
    ✅ 禁用不必要服务
    ✅ 配置SSH密钥认证
    ✅ 安装杀毒软件 (ClamAV)
  
  Windows:
    ✅ 启用Windows Update
    ✅ 安装杀毒软件
    ✅ 启用Windows防火墙
    ✅ 禁用不必要服务
    ✅ 配置用户账户控制(UAC)
    ✅ 启用BitLocker (如需要)
    ✅ 定期运行安全扫描

2. VMware Tools安全:
  
  ✅ 及时更新VMware Tools
  ✅ 禁用不需要的功能:
     - 复制粘贴 (VM ↔ 主机)
     - 拖放文件
     - 控制台剪贴板
  
  # 禁用复制粘贴
  Get-VM "vm-name" | New-AdvancedSetting -Name "isolation.tools.copy.disable" -Value "TRUE"
  Get-VM "vm-name" | New-AdvancedSetting -Name "isolation.tools.paste.disable" -Value "TRUE"
  Get-VM "vm-name" | New-AdvancedSetting -Name "isolation.tools.setGUIOptions.enable" -Value "FALSE"

3. VM配置安全:
  
  ✅ 移除不必要的硬件:
     - 软驱
     - 并口/串口
     - USB控制器 (如不需要)
  
  ✅ 禁用不必要的功能:
     # 禁用VM控制台剪贴板操作
     isolation.tools.copy.disable = TRUE
     isolation.tools.paste.disable = TRUE
     isolation.tools.setGUIOptions.enable = FALSE
     
     # 限制控制台连接
     RemoteDisplay.maxConnections = 1
     
     # 禁用不必要的设备
     isolation.device.connectable.disable = TRUE

4. VM快照安全:
  
  ❌ 不要长期保留快照
  ❌ 快照包含内存时包含敏感数据
  ✅ 快照后及时删除/合并
  ✅ 定期审查快照列表
  
  # 查找所有快照
  Get-VM | Get-Snapshot | Select VM, Name, Created, SizeGB

5. VM备份加密:
  
  ✅ 备份数据加密存储
  ✅ 传输加密 (TLS/SSH)
  ✅ 备份访问控制
  ✅ 定期测试恢复
```

---

## 网络安全加固

```yaml
网络安全分层防御:

1. 网络分段:
  
  VLAN隔离:
    VLAN 10: 管理网络 (ESXi/vCenter)
    VLAN 20: 生产VM网络
    VLAN 30: 测试VM网络
    VLAN 50: DMZ (对外服务)
    VLAN 100: vMotion网络
    VLAN 200: vSAN/存储网络
  
  访问控制:
    ✅ 管理网络严格限制访问源
    ✅ 生产网络与测试网络隔离
    ✅ DMZ不能直接访问内网
    ✅ 使用防火墙控制VLAN间流量

2. vSwitch安全:
  
  端口组安全策略:
    路径: vSwitch → 端口组 → 编辑设置 → 安全
    
    配置:
      混杂模式: 拒绝 (Reject)
        防止VM嗅探其他VM流量
      
      MAC地址更改: 拒绝 (Reject)
        防止MAC欺骗攻击
      
      伪传输: 拒绝 (Reject)
        防止MAC/IP欺骗

3. 分布式防火墙:
  
  使用场景:
    - VM间micro-segmentation
    - 东西向流量控制
    - 应用级访问控制
  
  示例规则:
    规则1: 允许Web → App
      源: Web服务器安全组
      目标: App服务器安全组
      服务: HTTP/HTTPS
      操作: 允许
    
    规则2: 允许App → DB
      源: App服务器安全组
      目标: DB服务器安全组
      服务: MySQL (3306)
      操作: 允许
    
    规则3: 默认拒绝
      源: 任意
      目标: 任意
      服务: 任意
      操作: 拒绝

4. IDS/IPS:
  
  部署位置:
    - 网络边界
    - DMZ入口
    - 关键应用前端
  
  推荐方案:
    - Snort (开源)
    - Suricata (开源)
    - Cisco Firepower
    - Palo Alto Networks

5. VPN安全访问:
  
  远程管理:
    ✅ 使用VPN访问管理网络
    ✅ 多因素认证 (MFA)
    ✅ 限制VPN用户权限
    ✅ VPN日志审计
  
  站点间连接:
    ✅ IPsec VPN加密
    ✅ 或使用专线

6. 网络监控:
  
  ✅ 流量分析 (NetFlow/sFlow)
  ✅ 异常检测
  ✅ DDoS防护
  ✅ 日志收集与分析
```

---

## 数据加密

```yaml
加密层次:

1. 静态数据加密 (Data at Rest):
  
  vSAN加密:
    配置: 集群 → 配置 → vSAN → 服务 → 加密
    
    要求:
      - vSphere 6.6+
      - 企业Plus许可
      - KMS (密钥管理服务器)
    
    性能影响: <5%
  
  VM加密:
    配置: VM → 编辑设置 → VM选项 → 加密
    
    加密内容:
      - VM配置文件
      - 虚拟磁盘
      - VM快照
      - VM内存 (vMotion时)
    
    性能影响: <10%
  
  存储阵列加密:
    - 使用支持加密的存储阵列
    - 自加密驱动器 (SED)
    - 性能影响最小

2. 传输数据加密 (Data in Transit):
  
  vMotion加密:
    配置: VM → 编辑设置 → VM选项 → 加密
    选项: 
      - Disabled: 不加密
      - Opportunistic: 可选加密
      - Required: 强制加密
    
    推荐: Required (关键VM)
  
  管理流量加密:
    ✅ HTTPS (vCenter/ESXi Web)
    ✅ TLS 1.2+ (禁用TLS 1.0/1.1)
    ✅ SSH (主机管理)
  
  存储流量加密:
    ✅ iSCSI over TLS
    ✅ NFS v4.x + Kerberos
    ✅ FC (天然加密)

3. 密钥管理:
  
  KMS集成:
    支持的KMS:
      - VMware vSphere Native Key Provider (7.0+)
      - HyTrust KeyControl
      - Thales CipherTrust Manager
      - IBM Security Key Lifecycle Manager
    
    配置:
      vCenter → 配置 → 密钥管理服务器 → 添加
      - KMS名称
      - 服务器地址
      - 端口 (默认5696)
      - 证书
    
    高可用:
      ✅ 至少2台KMS服务器
      ✅ 不同数据中心
      ✅ 定期备份密钥
  
  密钥轮换:
    ✅ 定期轮换密钥 (如每年)
    ✅ 自动化轮换流程
    ✅ 测试密钥恢复流程

KVM加密:
  
  LUKS磁盘加密:
    # 创建加密磁盘
    cryptsetup luksFormat /dev/vg_storage/vm-disk
    cryptsetup luksOpen /dev/vg_storage/vm-disk vm-disk-encrypted
    
    # 在libvirt中配置
    <encryption format='luks'>
      <secret type='passphrase' uuid='xxx'/>
    </encryption>
  
  网络加密:
    ✅ libvirt TLS
    ✅ QEMU TLS
    ✅ 存储流量加密
```

---

## 审计与合规

```yaml
审计框架:

1. 日志收集:
  
  收集范围:
    ✅ ESXi主机日志
    ✅ vCenter事件
    ✅ VM Guest OS日志
    ✅ 网络设备日志
    ✅ 存储日志
    ✅ 安全设备日志
  
  集中管理:
    方案1: ELK Stack
      - Elasticsearch: 存储
      - Logstash: 处理
      - Kibana: 可视化
    
    方案2: Splunk
      - 商业方案
      - 功能强大
      - 成本较高
    
    方案3: Graylog
      - 开源
      - 功能丰富

2. 合规检查:
  
  等保2.0:
    检查项:
      ✅ 身份鉴别
      ✅ 访问控制
      ✅ 安全审计
      ✅ 入侵防范
      ✅ 恶意代码防范
      ✅ 数据备份恢复
      ✅ 数据完整性
      ✅ 数据保密性
  
  工具:
    - OpenSCAP: 自动化合规扫描
    - Lynis: Linux安全审计
    - VMware vCenter Configuration Manager

3. 漏洞扫描:
  
  定期扫描:
    频率: 每月或每季度
    工具:
      - Nessus (商业)
      - OpenVAS (开源)
      - Qualys
    
    扫描范围:
      ✅ ESXi主机
      ✅ vCenter
      ✅ VM Guest OS
      ✅ 网络设备
  
  漏洞修复:
    流程:
      1. 漏洞识别
      2. 风险评估
      3. 优先级排序
      4. 补丁测试
      5. 生产环境应用
      6. 验证修复

4. 安全事件响应:
  
  事件分类:
    - P0: 严重安全事件 (数据泄露/攻击)
    - P1: 高危事件 (关键漏洞)
    - P2: 中危事件
    - P3: 低危事件
  
  响应流程:
    1. 检测 (Detection)
       - 监控系统告警
       - 异常行为识别
    
    2. 分析 (Analysis)
       - 确认事件真实性
       - 评估影响范围
    
    3. 遏制 (Containment)
       - 隔离受影响系统
       - 阻止攻击传播
    
    4. 根除 (Eradication)
       - 清除恶意代码
       - 修复漏洞
    
    5. 恢复 (Recovery)
       - 恢复业务系统
       - 验证系统安全
    
    6. 总结 (Lessons Learned)
       - 事件报告
       - 改进措施

5. 定期审计:
  
  审计内容:
    ✅ 账户权限审查
    ✅ 配置合规检查
    ✅ 补丁状态检查
    ✅ 备份状态验证
    ✅ 日志完整性检查
    ✅ 安全策略执行情况
  
  审计频率:
    - 每月: 账户权限审查
    - 每季度: 完整合规检查
    - 每年: 第三方安全审计
```

---

## 安全加固检查清单

```yaml
快速检查清单:

ESXi主机: □ 20项
  访问控制:
    □ 禁用root SSH登录
    □ 配置SSH密钥认证
    □ 禁用不必要的服务
    □ 配置账户锁定策略
  
  网络安全:
    □ 启用防火墙
    □ 限制管理访问IP
    □ 禁用IPv6 (如不使用)
    □ 配置管理网络隔离
  
  日志审计:
    □ 配置远程日志服务器
    □ 启用Shell访问日志
    □ 配置登录Banner
  
  系统加固:
    □ 安装最新补丁
    □ 禁用MOB
    □ 配置超时时间
    □ 启用TLS 1.2+
    □ 配置NTP
    □ BIOS安全配置
    □ 禁用不安全协议
    □ 配置SNMP v3 (如使用)
    □ 限制CIM访问

vCenter Server: □ 15项
  □ 配置自动备份
  □ 安装最新补丁
  □ 配置强密码策略
  □ 配置账户锁定
  □ 集成AD/LDAP
  □ 配置RBAC
  □ 最小权限分配
  □ 配置安全告警
  □ 启用审计日志
  □ 使用企业CA证书
  □ 配置NTP
  □ 限制并发会话
  □ 配置会话超时
  □ 定期权限审查
  □ 导出审计日志

虚拟机: □ 12项
  □ 最小化安装OS
  □ 及时更新补丁
  □ 安装杀毒软件
  □ 配置防火墙
  □ 禁用不必要服务
  □ 移除不必要硬件
  □ 禁用复制粘贴
  □ 更新VMware Tools
  □ 及时删除快照
  □ 配置VM加密 (关键VM)
  □ 限制控制台访问
  □ 备份加密

网络安全: □ 10项
  □ VLAN隔离
  □ 配置端口组安全策略
  □ 禁用混杂模式
  □ 禁用MAC地址更改
  □ 配置分布式防火墙
  □ 部署IDS/IPS
  □ 启用网络监控
  □ VPN远程访问
  □ 启用流量加密
  □ DDoS防护

数据加密: □ 6项
  □ vSAN加密 (如使用)
  □ VM加密 (关键VM)
  □ vMotion加密
  □ 管理流量TLS
  □ 配置KMS
  □ 定期密钥轮换

审计合规: □ 7项
  □ 集中日志管理
  □ 定期漏洞扫描
  □ 合规性检查
  □ 安全事件响应流程
  □ 定期安全审计
  □ 备份与恢复测试
  □ 安全培训

总计: □ 70项安全检查
```

---

**文档版本**: v1.0  
**创建时间**: 2025-10-19  
**适用范围**: VMware vSphere, KVM, 通用虚拟化平台  
**状态**: ✅ 生产就绪  
**合规标准**: 等保2.0, PCI-DSS, GDPR
