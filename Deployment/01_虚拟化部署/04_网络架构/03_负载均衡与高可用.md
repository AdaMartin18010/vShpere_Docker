# 负载均衡与高可用

> **返回**: [网络架构目录](README.md) | [虚拟化部署首页](../README.md) | [部署指南首页](../../00_索引导航/README.md)

---

## 📋 目录

- [负载均衡与高可用](#负载均衡与高可用)
  - [📋 目录](#-目录)
  - [1. 网关冗余协议](#1-网关冗余协议)
    - [1.1 VRRP配置](#11-vrrp配置)
      - [Cisco VRRP配置](#cisco-vrrp配置)
      - [华为VRRP配置](#华为vrrp配置)
      - [VRRP负载均衡](#vrrp负载均衡)
    - [1.2 HSRP配置](#12-hsrp配置)
      - [基础HSRP配置](#基础hsrp配置)
      - [HSRP对象跟踪](#hsrp对象跟踪)
      - [HSRP负载均衡](#hsrp负载均衡)
    - [1.3 GLBP配置](#13-glbp配置)
      - [基础GLBP配置](#基础glbp配置)
      - [GLBP对象跟踪](#glbp对象跟踪)
  - [2. 链路冗余与聚合](#2-链路冗余与聚合)
    - [2.1 双链路冗余架构](#21-双链路冗余架构)
      - [服务器双网卡配置](#服务器双网卡配置)
    - [2.2 多路径冗余](#22-多路径冗余)
      - [VMware vSwitch配置](#vmware-vswitch配置)
      - [vSphere分布式交换机LACP](#vsphere分布式交换机lacp)
  - [3. 负载均衡方案](#3-负载均衡方案)
    - [3.1 四层负载均衡](#31-四层负载均衡)
      - [HAProxy配置示例](#haproxy配置示例)
    - [3.2 七层负载均衡](#32-七层负载均衡)
      - [Nginx七层负载均衡](#nginx七层负载均衡)
  - [4. 高可用架构设计](#4-高可用架构设计)
    - [4.1 网络拓扑设计](#41-网络拓扑设计)
    - [4.2 故障切换机制](#42-故障切换机制)
  - [5. 监控与测试](#5-监控与测试)
  - [相关文档](#相关文档)

---

## 1. 网关冗余协议

### 1.1 VRRP配置

```yaml
VRRP_Overview:
  Full_Name: Virtual Router Redundancy Protocol
  Standard: RFC 3768 (VRRPv2), RFC 5798 (VRRPv3)
  Features:
    - 开放标准协议
    - 支持IPv4和IPv6
    - 主备模式（Master/Backup）
    - 优先级1-254（默认100）
    - 抢占模式支持
  Advantages:
    - 厂商中立
    - 配置简单
    - 快速故障切换（秒级）
  Use_Cases:
    - 多厂商环境
    - 需要标准协议场景
    - IPv6环境
```

#### Cisco VRRP配置

```cisco
! ========================================
! Cisco VRRP配置
! ========================================

! Master路由器配置
interface Vlan10
 description Management-Network-Gateway
 ip address 192.168.10.2 255.255.255.0
 vrrp 10 ip 192.168.10.1
 vrrp 10 priority 110
 vrrp 10 preempt
 vrrp 10 timers advertise 1
 vrrp 10 authentication md5 key-string VrrpPass@2025

! Backup路由器配置
interface Vlan10
 description Management-Network-Gateway-Backup
 ip address 192.168.10.3 255.255.255.0
 vrrp 10 ip 192.168.10.1
 vrrp 10 priority 100
 vrrp 10 preempt
 vrrp 10 timers advertise 1
 vrrp 10 authentication md5 key-string VrrpPass@2025

! 验证
show vrrp brief
show vrrp interface Vlan10
```

#### 华为VRRP配置

```huawei
# ========================================
# 华为VRRP配置
# ========================================

# Master配置
interface Vlanif10
 ip address 192.168.10.2 255.255.255.0
 vrrp vrid 10 virtual-ip 192.168.10.1
 vrrp vrid 10 priority 110
 vrrp vrid 10 preempt-mode timer delay 30
 vrrp vrid 10 track interface GigabitEthernet1/0/1

# Backup配置
interface Vlanif10
 ip address 192.168.10.3 255.255.255.0
 vrrp vrid 10 virtual-ip 192.168.10.1
 vrrp vrid 10 priority 100

# 验证
display vrrp brief
display vrrp interface Vlanif10 verbose
```

#### VRRP负载均衡

```cisco
! ========================================
! VRRP多组实现负载均衡
! ========================================

! 路由器1配置
interface Vlan10
 ip address 192.168.10.2 255.255.255.0
 ! VRRP组1 - 主
 vrrp 1 ip 192.168.10.1
 vrrp 1 priority 110
 ! VRRP组2 - 备
 vrrp 2 ip 192.168.10.254
 vrrp 2 priority 100

! 路由器2配置
interface Vlan10
 ip address 192.168.10.3 255.255.255.0
 ! VRRP组1 - 备
 vrrp 1 ip 192.168.10.1
 vrrp 1 priority 100
 ! VRRP组2 - 主
 vrrp 2 ip 192.168.10.254
 vrrp 2 priority 110

! 客户端配置：
! 一半主机使用192.168.10.1作为网关
! 另一半使用192.168.10.254作为网关
```

---

### 1.2 HSRP配置

```yaml
HSRP_Overview:
  Full_Name: Hot Standby Router Protocol
  Vendor: Cisco私有协议
  Versions:
    HSRPv1: 组号0-255, 多播224.0.0.2
    HSRPv2: 组号0-4095, 多播224.0.0.102, IPv6支持
  States:
    - Initial: 初始状态
    - Learn: 学习状态
    - Listen: 监听状态
    - Speak: 发送Hello
    - Standby: 备用路由器
    - Active: 活动路由器
  Features:
    - 虚拟MAC地址
    - 对象跟踪
    - 抢占支持
    - 认证
```

#### 基础HSRP配置

```cisco
! ========================================
! Cisco HSRP配置
! ========================================

! Active路由器
interface Vlan10
 description Management-Network-Gateway
 ip address 192.168.10.2 255.255.255.0
 standby version 2
 standby 10 ip 192.168.10.1
 standby 10 priority 110
 standby 10 preempt
 standby 10 timers 1 3
 standby 10 authentication md5 key-string HsrpPass@2025

! Standby路由器
interface Vlan10
 description Management-Network-Gateway-Standby
 ip address 192.168.10.3 255.255.255.0
 standby version 2
 standby 10 ip 192.168.10.1
 standby 10 priority 100
 standby 10 preempt
 standby 10 timers 1 3
 standby 10 authentication md5 key-string HsrpPass@2025

! 验证
show standby brief
show standby Vlan10
```

#### HSRP对象跟踪

```cisco
! ========================================
! HSRP接口跟踪
! ========================================

! 创建跟踪对象
track 1 interface GigabitEthernet1/0/1 line-protocol
track 2 interface GigabitEthernet1/0/2 line-protocol
track 10 list boolean and
 object 1
 object 2

! 应用跟踪
interface Vlan10
 ip address 192.168.10.2 255.255.255.0
 standby 10 ip 192.168.10.1
 standby 10 priority 110
 standby 10 preempt
 standby 10 track 10 decrement 20

! 验证
show track
show track 10
```

#### HSRP负载均衡

```cisco
! ========================================
! HSRP多组负载均衡
! ========================================

! 路由器1
interface Vlan10
 ip address 192.168.10.2 255.255.255.0
 ! HSRP组10 - Active
 standby 10 ip 192.168.10.1
 standby 10 priority 110
 standby 10 preempt
 ! HSRP组20 - Standby
 standby 20 ip 192.168.10.254
 standby 20 priority 100
 standby 20 preempt

! 路由器2
interface Vlan10
 ip address 192.168.10.3 255.255.255.0
 ! HSRP组10 - Standby
 standby 10 ip 192.168.10.1
 standby 10 priority 100
 standby 10 preempt
 ! HSRP组20 - Active
 standby 20 ip 192.168.10.254
 standby 20 priority 110
 standby 20 preempt
```

---

### 1.3 GLBP配置

```yaml
GLBP_Overview:
  Full_Name: Gateway Load Balancing Protocol
  Vendor: Cisco私有协议
  Features:
    - 真正的负载均衡
    - 单一虚拟IP
    - 多虚拟MAC地址
    - AVG (Active Virtual Gateway)
    - AVF (Active Virtual Forwarder)
    - 最多4个转发器
  Load_Balance_Methods:
    - Weighted: 基于权重
    - Host-dependent: 基于主机
    - Round-robin: 轮询（默认）
```

#### 基础GLBP配置

```cisco
! ========================================
! Cisco GLBP配置
! ========================================

! 路由器1 (AVG)
interface Vlan10
 description GLBP-Primary
 ip address 192.168.10.2 255.255.255.0
 glbp 10 ip 192.168.10.1
 glbp 10 priority 110
 glbp 10 preempt
 glbp 10 load-balancing weighted
 glbp 10 weighting 100 lower 80 upper 100
 glbp 10 authentication md5 key-string GlbpPass@2025

! 路由器2
interface Vlan10
 description GLBP-Secondary
 ip address 192.168.10.3 255.255.255.0
 glbp 10 ip 192.168.10.1
 glbp 10 priority 100
 glbp 10 preempt
 glbp 10 load-balancing weighted
 glbp 10 weighting 100 lower 80 upper 100
 glbp 10 authentication md5 key-string GlbpPass@2025

! 验证
show glbp brief
show glbp 10
```

#### GLBP对象跟踪

```cisco
! ========================================
! GLBP接口跟踪
! ========================================

! 创建跟踪对象
track 1 interface GigabitEthernet1/0/1 line-protocol

! 配置GLBP
interface Vlan10
 ip address 192.168.10.2 255.255.255.0
 glbp 10 ip 192.168.10.1
 glbp 10 priority 110
 glbp 10 preempt
 glbp 10 weighting track 1 decrement 20

! 验证
show track
show glbp
```

---

## 2. 链路冗余与聚合

### 2.1 双链路冗余架构

```yaml
Dual_Link_Architecture:
  Topology: "服务器 ⇄ 接入交换机 ⇄ 核心交换机"
  
  链路冗余方案:
    方案1_主备模式:
      - 一条主链路，一条备份链路
      - STP阻塞备份链路
      - 故障时切换到备份
      - 切换时间: 30-50秒 (RSTP)
      - 优点: 配置简单
      - 缺点: 带宽浪费
    
    方案2_链路聚合:
      - LACP动态聚合
      - 两条链路同时工作
      - 负载均衡
      - 切换时间: 秒级
      - 优点: 充分利用带宽
      - 推荐: ✅ 生产环境首选
    
    方案3_堆叠:
      - 交换机堆叠
      - 逻辑上单台设备
      - 零切换时间
      - 优点: 最高可用性
      - 缺点: 需要硬件支持
```

#### 服务器双网卡配置

```yaml
# ========================================
# Linux服务器网络绑定
# ========================================

Server_Bonding_Modes:
  Mode0_Balance_RR:
    名称: 轮询负载均衡
    特点: 顺序传输, 需要交换机配置EtherChannel
    推荐: 不推荐
  
  Mode1_Active_Backup:
    名称: 主备模式
    特点: 一主一备, 不需要交换机特殊配置
    推荐: ✅ 简单场景
    配置: |
      auto bond0
      iface bond0 inet static
        address 192.168.10.100
        netmask 255.255.255.0
        gateway 192.168.10.1
        bond-slaves eth0 eth1
        bond-mode active-backup
        bond-miimon 100
        bond-primary eth0
  
  Mode2_Balance_XOR:
    名称: XOR负载均衡
    特点: 基于MAC/IP哈希, 需要交换机配置
    推荐: 一般
  
  Mode4_802.3ad:
    名称: LACP动态聚合
    特点: 需要交换机支持LACP
    推荐: ✅ 生产环境推荐
    配置: |
      auto bond0
      iface bond0 inet static
        address 192.168.10.100
        netmask 255.255.255.0
        gateway 192.168.10.1
        bond-slaves eth0 eth1
        bond-mode 802.3ad
        bond-miimon 100
        bond-lacp-rate 1
        bond-xmit-hash-policy layer3+4
  
  Mode5_Balance_TLB:
    名称: 传输负载均衡
    特点: 出站负载均衡, 不需要交换机配置
    推荐: 一般
  
  Mode6_Balance_ALB:
    名称: 自适应负载均衡
    特点: 双向负载均衡, 不需要交换机配置
    推荐: ✅ 无法配置交换机时
```

```bash
#!/bin/bash
# ========================================
# Ubuntu/Debian网络绑定配置
# ========================================

# 1. 安装工具
apt update
apt install -y ifenslave

# 2. 加载模块
modprobe bonding

# 3. 配置bonding (/etc/netplan/01-netcfg.yaml for Ubuntu 20.04+)
cat > /etc/netplan/01-netcfg.yaml << 'EOF'
network:
  version: 2
  renderer: networkd
  ethernets:
    ens192:
      dhcp4: no
    ens224:
      dhcp4: no
  bonds:
    bond0:
      dhcp4: no
      interfaces: [ens192, ens224]
      addresses: [192.168.10.100/24]
      gateway4: 192.168.10.1
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
      parameters:
        mode: 802.3ad
        mii-monitor-interval: 100
        lacp-rate: fast
        transmit-hash-policy: layer3+4
EOF

# 4. 应用配置
netplan apply

# 5. 验证
ip addr show bond0
cat /proc/net/bonding/bond0
```

```powershell
# ========================================
# Windows网卡绑定 (Team)
# ========================================

# 1. 创建网卡组 (LACP)
New-NetLbfoTeam -Name "Team1" `
  -TeamMembers "Ethernet1","Ethernet2" `
  -TeamingMode LACP `
  -LoadBalancingAlgorithm Dynamic `
  -Confirm:$false

# 2. 配置IP
New-NetIPAddress -InterfaceAlias "Team1" `
  -IPAddress 192.168.10.100 `
  -PrefixLength 24 `
  -DefaultGateway 192.168.10.1

# 3. 验证
Get-NetLbfoTeam
Get-NetLbfoTeamMember
Get-NetLbfoTeamNic
```

---

### 2.2 多路径冗余

```yaml
Multi_Path_Redundancy:
  虚拟化环境网络冗余:
    ESXi_vSwitch:
      标准交换机 (vSS):
        - 多物理网卡上行链路
        - 负载均衡策略
        - 故障切换顺序
      
      分布式交换机 (vDS):
        - LACP支持
        - 负载均衡增强
        - 集中管理
    
    KVM_Bridge:
      - Linux Bridge + Bond
      - Open vSwitch + Bond
      - 支持LACP
    
    负载均衡策略:
      基于源MAC哈希:
        - 简单
        - 单VM限制单链路
      
      基于IP哈希:
        - 需要EtherChannel/LACP
        - 单VM可用多链路
        - 推荐: ✅
      
      显式故障切换:
        - 主备模式
        - 特定场景使用
```

#### VMware vSwitch配置

```bash
# ========================================
# ESXi vSwitch配置 (CLI)
# ========================================

# 1. 查看当前交换机
esxcli network vswitch standard list

# 2. 创建vSwitch
esxcli network vswitch standard add --vswitch-name=vSwitch1

# 3. 添加上行链路
esxcli network vswitch standard uplink add \
  --uplink-name=vmnic2 --vswitch-name=vSwitch1
esxcli network vswitch standard uplink add \
  --uplink-name=vmnic3 --vswitch-name=vSwitch1

# 4. 配置负载均衡策略
esxcli network vswitch standard policy failover set \
  --vswitch-name=vSwitch1 \
  --load-balancing=iphash \
  --active-uplinks=vmnic2,vmnic3

# 5. 配置端口组
esxcli network vswitch standard portgroup add \
  --portgroup-name="Production-Network" \
  --vswitch-name=vSwitch1
esxcli network vswitch standard portgroup set \
  --portgroup-name="Production-Network" \
  --vlan-id=40

# 6. 验证
esxcli network vswitch standard list
esxcli network vswitch standard portgroup list
```

#### vSphere分布式交换机LACP

```powershell
# ========================================
# vDS LACP配置 (PowerCLI)
# ========================================

# 连接vCenter
Connect-VIServer -Server vcenter.example.com

# 获取分布式交换机
$vds = Get-VDSwitch -Name "Production-vDS"

# 创建LACP LAG
$lag = New-VDSwitchLag -VDSwitch $vds `
  -Name "LAG-ESXi-Host1" `
  -NumUplinkPorts 2 `
  -Mode Active `
  -LoadBalancingMode SrcDestIpPort

# 分配上行链路到LAG
$vmhost = Get-VMHost -Name "esxi-host1.example.com"
$pnic1 = Get-VMHostNetworkAdapter -VMHost $vmhost -Physical -Name "vmnic2"
$pnic2 = Get-VMHostNetworkAdapter -VMHost $vmhost -Physical -Name "vmnic3"

Add-VDSwitchPhysicalNetworkAdapter -DistributedSwitch $vds `
  -VMHostPhysicalNic $pnic1,$pnic2 -Lag $lag -Confirm:$false

# 验证
Get-VDSwitchLag -VDSwitch $vds
```

---

## 3. 负载均衡方案

### 3.1 四层负载均衡

```yaml
Layer4_Load_Balancing:
  特点:
    - 基于IP+端口
    - 传输层负载均衡
    - 高性能
    - 低延迟
  
  产品:
    HAProxy:
      类型: 开源
      性能: ⭐⭐⭐⭐⭐
      功能: 4层+7层
      推荐: ✅
    
    Nginx:
      类型: 开源/商业
      性能: ⭐⭐⭐⭐⭐
      功能: 主要7层, 支持4层
      推荐: ✅
    
    LVS:
      类型: Linux内核模块
      性能: ⭐⭐⭐⭐⭐
      功能: 4层
      推荐: 大规模场景
    
    F5 BIG-IP:
      类型: 商业硬件/软件
      性能: ⭐⭐⭐⭐⭐
      功能: 全功能
      推荐: 企业级
```

#### HAProxy配置示例

```bash
# ========================================
# HAProxy 4层负载均衡配置
# ========================================

# /etc/haproxy/haproxy.cfg
global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    maxconn 40000
    
    # SSL
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    retries 3

# 统计页面
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# MySQL负载均衡 (4层)
listen mysql-cluster
    bind *:3306
    mode tcp
    option tcplog
    option tcp-check
    balance roundrobin
    server mysql1 192.168.40.11:3306 check inter 2000 rise 2 fall 3
    server mysql2 192.168.40.12:3306 check inter 2000 rise 2 fall 3 backup

# PostgreSQL负载均衡
listen pgsql-cluster
    bind *:5432
    mode tcp
    option tcplog
    balance leastconn
    server pg1 192.168.40.21:5432 check inter 2000
    server pg2 192.168.40.22:5432 check inter 2000

# Kubernetes API负载均衡
listen k8s-api
    bind *:6443
    mode tcp
    option tcplog
    balance roundrobin
    server k8s-master1 192.168.50.11:6443 check inter 2000
    server k8s-master2 192.168.50.12:6443 check inter 2000
    server k8s-master3 192.168.50.13:6443 check inter 2000
```

---

### 3.2 七层负载均衡

```yaml
Layer7_Load_Balancing:
  特点:
    - 基于HTTP/HTTPS
    - 应用层负载均衡
    - 内容路由
    - SSL卸载
  
  负载均衡算法:
    轮询 (Round Robin):
      特点: 平均分配
      适用: 服务器性能相近
    
    最少连接 (Least Connections):
      特点: 分配到连接数最少的服务器
      适用: 长连接场景
      推荐: ✅
    
    IP哈希 (IP Hash):
      特点: 同一IP固定到同一服务器
      适用: 会话保持
    
    加权轮询 (Weighted Round Robin):
      特点: 根据权重分配
      适用: 服务器性能不同
      推荐: ✅
```

#### Nginx七层负载均衡

```nginx
# ========================================
# Nginx 7层负载均衡配置
# ========================================

# /etc/nginx/nginx.conf
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 10240;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'upstream: $upstream_addr';
    
    access_log /var/log/nginx/access.log main;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # 上游服务器池 - Web应用
    upstream web_backend {
        least_conn;  # 最少连接算法
        server 192.168.40.11:80 weight=3 max_fails=2 fail_timeout=30s;
        server 192.168.40.12:80 weight=3 max_fails=2 fail_timeout=30s;
        server 192.168.40.13:80 weight=2 max_fails=2 fail_timeout=30s backup;
        keepalive 32;
    }
    
    # 上游服务器池 - API
    upstream api_backend {
        ip_hash;  # 会话保持
        server 192.168.41.11:8080 max_fails=2 fail_timeout=30s;
        server 192.168.41.12:8080 max_fails=2 fail_timeout=30s;
        server 192.168.41.13:8080 max_fails=2 fail_timeout=30s;
    }
    
    # HTTP服务器 (重定向到HTTPS)
    server {
        listen 80;
        server_name example.com www.example.com;
        return 301 https://$server_name$request_uri;
    }
    
    # HTTPS服务器
    server {
        listen 443 ssl http2;
        server_name example.com www.example.com;
        
        # SSL证书
        ssl_certificate /etc/nginx/ssl/example.com.crt;
        ssl_certificate_key /etc/nginx/ssl/example.com.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        
        # 根路径 -> Web后端
        location / {
            proxy_pass http://web_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 5s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
        
        # API路径 -> API后端
        location /api/ {
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_connect_timeout 5s;
            proxy_send_timeout 120s;
            proxy_read_timeout 120s;
        }
        
        # 健康检查端点
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
    }
}
```

---

## 4. 高可用架构设计

### 4.1 网络拓扑设计

```yaml
典型高可用网络架构:
  三层架构:
    核心层 (Core):
      设备: 2台核心交换机
      配置: VSS/堆叠/独立+VRRP
      功能: L3路由, VRRP, 上行
      冗余: 双活
    
    汇聚层 (Distribution):
      设备: 2台汇聚交换机/机柜
      配置: 独立设备
      功能: VLAN间路由, ACL, QoS
      冗余: HSRP/VRRP
      上行: 每台到两个核心 (LACP)
    
    接入层 (Access):
      设备: N台接入交换机
      配置: 独立或堆叠
      功能: 接入, VLAN, PoE
      冗余: 每台上行到两台汇聚 (LACP)
  
  Spine-Leaf架构:
    Spine层:
      设备: 2-4台Spine交换机
      功能: 纯L3转发
      冗余: 等价多路径 (ECMP)
    
    Leaf层:
      设备: N台Leaf交换机
      功能: L2/L3, VTEP
      上行: 到所有Spine (LACP/ECMP)
      特点: 任意Leaf间2跳可达
    
    推荐: ✅ 数据中心/云环境
```

### 4.2 故障切换机制

```yaml
故障切换时间对比:
  STP故障切换:
    收敛时间: 30-50秒 (RSTP)
    影响: 中断30-50秒
    推荐: ❌ 不推荐生产环境
  
  LACP故障切换:
    收敛时间: 3-5秒
    影响: 短暂中断
    推荐: ✅ 推荐
  
  VRRP/HSRP故障切换:
    收敛时间: 1-3秒
    影响: 短暂中断
    推荐: ✅ 推荐
  
  堆叠故障切换:
    收敛时间: <1秒
    影响: 无感知
    推荐: ✅ 最佳（需硬件支持）

故障检测机制:
  链路层检测:
    - 物理链路Down
    - 检测时间: 毫秒级
    - 触发: 立即切换
  
  协议层检测:
    - VRRP/HSRP Hello超时
    - 检测时间: 1-3秒
    - 触发: 优先级调整
  
  对象跟踪:
    - Track接口/路由/IP可达性
    - 检测时间: 可配置
    - 触发: 降低优先级
  
  BFD检测:
    - 双向转发检测
    - 检测时间: 50ms-1s
    - 推荐: ✅ 快速故障检测
```

---

## 5. 监控与测试

```yaml
高可用测试清单:
  链路冗余测试:
    1. 物理链路拔线测试:
       操作: 拔掉一条上行链路
       预期: 流量切换到另一条, 无中断
       验证: show etherchannel summary
    
    2. 交换机重启测试:
       操作: 重启备份交换机
       预期: 无影响
       验证: show vrrp brief
    
    3. 核心交换机故障测试:
       操作: 关闭主核心交换机
       预期: VRRP切换, 中断<3秒
       验证: ping连续测试
  
  负载均衡测试:
    1. 流量分布测试:
       工具: iperf3多连接测试
       验证: show interfaces counters rate
       预期: 流量均匀分布
    
    2. 后端服务器故障测试:
       操作: 停止一台后端服务器
       预期: 负载均衡器检测故障, 流量转移
       验证: 查看负载均衡器日志
    
    3. 会话保持测试:
       操作: 建立会话后重复请求
       验证: 同一客户端请求到同一后端
       预期: 会话不中断

监控指标:
  网络设备:
    - CPU使用率 (< 70%)
    - 内存使用率 (< 80%)
    - 接口错误率 (< 0.01%)
    - VRRP/HSRP状态
    - 链路利用率
  
  负载均衡器:
    - 当前连接数
    - 新建连接速率
    - 后端健康状态
    - 响应时间
    - 错误率
  
  告警阈值:
    Critical:
      - VRRP状态变化
      - 链路Down
      - 所有后端不可用
    
    Warning:
      - CPU > 80%
      - 内存 > 90%
      - 后端部分不可用
      - 接口错误增加
```

```bash
#!/bin/bash
# ========================================
# 高可用测试脚本
# ========================================

TARGET_IP="192.168.10.1"
COUNT=100
INTERVAL=1

echo "开始高可用测试..."
echo "目标: $TARGET_IP"
echo "时间: $(date)"
echo "======================================"

# 连续ping测试
ping -c $COUNT -i $INTERVAL $TARGET_IP | while read pong; do
    echo "$(date '+%Y-%m-%d %H:%M:%S') : $pong"
done

# 统计丢包
echo "======================================"
ping -c $COUNT -i $INTERVAL $TARGET_IP > /tmp/ping_result.txt
packet_loss=$(grep 'packet loss' /tmp/ping_result.txt | awk '{print $6}')
echo "丢包率: $packet_loss"

if [ "$packet_loss" == "0%" ]; then
    echo "✅ 测试通过: 无丢包"
else
    echo "⚠️  警告: 有丢包发生"
fi
```

---

## 相关文档

- [网络拓扑与VLAN规划](01_网络拓扑与VLAN规划.md)
- [交换机配置与优化](02_交换机配置与优化.md)
- [网络安全策略](04_网络安全策略.md)
- [网络监控与故障排查](05_网络监控与故障排查.md)

---

**更新时间**: 2025-10-19  
**文档版本**: v1.0  
**状态**: ✅ 生产就绪
