# 网络监控与故障排查

> **返回**: [网络架构目录](README.md) | [虚拟化部署首页](../README.md) | [部署指南首页](../../00_索引导航/README.md)

---

## 📋 目录

- [网络监控与故障排查](#网络监控与故障排查)
  - [📋 目录](#-目录)
  - [1. 监控体系架构](#1-监控体系架构)
  - [2. SNMP监控](#2-snmp监控)
    - [2.1 SNMP配置](#21-snmp配置)
    - [2.2 常用SNMP OID](#22-常用snmp-oid)
    - [2.3 SNMP监控脚本](#23-snmp监控脚本)
  - [3. NetFlow流量分析](#3-netflow流量分析)
    - [3.1 Cisco NetFlow配置](#31-cisco-netflow配置)
    - [3.2 nfdump分析工具](#32-nfdump分析工具)
    - [3.3 流量异常检测](#33-流量异常检测)
  - [4. 日志分析](#4-日志分析)
    - [4.1 Syslog配置](#41-syslog配置)
    - [4.2 日志分析脚本](#42-日志分析脚本)
  - [5. 性能监控](#5-性能监控)
    - [5.1 Prometheus + Grafana](#51-prometheus--grafana)
    - [5.2 Prometheus告警规则](#52-prometheus告警规则)
  - [6. 告警配置](#6-告警配置)
    - [6.1 Alertmanager配置](#61-alertmanager配置)
    - [6.2 钉钉告警脚本](#62-钉钉告警脚本)
  - [7. 故障排查方法论](#7-故障排查方法论)
  - [8. 常见故障案例](#8-常见故障案例)
    - [案例1: 网络间歇性中断](#案例1-网络间歇性中断)
    - [案例2: VLAN间无法通信](#案例2-vlan间无法通信)
    - [案例3: 广播风暴](#案例3-广播风暴)
  - [9. 诊断命令大全](#9-诊断命令大全)
    - [9.1 Cisco诊断命令](#91-cisco诊断命令)
    - [9.2 Linux网络诊断命令](#92-linux网络诊断命令)
  - [10. 故障排查工具](#10-故障排查工具)
    - [10.1 抓包分析 (tcpdump/Wireshark)](#101-抓包分析-tcpdumpwireshark)
    - [10.2 网络性能测试](#102-网络性能测试)
    - [10.3 自动化巡检脚本](#103-自动化巡检脚本)
  - [相关文档](#相关文档)

---

## 1. 监控体系架构

```yaml
网络监控层次模型:
  L1_物理层监控:
    指标:
      - 端口状态 (Up/Down)
      - 光功率 (dBm)
      - 错误率 (CRC/Collision)
      - 线缆质量
    工具: SNMP, 设备CLI
  
  L2_链路层监控:
    指标:
      - MAC地址表
      - VLAN状态
      - 生成树状态
      - EtherChannel状态
    工具: SNMP, LLDP/CDP
  
  L3_网络层监控:
    指标:
      - 路由表
      - ARP表
      - ICMP可达性
      - 路由协议状态
    工具: Ping, Traceroute, BGP/OSPF监控
  
  L4_传输层监控:
    指标:
      - 连接数
      - 端口利用率
      - TCP重传率
      - 延迟/抖动
    工具: NetFlow, TCP分析
  
  L7_应用层监控:
    指标:
      - HTTP响应时间
      - DNS查询延迟
      - 应用性能
      - 用户体验
    工具: APM, 综合监控

监控工具栈:
  数据采集:
    - SNMP (Simple Network Management Protocol)
    - NetFlow/sFlow/IPFIX
    - Syslog
    - API/CLI
  
  数据存储:
    - InfluxDB (时序数据)
    - Elasticsearch (日志)
    - Prometheus (指标)
  
  数据展示:
    - Grafana (仪表板)
    - Kibana (日志分析)
    - Cacti/Zabbix (传统监控)
  
  告警通知:
    - Alertmanager
    - PagerDuty
    - Email/SMS/钉钉/企业微信
```

---

## 2. SNMP监控

### 2.1 SNMP配置

```cisco
! ========================================
! Cisco SNMP配置
! ========================================

! SNMPv2c配置 (不推荐生产环境)
snmp-server community public RO
snmp-server community private RW
snmp-server location "DC1-Rack-A-U10"
snmp-server contact "admin@example.com"

! SNMPv3配置 (推荐)
snmp-server group ADMIN-GROUP v3 priv
snmp-server user admin ADMIN-GROUP v3 auth sha AuthPass@2025 priv aes 128 PrivPass@2025

! 配置Trap接收者
snmp-server host 192.168.10.100 version 3 priv admin
snmp-server enable traps snmp linkdown linkup
snmp-server enable traps config
snmp-server enable traps cpu threshold
snmp-server enable traps memory bufferpeak
snmp-server enable traps vrrp
snmp-server enable traps hsrp

! 验证
show snmp
show snmp user
show snmp group
```

### 2.2 常用SNMP OID

```yaml
常用SNMP_OID:
  系统信息:
    sysName: .1.3.6.1.2.1.1.5.0
    sysUpTime: .1.3.6.1.2.1.1.3.0
    sysDescr: .1.3.6.1.2.1.1.1.0
    sysLocation: .1.3.6.1.2.1.1.6.0
  
  CPU和内存:
    CPU_5秒利用率: .1.3.6.1.4.1.9.9.109.1.1.1.1.3
    CPU_1分钟利用率: .1.3.6.1.4.1.9.9.109.1.1.1.1.4
    内存使用: .1.3.6.1.4.1.9.9.48.1.1.1.5
    内存空闲: .1.3.6.1.4.1.9.9.48.1.1.1.6
  
  接口:
    ifDescr: .1.3.6.1.2.1.2.2.1.2
    ifOperStatus: .1.3.6.1.2.1.2.2.1.8
    ifInOctets: .1.3.6.1.2.1.2.2.1.10
    ifOutOctets: .1.3.6.1.2.1.2.2.1.16
    ifInErrors: .1.3.6.1.2.1.2.2.1.14
    ifOutErrors: .1.3.6.1.2.1.2.2.1.20
  
  环境:
    温度: .1.3.6.1.4.1.9.9.13.1.3.1.3
    风扇状态: .1.3.6.1.4.1.9.9.13.1.4.1.3
    电源状态: .1.3.6.1.4.1.9.9.13.1.5.1.3
```

### 2.3 SNMP监控脚本

```bash
#!/bin/bash
# ========================================
# SNMP批量监控脚本
# ========================================

DEVICES=(
    "192.168.10.10:Core-SW1"
    "192.168.10.11:Core-SW2"
    "192.168.10.20:Dist-SW1"
)

COMMUNITY="public"
OUTPUT_DIR="/var/log/snmp-monitoring"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "$OUTPUT_DIR"

for DEVICE in "${DEVICES[@]}"; do
    IP="${DEVICE%%:*}"
    NAME="${DEVICE##*:}"
    
    echo "========================================" | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
    echo "监控设备: $NAME ($IP)" | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
    echo "时间: $(date)" | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
    
    # 设备信息
    echo -e "\n--- 设备信息 ---" | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
    snmpget -v2c -c $COMMUNITY $IP .1.3.6.1.2.1.1.1.0 | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
    snmpget -v2c -c $COMMUNITY $IP .1.3.6.1.2.1.1.3.0 | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
    
    # CPU利用率
    echo -e "\n--- CPU利用率 ---" | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
    CPU_5SEC=$(snmpget -v2c -c $COMMUNITY -Ovq $IP .1.3.6.1.4.1.9.9.109.1.1.1.1.3.1)
    echo "CPU 5秒: $CPU_5SEC%" | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
    
    # 内存使用
    echo -e "\n--- 内存使用 ---" | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
    MEM_USED=$(snmpget -v2c -c $COMMUNITY -Ovq $IP .1.3.6.1.4.1.9.9.48.1.1.1.5.1)
    MEM_FREE=$(snmpget -v2c -c $COMMUNITY -Ovq $IP .1.3.6.1.4.1.9.9.48.1.1.1.6.1)
    MEM_TOTAL=$((MEM_USED + MEM_FREE))
    MEM_PERCENT=$((MEM_USED * 100 / MEM_TOTAL))
    echo "内存使用: $MEM_USED / $MEM_TOTAL ($MEM_PERCENT%)" | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
    
    # 接口状态
    echo -e "\n--- 接口状态 ---" | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
    snmpwalk -v2c -c $COMMUNITY $IP .1.3.6.1.2.1.2.2.1.2 | head -10 | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
    
    # 告警判断
    if [ "$CPU_5SEC" -gt 80 ]; then
        echo "⚠️  警告: CPU使用率过高 ($CPU_5SEC%)" | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
        # 发送告警 (邮件/钉钉/短信)
    fi
    
    if [ "$MEM_PERCENT" -gt 90 ]; then
        echo "⚠️  警告: 内存使用率过高 ($MEM_PERCENT%)" | tee -a "$OUTPUT_DIR/$NAME-$DATE.log"
    fi
done

echo "✅ 监控完成，日志保存在: $OUTPUT_DIR"
```

---

## 3. NetFlow流量分析

### 3.1 Cisco NetFlow配置

```cisco
! ========================================
! Cisco NetFlow v9配置
! ========================================

! 配置Flow Exporter
flow exporter NETFLOW-EXPORT
 destination 192.168.10.100
 source Vlan10
 transport udp 9995
 export-protocol netflow-v9
 template data timeout 60

! 配置Flow Record
flow record NETFLOW-RECORD
 match ipv4 tos
 match ipv4 protocol
 match ipv4 source address
 match ipv4 destination address
 match transport source-port
 match transport destination-port
 collect counter bytes
 collect counter packets
 collect timestamp sys-uptime first
 collect timestamp sys-uptime last

! 配置Flow Monitor
flow monitor NETFLOW-MONITOR
 exporter NETFLOW-EXPORT
 cache timeout inactive 10
 cache timeout active 60
 record NETFLOW-RECORD

! 应用到接口
interface GigabitEthernet1/0/1
 ip flow monitor NETFLOW-MONITOR input
 ip flow monitor NETFLOW-MONITOR output

! 验证
show flow monitor NETFLOW-MONITOR cache
show flow exporter NETFLOW-EXPORT statistics
```

### 3.2 nfdump分析工具

```bash
#!/bin/bash
# ========================================
# nfdump NetFlow分析
# ========================================

# 安装nfdump
apt install -y nfdump

# 配置nfcapd收集器
nfcapd -w /var/cache/nfdump -p 9995 -D

# 实时流量分析
# Top 10 流量源IP
nfdump -R /var/cache/nfdump -s srcip/bytes -n 10

# Top 10 流量目标IP
nfdump -R /var/cache/nfdump -s dstip/bytes -n 10

# Top 10 使用端口
nfdump -R /var/cache/nfdump -s dstport/bytes -n 10

# 查看特定IP的流量
nfdump -R /var/cache/nfdump 'src ip 192.168.10.100'

# 查看HTTP流量
nfdump -R /var/cache/nfdump 'dst port 80 or dst port 443'

# 按时间过滤
nfdump -R /var/cache/nfdump -t 2025/10/19.10:00:00-2025/10/19.12:00:00

# 生成流量报告
nfdump -R /var/cache/nfdump -s srcip/bytes -n 20 -o csv > traffic_report.csv
```

### 3.3 流量异常检测

```python
#!/usr/bin/env python3
# ========================================
# NetFlow异常流量检测
# ========================================

import subprocess
import re
from collections import defaultdict

def get_top_talkers(n=10):
    """获取Top流量主机"""
    cmd = f"nfdump -R /var/cache/nfdump -s srcip/bytes -n {n} -q"
    output = subprocess.check_output(cmd, shell=True).decode()
    
    talkers = []
    for line in output.split('\n'):
        match = re.search(r'(\d+\.\d+\.\d+\.\d+)\s+(\d+\.\d+\s+\w+)', line)
        if match:
            talkers.append((match.group(1), match.group(2)))
    
    return talkers

def detect_port_scan(threshold=100):
    """检测端口扫描"""
    cmd = "nfdump -R /var/cache/nfdump -a -o extended"
    output = subprocess.check_output(cmd, shell=True).decode()
    
    src_ports = defaultdict(set)
    for line in output.split('\n'):
        match = re.search(r'(\d+\.\d+\.\d+\.\d+):\d+ -> \d+\.\d+\.\d+\.\d+:(\d+)', line)
        if match:
            src_ip = match.group(1)
            dst_port = match.group(2)
            src_ports[src_ip].add(dst_port)
    
    # 检测访问过多端口的IP
    scanners = []
    for ip, ports in src_ports.items():
        if len(ports) > threshold:
            scanners.append((ip, len(ports)))
    
    return sorted(scanners, key=lambda x: x[1], reverse=True)

def detect_ddos(threshold_gbps=1.0):
    """检测DDoS攻击"""
    cmd = "nfdump -R /var/cache/nfdump -s srcip/bps -n 10 -q"
    output = subprocess.check_output(cmd, shell=True).decode()
    
    attacks = []
    for line in output.split('\n'):
        match = re.search(r'(\d+\.\d+\.\d+\.\d+)\s+(\d+\.\d+)\s+G', line)
        if match and float(match.group(2)) > threshold_gbps:
            attacks.append((match.group(1), float(match.group(2))))
    
    return attacks

if __name__ == "__main__":
    print("=== Top 10 流量主机 ===")
    for ip, traffic in get_top_talkers():
        print(f"{ip}: {traffic}")
    
    print("\n=== 可疑端口扫描 ===")
    for ip, port_count in detect_port_scan():
        print(f"⚠️  {ip} 访问了 {port_count} 个不同端口")
    
    print("\n=== 可疑DDoS攻击 ===")
    for ip, gbps in detect_ddos():
        print(f"🔴 {ip} 流量: {gbps} Gbps")
```

---

## 4. 日志分析

### 4.1 Syslog配置

```bash
#!/bin/bash
# ========================================
# rsyslog配置
# ========================================

# 配置rsyslog服务器
cat >> /etc/rsyslog.conf << 'EOF'
# 启用UDP接收 (默认514端口)
$ModLoad imudp
$UDPServerRun 514

# 启用TCP接收
$ModLoad imtcp
$InputTCPServerRun 514

# 按主机分类日志
$template RemoteLogs,"/var/log/remote/%HOSTNAME%/%$YEAR%%$MONTH%%$DAY%.log"
*.* ?RemoteLogs
EOF

# 重启rsyslog
systemctl restart rsyslog

# 配置日志轮转
cat > /etc/logrotate.d/remote-logs << 'EOF'
/var/log/remote/*/*.log {
    daily
    rotate 90
    compress
    delaycompress
    missingok
    notifempty
    create 0640 syslog adm
}
EOF
```

### 4.2 日志分析脚本

```bash
#!/bin/bash
# ========================================
# 网络设备日志分析脚本
# ========================================

LOG_DIR="/var/log/remote"
REPORT_FILE="/var/log/network-analysis-$(date +%Y%m%d).txt"

echo "=== 网络日志分析报告 ===" > $REPORT_FILE
echo "生成时间: $(date)" >> $REPORT_FILE
echo "" >> $REPORT_FILE

# 1. 链路Down事件
echo "=== 链路Down事件 ===" >> $REPORT_FILE
grep -r "LINK-3-UPDOWN.*down" $LOG_DIR | tail -20 >> $REPORT_FILE

# 2. 配置变更
echo -e "\n=== 配置变更 ===" >> $REPORT_FILE
grep -r "CONFIG_I" $LOG_DIR | tail -20 >> $REPORT_FILE

# 3. 认证失败
echo -e "\n=== 认证失败 ===" >> $REPORT_FILE
grep -r "Authentication failed\|LOGIN-4-LOGIN_FAILED" $LOG_DIR | tail -20 >> $REPORT_FILE

# 4. VRRP/HSRP状态变化
echo -e "\n=== VRRP/HSRP状态变化 ===" >> $REPORT_FILE
grep -r "VRRP\|HSRP.*state" $LOG_DIR | tail -20 >> $REPORT_FILE

# 5. CPU/内存告警
echo -e "\n=== CPU/内存告警 ===" >> $REPORT_FILE
grep -r "CPU\|MEMORY.*threshold" $LOG_DIR | tail -20 >> $REPORT_FILE

# 6. 统计分析
echo -e "\n=== 错误统计 ===" >> $REPORT_FILE
echo "错误总数:" >> $REPORT_FILE
grep -rc "ERROR\|CRIT" $LOG_DIR | sort -t: -k2 -nr | head -10 >> $REPORT_FILE

cat $REPORT_FILE
```

---

## 5. 性能监控

### 5.1 Prometheus + Grafana

```yaml
# ========================================
# Prometheus配置
# ========================================
global:
  scrape_interval: 30s
  evaluation_interval: 30s

scrape_configs:
  # SNMP Exporter监控交换机
  - job_name: 'snmp-switches'
    static_configs:
      - targets:
        - 192.168.10.10  # Core-SW1
        - 192.168.10.11  # Core-SW2
        labels:
          device_type: 'switch'
          location: 'DC1'
    metrics_path: /snmp
    params:
      module: [cisco_ios]
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: localhost:9116  # SNMP Exporter地址
  
  # Node Exporter监控服务器
  - job_name: 'node'
    static_configs:
      - targets:
        - 192.168.10.100:9100
        - 192.168.10.101:9100
        labels:
          env: 'production'
```

### 5.2 Prometheus告警规则

```yaml
# ========================================
# Prometheus告警规则
# ========================================
groups:
  - name: network_alerts
    interval: 30s
    rules:
      # 接口Down告警
      - alert: InterfaceDown
        expr: ifOperStatus == 2
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "接口Down: {{ $labels.ifDescr }}"
          description: "设备 {{ $labels.instance }} 接口 {{ $labels.ifDescr }} 已Down超过1分钟"
      
      # 高带宽使用
      - alert: HighBandwidthUtilization
        expr: (rate(ifHCInOctets[5m]) * 8 / ifHighSpeed) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "带宽使用率过高"
          description: "{{ $labels.ifDescr }} 带宽使用率超过80%"
      
      # 高错误率
      - alert: HighErrorRate
        expr: rate(ifInErrors[5m]) > 100
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "接口错误率过高"
          description: "{{ $labels.ifDescr }} 每秒错误超过100个"
      
      # CPU过高
      - alert: HighCPU
        expr: cpmCPUTotal5minRev > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU使用率过高"
          description: "{{ $labels.instance }} CPU使用率 {{ $value }}%"
      
      # 内存不足
      - alert: LowMemory
        expr: (cempMemPoolHCUsed / (cempMemPoolHCUsed + cempMemPoolHCFree)) * 100 > 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "内存不足"
          description: "{{ $labels.instance }} 内存使用率 {{ $value }}%"
```

---

## 6. 告警配置

### 6.1 Alertmanager配置

```yaml
# ========================================
# Alertmanager配置
# ========================================
global:
  resolve_timeout: 5m
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alertmanager@example.com'
  smtp_auth_username: 'alertmanager@example.com'
  smtp_auth_password: 'password'

route:
  group_by: ['alertname', 'cluster']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'
  routes:
    - match:
        severity: critical
      receiver: 'critical-team'
      continue: true
    
    - match:
        severity: warning
      receiver: 'ops-team'

receivers:
  - name: 'default'
    email_configs:
      - to: 'ops@example.com'
  
  - name: 'critical-team'
    email_configs:
      - to: 'oncall@example.com'
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=xxx'
  
  - name: 'ops-team'
    email_configs:
      - to: 'ops@example.com'

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
```

### 6.2 钉钉告警脚本

```bash
#!/bin/bash
# ========================================
# 钉钉Webhook告警脚本
# ========================================

DINGTALK_WEBHOOK="https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN"

ALERT_NAME=$1
ALERT_SEVERITY=$2
ALERT_MESSAGE=$3

JSON_DATA=$(cat <<EOF
{
    "msgtype": "markdown",
    "markdown": {
        "title": "网络告警",
        "text": "## 🔔 网络告警通知\n\n**告警名称**: ${ALERT_NAME}\n\n**严重程度**: ${ALERT_SEVERITY}\n\n**告警信息**: ${ALERT_MESSAGE}\n\n**时间**: $(date '+%Y-%m-%d %H:%M:%S')"
    },
    "at": {
        "isAtAll": false
    }
}
EOF
)

curl -H "Content-Type: application/json" \
     -d "$JSON_DATA" \
     "$DINGTALK_WEBHOOK"
```

---

## 7. 故障排查方法论

```yaml
故障排查流程:
  第一步_确定范围:
    问题现象: 用户报告的具体问题
    影响范围: 单用户/部门/全网
    发生时间: 何时开始出现
    环境变化: 近期是否有变更
  
  第二步_收集信息:
    用户终端:
      - IP配置 (ipconfig/ifconfig)
      - 网关可达性 (ping)
      - DNS解析 (nslookup)
    
    网络设备:
      - 接口状态
      - 配置变更日志
      - 错误日志
      - CPU/内存使用
    
    监控数据:
      - 流量图表
      - 告警历史
      - 性能指标
  
  第三步_分层排查:
    L1_物理层:
      ✓ 线缆连接
      ✓ 端口指示灯
      ✓ 光功率 (光纤)
    
    L2_数据链路层:
      ✓ 端口状态 (show interface)
      ✓ VLAN配置
      ✓ MAC地址表
      ✓ 生成树状态
    
    L3_网络层:
      ✓ IP配置
      ✓ 路由表
      ✓ ARP表
      ✓ Ping测试
    
    L4_传输层:
      ✓ 端口监听
      ✓ 连接状态
      ✓ 防火墙规则
    
    L7_应用层:
      ✓ 服务运行状态
      ✓ 应用日志
      ✓ 业务逻辑
  
  第四步_隔离问题:
    对比法:
      - 正常vs异常对比
      - 历史vs当前对比
    
    替换法:
      - 更换线缆
      - 更换模块
      - 切换路径
    
    分段法:
      - 逐段测试
      - 缩小范围
  
  第五步_解决问题:
    临时措施: 快速恢复服务
    根本解决: 彻底修复问题
    文档记录: 记录故障和解决方案
  
  第六步_验证与预防:
    验证: 确认问题已解决
    监控: 持续观察
    预防: 避免再次发生

OSI七层排查口诀:
  "物数网传会表应，自下而上把层清"
  - 先检查物理连接
  - 再查链路层配置
  - 然后看网络层路由
  - 最后排查应用问题
```

---

## 8. 常见故障案例

### 案例1: 网络间歇性中断

```yaml
故障现象:
  用户访问内网资源间歇性中断
  Ping丢包率10-30%
  影响范围: 整个办公区
  持续时间: 2小时

排查过程:
  1. 检查用户终端:
     - IP配置正常
     - ping网关有丢包
  
  2. 检查接入交换机:
     - show interface: 大量CRC错误
     - show mac address-table: MAC地址频繁变化
     - show interface counters errors: input errors持续增长
  
  3. 检查物理连接:
     - 发现某条线缆松动
     - 插头氧化

根本原因:
  网线接触不良导致CRC错误和丢包

解决方案:
  1. 临时: 更换网线
  2. 永久: 重新整理布线，使用质量更好的网线
  3. 预防: 定期检查线缆，监控CRC错误

关键命令:
  show interface GigabitEthernet1/0/1
  show interface counters errors
  show logging | include CRC
```

### 案例2: VLAN间无法通信

```yaml
故障现象:
  Web服务器(VLAN40)无法访问数据库(VLAN42)
  应用报错: Connection refused

排查过程:
  1. 测试连通性:
     Web服务器: ping 10.100.42.10 (数据库) - 失败
     
  2. 检查路由:
     show ip route - 路由存在
     show ip interface brief - 接口Up
  
  3. 检查ACL:
     show access-lists - 发现DB-ACCESS ACL
     show ip access-lists DB-ACCESS
     发现: 只允许10.100.41.0/24访问数据库
     问题: Web服务器在10.100.40.0/24网段
  
  4. 检查配置历史:
     show archive log config all
     发现昨天有ACL变更

根本原因:
  ACL配置错误，未包含Web服务器网段

解决方案:
  ip access-list extended DB-ACCESS
   5 permit tcp 10.100.40.0 0.0.0.255 10.100.42.0 0.0.0.127 eq 3306
   10 permit tcp 10.100.41.0 0.0.0.255 10.100.42.0 0.0.0.127 eq 3306

教训:
  - 配置变更必须有变更申请
  - ACL变更要充分测试
  - 配置前后要备份
```

### 案例3: 广播风暴

```yaml
故障现象:
  全网网络卡顿
  交换机CPU 100%
  接口流量异常

排查过程:
  1. 检查CPU使用:
     show processes cpu sorted
     发现: "Ethernet Input"进程占用90%
  
  2. 检查接口流量:
     show interface counters rate
     发现: 所有接口都有大量广播包
  
  3. 检查生成树:
     show spanning-tree
     发现: 多个端口处于Forwarding状态
     原因: 某台交换机生成树被禁用
  
  4. 定位源头:
     show mac address-table动态变化
     show cdp neighbors - 发现新接入设备

根本原因:
  用户私接交换机，且禁用了生成树，形成环路

解决方案:
  1. 紧急: 断开环路端口
     interface GigabitEthernet1/0/24
      shutdown
  
  2. 长期: 启用BPDU Guard
     spanning-tree portfast bpduguard default
     
     在所有接入端口:
     interface range GigabitEthernet1/0/1-24
      spanning-tree portfast
      spanning-tree bpduguard enable

预防措施:
  - 接入层启用BPDU Guard
  - 端口安全限制MAC数量
  - 监控广播流量
```

---

## 9. 诊断命令大全

### 9.1 Cisco诊断命令

```cisco
! ========================================
! Cisco常用诊断命令
! ========================================

! === 基础信息 ===
show version                          ! 版本信息
show running-config                   ! 运行配置
show startup-config                   ! 启动配置
show inventory                        ! 硬件清单
show module                           ! 模块信息

! === 接口诊断 ===
show interfaces                       ! 所有接口状态
show interfaces status                ! 接口简要状态
show interfaces GigabitEthernet1/0/1  ! 特定接口详细信息
show interfaces counters              ! 接口计数器
show interfaces counters errors       ! 接口错误统计
show interfaces description           ! 接口描述
show controllers                      ! 控制器信息

! === VLAN和交换 ===
show vlan brief                       ! VLAN简要信息
show vlan id 10                       ! 特定VLAN详情
show interfaces switchport            ! 交换端口配置
show interfaces trunk                 ! Trunk端口信息
show mac address-table                ! MAC地址表
show mac address-table aging-time     ! MAC老化时间

! === 链路聚合 ===
show etherchannel summary             ! EtherChannel概要
show etherchannel 1 detail            ! 特定Channel详情
show lacp neighbor                    ! LACP邻居
show lacp internal                    ! LACP内部状态

! === 生成树 ===
show spanning-tree                    ! 生成树状态
show spanning-tree summary            ! 生成树摘要
show spanning-tree vlan 10            ! 特定VLAN生成树
show spanning-tree interface Gi1/0/1  ! 特定接口生成树
show spanning-tree blockedports       ! 被阻塞端口

! === 路由相关 ===
show ip interface brief               ! IP接口简要
show ip route                         ! 路由表
show ip arp                           ! ARP表
show ip protocols                     ! 路由协议
show ip route summary                 ! 路由摘要

! === VRRP/HSRP ===
show vrrp brief                       ! VRRP简要
show vrrp interface Vlan10            ! 特定接口VRRP
show standby brief                    ! HSRP简要
show standby                          ! HSRP详细

! === ACL ===
show access-lists                     ! 所有ACL
show ip access-lists                  ! IP ACL
show ip interface Vlan10 | include access list  ! 接口应用的ACL

! === 性能监控 ===
show processes cpu                    ! CPU使用
show processes cpu sorted             ! CPU排序
show processes cpu history            ! CPU历史
show processes memory                 ! 内存使用
show processes memory sorted          ! 内存排序
show environment all                  ! 环境传感器

! === 日志 ===
show logging                          ! 日志信息
show logging | include ERROR          ! 过滤错误
show archive log config all           ! 配置变更历史

! === 诊断测试 ===
ping 192.168.10.1                     ! Ping测试
traceroute 192.168.10.1               ! 路由追踪
telnet 192.168.10.1 22                ! Telnet端口测试

! === CDP/LLDP ===
show cdp neighbors                    ! CDP邻居
show cdp neighbors detail             ! CDP详细
show lldp neighbors                   ! LLDP邻居
show lldp neighbors detail            ! LLDP详细
```

### 9.2 Linux网络诊断命令

```bash
#!/bin/bash
# ========================================
# Linux网络诊断命令
# ========================================

# === 接口状态 ===
ip addr show                          # IP地址
ip link show                          # 链路状态
ifconfig -a                           # 所有接口
ethtool eth0                          # 网卡详细信息
ethtool -S eth0                       # 网卡统计

# === 路由和网关 ===
ip route show                         # 路由表
route -n                              # 路由表(数字)
ip neigh show                         # ARP表(邻居)
arp -an                               # ARP表

# === 连接状态 ===
ss -tunlp                             # 所有监听端口
ss -s                                 # 套接字统计
netstat -tunlp                        # 所有连接
netstat -i                            # 接口统计

# === 连通性测试 ===
ping -c 4 192.168.10.1                # Ping测试
ping6 -c 4 fe80::1                    # IPv6 Ping
traceroute 192.168.10.1               # 路由追踪
mtr 192.168.10.1                      # 持续路由追踪

# === DNS ===
nslookup www.example.com              # DNS查询
dig www.example.com                   # DNS详细查询
host www.example.com                  # 简单DNS查询

# === 端口扫描 ===
nmap -p 80,443 192.168.10.1           # 端口扫描
nc -zv 192.168.10.1 80                # 端口测试
telnet 192.168.10.1 80                # Telnet测试

# === 流量监控 ===
iftop                                 # 实时流量监控
nethogs                               # 按进程流量
iptraf-ng                             # 交互式流量监控
tcpdump -i eth0 -n                    # 抓包
tcpdump -i eth0 port 80 -w capture.pcap  # 抓包保存

# === 防火墙 ===
iptables -L -v -n                     # iptables规则
iptables -L INPUT -v -n --line-numbers  # 带行号
nft list ruleset                      # nftables规则
ufw status verbose                    # UFW状态

# === 性能 ===
iperf3 -s                             # iperf3服务器
iperf3 -c 192.168.10.1                # iperf3客户端
speedtest-cli                         # 网速测试

# === 日志 ===
journalctl -u networking -f           # 网络服务日志
tail -f /var/log/syslog | grep -i network  # 实时网络日志
dmesg | grep -i eth                   # 内核网络消息
```

---

## 10. 故障排查工具

### 10.1 抓包分析 (tcpdump/Wireshark)

```bash
#!/bin/bash
# ========================================
# tcpdump抓包示例
# ========================================

# 基础抓包
tcpdump -i eth0

# 抓取特定主机
tcpdump -i eth0 host 192.168.10.100

# 抓取特定端口
tcpdump -i eth0 port 80

# 抓取TCP SYN包 (端口扫描检测)
tcpdump -i eth0 'tcp[tcpflags] & (tcp-syn) != 0'

# 抓取ICMP
tcpdump -i eth0 icmp

# 保存到文件
tcpdump -i eth0 -w capture.pcap

# 读取文件
tcpdump -r capture.pcap

# 只显示包头
tcpdump -i eth0 -n -c 100

# 详细显示
tcpdump -i eth0 -vv -n

# 过滤组合
tcpdump -i eth0 'src 192.168.10.100 and dst port 3306'

# 排除SSH流量
tcpdump -i eth0 'port not 22'
```

### 10.2 网络性能测试

```bash
#!/bin/bash
# ========================================
# 网络性能测试脚本
# ========================================

TARGET_HOST="192.168.10.100"
DURATION=30

echo "=== 网络性能测试 ==="
echo "目标: $TARGET_HOST"
echo "时间: $(date)"
echo ""

# 1. 延迟测试
echo "--- Ping延迟测试 ---"
ping -c 10 $TARGET_HOST | tail -2

# 2. 带宽测试 (iperf3)
echo -e "\n--- 带宽测试 (TCP) ---"
iperf3 -c $TARGET_HOST -t $DURATION

echo -e "\n--- 带宽测试 (UDP) ---"
iperf3 -c $TARGET_HOST -u -b 1G -t 10

# 3. 路由追踪
echo -e "\n--- 路由追踪 ---"
traceroute -n $TARGET_HOST

# 4. MTU测试
echo -e "\n--- MTU测试 ---"
for size in 1472 1500 8972 9000; do
    echo "测试MTU $size:"
    ping -c 3 -M do -s $size $TARGET_HOST 2>&1 | grep -E "bytes of data|Message too long"
done

# 5. 并发连接测试
echo -e "\n--- 并发连接测试 ---"
iperf3 -c $TARGET_HOST -P 10 -t 10

echo -e "\n✅ 测试完成"
```

### 10.3 自动化巡检脚本

```bash
#!/bin/bash
# ========================================
# 网络设备自动化巡检脚本
# ========================================

DEVICES_FILE="devices.txt"  # 设备列表文件
REPORT_DIR="/var/log/network-patrol"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "$REPORT_DIR"

while IFS=: read -r IP NAME; do
    echo "========================================" | tee "$REPORT_DIR/${NAME}_${DATE}.log"
    echo "巡检设备: $NAME ($IP)" | tee -a "$REPORT_DIR/${NAME}_${DATE}.log"
    echo "时间: $(date)" | tee -a "$REPORT_DIR/${NAME}_${DATE}.log"
    echo "" | tee -a "$REPORT_DIR/${NAME}_${DATE}.log"
    
    # 连通性测试
    echo "--- Ping测试 ---" | tee -a "$REPORT_DIR/${NAME}_${DATE}.log"
    if ping -c 3 -W 2 $IP &> /dev/null; then
        echo "✅ 设备可达" | tee -a "$REPORT_DIR/${NAME}_${DATE}.log"
    else
        echo "❌ 设备不可达" | tee -a "$REPORT_DIR/${NAME}_${DATE}.log"
        continue
    fi
    
    # SNMP检查 (假设使用SNMPv2c, community=public)
    echo -e "\n--- CPU使用率 ---" | tee -a "$REPORT_DIR/${NAME}_${DATE}.log"
    CPU=$(snmpget -v2c -c public -Ovq $IP .1.3.6.1.4.1.9.9.109.1.1.1.1.3.1 2>/dev/null)
    if [ -n "$CPU" ]; then
        echo "CPU: $CPU%" | tee -a "$REPORT_DIR/${NAME}_${DATE}.log"
        if [ "$CPU" -gt 80 ]; then
            echo "⚠️  警告: CPU使用率过高" | tee -a "$REPORT_DIR/${NAME}_${DATE}.log"
        fi
    fi
    
    echo -e "\n--- 内存使用 ---" | tee -a "$REPORT_DIR/${NAME}_${DATE}.log"
    MEM_USED=$(snmpget -v2c -c public -Ovq $IP .1.3.6.1.4.1.9.9.48.1.1.1.5.1 2>/dev/null)
    MEM_FREE=$(snmpget -v2c -c public -Ovq $IP .1.3.6.1.4.1.9.9.48.1.1.1.6.1 2>/dev/null)
    if [ -n "$MEM_USED" ] && [ -n "$MEM_FREE" ]; then
        MEM_TOTAL=$((MEM_USED + MEM_FREE))
        MEM_PERCENT=$((MEM_USED * 100 / MEM_TOTAL))
        echo "内存使用: $MEM_USED / $MEM_TOTAL ($MEM_PERCENT%)" | tee -a "$REPORT_DIR/${NAME}_${DATE}.log"
        if [ "$MEM_PERCENT" -gt 90 ]; then
            echo "⚠️  警告: 内存使用率过高" | tee -a "$REPORT_DIR/${NAME}_${DATE}.log"
        fi
    fi
    
done < "$DEVICES_FILE"

echo "✅ 巡检完成，报告保存在: $REPORT_DIR"
```

---

## 相关文档

- [网络拓扑与VLAN规划](01_网络拓扑与VLAN规划.md)
- [交换机配置与优化](02_交换机配置与优化.md)
- [负载均衡与高可用](03_负载均衡与高可用.md)
- [网络安全策略](04_网络安全策略.md)

---

**更新时间**: 2025-10-19  
**文档版本**: v1.0  
**状态**: ✅ 生产就绪
