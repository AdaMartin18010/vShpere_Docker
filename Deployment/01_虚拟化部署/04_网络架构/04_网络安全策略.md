# 网络安全策略

> **返回**: [网络架构目录](README.md) | [虚拟化部署首页](../README.md) | [部署指南首页](../../00_索引导航/README.md)

---

## 📋 目录

- [网络安全策略](#网络安全策略)
  - [📋 目录](#-目录)
  - [1. 安全设计原则](#1-安全设计原则)
  - [2. 防火墙配置](#2-防火墙配置)
    - [2.1 Linux防火墙 (iptables/nftables)](#21-linux防火墙-iptablesnftables)
    - [2.2 UFW防火墙 (Ubuntu)](#22-ufw防火墙-ubuntu)
    - [2.3 firewalld防火墙 (CentOS/RHEL)](#23-firewalld防火墙-centosrhel)
  - [3. ACL访问控制](#3-acl访问控制)
    - [3.1 Cisco标准ACL](#31-cisco标准acl)
    - [3.2 Cisco扩展ACL](#32-cisco扩展acl)
    - [3.3 时间范围ACL](#33-时间范围acl)
    - [3.4 华为ACL配置](#34-华为acl配置)
  - [4. 网络隔离与分段](#4-网络隔离与分段)
    - [4.1 VLAN隔离](#41-vlan隔离)
    - [4.2 Private VLAN隔离](#42-private-vlan隔离)
    - [4.3 微分段 (Micro-segmentation)](#43-微分段-micro-segmentation)
      - [Kubernetes NetworkPolicy示例](#kubernetes-networkpolicy示例)
  - [5. VPN配置](#5-vpn配置)
    - [5.1 IPSec VPN (Site-to-Site)](#51-ipsec-vpn-site-to-site)
    - [5.2 OpenVPN服务器配置](#52-openvpn服务器配置)
    - [5.3 WireGuard VPN (现代化)](#53-wireguard-vpn-现代化)
  - [6. 入侵检测与防护](#6-入侵检测与防护)
    - [6.1 Snort IDS配置](#61-snort-ids配置)
    - [6.2 Suricata IDS/IPS](#62-suricata-idsips)
  - [7. DDoS防护](#7-ddos防护)
    - [Linux系统DDoS防护](#linux系统ddos防护)
  - [8. 安全审计与日志](#8-安全审计与日志)
    - [8.1 集中日志收集 (ELK Stack)](#81-集中日志收集-elk-stack)
    - [8.2 审计日志配置](#82-审计日志配置)
  - [9. 安全加固清单](#9-安全加固清单)
  - [相关文档](#相关文档)

---

## 1. 安全设计原则

```yaml
网络安全核心原则:
  零信任架构 (Zero Trust):
    原则: 永不信任，始终验证
    实施:
      - 默认拒绝所有流量
      - 显式授权必要流量
      - 最小权限原则
      - 持续验证身份
      - 微分段隔离
    
  纵深防御 (Defense in Depth):
    层次:
      L1_物理层: 机房门禁、监控
      L2_网络层: 防火墙、IPS、隔离
      L3_主机层: 防病毒、补丁、加固
      L4_应用层: WAF、输入验证
      L5_数据层: 加密、备份、审计
    
  最小权限原则:
    网络: 只开放必要端口
    用户: 只授予必要权限
    服务: 只运行必要服务
    数据: 只访问必要数据

安全区域划分:
  DMZ (非军事区):
    位置: 外网与内网之间
    用途: 对外服务 (Web/邮件/DNS)
    隔离: 防火墙隔离内外网
  
  内网区:
    管理区: VLAN 10 - 管理设备
    办公区: VLAN 100 - 办公终端
    生产区: VLAN 40-42 - 生产系统
    存储区: VLAN 30-31 - 存储网络
  
  访问控制:
    外网 → DMZ: 允许 (HTTP/HTTPS)
    DMZ → 内网: 严格限制
    内网 → DMZ: 允许
    内网各区: 按需控制
```

---

## 2. 防火墙配置

### 2.1 Linux防火墙 (iptables/nftables)

```bash
#!/bin/bash
# ========================================
# iptables防火墙配置脚本
# ========================================

# 清空现有规则
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X

# 设置默认策略 (默认拒绝)
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# 允许本地回环
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# 允许已建立连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

# 防止SYN洪水攻击
iptables -A INPUT -p tcp --syn -m limit --limit 1/s --limit-burst 3 -j ACCEPT
iptables -A INPUT -p tcp --syn -j DROP

# 防止ICMP洪水攻击
iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT

# 允许SSH (限制来源)
iptables -A INPUT -p tcp -s 192.168.10.0/24 --dport 22 -m state --state NEW -j ACCEPT

# 允许HTTP/HTTPS
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 允许DNS
iptables -A INPUT -p udp --dport 53 -j ACCEPT
iptables -A INPUT -p tcp --dport 53 -j ACCEPT

# 记录被拒绝的包
iptables -A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables INPUT denied: " --log-level 7
iptables -A FORWARD -m limit --limit 5/min -j LOG --log-prefix "iptables FORWARD denied: " --log-level 7

# 保存规则
iptables-save > /etc/iptables/rules.v4

echo "✅ 防火墙规则配置完成"
iptables -L -v -n
```

### 2.2 UFW防火墙 (Ubuntu)

```bash
#!/bin/bash
# ========================================
# UFW防火墙配置
# ========================================

# 重置UFW
ufw --force reset

# 默认策略
ufw default deny incoming
ufw default allow outgoing

# 允许SSH (限制来源)
ufw allow from 192.168.10.0/24 to any port 22 proto tcp

# 允许HTTP/HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# 允许特定服务
ufw allow from 192.168.10.0/24 to any port 3306 proto tcp  # MySQL
ufw allow from 192.168.10.0/24 to any port 5432 proto tcp  # PostgreSQL

# 速率限制SSH
ufw limit 22/tcp

# 启用日志
ufw logging medium

# 启用UFW
ufw --force enable

# 查看状态
ufw status verbose
```

### 2.3 firewalld防火墙 (CentOS/RHEL)

```bash
#!/bin/bash
# ========================================
# firewalld防火墙配置
# ========================================

# 启动firewalld
systemctl start firewalld
systemctl enable firewalld

# 设置默认区域
firewall-cmd --set-default-zone=public

# 创建自定义区域
firewall-cmd --permanent --new-zone=management
firewall-cmd --permanent --new-zone=dmz-zone
firewall-cmd --permanent --new-zone=internal

# 配置管理区域
firewall-cmd --permanent --zone=management --add-source=192.168.10.0/24
firewall-cmd --permanent --zone=management --add-service=ssh
firewall-cmd --permanent --zone=management --add-service=https

# 配置DMZ区域
firewall-cmd --permanent --zone=dmz-zone --add-service=http
firewall-cmd --permanent --zone=dmz-zone --add-service=https

# 配置内网区域
firewall-cmd --permanent --zone=internal --add-source=10.100.0.0/16
firewall-cmd --permanent --zone=internal --add-service=mysql
firewall-cmd --permanent --zone=internal --add-service=postgresql

# 端口转发示例
firewall-cmd --permanent --zone=public --add-forward-port=port=8080:proto=tcp:toport=80

# 富规则 (高级规则)
firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.10.0/24" port port="3306" protocol="tcp" accept'

# 重载配置
firewall-cmd --reload

# 查看配置
firewall-cmd --list-all-zones
```

---

## 3. ACL访问控制

### 3.1 Cisco标准ACL

```cisco
! ========================================
! Cisco标准ACL配置
! ========================================

! 标准ACL (1-99, 1300-1999)
! 只能匹配源IP地址

! 允许管理网络访问
access-list 10 permit 192.168.10.0 0.0.0.255
access-list 10 deny any log

! 应用到接口
interface Vlan10
 ip access-group 10 in

! 验证
show access-lists
show ip access-lists 10
show ip interface Vlan10
```

### 3.2 Cisco扩展ACL

```cisco
! ========================================
! Cisco扩展ACL配置
! ========================================

! 扩展ACL (100-199, 2000-2699)
! 可以匹配源/目标IP、端口、协议

! 限制数据库访问
ip access-list extended DB-ACCESS
 remark === Allow app servers to database ===
 permit tcp 10.100.41.0 0.0.0.255 10.100.42.0 0.0.0.127 eq 3306
 permit tcp 10.100.41.0 0.0.0.255 10.100.42.0 0.0.0.127 eq 5432
 remark === Deny all other traffic ===
 deny ip any 10.100.42.0 0.0.0.127 log
 permit ip any any

! Web服务器ACL
ip access-list extended WEB-ACCESS
 remark === Allow HTTP/HTTPS from anywhere ===
 permit tcp any 10.100.40.0 0.0.0.255 eq 80
 permit tcp any 10.100.40.0 0.0.0.255 eq 443
 remark === Allow SSH from management ===
 permit tcp 192.168.10.0 0.0.0.255 10.100.40.0 0.0.0.255 eq 22
 remark === Deny all other inbound ===
 deny ip any 10.100.40.0 0.0.0.255 log
 permit ip any any

! 应用ACL
interface Vlan42
 description Database-Tier
 ip access-group DB-ACCESS in

interface Vlan40
 description Web-Tier
 ip access-group WEB-ACCESS in

! 验证
show access-lists
show ip interface Vlan42
```

### 3.3 时间范围ACL

```cisco
! ========================================
! 基于时间的ACL
! ========================================

! 定义时间范围 (工作时间)
time-range BUSINESS-HOURS
 periodic weekdays 8:00 to 18:00

! 定义时间范围 (维护窗口)
time-range MAINTENANCE-WINDOW
 periodic weekend 2:00 to 6:00

! 使用时间范围的ACL
ip access-list extended TIMED-ACCESS
 permit tcp 192.168.100.0 0.0.0.255 any eq 80 time-range BUSINESS-HOURS
 permit tcp 192.168.100.0 0.0.0.255 any eq 443 time-range BUSINESS-HOURS
 deny ip any any log

! 应用
interface GigabitEthernet1/0/1
 ip access-group TIMED-ACCESS in
```

### 3.4 华为ACL配置

```huawei
# ========================================
# 华为ACL配置
# ========================================

# 基本ACL (2000-2999)
acl number 2000
 description Management-Access
 rule 5 permit source 192.168.10.0 0.0.0.255
 rule 10 deny source any

# 高级ACL (3000-3999)
acl number 3000
 description Database-Access
 rule 5 permit tcp source 10.100.41.0 0.0.0.255 destination 10.100.42.0 0.0.0.127 destination-port eq 3306
 rule 10 permit tcp source 10.100.41.0 0.0.0.255 destination 10.100.42.0 0.0.0.127 destination-port eq 5432
 rule 15 deny ip destination 10.100.42.0 0.0.0.127

# 应用ACL
interface Vlanif42
 traffic-filter inbound acl 3000

# 验证
display acl all
display acl 3000
display traffic-filter applied-record
```

---

## 4. 网络隔离与分段

### 4.1 VLAN隔离

```yaml
VLAN_Isolation:
  管理隔离:
    VLAN_10: 网络设备管理
    VLAN_11: 虚拟化管理 (vCenter/ESXi)
    访问: 严格限制，仅管理员
  
  业务隔离:
    VLAN_40: Web层
    VLAN_41: 应用层
    VLAN_42: 数据库层
    策略: 单向访问，逐层防护
  
  存储隔离:
    VLAN_30: iSCSI存储A
    VLAN_31: iSCSI存储B
    特点: 独立网络，Jumbo Frame
  
  安全策略:
    - VLAN间默认禁止通信
    - 通过ACL显式允许必要流量
    - 记录所有跨VLAN流量
```

### 4.2 Private VLAN隔离

```cisco
! ========================================
! Private VLAN端口隔离
! ========================================

! 场景：同一VLAN内服务器之间隔离
! 应用：Web服务器集群，防止横向移动

! 创建Private VLAN
vlan 200
 name Primary-VLAN
 private-vlan primary

vlan 201
 name Isolated-VLAN
 private-vlan isolated

vlan 202
 name Community-VLAN
 private-vlan community

! 关联
vlan 200
 private-vlan association 201,202

! 配置Promiscuous端口 (网关/防火墙)
interface GigabitEthernet1/0/1
 description Gateway
 switchport mode private-vlan promiscuous
 switchport private-vlan mapping 200 201,202

! 配置Isolated端口 (完全隔离的服务器)
interface range GigabitEthernet1/0/10-20
 description Isolated-Web-Servers
 switchport mode private-vlan host
 switchport private-vlan host-association 200 201

! 配置Community端口 (允许组内通信)
interface range GigabitEthernet1/0/21-30
 description App-Servers-Group
 switchport mode private-vlan host
 switchport private-vlan host-association 200 202
```

### 4.3 微分段 (Micro-segmentation)

```yaml
Micro_Segmentation:
  概念: 细粒度的网络分段和访问控制
  
  传统分段:
    粒度: VLAN/子网
    规则: 基于网络位置
    问题: 横向移动风险
  
  微分段:
    粒度: 工作负载/应用
    规则: 基于身份和上下文
    优势: 零信任，最小权限
  
  实施方式:
    VMware_NSX:
      - 分布式防火墙
      - 基于VM标签的策略
      - 动态安全组
    
    Kubernetes_NetworkPolicy:
      - Pod级别隔离
      - 命名空间隔离
      - Ingress/Egress规则
    
    Cisco_ACI:
      - 应用为中心
      - 合约(Contract)机制
      - EPG (Endpoint Group)
```

#### Kubernetes NetworkPolicy示例

```yaml
# ========================================
# Kubernetes NetworkPolicy
# ========================================

# 策略1: 默认拒绝所有流量
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# 策略2: 允许Web到App的流量
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-web-to-app
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: app
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: web
    ports:
    - protocol: TCP
      port: 8080

---
# 策略3: 允许App到数据库的流量
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-app-to-db
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: database
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: app
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 5432

---
# 策略4: 允许DNS查询
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
```

---

## 5. VPN配置

### 5.1 IPSec VPN (Site-to-Site)

```cisco
! ========================================
! Cisco IPSec Site-to-Site VPN
! ========================================

! ISAKMP策略 (Phase 1)
crypto isakmp policy 10
 encryption aes 256
 hash sha256
 authentication pre-share
 group 14
 lifetime 86400

! 预共享密钥
crypto isakmp key VpnKey@2025 address 203.0.113.10

! IPSec转换集 (Phase 2)
crypto ipsec transform-set STRONG-TRANSFORM esp-aes 256 esp-sha256-hmac
 mode tunnel

! 定义感兴趣流量
ip access-list extended VPN-TRAFFIC
 permit ip 192.168.10.0 0.0.0.255 10.20.30.0 0.0.0.255

! 创建加密映射
crypto map VPN-MAP 10 ipsec-isakmp
 set peer 203.0.113.10
 set transform-set STRONG-TRANSFORM
 set pfs group14
 match address VPN-TRAFFIC

! 应用到接口
interface GigabitEthernet0/0
 description WAN-Interface
 ip address 198.51.100.1 255.255.255.252
 crypto map VPN-MAP

! 验证
show crypto isakmp sa
show crypto ipsec sa
show crypto map
```

### 5.2 OpenVPN服务器配置

```bash
#!/bin/bash
# ========================================
# OpenVPN服务器配置
# ========================================

# 安装OpenVPN
apt update
apt install -y openvpn easy-rsa

# 初始化PKI
make-cadir ~/openvpn-ca
cd ~/openvpn-ca

# 配置vars
cat > vars << 'EOF'
export KEY_COUNTRY="CN"
export KEY_PROVINCE="Beijing"
export KEY_CITY="Beijing"
export KEY_ORG="Example Corp"
export KEY_EMAIL="admin@example.com"
export KEY_OU="IT"
export KEY_NAME="server"
EOF

# 生成CA证书
source vars
./clean-all
./build-ca

# 生成服务器证书
./build-key-server server

# 生成DH参数
./build-dh

# 生成TLS密钥
openvpn --genkey --secret keys/ta.key

# 配置OpenVPN服务器
cat > /etc/openvpn/server.conf << 'EOF'
port 1194
proto udp
dev tun

ca /etc/openvpn/ca.crt
cert /etc/openvpn/server.crt
key /etc/openvpn/server.key
dh /etc/openvpn/dh2048.pem
tls-auth /etc/openvpn/ta.key 0

server 10.8.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt

# 推送路由
push "route 192.168.10.0 255.255.255.0"
push "route 10.100.0.0 255.255.0.0"

# DNS
push "dhcp-option DNS 192.168.10.1"

keepalive 10 120
cipher AES-256-CBC
auth SHA256
comp-lzo
persist-key
persist-tun
status openvpn-status.log
log-append /var/log/openvpn.log
verb 3
EOF

# 启用IP转发
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -p

# 配置防火墙
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
iptables-save > /etc/iptables/rules.v4

# 启动OpenVPN
systemctl start openvpn@server
systemctl enable openvpn@server

echo "✅ OpenVPN服务器配置完成"
```

### 5.3 WireGuard VPN (现代化)

```bash
#!/bin/bash
# ========================================
# WireGuard VPN配置 (更快、更安全)
# ========================================

# 安装WireGuard
apt update
apt install -y wireguard

# 生成密钥对
wg genkey | tee /etc/wireguard/server_private.key | wg pubkey > /etc/wireguard/server_public.key
chmod 600 /etc/wireguard/server_private.key

# 配置WireGuard服务器
cat > /etc/wireguard/wg0.conf << 'EOF'
[Interface]
Address = 10.9.0.1/24
ListenPort = 51820
PrivateKey = <SERVER_PRIVATE_KEY>
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

# 客户端1
[Peer]
PublicKey = <CLIENT1_PUBLIC_KEY>
AllowedIPs = 10.9.0.2/32

# 客户端2
[Peer]
PublicKey = <CLIENT2_PUBLIC_KEY>
AllowedIPs = 10.9.0.3/32
EOF

# 启用IP转发
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -p

# 启动WireGuard
systemctl enable wg-quick@wg0
systemctl start wg-quick@wg0

# 查看状态
wg show
```

---

## 6. 入侵检测与防护

### 6.1 Snort IDS配置

```bash
#!/bin/bash
# ========================================
# Snort入侵检测系统配置
# ========================================

# 安装Snort
apt update
apt install -y snort

# 配置Snort (/etc/snort/snort.conf)
cat >> /etc/snort/snort.conf << 'EOF'
# 网络配置
ipvar HOME_NET 192.168.10.0/24
ipvar EXTERNAL_NET any

# 规则路径
var RULE_PATH /etc/snort/rules

# 启用规则
include $RULE_PATH/local.rules
include $RULE_PATH/community.rules
EOF

# 自定义规则
cat > /etc/snort/rules/local.rules << 'EOF'
# SSH暴力破解检测
alert tcp any any -> $HOME_NET 22 (msg:"SSH Brute Force Attempt"; \
  flags:S; threshold:type both, track by_src, count 5, seconds 60; \
  sid:1000001; rev:1;)

# SQL注入检测
alert tcp any any -> $HOME_NET any (msg:"Possible SQL Injection"; \
  content:"select"; nocase; content:"from"; nocase; \
  sid:1000002; rev:1;)

# 端口扫描检测
alert tcp any any -> $HOME_NET any (msg:"Port Scan Detected"; \
  flags:S; threshold:type both, track by_src, count 20, seconds 60; \
  sid:1000003; rev:1;)
EOF

# 启动Snort
snort -c /etc/snort/snort.conf -i eth0 -D

# 查看日志
tail -f /var/log/snort/alert
```

### 6.2 Suricata IDS/IPS

```bash
#!/bin/bash
# ========================================
# Suricata IDS/IPS配置
# ========================================

# 安装Suricata
add-apt-repository ppa:oisf/suricata-stable
apt update
apt install -y suricata

# 更新规则
suricata-update

# 配置接口 (/etc/suricata/suricata.yaml)
cat > /etc/suricata/suricata.yaml << 'EOF'
vars:
  address-groups:
    HOME_NET: "[192.168.10.0/24,10.100.0.0/16]"
    EXTERNAL_NET: "!$HOME_NET"

af-packet:
  - interface: eth0
    cluster-id: 99
    cluster-type: cluster_flow
    defrag: yes

default-rule-path: /var/lib/suricata/rules
rule-files:
  - suricata.rules

outputs:
  - fast:
      enabled: yes
      filename: fast.log
  - eve-log:
      enabled: yes
      filetype: regular
      filename: eve.json
      types:
        - alert
        - http
        - dns
        - tls
EOF

# 启动Suricata
systemctl enable suricata
systemctl start suricata

# 查看统计
suricatasc -c "dump-counters"
tail -f /var/log/suricata/fast.log
```

---

## 7. DDoS防护

```yaml
DDoS_Protection:
  攻击类型:
    SYN_Flood:
      原理: 大量SYN包耗尽连接表
      防护: SYN Cookie, 连接速率限制
    
    UDP_Flood:
      原理: 大量UDP包耗尽带宽
      防护: 速率限制, 无效端口过滤
    
    HTTP_Flood:
      原理: 大量HTTP请求
      防护: WAF, 验证码, 速率限制
    
    Amplification:
      原理: 利用放大攻击 (DNS/NTP)
      防护: 禁止反射, BCP38

防护措施:
  网络层:
    - 上游ISP DDoS清洗服务
    - BGP Flowspec
    - Blackhole路由
  
  边界设备:
    - 硬件防火墙
    - 流量清洗设备
    - CDN服务
  
  系统层:
    - TCP参数调优
    - 连接数限制
    - SYN Cookie
  
  应用层:
    - WAF防护
    - 速率限制
    - 验证码
```

### Linux系统DDoS防护

```bash
#!/bin/bash
# ========================================
# Linux系统DDoS防护配置
# ========================================

# TCP参数优化
cat >> /etc/sysctl.conf << 'EOF'
# TCP SYN Cookie
net.ipv4.tcp_syncookies = 1

# SYN队列长度
net.ipv4.tcp_max_syn_backlog = 8192
net.core.netdev_max_backlog = 16384

# 连接追踪优化
net.netfilter.nf_conntrack_max = 1048576

# 超时设置
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_keepalive_time = 300

# IP源地址验证 (防止IP欺骗)
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# 忽略ICMP重定向
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0

# 禁止转发源路由包
net.ipv4.conf.all.accept_source_route = 0
EOF

sysctl -p

# iptables DDoS防护
iptables -N DDOS-PROTECT

# 限制新连接速率
iptables -A DDOS-PROTECT -p tcp --dport 80 -m state --state NEW -m limit --limit 50/s --limit-burst 100 -j ACCEPT
iptables -A DDOS-PROTECT -p tcp --dport 80 -m state --state NEW -j DROP

# 限制ICMP
iptables -A DDOS-PROTECT -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT
iptables -A DDOS-PROTECT -p icmp --icmp-type echo-request -j DROP

# 防止端口扫描
iptables -A DDOS-PROTECT -p tcp --tcp-flags ALL NONE -j DROP
iptables -A DDOS-PROTECT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP
iptables -A DDOS-PROTECT -p tcp --tcp-flags SYN,RST SYN,RST -j DROP

# 应用规则链
iptables -A INPUT -j DDOS-PROTECT

echo "✅ DDoS防护配置完成"
```

---

## 8. 安全审计与日志

### 8.1 集中日志收集 (ELK Stack)

```yaml
# ========================================
# Filebeat配置 (收集日志)
# ========================================
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/syslog
    - /var/log/auth.log
    - /var/log/firewall.log
  fields:
    log_type: system

- type: log
  enabled: true
  paths:
    - /var/log/nginx/access.log
    - /var/log/nginx/error.log
  fields:
    log_type: nginx

output.logstash:
  hosts: ["logstash.example.com:5044"]
  ssl.certificate_authorities: ["/etc/filebeat/ca.crt"]
```

### 8.2 审计日志配置

```bash
#!/bin/bash
# ========================================
# Linux审计系统 (auditd)
# ========================================

# 安装auditd
apt install -y auditd audispd-plugins

# 配置审计规则
cat > /etc/audit/rules.d/custom.rules << 'EOF'
# 删除所有规则
-D

# 缓冲区大小
-b 8192

# 失败模式 (1=打印, 2=内核panic)
-f 1

# 监控文件修改
-w /etc/passwd -p wa -k passwd_changes
-w /etc/shadow -p wa -k shadow_changes
-w /etc/group -p wa -k group_changes
-w /etc/sudoers -p wa -k sudoers_changes

# 监控网络配置
-w /etc/network/ -p wa -k network_changes
-w /etc/sysconfig/network-scripts/ -p wa -k network_changes

# 监控防火墙规则
-w /etc/iptables/ -p wa -k firewall_changes
-w /etc/ufw/ -p wa -k firewall_changes

# 监控SSH配置
-w /etc/ssh/sshd_config -p wa -k sshd_config_changes

# 监控特权命令
-a always,exit -F arch=b64 -S execve -F euid=0 -k root_commands

# 监控用户登录
-w /var/log/lastlog -p wa -k login_events
-w /var/run/faillock/ -p wa -k login_events

# 监控时间变更
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time_change
-a always,exit -F arch=b64 -S clock_settime -k time_change

# 监控内核模块
-w /sbin/insmod -p x -k kernel_modules
-w /sbin/rmmod -p x -k kernel_modules
-w /sbin/modprobe -p x -k kernel_modules

# 使规则生效
-e 2
EOF

# 重启auditd
service auditd restart

# 查看审计日志
ausearch -k passwd_changes
aureport --summary
```

---

## 9. 安全加固清单

```yaml
网络设备安全加固清单:
  基础安全:
    ✅ 修改默认密码
    ✅ 禁用不必要服务
    ✅ 启用SSH, 禁用Telnet
    ✅ 配置强密码策略
    ✅ 启用AAA认证
    ✅ 配置Banner警告
    ✅ 限制管理访问来源
    ✅ 启用NTP时间同步
  
  访问控制:
    ✅ 配置RBAC角色权限
    ✅ 使用密钥认证SSH
    ✅ 启用多因素认证
    ✅ 定期审查用户权限
    ✅ 禁用未使用端口
    ✅ 配置端口安全
    ✅ 启用DHCP Snooping
    ✅ 启用ARP Inspection
  
  日志审计:
    ✅ 启用日志记录
    ✅ 配置远程日志服务器
    ✅ 启用SNMP监控
    ✅ 配置Syslog告警
    ✅ 定期审查日志
    ✅ 保留180天日志
  
  网络防护:
    ✅ 配置ACL策略
    ✅ 启用STP保护
    ✅ 配置BPDU Guard
    ✅ 配置Root Guard
    ✅ 启用端口安全
    ✅ 配置风暴控制
    ✅ 启用私有VLAN
  
  加密通信:
    ✅ 使用SSHv2
    ✅ 禁用SSLv2/v3, TLSv1.0/1.1
    ✅ 配置强加密套件
    ✅ 启用SNMPv3
    ✅ 使用加密管理协议
  
  定期维护:
    ✅ 更新固件/软件
    ✅ 应用安全补丁
    ✅ 备份配置文件
    ✅ 审查安全策略
    ✅ 漏洞扫描
    ✅ 安全评估

服务器安全加固清单:
  系统加固:
    ✅ 最小化安装
    ✅ 禁用不必要服务
    ✅ 配置SELinux/AppArmor
    ✅ 内核参数优化
    ✅ 限制资源使用
  
  账户安全:
    ✅ 禁用root远程登录
    ✅ 使用sudo
    ✅ 强密码策略
    ✅ SSH密钥认证
    ✅ 定期密码变更
  
  防火墙:
    ✅ 启用防火墙
    ✅ 默认拒绝策略
    ✅ 最小权限开放
    ✅ 速率限制
  
  补丁管理:
    ✅ 自动更新安全补丁
    ✅ 定期全面更新
    ✅ 测试后再上线
  
  监控审计:
    ✅ 启用auditd
    ✅ 集中日志管理
    ✅ 入侵检测系统
    ✅ 文件完整性监控
  
  数据保护:
    ✅ 敏感数据加密
    ✅ 定期备份
    ✅ 备份加密
    ✅ 异地备份
```

---

## 相关文档

- [网络拓扑与VLAN规划](01_网络拓扑与VLAN规划.md)
- [交换机配置与优化](02_交换机配置与优化.md)
- [负载均衡与高可用](03_负载均衡与高可用.md)
- [网络监控与故障排查](05_网络监控与故障排查.md)

---

**更新时间**: 2025-10-19  
**文档版本**: v1.0  
**状态**: ✅ 生产就绪
