# 交换机配置与优化

> **返回**: [网络架构目录](README.md) | [虚拟化部署首页](../README.md) | [部署指南首页](../../00_索引导航/README.md)

---

## 📋 目录

- [交换机配置与优化](#交换机配置与优化)
  - [📋 目录](#-目录)
  - [交换机基础配置](#交换机基础配置)
    - [Cisco交换机基础配置](#cisco交换机基础配置)
    - [HPE/Aruba交换机基础配置](#hpearuba交换机基础配置)
    - [华为交换机基础配置](#华为交换机基础配置)
  - [VLAN配置](#vlan配置)
    - [创建和管理VLAN](#创建和管理vlan)
    - [Access端口配置](#access端口配置)
    - [Trunk端口配置](#trunk端口配置)
    - [VLAN间路由配置](#vlan间路由配置)
    - [Private VLAN配置](#private-vlan配置)
  - [链路聚合配置](#链路聚合配置)
    - [LACP配置 (推荐)](#lacp配置-推荐)
    - [PAgP配置 (Cisco私有)](#pagp配置-cisco私有)
    - [Static EtherChannel配置](#static-etherchannel配置)
    - [负载均衡配置](#负载均衡配置)
    - [HPE/Aruba链路聚合](#hpearuba链路聚合)
    - [华为链路聚合](#华为链路聚合)
  - [生成树协议配置](#生成树协议配置)
    - [RSTP配置](#rstp配置)
    - [MSTP配置](#mstp配置)
    - [HPE/Aruba生成树](#hpearuba生成树)
  - [QoS配置](#qos配置)
    - [基础QoS配置](#基础qos配置)
    - [存储网络QoS](#存储网络qos)
    - [Auto-QoS配置](#auto-qos配置)
  - [端口安全配置](#端口安全配置)
    - [基础端口安全](#基础端口安全)
    - [DHCP Snooping](#dhcp-snooping)
    - [Dynamic ARP Inspection (DAI)](#dynamic-arp-inspection-dai)
    - [IP Source Guard](#ip-source-guard)
  - [高可用配置](#高可用配置)
    - [堆叠配置 (Cisco StackWise)](#堆叠配置-cisco-stackwise)
    - [VSS配置 (Cisco Virtual Switching System)](#vss配置-cisco-virtual-switching-system)
    - [VSF配置 (HPE Aruba)](#vsf配置-hpe-aruba)
    - [CSS配置 (华为)](#css配置-华为)
  - [性能优化](#性能优化)
    - [Jumbo Frame配置](#jumbo-frame配置)
    - [流量监控 (NetFlow/sFlow)](#流量监控-netflowsflow)
    - [端口镜像 (SPAN)](#端口镜像-span)
    - [CPU保护](#cpu保护)
  - [监控与管理](#监控与管理)
    - [SNMP配置详解](#snmp配置详解)
    - [日志配置](#日志配置)
    - [配置备份](#配置备份)
  - [故障排查](#故障排查)
  - [相关文档](#相关文档)

---

## 交换机基础配置

### Cisco交换机基础配置

```cisco
! ========================================
! Cisco交换机初始化配置
! ========================================

! 1. 进入特权模式
enable

! 2. 进入全局配置模式
configure terminal

! 3. 基础配置
hostname Core-SW1
no ip domain-lookup
service password-encryption

! 4. 配置特权密码
enable secret Cisco@2025

! 5. 配置Console密码
line console 0
 password Console@2025
 login
 logging synchronous
 exec-timeout 30 0
 exit

! 6. 配置VTY (Telnet/SSH)
line vty 0 15
 password VTY@2025
 login local
 transport input ssh
 exec-timeout 30 0
 exit

! 7. 创建管理用户
username admin privilege 15 secret Admin@2025

! 8. 配置SSH
ip domain-name example.com
crypto key generate rsa modulus 2048
ip ssh version 2
ip ssh time-out 60
ip ssh authentication-retries 3

! 9. 配置管理VLAN
vlan 10
 name MGMT-Network
 exit

interface Vlan10
 description Management-Interface
 ip address 192.168.10.10 255.255.255.0
 no shutdown
 exit

! 10. 配置默认网关
ip default-gateway 192.168.10.1

! 11. 配置NTP
ntp server 192.168.10.1 prefer
clock timezone CST 8
clock summer-time CDT recurring

! 12. 配置日志
logging buffered 51200 informational
logging console warnings
logging trap informational
logging source-interface Vlan10
logging host 192.168.10.100

! 13. 配置SNMP
snmp-server community public RO
snmp-server community private RW
snmp-server location "DC1-Rack-A-U10"
snmp-server contact "admin@example.com"
snmp-server enable traps
snmp-server host 192.168.10.100 version 2c public

! 14. Banner配置
banner login ^C
========================================
  Authorized Access Only
  Contact: admin@example.com
========================================
^C

! 15. 保存配置
end
write memory

! 或使用
copy running-config startup-config
```

### HPE/Aruba交换机基础配置

```bash
# ========================================
# HPE Aruba交换机初始化配置
# ========================================

# 进入配置模式
configure

# 基础配置
hostname "Core-SW1"
time timezone 480
time daylight-time-rule continental-us-and-canada

# 创建管理用户
user admin group administrators password plaintext Admin@2025

# 配置SSH
crypto key generate ssh rsa bits 2048
ip ssh version 2

# 配置管理VLAN
vlan 10
   name "MGMT-Network"
   exit

interface vlan 10
   ip address 192.168.10.10/24
   exit

# 配置默认网关
ip route 0.0.0.0/0 192.168.10.1

# 配置NTP
ntp server 192.168.10.1 prefer
ntp enable

# 配置日志
logging 192.168.10.100
logging facility local7
logging severity info

# 配置SNMP
snmp-server community "public" unrestricted
snmp-server host 192.168.10.100 community "public"
snmp-server location "DC1-Rack-A-U10"
snmp-server contact "admin@example.com"

# Banner
banner motd "Authorized Access Only"

# 保存配置
write memory
```

### 华为交换机基础配置

```huawei
# ========================================
# 华为交换机初始化配置
# ========================================

# 进入系统视图
system-view

# 基础配置
sysname Core-SW1
clock timezone BJ add 08:00:00

# 配置用户
aaa
 local-user admin password irreversible-cipher Admin@2025
 local-user admin privilege level 15
 local-user admin service-type telnet terminal ssh
 quit

# 配置SSH
rsa local-key-pair create
stelnet server enable
ssh user admin authentication-type password
ssh user admin service-type stelnet

# 配置Console
user-interface con 0
 authentication-mode password
 set authentication password cipher Console@2025
 idle-timeout 30 0
 quit

# 配置VTY
user-interface vty 0 4
 authentication-mode aaa
 protocol inbound ssh
 idle-timeout 30 0
 quit

# 配置管理VLAN
vlan 10
 description MGMT-Network
 quit

interface Vlanif10
 description Management-Interface
 ip address 192.168.10.10 255.255.255.0
 quit

# 配置默认路由
ip route-static 0.0.0.0 0.0.0.0 192.168.10.1

# 配置NTP
ntp-service unicast-server 192.168.10.1 prefer
ntp-service enable

# 配置日志
info-center loghost 192.168.10.100
info-center source default channel loghost log state on level informational

# 配置SNMP
snmp-agent
snmp-agent community read public
snmp-agent sys-info contact admin@example.com
snmp-agent sys-info location DC1-Rack-A-U10
snmp-agent target-host trap address udp-domain 192.168.10.100 params securityname public

# 保存配置
quit
save
```

---

## VLAN配置

### 创建和管理VLAN

```cisco
! ========================================
! Cisco VLAN配置
! ========================================

! 1. 创建VLAN
vlan 10
 name MGMT-Network
vlan 11
 name VMware-Management
vlan 20
 name vMotion-Network
vlan 30
 name iSCSI-Storage-A
vlan 31
 name iSCSI-Storage-B
vlan 40
 name Web-Tier
vlan 41
 name App-Tier
vlan 42
 name Database-Tier
vlan 100
 name Office-Network
vlan 999
 name Unused-VLAN

! 2. 查看VLAN
show vlan brief
show vlan id 10

! 3. 删除VLAN
no vlan 999

! 4. 批量创建VLAN
vlan 40-49
 name Production-VLANs
```

### Access端口配置

```cisco
! ========================================
! Access端口配置 (连接服务器/PC)
! ========================================

! 标准Access配置
interface GigabitEthernet1/0/1
 description ESXi-Host-1-MGMT
 switchport mode access
 switchport access vlan 11
 spanning-tree portfast
 spanning-tree bpduguard enable
 no shutdown

! 带Voice VLAN的配置 (IP电话)
interface GigabitEthernet1/0/10
 description IP-Phone-User-PC
 switchport mode access
 switchport access vlan 100
 switchport voice vlan 220
 spanning-tree portfast
 power inline auto
 no shutdown

! 带Port Security的配置
interface GigabitEthernet1/0/20
 description Secure-Server
 switchport mode access
 switchport access vlan 42
 switchport port-security
 switchport port-security maximum 2
 switchport port-security violation restrict
 switchport port-security mac-address sticky
 spanning-tree portfast
 no shutdown
```

### Trunk端口配置

```cisco
! ========================================
! Trunk端口配置 (上行链路)
! ========================================

! 标准Trunk配置
interface GigabitEthernet1/0/48
 description Uplink-to-Core-SW1
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 10,11,20,30,31,40-42,100
 switchport trunk native vlan 999
 no shutdown

! 禁用DTP (推荐)
interface GigabitEthernet1/0/48
 switchport mode trunk
 switchport nonegotiate

! 动态Trunk (不推荐)
interface GigabitEthernet1/0/48
 switchport mode dynamic desirable
 ! 或
 switchport mode dynamic auto
```

### VLAN间路由配置

```cisco
! ========================================
! L3交换机VLAN间路由 (SVI)
! ========================================

! 启用IP路由
ip routing

! 创建VLAN接口
interface Vlan10
 description MGMT-Network-Gateway
 ip address 192.168.10.1 255.255.255.0
 ip helper-address 192.168.10.10
 no shutdown

interface Vlan40
 description Web-Tier-Gateway
 ip address 10.100.40.1 255.255.255.0
 ip helper-address 192.168.10.10
 no shutdown

interface Vlan41
 description App-Tier-Gateway
 ip address 10.100.41.1 255.255.255.0
 ip helper-address 192.168.10.10
 no shutdown

interface Vlan42
 description Database-Tier-Gateway
 ip address 10.100.42.1 255.255.255.128
 no ip proxy-arp
 no shutdown

! 配置访问控制列表 (ACL)
ip access-list extended RESTRICT-DB
 permit tcp 10.100.41.0 0.0.0.255 10.100.42.0 0.0.0.127 eq 3306
 permit tcp 10.100.41.0 0.0.0.255 10.100.42.0 0.0.0.127 eq 5432
 deny ip any 10.100.42.0 0.0.0.127
 permit ip any any

interface Vlan42
 ip access-group RESTRICT-DB in
```

### Private VLAN配置

```cisco
! ========================================
! Private VLAN配置 (端口隔离)
! ========================================

! 1. 创建Private VLAN
vlan 200
 private-vlan primary
vlan 201
 private-vlan isolated
vlan 202
 private-vlan community

! 2. 关联Private VLAN
vlan 200
 private-vlan association 201,202

! 3. 配置Promiscuous端口 (网关)
interface GigabitEthernet1/0/1
 switchport mode private-vlan promiscuous
 switchport private-vlan mapping 200 201,202

! 4. 配置Isolated端口
interface range GigabitEthernet1/0/2-10
 switchport mode private-vlan host
 switchport private-vlan host-association 200 201

! 5. 配置Community端口
interface range GigabitEthernet1/0/11-20
 switchport mode private-vlan host
 switchport private-vlan host-association 200 202
```

---

## 链路聚合配置

### LACP配置 (推荐)

```cisco
! ========================================
! Cisco LACP (802.3ad) 配置
! ========================================

! 1. 创建Port-Channel接口
interface Port-channel1
 description LACP-to-Core-SW1
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 10,11,20,30,31,40-42,100
 switchport trunk native vlan 999

! 2. 配置物理接口
interface range GigabitEthernet1/0/47-48
 description Member-of-Port-channel1
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 10,11,20,30,31,40-42,100
 switchport trunk native vlan 999
 channel-group 1 mode active
 no shutdown

! 3. 验证配置
show etherchannel summary
show etherchannel 1 detail
show interfaces Port-channel1

! 4. L3 Port-Channel配置
interface Port-channel2
 description L3-Link-to-Core
 no switchport
 ip address 10.10.10.1 255.255.255.252

interface range TenGigabitEthernet1/0/1-2
 description Member-of-Port-channel2
 no switchport
 channel-group 2 mode active
 no shutdown
```

### PAgP配置 (Cisco私有)

```cisco
! ========================================
! PAgP配置 (不推荐，仅Cisco)
! ========================================

interface Port-channel3
 switchport mode trunk

interface range GigabitEthernet1/0/45-46
 channel-group 3 mode desirable
 ! 或
 channel-group 3 mode auto
```

### Static EtherChannel配置

```cisco
! ========================================
! 静态EtherChannel配置
! ========================================

interface Port-channel4
 switchport mode trunk

interface range GigabitEthernet1/0/43-44
 channel-group 4 mode on
 no shutdown
```

### 负载均衡配置

```cisco
! ========================================
! EtherChannel负载均衡
! ========================================

! 查看当前负载均衡方法
show etherchannel load-balance

! 配置负载均衡算法
! 可选: src-mac, dst-mac, src-dst-mac, src-ip, dst-ip, src-dst-ip, src-port, dst-port, src-dst-port

! 推荐：基于源和目标IP
port-channel load-balance src-dst-ip

! 或基于源和目标MAC+IP
port-channel load-balance src-dst-mixed-ip-port
```

### HPE/Aruba链路聚合

```bash
# ========================================
# HPE Aruba LACP配置
# ========================================

# 创建Trunk
trunk 1/1,1/2 trk1 lacp

# 配置为Trunk模式
interface trk1
   description "LACP to Core"
   vlan trunk native 999
   vlan trunk allowed 10,11,20,30,31,40-42,100
   exit

# 验证
show lacp
show trunk
```

### 华为链路聚合

```huawei
# ========================================
# 华为Eth-Trunk配置
# ========================================

# 创建Eth-Trunk
interface Eth-Trunk1
 description LACP-to-Core
 port link-type trunk
 port trunk allow-pass vlan 10 11 20 30 31 40 to 42 100
 port trunk pvid vlan 999
 mode lacp

# 添加成员接口
interface GigabitEthernet1/0/47
 eth-trunk 1
interface GigabitEthernet1/0/48
 eth-trunk 1

# 配置负载均衡
load-balance-profile lacp-profile
 load-balance enhanced dst-ip src-ip
interface Eth-Trunk1
 load-balance enhanced profile lacp-profile

# 验证
display eth-trunk 1
display lacp statistics eth-trunk 1
```

---

## 生成树协议配置

### RSTP配置

```cisco
! ========================================
! RSTP (Rapid Spanning Tree Protocol) 配置
! ========================================

! 1. 启用RSTP
spanning-tree mode rapid-pvst

! 2. 配置根桥
! 主根桥 (Core-SW1)
spanning-tree vlan 1-4094 priority 4096

! 备份根桥 (Core-SW2)
spanning-tree vlan 1-4094 priority 8192

! 3. 配置端口优先级
interface GigabitEthernet1/0/1
 spanning-tree vlan 10 port-priority 64

! 4. 配置PortFast (仅Access端口)
interface range GigabitEthernet1/0/1-24
 spanning-tree portfast

! 或全局配置
spanning-tree portfast default

! 5. 配置BPDU Guard (防止环路)
interface range GigabitEthernet1/0/1-24
 spanning-tree bpduguard enable

! 或全局配置
spanning-tree portfast bpduguard default

! 6. 配置Root Guard (保护根桥)
interface GigabitEthernet1/0/47
 spanning-tree guard root

! 7. 配置Loop Guard
interface GigabitEthernet1/0/48
 spanning-tree guard loop

! 8. UplinkFast (加速收敛)
spanning-tree uplinkfast

! 9. BackboneFast
spanning-tree backbonefast

! 10. 验证配置
show spanning-tree
show spanning-tree summary
show spanning-tree vlan 10
show spanning-tree interface GigabitEthernet1/0/1
```

### MSTP配置

```cisco
! ========================================
! MSTP (Multiple Spanning Tree Protocol) 配置
! ========================================

! 1. 启用MSTP
spanning-tree mode mst

! 2. 配置MST实例
spanning-tree mst configuration
 name COMPANY
 revision 1
 instance 1 vlan 10-19
 instance 2 vlan 20-39
 instance 3 vlan 40-99
 exit

! 3. 配置根桥
spanning-tree mst 0 priority 4096
spanning-tree mst 1 priority 4096
spanning-tree mst 2 priority 8192
spanning-tree mst 3 priority 8192

! 4. 验证配置
show spanning-tree mst configuration
show spanning-tree mst 0
```

### HPE/Aruba生成树

```bash
# ========================================
# HPE Aruba MSTP配置
# ========================================

# 启用MSTP
spanning-tree
spanning-tree mode mstp

# 配置MST实例
spanning-tree config-name "COMPANY"
spanning-tree config-revision 1
spanning-tree instance 1 vlan 10-19
spanning-tree instance 2 vlan 20-39

# 配置根桥
spanning-tree instance 0 priority 4
spanning-tree instance 1 priority 4
spanning-tree instance 2 priority 8

# 配置PortFast
interface 1/1-1/24
   spanning-tree admin-edge-port
   spanning-tree bpdu-protection
   exit

# 验证
show spanning-tree
show spanning-tree mst-config
```

---

## QoS配置

### 基础QoS配置

```cisco
! ========================================
! Cisco QoS配置
! ========================================

! 1. 启用QoS
mls qos

! 2. 信任DSCP (推荐)
interface range GigabitEthernet1/0/1-48
 mls qos trust dscp

! 3. 信任CoS
interface range GigabitEthernet1/0/1-24
 mls qos trust cos

! 4. 配置队列
! 配置队列权重 (WRR - Weighted Round Robin)
mls qos srr-queue output cos-map queue 1 threshold 3 4 5
mls qos srr-queue output cos-map queue 2 threshold 3 2 3
mls qos srr-queue output cos-map queue 3 threshold 3 0 1
mls qos srr-queue output cos-map queue 4 threshold 3 6 7

! 配置队列带宽
mls qos queue-set output 1 threshold 1 100 100 100 100
mls qos queue-set output 1 threshold 2 125 125 100 400
mls qos queue-set output 1 buffers 15 25 40 20

! 5. 分类和标记
! 创建Class Map
class-map match-any VOICE
 match ip dscp ef
class-map match-any VIDEO
 match ip dscp af41 af42 af43
class-map match-any CRITICAL-DATA
 match ip dscp af31 af32 af33
class-map match-any BEST-EFFORT
 match ip dscp default

! 创建Policy Map
policy-map QOS-POLICY
 class VOICE
  priority percent 30
 class VIDEO
  bandwidth percent 20
 class CRITICAL-DATA
  bandwidth percent 30
 class class-default
  bandwidth percent 20
  random-detect

! 应用策略
interface GigabitEthernet1/0/48
 service-policy output QOS-POLICY

! 6. 流量整形
policy-map SHAPE-10M
 class class-default
  shape average 10000000

interface GigabitEthernet1/0/10
 service-policy output SHAPE-10M

! 7. 流量监管
policy-map POLICE-50M
 class class-default
  police 50000000 conform-action transmit exceed-action drop

interface GigabitEthernet1/0/20
 service-policy input POLICE-50M
```

### 存储网络QoS

```cisco
! ========================================
! iSCSI/NFS存储网络QoS
! ========================================

! 1. 分类存储流量
class-map match-any ISCSI-TRAFFIC
 match access-group name ISCSI-ACL

ip access-list extended ISCSI-ACL
 permit tcp any any eq 3260
 permit tcp any eq 3260 any

class-map match-any NFS-TRAFFIC
 match access-group name NFS-ACL

ip access-list extended NFS-ACL
 permit tcp any any eq 2049
 permit udp any any eq 2049

! 2. 配置存储策略
policy-map STORAGE-QOS
 class ISCSI-TRAFFIC
  set ip dscp af41
  bandwidth percent 40
 class NFS-TRAFFIC
  set ip dscp af31
  bandwidth percent 30
 class class-default
  bandwidth percent 30

! 3. 应用到存储VLAN接口
interface Vlan30
 service-policy input STORAGE-QOS
interface Vlan31
 service-policy input STORAGE-QOS
```

### Auto-QoS配置

```cisco
! ========================================
! Auto-QoS (自动QoS)
! ========================================

! VoIP电话
interface GigabitEthernet1/0/10
 auto qos voip cisco-phone

! VoIP信任
interface GigabitEthernet1/0/11
 auto qos voip trust

! 视频
interface GigabitEthernet1/0/12
 auto qos video cts
 auto qos video ip-camera

! 验证
show auto qos
show mls qos
```

---

## 端口安全配置

### 基础端口安全

```cisco
! ========================================
! 端口安全配置
! ========================================

! 1. 基础配置
interface GigabitEthernet1/0/1
 switchport mode access
 switchport port-security
 switchport port-security maximum 2
 switchport port-security violation restrict
 switchport port-security mac-address sticky

! 2. 违规模式
! shutdown: 关闭端口 (默认)
interface GigabitEthernet1/0/2
 switchport port-security violation shutdown

! restrict: 限制+记录
interface GigabitEthernet1/0/3
 switchport port-security violation restrict

! protect: 仅限制
interface GigabitEthernet1/0/4
 switchport port-security violation protect

! 3. 手动指定MAC
interface GigabitEthernet1/0/5
 switchport port-security mac-address 0011.2233.4455

! 4. 老化时间
interface GigabitEthernet1/0/6
 switchport port-security aging time 60
 switchport port-security aging type inactivity

! 5. 恢复err-disabled端口
errdisable recovery cause psecure-violation
errdisable recovery interval 300

! 6. 查看配置
show port-security
show port-security interface GigabitEthernet1/0/1
show port-security address
```

### DHCP Snooping

```cisco
! ========================================
! DHCP Snooping配置
! ========================================

! 1. 全局启用
ip dhcp snooping
ip dhcp snooping vlan 10,100

! 2. 配置信任端口
interface GigabitEthernet1/0/48
 description Uplink-Trusted
 ip dhcp snooping trust

! 3. 配置速率限制
interface range GigabitEthernet1/0/1-24
 ip dhcp snooping limit rate 10

! 4. 启用Option 82
ip dhcp snooping information option

! 5. 绑定数据库
ip dhcp snooping database tftp://192.168.10.100/dhcp-snooping.db

! 6. 验证
show ip dhcp snooping
show ip dhcp snooping binding
```

### Dynamic ARP Inspection (DAI)

```cisco
! ========================================
! DAI配置 (依赖DHCP Snooping)
! ========================================

! 1. 启用DAI
ip arp inspection vlan 10,100

! 2. 配置信任端口
interface GigabitEthernet1/0/48
 ip arp inspection trust

! 3. 验证源MAC
ip arp inspection validate src-mac

! 4. 验证目标MAC
ip arp inspection validate dst-mac

! 5. 验证IP地址
ip arp inspection validate ip

! 6. 所有验证
ip arp inspection validate src-mac dst-mac ip

! 7. 速率限制
interface range GigabitEthernet1/0/1-24
 ip arp inspection limit rate 15

! 8. 静态ARP绑定
arp access-list STATIC-ARP
 permit ip host 10.100.40.10 mac host 0011.2233.4455
 exit

ip arp inspection filter STATIC-ARP vlan 40

! 9. 验证
show ip arp inspection
show ip arp inspection statistics
```

### IP Source Guard

```cisco
! ========================================
! IP Source Guard配置
! ========================================

! 1. 基础配置 (仅IP)
interface GigabitEthernet1/0/1
 ip verify source

! 2. IP+MAC验证
interface GigabitEthernet1/0/2
 ip verify source port-security

! 3. 静态绑定
ip source binding 0011.2233.4455 vlan 10 10.100.40.10 interface GigabitEthernet1/0/3

! 4. 验证
show ip verify source
show ip source binding
```

---

## 高可用配置

### 堆叠配置 (Cisco StackWise)

```cisco
! ========================================
! Cisco StackWise配置
! ========================================

! 1. 查看堆叠状态
show switch

! 2. 配置交换机优先级
switch 1 priority 15
switch 2 priority 14
switch 3 priority 13

! 3. 重新编号交换机
switch 2 renumber 3

! 4. 配置堆叠带宽
! (硬件配置，通过堆叠线缆)

! 5. 验证
show switch stack-ports
show switch stack-ring speed
```

### VSS配置 (Cisco Virtual Switching System)

```cisco
! ========================================
! VSS配置 (需要6500/4500系列)
! ========================================

! Switch 1配置
switch virtual domain 100
 switch 1
 exit

interface Port-channel10
 switch virtual link 1
 no shutdown

interface range TenGigabitEthernet1/1-2
 channel-group 10 mode on
 no shutdown

switch convert mode virtual

! Switch 2配置 (类似)
switch virtual domain 100
 switch 2
 exit

! 验证
show switch virtual
show switch virtual link
```

### VSF配置 (HPE Aruba)

```bash
# ========================================
# HPE Aruba VSF配置
# ========================================

# 配置VSF链路
vsf member 1
   link 1 1/49
   link 2 1/50
   priority 255
   exit

vsf member 2
   link 1 2/49
   link 2 2/50
   priority 254
   exit

# 启用VSF
vsf enable domain 1

# 验证
show vsf
show vsf link
```

### CSS配置 (华为)

```huawei
# ========================================
# 华为CSS (Cluster Switch System) 配置
# ========================================

# 配置CSS ID
css-mode enable
css css-id 1

# 配置CSS优先级
css priority 200

# 配置CSS链路
interface Stack-Port 1/1
 port interface XGigabitEthernet 1/0/49 enable
 port interface XGigabitEthernet 1/0/50 enable

# 验证
display css configuration
display css topology
```

---

## 性能优化

### Jumbo Frame配置

```cisco
! ========================================
! Jumbo Frame (巨型帧) 配置
! ========================================

! 1. 全局配置MTU (Cisco)
system mtu 9000
system mtu jumbo 9000

! 2. 接口级MTU (L3接口)
interface GigabitEthernet1/0/1
 mtu 9000

! 3. 验证
show system mtu
show interfaces GigabitEthernet1/0/1 | include MTU

! 注意：需要重启交换机生效
reload
```

```bash
# HPE Aruba
interface 1/1
   mtu 9198
   exit

# 华为
system-view
jumboframe enable 9000
interface GigabitEthernet1/0/1
 jumboframe enable 9000
```

### 流量监控 (NetFlow/sFlow)

```cisco
! ========================================
! NetFlow配置
! ========================================

! 1. 配置NetFlow导出器
flow exporter NETFLOW-EXPORT
 destination 192.168.10.100
 source Vlan10
 transport udp 9995
 export-protocol netflow-v9

! 2. 配置Flow Monitor
flow monitor NETFLOW-MONITOR
 exporter NETFLOW-EXPORT
 record netflow ipv4 original-input
 cache timeout active 60

! 3. 应用到接口
interface GigabitEthernet1/0/48
 ip flow monitor NETFLOW-MONITOR input
 ip flow monitor NETFLOW-MONITOR output

! 4. 验证
show flow monitor NETFLOW-MONITOR cache
show flow exporter NETFLOW-EXPORT statistics
```

```cisco
! ========================================
! sFlow配置 (HPE/Aruba)
! ========================================

sflow 1 destination 192.168.10.100
sflow 1 sampling 512
sflow 1 polling 20

interface 1/48
   sflow 1
   exit

show sflow 1
```

### 端口镜像 (SPAN)

```cisco
! ========================================
! SPAN (Switched Port Analyzer) 配置
! ========================================

! 1. 本地SPAN
monitor session 1 source interface GigabitEthernet1/0/1 both
monitor session 1 destination interface GigabitEthernet1/0/48

! 2. 多源端口
monitor session 2 source interface range GigabitEthernet1/0/1-10 rx
monitor session 2 destination interface GigabitEthernet1/0/48

! 3. VLAN SPAN
monitor session 3 source vlan 10 both
monitor session 3 destination interface GigabitEthernet1/0/48

! 4. RSPAN (远程SPAN)
vlan 900
 name RSPAN-VLAN
 remote-span

monitor session 4 source interface GigabitEthernet1/0/1
monitor session 4 destination remote vlan 900

! 在目标交换机
monitor session 5 source remote vlan 900
monitor session 5 destination interface GigabitEthernet1/0/48

! 5. ERSPAN (封装远程SPAN)
monitor session 6 type erspan-source
 source interface GigabitEthernet1/0/1
 destination
  erspan-id 6
  ip address 192.168.20.100
  origin ip address 192.168.10.10

! 6. 验证
show monitor session 1
show monitor session all
```

### CPU保护

```cisco
! ========================================
! CoPP (Control Plane Policing) 配置
! ========================================

! 1. 分类控制平面流量
class-map match-any ROUTING-PROTOCOLS
 match access-group name ROUTING-ACL
class-map match-any MANAGEMENT
 match access-group name MGMT-ACL

ip access-list extended ROUTING-ACL
 permit ospf any any
 permit tcp any any eq bgp
 permit tcp any eq bgp any

ip access-list extended MGMT-ACL
 permit tcp any any eq 22
 permit udp any any eq snmp

! 2. 配置策略
policy-map COPP-POLICY
 class ROUTING-PROTOCOLS
  police 8000000 conform-action transmit exceed-action drop
 class MANAGEMENT
  police 1000000 conform-action transmit exceed-action drop
 class class-default
  police 500000 conform-action transmit exceed-action drop

! 3. 应用到控制平面
control-plane
 service-policy input COPP-POLICY

! 4. 验证
show policy-map control-plane
```

---

## 监控与管理

### SNMP配置详解

```cisco
! ========================================
! 完整SNMP配置
! ========================================

! 1. SNMPv2c配置
snmp-server community public RO
snmp-server community private RW
snmp-server location "DC1-Rack-A-U10"
snmp-server contact "admin@example.com"
snmp-server chassis-id "Core-SW1"

! 2. SNMP Trap配置
snmp-server enable traps
snmp-server enable traps snmp authentication linkdown linkup coldstart warmstart
snmp-server enable traps port-security
snmp-server enable traps config
snmp-server enable traps hsrp
snmp-server enable traps vtp
snmp-server enable traps vlancreate
snmp-server enable traps vlandelete
snmp-server enable traps envmon fan shutdown supply temperature status
snmp-server enable traps cpu threshold
snmp-server enable traps memory bufferpeak

! 3. 配置Trap接收者
snmp-server host 192.168.10.100 version 2c public
snmp-server host 192.168.10.101 version 2c public

! 4. SNMPv3配置 (推荐)
snmp-server group ADMIN-GROUP v3 priv
snmp-server user admin ADMIN-GROUP v3 auth sha AuthPass@2025 priv aes 128 PrivPass@2025
snmp-server host 192.168.10.100 version 3 priv admin

! 5. 访问控制
snmp-server view ALL-VIEW internet included
snmp-server group READONLY v2c access ALL-VIEW

! 6. 验证
show snmp
show snmp community
show snmp user
show snmp group
```

### 日志配置

```cisco
! ========================================
! 日志配置
! ========================================

! 1. 日志缓冲区
logging buffered 51200 informational

! 2. Console日志
logging console warnings

! 3. Syslog服务器
logging host 192.168.10.100
logging trap informational
logging source-interface Vlan10

! 4. 时间戳
service timestamps log datetime msec localtime show-timezone
service timestamps debug datetime msec

! 5. 序列号
service sequence-numbers

! 6. 日志级别
! emergencies (0)
! alerts (1)
! critical (2)
! errors (3)
! warnings (4)
! notifications (5)
! informational (6)
! debugging (7)

! 7. 查看日志
show logging
show logging | include ERROR
```

### 配置备份

```bash
#!/bin/bash
# ========================================
# 交换机配置备份脚本
# ========================================

BACKUP_DIR="/backup/switches"
DATE=$(date +%Y%m%d_%H%M%S)
SWITCHES=(
    "192.168.10.10:Core-SW1"
    "192.168.10.11:Core-SW2"
    "192.168.10.20:Dist-SW1"
)

mkdir -p "$BACKUP_DIR/$DATE"

for SWITCH in "${SWITCHES[@]}"; do
    IP="${SWITCH%%:*}"
    NAME="${SWITCH##*:}"
    
    echo "备份交换机: $NAME ($IP)"
    
    # Cisco (SSH)
    sshpass -p 'password' ssh admin@$IP "show running-config" \
        > "$BACKUP_DIR/$DATE/${NAME}_running-config.txt"
    
    sshpass -p 'password' ssh admin@$IP "show startup-config" \
        > "$BACKUP_DIR/$DATE/${NAME}_startup-config.txt"
    
    # 或使用TFTP
    # sshpass -p 'password' ssh admin@$IP "copy running-config tftp://192.168.10.100/${NAME}_config"
done

# 压缩备份
cd "$BACKUP_DIR"
tar czf "switch-backup-${DATE}.tar.gz" "$DATE"
rm -rf "$DATE"

# 清理30天前的备份
find "$BACKUP_DIR" -name "switch-backup-*.tar.gz" -mtime +30 -delete

echo "备份完成: $BACKUP_DIR/switch-backup-${DATE}.tar.gz"
```

---

## 故障排查

```yaml
常见问题与诊断:
  问题1: 端口Down
    排查步骤:
      1. show interface GigabitEthernet1/0/1
      2. show interface status
      3. show logging | include GigabitEthernet1/0/1
      4. show controllers
    
    可能原因:
      - 物理连接问题
      - 端口shutdown
      - err-disabled
      - SFP模块故障
    
    解决:
      interface GigabitEthernet1/0/1
       shutdown
       no shutdown
      
      ! 清除err-disabled
      clear errdisable interface GigabitEthernet1/0/1
  
  问题2: VLAN不通
    排查步骤:
      1. show vlan brief
      2. show interfaces switchport
      3. show interfaces trunk
      4. show spanning-tree vlan 10
    
    可能原因:
      - VLAN未创建
      - Trunk未允许VLAN
      - Native VLAN不匹配
      - 生成树阻塞
    
    解决:
      vlan 10
      
      interface GigabitEthernet1/0/48
       switchport trunk allowed vlan add 10
  
  问题3: LACP不协商
    排查步骤:
      1. show etherchannel summary
      2. show lacp neighbor
      3. show lacp internal
      4. show logging | include LACP
    
    可能原因:
      - 模式不匹配
      - VLAN配置不同
      - STP配置冲突
    
    解决:
      interface range GigabitEthernet1/0/47-48
       no channel-group 1
       channel-group 1 mode active
  
  问题4: 生成树环路
    排查步骤:
      1. show spanning-tree
      2. show spanning-tree blockedports
      3. show spanning-tree inconsistentports
      4. show logging | include LOOP
    
    可能原因:
      - PortFast误用
      - BPDU Guard触发
      - 多个根桥
    
    解决:
      spanning-tree vlan 10 priority 4096
      
      interface GigabitEthernet1/0/1
       spanning-tree portfast
       spanning-tree bpduguard enable
  
  问题5: 性能下降
    排查步骤:
      1. show processes cpu sorted
      2. show processes memory sorted
      3. show interfaces counters errors
      4. show controllers utilization
    
    可能原因:
      - CPU过载
      - 内存不足
      - 错误包过多
      - 广播风暴
    
    解决:
      ! 查找高流量接口
      show interfaces counters rate
      
      ! 限制广播
      interface GigabitEthernet1/0/1
       storm-control broadcast level 10
       storm-control multicast level 10

诊断命令:
  基础命令:
    show version
    show running-config
    show startup-config
    show interfaces
    show interfaces status
    show interfaces counters
    show ip interface brief
    show vlan brief
    show spanning-tree
    show etherchannel summary
    show cdp neighbors detail
    show lldp neighbors detail
  
  高级命令:
    show tech-support
    show diagnostic result
    show environment all
    show power inline
    show mac address-table
    show arp
    show ip route
    show processes cpu history
    show logging
  
  调试命令 (谨慎使用):
    debug spanning-tree events
    debug lacp event
    debug etherchannel
    
    ! 关闭调试
    undebug all
```

---

## 相关文档

- [网络拓扑与VLAN规划](01_网络拓扑与VLAN规划.md)
- [负载均衡与高可用](03_负载均衡与高可用.md)
- [网络安全策略](04_网络安全策略.md)
- [网络监控与故障排查](05_网络监控与故障排查.md)

---

**更新时间**: 2025-10-19  
**文档版本**: v3.0  
**状态**: ✅ 生产就绪
