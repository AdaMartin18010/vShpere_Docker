# å­˜å‚¨å®¹ç¾ä¸å¤‡ä»½æ–¹æ¡ˆ

> **è¿”å›**: [å­˜å‚¨æ¶æ„ç›®å½•](README.md) | [è™šæ‹ŸåŒ–éƒ¨ç½²é¦–é¡µ](../README.md) | [éƒ¨ç½²æŒ‡å—é¦–é¡µ](../../00_ç´¢å¼•å¯¼èˆª/README.md)

---

## ğŸ“‹ ç›®å½•

- [å­˜å‚¨å®¹ç¾ä¸å¤‡ä»½æ–¹æ¡ˆ](#å­˜å‚¨å®¹ç¾ä¸å¤‡ä»½æ–¹æ¡ˆ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [å®¹ç¾å¤‡ä»½æ¦‚è¿°](#å®¹ç¾å¤‡ä»½æ¦‚è¿°)
  - [å¤‡ä»½ç­–ç•¥ä¸æ–¹æ¡ˆ](#å¤‡ä»½ç­–ç•¥ä¸æ–¹æ¡ˆ)
  - [è™šæ‹Ÿæœºå¤‡ä»½](#è™šæ‹Ÿæœºå¤‡ä»½)
  - [å®¹å™¨å¤‡ä»½](#å®¹å™¨å¤‡ä»½)
  - [æ•°æ®åº“å¤‡ä»½](#æ•°æ®åº“å¤‡ä»½)
  - [å­˜å‚¨çº§å¤‡ä»½](#å­˜å‚¨çº§å¤‡ä»½)
  - [ç¾å¤‡æ¶æ„](#ç¾å¤‡æ¶æ„)
  - [æ¢å¤æµ‹è¯•](#æ¢å¤æµ‹è¯•)
  - [å¤‡ä»½ç›‘æ§](#å¤‡ä»½ç›‘æ§)
  - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
  - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## å®¹ç¾å¤‡ä»½æ¦‚è¿°

```yaml
æ ¸å¿ƒæ¦‚å¿µ:
  RPO (Recovery Point Objective):
    å®šä¹‰: æ¢å¤ç‚¹ç›®æ ‡
    å«ä¹‰: æ•°æ®ä¸¢å¤±çš„æœ€å¤§å¯å®¹å¿æ—¶é—´
    ç¤ºä¾‹:
      RPO=0: å®æ—¶å¤åˆ¶ï¼Œæ— æ•°æ®ä¸¢å¤±
      RPO=4å°æ—¶: æœ€å¤šä¸¢å¤±4å°æ—¶æ•°æ®
      RPO=24å°æ—¶: æ¯æ—¥å¤‡ä»½
    
    ä¸šåŠ¡åˆ†ç±»:
      å…³é”®ä¸šåŠ¡: RPO <1å°æ—¶
      é‡è¦ä¸šåŠ¡: RPO 4-8å°æ—¶
      ä¸€èˆ¬ä¸šåŠ¡: RPO 24å°æ—¶
      å½’æ¡£æ•°æ®: RPO 7å¤©
  
  RTO (Recovery Time Objective):
    å®šä¹‰: æ¢å¤æ—¶é—´ç›®æ ‡
    å«ä¹‰: ç³»ç»Ÿæ¢å¤çš„æœ€å¤§å¯å®¹å¿æ—¶é—´
    ç¤ºä¾‹:
      RTO=0: é«˜å¯ç”¨ï¼Œæ— åœæœº
      RTO=1å°æ—¶: 1å°æ—¶å†…æ¢å¤
      RTO=24å°æ—¶: 1å¤©å†…æ¢å¤
    
    ä¸šåŠ¡åˆ†ç±»:
      å…³é”®ä¸šåŠ¡: RTO <1å°æ—¶
      é‡è¦ä¸šåŠ¡: RTO 4-8å°æ—¶
      ä¸€èˆ¬ä¸šåŠ¡: RTO 24å°æ—¶
      å½’æ¡£æ•°æ®: RTO 7å¤©
  
  å¤‡ä»½ç±»å‹:
    çƒ­å¤‡ä»½ (Hot Backup):
      ç‰¹ç‚¹: åœ¨çº¿å¤‡ä»½ï¼Œä¸åœæœº
      é€‚ç”¨: ç”Ÿäº§æ•°æ®åº“
      ç¤ºä¾‹: MySQLçƒ­å¤‡ä»½
    
    æ¸©å¤‡ä»½ (Warm Backup):
      ç‰¹ç‚¹: åªè¯»æ¨¡å¼å¤‡ä»½
      é€‚ç”¨: å¯çŸ­æš‚é”è¡¨
    
    å†·å¤‡ä»½ (Cold Backup):
      ç‰¹ç‚¹: åœæœºå¤‡ä»½
      é€‚ç”¨: ç»´æŠ¤çª—å£
      ç¤ºä¾‹: æ–‡ä»¶ç³»ç»Ÿæ‹·è´

å¤‡ä»½æ–¹æ¡ˆå¯¹æ¯”:
  å…¨é‡å¤‡ä»½ (Full Backup):
    æè¿°: å¤‡ä»½æ‰€æœ‰æ•°æ®
    ä¼˜ç‚¹:
      âœ… æ¢å¤é€Ÿåº¦å¿«
      âœ… æ¢å¤ç®€å•
    ç¼ºç‚¹:
      âŒ å¤‡ä»½æ—¶é—´é•¿
      âŒ å­˜å‚¨ç©ºé—´å¤§
      âŒ ç½‘ç»œå¸¦å®½æ¶ˆè€—å¤§
    
    é€‚ç”¨:
      - é¦–æ¬¡å¤‡ä»½
      - å‘¨æœŸæ€§åŸºå‡†å¤‡ä»½
      - å°æ•°æ®é‡ç¯å¢ƒ
    
    é¢‘ç‡: æ¯å‘¨/æ¯æœˆ
  
  å¢é‡å¤‡ä»½ (Incremental Backup):
    æè¿°: å¤‡ä»½è‡ªä¸Šæ¬¡å¤‡ä»½åçš„å˜åŒ–
    ä¼˜ç‚¹:
      âœ… å¤‡ä»½é€Ÿåº¦å¿«
      âœ… å­˜å‚¨ç©ºé—´å°
      âœ… ç½‘ç»œæ¶ˆè€—ä½
    ç¼ºç‚¹:
      âŒ æ¢å¤é€Ÿåº¦æ…¢ (éœ€è¦å®Œæ•´é“¾)
      âŒ æ¢å¤å¤æ‚
    
    é€‚ç”¨:
      - é¢‘ç¹å¤‡ä»½
      - å¤§æ•°æ®é‡ç¯å¢ƒ
      - å¸¦å®½å—é™ç¯å¢ƒ
    
    é¢‘ç‡: æ¯å¤©/æ¯å°æ—¶
  
  å·®å¼‚å¤‡ä»½ (Differential Backup):
    æè¿°: å¤‡ä»½è‡ªä¸Šæ¬¡å…¨é‡å¤‡ä»½åçš„å˜åŒ–
    ä¼˜ç‚¹:
      âœ… æ¢å¤è¾ƒå¿« (å…¨é‡+å·®å¼‚)
      âœ… æŠ˜ä¸­æ–¹æ¡ˆ
    ç¼ºç‚¹:
      âš ï¸ å¤‡ä»½é‡é€æ¸å¢å¤§
    
    é€‚ç”¨:
      - æŠ˜ä¸­éœ€æ±‚
      - ä¸­ç­‰æ•°æ®é‡
    
    é¢‘ç‡: æ¯å¤©
  
  æŒç»­æ•°æ®ä¿æŠ¤ (CDP):
    æè¿°: å®æ—¶æ•°æ®å¤åˆ¶
    ä¼˜ç‚¹:
      âœ… RPOæ¥è¿‘0
      âœ… ä»»æ„æ—¶é—´ç‚¹æ¢å¤
    ç¼ºç‚¹:
      âŒ æˆæœ¬é«˜
      âŒ å¤æ‚åº¦é«˜
    
    é€‚ç”¨:
      - å…³é”®ä¸šåŠ¡
      - é‡‘èäº¤æ˜“
      - åŒ»ç–—ç³»ç»Ÿ

å¤‡ä»½ç­–ç•¥:
  3-2-1è§„åˆ™:
    3: ä¿ç•™3ä»½æ•°æ®å‰¯æœ¬
    2: ä½¿ç”¨2ç§ä¸åŒå­˜å‚¨ä»‹è´¨
    1: 1ä»½å¼‚åœ°å­˜å‚¨
    
    ç¤ºä¾‹:
      - ç”Ÿäº§æ•°æ® (1ä»½)
      - æœ¬åœ°å¤‡ä»½ç£ç›˜ (ç¬¬2ä»½)
      - å¼‚åœ°å¤‡ä»½ç£ç›˜ (ç¬¬3ä»½, ä¸åŒä»‹è´¨)
  
  GFSç­–ç•¥ (Grandfather-Father-Son):
    æ¯æ—¥å¤‡ä»½ (Son): ä¿ç•™7å¤©
    æ¯å‘¨å¤‡ä»½ (Father): ä¿ç•™4å‘¨
    æ¯æœˆå¤‡ä»½ (Grandfather): ä¿ç•™12ä¸ªæœˆ
    
    ä¼˜ç‚¹:
      âœ… å¹³è¡¡å­˜å‚¨ç©ºé—´
      âœ… é•¿æœŸæ•°æ®ä¿ç•™
      âœ… çµæ´»æ¢å¤é€‰é¡¹
  
  Tower of Hanoiç­–ç•¥:
    å¤æ‚çš„è½®è½¬ç­–ç•¥
    é€‚ç”¨: ç£å¸¦å¤‡ä»½
```

---

## å¤‡ä»½ç­–ç•¥ä¸æ–¹æ¡ˆ

```bash
#!/bin/bash
# ä¼ä¸šçº§å¤‡ä»½ç­–ç•¥å®ç°è„šæœ¬

set -e

BACKUP_ROOT="/backup"
DATE=$(date +%Y%m%d_%H%M%S)
DAY_OF_WEEK=$(date +%u)  # 1-7 (Monday-Sunday)
DAY_OF_MONTH=$(date +%d)
LOG_FILE="/var/log/backup_${DATE}.log"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# å¤‡ä»½ä¿ç•™ç­–ç•¥
DAILY_RETENTION=7      # ä¿ç•™7å¤©æ—¥å¤‡ä»½
WEEKLY_RETENTION=4     # ä¿ç•™4å‘¨å‘¨å¤‡ä»½
MONTHLY_RETENTION=12   # ä¿ç•™12ä¸ªæœˆæœˆå¤‡ä»½

log "========================================="
log "  å¤‡ä»½ä»»åŠ¡å¼€å§‹"
log "========================================="

# 1. ç¡®å®šå¤‡ä»½ç±»å‹
if [ "$DAY_OF_MONTH" -eq 1 ]; then
    BACKUP_TYPE="monthly"
    BACKUP_DIR="$BACKUP_ROOT/monthly/$DATE"
    log "æ‰§è¡Œï¼šæœˆåº¦å…¨é‡å¤‡ä»½"
elif [ "$DAY_OF_WEEK" -eq 7 ]; then
    BACKUP_TYPE="weekly"
    BACKUP_DIR="$BACKUP_ROOT/weekly/$DATE"
    log "æ‰§è¡Œï¼šå‘¨åº¦å…¨é‡å¤‡ä»½"
else
    BACKUP_TYPE="daily"
    BACKUP_DIR="$BACKUP_ROOT/daily/$DATE"
    log "æ‰§è¡Œï¼šæ—¥åº¦å¢é‡å¤‡ä»½"
fi

mkdir -p "$BACKUP_DIR"

# 2. æ•°æ®åº“å¤‡ä»½
log "--- æ•°æ®åº“å¤‡ä»½ ---"

# MySQLå¤‡ä»½
if command -v mysqldump &> /dev/null; then
    log "å¤‡ä»½MySQLæ•°æ®åº“..."
    MYSQL_BACKUP_DIR="$BACKUP_DIR/mysql"
    mkdir -p "$MYSQL_BACKUP_DIR"
    
    # è·å–æ‰€æœ‰æ•°æ®åº“
    DATABASES=$(mysql -e "SHOW DATABASES;" | grep -Ev "^(Database|information_schema|performance_schema|mysql|sys)$")
    
    for DB in $DATABASES; do
        log "  å¤‡ä»½æ•°æ®åº“: $DB"
        mysqldump --single-transaction --routines --triggers --events \
            --add-drop-database --databases "$DB" \
            | gzip > "$MYSQL_BACKUP_DIR/${DB}.sql.gz"
    done
fi

# PostgreSQLå¤‡ä»½
if command -v pg_dumpall &> /dev/null; then
    log "å¤‡ä»½PostgreSQLæ•°æ®åº“..."
    PGSQL_BACKUP_DIR="$BACKUP_DIR/postgresql"
    mkdir -p "$PGSQL_BACKUP_DIR"
    
    sudo -u postgres pg_dumpall | gzip > "$PGSQL_BACKUP_DIR/all_databases.sql.gz"
fi

# MongoDBå¤‡ä»½
if command -v mongodump &> /dev/null; then
    log "å¤‡ä»½MongoDBæ•°æ®åº“..."
    MONGO_BACKUP_DIR="$BACKUP_DIR/mongodb"
    mkdir -p "$MONGO_BACKUP_DIR"
    
    mongodump --out "$MONGO_BACKUP_DIR" --gzip
fi

# 3. é…ç½®æ–‡ä»¶å¤‡ä»½
log "--- é…ç½®æ–‡ä»¶å¤‡ä»½ ---"
CONFIG_BACKUP_DIR="$BACKUP_DIR/configs"
mkdir -p "$CONFIG_BACKUP_DIR"

CONFIGS=(
    "/etc"
    "/root/.ssh"
    "/home/*/.ssh"
    "/var/www/html/config"
)

for CONFIG in "${CONFIGS[@]}"; do
    if [ -e "$CONFIG" ]; then
        log "  å¤‡ä»½: $CONFIG"
        tar czf "$CONFIG_BACKUP_DIR/$(basename $CONFIG)_${DATE}.tar.gz" "$CONFIG" 2>/dev/null || true
    fi
done

# 4. è™šæ‹Ÿæœºå¤‡ä»½ (å¦‚æœæœ‰)
if command -v virsh &> /dev/null; then
    log "--- è™šæ‹Ÿæœºå¤‡ä»½ ---"
    VM_BACKUP_DIR="$BACKUP_DIR/vms"
    mkdir -p "$VM_BACKUP_DIR"
    
    # è·å–è¿è¡Œä¸­çš„è™šæ‹Ÿæœº
    VMS=$(virsh list --name)
    
    for VM in $VMS; do
        if [ -n "$VM" ]; then
            log "  å¤‡ä»½è™šæ‹Ÿæœº: $VM"
            virsh dumpxml "$VM" > "$VM_BACKUP_DIR/${VM}.xml"
            
            # åˆ›å»ºå¿«ç…§ï¼ˆå¦‚æœæ˜¯å…¨é‡å¤‡ä»½ï¼‰
            if [ "$BACKUP_TYPE" != "daily" ]; then
                virsh snapshot-create-as "$VM" "${VM}_backup_${DATE}" \
                    "Backup snapshot created on ${DATE}"
            fi
        fi
    done
fi

# 5. Dockerå®¹å™¨å¤‡ä»½
if command -v docker &> /dev/null; then
    log "--- Dockerå®¹å™¨å¤‡ä»½ ---"
    DOCKER_BACKUP_DIR="$BACKUP_DIR/docker"
    mkdir -p "$DOCKER_BACKUP_DIR"
    
    # å¤‡ä»½æ‰€æœ‰å®¹å™¨é…ç½®
    docker ps -a --format '{{.Names}}' | while read CONTAINER; do
        log "  å¯¼å‡ºå®¹å™¨: $CONTAINER"
        docker inspect "$CONTAINER" > "$DOCKER_BACKUP_DIR/${CONTAINER}_config.json"
    done
    
    # å¤‡ä»½Dockerå·
    docker volume ls -q | while read VOLUME; do
        log "  å¤‡ä»½å·: $VOLUME"
        docker run --rm -v "$VOLUME:/data" -v "$DOCKER_BACKUP_DIR:/backup" \
            alpine tar czf "/backup/${VOLUME}.tar.gz" -C /data .
    done
fi

# 6. åº”ç”¨æ•°æ®å¤‡ä»½
log "--- åº”ç”¨æ•°æ®å¤‡ä»½ ---"
DATA_BACKUP_DIR="$BACKUP_DIR/data"
mkdir -p "$DATA_BACKUP_DIR"

# æ ¹æ®å¤‡ä»½ç±»å‹é€‰æ‹©å¤‡ä»½æ–¹æ³•
if [ "$BACKUP_TYPE" != "daily" ]; then
    # å…¨é‡å¤‡ä»½
    log "  æ‰§è¡Œå…¨é‡å¤‡ä»½..."
    tar czf "$DATA_BACKUP_DIR/app_data_full_${DATE}.tar.gz" /var/www /opt/apps 2>/dev/null || true
else
    # å¢é‡å¤‡ä»½
    log "  æ‰§è¡Œå¢é‡å¤‡ä»½..."
    LAST_FULL=$(ls -t $BACKUP_ROOT/weekly/*/data/app_data_full_*.tar.gz 2>/dev/null | head -1)
    if [ -n "$LAST_FULL" ]; then
        find /var/www /opt/apps -newer "$LAST_FULL" -type f \
            | tar czf "$DATA_BACKUP_DIR/app_data_incr_${DATE}.tar.gz" -T - 2>/dev/null || true
    fi
fi

# 7. åˆ›å»ºå¤‡ä»½æ¸…å•
log "--- åˆ›å»ºå¤‡ä»½æ¸…å• ---"
cat > "$BACKUP_DIR/manifest.txt" <<EOF
å¤‡ä»½ä¿¡æ¯
========================================
å¤‡ä»½æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
å¤‡ä»½ç±»å‹: $BACKUP_TYPE
ä¸»æœºåç§°: $(hostname)
æ“ä½œç³»ç»Ÿ: $(uname -a)
å¤‡ä»½è·¯å¾„: $BACKUP_DIR

å¤‡ä»½å†…å®¹:
EOF

du -sh "$BACKUP_DIR"/* >> "$BACKUP_DIR/manifest.txt"

# 8. æ ¡éªŒå¤‡ä»½
log "--- æ ¡éªŒå¤‡ä»½ ---"
find "$BACKUP_DIR" -type f -name "*.tar.gz" -o -name "*.sql.gz" | while read FILE; do
    if gzip -t "$FILE" 2>/dev/null; then
        log "  æ ¡éªŒé€šè¿‡: $(basename $FILE)"
    else
        log "  æ ¡éªŒå¤±è´¥: $(basename $FILE)" >&2
    fi
done

# 9. æ¸…ç†è¿‡æœŸå¤‡ä»½
log "--- æ¸…ç†è¿‡æœŸå¤‡ä»½ ---"

# æ¸…ç†æ—¥å¤‡ä»½ (ä¿ç•™7å¤©)
find "$BACKUP_ROOT/daily" -maxdepth 1 -type d -mtime +$DAILY_RETENTION -exec rm -rf {} \; 2>/dev/null || true
log "  æ¸…ç†æ—¥å¤‡ä»½: ä¿ç•™ ${DAILY_RETENTION} å¤©"

# æ¸…ç†å‘¨å¤‡ä»½ (ä¿ç•™4å‘¨)
find "$BACKUP_ROOT/weekly" -maxdepth 1 -type d -mtime +$((WEEKLY_RETENTION * 7)) -exec rm -rf {} \; 2>/dev/null || true
log "  æ¸…ç†å‘¨å¤‡ä»½: ä¿ç•™ ${WEEKLY_RETENTION} å‘¨"

# æ¸…ç†æœˆå¤‡ä»½ (ä¿ç•™12ä¸ªæœˆ)
find "$BACKUP_ROOT/monthly" -maxdepth 1 -type d -mtime +$((MONTHLY_RETENTION * 30)) -exec rm -rf {} \; 2>/dev/null || true
log "  æ¸…ç†æœˆå¤‡ä»½: ä¿ç•™ ${MONTHLY_RETENTION} æœˆ"

# 10. å¼‚åœ°ä¼ è¾“ (å¯é€‰)
if [ -n "$REMOTE_BACKUP_HOST" ]; then
    log "--- å¼‚åœ°ä¼ è¾“ ---"
    log "ä¼ è¾“åˆ°è¿œç¨‹ä¸»æœº: $REMOTE_BACKUP_HOST"
    
    rsync -avz --progress "$BACKUP_DIR" \
        "$REMOTE_BACKUP_HOST:/backup/offsite/" || log "è­¦å‘Š: å¼‚åœ°ä¼ è¾“å¤±è´¥"
fi

# 11. å¤‡ä»½ç»Ÿè®¡
log "========================================="
log "  å¤‡ä»½ä»»åŠ¡å®Œæˆ"
log "========================================="
log "å¤‡ä»½ä½ç½®: $BACKUP_DIR"
log "å¤‡ä»½å¤§å°: $(du -sh $BACKUP_DIR | awk '{print $1}')"
log "ç£ç›˜ä½¿ç”¨: $(df -h $BACKUP_ROOT | tail -1 | awk '{print $5}')"
log "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"

# 12. å‘é€é€šçŸ¥ (å¯é€‰)
# sendmail -t <<EOF
# To: admin@example.com
# Subject: å¤‡ä»½ä»»åŠ¡å®Œæˆ - $(hostname) - $DATE
# 
# å¤‡ä»½ä»»åŠ¡å·²å®Œæˆ
# ç±»å‹: $BACKUP_TYPE
# å¤§å°: $(du -sh $BACKUP_DIR | awk '{print $1}')
# çŠ¶æ€: æˆåŠŸ
# EOF

exit 0
```

**å®šæ—¶ä»»åŠ¡é…ç½®**:

```bash
# /etc/cron.d/backup
# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå¤‡ä»½
0 2 * * * root /usr/local/bin/backup.sh >> /var/log/backup_cron.log 2>&1
```

---

## è™šæ‹Ÿæœºå¤‡ä»½

```yaml
VMware vSphereå¤‡ä»½:
  æ–¹æ³•1: vSphere Data Protection (VDP)
    ç®€ä»‹: VMwareå®˜æ–¹å¤‡ä»½æ–¹æ¡ˆ
    åŠŸèƒ½:
      âœ… æ˜ åƒçº§å¤‡ä»½
      âœ… é‡å¤æ•°æ®åˆ é™¤
      âœ… å¢é‡å¤‡ä»½
      âœ… æ–‡ä»¶çº§æ¢å¤
    
    é…ç½®æ­¥éª¤:
      1. éƒ¨ç½²VDPè™šæ‹Ÿè®¾å¤‡
      2. é…ç½®å¤‡ä»½ç›®æ ‡
      3. åˆ›å»ºå¤‡ä»½ä»»åŠ¡
      4. è®¾ç½®ä¿ç•™ç­–ç•¥
  
  æ–¹æ³•2: Veeam Backup & Replication
    ç®€ä»‹: ä¸šç•Œé¢†å…ˆå¤‡ä»½æ–¹æ¡ˆ
    ç‰ˆæœ¬: Community Edition (å…è´¹) / Standard / Enterprise
    
    åŠŸèƒ½:
      âœ… å¢é‡å¤‡ä»½ (CBT)
      âœ… å³æ—¶VMæ¢å¤
      âœ… æ–‡ä»¶çº§æ¢å¤
      âœ… åº”ç”¨æ„ŸçŸ¥å¤‡ä»½
      âœ… å¤‡ä»½å¤åˆ¶
      âœ… SureBackupéªŒè¯
    
    é…ç½®ç¤ºä¾‹:
      1. å®‰è£…VeeamæœåŠ¡å™¨
      2. æ·»åŠ vCenter
      3. åˆ›å»ºå¤‡ä»½ä»»åŠ¡
         åç§°: Daily_VM_Backup
         å¯¹è±¡: ç”Ÿäº§VM
         ç›®æ ‡: å¤‡ä»½ä»“åº“
         è®¡åˆ’: æ¯å¤©22:00
         ä¿ç•™: 14ä¸ªè¿˜åŸç‚¹
      4. å¯ç”¨åº”ç”¨æ„ŸçŸ¥å¤„ç† (æ•°æ®åº“)
  
  æ–¹æ³•3: VMwareå¿«ç…§
    æ³¨æ„: âš ï¸ å¿«ç…§ä¸æ˜¯å¤‡ä»½
    
    ç”¨é€”:
      - ä¸´æ—¶ä¿æŠ¤ç‚¹
      - å‡çº§å‰åˆ›å»º
      - çŸ­æœŸä¿ç•™ (<72å°æ—¶)
    
    å‘½ä»¤:
      # åˆ›å»ºå¿«ç…§
      vim-cmd vmsvc/snapshot.create <vmid> "Snapshot Name" "Description" 0 0
      
      # æ¢å¤å¿«ç…§
      vim-cmd vmsvc/snapshot.revert <vmid> <snapshot-id> 0
      
      # åˆ é™¤å¿«ç…§
      vim-cmd vmsvc/snapshot.remove <vmid> <snapshot-id>
    
    æœ€ä½³å®è·µ:
      âœ… å¿«ç…§ä¿ç•™æ—¶é—´ <72å°æ—¶
      âœ… å®šæœŸæ¸…ç†
      âœ… ç›‘æ§å¿«ç…§å¤§å°
      âŒ ä¸è¦åˆ›å»ºå¿«ç…§é“¾
      âŒ ä¸è¦ä¾èµ–å¿«ç…§ä½œä¸ºé•¿æœŸå¤‡ä»½
  
  æ–¹æ³•4: PowerCLIå¤‡ä»½è„šæœ¬
```

```powershell
# PowerCLI - è‡ªåŠ¨åŒ–VMå¤‡ä»½è„šæœ¬

# è¿æ¥vCenter
Connect-VIServer -Server vcenter.example.com -User administrator@vsphere.local -Password 'P@ssw0rd'

# é…ç½®
$BackupPath = "\\backup-server\vmware"
$VMs = Get-VM | Where-Object {$_.PowerState -eq "PoweredOn" -and $_.Name -like "prod-*"}

foreach ($VM in $VMs) {
    Write-Host "å¤‡ä»½è™šæ‹Ÿæœº: $($VM.Name)"
    
    # åˆ›å»ºå¿«ç…§
    $Snapshot = New-Snapshot -VM $VM -Name "Backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')" `
        -Description "Automated backup snapshot"
    
    # å¯¼å‡ºOVF
    $ExportPath = Join-Path $BackupPath "$($VM.Name)_$(Get-Date -Format 'yyyyMMdd')"
    Export-VApp -VM $VM -Destination $ExportPath -Format Ovf
    
    # åˆ é™¤å¿«ç…§
    Remove-Snapshot -Snapshot $Snapshot -Confirm:$false
    
    Write-Host "å®Œæˆ: $($VM.Name)"
}

Disconnect-VIServer -Confirm:$false
```

```yaml
KVMè™šæ‹Ÿæœºå¤‡ä»½:
  æ–¹æ³•1: virt-backup (è„šæœ¬)
```

```bash
#!/bin/bash
# KVMè™šæ‹Ÿæœºå¤‡ä»½è„šæœ¬

BACKUP_DIR="/backup/kvm"
DATE=$(date +%Y%m%d_%H%M%S)

# è·å–æ‰€æœ‰è¿è¡Œçš„è™šæ‹Ÿæœº
VMS=$(virsh list --name)

for VM in $VMS; do
    if [ -z "$VM" ]; then
        continue
    fi
    
    echo "å¤‡ä»½è™šæ‹Ÿæœº: $VM"
    VM_BACKUP_DIR="$BACKUP_DIR/$VM/$DATE"
    mkdir -p "$VM_BACKUP_DIR"
    
    # 1. å¯¼å‡ºXMLé…ç½®
    virsh dumpxml "$VM" > "$VM_BACKUP_DIR/${VM}.xml"
    
    # 2. åˆ›å»ºå¿«ç…§
    SNAPSHOT_NAME="${VM}_backup_${DATE}"
    virsh snapshot-create-as "$VM" "$SNAPSHOT_NAME" \
        "Backup snapshot" --disk-only --atomic
    
    # 3. å¤‡ä»½ç£ç›˜é•œåƒ
    DISKS=$(virsh domblklist "$VM" --details | grep disk | awk '{print $4}')
    for DISK in $DISKS; do
        DISK_NAME=$(basename "$DISK")
        echo "  å¤‡ä»½ç£ç›˜: $DISK_NAME"
        cp "$DISK" "$VM_BACKUP_DIR/$DISK_NAME"
    done
    
    # 4. åˆå¹¶å¿«ç…§
    SNAPSHOTS=$(virsh snapshot-list "$VM" --name)
    for SNAPSHOT in $SNAPSHOTS; do
        virsh blockcommit "$VM" vda --active --pivot
    done
    
    # 5. åˆ é™¤å¿«ç…§
    virsh snapshot-delete "$VM" "$SNAPSHOT_NAME" --metadata
    
    # 6. å‹ç¼©å¤‡ä»½
    cd "$BACKUP_DIR/$VM"
    tar czf "${VM}_${DATE}.tar.gz" "$DATE"
    rm -rf "$DATE"
    
    echo "å®Œæˆ: $VM"
done

# æ¸…ç†7å¤©å‰çš„å¤‡ä»½
find "$BACKUP_DIR" -type f -name "*.tar.gz" -mtime +7 -delete

echo "æ‰€æœ‰è™šæ‹Ÿæœºå¤‡ä»½å®Œæˆ"
```

```yaml
  æ–¹æ³•2: virtnbdbackup (å¢é‡å¤‡ä»½)
    ç‰¹ç‚¹: æ”¯æŒå¢é‡å¤‡ä»½
    è¦æ±‚: libvirt 6.0+, qemu 4.2+
    
    å®‰è£…:
      pip3 install virtnbdbackup
    
    ä½¿ç”¨:
      # å…¨é‡å¤‡ä»½
      virtnbdbackup -d vm-name -l full -o /backup/vm-name
      
      # å¢é‡å¤‡ä»½
      virtnbdbackup -d vm-name -l inc -o /backup/vm-name
      
      # æ¢å¤
      virtnbdrestore -i /backup/vm-name -o /var/lib/libvirt/images/vm-name.qcow2
```

---

## å®¹å™¨å¤‡ä»½

```yaml
Dockerå®¹å™¨å¤‡ä»½:
  å®¹å™¨å¯¼å‡º:
    å¯¼å‡ºå®¹å™¨ä¸ºé•œåƒ:
      docker commit <container-id> my-backup:latest
      docker save -o my-backup.tar my-backup:latest
    
    æ¢å¤:
      docker load -i my-backup.tar
      docker run -d my-backup:latest
  
  å·å¤‡ä»½:
```

```bash
#!/bin/bash
# Dockerå·å¤‡ä»½è„šæœ¬

BACKUP_DIR="/backup/docker"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "$BACKUP_DIR"

# å¤‡ä»½æ‰€æœ‰Dockerå·
docker volume ls -q | while read VOLUME; do
    echo "å¤‡ä»½å·: $VOLUME"
    
    docker run --rm \
        -v "$VOLUME:/data:ro" \
        -v "$BACKUP_DIR:/backup" \
        alpine \
        tar czf "/backup/${VOLUME}_${DATE}.tar.gz" -C /data .
done

# å¤‡ä»½Docker Composeé…ç½®
find /opt -name "docker-compose.yml" -exec cp {} "$BACKUP_DIR/" \;

echo "Dockerå¤‡ä»½å®Œæˆ"
```

```yaml
Kuberneteså¤‡ä»½:
  æ–¹æ³•1: Velero (æ¨è)
    ç®€ä»‹: Kuberneteså¤‡ä»½ä¸è¿ç§»å·¥å…·
    åŠŸèƒ½:
      âœ… é›†ç¾¤èµ„æºå¤‡ä»½
      âœ… PVå¿«ç…§
      âœ… å®šæ—¶å¤‡ä»½
      âœ… è·¨é›†ç¾¤è¿ç§»
    
    å®‰è£…:
```

```bash
# å®‰è£…Velero CLI
wget https://github.com/vmware-tanzu/velero/releases/download/v1.11.0/velero-v1.11.0-linux-amd64.tar.gz
tar -xvf velero-v1.11.0-linux-amd64.tar.gz
sudo mv velero-v1.11.0-linux-amd64/velero /usr/local/bin/

# å®‰è£…Veleroåˆ°Kubernetes
velero install \
    --provider aws \
    --plugins velero/velero-plugin-for-aws:v1.7.0 \
    --bucket velero-backups \
    --secret-file ./credentials-velero \
    --backup-location-config region=us-east-1 \
    --snapshot-location-config region=us-east-1
```

```yaml
    ä½¿ç”¨:
      # å¤‡ä»½æ•´ä¸ªå‘½åç©ºé—´
      velero backup create backup-prod --include-namespaces production
      
      # å¤‡ä»½ç‰¹å®šèµ„æº
      velero backup create backup-mysql --selector app=mysql
      
      # å®šæ—¶å¤‡ä»½
      velero schedule create daily-backup --schedule="0 2 * * *"
      
      # æ¢å¤
      velero restore create --from-backup backup-prod
      
      # æŸ¥çœ‹å¤‡ä»½
      velero backup get
      velero backup describe backup-prod
  
  æ–¹æ³•2: etcdå¤‡ä»½
    é‡è¦æ€§: âš ï¸ etcdå­˜å‚¨æ‰€æœ‰K8sçŠ¶æ€
```

```bash
#!/bin/bash
# etcdå¤‡ä»½è„šæœ¬

BACKUP_DIR="/backup/etcd"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "$BACKUP_DIR"

# å¤‡ä»½etcd
ETCDCTL_API=3 etcdctl snapshot save "$BACKUP_DIR/etcd-snapshot-${DATE}.db" \
    --endpoints=https://127.0.0.1:2379 \
    --cacert=/etc/kubernetes/pki/etcd/ca.crt \
    --cert=/etc/kubernetes/pki/etcd/server.crt \
    --key=/etc/kubernetes/pki/etcd/server.key

# éªŒè¯å¤‡ä»½
ETCDCTL_API=3 etcdctl snapshot status "$BACKUP_DIR/etcd-snapshot-${DATE}.db"

# ä¿ç•™7å¤©
find "$BACKUP_DIR" -name "etcd-snapshot-*.db" -mtime +7 -delete

echo "etcdå¤‡ä»½å®Œæˆ: $BACKUP_DIR/etcd-snapshot-${DATE}.db"
```

```yaml
    æ¢å¤:
      # åœæ­¢kube-apiserver
      mv /etc/kubernetes/manifests/kube-apiserver.yaml /tmp/
      
      # æ¢å¤etcd
      ETCDCTL_API=3 etcdctl snapshot restore etcd-snapshot.db \
          --data-dir=/var/lib/etcd-restored
      
      # æ›´æ–°etcdæ•°æ®ç›®å½•
      mv /var/lib/etcd /var/lib/etcd.bak
      mv /var/lib/etcd-restored /var/lib/etcd
      
      # å¯åŠ¨kube-apiserver
      mv /tmp/kube-apiserver.yaml /etc/kubernetes/manifests/
```

---

## æ•°æ®åº“å¤‡ä»½

```yaml
MySQL/MariaDBå¤‡ä»½:
  æ–¹æ³•1: mysqldump (é€»è¾‘å¤‡ä»½)
```

```bash
#!/bin/bash
# MySQLé€»è¾‘å¤‡ä»½è„šæœ¬

BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_USER="backup_user"
MYSQL_PASSWORD="backup_password"

mkdir -p "$BACKUP_DIR"

# å¤‡ä»½æ‰€æœ‰æ•°æ®åº“
mysqldump --all-databases \
    --user="$MYSQL_USER" \
    --password="$MYSQL_PASSWORD" \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    --add-drop-database \
    --master-data=2 \
    | gzip > "$BACKUP_DIR/all_databases_${DATE}.sql.gz"

# å•ç‹¬å¤‡ä»½å…³é”®æ•°æ®åº“
CRITICAL_DBS=("production_db" "user_db" "order_db")

for DB in "${CRITICAL_DBS[@]}"; do
    mysqldump --databases "$DB" \
        --user="$MYSQL_USER" \
        --password="$MYSQL_PASSWORD" \
        --single-transaction \
        --routines \
        --triggers \
        | gzip > "$BACKUP_DIR/${DB}_${DATE}.sql.gz"
done

# æ¸…ç†15å¤©å‰çš„å¤‡ä»½
find "$BACKUP_DIR" -name "*.sql.gz" -mtime +15 -delete

echo "MySQLå¤‡ä»½å®Œæˆ"
```

```yaml
  æ–¹æ³•2: XtraBackup (ç‰©ç†å¤‡ä»½)
    ä¼˜åŠ¿:
      âœ… çƒ­å¤‡ä»½ï¼Œä¸é”è¡¨
      âœ… æ”¯æŒå¢é‡å¤‡ä»½
      âœ… æ¢å¤é€Ÿåº¦å¿«
```

```bash
#!/bin/bash
# MySQLç‰©ç†å¤‡ä»½è„šæœ¬ (XtraBackup)

BACKUP_DIR="/backup/xtrabackup"
DATE=$(date +%Y%m%d_%H%M%S)
DAY_OF_WEEK=$(date +%u)

# å‘¨æ—¥å…¨é‡å¤‡ä»½ï¼Œå…¶ä»–å¢é‡å¤‡ä»½
if [ "$DAY_OF_WEEK" -eq 7 ]; then
    echo "æ‰§è¡Œå…¨é‡å¤‡ä»½..."
    FULL_BACKUP_DIR="$BACKUP_DIR/full/$DATE"
    
    xtrabackup --backup \
        --user=backup_user \
        --password=backup_password \
        --target-dir="$FULL_BACKUP_DIR"
    
    # è®°å½•å…¨é‡å¤‡ä»½è·¯å¾„
    echo "$FULL_BACKUP_DIR" > "$BACKUP_DIR/last_full_backup.txt"
else
    echo "æ‰§è¡Œå¢é‡å¤‡ä»½..."
    LAST_FULL=$(cat "$BACKUP_DIR/last_full_backup.txt")
    INCR_BACKUP_DIR="$BACKUP_DIR/incremental/$DATE"
    
    xtrabackup --backup \
        --user=backup_user \
        --password=backup_password \
        --target-dir="$INCR_BACKUP_DIR" \
        --incremental-basedir="$LAST_FULL"
fi

echo "XtraBackupå¤‡ä»½å®Œæˆ"
```

```yaml
    æ¢å¤:
      # å‡†å¤‡å…¨é‡å¤‡ä»½
      xtrabackup --prepare --apply-log-only --target-dir=/backup/full/20250119
      
      # åº”ç”¨å¢é‡å¤‡ä»½
      xtrabackup --prepare --apply-log-only \
          --target-dir=/backup/full/20250119 \
          --incremental-dir=/backup/incremental/20250120
      
      # æœ€åå‡†å¤‡
      xtrabackup --prepare --target-dir=/backup/full/20250119
      
      # åœæ­¢MySQL
      systemctl stop mysql
      
      # æ¢å¤æ•°æ®
      xtrabackup --copy-back --target-dir=/backup/full/20250119
      chown -R mysql:mysql /var/lib/mysql
      
      # å¯åŠ¨MySQL
      systemctl start mysql

PostgreSQLå¤‡ä»½:
  æ–¹æ³•1: pg_dump (é€»è¾‘å¤‡ä»½)
```

```bash
#!/bin/bash
# PostgreSQLé€»è¾‘å¤‡ä»½è„šæœ¬

BACKUP_DIR="/backup/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "$BACKUP_DIR"

# å¤‡ä»½æ‰€æœ‰æ•°æ®åº“
sudo -u postgres pg_dumpall | gzip > "$BACKUP_DIR/all_databases_${DATE}.sql.gz"

# å•ç‹¬å¤‡ä»½æ•°æ®åº“
DATABASES=$(sudo -u postgres psql -t -c "SELECT datname FROM pg_database WHERE datistemplate = false;")

for DB in $DATABASES; do
    if [ "$DB" != "postgres" ]; then
        sudo -u postgres pg_dump "$DB" -F c \
            -f "$BACKUP_DIR/${DB}_${DATE}.dump"
    fi
done

# æ¸…ç†15å¤©å‰çš„å¤‡ä»½
find "$BACKUP_DIR" -mtime +15 -delete

echo "PostgreSQLå¤‡ä»½å®Œæˆ"
```

```yaml
  æ–¹æ³•2: pg_basebackup (ç‰©ç†å¤‡ä»½)
```

```bash
# PostgreSQLç‰©ç†å¤‡ä»½
pg_basebackup -h localhost -U replication_user \
    -D /backup/postgresql/base_backup_$(date +%Y%m%d) \
    -F tar -z -P -v
```

```yaml
MongoDBå¤‡ä»½:
```

```bash
#!/bin/bash
# MongoDBå¤‡ä»½è„šæœ¬

BACKUP_DIR="/backup/mongodb"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "$BACKUP_DIR"

# mongodumpå¤‡ä»½
mongodump --host localhost --port 27017 \
    --username backup_user \
    --password backup_password \
    --authenticationDatabase admin \
    --out "$BACKUP_DIR/dump_${DATE}" \
    --gzip

# å‹ç¼©å¤‡ä»½
cd "$BACKUP_DIR"
tar czf "mongodb_${DATE}.tar.gz" "dump_${DATE}"
rm -rf "dump_${DATE}"

# æ¸…ç†30å¤©å‰çš„å¤‡ä»½
find "$BACKUP_DIR" -name "mongodb_*.tar.gz" -mtime +30 -delete

echo "MongoDBå¤‡ä»½å®Œæˆ"
```

---

## å­˜å‚¨çº§å¤‡ä»½

```yaml
å¿«ç…§æŠ€æœ¯:
  LVMå¿«ç…§:
    åˆ›å»º:
      # åˆ›å»º5GBå¿«ç…§å·
      lvcreate -L 5G -s -n data_snapshot /dev/vg0/data
    
    æŒ‚è½½:
      mount /dev/vg0/data_snapshot /mnt/snapshot
    
    å¤‡ä»½:
      tar czf /backup/data_$(date +%Y%m%d).tar.gz /mnt/snapshot
    
    åˆ é™¤:
      umount /mnt/snapshot
      lvremove /dev/vg0/data_snapshot
  
  Btrfså¿«ç…§:
    åˆ›å»º:
      btrfs subvolume snapshot /data /data/.snapshots/$(date +%Y%m%d)
    
    åˆ—è¡¨:
      btrfs subvolume list /data
    
    åˆ é™¤:
      btrfs subvolume delete /data/.snapshots/20250119
  
  ZFSå¿«ç…§:
    åˆ›å»º:
      zfs snapshot tank/data@$(date +%Y%m%d)
    
    åˆ—è¡¨:
      zfs list -t snapshot
    
    å›æ»š:
      zfs rollback tank/data@20250119
    
    å…‹éš†:
      zfs clone tank/data@20250119 tank/data_restored
    
    åˆ é™¤:
      zfs destroy tank/data@20250119

å­˜å‚¨å¤åˆ¶:
  vSANå¤åˆ¶:
    vSphere Replication:
      RPO: 15åˆ†é’Ÿ-24å°æ—¶
      é…ç½®:
        1. éƒ¨ç½²vSphere Replicationè®¾å¤‡
        2. é…å¯¹ç«™ç‚¹
        3. é…ç½®å¤åˆ¶
           è™šæ‹Ÿæœº â†’ é…ç½®å¤åˆ¶
           ç›®æ ‡: ç¾å¤‡ç«™ç‚¹
           RPO: 1å°æ—¶
           æ•°æ®å­˜å‚¨: DR-Datastore
  
  Ceph RBDé•œåƒ:
    é…ç½®:
      # åœ¨ä¸»ç«™ç‚¹
      rbd mirror pool enable rbd image
      rbd mirror image enable rbd/image01
      
      # åœ¨ç¾å¤‡ç«™ç‚¹
      rbd mirror pool peer add rbd <primary-cluster>
    
    ç›‘æ§:
      rbd mirror image status rbd/image01
```

---

## ç¾å¤‡æ¶æ„

```yaml
ç¾å¤‡çº§åˆ«:
  åŒåŸç¾å¤‡:
    è·ç¦»: <100km
    RPO: <30åˆ†é’Ÿ
    RTO: <4å°æ—¶
    æ–¹æ¡ˆ:
      - åŒæ­¥å¤åˆ¶
      - Metro Cluster
      - vSANå»¶ä¼¸é›†ç¾¤
  
  å¼‚åœ°ç¾å¤‡:
    è·ç¦»: >100km
    RPO: <4å°æ—¶
    RTO: <24å°æ—¶
    æ–¹æ¡ˆ:
      - å¼‚æ­¥å¤åˆ¶
      - å¤‡ä»½ä¼ è¾“
      - äº‘ç¾å¤‡

ç¾å¤‡æ¨¡å¼:
  ä¸»å¤‡æ¨¡å¼ (Active-Passive):
    æè¿°: ä¸»ç«™ç‚¹è¿è¡Œï¼Œå¤‡ç«™ç‚¹å¾…æœº
    ä¼˜ç‚¹:
      âœ… ç®€å•
      âœ… æˆæœ¬ä½
    ç¼ºç‚¹:
      âŒ èµ„æºæµªè´¹
      âŒ åˆ‡æ¢æ—¶é—´é•¿
    
    é€‚ç”¨: ä¸€èˆ¬ä¸šåŠ¡
  
  åŒæ´»æ¨¡å¼ (Active-Active):
    æè¿°: ä¸¤ç«™ç‚¹åŒæ—¶è¿è¡Œ
    ä¼˜ç‚¹:
      âœ… èµ„æºåˆ©ç”¨ç‡é«˜
      âœ… æ— ç¼åˆ‡æ¢
      âœ… è´Ÿè½½å‡è¡¡
    ç¼ºç‚¹:
      âŒ å¤æ‚åº¦é«˜
      âŒ æˆæœ¬é«˜
      âŒ æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜
    
    é€‚ç”¨: å…³é”®ä¸šåŠ¡
    
    æŠ€æœ¯æ–¹æ¡ˆ:
      - VMware vSANå»¶ä¼¸é›†ç¾¤
      - Oracle RAC
      - MySQL Group Replication
      - PostgreSQLé€»è¾‘å¤åˆ¶

VMware vSANå»¶ä¼¸é›†ç¾¤:
  æ¶æ„:
    ç«™ç‚¹A: 3+ ESXiä¸»æœº
    ç«™ç‚¹B: 3+ ESXiä¸»æœº
    è§è¯ç«™ç‚¹: è§è¯ä¸»æœº
  
  ç‰¹ç‚¹:
    âœ… è·¨ç«™ç‚¹æ•°æ®é•œåƒ
    âœ… è‡ªåŠ¨æ•…éšœåˆ‡æ¢
    âœ… RPOæ¥è¿‘0
    âœ… RTO <5åˆ†é’Ÿ
  
  è¦æ±‚:
    ç½‘ç»œå»¶è¿Ÿ: <5ms (ç«™ç‚¹A-B)
    å¸¦å®½: 10GbE+
    è§è¯: <200mså»¶è¿Ÿ

æ•°æ®åº“å¼‚åœ°ç¾å¤‡:
  MySQLä¸»ä»å¤åˆ¶:
```

```bash
# ä¸»åº“é…ç½®
[mysqld]
server-id=1
log-bin=mysql-bin
binlog-format=ROW
gtid-mode=ON
enforce-gtid-consistency=ON

# ä»åº“é…ç½®
[mysqld]
server-id=2
relay-log=mysql-relay-bin
gtid-mode=ON
enforce-gtid-consistency=ON
read_only=ON

# è®¾ç½®å¤åˆ¶
CHANGE MASTER TO
    MASTER_HOST='primary-db.example.com',
    MASTER_USER='replication_user',
    MASTER_PASSWORD='replication_password',
    MASTER_AUTO_POSITION=1;

START SLAVE;
SHOW SLAVE STATUS\G
```

```yaml
  PostgreSQLæµå¤åˆ¶:
    # primaryé…ç½® (postgresql.conf)
    wal_level = replica
    max_wal_senders = 10
    wal_keep_segments = 64
    
    # primaryé…ç½® (pg_hba.conf)
    host replication repl_user 192.168.1.0/24 md5
    
    # standbyé…ç½® (recovery.conf)
    standby_mode = 'on'
    primary_conninfo = 'host=primary-db port=5432 user=repl_user password=xxx'
    trigger_file = '/tmp/trigger_failover'
```

---

## æ¢å¤æµ‹è¯•

```yaml
æ¢å¤æ¼”ç»ƒé‡è¦æ€§:
  ä¸ºä»€ä¹ˆå¿…é¡»æ¼”ç»ƒ:
    âŒ å¤‡ä»½æœªæµ‹è¯• = æ²¡æœ‰å¤‡ä»½
    âŒ æ¢å¤ç¨‹åºæœªéªŒè¯ = æ— æ³•æ¢å¤
    âŒ RTO/RPOæœªå®æµ‹ = æŒ‡æ ‡è™šå‡
  
  æ¼”ç»ƒé¢‘ç‡:
    å…³é”®ç³»ç»Ÿ: æ¯å­£åº¦
    é‡è¦ç³»ç»Ÿ: æ¯åŠå¹´
    ä¸€èˆ¬ç³»ç»Ÿ: æ¯å¹´

æ¢å¤æµ‹è¯•è®¡åˆ’:
```

```bash
#!/bin/bash
# æ¢å¤æ¼”ç»ƒè„šæœ¬

DRILL_DATE=$(date +%Y%m%d_%H%M%S)
REPORT_FILE="/var/log/drill_report_${DRILL_DATE}.txt"

exec > >(tee -a "$REPORT_FILE")
exec 2>&1

echo "========================================="
echo "  ç¾å¤‡æ¢å¤æ¼”ç»ƒ"
echo "========================================="
echo "æ¼”ç»ƒæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

# 1. éªŒè¯å¤‡ä»½å®Œæ•´æ€§
echo "=== 1. å¤‡ä»½å®Œæ•´æ€§éªŒè¯ ==="
START_TIME=$(date +%s)

BACKUP_FILES=$(find /backup -type f -name "*.tar.gz" -o -name "*.sql.gz" -mtime -1)

for FILE in $BACKUP_FILES; do
    echo "æ£€æŸ¥: $(basename $FILE)"
    if gzip -t "$FILE" 2>/dev/null; then
        echo "  âœ“ å®Œæ•´æ€§æ­£å¸¸"
    else
        echo "  âœ— å®Œæ•´æ€§å¼‚å¸¸"
    fi
done

END_TIME=$(date +%s)
echo "è€—æ—¶: $((END_TIME - START_TIME)) ç§’"
echo ""

# 2. æ¢å¤æ•°æ®åº“åˆ°æµ‹è¯•ç¯å¢ƒ
echo "=== 2. æ•°æ®åº“æ¢å¤æµ‹è¯• ==="
START_TIME=$(date +%s)

LATEST_BACKUP=$(ls -t /backup/mysql/*.sql.gz | head -1)
echo "æ¢å¤å¤‡ä»½: $LATEST_BACKUP"

# åˆ›å»ºæµ‹è¯•æ•°æ®åº“
mysql -u root -p'password' -e "CREATE DATABASE IF NOT EXISTS drill_test;"

# æ¢å¤æ•°æ®
gunzip < "$LATEST_BACKUP" | mysql -u root -p'password' drill_test

# éªŒè¯æ•°æ®
RECORD_COUNT=$(mysql -u root -p'password' -N -e "SELECT COUNT(*) FROM drill_test.users;")
echo "éªŒè¯è®°å½•æ•°: $RECORD_COUNT"

# æ¸…ç†
mysql -u root -p'password' -e "DROP DATABASE drill_test;"

END_TIME=$(date +%s)
echo "æ¢å¤è€—æ—¶: $((END_TIME - START_TIME)) ç§’"
echo "RTOè¾¾æˆ: $(if [ $((END_TIME - START_TIME)) -lt 3600 ]; then echo "æ˜¯"; else echo "å¦"; fi)"
echo ""

# 3. æ¢å¤è™šæ‹Ÿæœºåˆ°æµ‹è¯•ç¯å¢ƒ
echo "=== 3. è™šæ‹Ÿæœºæ¢å¤æµ‹è¯• ==="
START_TIME=$(date +%s)

# é€‰æ‹©æœ€æ–°å¤‡ä»½
LATEST_VM_BACKUP=$(ls -t /backup/kvm/*.tar.gz | head -1)
echo "æ¢å¤è™šæ‹Ÿæœº: $LATEST_VM_BACKUP"

# è§£å‹åˆ°ä¸´æ—¶ç›®å½•
TEMP_DIR="/tmp/vm_drill_$$"
mkdir -p "$TEMP_DIR"
tar xzf "$LATEST_VM_BACKUP" -C "$TEMP_DIR"

# å¯¼å…¥è™šæ‹Ÿæœºé…ç½®
VM_XML=$(find "$TEMP_DIR" -name "*.xml" | head -1)
if [ -n "$VM_XML" ]; then
    # ä¿®æ”¹VMåç§°ä¸ºæµ‹è¯•ç‰ˆæœ¬
    sed -i 's/<name>.*<\/name>/<name>drill-test-vm<\/name>/' "$VM_XML"
    virsh define "$VM_XML"
    echo "  âœ“ è™šæ‹Ÿæœºå·²å¯¼å…¥"
else
    echo "  âœ— æœªæ‰¾åˆ°è™šæ‹Ÿæœºé…ç½®"
fi

# æ¸…ç†
rm -rf "$TEMP_DIR"
virsh undefine drill-test-vm

END_TIME=$(date +%s)
echo "æ¢å¤è€—æ—¶: $((END_TIME - START_TIME)) ç§’"
echo ""

# 4. åº”ç”¨é…ç½®æ¢å¤æµ‹è¯•
echo "=== 4. é…ç½®æ–‡ä»¶æ¢å¤æµ‹è¯• ==="
START_TIME=$(date +%s)

LATEST_CONFIG=$(ls -t /backup/configs/*.tar.gz | head -1)
echo "æ¢å¤é…ç½®: $LATEST_CONFIG"

TEMP_DIR="/tmp/config_drill_$$"
mkdir -p "$TEMP_DIR"
tar xzf "$LATEST_CONFIG" -C "$TEMP_DIR"

# éªŒè¯å…³é”®é…ç½®æ–‡ä»¶
CRITICAL_CONFIGS=(
    "sshd_config"
    "nginx.conf"
    "my.cnf"
)

for CONFIG in "${CRITICAL_CONFIGS[@]}"; do
    if find "$TEMP_DIR" -name "$CONFIG" | grep -q .; then
        echo "  âœ“ $CONFIG å­˜åœ¨"
    else
        echo "  âœ— $CONFIG ç¼ºå¤±"
    fi
done

rm -rf "$TEMP_DIR"

END_TIME=$(date +%s)
echo "éªŒè¯è€—æ—¶: $((END_TIME - START_TIME)) ç§’"
echo ""

# 5. ç”Ÿæˆæ¼”ç»ƒæŠ¥å‘Š
echo "========================================="
echo "  æ¼”ç»ƒæ€»ç»“"
echo "========================================="
echo "æ¼”ç»ƒå®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""
echo "æŒ‡æ ‡è¾¾æˆæƒ…å†µ:"
echo "  - å¤‡ä»½å®Œæ•´æ€§: é€šè¿‡"
echo "  - æ•°æ®åº“RTO: $(if [ $((END_TIME - START_TIME)) -lt 3600 ]; then echo "è¾¾æ ‡"; else echo "æœªè¾¾æ ‡"; fi)"
echo "  - è™šæ‹Ÿæœºæ¢å¤: é€šè¿‡"
echo "  - é…ç½®æ–‡ä»¶: é€šè¿‡"
echo ""
echo "å»ºè®®:"
echo "  1. å®šæœŸæ¸…ç†è¿‡æœŸå¤‡ä»½"
echo "  2. ä¼˜åŒ–å¤‡ä»½è„šæœ¬æ€§èƒ½"
echo "  3. å¢åŠ è‡ªåŠ¨åŒ–æµ‹è¯•"
echo ""
echo "è¯¦ç»†æŠ¥å‘Š: $REPORT_FILE"
```

---

## å¤‡ä»½ç›‘æ§

```yaml
ç›‘æ§æŒ‡æ ‡:
  å¤‡ä»½çŠ¶æ€:
    âœ“ å¤‡ä»½æˆåŠŸç‡
    âœ“ å¤‡ä»½å®Œæˆæ—¶é—´
    âœ“ å¤‡ä»½å¤§å°è¶‹åŠ¿
    âœ“ å¤‡ä»½å¤±è´¥å‘Šè­¦
  
  å­˜å‚¨å®¹é‡:
    âœ“ å¤‡ä»½ä»“åº“ä½¿ç”¨ç‡
    âœ“ å®¹é‡å¢é•¿ç‡
    âœ“ é¢„è®¡å‰©ä½™å¤©æ•°
  
  æ¢å¤æŒ‡æ ‡:
    âœ“ æ¢å¤æµ‹è¯•æˆåŠŸç‡
    âœ“ å®é™…RTO/RPO
    âœ“ æ•°æ®å®Œæ•´æ€§

å‘Šè­¦é…ç½®:
```

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: backup_alerts
    rules:
      - alert: BackupFailed
        expr: backup_job_status{status="failed"} > 0
        for: 5m
        annotations:
          summary: "å¤‡ä»½ä»»åŠ¡å¤±è´¥"
          description: "{{ $labels.job }} å¤‡ä»½å¤±è´¥"
      
      - alert: BackupStorageFull
        expr: (backup_storage_used / backup_storage_total) > 0.85
        for: 10m
        annotations:
          summary: "å¤‡ä»½å­˜å‚¨ç©ºé—´ä¸è¶³"
          description: "å¤‡ä»½å­˜å‚¨ä½¿ç”¨ç‡ {{ $value }}%"
      
      - alert: BackupNotRunning
        expr: time() - backup_last_success_time > 86400
        for: 1h
        annotations:
          summary: "å¤‡ä»½ä»»åŠ¡è¶…è¿‡24å°æ—¶æœªè¿è¡Œ"
          description: "{{ $labels.job }} æœ€åæˆåŠŸæ—¶é—´ {{ $value }} ç§’å‰"
```

---

## æœ€ä½³å®è·µ

```yaml
å¤‡ä»½ç­–ç•¥æœ€ä½³å®è·µ:
  1. 3-2-1è§„åˆ™:
     âœ“ ä¿ç•™3ä»½æ•°æ®å‰¯æœ¬
     âœ“ ä½¿ç”¨2ç§ä¸åŒå­˜å‚¨ä»‹è´¨
     âœ“ 1ä»½å¼‚åœ°å­˜å‚¨
  
  2. è‡ªåŠ¨åŒ–:
     âœ“ å®šæ—¶è‡ªåŠ¨å¤‡ä»½
     âœ“ è‡ªåŠ¨éªŒè¯
     âœ“ è‡ªåŠ¨æ¸…ç†
     âœ“ è‡ªåŠ¨å‘Šè­¦
  
  3. æµ‹è¯•éªŒè¯:
     âœ“ å®šæœŸæ¢å¤æ¼”ç»ƒ
     âœ“ éªŒè¯æ•°æ®å®Œæ•´æ€§
     âœ“ æµ‹é‡å®é™…RTO/RPO
  
  4. å®‰å…¨ä¿æŠ¤:
     âœ“ å¤‡ä»½åŠ å¯†
     âœ“ è®¿é—®æ§åˆ¶
     âœ“ ç¦»çº¿å¤‡ä»½
     âœ“ é˜²å‹’ç´¢ç—…æ¯’
  
  5. æ–‡æ¡£è®°å½•:
     âœ“ å¤‡ä»½æµç¨‹æ–‡æ¡£
     âœ“ æ¢å¤æ­¥éª¤æ–‡æ¡£
     âœ“ åº”æ€¥è”ç³»æ–¹å¼
     âœ“ æ¼”ç»ƒè®°å½•

å®¹ç¾æ¶æ„æœ€ä½³å®è·µ:
  1. åˆ†å±‚ä¿æŠ¤:
     L1: å­˜å‚¨RAID (ç¡¬ä»¶å®¹é”™)
     L2: å¿«ç…§ (è¯¯æ“ä½œæ¢å¤)
     L3: å¤‡ä»½ (æ•°æ®ä¸¢å¤±æ¢å¤)
     L4: å¼‚åœ°å®¹ç¾ (ç«™ç‚¹çº§ç¾éš¾)
  
  2. å…³é”®æ•°æ®ä¼˜å…ˆ:
     æ•°æ®åº“ > é…ç½®æ–‡ä»¶ > åº”ç”¨æ•°æ® > æ—¥å¿—
  
  3. åˆç†çš„ä¿ç•™æœŸ:
     æ—¥å¿—: 7-30å¤©
     æ•°æ®åº“: 30-90å¤©
     é…ç½®: 365å¤©
     å½’æ¡£: æ°¸ä¹…
  
  4. å®šæœŸå®¡æŸ¥:
     å­£åº¦: å®¡æŸ¥å¤‡ä»½ç­–ç•¥
     åŠå¹´: å®¹ç¾æ¼”ç»ƒ
     å¹´åº¦: å…¨é¢è¯„ä¼°

å¸¸è§é”™è¯¯:
  âŒ åªå¤‡ä»½ä¸æµ‹è¯•æ¢å¤
  âŒ å¤‡ä»½å’Œç”Ÿäº§åœ¨åŒä¸€å­˜å‚¨
  âŒ æ²¡æœ‰å¼‚åœ°å¤‡ä»½
  âŒ è¿‡æœŸå¤‡ä»½ä¸æ¸…ç†
  âŒ å¤‡ä»½çª—å£è¿‡é•¿å½±å“ä¸šåŠ¡
  âŒ æ²¡æœ‰ç›‘æ§å‘Šè­¦
  âŒ æ¢å¤æµç¨‹ä¸æ¸…æ™°
  âŒ å¤‡ä»½ä»‹è´¨å•ä¸€

æˆæœ¬ä¼˜åŒ–:
  1. åˆ†çº§å­˜å‚¨:
     çƒ­æ•°æ®: é«˜æ€§èƒ½å­˜å‚¨ (SSD)
     æ¸©æ•°æ®: æ ‡å‡†å­˜å‚¨ (HDD)
     å†·æ•°æ®: å¯¹è±¡å­˜å‚¨ (S3)
     å½’æ¡£: ç£å¸¦/å†°å·å­˜å‚¨
  
  2. é‡å¤æ•°æ®åˆ é™¤:
     Veeam: å†…ç½®å»é‡
     å¤‡ä»½ä¸€ä½“æœº: ç¡¬ä»¶å»é‡
     äº‘å¤‡ä»½: æœåŠ¡ç«¯å»é‡
  
  3. å‹ç¼©:
     gzip: é€šç”¨å‹ç¼©
     lz4: å¿«é€Ÿå‹ç¼©
     zstd: é«˜å‹ç¼©æ¯”
  
  4. å¢é‡å¤‡ä»½:
     å‡å°‘å­˜å‚¨ç©ºé—´
     å‡å°‘å¤‡ä»½æ—¶é—´
     å‡å°‘ç½‘ç»œå¸¦å®½
```

---

## ç›¸å…³æ–‡æ¡£

- [å­˜å‚¨ç±»å‹ä¸é€‰å‹æ ‡å‡†](01_å­˜å‚¨ç±»å‹ä¸é€‰å‹æ ‡å‡†.md)
- [iSCSIé…ç½®ä¸ä¼˜åŒ–](02_iSCSIé…ç½®ä¸ä¼˜åŒ–.md)
- [NFSé…ç½®ä¸ä¼˜åŒ–](03_NFSé…ç½®ä¸ä¼˜åŒ–.md)
- [VMware vSANé…ç½®](04_VMware_vSANé…ç½®.md)
- [Cephåˆ†å¸ƒå¼å­˜å‚¨](05_Cephåˆ†å¸ƒå¼å­˜å‚¨.md)
- [å­˜å‚¨æ€§èƒ½ä¼˜åŒ–](06_å­˜å‚¨æ€§èƒ½ä¼˜åŒ–.md)

---

**æ›´æ–°æ—¶é—´**: 2025-10-19  
**æ–‡æ¡£ç‰ˆæœ¬**: v3.0  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
