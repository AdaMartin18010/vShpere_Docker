# 2025安全新标准

> **返回**: [新兴技术2025首页](README.md) | [容器化部署首页](../README.md)

---

## 📋 目录

- [2025安全新标准](#2025安全新标准)
  - [📋 目录](#-目录)
  - [云原生安全演进](#云原生安全演进)
    - [2025安全趋势](#2025安全趋势)
      - [1. **供应链安全成为首要关注**](#1-供应链安全成为首要关注)
      - [2. **零信任架构主流化**](#2-零信任架构主流化)
      - [3. **eBPF驱动的运行时安全**](#3-ebpf驱动的运行时安全)
      - [4. **AI辅助安全分析**](#4-ai辅助安全分析)
    - [供应链安全重要性](#供应链安全重要性)
  - [Sigstore无密钥签名](#sigstore无密钥签名)
    - [Sigstore概述](#sigstore概述)
    - [Sigstore架构](#sigstore架构)
    - [Cosign镜像签名](#cosign镜像签名)
      - [安装Cosign](#安装cosign)
      - [签名容器镜像](#签名容器镜像)
      - [验证镜像签名](#验证镜像签名)
      - [Kubernetes集成](#kubernetes集成)
    - [Sigstore 2025新特性](#sigstore-2025新特性)
      - [1. **Trusted Root (信任根)**](#1-trusted-root-信任根)
      - [2. **私有Sigstore实例**](#2-私有sigstore实例)
      - [3. **Sigstore Java/Python/Go客户端**](#3-sigstore-javapythongo客户端)
  - [SBOM软件物料清单](#sbom软件物料清单)
    - [SBOM概述](#sbom概述)
    - [Syft生成SBOM](#syft生成sbom)
    - [SBOM验证与审计](#sbom验证与审计)
  - [SLSA供应链等级](#slsa供应链等级)
    - [SLSA概述](#slsa概述)
    - [SLSA等级要求](#slsa等级要求)
    - [实现SLSA 3级](#实现slsa-3级)
  - [GUAC软件供应链图谱](#guac软件供应链图谱)
    - [GUAC概述](#guac概述)
    - [GUAC架构](#guac架构)
    - [GUAC部署](#guac部署)
    - [GUAC查询示例](#guac查询示例)
  - [VEX漏洞可利用性交换](#vex漏洞可利用性交换)
    - [VEX概述](#vex概述)
    - [VEX文档格式](#vex文档格式)
    - [VEX实践](#vex实践)
  - [Trivy安全扫描增强](#trivy安全扫描增强)
    - [Trivy概述](#trivy概述)
    - [Trivy 2025新特性](#trivy-2025新特性)
      - [1. **VEX支持**](#1-vex支持)
      - [2. **SBOM扫描**](#2-sbom扫描)
      - [3. **Kubernetes Operator**](#3-kubernetes-operator)
      - [4. **供应链安全**](#4-供应链安全)
    - [Trivy全面扫描](#trivy全面扫描)
    - [Trivy CI/CD集成](#trivy-cicd集成)
    - [Trivy Operator](#trivy-operator)
  - [Falco运行时安全](#falco运行时安全)
    - [Falco概述](#falco概述)
    - [Falco 2025新特性](#falco-2025新特性)
      - [1. **eBPF原生** (默认)](#1-ebpf原生-默认)
      - [2. **插件生态**](#2-插件生态)
    - [Falco规则示例](#falco规则示例)
  - [Tetragon eBPF安全](#tetragon-ebpf安全)
    - [Tetragon概述](#tetragon概述)
    - [Tetragon策略示例](#tetragon策略示例)
  - [OPA/Kyverno策略引擎](#opakyverno策略引擎)
    - [Kyverno 2025新特性](#kyverno-2025新特性)
      - [1. **Validate Admission Rules** (1.11+)](#1-validate-admission-rules-111)
    - [Kyverno策略示例](#kyverno策略示例)
  - [零信任安全架构](#零信任安全架构)
    - [SPIFFE/SPIRE身份认证](#spiffespire身份认证)
    - [mTLS自动化](#mtls自动化)
  - [安全最佳实践](#安全最佳实践)
    - [镜像安全](#镜像安全)
      - [1. **使用最小化基础镜像**](#1-使用最小化基础镜像)
      - [2. **多阶段构建 + 非root用户**](#2-多阶段构建--非root用户)
      - [3. **签名和验证**](#3-签名和验证)
    - [运行时安全](#运行时安全)
      - [1. **Pod Security Standards**](#1-pod-security-standards)
      - [2. **AppArmor/SELinux**](#2-apparmorselinux)
    - [网络安全](#网络安全)
      - [1. **NetworkPolicy**](#1-networkpolicy)
    - [数据安全](#数据安全)
      - [1. **密钥加密 (KMS)**](#1-密钥加密-kms)
      - [2. **External Secrets Operator**](#2-external-secrets-operator)
  - [安全合规框架](#安全合规框架)
    - [CIS Benchmarks](#cis-benchmarks)
    - [PCI DSS](#pci-dss)
    - [SOC 2](#soc-2)
  - [安全生产案例](#安全生产案例)
    - [案例1：供应链攻击防御](#案例1供应链攻击防御)
    - [案例2：零信任安全架构](#案例2零信任安全架构)
  - [安全未来趋势](#安全未来趋势)
    - [1. **供应链安全标准化**](#1-供应链安全标准化)
    - [2. **eBPF驱动安全**](#2-ebpf驱动安全)
    - [3. **AI辅助安全**](#3-ai辅助安全)
    - [4. **零信任主流化**](#4-零信任主流化)
  - [相关资源](#相关资源)
    - [官方文档](#官方文档)
    - [GitHub仓库](#github仓库)
    - [学习资源](#学习资源)

---

## 云原生安全演进

### 2025安全趋势

#### 1. **供应链安全成为首要关注**

```text
2023年SolarWinds供应链攻击影响:
- 18,000+组织受影响
- 损失: >$100M

2024年Log4Shell漏洞影响:
- 全球数百万应用受影响
- CVSS评分: 10.0 (最高)

2025年应对:
- ✅ SBOM (软件物料清单) 强制要求
- ✅ Sigstore无密钥签名标准化
- ✅ SLSA供应链等级认证
```

#### 2. **零信任架构主流化**

- ✅ SPIFFE/SPIRE成为身份标准
- ✅ mTLS自动化 (Istio Ambient、Linkerd)
- ✅ 工作负载身份 (Workload Identity)

#### 3. **eBPF驱动的运行时安全**

- ✅ Falco 0.37+ (eBPF原生)
- ✅ Tetragon (Cilium安全组件)
- ✅ 内核级可观测性和策略执行

#### 4. **AI辅助安全分析**

- ✅ 智能漏洞优先级排序
- ✅ 异常行为检测
- ✅ 自动化安全响应

---

### 供应链安全重要性

**供应链攻击路径**:

```text
攻击者
  ↓
开源库投毒 (恶意依赖)
  ↓
开发者构建镜像 (包含恶意代码)
  ↓
CI/CD流水线 (未验证签名)
  ↓
生产环境部署 (受感染)
  ↓
数据泄露 / 后门植入
```

**2025防御体系**:

```text
✅ SBOM: 透明的依赖关系
✅ Sigstore: 可验证的签名
✅ SLSA: 可信的构建过程
✅ GUAC: 全局供应链图谱
✅ VEX: 准确的漏洞状态
✅ Trivy: 全面的安全扫描
```

---

## Sigstore无密钥签名

### Sigstore概述

**Sigstore** 是一个**免费、开源**的软件签名服务，提供**无密钥签名** (Keyless Signing)。

**官网**: https://www.sigstore.dev/  
**GitHub**: https://github.com/sigstore/sigstore  
**CNCF状态**: Incubating (2021) → Graduated (2023)

**核心特点**:

- 🔑 **无密钥签名**: 基于OIDC身份，无需管理长期密钥
- 🌐 **公共透明日志**: Rekor透明日志，不可篡改
- 📜 **证书颁发**: Fulcio CA，短期证书
- 🆓 **免费公共服务**: 由Linux Foundation运营

---

### Sigstore架构

```text
┌───────────────────────────────────────────────────────────┐
│                    Sigstore Architecture                   │
│                                                            │
│  ┌────────────────────────────────────────────────────┐   │
│  │  开发者                                             │   │
│  │  1. OIDC登录 (GitHub/Google/Microsoft)            │   │
│  │  2. 请求签名                                        │   │
│  └────────────────────────────────────────────────────┘   │
│                       ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Fulcio (证书颁发机构)                             │   │
│  │  - 验证OIDC身份                                    │   │
│  │  - 颁发短期证书 (10分钟)                           │   │
│  │  - 证书绑定OIDC身份信息                            │   │
│  └────────────────────────────────────────────────────┘   │
│                       ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Cosign (签名工具)                                  │   │
│  │  - 使用短期证书签名容器镜像                         │   │
│  │  - 将签名上传到OCI Registry                         │   │
│  └────────────────────────────────────────────────────┘   │
│                       ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Rekor (透明日志)                                   │   │
│  │  - 记录所有签名操作                                 │   │
│  │  - 不可篡改的Merkle树                              │   │
│  │  - 公开可审计                                       │   │
│  └────────────────────────────────────────────────────┘   │
│                       ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  验证者 (Kubernetes / CI/CD)                        │   │
│  │  - 验证签名真实性                                   │   │
│  │  - 检查透明日志                                     │   │
│  │  - 验证OIDC身份                                     │   │
│  └────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────┘
```

---

### Cosign镜像签名

#### 安装Cosign

```bash
#!/bin/bash
# install-cosign.sh - Cosign安装 (2025)

set -e

echo "=== 安装Cosign ==="

# 方法1: 二进制安装
COSIGN_VERSION="v2.2.3"
wget https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64
chmod +x cosign-linux-amd64
sudo mv cosign-linux-amd64 /usr/local/bin/cosign

# 方法2: Go安装
# go install github.com/sigstore/cosign/v2/cmd/cosign@latest

# 验证安装
cosign version

echo "=== Cosign安装完成 ==="
```

#### 签名容器镜像

```bash
#!/bin/bash
# sign-container-image.sh - 无密钥签名容器镜像

set -e

echo "=== Sigstore无密钥签名容器镜像 ==="

IMAGE="docker.io/myorg/myapp:v1.0.0"

# 1. 使用OIDC登录 (GitHub身份)
echo "1. 使用OIDC登录..."
# Cosign会打开浏览器进行GitHub OAuth登录

# 2. 签名镜像 (Keyless)
echo "2. 签名镜像..."
cosign sign $IMAGE

# 签名流程:
# - Cosign通过浏览器进行OIDC认证 (GitHub/Google/Microsoft)
# - Fulcio验证身份后颁发短期证书 (10分钟)
# - Cosign使用证书签名镜像
# - 签名和证书上传到OCI Registry
# - 签名记录写入Rekor透明日志

# 3. 查看签名
echo "3. 查看签名..."
cosign tree $IMAGE

echo ""
echo "=== 签名完成 ==="
```

**签名输出示例**:

```text
Generating ephemeral keys...
Retrieving signed certificate...

        The sigstore service, hosted by sigstore a Series of LF Projects, LLC, is provided pursuant to the Hosted Project Tools Terms of Use, available at https://lfprojects.org/policies/hosted-project-tools-terms-of-use/.
        Note that if your submission includes personal data associated with this signed artifact, it will be part of an immutable record.
        This may include the email address associated with the account with which you authenticate your contractual Agreement.
        This information will be used for signing this artifact and will be stored in public transparency logs and cannot be removed later, and is subject to the Immutable Record notice at https://lfprojects.org/policies/hosted-project-tools-immutable-records/.

By typing 'y', you attest that (1) you are not submitting the personal data of any other person; and (2) you understand and agree to the statement and the Agreement terms at the URLs listed above.
Are you sure you would like to continue? [y/N] y

tlog entry created with index: 123456789
Pushing signature to: docker.io/myorg/myapp:sha256-abc123...
```

#### 验证镜像签名

```bash
#!/bin/bash
# verify-signature.sh - 验证镜像签名

set -e

IMAGE="docker.io/myorg/myapp:v1.0.0"

echo "=== 验证镜像签名 ==="

# 1. 验证签名 (基于OIDC身份)
echo "1. 验证签名..."
cosign verify $IMAGE \
  --certificate-identity=user@example.com \
  --certificate-oidc-issuer=https://github.com/login/oauth

# 2. 验证签名 (任何GitHub用户)
echo "2. 验证GitHub组织签名..."
cosign verify $IMAGE \
  --certificate-identity-regexp='.*@myorg.com' \
  --certificate-oidc-issuer=https://github.com/login/oauth

# 3. 查看签名详情
echo "3. 查看签名详情..."
cosign verify $IMAGE \
  --certificate-identity-regexp='.*' \
  --certificate-oidc-issuer=https://github.com/login/oauth \
  -o json | jq

echo ""
echo "=== 验证完成 ==="
```

**验证输出**:

```json
{
  "critical": {
    "identity": {
      "docker-reference": "docker.io/myorg/myapp"
    },
    "image": {
      "docker-manifest-digest": "sha256:abc123..."
    },
    "type": "cosign container image signature"
  },
  "optional": {
    "Bundle": {
      "SignedEntryTimestamp": "MEUCIQD...",
      "Payload": {
        "body": "eyJhcGlWZXJzaW9...",
        "integratedTime": 1697760000,
        "logIndex": 123456789,
        "logID": "c0d23d6ad406973f9559f3ba2d1ca01f84147d8ffc5b8445c224f98b9591801d"
      }
    },
    "Issuer": "https://github.com/login/oauth",
    "Subject": "user@example.com"
  }
}
```

#### Kubernetes集成

**Policy Controller (Sigstore)**:

```bash
#!/bin/bash
# install-policy-controller.sh - 安装Sigstore Policy Controller

set -e

echo "=== 安装Sigstore Policy Controller ==="

# 1. 安装Policy Controller
kubectl apply -f https://github.com/sigstore/policy-controller/releases/latest/download/policy-controller.yaml

# 2. 等待部署完成
kubectl rollout status deployment/policy-controller-webhook -n cosign-system

echo "=== Policy Controller安装完成 ==="
```

**ClusterImagePolicy** (强制签名验证):

```yaml
# cluster-image-policy.yaml
apiVersion: policy.sigstore.dev/v1beta1
kind: ClusterImagePolicy
metadata:
  name: require-signed-images
spec:
  images:
  - glob: "docker.io/myorg/**"  # 所有myorg镜像必须签名
  authorities:
  - keyless:
      url: https://fulcio.sigstore.dev
      identities:
      - issuerRegExp: ".*"
        subjectRegExp: ".*@myorg\\.com"  # 只允许myorg.com签名者
    ctlog:
      url: https://rekor.sigstore.dev
```

**测试策略**:

```bash
# 尝试部署未签名镜像 (应该失败)
kubectl run test --image=docker.io/myorg/unsigned:latest

# 错误:
# Error: admission webhook "policy.sigstore.dev" denied the request: 
# validation failed: failed to verify signature for docker.io/myorg/unsigned:latest
```

---

### Sigstore 2025新特性

#### 1. **Trusted Root (信任根)**

```bash
# 使用Trusted Root验证 (2025新增)
cosign verify $IMAGE \
  --use-trusted-root \
  --trusted-root-url=https://tuf.sigstore.dev
```

#### 2. **私有Sigstore实例**

```bash
# 部署私有Fulcio + Rekor
helm install sigstore sigstore/sigstore-scaffolding \
  --namespace sigstore-system --create-namespace \
  --set fulcio.enabled=true \
  --set rekor.enabled=true \
  --set ctlog.enabled=true
```

#### 3. **Sigstore Java/Python/Go客户端**

```python
# Python示例
from sigstore.verify import Verifier

verifier = Verifier()
result = verifier.verify(
    image="docker.io/myorg/myapp:v1.0.0",
    certificate_identity="user@example.com",
    certificate_oidc_issuer="https://github.com/login/oauth"
)
```

---

## SBOM软件物料清单

### SBOM概述

**SBOM** (Software Bill of Materials，软件物料清单) 是软件中所有组件和依赖的**完整清单**。

**重要性**:

- 🔍 **供应链可见性**: 知道软件中有什么
- 🐛 **漏洞管理**: 快速定位受影响组件
- 📋 **合规要求**: 美国政府强制要求 (Executive Order 14028)

**SBOM格式**:

- **SPDX** (Software Package Data Exchange) - Linux Foundation
- **CycloneDX** - OWASP

---

### Syft生成SBOM

**Syft** 是 **Anchore** 开源的SBOM生成工具。

```bash
#!/bin/bash
# generate-sbom.sh - 生成容器镜像SBOM

set -e

echo "=== 生成SBOM ==="

IMAGE="docker.io/myorg/myapp:v1.0.0"

# 1. 安装Syft
echo "1. 安装Syft..."
curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

# 2. 生成SBOM (SPDX格式)
echo "2. 生成SBOM (SPDX)..."
syft $IMAGE -o spdx-json > sbom-spdx.json

# 3. 生成SBOM (CycloneDX格式)
echo "3. 生成SBOM (CycloneDX)..."
syft $IMAGE -o cyclonedx-json > sbom-cyclonedx.json

# 4. 生成SBOM (人类可读格式)
echo "4. 生成SBOM (表格)..."
syft $IMAGE -o table

# 5. 将SBOM附加到镜像 (Cosign)
echo "5. 将SBOM附加到镜像..."
cosign attach sbom --sbom sbom-spdx.json $IMAGE

echo ""
echo "=== SBOM生成完成 ==="
```

**SBOM示例输出** (简化):

```text
NAME                 VERSION      TYPE
nginx                1.25.3       apk
openssl              3.1.4        apk
zlib                 1.3          apk
pcre2                10.42        apk
alpine-baselayout    3.4.3        apk
...
```

**CycloneDX JSON示例**:

```json
{
  "bomFormat": "CycloneDX",
  "specVersion": "1.5",
  "version": 1,
  "metadata": {
    "timestamp": "2025-10-20T10:00:00Z",
    "component": {
      "type": "container",
      "name": "myapp",
      "version": "v1.0.0"
    }
  },
  "components": [
    {
      "type": "library",
      "name": "nginx",
      "version": "1.25.3",
      "purl": "pkg:apk/alpine/nginx@1.25.3",
      "licenses": [{"license": {"id": "BSD-2-Clause"}}]
    }
  ]
}
```

---

### SBOM验证与审计

```bash
# 验证SBOM真实性 (Cosign)
cosign verify-attestation $IMAGE \
  --type cyclonedx \
  --certificate-identity-regexp='.*@myorg.com' \
  --certificate-oidc-issuer=https://github.com/login/oauth

# 下载附加的SBOM
cosign download sbom $IMAGE > sbom.json

# 分析SBOM中的漏洞 (Grype)
grype sbom:./sbom.json
```

---

## SLSA供应链等级

### SLSA概述

**SLSA** (Supply chain Levels for Software Artifacts，软件供应链级别) 是一个**安全框架**，定义了软件供应链的**成熟度等级**。

**官网**: https://slsa.dev/  
**发起方**: Google、Linux Foundation

**核心目标**:

- 🔒 **防止篡改**: 确保软件在构建和发布过程中未被篡改
- 📜 **可审计**: 提供完整的构建证明
- 🎯 **标准化**: 统一的安全标准

---

### SLSA等级要求

| 等级 | 要求 | 说明 |
|------|------|------|
| **SLSA 0** | 无要求 | 基线 (不安全) |
| **SLSA 1** | 构建证明 | 生成并签名构建元数据 |
| **SLSA 2** | 版本控制 + 托管构建 | 代码托管在Git，使用CI/CD构建 |
| **SLSA 3** | 强化构建平台 | 防篡改构建环境，审计日志 |
| **SLSA 4** | 双方审查 | 代码和构建双方审查 (最高级别) |

---

### 实现SLSA 3级

**GitHub Actions SLSA 3示例**:

```yaml
# .github/workflows/slsa3-build.yaml
name: SLSA 3 Build

on:
  push:
    tags:
      - 'v*'

permissions:
  id-token: write  # OIDC token
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Build image
      id: build
      run: |
        docker build -t ghcr.io/${{ github.repository }}:${{ github.ref_name }} .
        docker push ghcr.io/${{ github.repository }}:${{ github.ref_name }}
        echo "digest=$(docker inspect --format='{{.RepoDigests}}' ghcr.io/${{ github.repository }}:${{ github.ref_name }} | cut -d'@' -f2)" >> $GITHUB_OUTPUT

  provenance:
    needs: build
    permissions:
      id-token: write
      actions: read
      packages: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v1.9.0
    with:
      image: ghcr.io/${{ github.repository }}
      digest: ${{ needs.build.outputs.image-digest }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}
```

**SLSA Provenance (来源证明)**:

```json
{
  "_type": "https://in-toto.io/Statement/v0.1",
  "subject": [
    {
      "name": "ghcr.io/myorg/myapp",
      "digest": {
        "sha256": "abc123..."
      }
    }
  ],
  "predicateType": "https://slsa.dev/provenance/v0.2",
  "predicate": {
    "builder": {
      "id": "https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v1.9.0"
    },
    "buildType": "https://github.com/slsa-framework/slsa-github-generator/container@v1",
    "invocation": {
      "configSource": {
        "uri": "git+https://github.com/myorg/myapp@refs/tags/v1.0.0",
        "digest": {
          "sha1": "def456..."
        },
        "entryPoint": ".github/workflows/slsa3-build.yaml"
      }
    },
    "metadata": {
      "buildInvocationId": "123456789",
      "buildStartedOn": "2025-10-20T10:00:00Z",
      "buildFinishedOn": "2025-10-20T10:05:00Z",
      "completeness": {
        "parameters": true,
        "environment": false,
        "materials": true
      },
      "reproducible": false
    },
    "materials": [
      {
        "uri": "git+https://github.com/myorg/myapp@refs/tags/v1.0.0",
        "digest": {
          "sha1": "def456..."
        }
      }
    ]
  }
}
```

---

## GUAC软件供应链图谱

### GUAC概述

**GUAC** (Graph for Understanding Artifact Composition，理解构件组成的图谱) 是一个**供应链安全图谱工具**。

**官网**: https://guac.sh/  
**GitHub**: https://github.com/guacsec/guac  
**发起方**: Google、Kusari、Citi

**核心功能**:

- 📊 **构建供应链图谱**: 将SBOM、SLSA、漏洞数据关联起来
- 🔍 **深度查询**: 找出哪些软件受某个漏洞影响
- 🎯 **风险评估**: 评估供应链风险

---

### GUAC架构

```text
┌───────────────────────────────────────────────────────────┐
│                    GUAC Architecture                       │
│                                                            │
│  ┌────────────────────────────────────────────────────┐   │
│  │  数据摄取 (Ingestors)                               │   │
│  │  - SBOM (Syft、SPDX)                               │   │
│  │  - SLSA Provenance                                 │   │
│  │  - 漏洞数据 (OSV、NVD、Trivy)                      │   │
│  │  - 签名数据 (Sigstore)                             │   │
│  └────────────────────────────────────────────────────┘   │
│                       ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  GUAC图数据库                                       │   │
│  │  - Neo4j / Memgraph                                │   │
│  │  - 节点: 软件包、漏洞、构建                        │   │
│  │  - 边: 依赖关系、影响关系                          │   │
│  └────────────────────────────────────────────────────┘   │
│                       ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  GUAC API / UI                                      │   │
│  │  - GraphQL查询                                      │   │
│  │  - 可视化图谱                                       │   │
│  └────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────┘
```

---

### GUAC部署

```bash
#!/bin/bash
# install-guac.sh - GUAC安装

set -e

echo "=== 安装GUAC ==="

# 1. 使用Docker Compose快速启动
git clone https://github.com/guacsec/guac.git
cd guac

# 2. 启动GUAC服务
docker-compose up -d

# 服务:
# - GUAC GraphQL API: http://localhost:8080
# - GUAC UI: http://localhost:3000
# - Neo4j: http://localhost:7474

echo "=== GUAC启动完成 ==="
echo "访问UI: http://localhost:3000"
```

---

### GUAC查询示例

**1. 查找受CVE影响的所有镜像**

```graphql
query FindAffectedImages {
  vulnerabilities(vulnID: "CVE-2024-12345") {
    vulnerability {
      vulnerabilityIDs {
        vulnerabilityID
      }
    }
    packages {
      package {
        namespaces {
          namespace
          names {
            name
            versions {
              version
            }
          }
        }
      }
    }
  }
}
```

**2. 查找镜像的完整依赖树**

```graphql
query ImageDependencies {
  artifacts(artifactSpec: {
    digest: "sha256:abc123..."
  }) {
    ... on Package {
      namespaces {
        namespace
        names {
          name
          versions {
            version
            dependencies {
              package {
                name
                version
              }
            }
          }
        }
      }
    }
  }
}
```

**3. 查找未签名的镜像**

```graphql
query UnsignedImages {
  artifacts {
    ... on Artifact {
      algorithm
      digest
      signatures {
        signature
      }
    }
  }
}
```

---

## VEX漏洞可利用性交换

### VEX概述

**VEX** (Vulnerability Exploitability eXchange，漏洞可利用性交换) 是一种**标准格式**，用于描述漏洞的**实际可利用性**。

**问题场景**:

```text
场景: 容器镜像中包含OpenSSL 3.0.10

漏洞扫描器报告:
- CVE-2023-12345: CRITICAL (CVSS 9.8)
- 建议: 立即升级

实际情况:
- 该漏洞仅影响OpenSSL的X功能
- 我们的应用不使用X功能
- 结论: 漏洞不可利用 (False Positive)

问题: 如何告诉扫描器"这个漏洞不影响我"？
答案: 使用VEX
```

---

### VEX文档格式

**OpenVEX格式** (CycloneDX VEX):

```json
{
  "@context": "https://openvex.dev/ns/v0.2.0",
  "@id": "https://example.com/vex/2025/001",
  "author": "Security Team <security@example.com>",
  "timestamp": "2025-10-20T10:00:00Z",
  "version": 1,
  "statements": [
    {
      "vulnerability": {
        "name": "CVE-2023-12345"
      },
      "products": [
        {
          "@id": "pkg:oci/myapp@sha256:abc123..."
        }
      ],
      "status": "not_affected",
      "justification": "vulnerable_code_not_present",
      "impact_statement": "The vulnerable OpenSSL X functionality is not compiled in our build."
    },
    {
      "vulnerability": {
        "name": "CVE-2023-67890"
      },
      "products": [
        {
          "@id": "pkg:oci/myapp@sha256:abc123..."
        }
      ],
      "status": "fixed",
      "action_statement": "Upgraded to patched version"
    }
  ]
}
```

**VEX状态**:

- `not_affected`: 不受影响
- `affected`: 受影响
- `fixed`: 已修复
- `under_investigation`: 调查中

---

### VEX实践

```bash
#!/bin/bash
# generate-vex.sh - 生成VEX文档

set -e

echo "=== 生成VEX文档 ==="

# 1. 安装vexctl
go install github.com/openvex/vexctl@latest

# 2. 创建VEX文档
cat > vex.json <<'EOF'
{
  "@context": "https://openvex.dev/ns/v0.2.0",
  "@id": "https://example.com/vex/2025/001",
  "author": "Security Team",
  "timestamp": "2025-10-20T10:00:00Z",
  "version": 1,
  "statements": [
    {
      "vulnerability": {"name": "CVE-2023-12345"},
      "products": [{"@id": "pkg:oci/myapp@sha256:abc123..."}],
      "status": "not_affected",
      "justification": "vulnerable_code_not_present"
    }
  ]
}
EOF

# 3. 附加VEX到镜像 (Cosign)
cosign attach attestation \
  --attestation vex.json \
  --type openvex \
  docker.io/myorg/myapp:v1.0.0

# 4. 使用VEX过滤扫描结果 (Trivy)
trivy image --severity HIGH,CRITICAL \
  --vex vex.json \
  docker.io/myorg/myapp:v1.0.0

echo "=== VEX文档生成并附加完成 ==="
```

---

## Trivy安全扫描增强

### Trivy概述

**Trivy** 是 **Aqua Security** 开源的**全面安全扫描器**。

**官网**: https://trivy.dev/  
**GitHub**: https://github.com/aquasecurity/trivy

**扫描能力**:

- 🐳 **容器镜像**: 漏洞、配置错误
- 📁 **文件系统**: 本地目录、Git仓库
- ☸️ **Kubernetes**: 配置错误、CIS Benchmarks
- 📄 **IaC**: Terraform、CloudFormation、Dockerfile
- 📦 **SBOM**: 生成和扫描SBOM
- 🔑 **密钥**: 检测硬编码密钥

---

### Trivy 2025新特性

#### 1. **VEX支持**

```bash
# 使用VEX过滤误报
trivy image --vex vex.json nginx:latest
```

#### 2. **SBOM扫描**

```bash
# 直接扫描SBOM文件
trivy sbom sbom-cyclonedx.json
```

#### 3. **Kubernetes Operator**

```bash
# 自动扫描集群中的所有镜像
helm install trivy-operator aqua/trivy-operator \
  --namespace trivy-system --create-namespace
```

#### 4. **供应链安全**

```bash
# 验证SLSA Provenance
trivy image --sbom-sources rekor \
  --rekor-url https://rekor.sigstore.dev \
  nginx:latest
```

---

### Trivy全面扫描

```bash
#!/bin/bash
# trivy-comprehensive-scan.sh - Trivy全面扫描

set -e

IMAGE="docker.io/myorg/myapp:v1.0.0"

echo "=== Trivy全面扫描 ==="

# 1. 漏洞扫描
echo "1. 漏洞扫描..."
trivy image --severity HIGH,CRITICAL $IMAGE

# 2. 配置错误扫描
echo "2. 配置错误扫描..."
trivy image --scanners config $IMAGE

# 3. 密钥泄露扫描
echo "3. 密钥泄露扫描..."
trivy image --scanners secret $IMAGE

# 4. 许可证合规扫描
echo "4. 许可证合规扫描..."
trivy image --scanners license $IMAGE

# 5. 生成SBOM
echo "5. 生成SBOM..."
trivy image --format cyclonedx $IMAGE > sbom.json

# 6. Kubernetes配置扫描
echo "6. Kubernetes配置扫描..."
trivy k8s --report summary cluster

# 7. IaC扫描 (Terraform)
echo "7. IaC扫描..."
trivy config ./terraform/

# 8. 生成HTML报告
echo "8. 生成HTML报告..."
trivy image --format template --template "@contrib/html.tpl" \
  -o report.html $IMAGE

echo ""
echo "=== Trivy扫描完成 ==="
```

---

### Trivy CI/CD集成

**GitHub Actions**:

```yaml
# .github/workflows/trivy-scan.yaml
name: Trivy Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  trivy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Build image
      run: docker build -t ${{ github.repository }}:${{ github.sha }} .
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ github.repository }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: Fail build on CRITICAL vulnerabilities
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ github.repository }}:${{ github.sha }}
        exit-code: '1'
        severity: 'CRITICAL'
```

---

### Trivy Operator

**自动扫描集群镜像**:

```bash
# 安装Trivy Operator
helm repo add aqua https://aquasecurity.github.io/helm-charts/
helm install trivy-operator aqua/trivy-operator \
  --namespace trivy-system --create-namespace \
  --set="trivy.ignoreUnfixed=true"

# 查看扫描报告
kubectl get vulnerabilityreports -A

# 查看详细报告
kubectl describe vulnerabilityreport <report-name> -n <namespace>
```

**VulnerabilityReport CRD**:

```yaml
apiVersion: aquasecurity.github.io/v1alpha1
kind: VulnerabilityReport
metadata:
  name: pod-nginx-7d8f9c5b4-xjk2m
  namespace: default
report:
  vulnerabilities:
  - vulnerabilityID: CVE-2023-12345
    severity: CRITICAL
    score: 9.8
    title: "OpenSSL Remote Code Execution"
    installedVersion: "3.0.10"
    fixedVersion: "3.0.11"
```

---

## Falco运行时安全

### Falco概述

**Falco** 是 **CNCF毕业项目**，基于**eBPF**的**运行时安全监控**工具。

**官网**: https://falco.org/  
**GitHub**: https://github.com/falcosecurity/falco

**核心功能**:

- 🔍 **异常行为检测**: 检测容器内异常行为
- 📊 **系统调用监控**: 基于eBPF，低开销
- 🚨 **实时告警**: Slack、PagerDuty、Webhook

---

### Falco 2025新特性

#### 1. **eBPF原生** (默认)

```bash
# Falco 0.37+ 默认使用eBPF (无需内核模块)
helm install falco falcosecurity/falco \
  --namespace falco --create-namespace \
  --set driver.kind=ebpf
```

#### 2. **插件生态**

```yaml
# falco.yaml
plugins:
- name: cloudtrail
  library_path: /usr/share/falco/plugins/libcloudtrail.so
  init_config: |
    aws_region: us-east-1
```

---

### Falco规则示例

```yaml
# falco-rules.yaml
- rule: Shell in Container
  desc: Detect shell spawned inside a container
  condition: >
    spawned_process and
    container and
    proc.name in (bash, sh, zsh)
  output: >
    Shell spawned in container
    (user=%user.name container=%container.name
    image=%container.image.repository:%container.image.tag
    shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline)
  priority: WARNING
  tags: [container, shell, mitre_execution]

- rule: Write below etc
  desc: Detect write to /etc directory
  condition: >
    open_write and
    container and
    fd.name startswith /etc/
  output: >
    File below /etc opened for writing
    (user=%user.name container=%container.name
    file=%fd.name parent=%proc.pname cmdline=%proc.cmdline)
  priority: ERROR
  tags: [filesystem, mitre_persistence]

- rule: Outbound Connection to C2 Server
  desc: Detect connection to known C2 server
  condition: >
    outbound and
    container and
    fd.sip in (malicious_ips)
  output: >
    Outbound connection to suspicious IP
    (user=%user.name container=%container.name
    connection=%fd.name)
  priority: CRITICAL
  tags: [network, mitre_command_and_control]
```

---

## Tetragon eBPF安全

### Tetragon概述

**Tetragon** 是 **Cilium** 的eBPF安全组件，提供**运行时执行策略**。

**GitHub**: https://github.com/cilium/tetragon

**核心功能**:

- ⚡ **实时执行策略**: 基于eBPF，内核级执行
- 🔒 **零信任执行**: 只允许预定义的行为
- 📊 **深度可观测性**: 系统调用、文件、网络

---

### Tetragon策略示例

```yaml
# tetragon-policy.yaml
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: prevent-sensitive-file-access
spec:
  lists:
  - name: "sensitive_files"
    type: "files"
    values:
    - "/etc/shadow"
    - "/etc/passwd"
    - "/root/.ssh/id_rsa"
  
  kprobes:
  - call: "security_file_open"
    syscall: false
    args:
    - index: 0
      type: "file"
    selectors:
    - matchArgs:
      - index: 0
        operator: "InList"
        values:
        - "sensitive_files"
      matchActions:
      - action: Block  # 阻止访问
      - action: Notify  # 发送告警
```

---

## OPA/Kyverno策略引擎

### Kyverno 2025新特性

**Kyverno** 是 **CNCF孵化项目**，专为Kubernetes设计的**策略引擎**。

**官网**: https://kyverno.io/

#### 1. **Validate Admission Rules** (1.11+)

```yaml
# validate-admission-rule.yaml
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: require-labels
spec:
  matchConstraints:
    resourceRules:
    - apiGroups: ["apps"]
      apiVersions: ["v1"]
      resources: ["deployments"]
      operations: ["CREATE", "UPDATE"]
  validations:
  - expression: "has(object.metadata.labels.team)"
    message: "Deployment must have 'team' label"
```

---

### Kyverno策略示例

**1. 强制镜像签名验证**

```yaml
# verify-image-signature.yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: verify-image-signature
spec:
  validationFailureAction: Enforce
  rules:
  - name: verify-signature
    match:
      any:
      - resources:
          kinds:
          - Pod
    verifyImages:
    - imageReferences:
      - "docker.io/myorg/*"
      attestors:
      - entries:
        - keyless:
            subject: "*@myorg.com"
            issuer: "https://github.com/login/oauth"
            rekor:
              url: https://rekor.sigstore.dev
```

**2. 禁止特权容器**

```yaml
# disallow-privileged.yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-privileged
spec:
  validationFailureAction: Enforce
  rules:
  - name: check-privileged
    match:
      any:
      - resources:
          kinds:
          - Pod
    validate:
      message: "Privileged containers are not allowed"
      pattern:
        spec:
          containers:
          - =(securityContext):
              =(privileged): false
```

**3. 自动注入Sidecar (Mutation)**

```yaml
# inject-sidecar.yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: inject-logging-sidecar
spec:
  rules:
  - name: inject-sidecar
    match:
      any:
      - resources:
          kinds:
          - Pod
          namespaces:
          - production
    mutate:
      patchStrategicMerge:
        spec:
          containers:
          - name: log-forwarder
            image: fluent/fluent-bit:latest
            volumeMounts:
            - name: varlog
              mountPath: /var/log
```

---

## 零信任安全架构

### SPIFFE/SPIRE身份认证

**SPIFFE** (Secure Production Identity Framework For Everyone) 是**零信任身份标准**。

**官网**: https://spiffe.io/

**核心概念**:

- **SPIFFE ID**: `spiffe://trust-domain/workload-identifier`
- **SVID**: SPIFFE Verifiable Identity Document (X.509证书或JWT)
- **SPIRE**: SPIFFE Runtime Environment (实现)

**部署SPIRE**:

```bash
# 安装SPIRE
helm install spire-server spire/spire-server \
  --namespace spire --create-namespace

helm install spire-agent spire/spire-agent \
  --namespace spire
```

---

### mTLS自动化

**Istio Ambient Mode (无Sidecar mTLS)**:

```yaml
# ambient-mtls.yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: production
spec:
  mtls:
    mode: STRICT  # 强制mTLS
```

---

## 安全最佳实践

### 镜像安全

#### 1. **使用最小化基础镜像**

```dockerfile
# 推荐: Distroless
FROM gcr.io/distroless/static-debian12:nonroot
COPY --from=builder /app/binary /app

# 或: Alpine
FROM alpine:3.19
RUN apk add --no-cache ca-certificates
COPY --from=builder /app/binary /app
```

#### 2. **多阶段构建 + 非root用户**

```dockerfile
# Dockerfile (安全最佳实践)
FROM golang:1.21 AS builder
WORKDIR /build
COPY . .
RUN CGO_ENABLED=0 go build -o app .

FROM gcr.io/distroless/static-debian12:nonroot
COPY --from=builder /build/app /app
USER nonroot:nonroot
ENTRYPOINT ["/app"]
```

#### 3. **签名和验证**

```bash
# 构建、签名、推送
docker build -t myorg/app:v1.0.0 .
docker push myorg/app:v1.0.0
cosign sign myorg/app:v1.0.0
```

---

### 运行时安全

#### 1. **Pod Security Standards**

```yaml
# pod-security-standards.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
```

#### 2. **AppArmor/SELinux**

```yaml
# apparmor-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: secure-pod
  annotations:
    container.apparmor.security.beta.kubernetes.io/app: runtime/default
spec:
  securityContext:
    seLinuxOptions:
      level: "s0:c123,c456"
  containers:
  - name: app
    image: myapp:latest
    securityContext:
      allowPrivilegeEscalation: false
      runAsNonRoot: true
      runAsUser: 1000
      capabilities:
        drop:
        - ALL
      seccompProfile:
        type: RuntimeDefault
```

---

### 网络安全

#### 1. **NetworkPolicy**

```yaml
# network-policy-default-deny.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend-to-backend
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: frontend
    ports:
    - protocol: TCP
      port: 8080
```

---

### 数据安全

#### 1. **密钥加密 (KMS)**

```yaml
# encryption-config.yaml
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
- resources:
  - secrets
  providers:
  - kms:
      name: aws-kms
      endpoint: unix:///var/run/kmsplugin/socket.sock
      cachesize: 1000
  - identity: {}
```

#### 2. **External Secrets Operator**

```yaml
# external-secret.yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: database-credentials
    creationPolicy: Owner
  data:
  - secretKey: password
    remoteRef:
      key: prod/database/password
```

---

## 安全合规框架

### CIS Benchmarks

```bash
# 使用kube-bench检查CIS Kubernetes Benchmark
kubectl apply -f https://raw.githubusercontent.com/aquasecurity/kube-bench/main/job.yaml
kubectl logs -f job/kube-bench
```

### PCI DSS

**PCI DSS合规要求**:

- ✅ 网络隔离 (NetworkPolicy)
- ✅ 访问控制 (RBAC)
- ✅ 日志审计 (Audit Logs)
- ✅ 数据加密 (KMS)

### SOC 2

**SOC 2合规要求**:

- ✅ 安全监控 (Falco/Tetragon)
- ✅ 变更管理 (GitOps)
- ✅ 事件响应 (告警流程)
- ✅ 数据备份 (Velero)

---

## 安全生产案例

### 案例1：供应链攻击防御

**背景**: 某金融公司防御供应链攻击

**安全措施**:

1. **镜像签名强制验证**:

   ```yaml
   # Kyverno策略
   apiVersion: kyverno.io/v1
   kind: ClusterPolicy
   metadata:
     name: require-signed-images
   spec:
     validationFailureAction: Enforce
     rules:
     - name: verify-signature
       match:
         any:
         - resources:
             kinds: [Pod]
       verifyImages:
       - imageReferences: ["*"]
         attestors:
         - entries:
           - keyless:
               issuer: "https://github.com/login/oauth"
               rekor:
                 url: https://rekor.sigstore.dev
   ```

2. **SBOM强制生成**:

   ```bash
   # CI/CD流水线
   syft $IMAGE -o cyclonedx-json > sbom.json
   cosign attach sbom --sbom sbom.json $IMAGE
   ```

3. **漏洞扫描门禁**:

   ```bash
   # CI/CD失败条件
   trivy image --exit-code 1 --severity CRITICAL $IMAGE
   ```

**效果**:

- ✅ 100%镜像签名率
- ✅ 100% SBOM覆盖率
- ✅ 0个CRITICAL漏洞进入生产

---

### 案例2：零信任安全架构

**背景**: 某电商公司实施零信任架构

**架构**:

```text
┌─────────────────────────────────────────────────┐
│  零信任架构                                      │
│  ┌───────────────────────────────────────────┐  │
│  │  身份层 (SPIFFE/SPIRE)                    │  │
│  │  - 工作负载身份 (SVID)                     │  │
│  │  - 短期证书 (1小时TTL)                     │  │
│  └───────────────────────────────────────────┘  │
│                     ↓                            │
│  ┌───────────────────────────────────────────┐  │
│  │  传输层 (Istio Ambient mTLS)              │  │
│  │  - 自动mTLS                               │  │
│  │  - 无Sidecar                              │  │
│  └───────────────────────────────────────────┘  │
│                     ↓                            │
│  ┌───────────────────────────────────────────┐  │
│  │  策略层 (OPA/Kyverno)                     │  │
│  │  - 细粒度授权                             │  │
│  │  - 动态策略                               │  │
│  └───────────────────────────────────────────┘  │
│                     ↓                            │
│  ┌───────────────────────────────────────────┐  │
│  │  监控层 (Falco/Tetragon)                  │  │
│  │  - 运行时行为监控                         │  │
│  │  - 实时告警                               │  │
│  └───────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
```

**效果**:

- ✅ 100% mTLS覆盖率
- ✅ 工作负载身份自动化
- ✅ 安全事件响应时间 <5分钟

---

## 安全未来趋势

### 1. **供应链安全标准化**

- ✅ SBOM强制要求 (美国EO 14028)
- ✅ SLSA Level 3成为行业标准
- ✅ Sigstore生态成熟

### 2. **eBPF驱动安全**

- ✅ 内核级安全策略
- ✅ 零性能开销
- ✅ 运行时保护标配

### 3. **AI辅助安全**

- ✅ 智能漏洞优先级
- ✅ 异常行为检测
- ✅ 自动化响应

### 4. **零信任主流化**

- ✅ SPIFFE/SPIRE标准化
- ✅ Ambient Mesh无Sidecar
- ✅ 工作负载身份普及

---

## 相关资源

### 官方文档

- [Sigstore官网](https://www.sigstore.dev/)
- [SLSA官网](https://slsa.dev/)
- [GUAC官网](https://guac.sh/)
- [Trivy官网](https://trivy.dev/)
- [Falco官网](https://falco.org/)

### GitHub仓库

- [Cosign GitHub](https://github.com/sigstore/cosign)
- [Trivy GitHub](https://github.com/aquasecurity/trivy)
- [Kyverno GitHub](https://github.com/kyverno/kyverno)
- [Falco GitHub](https://github.com/falcosecurity/falco)

### 学习资源

- [CNCF Security TAG](https://github.com/cncf/tag-security)
- [Kubernetes Security Best Practices](https://kubernetes.io/docs/concepts/security/)

---

**更新时间**: 2025-10-20  
**文档版本**: v1.0  
**状态**: ✅ **完成 - 2025云原生安全标准全面对齐**

---

**🔒 安全是云原生的基石，供应链安全和零信任架构是2025年的重点！**
