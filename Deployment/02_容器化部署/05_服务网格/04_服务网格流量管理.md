# æœåŠ¡ç½‘æ ¼æµé‡ç®¡ç†

> **è¿”å›**: [æœåŠ¡ç½‘æ ¼é¦–é¡µ](README.md) | [å®¹å™¨åŒ–éƒ¨ç½²é¦–é¡µ](../README.md) | [éƒ¨ç½²æŒ‡å—é¦–é¡µ](../../00_ç´¢å¼•å¯¼èˆª/README.md)

---

## ğŸ“‹ ç›®å½•

- [æœåŠ¡ç½‘æ ¼æµé‡ç®¡ç†](#æœåŠ¡ç½‘æ ¼æµé‡ç®¡ç†)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æµé‡ç®¡ç†æ¦‚è¿°](#1-æµé‡ç®¡ç†æ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯æµé‡ç®¡ç†](#11-ä»€ä¹ˆæ˜¯æµé‡ç®¡ç†)
    - [1.2 æ ¸å¿ƒèƒ½åŠ›](#12-æ ¸å¿ƒèƒ½åŠ›)
    - [1.3 ä½¿ç”¨åœºæ™¯](#13-ä½¿ç”¨åœºæ™¯)
  - [2. é‡‘ä¸é›€å‘å¸ƒ (Canary Release)](#2-é‡‘ä¸é›€å‘å¸ƒ-canary-release)
    - [2.1 æ¦‚è¿°](#21-æ¦‚è¿°)
    - [2.2 Istio å®ç°](#22-istio-å®ç°)
    - [2.3 Linkerd å®ç°](#23-linkerd-å®ç°)
    - [2.4 Flagger è‡ªåŠ¨åŒ–é‡‘ä¸é›€](#24-flagger-è‡ªåŠ¨åŒ–é‡‘ä¸é›€)
  - [3. è“ç»¿éƒ¨ç½² (Blue-Green Deployment)](#3-è“ç»¿éƒ¨ç½²-blue-green-deployment)
    - [3.1 æ¦‚è¿°](#31-æ¦‚è¿°)
    - [3.2 Istio å®ç°](#32-istio-å®ç°)
    - [3.3 Linkerd å®ç°](#33-linkerd-å®ç°)
  - [4. A/B æµ‹è¯• (A/B Testing)](#4-ab-æµ‹è¯•-ab-testing)
    - [4.1 æ¦‚è¿°](#41-æ¦‚è¿°)
    - [4.2 åŸºäºè¯·æ±‚å¤´çš„ A/B æµ‹è¯•](#42-åŸºäºè¯·æ±‚å¤´çš„-ab-æµ‹è¯•)
    - [4.3 åŸºäº Cookie çš„ A/B æµ‹è¯•](#43-åŸºäº-cookie-çš„-ab-æµ‹è¯•)
  - [5. æµé‡é•œåƒ (Traffic Mirroring)](#5-æµé‡é•œåƒ-traffic-mirroring)
    - [5.1 æ¦‚è¿°](#51-æ¦‚è¿°)
    - [5.2 Istio å®ç°](#52-istio-å®ç°)
    - [5.3 åº”ç”¨åœºæ™¯](#53-åº”ç”¨åœºæ™¯)
  - [6. ç†”æ–­ (Circuit Breaking)](#6-ç†”æ–­-circuit-breaking)
    - [6.1 æ¦‚è¿°](#61-æ¦‚è¿°)
    - [6.2 Istio ç†”æ–­é…ç½®](#62-istio-ç†”æ–­é…ç½®)
    - [6.3 Linkerd ç†”æ–­é…ç½®](#63-linkerd-ç†”æ–­é…ç½®)
  - [7. é™æµ (Rate Limiting)](#7-é™æµ-rate-limiting)
    - [7.1 æ¦‚è¿°](#71-æ¦‚è¿°)
    - [7.2 æœ¬åœ°é™æµ (Envoy)](#72-æœ¬åœ°é™æµ-envoy)
    - [7.3 å…¨å±€é™æµ (Redis)](#73-å…¨å±€é™æµ-redis)
  - [8. è¶…æ—¶ä¸é‡è¯•](#8-è¶…æ—¶ä¸é‡è¯•)
    - [8.1 è¶…æ—¶é…ç½®](#81-è¶…æ—¶é…ç½®)
    - [8.2 é‡è¯•ç­–ç•¥](#82-é‡è¯•ç­–ç•¥)
  - [9. æ•…éšœæ³¨å…¥ (Fault Injection)](#9-æ•…éšœæ³¨å…¥-fault-injection)
    - [9.1 æ¦‚è¿°](#91-æ¦‚è¿°)
    - [9.2 å»¶è¿Ÿæ³¨å…¥](#92-å»¶è¿Ÿæ³¨å…¥)
    - [9.3 é”™è¯¯æ³¨å…¥](#93-é”™è¯¯æ³¨å…¥)
  - [10. å®æˆ˜æ¡ˆä¾‹](#10-å®æˆ˜æ¡ˆä¾‹)
    - [10.1 å¾®æœåŠ¡æ¸è¿›å¼å‡çº§](#101-å¾®æœåŠ¡æ¸è¿›å¼å‡çº§)
    - [10.2 å¤šç‰ˆæœ¬ç°åº¦æµ‹è¯•](#102-å¤šç‰ˆæœ¬ç°åº¦æµ‹è¯•)
    - [10.3 æµé‡é˜²æŠ¤ä¸é™çº§](#103-æµé‡é˜²æŠ¤ä¸é™çº§)
  - [11. æœ€ä½³å®è·µ](#11-æœ€ä½³å®è·µ)
    - [11.1 å‘å¸ƒç­–ç•¥é€‰æ‹©](#111-å‘å¸ƒç­–ç•¥é€‰æ‹©)
    - [11.2 ç›‘æ§ä¸å›æ»š](#112-ç›‘æ§ä¸å›æ»š)
    - [11.3 è‡ªåŠ¨åŒ–æµç¨‹](#113-è‡ªåŠ¨åŒ–æµç¨‹)
  - [æ€»ç»“](#æ€»ç»“)

---

## 1. æµé‡ç®¡ç†æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯æµé‡ç®¡ç†

**æµé‡ç®¡ç†** æ˜¯æœåŠ¡ç½‘æ ¼çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå…è®¸ç²¾ç»†æ§åˆ¶æœåŠ¡é—´çš„æµé‡è·¯ç”±ã€åˆ†é…å’Œè¡Œä¸ºï¼Œæ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç ã€‚

**æ ¸å¿ƒåŸç†**:

```text
ç”¨æˆ·è¯·æ±‚
    â†“
Ingress Gateway / LoadBalancer
    â†“
Virtual Service (è·¯ç”±è§„åˆ™)
    â†“
Destination Rule (ç›®æ ‡ç­–ç•¥)
    â†“
æœåŠ¡å®ä¾‹ (v1/v2/v3)
```

---

### 1.2 æ ¸å¿ƒèƒ½åŠ›

| èƒ½åŠ› | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|-----|------|---------|
| **æµé‡åˆ†å‰²** | æŒ‰æƒé‡/ç™¾åˆ†æ¯”åˆ†é…æµé‡ | é‡‘ä¸é›€å‘å¸ƒ |
| **æ¡ä»¶è·¯ç”±** | åŸºäºè¯·æ±‚å¤´/è·¯å¾„/å‚æ•°è·¯ç”± | A/B æµ‹è¯• |
| **æµé‡é•œåƒ** | å¤åˆ¶æµé‡åˆ°æµ‹è¯•ç‰ˆæœ¬ | ç”Ÿäº§ç¯å¢ƒæµ‹è¯• |
| **ç†”æ–­** | å¿«é€Ÿå¤±è´¥ï¼Œé˜²æ­¢çº§è”æ•…éšœ | æ•…éšœéš”ç¦» |
| **é‡è¯•** | è‡ªåŠ¨é‡è¯•å¤±è´¥è¯·æ±‚ | æå‡æˆåŠŸç‡ |
| **è¶…æ—¶** | é™åˆ¶è¯·æ±‚ç­‰å¾…æ—¶é—´ | é˜²æ­¢èµ„æºè€—å°½ |
| **é™æµ** | é™åˆ¶è¯·æ±‚é€Ÿç‡ | é˜²æ­¢è¿‡è½½ |
| **æ•…éšœæ³¨å…¥** | äººä¸ºæ³¨å…¥å»¶è¿Ÿ/é”™è¯¯ | æ··æ²Œå·¥ç¨‹ |

---

### 1.3 ä½¿ç”¨åœºæ™¯

**ç‰ˆæœ¬å‘å¸ƒ**:

- é‡‘ä¸é›€å‘å¸ƒ (Canary Release)
- è“ç»¿éƒ¨ç½² (Blue-Green Deployment)
- ç°åº¦å‘å¸ƒ (Progressive Rollout)

**åŠŸèƒ½æµ‹è¯•**:

- A/B æµ‹è¯•
- æµé‡é•œåƒ (Shadow Testing)

**å¼¹æ€§ä¿éšœ**:

- ç†”æ–­ (Circuit Breaking)
- é™æµ (Rate Limiting)
- è¶…æ—¶ä¸é‡è¯•

---

## 2. é‡‘ä¸é›€å‘å¸ƒ (Canary Release)

### 2.1 æ¦‚è¿°

**é‡‘ä¸é›€å‘å¸ƒ** æ˜¯ä¸€ç§æ¸è¿›å¼å‘å¸ƒç­–ç•¥ï¼Œå…ˆå°†å°‘é‡æµé‡ (å¦‚ 5-10%) å¼•å¯¼åˆ°æ–°ç‰ˆæœ¬ï¼ŒéªŒè¯æ— é—®é¢˜åé€æ­¥å¢åŠ æµé‡ï¼Œæœ€ç»ˆå…¨é‡åˆ‡æ¢ã€‚

**æµç¨‹**:

```text
1. éƒ¨ç½²æ–°ç‰ˆæœ¬ (v2)
2. 5% æµé‡åˆ° v2, 95% åˆ° v1
3. ç›‘æ§ v2 æŒ‡æ ‡ (é”™è¯¯ç‡/å»¶è¿Ÿ)
4. é€æ­¥å¢åŠ  v2 æµé‡: 10% â†’ 25% â†’ 50% â†’ 100%
5. å…¨é‡åˆ‡æ¢åˆ° v2ï¼Œä¸‹çº¿ v1
```

**ä¼˜ç‚¹**:

- âœ… é£é™©å¯æ§ (å½±å“èŒƒå›´å°)
- âœ… å¯å¿«é€Ÿå›æ»š
- âœ… åŸºäºçœŸå®æµé‡éªŒè¯

---

### 2.2 Istio å®ç°

**æ­¥éª¤1: éƒ¨ç½²ä¸¤ä¸ªç‰ˆæœ¬**:

```yaml
# v1 Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
spec:
  replicas: 3
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      containers:
      - name: reviews
        image: reviews:v1
---
# v2 Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v2
  template:
    metadata:
      labels:
        app: reviews
        version: v2
    spec:
      containers:
      - name: reviews
        image: reviews:v2
---
# Service
apiVersion: v1
kind: Service
metadata:
  name: reviews
spec:
  selector:
    app: reviews
  ports:
  - port: 9080
```

**æ­¥éª¤2: å®šä¹‰ Subset (DestinationRule)**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

**æ­¥éª¤3: é…ç½®æµé‡åˆ†å‰² (VirtualService)**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 90  # 90% æµé‡åˆ° v1
    - destination:
        host: reviews
        subset: v2
      weight: 10  # 10% æµé‡åˆ° v2 (é‡‘ä¸é›€)
```

**æ­¥éª¤4: é€æ­¥å¢åŠ æµé‡**:

```bash
# 25% æµé‡åˆ° v2
kubectl patch virtualservice reviews --type merge -p '
{
  "spec": {
    "http": [
      {
        "route": [
          {"destination": {"host": "reviews", "subset": "v1"}, "weight": 75},
          {"destination": {"host": "reviews", "subset": "v2"}, "weight": 25}
        ]
      }
    ]
  }
}'

# 50% æµé‡åˆ° v2
# ... (ç±»ä¼¼æ“ä½œ)

# 100% æµé‡åˆ° v2
kubectl patch virtualservice reviews --type merge -p '
{
  "spec": {
    "http": [
      {
        "route": [
          {"destination": {"host": "reviews", "subset": "v2"}, "weight": 100}
        ]
      }
    ]
  }
}'
```

---

### 2.3 Linkerd å®ç°

**ä½¿ç”¨ SMI TrafficSplit**:

```yaml
# v1 Service
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1
spec:
  selector:
    app: reviews
    version: v1
  ports:
  - port: 9080
---
# v2 Service
apiVersion: v1
kind: Service
metadata:
  name: reviews-v2
spec:
  selector:
    app: reviews
    version: v2
  ports:
  - port: 9080
---
# ä¸» Service
apiVersion: v1
kind: Service
metadata:
  name: reviews
spec:
  selector:
    app: reviews
  ports:
  - port: 9080
---
# TrafficSplit
apiVersion: split.smi-spec.io/v1alpha1
kind: TrafficSplit
metadata:
  name: reviews-canary
spec:
  service: reviews
  backends:
  - service: reviews-v1
    weight: 900  # 90%
  - service: reviews-v2
    weight: 100  # 10%
```

**éªŒè¯é‡‘ä¸é›€**:

```bash
# æŸ¥çœ‹æµé‡åˆ†é…
linkerd viz stat trafficsplit

# è¾“å‡º
NAME              APEX      LEAF         WEIGHT   SUCCESS      RPS
reviews-canary    reviews   reviews-v1    900m   100.00%   9.0rps
                            reviews-v2    100m   100.00%   1.0rps
```

---

### 2.4 Flagger è‡ªåŠ¨åŒ–é‡‘ä¸é›€

**å®‰è£… Flagger** (æ”¯æŒ Istio/Linkerd):

```bash
# å®‰è£… Flagger
kubectl apply -k github.com/fluxcd/flagger//kustomize/linkerd

# æˆ– Helm å®‰è£…
helm repo add flagger https://flagger.app
helm install flagger flagger/flagger \
  --namespace linkerd \
  --set meshProvider=linkerd \
  --set metricsServer=http://linkerd-prometheus:9090
```

**é…ç½®è‡ªåŠ¨é‡‘ä¸é›€**:

```yaml
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: reviews
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews
  progressDeadlineSeconds: 60
  service:
    port: 9080
  analysis:
    interval: 1m      # æ£€æŸ¥é—´éš”
    threshold: 5      # è¿ç»­æˆåŠŸ 5 æ¬¡æ‰å¢åŠ æµé‡
    maxWeight: 50     # æœ€å¤§é‡‘ä¸é›€æƒé‡ 50%
    stepWeight: 10    # æ¯æ¬¡å¢åŠ  10%
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: 99       # æˆåŠŸç‡ â‰¥ 99%
      interval: 1m
    - name: request-duration
      thresholdRange:
        max: 500      # P99 å»¶è¿Ÿ â‰¤ 500ms
      interval: 1m
```

**å·¥ä½œæµç¨‹**:

```text
1. éƒ¨ç½²æ–°ç‰ˆæœ¬ (v2)
        â†“
2. Flagger è‡ªåŠ¨åˆ›å»º v2 å®ä¾‹
        â†“
3. æŒ‰æ­¥é•¿å¢åŠ æµé‡: 10% â†’ 20% â†’ 30% â†’ 40% â†’ 50%
        â†“
4. æ¯æ¬¡å¢åŠ åæ£€æŸ¥æŒ‡æ ‡ (æˆåŠŸç‡/å»¶è¿Ÿ)
        â†“
5. å¦‚æœæŒ‡æ ‡å¼‚å¸¸ï¼Œè‡ªåŠ¨å›æ»šåˆ° v1
        â†“
6. å¦‚æœæŒ‡æ ‡æ­£å¸¸ï¼Œæœ€ç»ˆåˆ‡æ¢åˆ° v2
```

---

## 3. è“ç»¿éƒ¨ç½² (Blue-Green Deployment)

### 3.1 æ¦‚è¿°

**è“ç»¿éƒ¨ç½²** æ˜¯åŒæ—¶è¿è¡Œä¸¤ä¸ªç‰ˆæœ¬ (è“è‰²=å½“å‰ç‰ˆæœ¬, ç»¿è‰²=æ–°ç‰ˆæœ¬)ï¼Œé€šè¿‡ä¸€æ¬¡æ€§åˆ‡æ¢æµé‡æ¥å‘å¸ƒæ–°ç‰ˆæœ¬ã€‚

**æµç¨‹**:

```text
1. éƒ¨ç½²ç»¿è‰²ç‰ˆæœ¬ (v2)
2. éªŒè¯ç»¿è‰²ç‰ˆæœ¬æ­£å¸¸
3. ä¸€æ¬¡æ€§åˆ‡æ¢å…¨éƒ¨æµé‡åˆ°ç»¿è‰²ç‰ˆæœ¬
4. ä¿ç•™è“è‰²ç‰ˆæœ¬ä¸€æ®µæ—¶é—´ (ä»¥å¤‡å›æ»š)
5. ä¸‹çº¿è“è‰²ç‰ˆæœ¬
```

**ä¼˜ç‚¹**:

- âœ… åˆ‡æ¢å¿«é€Ÿ (ç§’çº§)
- âœ… å›æ»šç®€å• (åˆ‡å›è“è‰²)
- âŒ èµ„æºå ç”¨é«˜ (åŒå€èµ„æº)

---

### 3.2 Istio å®ç°

```yaml
# åˆå§‹çŠ¶æ€: 100% æµé‡åˆ° v1 (è“è‰²)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
---
# åˆ‡æ¢åˆ° v2 (ç»¿è‰²)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v2
      weight: 100
```

**æ“ä½œå‘½ä»¤**:

```bash
# ä¸€é”®åˆ‡æ¢åˆ° v2
kubectl patch virtualservice reviews --type merge -p '
{
  "spec": {
    "http": [
      {
        "route": [
          {"destination": {"host": "reviews", "subset": "v2"}, "weight": 100}
        ]
      }
    ]
  }
}'

# å¦‚éœ€å›æ»šï¼Œä¸€é”®åˆ‡å› v1
kubectl patch virtualservice reviews --type merge -p '
{
  "spec": {
    "http": [
      {
        "route": [
          {"destination": {"host": "reviews", "subset": "v1"}, "weight": 100}
        ]
      }
    ]
  }
}'
```

---

### 3.3 Linkerd å®ç°

```yaml
# åˆå§‹çŠ¶æ€: 100% v1
apiVersion: split.smi-spec.io/v1alpha1
kind: TrafficSplit
metadata:
  name: reviews
spec:
  service: reviews
  backends:
  - service: reviews-v1
    weight: 1000  # 100%
  - service: reviews-v2
    weight: 0     # 0%
---
# åˆ‡æ¢åˆ° v2
apiVersion: split.smi-spec.io/v1alpha1
kind: TrafficSplit
metadata:
  name: reviews
spec:
  service: reviews
  backends:
  - service: reviews-v1
    weight: 0     # 0%
  - service: reviews-v2
    weight: 1000  # 100%
```

---

## 4. A/B æµ‹è¯• (A/B Testing)

### 4.1 æ¦‚è¿°

**A/B æµ‹è¯•** æ˜¯æ ¹æ®ç”¨æˆ·ç‰¹å¾ (è¯·æ±‚å¤´/Cookie/åœ°ç†ä½ç½®ç­‰) å°†ä¸åŒç”¨æˆ·è·¯ç”±åˆ°ä¸åŒç‰ˆæœ¬ï¼Œä»¥æ¯”è¾ƒåŠŸèƒ½æ•ˆæœã€‚

**å…¸å‹åœºæ™¯**:

- VIP ç”¨æˆ·ä½¿ç”¨æ–°åŠŸèƒ½ï¼Œæ™®é€šç”¨æˆ·ä½¿ç”¨æ—§ç‰ˆæœ¬
- åœ°åŸŸ A ä½¿ç”¨ç‰ˆæœ¬ Aï¼Œåœ°åŸŸ B ä½¿ç”¨ç‰ˆæœ¬ B
- æµ‹è¯•æ–° UI å¯¹è½¬åŒ–ç‡çš„å½±å“

---

### 4.2 åŸºäºè¯·æ±‚å¤´çš„ A/B æµ‹è¯•

**Istio å®ç°**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - match:
    - headers:
        user:
          exact: "vip"  # VIP ç”¨æˆ·
    route:
    - destination:
        host: reviews
        subset: v2      # VIP ç”¨æˆ·è®¿é—® v2 (æ–°åŠŸèƒ½)
  - route:
    - destination:
        host: reviews
        subset: v1      # é»˜è®¤è®¿é—® v1
```

**éªŒè¯**:

```bash
# VIP ç”¨æˆ·è®¿é—® v2
curl -H "user: vip" http://reviews:9080/

# æ™®é€šç”¨æˆ·è®¿é—® v1
curl http://reviews:9080/
```

---

### 4.3 åŸºäº Cookie çš„ A/B æµ‹è¯•

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - match:
    - headers:
        cookie:
          regex: ".*experiment=v2.*"  # Cookie åŒ…å« experiment=v2
    route:
    - destination:
        host: reviews
        subset: v2
  - route:
    - destination:
        host: reviews
        subset: v1
```

---

## 5. æµé‡é•œåƒ (Traffic Mirroring)

### 5.1 æ¦‚è¿°

**æµé‡é•œåƒ** (Shadow Traffic) å°†ç”Ÿäº§æµé‡å¤åˆ¶ä¸€ä»½å‘é€åˆ°æµ‹è¯•ç‰ˆæœ¬ï¼Œä½†ä¸å½±å“å®é™…å“åº”ã€‚ç”¨äºåœ¨çœŸå®æµé‡ä¸‹éªŒè¯æ–°ç‰ˆæœ¬ã€‚

**ç‰¹ç‚¹**:

- âœ… é›¶é£é™© (å“åº”ä¸è¿”å›ç»™ç”¨æˆ·)
- âœ… çœŸå®æµé‡æµ‹è¯•
- âœ… ä¸å½±å“ç”Ÿäº§æ€§èƒ½

---

### 5.2 Istio å®ç°

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 100  # 100% æµé‡åˆ° v1 (ç”Ÿäº§)
    mirror:
      host: reviews
      subset: v2   # é•œåƒæµé‡åˆ° v2 (æµ‹è¯•)
    mirrorPercentage:
      value: 100.0 # é•œåƒ 100% æµé‡
```

**æ³¨æ„äº‹é¡¹**:

- é•œåƒæµé‡æ˜¯ **Fire-and-Forget** (å‘é€åä¸ç­‰å¾…å“åº”)
- ä¸å½±å“ä¸»è¯·æ±‚çš„å»¶è¿Ÿ
- v2 çš„é”™è¯¯ä¸ä¼šå½±å“ç”¨æˆ·

---

### 5.3 åº”ç”¨åœºæ™¯

**åœºæ™¯1: æ–°ç‰ˆæœ¬å‹åŠ›æµ‹è¯•**:

```yaml
# é•œåƒ 50% æµé‡åˆ° v2 è¿›è¡Œå‹æµ‹
mirror:
  host: reviews
  subset: v2
mirrorPercentage:
  value: 50.0
```

**åœºæ™¯2: æ•°æ®åº“è¿ç§»éªŒè¯**:

```yaml
# é•œåƒæµé‡åˆ°æ–°æ•°æ®åº“ç‰ˆæœ¬ï¼ŒéªŒè¯å…¼å®¹æ€§
mirror:
  host: reviews-new-db
  subset: v2
```

---

## 6. ç†”æ–­ (Circuit Breaking)

### 6.1 æ¦‚è¿°

**ç†”æ–­** æ˜¯ä¸€ç§ä¿æŠ¤æœºåˆ¶ï¼Œå½“æ£€æµ‹åˆ°æœåŠ¡å¼‚å¸¸æ—¶å¿«é€Ÿå¤±è´¥ï¼Œé˜²æ­¢çº§è”æ•…éšœã€‚

**ç†”æ–­çŠ¶æ€**:

```text
å…³é—­ (Closed) â†’ æ‰“å¼€ (Open) â†’ åŠå¼€ (Half-Open)
        â†‘                â†“
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å·¥ä½œæµç¨‹**:

```text
1. æ­£å¸¸çŠ¶æ€: ç†”æ–­å™¨å…³é—­ï¼Œè¯·æ±‚æ­£å¸¸é€šè¿‡
2. é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼ (å¦‚ 5 æ¬¡ 5xx é”™è¯¯)
3. ç†”æ–­å™¨æ‰“å¼€ï¼Œå¿«é€Ÿå¤±è´¥ (è¿”å› 503)
4. ç­‰å¾…ä¸€æ®µæ—¶é—´ (30 ç§’)
5. è¿›å…¥åŠå¼€çŠ¶æ€ï¼Œå…è®¸å°‘é‡è¯·æ±‚æµ‹è¯•
6. å¦‚æœæµ‹è¯•æˆåŠŸï¼Œæ¢å¤å…³é—­çŠ¶æ€
7. å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œç»§ç»­æ‰“å¼€çŠ¶æ€
```

---

### 6.2 Istio ç†”æ–­é…ç½®

```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100       # æœ€å¤§è¿æ¥æ•°
      http:
        http1MaxPendingRequests: 10  # æœ€å¤§æŒ‚èµ·è¯·æ±‚
        http2MaxRequests: 100
        maxRequestsPerConnection: 2
    outlierDetection:
      consecutive5xxErrors: 5     # è¿ç»­ 5 æ¬¡ 5xx é”™è¯¯
      interval: 30s               # æ£€æµ‹é—´éš”
      baseEjectionTime: 30s       # é©±é€æ—¶é—´ (ç†”æ–­æŒç»­æ—¶é—´)
      maxEjectionPercent: 50      # æœ€å¤šé©±é€ 50% å®ä¾‹
      minHealthPercent: 10        # æœ€å°‘ä¿ç•™ 10% å¥åº·å®ä¾‹
```

**éªŒè¯ç†”æ–­**:

```bash
# ç”Ÿæˆå¤§é‡å¹¶å‘è¯·æ±‚è§¦å‘ç†”æ–­
kubectl run fortio --image=fortio/fortio --command -- \
  fortio load -c 100 -qps 0 -n 1000 http://reviews:9080/

# æŸ¥çœ‹ç†”æ–­æŒ‡æ ‡
kubectl exec fortio -- fortio report

# è¾“å‡º
# éƒ¨åˆ†è¯·æ±‚è¿”å› 503 (ç†”æ–­ç”Ÿæ•ˆ)
Code 200 : 950 (95.0 %)
Code 503 : 50 (5.0 %)
```

---

### 6.3 Linkerd ç†”æ–­é…ç½®

**Linkerd ä½¿ç”¨ Server å’Œ HTTPRoute**:

```yaml
apiVersion: policy.linkerd.io/v1alpha1
kind: Server
metadata:
  name: reviews-server
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: reviews
  port: 9080
  proxyProtocol: HTTP/2
---
apiVersion: policy.linkerd.io/v1beta1
kind: HTTPRoute
metadata:
  name: reviews-route
  namespace: default
spec:
  parentRefs:
  - name: reviews-server
    kind: Server
    group: policy.linkerd.io
  rules:
  - backendRefs:
    - name: reviews
      port: 9080
    timeouts:
      request: 10s
      backendRequest: 5s
    retry:
      codes: [503, 504]
      maxRetries: 3
```

---

## 7. é™æµ (Rate Limiting)

### 7.1 æ¦‚è¿°

**é™æµ** ç”¨äºé˜²æ­¢æœåŠ¡è¿‡è½½ï¼Œé™åˆ¶å•ä½æ—¶é—´å†…çš„è¯·æ±‚æ•°é‡ã€‚

**é™æµç±»å‹**:

- **æœ¬åœ°é™æµ**: Envoy ä»£ç†æœ¬åœ°è®¡æ•° (é€‚åˆå•æœºåœºæ™¯)
- **å…¨å±€é™æµ**: ä½¿ç”¨ Redis ç­‰åˆ†å¸ƒå¼å­˜å‚¨ (é€‚åˆé›†ç¾¤åœºæ™¯)

---

### 7.2 æœ¬åœ°é™æµ (Envoy)

**Istio EnvoyFilter**:

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: filter-local-ratelimit-svc
  namespace: default
spec:
  workloadSelector:
    labels:
      app: reviews
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.local_ratelimit
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
          value:
            stat_prefix: http_local_rate_limiter
            token_bucket:
              max_tokens: 100       # æ¡¶å®¹é‡ 100
              tokens_per_fill: 100
              fill_interval: 1s     # æ¯ç§’è¡¥å…… 100 ä¸ªä»¤ç‰Œ (å³ 100 RPS)
            filter_enabled:
              runtime_key: local_rate_limit_enabled
              default_value:
                numerator: 100
                denominator: HUNDRED
            filter_enforced:
              runtime_key: local_rate_limit_enforced
              default_value:
                numerator: 100
                denominator: HUNDRED
            response_headers_to_add:
            - append: false
              header:
                key: x-local-rate-limit
                value: 'true'
```

---

### 7.3 å…¨å±€é™æµ (Redis)

**éƒ¨ç½² Redis**:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:alpine
        ports:
        - containerPort: 6379
---
apiVersion: v1
kind: Service
metadata:
  name: redis
spec:
  selector:
    app: redis
  ports:
  - port: 6379
```

**é…ç½®å…¨å±€é™æµ** (å¤æ‚ï¼Œéœ€Envoy RateLimitæœåŠ¡):

```yaml
# éƒ¨ç½² Envoy Rate Limit Service
# (ç•¥ï¼Œè¯¦è§ Istio å®˜æ–¹æ–‡æ¡£)
```

---

## 8. è¶…æ—¶ä¸é‡è¯•

### 8.1 è¶…æ—¶é…ç½®

**Istio è¶…æ—¶**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - timeout: 10s  # è¯·æ±‚è¶…æ—¶ 10 ç§’
    route:
    - destination:
        host: reviews
        subset: v1
```

**Linkerd è¶…æ—¶**:

```yaml
apiVersion: policy.linkerd.io/v1beta1
kind: HTTPRoute
metadata:
  name: reviews-route
spec:
  rules:
  - timeouts:
      request: 10s
      backendRequest: 5s
```

---

### 8.2 é‡è¯•ç­–ç•¥

**Istio é‡è¯•**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - retries:
      attempts: 3             # é‡è¯• 3 æ¬¡
      perTryTimeout: 2s       # æ¯æ¬¡é‡è¯•è¶…æ—¶ 2 ç§’
      retryOn: 5xx,reset,connect-failure  # é‡è¯•æ¡ä»¶
    route:
    - destination:
        host: reviews
        subset: v1
```

**Linkerd é‡è¯•**:

```yaml
apiVersion: linkerd.io/v1alpha2
kind: ServiceProfile
metadata:
  name: reviews.default.svc.cluster.local
spec:
  routes:
  - name: GET /api
    condition:
      method: GET
      pathRegex: /api/.*
    isRetryable: true
    timeout: 10s
    retryBudget:
      retryRatio: 0.2         # æœ€å¤šé‡è¯• 20% è¯·æ±‚
      minRetriesPerSecond: 10
      ttl: 10s
```

---

## 9. æ•…éšœæ³¨å…¥ (Fault Injection)

### 9.1 æ¦‚è¿°

**æ•…éšœæ³¨å…¥** ç”¨äºæµ‹è¯•ç³»ç»Ÿåœ¨å¼‚å¸¸æƒ…å†µä¸‹çš„è¡Œä¸º (æ··æ²Œå·¥ç¨‹)ã€‚

**æ³¨å…¥ç±»å‹**:

- **å»¶è¿Ÿæ³¨å…¥**: æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ/æ…¢æŸ¥è¯¢
- **é”™è¯¯æ³¨å…¥**: æ¨¡æ‹ŸæœåŠ¡æ•…éšœ (500 é”™è¯¯)

---

### 9.2 å»¶è¿Ÿæ³¨å…¥

**Istio å»¶è¿Ÿæ³¨å…¥**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - fault:
      delay:
        percentage:
          value: 10.0  # 10% è¯·æ±‚å»¶è¿Ÿ
        fixedDelay: 5s # å»¶è¿Ÿ 5 ç§’
    route:
    - destination:
        host: reviews
        subset: v1
```

---

### 9.3 é”™è¯¯æ³¨å…¥

**Istio é”™è¯¯æ³¨å…¥**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - fault:
      abort:
        percentage:
          value: 10.0  # 10% è¯·æ±‚è¿”å›é”™è¯¯
        httpStatus: 500  # è¿”å› 500 é”™è¯¯
    route:
    - destination:
        host: reviews
        subset: v1
```

---

## 10. å®æˆ˜æ¡ˆä¾‹

### 10.1 å¾®æœåŠ¡æ¸è¿›å¼å‡çº§

**åœºæ™¯**: å‡çº§ `reviews` æœåŠ¡ä» v1.0 åˆ° v2.0

**æ­¥éª¤**:

```bash
# 1. éƒ¨ç½² v2.0
kubectl apply -f reviews-v2-deployment.yaml

# 2. å®šä¹‰ DestinationRule (Istio)
kubectl apply -f reviews-destination-rule.yaml

# 3. é‡‘ä¸é›€å‘å¸ƒ: 10% æµé‡åˆ° v2
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 90
    - destination:
        host: reviews
        subset: v2
      weight: 10
EOF

# 4. ç›‘æ§æŒ‡æ ‡
linkerd viz stat deploy/reviews-v2 -n default
# æˆ– Istio
istioctl dashboard prometheus

# 5. é€æ­¥å¢åŠ æµé‡ (25% â†’ 50% â†’ 100%)
# ... (ç±»ä¼¼æ­¥éª¤3)

# 6. å…¨é‡åˆ‡æ¢åˆ° v2
kubectl patch virtualservice reviews --type merge -p '
{
  "spec": {
    "http": [
      {
        "route": [
          {"destination": {"host": "reviews", "subset": "v2"}, "weight": 100}
        ]
      }
    ]
  }
}'

# 7. ä¸‹çº¿ v1
kubectl delete deployment reviews-v1
```

---

### 10.2 å¤šç‰ˆæœ¬ç°åº¦æµ‹è¯•

**åœºæ™¯**: åŒæ—¶ç°åº¦ 3 ä¸ªç‰ˆæœ¬ (v1, v2, v3)

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 70  # 70% æµé‡ (ç¨³å®šç‰ˆæœ¬)
    - destination:
        host: reviews
        subset: v2
      weight: 20  # 20% æµé‡ (é‡‘ä¸é›€1)
    - destination:
        host: reviews
        subset: v3
      weight: 10  # 10% æµé‡ (é‡‘ä¸é›€2)
```

---

### 10.3 æµé‡é˜²æŠ¤ä¸é™çº§

**åœºæ™¯**: é˜²æ­¢ä¸‹æ¸¸æœåŠ¡æ•…éšœå½±å“æ•´ä½“ç³»ç»Ÿ

```yaml
# 1. ç†”æ–­é…ç½®
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  trafficPolicy:
    outlierDetection:
      consecutive5xxErrors: 3
      interval: 30s
      baseEjectionTime: 30s
---
# 2. è¶…æ—¶é…ç½®
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - timeout: 5s
    retries:
      attempts: 2
      perTryTimeout: 2s
    route:
    - destination:
        host: reviews
---
# 3. é™æµé…ç½® (EnvoyFilter)
# ... (å‚è€ƒ 7.2 èŠ‚)
```

---

## 11. æœ€ä½³å®è·µ

### 11.1 å‘å¸ƒç­–ç•¥é€‰æ‹©

| ç­–ç•¥ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|-----|------|------|---------|
| **é‡‘ä¸é›€å‘å¸ƒ** | é£é™©å°ï¼Œå¯æ¸è¿› | è€—æ—¶é•¿ | å…³é”®æœåŠ¡ã€å¤§ç‰ˆæœ¬å‡çº§ |
| **è“ç»¿éƒ¨ç½²** | åˆ‡æ¢å¿«ï¼Œå›æ»šç®€å• | èµ„æºå ç”¨é«˜ | å°ç‰ˆæœ¬å‡çº§ã€å¿«é€Ÿå‘å¸ƒ |
| **A/B æµ‹è¯•** | ç²¾å‡†æµ‹è¯•ç”¨æˆ·ååº” | å¤æ‚åº¦é«˜ | åŠŸèƒ½éªŒè¯ã€UI æµ‹è¯• |
| **æµé‡é•œåƒ** | é›¶é£é™© | ä¸åæ˜ çœŸå®å“åº” | å‹åŠ›æµ‹è¯•ã€å…¼å®¹æ€§éªŒè¯ |

---

### 11.2 ç›‘æ§ä¸å›æ»š

**å…³é”®æŒ‡æ ‡**:

```yaml
# Prometheus å‘Šè­¦è§„åˆ™
groups:
- name: canary.rules
  rules:
  # æˆåŠŸç‡ < 95%
  - alert: CanaryErrorRate
    expr: |
      sum(rate(istio_requests_total{destination_workload="reviews-v2",response_code=~"5.."}[5m])) 
      / 
      sum(rate(istio_requests_total{destination_workload="reviews-v2"}[5m])) > 0.05
    for: 2m
    annotations:
      summary: "Canary error rate > 5%"
  
  # P99 å»¶è¿Ÿ > 1s
  - alert: CanaryHighLatency
    expr: |
      histogram_quantile(0.99, 
        sum(rate(istio_request_duration_milliseconds_bucket{destination_workload="reviews-v2"}[5m])) by (le)
      ) > 1000
    for: 2m
    annotations:
      summary: "Canary P99 latency > 1s"
```

**è‡ªåŠ¨å›æ»š**:

```bash
# ç›‘æ§æŒ‡æ ‡å¼‚å¸¸æ—¶è‡ªåŠ¨å›æ»š
kubectl patch virtualservice reviews --type merge -p '
{
  "spec": {
    "http": [
      {
        "route": [
          {"destination": {"host": "reviews", "subset": "v1"}, "weight": 100}
        ]
      }
    ]
  }
}'
```

---

### 11.3 è‡ªåŠ¨åŒ–æµç¨‹

**GitOps + Flagger**:

```text
1. å¼€å‘æäº¤ä»£ç åˆ° Git
        â†“
2. CI æ„å»ºé•œåƒå¹¶æ¨é€
        â†“
3. æ›´æ–° Kubernetes Deployment (Git)
        â†“
4. Flux/ArgoCD åŒæ­¥åˆ°é›†ç¾¤
        â†“
5. Flagger è‡ªåŠ¨æ‰§è¡Œé‡‘ä¸é›€å‘å¸ƒ
        â†“
6. ç›‘æ§æŒ‡æ ‡ï¼Œè‡ªåŠ¨å¢åŠ æµé‡
        â†“
7. æˆåŠŸåå…¨é‡åˆ‡æ¢ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š
```

---

## æ€»ç»“

**æµé‡ç®¡ç†æ ¸å¿ƒä»·å€¼**:

- âœ… **ç°åº¦å‘å¸ƒ**: é™ä½å‘å¸ƒé£é™©
- âœ… **A/B æµ‹è¯•**: æ•°æ®é©±åŠ¨å†³ç­–
- âœ… **æµé‡é•œåƒ**: ç”Ÿäº§ç¯å¢ƒå®‰å…¨æµ‹è¯•
- âœ… **ç†”æ–­/é™æµ**: ä¿éšœç³»ç»Ÿç¨³å®šæ€§

**é€‰å‹å»ºè®®**:

- **Istio**: åŠŸèƒ½å…¨é¢ï¼Œé€‚åˆå¤æ‚åœºæ™¯ (æµé‡é•œåƒã€Egress ç½‘å…³)
- **Linkerd**: ç®€å•æ˜“ç”¨ï¼Œé€‚åˆåŸºç¡€æµé‡ç®¡ç† (é‡‘ä¸é›€ã€A/B æµ‹è¯•)

**å·¥å…·æ¨è**:

- **Flagger**: è‡ªåŠ¨åŒ–é‡‘ä¸é›€å‘å¸ƒ
- **Argo Rollouts**: é«˜çº§æ¸è¿›å¼äº¤ä»˜
- **Prometheus + Grafana**: ç›‘æ§ä¸å‘Šè­¦

---

**ç›¸å…³æ–‡æ¡£**:

- [æœåŠ¡ç½‘æ ¼æ¦‚è¿°](01_æœåŠ¡ç½‘æ ¼æ¦‚è¿°.md)
- [Istioéƒ¨ç½²ä¸é…ç½®](02_Istioéƒ¨ç½²ä¸é…ç½®.md)
- [Linkerdéƒ¨ç½²ä¸é…ç½®](03_Linkerdéƒ¨ç½²ä¸é…ç½®.md)

---

**æ›´æ–°æ—¶é—´**: 2025-10-19  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**é€‚ç”¨ç‰ˆæœ¬**: Istio 1.20+, Linkerd 2.14+
