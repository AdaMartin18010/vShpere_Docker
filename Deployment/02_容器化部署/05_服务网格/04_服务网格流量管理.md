# 服务网格流量管理

> **返回**: [服务网格首页](README.md) | [容器化部署首页](../README.md) | [部署指南首页](../../00_索引导航/README.md)

---

## 📋 目录

- [服务网格流量管理](#服务网格流量管理)
  - [📋 目录](#-目录)
  - [1. 流量管理概述](#1-流量管理概述)
    - [1.1 什么是流量管理](#11-什么是流量管理)
    - [1.2 核心能力](#12-核心能力)
    - [1.3 使用场景](#13-使用场景)
  - [2. 金丝雀发布 (Canary Release)](#2-金丝雀发布-canary-release)
    - [2.1 概述](#21-概述)
    - [2.2 Istio 实现](#22-istio-实现)
    - [2.3 Linkerd 实现](#23-linkerd-实现)
    - [2.4 Flagger 自动化金丝雀](#24-flagger-自动化金丝雀)
  - [3. 蓝绿部署 (Blue-Green Deployment)](#3-蓝绿部署-blue-green-deployment)
    - [3.1 概述](#31-概述)
    - [3.2 Istio 实现](#32-istio-实现)
    - [3.3 Linkerd 实现](#33-linkerd-实现)
  - [4. A/B 测试 (A/B Testing)](#4-ab-测试-ab-testing)
    - [4.1 概述](#41-概述)
    - [4.2 基于请求头的 A/B 测试](#42-基于请求头的-ab-测试)
    - [4.3 基于 Cookie 的 A/B 测试](#43-基于-cookie-的-ab-测试)
  - [5. 流量镜像 (Traffic Mirroring)](#5-流量镜像-traffic-mirroring)
    - [5.1 概述](#51-概述)
    - [5.2 Istio 实现](#52-istio-实现)
    - [5.3 应用场景](#53-应用场景)
  - [6. 熔断 (Circuit Breaking)](#6-熔断-circuit-breaking)
    - [6.1 概述](#61-概述)
    - [6.2 Istio 熔断配置](#62-istio-熔断配置)
    - [6.3 Linkerd 熔断配置](#63-linkerd-熔断配置)
  - [7. 限流 (Rate Limiting)](#7-限流-rate-limiting)
    - [7.1 概述](#71-概述)
    - [7.2 本地限流 (Envoy)](#72-本地限流-envoy)
    - [7.3 全局限流 (Redis)](#73-全局限流-redis)
  - [8. 超时与重试](#8-超时与重试)
    - [8.1 超时配置](#81-超时配置)
    - [8.2 重试策略](#82-重试策略)
  - [9. 故障注入 (Fault Injection)](#9-故障注入-fault-injection)
    - [9.1 概述](#91-概述)
    - [9.2 延迟注入](#92-延迟注入)
    - [9.3 错误注入](#93-错误注入)
  - [10. 实战案例](#10-实战案例)
    - [10.1 微服务渐进式升级](#101-微服务渐进式升级)
    - [10.2 多版本灰度测试](#102-多版本灰度测试)
    - [10.3 流量防护与降级](#103-流量防护与降级)
  - [11. 最佳实践](#11-最佳实践)
    - [11.1 发布策略选择](#111-发布策略选择)
    - [11.2 监控与回滚](#112-监控与回滚)
    - [11.3 自动化流程](#113-自动化流程)
  - [总结](#总结)

---

## 1. 流量管理概述

### 1.1 什么是流量管理

**流量管理** 是服务网格的核心功能之一，允许精细控制服务间的流量路由、分配和行为，无需修改应用代码。

**核心原理**:

```text
用户请求
    ↓
Ingress Gateway / LoadBalancer
    ↓
Virtual Service (路由规则)
    ↓
Destination Rule (目标策略)
    ↓
服务实例 (v1/v2/v3)
```

---

### 1.2 核心能力

| 能力 | 说明 | 适用场景 |
|-----|------|---------|
| **流量分割** | 按权重/百分比分配流量 | 金丝雀发布 |
| **条件路由** | 基于请求头/路径/参数路由 | A/B 测试 |
| **流量镜像** | 复制流量到测试版本 | 生产环境测试 |
| **熔断** | 快速失败，防止级联故障 | 故障隔离 |
| **重试** | 自动重试失败请求 | 提升成功率 |
| **超时** | 限制请求等待时间 | 防止资源耗尽 |
| **限流** | 限制请求速率 | 防止过载 |
| **故障注入** | 人为注入延迟/错误 | 混沌工程 |

---

### 1.3 使用场景

**版本发布**:

- 金丝雀发布 (Canary Release)
- 蓝绿部署 (Blue-Green Deployment)
- 灰度发布 (Progressive Rollout)

**功能测试**:

- A/B 测试
- 流量镜像 (Shadow Testing)

**弹性保障**:

- 熔断 (Circuit Breaking)
- 限流 (Rate Limiting)
- 超时与重试

---

## 2. 金丝雀发布 (Canary Release)

### 2.1 概述

**金丝雀发布** 是一种渐进式发布策略，先将少量流量 (如 5-10%) 引导到新版本，验证无问题后逐步增加流量，最终全量切换。

**流程**:

```text
1. 部署新版本 (v2)
2. 5% 流量到 v2, 95% 到 v1
3. 监控 v2 指标 (错误率/延迟)
4. 逐步增加 v2 流量: 10% → 25% → 50% → 100%
5. 全量切换到 v2，下线 v1
```

**优点**:

- ✅ 风险可控 (影响范围小)
- ✅ 可快速回滚
- ✅ 基于真实流量验证

---

### 2.2 Istio 实现

**步骤1: 部署两个版本**:

```yaml
# v1 Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
spec:
  replicas: 3
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      containers:
      - name: reviews
        image: reviews:v1
---
# v2 Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v2
  template:
    metadata:
      labels:
        app: reviews
        version: v2
    spec:
      containers:
      - name: reviews
        image: reviews:v2
---
# Service
apiVersion: v1
kind: Service
metadata:
  name: reviews
spec:
  selector:
    app: reviews
  ports:
  - port: 9080
```

**步骤2: 定义 Subset (DestinationRule)**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

**步骤3: 配置流量分割 (VirtualService)**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 90  # 90% 流量到 v1
    - destination:
        host: reviews
        subset: v2
      weight: 10  # 10% 流量到 v2 (金丝雀)
```

**步骤4: 逐步增加流量**:

```bash
# 25% 流量到 v2
kubectl patch virtualservice reviews --type merge -p '
{
  "spec": {
    "http": [
      {
        "route": [
          {"destination": {"host": "reviews", "subset": "v1"}, "weight": 75},
          {"destination": {"host": "reviews", "subset": "v2"}, "weight": 25}
        ]
      }
    ]
  }
}'

# 50% 流量到 v2
# ... (类似操作)

# 100% 流量到 v2
kubectl patch virtualservice reviews --type merge -p '
{
  "spec": {
    "http": [
      {
        "route": [
          {"destination": {"host": "reviews", "subset": "v2"}, "weight": 100}
        ]
      }
    ]
  }
}'
```

---

### 2.3 Linkerd 实现

**使用 SMI TrafficSplit**:

```yaml
# v1 Service
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1
spec:
  selector:
    app: reviews
    version: v1
  ports:
  - port: 9080
---
# v2 Service
apiVersion: v1
kind: Service
metadata:
  name: reviews-v2
spec:
  selector:
    app: reviews
    version: v2
  ports:
  - port: 9080
---
# 主 Service
apiVersion: v1
kind: Service
metadata:
  name: reviews
spec:
  selector:
    app: reviews
  ports:
  - port: 9080
---
# TrafficSplit
apiVersion: split.smi-spec.io/v1alpha1
kind: TrafficSplit
metadata:
  name: reviews-canary
spec:
  service: reviews
  backends:
  - service: reviews-v1
    weight: 900  # 90%
  - service: reviews-v2
    weight: 100  # 10%
```

**验证金丝雀**:

```bash
# 查看流量分配
linkerd viz stat trafficsplit

# 输出
NAME              APEX      LEAF         WEIGHT   SUCCESS      RPS
reviews-canary    reviews   reviews-v1    900m   100.00%   9.0rps
                            reviews-v2    100m   100.00%   1.0rps
```

---

### 2.4 Flagger 自动化金丝雀

**安装 Flagger** (支持 Istio/Linkerd):

```bash
# 安装 Flagger
kubectl apply -k github.com/fluxcd/flagger//kustomize/linkerd

# 或 Helm 安装
helm repo add flagger https://flagger.app
helm install flagger flagger/flagger \
  --namespace linkerd \
  --set meshProvider=linkerd \
  --set metricsServer=http://linkerd-prometheus:9090
```

**配置自动金丝雀**:

```yaml
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: reviews
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews
  progressDeadlineSeconds: 60
  service:
    port: 9080
  analysis:
    interval: 1m      # 检查间隔
    threshold: 5      # 连续成功 5 次才增加流量
    maxWeight: 50     # 最大金丝雀权重 50%
    stepWeight: 10    # 每次增加 10%
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: 99       # 成功率 ≥ 99%
      interval: 1m
    - name: request-duration
      thresholdRange:
        max: 500      # P99 延迟 ≤ 500ms
      interval: 1m
```

**工作流程**:

```text
1. 部署新版本 (v2)
        ↓
2. Flagger 自动创建 v2 实例
        ↓
3. 按步长增加流量: 10% → 20% → 30% → 40% → 50%
        ↓
4. 每次增加后检查指标 (成功率/延迟)
        ↓
5. 如果指标异常，自动回滚到 v1
        ↓
6. 如果指标正常，最终切换到 v2
```

---

## 3. 蓝绿部署 (Blue-Green Deployment)

### 3.1 概述

**蓝绿部署** 是同时运行两个版本 (蓝色=当前版本, 绿色=新版本)，通过一次性切换流量来发布新版本。

**流程**:

```text
1. 部署绿色版本 (v2)
2. 验证绿色版本正常
3. 一次性切换全部流量到绿色版本
4. 保留蓝色版本一段时间 (以备回滚)
5. 下线蓝色版本
```

**优点**:

- ✅ 切换快速 (秒级)
- ✅ 回滚简单 (切回蓝色)
- ❌ 资源占用高 (双倍资源)

---

### 3.2 Istio 实现

```yaml
# 初始状态: 100% 流量到 v1 (蓝色)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
---
# 切换到 v2 (绿色)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v2
      weight: 100
```

**操作命令**:

```bash
# 一键切换到 v2
kubectl patch virtualservice reviews --type merge -p '
{
  "spec": {
    "http": [
      {
        "route": [
          {"destination": {"host": "reviews", "subset": "v2"}, "weight": 100}
        ]
      }
    ]
  }
}'

# 如需回滚，一键切回 v1
kubectl patch virtualservice reviews --type merge -p '
{
  "spec": {
    "http": [
      {
        "route": [
          {"destination": {"host": "reviews", "subset": "v1"}, "weight": 100}
        ]
      }
    ]
  }
}'
```

---

### 3.3 Linkerd 实现

```yaml
# 初始状态: 100% v1
apiVersion: split.smi-spec.io/v1alpha1
kind: TrafficSplit
metadata:
  name: reviews
spec:
  service: reviews
  backends:
  - service: reviews-v1
    weight: 1000  # 100%
  - service: reviews-v2
    weight: 0     # 0%
---
# 切换到 v2
apiVersion: split.smi-spec.io/v1alpha1
kind: TrafficSplit
metadata:
  name: reviews
spec:
  service: reviews
  backends:
  - service: reviews-v1
    weight: 0     # 0%
  - service: reviews-v2
    weight: 1000  # 100%
```

---

## 4. A/B 测试 (A/B Testing)

### 4.1 概述

**A/B 测试** 是根据用户特征 (请求头/Cookie/地理位置等) 将不同用户路由到不同版本，以比较功能效果。

**典型场景**:

- VIP 用户使用新功能，普通用户使用旧版本
- 地域 A 使用版本 A，地域 B 使用版本 B
- 测试新 UI 对转化率的影响

---

### 4.2 基于请求头的 A/B 测试

**Istio 实现**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - match:
    - headers:
        user:
          exact: "vip"  # VIP 用户
    route:
    - destination:
        host: reviews
        subset: v2      # VIP 用户访问 v2 (新功能)
  - route:
    - destination:
        host: reviews
        subset: v1      # 默认访问 v1
```

**验证**:

```bash
# VIP 用户访问 v2
curl -H "user: vip" http://reviews:9080/

# 普通用户访问 v1
curl http://reviews:9080/
```

---

### 4.3 基于 Cookie 的 A/B 测试

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - match:
    - headers:
        cookie:
          regex: ".*experiment=v2.*"  # Cookie 包含 experiment=v2
    route:
    - destination:
        host: reviews
        subset: v2
  - route:
    - destination:
        host: reviews
        subset: v1
```

---

## 5. 流量镜像 (Traffic Mirroring)

### 5.1 概述

**流量镜像** (Shadow Traffic) 将生产流量复制一份发送到测试版本，但不影响实际响应。用于在真实流量下验证新版本。

**特点**:

- ✅ 零风险 (响应不返回给用户)
- ✅ 真实流量测试
- ✅ 不影响生产性能

---

### 5.2 Istio 实现

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 100  # 100% 流量到 v1 (生产)
    mirror:
      host: reviews
      subset: v2   # 镜像流量到 v2 (测试)
    mirrorPercentage:
      value: 100.0 # 镜像 100% 流量
```

**注意事项**:

- 镜像流量是 **Fire-and-Forget** (发送后不等待响应)
- 不影响主请求的延迟
- v2 的错误不会影响用户

---

### 5.3 应用场景

**场景1: 新版本压力测试**:

```yaml
# 镜像 50% 流量到 v2 进行压测
mirror:
  host: reviews
  subset: v2
mirrorPercentage:
  value: 50.0
```

**场景2: 数据库迁移验证**:

```yaml
# 镜像流量到新数据库版本，验证兼容性
mirror:
  host: reviews-new-db
  subset: v2
```

---

## 6. 熔断 (Circuit Breaking)

### 6.1 概述

**熔断** 是一种保护机制，当检测到服务异常时快速失败，防止级联故障。

**熔断状态**:

```text
关闭 (Closed) → 打开 (Open) → 半开 (Half-Open)
        ↑                ↓
        └────────────────┘
```

**工作流程**:

```text
1. 正常状态: 熔断器关闭，请求正常通过
2. 错误率超过阈值 (如 5 次 5xx 错误)
3. 熔断器打开，快速失败 (返回 503)
4. 等待一段时间 (30 秒)
5. 进入半开状态，允许少量请求测试
6. 如果测试成功，恢复关闭状态
7. 如果测试失败，继续打开状态
```

---

### 6.2 Istio 熔断配置

```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100       # 最大连接数
      http:
        http1MaxPendingRequests: 10  # 最大挂起请求
        http2MaxRequests: 100
        maxRequestsPerConnection: 2
    outlierDetection:
      consecutive5xxErrors: 5     # 连续 5 次 5xx 错误
      interval: 30s               # 检测间隔
      baseEjectionTime: 30s       # 驱逐时间 (熔断持续时间)
      maxEjectionPercent: 50      # 最多驱逐 50% 实例
      minHealthPercent: 10        # 最少保留 10% 健康实例
```

**验证熔断**:

```bash
# 生成大量并发请求触发熔断
kubectl run fortio --image=fortio/fortio --command -- \
  fortio load -c 100 -qps 0 -n 1000 http://reviews:9080/

# 查看熔断指标
kubectl exec fortio -- fortio report

# 输出
# 部分请求返回 503 (熔断生效)
Code 200 : 950 (95.0 %)
Code 503 : 50 (5.0 %)
```

---

### 6.3 Linkerd 熔断配置

**Linkerd 使用 Server 和 HTTPRoute**:

```yaml
apiVersion: policy.linkerd.io/v1alpha1
kind: Server
metadata:
  name: reviews-server
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: reviews
  port: 9080
  proxyProtocol: HTTP/2
---
apiVersion: policy.linkerd.io/v1beta1
kind: HTTPRoute
metadata:
  name: reviews-route
  namespace: default
spec:
  parentRefs:
  - name: reviews-server
    kind: Server
    group: policy.linkerd.io
  rules:
  - backendRefs:
    - name: reviews
      port: 9080
    timeouts:
      request: 10s
      backendRequest: 5s
    retry:
      codes: [503, 504]
      maxRetries: 3
```

---

## 7. 限流 (Rate Limiting)

### 7.1 概述

**限流** 用于防止服务过载，限制单位时间内的请求数量。

**限流类型**:

- **本地限流**: Envoy 代理本地计数 (适合单机场景)
- **全局限流**: 使用 Redis 等分布式存储 (适合集群场景)

---

### 7.2 本地限流 (Envoy)

**Istio EnvoyFilter**:

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: filter-local-ratelimit-svc
  namespace: default
spec:
  workloadSelector:
    labels:
      app: reviews
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.local_ratelimit
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
          value:
            stat_prefix: http_local_rate_limiter
            token_bucket:
              max_tokens: 100       # 桶容量 100
              tokens_per_fill: 100
              fill_interval: 1s     # 每秒补充 100 个令牌 (即 100 RPS)
            filter_enabled:
              runtime_key: local_rate_limit_enabled
              default_value:
                numerator: 100
                denominator: HUNDRED
            filter_enforced:
              runtime_key: local_rate_limit_enforced
              default_value:
                numerator: 100
                denominator: HUNDRED
            response_headers_to_add:
            - append: false
              header:
                key: x-local-rate-limit
                value: 'true'
```

---

### 7.3 全局限流 (Redis)

**部署 Redis**:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:alpine
        ports:
        - containerPort: 6379
---
apiVersion: v1
kind: Service
metadata:
  name: redis
spec:
  selector:
    app: redis
  ports:
  - port: 6379
```

**配置全局限流** (复杂，需Envoy RateLimit服务):

```yaml
# 部署 Envoy Rate Limit Service
# (略，详见 Istio 官方文档)
```

---

## 8. 超时与重试

### 8.1 超时配置

**Istio 超时**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - timeout: 10s  # 请求超时 10 秒
    route:
    - destination:
        host: reviews
        subset: v1
```

**Linkerd 超时**:

```yaml
apiVersion: policy.linkerd.io/v1beta1
kind: HTTPRoute
metadata:
  name: reviews-route
spec:
  rules:
  - timeouts:
      request: 10s
      backendRequest: 5s
```

---

### 8.2 重试策略

**Istio 重试**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - retries:
      attempts: 3             # 重试 3 次
      perTryTimeout: 2s       # 每次重试超时 2 秒
      retryOn: 5xx,reset,connect-failure  # 重试条件
    route:
    - destination:
        host: reviews
        subset: v1
```

**Linkerd 重试**:

```yaml
apiVersion: linkerd.io/v1alpha2
kind: ServiceProfile
metadata:
  name: reviews.default.svc.cluster.local
spec:
  routes:
  - name: GET /api
    condition:
      method: GET
      pathRegex: /api/.*
    isRetryable: true
    timeout: 10s
    retryBudget:
      retryRatio: 0.2         # 最多重试 20% 请求
      minRetriesPerSecond: 10
      ttl: 10s
```

---

## 9. 故障注入 (Fault Injection)

### 9.1 概述

**故障注入** 用于测试系统在异常情况下的行为 (混沌工程)。

**注入类型**:

- **延迟注入**: 模拟网络延迟/慢查询
- **错误注入**: 模拟服务故障 (500 错误)

---

### 9.2 延迟注入

**Istio 延迟注入**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - fault:
      delay:
        percentage:
          value: 10.0  # 10% 请求延迟
        fixedDelay: 5s # 延迟 5 秒
    route:
    - destination:
        host: reviews
        subset: v1
```

---

### 9.3 错误注入

**Istio 错误注入**:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - fault:
      abort:
        percentage:
          value: 10.0  # 10% 请求返回错误
        httpStatus: 500  # 返回 500 错误
    route:
    - destination:
        host: reviews
        subset: v1
```

---

## 10. 实战案例

### 10.1 微服务渐进式升级

**场景**: 升级 `reviews` 服务从 v1.0 到 v2.0

**步骤**:

```bash
# 1. 部署 v2.0
kubectl apply -f reviews-v2-deployment.yaml

# 2. 定义 DestinationRule (Istio)
kubectl apply -f reviews-destination-rule.yaml

# 3. 金丝雀发布: 10% 流量到 v2
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 90
    - destination:
        host: reviews
        subset: v2
      weight: 10
EOF

# 4. 监控指标
linkerd viz stat deploy/reviews-v2 -n default
# 或 Istio
istioctl dashboard prometheus

# 5. 逐步增加流量 (25% → 50% → 100%)
# ... (类似步骤3)

# 6. 全量切换到 v2
kubectl patch virtualservice reviews --type merge -p '
{
  "spec": {
    "http": [
      {
        "route": [
          {"destination": {"host": "reviews", "subset": "v2"}, "weight": 100}
        ]
      }
    ]
  }
}'

# 7. 下线 v1
kubectl delete deployment reviews-v1
```

---

### 10.2 多版本灰度测试

**场景**: 同时灰度 3 个版本 (v1, v2, v3)

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 70  # 70% 流量 (稳定版本)
    - destination:
        host: reviews
        subset: v2
      weight: 20  # 20% 流量 (金丝雀1)
    - destination:
        host: reviews
        subset: v3
      weight: 10  # 10% 流量 (金丝雀2)
```

---

### 10.3 流量防护与降级

**场景**: 防止下游服务故障影响整体系统

```yaml
# 1. 熔断配置
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  trafficPolicy:
    outlierDetection:
      consecutive5xxErrors: 3
      interval: 30s
      baseEjectionTime: 30s
---
# 2. 超时配置
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - timeout: 5s
    retries:
      attempts: 2
      perTryTimeout: 2s
    route:
    - destination:
        host: reviews
---
# 3. 限流配置 (EnvoyFilter)
# ... (参考 7.2 节)
```

---

## 11. 最佳实践

### 11.1 发布策略选择

| 策略 | 优点 | 缺点 | 适用场景 |
|-----|------|------|---------|
| **金丝雀发布** | 风险小，可渐进 | 耗时长 | 关键服务、大版本升级 |
| **蓝绿部署** | 切换快，回滚简单 | 资源占用高 | 小版本升级、快速发布 |
| **A/B 测试** | 精准测试用户反应 | 复杂度高 | 功能验证、UI 测试 |
| **流量镜像** | 零风险 | 不反映真实响应 | 压力测试、兼容性验证 |

---

### 11.2 监控与回滚

**关键指标**:

```yaml
# Prometheus 告警规则
groups:
- name: canary.rules
  rules:
  # 成功率 < 95%
  - alert: CanaryErrorRate
    expr: |
      sum(rate(istio_requests_total{destination_workload="reviews-v2",response_code=~"5.."}[5m])) 
      / 
      sum(rate(istio_requests_total{destination_workload="reviews-v2"}[5m])) > 0.05
    for: 2m
    annotations:
      summary: "Canary error rate > 5%"
  
  # P99 延迟 > 1s
  - alert: CanaryHighLatency
    expr: |
      histogram_quantile(0.99, 
        sum(rate(istio_request_duration_milliseconds_bucket{destination_workload="reviews-v2"}[5m])) by (le)
      ) > 1000
    for: 2m
    annotations:
      summary: "Canary P99 latency > 1s"
```

**自动回滚**:

```bash
# 监控指标异常时自动回滚
kubectl patch virtualservice reviews --type merge -p '
{
  "spec": {
    "http": [
      {
        "route": [
          {"destination": {"host": "reviews", "subset": "v1"}, "weight": 100}
        ]
      }
    ]
  }
}'
```

---

### 11.3 自动化流程

**GitOps + Flagger**:

```text
1. 开发提交代码到 Git
        ↓
2. CI 构建镜像并推送
        ↓
3. 更新 Kubernetes Deployment (Git)
        ↓
4. Flux/ArgoCD 同步到集群
        ↓
5. Flagger 自动执行金丝雀发布
        ↓
6. 监控指标，自动增加流量
        ↓
7. 成功后全量切换，失败自动回滚
```

---

## 总结

**流量管理核心价值**:

- ✅ **灰度发布**: 降低发布风险
- ✅ **A/B 测试**: 数据驱动决策
- ✅ **流量镜像**: 生产环境安全测试
- ✅ **熔断/限流**: 保障系统稳定性

**选型建议**:

- **Istio**: 功能全面，适合复杂场景 (流量镜像、Egress 网关)
- **Linkerd**: 简单易用，适合基础流量管理 (金丝雀、A/B 测试)

**工具推荐**:

- **Flagger**: 自动化金丝雀发布
- **Argo Rollouts**: 高级渐进式交付
- **Prometheus + Grafana**: 监控与告警

---

**相关文档**:

- [服务网格概述](01_服务网格概述.md)
- [Istio部署与配置](02_Istio部署与配置.md)
- [Linkerd部署与配置](03_Linkerd部署与配置.md)

---

**更新时间**: 2025-10-19  
**文档版本**: v1.0  
**适用版本**: Istio 1.20+, Linkerd 2.14+
