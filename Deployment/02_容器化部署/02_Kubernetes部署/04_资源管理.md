# Kubernetes资源管理

> **返回**: [Kubernetes部署目录](README.md) | [容器化部署首页](../README.md) | [部署指南首页](../../00_索引导航/README.md)

---

## 📋 目录

- [Kubernetes资源管理](#kubernetes资源管理)
  - [📋 目录](#-目录)
  - [1. Namespace命名空间](#1-namespace命名空间)
  - [2. RBAC权限管理](#2-rbac权限管理)
  - [3. ResourceQuota资源配额](#3-resourcequota资源配额)
  - [4. LimitRange资源限制](#4-limitrange资源限制)
  - [5. Horizontal Pod Autoscaler (HPA)](#5-horizontal-pod-autoscaler-hpa)
  - [6. Vertical Pod Autoscaler (VPA)](#6-vertical-pod-autoscaler-vpa)
  - [7. PodDisruptionBudget (PDB)](#7-poddisruptionbudget-pdb)
  - [8. 节点管理](#8-节点管理)
  - [9. 资源监控](#9-资源监控)
  - [10. 最佳实践](#10-最佳实践)
  - [相关文档](#相关文档)

---

## 1. Namespace命名空间

```yaml
Namespace_Overview:
  定义:
    - 虚拟集群
    - 资源隔离
    - 命名空间隔离
    - 多租户支持
  
  默认命名空间:
    default: 默认命名空间
    kube-system: Kubernetes系统组件
    kube-public: 公开资源
    kube-node-lease: 节点心跳
  
  适用场景:
    - 环境隔离 (dev, test, prod)
    - 团队隔离
    - 项目隔离
    - 资源配额管理
```

**Namespace操作**:

```yaml
# 创建Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: development
  labels:
    name: development
    environment: dev

---
# 带资源配额的Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    name: production
    environment: prod
  annotations:
    owner: "ops-team@example.com"
    cost-center: "12345"
```

```bash
# 命令行创建
kubectl create namespace development

# 查看所有命名空间
kubectl get namespaces
kubectl get ns  # 简写

# 查看命名空间详情
kubectl describe namespace development

# 设置默认命名空间
kubectl config set-context --current --namespace=development

# 查看当前命名空间
kubectl config view --minify | grep namespace:

# 切换命名空间
kubectl config use-context <context-name>

# 在特定命名空间操作
kubectl get pods -n development
kubectl get all -n development

# 查看所有命名空间的资源
kubectl get pods --all-namespaces
kubectl get pods -A  # 简写

# 删除命名空间 (会删除所有资源)
kubectl delete namespace development
```

---

## 2. RBAC权限管理

```yaml
RBAC_Overview:
  组件:
    Role: 命名空间级别角色
    ClusterRole: 集群级别角色
    RoleBinding: 绑定Role到用户
    ClusterRoleBinding: 绑定ClusterRole到用户
  
  主体 (Subject):
    User: 用户
    Group: 用户组
    ServiceAccount: 服务账号
  
  权限 (Verb):
    - get, list, watch
    - create, update, patch
    - delete, deletecollection
    - *: 所有权限
  
  资源 (Resource):
    - pods, services, deployments
    - configmaps, secrets
    - nodes, namespaces
    - *: 所有资源
```

**Role和RoleBinding示例**:

```yaml
# Role - 命名空间级别
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: development
  name: pod-reader
rules:
- apiGroups: [""]  # "" 表示核心API组
  resources: ["pods"]
  verbs: ["get", "watch", "list"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get"]

---
# RoleBinding - 绑定Role
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-pods
  namespace: development
subjects:
- kind: User
  name: jane
  apiGroup: rbac.authorization.k8s.io
- kind: ServiceAccount
  name: myapp-sa
  namespace: development
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io
```

**ClusterRole和ClusterRoleBinding示例**:

```yaml
# ClusterRole - 集群级别
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-reader
rules:
- apiGroups: [""]
  resources: ["pods", "services", "nodes"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets", "daemonsets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["batch"]
  resources: ["jobs", "cronjobs"]
  verbs: ["get", "list", "watch"]

---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cluster-reader-binding
subjects:
- kind: Group
  name: readers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: cluster-reader
  apiGroup: rbac.authorization.k8s.io
```

**常用权限场景**:

```yaml
# 1. 只读权限
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: readonly
  namespace: development
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["get", "list", "watch"]

---
# 2. 开发者权限
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: developer
  namespace: development
rules:
- apiGroups: ["", "apps", "batch"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list"]  # Secret只读

---
# 3. 管理员权限
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: admin
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]

---
# 4. CI/CD权限
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cicd
  namespace: production
rules:
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "update", "patch"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get"]
```

**ServiceAccount管理**:

```yaml
# 创建ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: myapp-sa
  namespace: development

---
# 使用ServiceAccount
apiVersion: v1
kind: Pod
metadata:
  name: myapp
  namespace: development
spec:
  serviceAccountName: myapp-sa
  containers:
  - name: myapp
    image: myapp:v1.0
```

```bash
# 创建ServiceAccount
kubectl create serviceaccount myapp-sa -n development

# 查看ServiceAccount
kubectl get serviceaccounts -n development
kubectl get sa -n development  # 简写

# 查看ServiceAccount Token
kubectl describe sa myapp-sa -n development

# 获取Token
kubectl create token myapp-sa -n development

# 检查权限
kubectl auth can-i create pods --as=system:serviceaccount:development:myapp-sa -n development
kubectl auth can-i get secrets --as=system:serviceaccount:development:myapp-sa -n development

# 查看当前用户权限
kubectl auth can-i create deployments
kubectl auth can-i delete nodes
kubectl auth can-i '*' '*'  # 是否有所有权限
```

---

## 3. ResourceQuota资源配额

```yaml
ResourceQuota_Overview:
  定义:
    - 限制命名空间资源使用
    - 防止资源滥用
    - 多租户资源隔离
  
  配额类型:
    计算资源:
      - requests.cpu, requests.memory
      - limits.cpu, limits.memory
    
    对象数量:
      - pods, services, secrets
      - configmaps, persistentvolumeclaims
      - replicationcontrollers, deployments
    
    存储资源:
      - requests.storage
      - persistentvolumeclaims
```

**ResourceQuota示例**:

```yaml
# 计算资源配额
apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-quota
  namespace: development
spec:
  hard:
    requests.cpu: "10"         # 总CPU请求
    requests.memory: 20Gi      # 总内存请求
    limits.cpu: "20"           # 总CPU限制
    limits.memory: 40Gi        # 总内存限制

---
# 对象数量配额
apiVersion: v1
kind: ResourceQuota
metadata:
  name: object-quota
  namespace: development
spec:
  hard:
    pods: "50"                      # 最多50个Pod
    services: "10"                  # 最多10个Service
    secrets: "20"                   # 最多20个Secret
    configmaps: "20"                # 最多20个ConfigMap
    persistentvolumeclaims: "10"    # 最多10个PVC
    replicationcontrollers: "20"    # 最多20个RC
    deployments.apps: "20"          # 最多20个Deployment
    services.loadbalancers: "2"     # 最多2个LB

---
# 存储配额
apiVersion: v1
kind: ResourceQuota
metadata:
  name: storage-quota
  namespace: development
spec:
  hard:
    requests.storage: 100Gi                    # 总存储请求
    persistentvolumeclaims: "10"               # PVC数量
    requests.ephemeral-storage: 10Gi           # 临时存储
    limits.ephemeral-storage: 20Gi             # 临时存储限制

---
# 按StorageClass配额
apiVersion: v1
kind: ResourceQuota
metadata:
  name: storageclass-quota
  namespace: development
spec:
  hard:
    fast.storageclass.storage.k8s.io/requests.storage: 50Gi
    slow.storageclass.storage.k8s.io/requests.storage: 100Gi
    fast.storageclass.storage.k8s.io/persistentvolumeclaims: "5"
    slow.storageclass.storage.k8s.io/persistentvolumeclaims: "10"

---
# 按优先级配额
apiVersion: v1
kind: ResourceQuota
metadata:
  name: priority-quota
  namespace: development
spec:
  hard:
    pods: "50"
  scopeSelector:
    matchExpressions:
    - operator: In
      scopeName: PriorityClass
      values: ["high"]
```

**ResourceQuota管理**:

```bash
# 创建ResourceQuota
kubectl apply -f resourcequota.yaml

# 查看ResourceQuota
kubectl get resourcequota -n development
kubectl get quota -n development  # 简写

# 查看详情
kubectl describe resourcequota compute-quota -n development

# 查看资源使用情况
kubectl describe namespace development

# 删除ResourceQuota
kubectl delete resourcequota compute-quota -n development
```

---

## 4. LimitRange资源限制

```yaml
LimitRange_Overview:
  定义:
    - 限制单个对象资源
    - Pod/Container的min/max/default
    - 防止资源请求过大或过小
  
  限制类型:
    Container:
      - CPU, Memory
      - 默认requests和limits
    
    Pod:
      - 总CPU, Memory
      - 所有容器之和
    
    PersistentVolumeClaim:
      - 存储大小限制
```

**LimitRange示例**:

```yaml
# Container级别限制
apiVersion: v1
kind: LimitRange
metadata:
  name: container-limit-range
  namespace: development
spec:
  limits:
  - type: Container
    max:
      cpu: "2"          # 单个容器最大CPU
      memory: "4Gi"     # 单个容器最大内存
    min:
      cpu: "100m"       # 单个容器最小CPU
      memory: "128Mi"   # 单个容器最小内存
    default:
      cpu: "500m"       # 默认limits
      memory: "512Mi"
    defaultRequest:
      cpu: "200m"       # 默认requests
      memory: "256Mi"
    maxLimitRequestRatio:
      cpu: "4"          # limit/request最大比例
      memory: "2"

---
# Pod级别限制
apiVersion: v1
kind: LimitRange
metadata:
  name: pod-limit-range
  namespace: development
spec:
  limits:
  - type: Pod
    max:
      cpu: "4"          # Pod总CPU限制
      memory: "8Gi"     # Pod总内存限制
    min:
      cpu: "100m"
      memory: "128Mi"

---
# PVC限制
apiVersion: v1
kind: LimitRange
metadata:
  name: pvc-limit-range
  namespace: development
spec:
  limits:
  - type: PersistentVolumeClaim
    max:
      storage: 10Gi     # 单个PVC最大存储
    min:
      storage: 1Gi      # 单个PVC最小存储
```

**LimitRange管理**:

```bash
# 创建LimitRange
kubectl apply -f limitrange.yaml

# 查看LimitRange
kubectl get limitrange -n development
kubectl get limits -n development  # 简写

# 查看详情
kubectl describe limitrange container-limit-range -n development

# 删除LimitRange
kubectl delete limitrange container-limit-range -n development
```

---

## 5. Horizontal Pod Autoscaler (HPA)

```yaml
HPA_Overview:
  定义:
    - 水平Pod自动扩缩容
    - 基于指标自动调整副本数
    - 支持CPU、内存、自定义指标
  
  工作原理:
    1. Metrics Server收集指标
    2. HPA Controller计算期望副本数
    3. 调整Deployment/StatefulSet副本数
  
  指标类型:
    Resource: CPU, Memory
    Pods: 自定义Pod指标
    Object: Kubernetes对象指标
    External: 外部系统指标
```

**安装Metrics Server**:

```bash
# 部署Metrics Server
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

# 查看Metrics Server
kubectl get deployment metrics-server -n kube-system

# 查看节点资源
kubectl top nodes

# 查看Pod资源
kubectl top pods -n development
```

**HPA示例**:

```yaml
# 基于CPU的HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: myapp-hpa
  namespace: development
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: myapp
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 80  # 目标CPU使用率80%

---
# 基于CPU和内存的HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: myapp-hpa-multi
  namespace: development
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: myapp
  minReplicas: 2
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # 缩容稳定窗口
      policies:
      - type: Percent
        value: 50       # 每次最多缩容50%
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100      # 每次最多扩容100%
        periodSeconds: 15
      - type: Pods
        value: 4        # 每次最多扩容4个Pod
        periodSeconds: 15
      selectPolicy: Max  # 选择最大值

---
# 基于自定义指标的HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: myapp-hpa-custom
  namespace: development
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: myapp
  minReplicas: 3
  maxReplicas: 15
  metrics:
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: "1000"  # 每秒1000个请求
```

**HPA管理**:

```bash
# 命令行创建HPA
kubectl autoscale deployment myapp --min=3 --max=10 --cpu-percent=80 -n development

# 查看HPA
kubectl get hpa -n development

# 查看详情
kubectl describe hpa myapp-hpa -n development

# 查看HPA事件
kubectl get events -n development --field-selector involvedObject.name=myapp-hpa

# 编辑HPA
kubectl edit hpa myapp-hpa -n development

# 删除HPA
kubectl delete hpa myapp-hpa -n development
```

---

## 6. Vertical Pod Autoscaler (VPA)

```yaml
VPA_Overview:
  定义:
    - 垂直Pod自动扩缩容
    - 自动调整Pod资源requests/limits
    - 优化资源利用率
  
  更新模式:
    Off: 只推荐，不应用
    Initial: 仅创建时应用
    Recreate: 删除重建Pod
    Auto: 自动应用（未来）
  
  组件:
    VPA Recommender: 计算推荐值
    VPA Updater: 更新Pod
    VPA Admission Controller: 准入控制
```

**安装VPA**:

```bash
# 克隆VPA仓库
git clone https://github.com/kubernetes/autoscaler.git
cd autoscaler/vertical-pod-autoscaler

# 安装VPA
./hack/vpa-up.sh

# 查看VPA组件
kubectl get pods -n kube-system | grep vpa
```

**VPA示例**:

```yaml
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: myapp-vpa
  namespace: development
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: myapp
  updatePolicy:
    updateMode: "Auto"  # Off, Initial, Recreate, Auto
  resourcePolicy:
    containerPolicies:
    - containerName: myapp
      minAllowed:
        cpu: 100m
        memory: 128Mi
      maxAllowed:
        cpu: 2000m
        memory: 2Gi
      controlledResources: ["cpu", "memory"]
```

---

## 7. PodDisruptionBudget (PDB)

```yaml
PDB_Overview:
  定义:
    - 限制同时不可用的Pod数量
    - 保护应用可用性
    - 自愿中断保护
  
  适用场景:
    - 节点维护
    - 集群升级
    - Pod驱逐
    - 自动扩缩容
```

**PDB示例**:

```yaml
# 最小可用副本数
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: myapp-pdb
  namespace: development
spec:
  minAvailable: 2  # 至少2个Pod可用
  selector:
    matchLabels:
      app: myapp

---
# 最大不可用副本数
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: myapp-pdb-percent
  namespace: development
spec:
  maxUnavailable: 1  # 或 "30%" 最多30%不可用
  selector:
    matchLabels:
      app: myapp
```

**PDB管理**:

```bash
# 创建PDB
kubectl apply -f pdb.yaml

# 查看PDB
kubectl get pdb -n development

# 查看详情
kubectl describe pdb myapp-pdb -n development

# 删除PDB
kubectl delete pdb myapp-pdb -n development
```

---

## 8. 节点管理

```yaml
Node_Management:
  节点标签:
    - 节点分类
    - Pod调度
    - nodeSelector
  
  污点和容忍:
    Taint: 节点拒绝Pod
    Toleration: Pod容忍污点
  
  节点亲和性:
    - 硬性要求 (required)
    - 软性偏好 (preferred)
```

**节点操作**:

```bash
# 查看节点
kubectl get nodes
kubectl get nodes -o wide

# 查看节点详情
kubectl describe node node01

# 查看节点资源使用
kubectl top node node01

# 节点标签管理
kubectl label nodes node01 disktype=ssd
kubectl label nodes node01 env=production
kubectl label nodes node01 disktype-  # 删除标签

# 查看节点标签
kubectl get nodes --show-labels
kubectl get nodes -L disktype,env

# 节点污点管理
# 添加污点
kubectl taint nodes node01 key=value:NoSchedule
kubectl taint nodes node01 key=value:NoExecute
kubectl taint nodes node01 key=value:PreferNoSchedule

# 删除污点
kubectl taint nodes node01 key:NoSchedule-

# 查看节点污点
kubectl describe node node01 | grep Taints

# 节点维护
# 标记不可调度
kubectl cordon node01

# 驱逐Pod
kubectl drain node01 --ignore-daemonsets --delete-emptydir-data

# 恢复调度
kubectl uncordon node01
```

**污点和容忍示例**:

```yaml
# Pod容忍污点
apiVersion: v1
kind: Pod
metadata:
  name: myapp
spec:
  tolerations:
  - key: "key"
    operator: "Equal"
    value: "value"
    effect: "NoSchedule"
  - key: "key"
    operator: "Exists"
    effect: "NoExecute"
    tolerationSeconds: 3600  # 容忍3600秒
  containers:
  - name: myapp
    image: myapp:v1.0
```

---

## 9. 资源监控

```yaml
Monitoring_Overview:
  Metrics Server:
    - kubectl top命令
    - HPA数据源
    - 基础指标
  
  Prometheus:
    - 完整监控方案
    - 自定义指标
    - 告警规则
  
  关键指标:
    节点:
      - CPU使用率
      - 内存使用率
      - 磁盘使用率
      - 网络流量
    
    Pod:
      - CPU使用
      - 内存使用
      - 重启次数
      - 网络流量
    
    集群:
      - Pod数量
      - Node数量
      - API Server QPS
      - etcd延迟
```

**监控命令**:

```bash
# 查看节点资源
kubectl top nodes
kubectl top nodes --sort-by=cpu
kubectl top nodes --sort-by=memory

# 查看Pod资源
kubectl top pods -n development
kubectl top pods -A --sort-by=memory
kubectl top pods --containers  # 显示容器

# 查看集群组件状态
kubectl get componentstatuses
kubectl get cs  # 简写

# 查看API Server指标
kubectl get --raw /metrics | grep apiserver

# 查看事件
kubectl get events -n development --sort-by='.lastTimestamp'
kubectl get events -A --watch
```

---

## 10. 最佳实践

```yaml
Resource_Management_Best_Practices:
  命名空间:
    ✅ 按环境隔离: dev, test, prod
    ✅ 按团队隔离: team-a, team-b
    ✅ 设置ResourceQuota和LimitRange
    ✅ 使用有意义的标签和注解
  
  RBAC:
    ✅ 最小权限原则
    ✅ 使用ServiceAccount而非User
    ✅ 定期审计权限
    ✅ 禁用匿名访问
  
  资源配额:
    ✅ 所有命名空间设置ResourceQuota
    ✅ 预留10-20%缓冲
    ✅ 监控配额使用率
    ✅ 定期调整配额
  
  资源请求和限制:
    ✅ 始终设置requests和limits
    ✅ requests = 应用稳定运行所需
    ✅ limits = 应用峰值所需
    ✅ 避免过度分配
  
  自动扩缩容:
    ✅ 使用HPA应对流量波动
    ✅ 设置合理的min/max
    ✅ 配置扩缩容策略（behavior）
    ✅ 监控扩缩容事件
  
  高可用:
    ✅ 设置PodDisruptionBudget
    ✅ 多副本部署
    ✅ 跨可用区分布
    ✅ 反亲和性规则
  
  监控告警:
    ✅ 监控资源使用率
    ✅ 监控配额使用情况
    ✅ 配置告警规则
    ✅ 定期审查监控数据
```

---

## 相关文档

- [Kubernetes集群部署](01_集群部署.md)
- [Kubernetes核心组件](02_核心组件.md)
- [Kubernetes应用部署](03_应用部署.md)
- [Kubernetes故障排查](05_故障排查.md)
- [Kubernetes高可用架构](../../01_虚拟化部署/05_高可用容灾/02_Kubernetes高可用架构.md)

---

**更新时间**: 2025-10-19  
**文档版本**: v1.0  
**状态**: ✅ 生产就绪
