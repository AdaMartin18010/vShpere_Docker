# Kubernetesæ•…éšœæ’æŸ¥

> **è¿”å›**: [Kuberneteséƒ¨ç½²ç›®å½•](README.md) | [å®¹å™¨åŒ–éƒ¨ç½²é¦–é¡µ](../README.md) | [éƒ¨ç½²æŒ‡å—é¦–é¡µ](../../00_ç´¢å¼•å¯¼èˆª/README.md)

---

## ğŸ“‹ ç›®å½•

- [Kubernetesæ•…éšœæ’æŸ¥](#kubernetesæ•…éšœæ’æŸ¥)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ•…éšœæ’æŸ¥æµç¨‹](#1-æ•…éšœæ’æŸ¥æµç¨‹)
  - [2. Podæ•…éšœæ’æŸ¥](#2-podæ•…éšœæ’æŸ¥)
    - [åœºæ™¯1: Podä¸€ç›´å¤„äºPendingçŠ¶æ€](#åœºæ™¯1-podä¸€ç›´å¤„äºpendingçŠ¶æ€)
    - [åœºæ™¯2: CrashLoopBackOff](#åœºæ™¯2-crashloopbackoff)
    - [åœºæ™¯3: ImagePullBackOff](#åœºæ™¯3-imagepullbackoff)
  - [3. ç½‘ç»œæ•…éšœæ’æŸ¥](#3-ç½‘ç»œæ•…éšœæ’æŸ¥)
    - [åœºæ™¯1: Serviceæ— æ³•è®¿é—®](#åœºæ™¯1-serviceæ— æ³•è®¿é—®)
    - [åœºæ™¯2: DNSè§£æå¤±è´¥](#åœºæ™¯2-dnsè§£æå¤±è´¥)
  - [4. å­˜å‚¨æ•…éšœæ’æŸ¥](#4-å­˜å‚¨æ•…éšœæ’æŸ¥)
    - [åœºæ™¯1: PVCä¸€ç›´Pending](#åœºæ™¯1-pvcä¸€ç›´pending)
    - [åœºæ™¯2: Podæ— æ³•æŒ‚è½½å·](#åœºæ™¯2-podæ— æ³•æŒ‚è½½å·)
  - [5. èŠ‚ç‚¹æ•…éšœæ’æŸ¥](#5-èŠ‚ç‚¹æ•…éšœæ’æŸ¥)
    - [åœºæ™¯1: èŠ‚ç‚¹NotReady](#åœºæ™¯1-èŠ‚ç‚¹notready)
    - [åœºæ™¯2: èŠ‚ç‚¹èµ„æºå‹åŠ›](#åœºæ™¯2-èŠ‚ç‚¹èµ„æºå‹åŠ›)
  - [6. æ§åˆ¶å¹³é¢æ•…éšœæ’æŸ¥](#6-æ§åˆ¶å¹³é¢æ•…éšœæ’æŸ¥)
  - [7. æ€§èƒ½é—®é¢˜æ’æŸ¥](#7-æ€§èƒ½é—®é¢˜æ’æŸ¥)
  - [8. å¸¸ç”¨è¯Šæ–­å‘½ä»¤](#8-å¸¸ç”¨è¯Šæ–­å‘½ä»¤)
  - [9. æ—¥å¿—æ”¶é›†](#9-æ—¥å¿—æ”¶é›†)
  - [10. æ•…éšœé¢„é˜²æœ€ä½³å®è·µ](#10-æ•…éšœé¢„é˜²æœ€ä½³å®è·µ)
  - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## 1. æ•…éšœæ’æŸ¥æµç¨‹

```yaml
Troubleshooting_Workflow:
  ç¬¬ä¸€æ­¥_ä¿¡æ¯æ”¶é›†:
    - æ•…éšœç°è±¡æè¿°
    - å‘ç”Ÿæ—¶é—´
    - å½±å“èŒƒå›´
    - è¿‘æœŸå˜æ›´
  
  ç¬¬äºŒæ­¥_å¿«é€Ÿæ£€æŸ¥:
    - é›†ç¾¤çŠ¶æ€
    - èŠ‚ç‚¹çŠ¶æ€
    - PodçŠ¶æ€
    - äº‹ä»¶æ—¥å¿—
  
  ç¬¬ä¸‰æ­¥_å®šä½é—®é¢˜:
    - æŸ¥çœ‹æ—¥å¿—
    - æ£€æŸ¥é…ç½®
    - èµ„æºä½¿ç”¨
    - ç½‘ç»œè¿é€šæ€§
  
  ç¬¬å››æ­¥_è§£å†³é—®é¢˜:
    - ä¸´æ—¶ç¼“è§£
    - æ ¹æœ¬ä¿®å¤
    - éªŒè¯ä¿®å¤
    - è®°å½•æ–‡æ¡£
  
  ç¬¬äº”æ­¥_é¢„é˜²æªæ–½:
    - åˆ†ææ ¹å› 
    - æ”¹è¿›ç›‘æ§
    - æ›´æ–°æ–‡æ¡£
    - å›¢é˜Ÿåˆ†äº«
```

**å¿«é€Ÿæ£€æŸ¥æ¸…å•**:

```bash
# 1. é›†ç¾¤æ•´ä½“çŠ¶æ€
kubectl cluster-info
kubectl get nodes
kubectl get componentstatuses

# 2. æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„Pod
kubectl get pods -A

# 3. æŸ¥çœ‹æœ€è¿‘äº‹ä»¶
kubectl get events -A --sort-by='.lastTimestamp' | tail -20

# 4. æŸ¥çœ‹èµ„æºä½¿ç”¨
kubectl top nodes
kubectl top pods -A

# 5. æ£€æŸ¥å…³é”®ç³»ç»Ÿç»„ä»¶
kubectl get pods -n kube-system
```

---

## 2. Podæ•…éšœæ’æŸ¥

```yaml
Pod_Troubleshooting:
  å¸¸è§çŠ¶æ€:
    Pending:
      åŸå› :
        - èµ„æºä¸è¶³ (CPU/å†…å­˜)
        - èŠ‚ç‚¹æ±¡ç‚¹ä¸åŒ¹é…
        - æŒä¹…å·ä¸å¯ç”¨
        - é•œåƒæ‹‰å–å¤±è´¥
    
    CrashLoopBackOff:
      åŸå› :
        - åº”ç”¨å¯åŠ¨å¤±è´¥
        - å¥åº·æ£€æŸ¥å¤±è´¥
        - é…ç½®é”™è¯¯
        - æƒé™é—®é¢˜
    
    ImagePullBackOff:
      åŸå› :
        - é•œåƒä¸å­˜åœ¨
        - è®¤è¯å¤±è´¥
        - ç½‘ç»œé—®é¢˜
        - ç§æœ‰ä»“åº“é…ç½®é”™è¯¯
    
    Error / Failed:
      åŸå› :
        - å®¹å™¨é€€å‡ºå¼‚å¸¸
        - OOMKilled (å†…å­˜æº¢å‡º)
        - åˆå§‹åŒ–å¤±è´¥
    
    Evicted:
      åŸå› :
        - èŠ‚ç‚¹èµ„æºä¸è¶³
        - ç£ç›˜å‹åŠ›
        - å†…å­˜å‹åŠ›
    
    Unknown:
      åŸå› :
        - Kubeletå¤±è”
        - èŠ‚ç‚¹æ•…éšœ
        - ç½‘ç»œåˆ†åŒº
```

**Podæ’æŸ¥å‘½ä»¤**:

```bash
# ========================================
# PodåŸºæœ¬ä¿¡æ¯
# ========================================

# æŸ¥çœ‹PodçŠ¶æ€
kubectl get pods -n <namespace>
kubectl get pods -n <namespace> -o wide  # æ˜¾ç¤ºèŠ‚ç‚¹ã€IP

# æŸ¥çœ‹Podè¯¦æƒ…
kubectl describe pod <pod-name> -n <namespace>

# æŸ¥çœ‹Pod YAML
kubectl get pod <pod-name> -n <namespace> -o yaml

# æŸ¥çœ‹Podäº‹ä»¶
kubectl get events --field-selector involvedObject.name=<pod-name> -n <namespace>

# ========================================
# Podæ—¥å¿—
# ========================================

# æŸ¥çœ‹å½“å‰æ—¥å¿—
kubectl logs <pod-name> -n <namespace>

# æŸ¥çœ‹ä¸Šä¸€ä¸ªå®¹å™¨æ—¥å¿— (é‡å¯å)
kubectl logs <pod-name> -n <namespace> --previous

# å¤šå®¹å™¨PodæŒ‡å®šå®¹å™¨
kubectl logs <pod-name> -c <container-name> -n <namespace>

# å®æ—¶æ—¥å¿—
kubectl logs -f <pod-name> -n <namespace>

# æœ€è¿‘Nè¡Œ
kubectl logs --tail=100 <pod-name> -n <namespace>

# æŒ‡å®šæ—¶é—´èŒƒå›´
kubectl logs --since=1h <pod-name> -n <namespace>
kubectl logs --since-time=2024-10-19T10:00:00Z <pod-name> -n <namespace>

# ========================================
# Podè°ƒè¯•
# ========================================

# è¿›å…¥å®¹å™¨
kubectl exec -it <pod-name> -n <namespace> -- /bin/bash

# æ‰§è¡Œå‘½ä»¤
kubectl exec <pod-name> -n <namespace> -- ls -la /app

# å¤šå®¹å™¨æŒ‡å®šå®¹å™¨
kubectl exec -it <pod-name> -c <container-name> -n <namespace> -- sh

# ç«¯å£è½¬å‘
kubectl port-forward <pod-name> 8080:80 -n <namespace>

# å¤åˆ¶æ–‡ä»¶
kubectl cp <pod-name>:/path/to/file ./local-file -n <namespace>
kubectl cp ./local-file <pod-name>:/path/to/file -n <namespace>

# ä¸´æ—¶è°ƒè¯•Pod
kubectl run debug-pod --image=busybox:1.28 -it --rm -- sh
```

**Podæ•…éšœåœºæ™¯ä¸è§£å†³**:

### åœºæ™¯1: Podä¸€ç›´å¤„äºPendingçŠ¶æ€

```bash
# 1. æŸ¥çœ‹Podè¯¦æƒ…
kubectl describe pod <pod-name> -n <namespace>

# å¸¸è§åŸå› å’Œè§£å†³æ–¹æ¡ˆ:

# A. èµ„æºä¸è¶³
# æŸ¥çœ‹äº‹ä»¶: "0/3 nodes are available: 3 Insufficient cpu."
kubectl top nodes  # æŸ¥çœ‹èŠ‚ç‚¹èµ„æº
# è§£å†³: å¢åŠ èŠ‚ç‚¹ã€å‡å°‘èµ„æºè¯·æ±‚ã€é©±é€ä½ä¼˜å…ˆçº§Pod

# B. èŠ‚ç‚¹é€‰æ‹©å™¨ä¸åŒ¹é…
# Events: "0/3 nodes are available: 3 node(s) didn't match node selector."
kubectl get nodes --show-labels  # æŸ¥çœ‹èŠ‚ç‚¹æ ‡ç­¾
# è§£å†³: ä¿®æ”¹nodeSelectoræˆ–ç»™èŠ‚ç‚¹æ·»åŠ æ ‡ç­¾

# C. æ±¡ç‚¹ä¸å®¹å¿
# Events: "0/3 nodes are available: 3 node(s) had taint {key: value}, that the pod didn't tolerate."
kubectl describe node <node-name> | grep Taints
# è§£å†³: æ·»åŠ tolerationæˆ–ç§»é™¤æ±¡ç‚¹

# D. PVCç»‘å®šå¤±è´¥
# Events: "pod has unbound immediate PersistentVolumeClaims"
kubectl get pvc -n <namespace>
# è§£å†³: åˆ›å»ºPVã€ä¿®å¤StorageClassã€æ£€æŸ¥è®¿é—®æ¨¡å¼
```

### åœºæ™¯2: CrashLoopBackOff

```bash
# 1. æŸ¥çœ‹Podæ—¥å¿—
kubectl logs <pod-name> -n <namespace> --previous

# 2. æŸ¥çœ‹é€€å‡ºç 
kubectl describe pod <pod-name> -n <namespace> | grep "Exit Code"

# å¸¸è§é€€å‡ºç :
# 0: æ­£å¸¸é€€å‡º
# 1: åº”ç”¨é”™è¯¯
# 137: SIGKILL (OOMKilled, å†…å­˜æº¢å‡º)
# 139: SIGSEGV (æ®µé”™è¯¯)
# 143: SIGTERM (æ­£å¸¸ç»ˆæ­¢)

# 3. æ£€æŸ¥èµ„æºé™åˆ¶
kubectl describe pod <pod-name> -n <namespace> | grep -A 5 "Limits"

# 4. æ£€æŸ¥å¥åº·æ£€æŸ¥
kubectl describe pod <pod-name> -n <namespace> | grep -A 10 "Liveness"

# è§£å†³æ–¹æ¡ˆ:
# - ä¿®å¤åº”ç”¨é”™è¯¯
# - å¢åŠ å†…å­˜limits
# - è°ƒæ•´å¥åº·æ£€æŸ¥å‚æ•° (initialDelaySeconds, periodSeconds)
# - æ£€æŸ¥ä¾èµ–æœåŠ¡ (æ•°æ®åº“ã€ç¼“å­˜)
```

### åœºæ™¯3: ImagePullBackOff

```bash
# 1. æŸ¥çœ‹è¯¦ç»†é”™è¯¯
kubectl describe pod <pod-name> -n <namespace>

# å¸¸è§é”™è¯¯:

# A. é•œåƒä¸å­˜åœ¨
# "Failed to pull image: manifest for image:tag not found"
# è§£å†³: ç¡®è®¤é•œåƒåç§°å’Œæ ‡ç­¾æ­£ç¡®

# B. è®¤è¯å¤±è´¥
# "Failed to pull image: unauthorized"
# æ£€æŸ¥imagePullSecrets
kubectl get secret -n <namespace>
kubectl describe pod <pod-name> -n <namespace> | grep "Image Pull Secrets"

# åˆ›å»ºdocker-registry secret
kubectl create secret docker-registry regcred \
  --docker-server=<registry-url> \
  --docker-username=<username> \
  --docker-password=<password> \
  -n <namespace>

# C. ç½‘ç»œé—®é¢˜
# æµ‹è¯•èŠ‚ç‚¹åˆ°Registryçš„è¿é€šæ€§
kubectl debug node/<node-name> -it --image=busybox:1.28
# nslookup registry.example.com
# wget https://registry.example.com

# D. ç§æœ‰ä»“åº“è¯ä¹¦é—®é¢˜
# åœ¨èŠ‚ç‚¹ä¸Šé…ç½®CAè¯ä¹¦
# /etc/docker/certs.d/<registry-url>/ca.crt
```

---

## 3. ç½‘ç»œæ•…éšœæ’æŸ¥

```yaml
Network_Troubleshooting:
  å¸¸è§é—®é¢˜:
    - Podé—´æ— æ³•é€šä¿¡
    - Serviceæ— æ³•è®¿é—®
    - Ingressä¸å·¥ä½œ
    - DNSè§£æå¤±è´¥
    - ç½‘ç»œç­–ç•¥é˜»æ­¢
```

**ç½‘ç»œæ’æŸ¥å‘½ä»¤**:

```bash
# ========================================
# Serviceæ’æŸ¥
# ========================================

# æŸ¥çœ‹Service
kubectl get svc -n <namespace>

# Serviceè¯¦æƒ…
kubectl describe svc <service-name> -n <namespace>

# æŸ¥çœ‹Endpoints
kubectl get endpoints <service-name> -n <namespace>

# å¦‚æœEndpointsä¸ºç©ºï¼Œæ£€æŸ¥:
# 1. Podæ˜¯å¦è¿è¡Œ
kubectl get pods -l <label-selector> -n <namespace>

# 2. Podæ ‡ç­¾æ˜¯å¦åŒ¹é…Service selector
kubectl get svc <service-name> -n <namespace> -o jsonpath='{.spec.selector}'

# 3. Podç«¯å£æ˜¯å¦æ­£ç¡®
kubectl get pods <pod-name> -n <namespace> -o jsonpath='{.spec.containers[*].ports}'

# ========================================
# DNSæ’æŸ¥
# ========================================

# æŸ¥çœ‹CoreDNS
kubectl get pods -n kube-system -l k8s-app=kube-dns

# CoreDNSæ—¥å¿—
kubectl logs -n kube-system -l k8s-app=kube-dns

# DNSæµ‹è¯•
kubectl run dnsutils --image=tutum/dnsutils -it --rm -- nslookup kubernetes.default

# æµ‹è¯•Service DNS
kubectl run dnsutils --image=tutum/dnsutils -it --rm -- nslookup <service-name>.<namespace>.svc.cluster.local

# æŸ¥çœ‹Pod DNSé…ç½®
kubectl exec <pod-name> -n <namespace> -- cat /etc/resolv.conf

# ========================================
# ç½‘ç»œè¿é€šæ€§æµ‹è¯•
# ========================================

# æµ‹è¯•Podåˆ°Pod
kubectl exec <pod1> -n <namespace> -- ping <pod2-ip>
kubectl exec <pod1> -n <namespace> -- curl http://<pod2-ip>:8080

# æµ‹è¯•Podåˆ°Service
kubectl exec <pod-name> -n <namespace> -- curl http://<service-name>

# æµ‹è¯•Podåˆ°å¤–éƒ¨
kubectl exec <pod-name> -n <namespace> -- ping 8.8.8.8
kubectl exec <pod-name> -n <namespace> -- curl https://www.google.com

# ========================================
# NetworkPolicyæ’æŸ¥
# ========================================

# æŸ¥çœ‹NetworkPolicy
kubectl get networkpolicy -n <namespace>

# NetworkPolicyè¯¦æƒ…
kubectl describe networkpolicy <policy-name> -n <namespace>

# ä¸´æ—¶åˆ é™¤NetworkPolicyæµ‹è¯•
kubectl delete networkpolicy <policy-name> -n <namespace>

# ========================================
# CNIæ’æŸ¥
# ========================================

# Calico
kubectl get pods -n kube-system -l k8s-app=calico-node
kubectl logs -n kube-system <calico-node-pod> -c calico-node

# Flannel
kubectl get pods -n kube-system -l app=flannel
kubectl logs -n kube-system <flannel-pod>

# Cilium
kubectl get pods -n kube-system -l k8s-app=cilium
kubectl exec -n kube-system <cilium-pod> -- cilium status
```

**ç½‘ç»œæ•…éšœåœºæ™¯**:

### åœºæ™¯1: Serviceæ— æ³•è®¿é—®

```bash
# 1. æ£€æŸ¥Service Endpoints
kubectl get endpoints <service-name> -n <namespace>

# 2. å¦‚æœEndpointsä¸ºç©º
# æ£€æŸ¥Podæ ‡ç­¾ä¸Service selectoræ˜¯å¦åŒ¹é…
kubectl get svc <service-name> -n <namespace> -o yaml | grep -A 5 selector
kubectl get pods -n <namespace> --show-labels

# 3. å¦‚æœEndpointsæ­£å¸¸ï¼Œæµ‹è¯•è¿æ¥
# ä»é›†ç¾¤å†…Podæµ‹è¯•
kubectl run test-pod --image=busybox:1.28 -it --rm -- wget -qO- http://<service-name>.<namespace>

# 4. æ£€æŸ¥kube-proxy
kubectl get pods -n kube-system -l k8s-app=kube-proxy
kubectl logs -n kube-system <kube-proxy-pod>

# 5. æ£€æŸ¥iptables/ipvsè§„åˆ™
kubectl exec -n kube-system <kube-proxy-pod> -- iptables-save | grep <service-name>
kubectl exec -n kube-system <kube-proxy-pod> -- ipvsadm -Ln
```

### åœºæ™¯2: DNSè§£æå¤±è´¥

```bash
# 1. æµ‹è¯•CoreDNS
kubectl run dnsutils --image=tutum/dnsutils -it --rm -- nslookup kubernetes.default

# 2. å¦‚æœå¤±è´¥ï¼Œæ£€æŸ¥CoreDNS Pod
kubectl get pods -n kube-system -l k8s-app=kube-dns
kubectl logs -n kube-system -l k8s-app=kube-dns

# 3. æ£€æŸ¥CoreDNS ConfigMap
kubectl get configmap coredns -n kube-system -o yaml

# 4. æ£€æŸ¥Service
kubectl get svc kube-dns -n kube-system

# 5. é‡å¯CoreDNS
kubectl rollout restart deployment coredns -n kube-system
```

---

## 4. å­˜å‚¨æ•…éšœæ’æŸ¥

```yaml
Storage_Troubleshooting:
  å¸¸è§é—®é¢˜:
    - PVCå¤„äºPendingçŠ¶æ€
    - Podæ— æ³•æŒ‚è½½å·
    - å·æ•°æ®ä¸¢å¤±
    - å­˜å‚¨æ€§èƒ½å·®
```

**å­˜å‚¨æ’æŸ¥å‘½ä»¤**:

```bash
# ========================================
# PV/PVCæ’æŸ¥
# ========================================

# æŸ¥çœ‹PVC
kubectl get pvc -n <namespace>

# PVCè¯¦æƒ…
kubectl describe pvc <pvc-name> -n <namespace>

# æŸ¥çœ‹PV
kubectl get pv

# PVè¯¦æƒ…
kubectl describe pv <pv-name>

# æŸ¥çœ‹StorageClass
kubectl get storageclass
kubectl describe storageclass <sc-name>

# ========================================
# å·æŒ‚è½½æ’æŸ¥
# ========================================

# æŸ¥çœ‹Podå·æŒ‚è½½
kubectl describe pod <pod-name> -n <namespace> | grep -A 10 "Mounts"

# æŸ¥çœ‹kubeletæ—¥å¿—
journalctl -u kubelet -f | grep -i volume

# ========================================
# CSI Driveræ’æŸ¥
# ========================================

# æŸ¥çœ‹CSI Pods
kubectl get pods -n kube-system | grep csi

# CSI Driveræ—¥å¿—
kubectl logs -n kube-system <csi-driver-pod> -c csi-provisioner
kubectl logs -n kube-system <csi-driver-pod> -c csi-attacher
```

**å­˜å‚¨æ•…éšœåœºæ™¯**:

### åœºæ™¯1: PVCä¸€ç›´Pending

```bash
# 1. æŸ¥çœ‹PVCäº‹ä»¶
kubectl describe pvc <pvc-name> -n <namespace>

# å¸¸è§åŸå› :

# A. æ²¡æœ‰å¯ç”¨çš„PV
# æ£€æŸ¥PV
kubectl get pv
# è§£å†³: åˆ›å»ºPVæˆ–ä½¿ç”¨åŠ¨æ€ä¾›åº”

# B. StorageClassä¸å­˜åœ¨
kubectl get storageclass
# è§£å†³: åˆ›å»ºStorageClass

# C. è®¿é—®æ¨¡å¼ä¸åŒ¹é…
# PVCè¦æ±‚RWXï¼Œä½†PVåªæ”¯æŒRWO
# è§£å†³: ä½¿ç”¨æ”¯æŒRWXçš„å­˜å‚¨ (NFS, CephFS)

# D. å®¹é‡ä¸è¶³
# PVCè¯·æ±‚10Giï¼Œä½†æœ€å¤§PVåªæœ‰5Gi
# è§£å†³: å¢åŠ PVå®¹é‡æˆ–å‡å°‘PVCè¯·æ±‚
```

### åœºæ™¯2: Podæ— æ³•æŒ‚è½½å·

```bash
# 1. æŸ¥çœ‹Podäº‹ä»¶
kubectl describe pod <pod-name> -n <namespace>

# å¸¸è§é”™è¯¯:

# "MountVolume.SetUp failed: mount failed"
# 2. æ£€æŸ¥èŠ‚ç‚¹å­˜å‚¨é©±åŠ¨
kubectl debug node/<node-name> -it --image=ubuntu
# lsblk
# mount | grep <volume>

# 3. æ£€æŸ¥NFS (å¦‚æœä½¿ç”¨NFS)
showmount -e <nfs-server>
mount -t nfs <nfs-server>:/path /mnt/test

# 4. æŸ¥çœ‹kubeletæ—¥å¿—
journalctl -u kubelet -n 100 | grep -i mount
```

---

## 5. èŠ‚ç‚¹æ•…éšœæ’æŸ¥

```yaml
Node_Troubleshooting:
  å¸¸è§çŠ¶æ€:
    NotReady:
      - kubeletåœæ­¢
      - ç½‘ç»œé—®é¢˜
      - èµ„æºè€—å°½
      - å®¹å™¨è¿è¡Œæ—¶æ•…éšœ
    
    MemoryPressure:
      - å†…å­˜ä¸è¶³
      - è§¦å‘é©±é€
    
    DiskPressure:
      - ç£ç›˜ä¸è¶³
      - é•œåƒæ¸…ç†
```

**èŠ‚ç‚¹æ’æŸ¥å‘½ä»¤**:

```bash
# ========================================
# èŠ‚ç‚¹çŠ¶æ€
# ========================================

# æŸ¥çœ‹èŠ‚ç‚¹
kubectl get nodes
kubectl get nodes -o wide

# èŠ‚ç‚¹è¯¦æƒ…
kubectl describe node <node-name>

# èŠ‚ç‚¹èµ„æºä½¿ç”¨
kubectl top node <node-name>

# ========================================
# Kubeletæ’æŸ¥
# ========================================

# æŸ¥çœ‹kubeletçŠ¶æ€
systemctl status kubelet

# kubeletæ—¥å¿—
journalctl -u kubelet -f
journalctl -u kubelet -n 100

# kubeleté…ç½®
cat /var/lib/kubelet/config.yaml

# ========================================
# å®¹å™¨è¿è¡Œæ—¶æ’æŸ¥
# ========================================

# containerd
systemctl status containerd
journalctl -u containerd -f

# æŸ¥çœ‹å®¹å™¨
crictl ps
crictl pods

# å®¹å™¨æ—¥å¿—
crictl logs <container-id>

# ========================================
# ç³»ç»Ÿèµ„æº
# ========================================

# å†…å­˜
free -h
cat /proc/meminfo

# CPU
top
mpstat 1

# ç£ç›˜
df -h
du -sh /var/lib/*

# ç½‘ç»œ
ip addr
ip route
netstat -tlnp
```

**èŠ‚ç‚¹æ•…éšœåœºæ™¯**:

### åœºæ™¯1: èŠ‚ç‚¹NotReady

```bash
# 1. æŸ¥çœ‹èŠ‚ç‚¹è¯¦æƒ…
kubectl describe node <node-name>

# 2. SSHç™»å½•èŠ‚ç‚¹æ£€æŸ¥

# A. kubeletçŠ¶æ€
systemctl status kubelet
journalctl -u kubelet --since "10 minutes ago"

# å¸¸è§é”™è¯¯:
# "Failed to get system container stats"
# è§£å†³: é‡å¯kubelet
sudo systemctl restart kubelet

# B. å®¹å™¨è¿è¡Œæ—¶
systemctl status containerd
crictl ps

# C. ç½‘ç»œè¿é€šæ€§
# æµ‹è¯•åˆ°API Server
curl -k https://<api-server>:6443

# D. ç£ç›˜ç©ºé—´
df -h
# å¦‚æœ/varæ»¡äº†ï¼Œæ¸…ç†
docker system prune -a
crictl rmi --prune

# E. ç³»ç»Ÿè´Ÿè½½
top
free -h
```

### åœºæ™¯2: èŠ‚ç‚¹èµ„æºå‹åŠ›

```bash
# 1. MemoryPressure
kubectl describe node <node-name> | grep -A 5 "Conditions"

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
kubectl top node <node-name>

# SSHç™»å½•èŠ‚ç‚¹
free -h
ps aux --sort=-%mem | head

# é©±é€ä½ä¼˜å…ˆçº§Pod
kubectl drain <node-name> --ignore-daemonsets --delete-emptydir-data

# 2. DiskPressure
df -h

# æ¸…ç†Dockeré•œåƒå’Œå®¹å™¨
docker system prune -a -f

# æ¸…ç†æ—¥å¿—
find /var/log -name "*.log" -type f -mtime +7 -delete
journalctl --vacuum-time=7d
```

---

## 6. æ§åˆ¶å¹³é¢æ•…éšœæ’æŸ¥

```yaml
Control_Plane_Troubleshooting:
  ç»„ä»¶:
    - kube-apiserver
    - etcd
    - kube-controller-manager
    - kube-scheduler
```

**æ§åˆ¶å¹³é¢æ’æŸ¥**:

```bash
# ========================================
# API Server
# ========================================

# æŸ¥çœ‹Pod
kubectl get pods -n kube-system | grep apiserver

# æ—¥å¿—
kubectl logs -n kube-system kube-apiserver-<node> --tail=100

# æˆ–è€…æŸ¥çœ‹é™æ€Podæ—¥å¿—
journalctl -u kubelet | grep apiserver

# API Serverå¥åº·æ£€æŸ¥
curl -k https://localhost:6443/healthz
curl -k https://localhost:6443/readyz

# ========================================
# etcd
# ========================================

# æŸ¥çœ‹etcd Pod
kubectl get pods -n kube-system | grep etcd

# etcdæ—¥å¿—
kubectl logs -n kube-system etcd-<node>

# etcdå¥åº·æ£€æŸ¥
export ETCDCTL_API=3
etcdctl --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  endpoint health

# etcdæˆå‘˜
etcdctl member list

# ========================================
# Controller Manager
# ========================================

# æ—¥å¿—
kubectl logs -n kube-system kube-controller-manager-<node>

# å¥åº·æ£€æŸ¥
curl -k https://localhost:10257/healthz

# ========================================
# Scheduler
# ========================================

# æ—¥å¿—
kubectl logs -n kube-system kube-scheduler-<node>

# å¥åº·æ£€æŸ¥
curl -k https://localhost:10259/healthz
```

---

## 7. æ€§èƒ½é—®é¢˜æ’æŸ¥

```bash
# ========================================
# é›†ç¾¤æ€§èƒ½
# ========================================

# æŸ¥çœ‹èµ„æºä½¿ç”¨
kubectl top nodes
kubectl top pods -A --sort-by=cpu
kubectl top pods -A --sort-by=memory

# API ServeræŒ‡æ ‡
kubectl get --raw /metrics | grep apiserver_request_duration

# ========================================
# Podæ€§èƒ½
# ========================================

# è¿›å…¥PodæŸ¥çœ‹
kubectl exec -it <pod-name> -- top
kubectl exec -it <pod-name> -- ps aux

# èµ„æºé™åˆ¶æ£€æŸ¥
kubectl describe pod <pod-name> | grep -A 10 "Limits"

# ========================================
# ç½‘ç»œæ€§èƒ½
# ========================================

# Podé—´å»¶è¿Ÿæµ‹è¯•
kubectl run test-source --image=nicolaka/netshoot -it --rm -- bash
# ping <target-pod-ip>
# curl -w "@curl-format.txt" http://<target-service>

# ========================================
# å­˜å‚¨æ€§èƒ½
# ========================================

# ç£ç›˜IOæµ‹è¯•
kubectl exec -it <pod-name> -- dd if=/dev/zero of=/mnt/test bs=1M count=1024
kubectl exec -it <pod-name> -- hdparm -t /dev/sda
```

---

## 8. å¸¸ç”¨è¯Šæ–­å‘½ä»¤

```bash
# ========================================
# èµ„æºæŸ¥çœ‹
# ========================================

# æŸ¥çœ‹æ‰€æœ‰èµ„æº
kubectl get all -A

# æŒ‰æ ‡ç­¾è¿‡æ»¤
kubectl get pods -l app=nginx -A

# è¾“å‡ºæ ¼å¼
kubectl get pods -o wide
kubectl get pods -o yaml
kubectl get pods -o json
kubectl get pods -o jsonpath='{.items[*].metadata.name}'

# Watchæ¨¡å¼
kubectl get pods -w
kubectl get events -w

# ========================================
# è¯¦ç»†ä¿¡æ¯
# ========================================

# Describe
kubectl describe node <node-name>
kubectl describe pod <pod-name>
kubectl describe svc <service-name>

# æŸ¥çœ‹YAML
kubectl get pod <pod-name> -o yaml

# ç¼–è¾‘èµ„æº
kubectl edit pod <pod-name>

# ========================================
# è°ƒè¯•
# ========================================

# ä¸´æ—¶è°ƒè¯•Pod
kubectl run debug --image=nicolaka/netshoot -it --rm -- bash

# åœ¨ç°æœ‰Podæ—è¾¹åˆ›å»ºè°ƒè¯•å®¹å™¨ (1.23+)
kubectl debug <pod-name> -it --image=busybox --share-processes --copy-to=debug-pod

# åœ¨èŠ‚ç‚¹ä¸Šè°ƒè¯•
kubectl debug node/<node-name> -it --image=ubuntu

# ========================================
# æ‰¹é‡æ“ä½œ
# ========================================

# æ‰¹é‡åˆ é™¤
kubectl delete pods --field-selector=status.phase=Failed -A
kubectl delete pods --all -n <namespace>

# æ‰¹é‡é‡å¯
kubectl rollout restart deployment -n <namespace>
kubectl delete pods -l app=myapp -n <namespace>

# ========================================
# èµ„æºä½¿ç”¨
# ========================================

# èµ„æºé…é¢
kubectl describe quota -n <namespace>

# èµ„æºé™åˆ¶
kubectl describe limitrange -n <namespace>

# PV/PVC
kubectl get pv
kubectl get pvc -A
```

---

## 9. æ—¥å¿—æ”¶é›†

```bash
# ========================================
# ç»„ä»¶æ—¥å¿—
# ========================================

# kubelet
journalctl -u kubelet -n 1000 > kubelet.log

# containerd
journalctl -u containerd -n 1000 > containerd.log

# API Server
kubectl logs -n kube-system kube-apiserver-<node> > apiserver.log

# etcd
kubectl logs -n kube-system etcd-<node> > etcd.log

# Controller Manager
kubectl logs -n kube-system kube-controller-manager-<node> > controller.log

# Scheduler
kubectl logs -n kube-system kube-scheduler-<node> > scheduler.log

# ========================================
# é›†ç¾¤ä¿¡æ¯å¯¼å‡º
# ========================================

# æ‰€æœ‰Pod
kubectl get pods -A -o yaml > all-pods.yaml

# æ‰€æœ‰äº‹ä»¶
kubectl get events -A --sort-by='.lastTimestamp' > events.log

# èŠ‚ç‚¹ä¿¡æ¯
kubectl get nodes -o yaml > nodes.yaml
kubectl describe nodes > nodes-describe.txt

# ========================================
# æ‰¹é‡æ—¥å¿—æ”¶é›†è„šæœ¬
# ========================================

#!/bin/bash
# collect-logs.sh

NAMESPACE="default"
OUTPUT_DIR="./k8s-logs-$(date +%Y%m%d-%H%M%S)"

mkdir -p $OUTPUT_DIR

# é›†ç¾¤ä¿¡æ¯
kubectl cluster-info > $OUTPUT_DIR/cluster-info.txt
kubectl get nodes -o wide > $OUTPUT_DIR/nodes.txt
kubectl get pods -A -o wide > $OUTPUT_DIR/all-pods.txt
kubectl get events -A --sort-by='.lastTimestamp' > $OUTPUT_DIR/events.txt

# å‘½åç©ºé—´èµ„æº
kubectl get all -n $NAMESPACE > $OUTPUT_DIR/resources-$NAMESPACE.txt

# Podæ—¥å¿—
for pod in $(kubectl get pods -n $NAMESPACE -o jsonpath='{.items[*].metadata.name}'); do
  kubectl logs $pod -n $NAMESPACE --all-containers=true > $OUTPUT_DIR/pod-$pod.log 2>&1
done

# ç³»ç»Ÿç»„ä»¶æ—¥å¿—
kubectl logs -n kube-system -l component=kube-apiserver --tail=1000 > $OUTPUT_DIR/apiserver.log
kubectl logs -n kube-system -l component=etcd --tail=1000 > $OUTPUT_DIR/etcd.log
kubectl logs -n kube-system -l k8s-app=kube-dns --tail=1000 > $OUTPUT_DIR/coredns.log

echo "Logs collected in $OUTPUT_DIR"
```

---

## 10. æ•…éšœé¢„é˜²æœ€ä½³å®è·µ

```yaml
Prevention_Best_Practices:
  ç›‘æ§å‘Šè­¦:
    âœ… éƒ¨ç½²Prometheus + Grafana
    âœ… é…ç½®å…³é”®æŒ‡æ ‡å‘Šè­¦
    âœ… ç›‘æ§é›†ç¾¤å’Œåº”ç”¨å¥åº·
    âœ… æ—¥å¿—èšåˆ (ELK/EFK)
  
  èµ„æºç®¡ç†:
    âœ… è®¾ç½®èµ„æºrequestså’Œlimits
    âœ… é…ç½®ResourceQuota
    âœ… ä½¿ç”¨HPA
    âœ… å®šæœŸæ£€æŸ¥èµ„æºä½¿ç”¨
  
  é«˜å¯ç”¨:
    âœ… å¤šå‰¯æœ¬éƒ¨ç½²
    âœ… PodDisruptionBudget
    âœ… è·¨AZåˆ†å¸ƒ
    âœ… å®šæœŸå¤‡ä»½etcd
  
  å¥åº·æ£€æŸ¥:
    âœ… é…ç½®Liveness Probe
    âœ… é…ç½®Readiness Probe
    âœ… åˆç†è®¾ç½®æ¢é’ˆå‚æ•°
    âœ… ä¼˜é›…ç»ˆæ­¢ (preStop)
  
  å˜æ›´ç®¡ç†:
    âœ… ä½¿ç”¨æ»šåŠ¨æ›´æ–°
    âœ… é‡‘ä¸é›€å‘å¸ƒ
    âœ… ç‰ˆæœ¬æ§åˆ¶
    âœ… å˜æ›´å‰å¤‡ä»½
  
  å®‰å…¨:
    âœ… RBACæœ€å°æƒé™
    âœ… NetworkPolicy
    âœ… Pod Security Standards
    âœ… å®šæœŸæ›´æ–°é›†ç¾¤
  
  æ–‡æ¡£:
    âœ… æ•…éšœå¤„ç†æ‰‹å†Œ
    âœ… è¿ç»´æ–‡æ¡£
    âœ… æ¶æ„å›¾
    âœ… è”ç³»äººæ¸…å•
```

---

## ç›¸å…³æ–‡æ¡£

- [Kubernetesé›†ç¾¤éƒ¨ç½²](01_é›†ç¾¤éƒ¨ç½².md)
- [Kubernetesæ ¸å¿ƒç»„ä»¶](02_æ ¸å¿ƒç»„ä»¶.md)
- [Kubernetesåº”ç”¨éƒ¨ç½²](03_åº”ç”¨éƒ¨ç½².md)
- [Kubernetesèµ„æºç®¡ç†](04_èµ„æºç®¡ç†.md)
- [Kubernetesé«˜å¯ç”¨æ¶æ„](../../01_è™šæ‹ŸåŒ–éƒ¨ç½²/05_é«˜å¯ç”¨å®¹ç¾/02_Kubernetesé«˜å¯ç”¨æ¶æ„.md)

---

**æ›´æ–°æ—¶é—´**: 2025-10-19  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
