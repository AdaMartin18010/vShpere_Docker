# Kubernetesæ ¸å¿ƒç»„ä»¶

> **è¿”å›**: [Kuberneteséƒ¨ç½²ç›®å½•](README.md) | [å®¹å™¨åŒ–éƒ¨ç½²é¦–é¡µ](../README.md) | [éƒ¨ç½²æŒ‡å—é¦–é¡µ](../../00_ç´¢å¼•å¯¼èˆª/README.md)

---

## ğŸ“‹ ç›®å½•

- [Kubernetesæ ¸å¿ƒç»„ä»¶](#kubernetesæ ¸å¿ƒç»„ä»¶)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ç»„ä»¶æ¶æ„æ¦‚è¿°](#1-ç»„ä»¶æ¶æ„æ¦‚è¿°)
  - [2. kube-apiserver](#2-kube-apiserver)
  - [3. etcd](#3-etcd)
  - [4. kube-controller-manager](#4-kube-controller-manager)
  - [5. kube-scheduler](#5-kube-scheduler)
  - [6. kubelet](#6-kubelet)
  - [7. kube-proxy](#7-kube-proxy)
  - [8. ç»„ä»¶é€šä¿¡ä¸è®¤è¯](#8-ç»„ä»¶é€šä¿¡ä¸è®¤è¯)
  - [9. ç»„ä»¶ç›‘æ§ä¸æ—¥å¿—](#9-ç»„ä»¶ç›‘æ§ä¸æ—¥å¿—)
  - [10. æ€§èƒ½è°ƒä¼˜](#10-æ€§èƒ½è°ƒä¼˜)
  - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## 1. ç»„ä»¶æ¶æ„æ¦‚è¿°

```yaml
Kubernetes_Architecture:
  æ§åˆ¶å¹³é¢ç»„ä»¶ (Control Plane):
    kube-apiserver:
      ä½œç”¨: é›†ç¾¤APIå…¥å£ï¼ŒRESTfulæ¥å£
      ç«¯å£: 6443
      é«˜å¯ç”¨: å¤šå®ä¾‹è´Ÿè½½å‡è¡¡
    
    etcd:
      ä½œç”¨: åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ï¼Œé›†ç¾¤æ•°æ®æŒä¹…åŒ–
      ç«¯å£: 2379 (å®¢æˆ·ç«¯), 2380 (é›†ç¾¤é€šä¿¡)
      é«˜å¯ç”¨: 3/5/7èŠ‚ç‚¹é›†ç¾¤
    
    kube-controller-manager:
      ä½œç”¨: è¿è¡Œæ§åˆ¶å™¨ï¼Œç»´æŠ¤é›†ç¾¤æœŸæœ›çŠ¶æ€
      ç«¯å£: 10257
      é«˜å¯ç”¨: Leaderé€‰ä¸¾
    
    kube-scheduler:
      ä½œç”¨: Podè°ƒåº¦å™¨ï¼Œåˆ†é…Podåˆ°èŠ‚ç‚¹
      ç«¯å£: 10259
      é«˜å¯ç”¨: Leaderé€‰ä¸¾
    
    cloud-controller-manager (å¯é€‰):
      ä½œç”¨: äº‘å¹³å°é›†æˆ
      é«˜å¯ç”¨: Leaderé€‰ä¸¾
  
  èŠ‚ç‚¹ç»„ä»¶ (Node Components):
    kubelet:
      ä½œç”¨: èŠ‚ç‚¹ä»£ç†ï¼Œç®¡ç†Podç”Ÿå‘½å‘¨æœŸ
      ç«¯å£: 10250
      æ¯èŠ‚ç‚¹ä¸€ä¸ªå®ä¾‹
    
    kube-proxy:
      ä½œç”¨: ç½‘ç»œä»£ç†ï¼Œå®ç°Service
      ç«¯å£: 10256
      æ¯èŠ‚ç‚¹ä¸€ä¸ªå®ä¾‹
    
    Container Runtime:
      - containerd (æ¨è)
      - Docker Engine (deprecated)
      - CRI-O
  
  æ’ä»¶ (Addons):
    CoreDNS: é›†ç¾¤DNS
    CNI: ç½‘ç»œæ’ä»¶ (Calico, Flannel, Cilium)
    CSI: å­˜å‚¨æ’ä»¶ (Rook-Ceph, Longhorn)
    Metrics Server: èµ„æºæŒ‡æ ‡
    Dashboard: Web UI
    Ingress Controller: HTTPè·¯ç”±

  é€šä¿¡æµç¨‹:
    kubectl -> kube-apiserver -> etcd (å­˜å‚¨)
    kube-apiserver -> kubelet -> Container Runtime
    kube-scheduler -> kube-apiserver (è°ƒåº¦å†³ç­–)
    kube-controller-manager -> kube-apiserver (æ§åˆ¶å¾ªç¯)
```

---

## 2. kube-apiserver

```yaml
kube_apiserver:
  åŠŸèƒ½:
    - æä¾›Kubernetes API
    - è®¤è¯ã€æˆæƒã€å‡†å…¥æ§åˆ¶
    - æ•°æ®éªŒè¯å’Œè½¬æ¢
    - ä¸etcdäº¤äº’
    - é›†ç¾¤ç»„ä»¶é€šä¿¡æ¢çº½
  
  å…³é”®ç‰¹æ€§:
    RESTful API:
      - HTTP/HTTPS
      - JSONæ ¼å¼
      - èµ„æºç‰ˆæœ¬æ§åˆ¶
    
    è®¤è¯ (Authentication):
      - X509è¯ä¹¦
      - Bearer Token
      - Basic Auth (ä¸æ¨è)
      - OpenID Connect
      - Webhook Token
    
    æˆæƒ (Authorization):
      - RBAC (æ¨è)
      - ABAC
      - Node
      - Webhook
    
    å‡†å…¥æ§åˆ¶ (Admission Control):
      - ValidatingAdmissionWebhook
      - MutatingAdmissionWebhook
      - ResourceQuota
      - LimitRanger
      - PodSecurityPolicy
  
  é…ç½®å‚æ•° (é‡è¦):
    åŸºç¡€é…ç½®:
      --advertise-address: API Serverç›‘å¬IP
      --bind-address: ç»‘å®šåœ°å€
      --secure-port: HTTPSç«¯å£ (é»˜è®¤6443)
      --insecure-port: HTTPç«¯å£ (å·²åºŸå¼ƒ)
    
    etcdé…ç½®:
      --etcd-servers: etcdæœåŠ¡å™¨åœ°å€
      --etcd-cafile: etcd CAè¯ä¹¦
      --etcd-certfile: etcdå®¢æˆ·ç«¯è¯ä¹¦
      --etcd-keyfile: etcdå®¢æˆ·ç«¯å¯†é’¥
    
    è®¤è¯æˆæƒ:
      --client-ca-file: å®¢æˆ·ç«¯CAè¯ä¹¦
      --authorization-mode: æˆæƒæ¨¡å¼ (Node,RBAC)
      --enable-admission-plugins: å¯ç”¨çš„å‡†å…¥æ’ä»¶
    
    æ€§èƒ½ä¼˜åŒ–:
      --max-requests-inflight: æœ€å¤§å¹¶å‘è¯·æ±‚æ•° (é»˜è®¤400)
      --max-mutating-requests-inflight: æœ€å¤§å˜æ›´è¯·æ±‚ (é»˜è®¤200)
      --request-timeout: è¯·æ±‚è¶…æ—¶æ—¶é—´ (é»˜è®¤60s)
    
    å®¡è®¡æ—¥å¿—:
      --audit-log-path: å®¡è®¡æ—¥å¿—è·¯å¾„
      --audit-log-maxage: æ—¥å¿—ä¿ç•™å¤©æ•°
      --audit-log-maxsize: å•ä¸ªæ—¥å¿—æ–‡ä»¶å¤§å°
      --audit-policy-file: å®¡è®¡ç­–ç•¥æ–‡ä»¶
```

**API Serveré…ç½®ç¤ºä¾‹**:

```yaml
# /etc/kubernetes/manifests/kube-apiserver.yaml
apiVersion: v1
kind: Pod
metadata:
  name: kube-apiserver
  namespace: kube-system
spec:
  containers:
  - name: kube-apiserver
    image: registry.k8s.io/kube-apiserver:v1.28.0
    command:
    - kube-apiserver
    - --advertise-address=192.168.1.10
    - --allow-privileged=true
    - --authorization-mode=Node,RBAC
    - --client-ca-file=/etc/kubernetes/pki/ca.crt
    - --enable-admission-plugins=NodeRestriction,PodSecurityPolicy
    - --enable-bootstrap-token-auth=true
    - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt
    - --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt
    - --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key
    - --etcd-servers=https://127.0.0.1:2379
    - --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt
    - --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key
    - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
    - --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt
    - --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key
    - --requestheader-allowed-names=front-proxy-client
    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt
    - --requestheader-extra-headers-prefix=X-Remote-Extra-
    - --requestheader-group-headers=X-Remote-Group
    - --requestheader-username-headers=X-Remote-User
    - --secure-port=6443
    - --service-account-issuer=https://kubernetes.default.svc.cluster.local
    - --service-account-key-file=/etc/kubernetes/pki/sa.pub
    - --service-account-signing-key-file=/etc/kubernetes/pki/sa.key
    - --service-cluster-ip-range=10.96.0.0/12
    - --tls-cert-file=/etc/kubernetes/pki/apiserver.crt
    - --tls-private-key-file=/etc/kubernetes/pki/apiserver.key
    # æ€§èƒ½ä¼˜åŒ–
    - --max-requests-inflight=800
    - --max-mutating-requests-inflight=400
    # å®¡è®¡æ—¥å¿—
    - --audit-log-path=/var/log/kubernetes/audit.log
    - --audit-log-maxage=30
    - --audit-log-maxbackup=10
    - --audit-log-maxsize=100
    - --audit-policy-file=/etc/kubernetes/audit-policy.yaml
    volumeMounts:
    - mountPath: /etc/kubernetes/pki
      name: k8s-certs
      readOnly: true
    - mountPath: /var/log/kubernetes
      name: audit-log
  volumes:
  - hostPath:
      path: /etc/kubernetes/pki
      type: DirectoryOrCreate
    name: k8s-certs
  - hostPath:
      path: /var/log/kubernetes
      type: DirectoryOrCreate
    name: audit-log
```

**å®¡è®¡ç­–ç•¥é…ç½®**:

```yaml
# /etc/kubernetes/audit-policy.yaml
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
  # ä¸è®°å½•åªè¯»è¯·æ±‚
  - level: None
    verbs: ["get", "list", "watch"]
  
  # ä¸è®°å½•ç³»ç»Ÿäº‹ä»¶
  - level: None
    users: ["system:kube-proxy"]
    verbs: ["watch"]
    resources:
      - group: ""
        resources: ["endpoints", "services"]
  
  # è®°å½•Secretçš„å…ƒæ•°æ®
  - level: Metadata
    resources:
      - group: ""
        resources: ["secrets", "configmaps"]
  
  # è®°å½•Podå˜æ›´çš„è¯·æ±‚ä½“
  - level: Request
    resources:
      - group: ""
        resources: ["pods"]
    verbs: ["create", "update", "patch", "delete"]
  
  # é»˜è®¤è®°å½•å…ƒæ•°æ®
  - level: Metadata
    omitStages:
      - "RequestReceived"
```

---

## 3. etcd

```yaml
etcd:
  ä½œç”¨:
    - åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨
    - å­˜å‚¨æ‰€æœ‰é›†ç¾¤æ•°æ®
    - ä¸€è‡´æ€§ä¿è¯ (Raftç®—æ³•)
    - é«˜å¯ç”¨
  
  å…³é”®ç‰¹æ€§:
    Raftå…±è¯†ç®—æ³•:
      - Leaderé€‰ä¸¾
      - æ—¥å¿—å¤åˆ¶
      - å®‰å…¨æ€§ä¿è¯
    
    æ•°æ®æ¨¡å‹:
      - é”®å€¼å­˜å‚¨
      - åˆ†å±‚å‘½åç©ºé—´
      - ç‰ˆæœ¬æ§åˆ¶
      - Watchæœºåˆ¶
    
    æ€§èƒ½:
      - å†™å…¥å»¶è¿Ÿ < 10ms (æœ¬åœ°SSD)
      - æ¯ç§’10,000æ¬¡å†™å…¥
      - æ”¯æŒç™¾ä¸‡çº§é”®
  
  éƒ¨ç½²æ¨¡å¼:
    å †å etcd (Stacked):
      - etcdä¸æ§åˆ¶å¹³é¢ç»„ä»¶åŒèŠ‚ç‚¹
      - ç®€åŒ–éƒ¨ç½²
      - èµ„æºå…±äº«
      - æ¨è3/5/7èŠ‚ç‚¹
    
    å¤–éƒ¨etcd (External):
      - etcdç‹¬ç«‹éƒ¨ç½²
      - èµ„æºéš”ç¦»
      - æ›´é«˜å¯ç”¨æ€§
      - æ¨èå¤§è§„æ¨¡é›†ç¾¤
  
  é…ç½®å‚æ•°:
    åŸºç¡€é…ç½®:
      --name: èŠ‚ç‚¹åç§°
      --data-dir: æ•°æ®ç›®å½•
      --listen-client-urls: å®¢æˆ·ç«¯ç›‘å¬åœ°å€
      --advertise-client-urls: å®¢æˆ·ç«¯é€šå‘Šåœ°å€
      --listen-peer-urls: é›†ç¾¤é€šä¿¡ç›‘å¬åœ°å€
      --initial-advertise-peer-urls: é›†ç¾¤é€šä¿¡é€šå‘Šåœ°å€
    
    é›†ç¾¤é…ç½®:
      --initial-cluster: åˆå§‹é›†ç¾¤æˆå‘˜
      --initial-cluster-state: é›†ç¾¤çŠ¶æ€ (new/existing)
      --initial-cluster-token: é›†ç¾¤ä»¤ç‰Œ
    
    å®‰å…¨é…ç½®:
      --cert-file: æœåŠ¡å™¨è¯ä¹¦
      --key-file: æœåŠ¡å™¨å¯†é’¥
      --client-cert-auth: å¯ç”¨å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯
      --trusted-ca-file: å®¢æˆ·ç«¯CAè¯ä¹¦
      --peer-cert-file: é›†ç¾¤é€šä¿¡è¯ä¹¦
      --peer-key-file: é›†ç¾¤é€šä¿¡å¯†é’¥
    
    æ€§èƒ½é…ç½®:
      --heartbeat-interval: å¿ƒè·³é—´éš” (é»˜è®¤100ms)
      --election-timeout: é€‰ä¸¾è¶…æ—¶ (é»˜è®¤1000ms)
      --snapshot-count: å¿«ç…§è§¦å‘é˜ˆå€¼ (é»˜è®¤100000)
      --quota-backend-bytes: åç«¯å­˜å‚¨é…é¢ (é»˜è®¤2GB)
```

**etcdé›†ç¾¤é…ç½®ç¤ºä¾‹**:

```bash
# etcdèŠ‚ç‚¹1
etcd \
  --name=etcd-1 \
  --data-dir=/var/lib/etcd \
  --listen-client-urls=https://192.168.1.10:2379 \
  --advertise-client-urls=https://192.168.1.10:2379 \
  --listen-peer-urls=https://192.168.1.10:2380 \
  --initial-advertise-peer-urls=https://192.168.1.10:2380 \
  --initial-cluster=etcd-1=https://192.168.1.10:2380,etcd-2=https://192.168.1.11:2380,etcd-3=https://192.168.1.12:2380 \
  --initial-cluster-state=new \
  --initial-cluster-token=etcd-cluster-1 \
  --cert-file=/etc/etcd/pki/server.crt \
  --key-file=/etc/etcd/pki/server.key \
  --client-cert-auth=true \
  --trusted-ca-file=/etc/etcd/pki/ca.crt \
  --peer-cert-file=/etc/etcd/pki/peer.crt \
  --peer-key-file=/etc/etcd/pki/peer.key \
  --peer-client-cert-auth=true \
  --peer-trusted-ca-file=/etc/etcd/pki/ca.crt
```

**etcdè¿ç»´å‘½ä»¤**:

```bash
# è®¾ç½®etcdctlç¯å¢ƒå˜é‡
export ETCDCTL_API=3
export ETCDCTL_ENDPOINTS=https://192.168.1.10:2379,https://192.168.1.11:2379,https://192.168.1.12:2379
export ETCDCTL_CACERT=/etc/kubernetes/pki/etcd/ca.crt
export ETCDCTL_CERT=/etc/kubernetes/pki/etcd/server.crt
export ETCDCTL_KEY=/etc/kubernetes/pki/etcd/server.key

# æ£€æŸ¥é›†ç¾¤å¥åº·
etcdctl endpoint health

# æŸ¥çœ‹æˆå‘˜åˆ—è¡¨
etcdctl member list

# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
etcdctl endpoint status --write-out=table

# å¤‡ä»½etcd
etcdctl snapshot save /backup/etcd-snapshot-$(date +%Y%m%d-%H%M%S).db

# æ¢å¤etcd (å±é™©æ“ä½œ)
etcdctl snapshot restore snapshot.db \
  --name etcd-1 \
  --initial-cluster etcd-1=https://192.168.1.10:2380 \
  --initial-advertise-peer-urls https://192.168.1.10:2380 \
  --data-dir /var/lib/etcd-restored

# ç¢ç‰‡æ•´ç†
etcdctl defrag --cluster

# æŸ¥çœ‹etcdæ•°æ®å¤§å°
etcdctl endpoint status --write-out="json" | python -m json.tool
```

---

## 4. kube-controller-manager

```yaml
kube_controller_manager:
  ä½œç”¨:
    - è¿è¡Œæ§åˆ¶å™¨
    - ç»´æŠ¤é›†ç¾¤æœŸæœ›çŠ¶æ€
    - å“åº”é›†ç¾¤å˜åŒ–
  
  å†…ç½®æ§åˆ¶å™¨:
    Node Controller:
      - ç›‘æ§èŠ‚ç‚¹å¥åº·
      - èŠ‚ç‚¹çŠ¶æ€æ›´æ–°
      - Podé©±é€
    
    Replication Controller:
      - ç»´æŠ¤Podå‰¯æœ¬æ•°
      - æ›¿æ¢å¤±è´¥Pod
    
    Endpoints Controller:
      - å¡«å……Endpointså¯¹è±¡
      - è¿æ¥Serviceå’ŒPod
    
    Service Account Controller:
      - åˆ›å»ºé»˜è®¤ServiceAccount
      - ç”ŸæˆToken
    
    Namespace Controller:
      - ç›‘å¬Namespaceåˆ é™¤
      - æ¸…ç†Namespaceèµ„æº
    
    Deployment Controller:
      - ç®¡ç†Deployment
      - æ»šåŠ¨æ›´æ–°
      - å›æ»š
    
    StatefulSet Controller:
      - ç®¡ç†æœ‰çŠ¶æ€åº”ç”¨
      - é¡ºåºéƒ¨ç½²/åˆ é™¤
      - æŒä¹…åŒ–æ ‡è¯†
    
    DaemonSet Controller:
      - æ¯ä¸ªèŠ‚ç‚¹è¿è¡ŒPod
      - èŠ‚ç‚¹å¢åˆ è‡ªåŠ¨è°ƒæ•´
    
    Job Controller:
      - è¿è¡Œä¸€æ¬¡æ€§ä»»åŠ¡
      - å¹¶è¡Œæ‰§è¡Œ
    
    CronJob Controller:
      - å®šæ—¶ä»»åŠ¡
      - Cronè¡¨è¾¾å¼
  
  é…ç½®å‚æ•°:
    åŸºç¡€é…ç½®:
      --kubeconfig: kubeconfigæ–‡ä»¶è·¯å¾„
      --leader-elect: å¯ç”¨Leaderé€‰ä¸¾
      --leader-elect-lease-duration: Leaderç§Ÿçº¦æ—¶é•¿
    
    æ§åˆ¶å™¨é…ç½®:
      --controllers: å¯ç”¨çš„æ§åˆ¶å™¨åˆ—è¡¨ (*è¡¨ç¤ºæ‰€æœ‰)
      --node-monitor-period: èŠ‚ç‚¹ç›‘æ§å‘¨æœŸ (é»˜è®¤5s)
      --node-monitor-grace-period: èŠ‚ç‚¹å¤±è”å®½é™æœŸ (é»˜è®¤40s)
      --pod-eviction-timeout: Podé©±é€è¶…æ—¶ (é»˜è®¤5m)
    
    èµ„æºé…ç½®:
      --concurrent-deployment-syncs: Deploymentå¹¶å‘åŒæ­¥æ•°
      --concurrent-replicaset-syncs: ReplicaSetå¹¶å‘åŒæ­¥æ•°
      --concurrent-service-syncs: Serviceå¹¶å‘åŒæ­¥æ•°
```

**Controller Manageré…ç½®**:

```yaml
# /etc/kubernetes/manifests/kube-controller-manager.yaml
apiVersion: v1
kind: Pod
metadata:
  name: kube-controller-manager
  namespace: kube-system
spec:
  containers:
  - name: kube-controller-manager
    image: registry.k8s.io/kube-controller-manager:v1.28.0
    command:
    - kube-controller-manager
    - --allocate-node-cidrs=true
    - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf
    - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf
    - --bind-address=127.0.0.1
    - --client-ca-file=/etc/kubernetes/pki/ca.crt
    - --cluster-cidr=10.244.0.0/16
    - --cluster-name=kubernetes
    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt
    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key
    - --controllers=*,bootstrapsigner,tokencleaner
    - --kubeconfig=/etc/kubernetes/controller-manager.conf
    - --leader-elect=true
    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt
    - --root-ca-file=/etc/kubernetes/pki/ca.crt
    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key
    - --service-cluster-ip-range=10.96.0.0/12
    - --use-service-account-credentials=true
    # èŠ‚ç‚¹ç›‘æ§é…ç½®
    - --node-monitor-period=5s
    - --node-monitor-grace-period=40s
    - --pod-eviction-timeout=5m0s
    # æ€§èƒ½ä¼˜åŒ–
    - --concurrent-deployment-syncs=5
    - --concurrent-replicaset-syncs=5
    - --concurrent-service-syncs=2
    volumeMounts:
    - mountPath: /etc/kubernetes/pki
      name: k8s-certs
      readOnly: true
    - mountPath: /etc/kubernetes/controller-manager.conf
      name: kubeconfig
      readOnly: true
  volumes:
  - hostPath:
      path: /etc/kubernetes/pki
      type: DirectoryOrCreate
    name: k8s-certs
  - hostPath:
      path: /etc/kubernetes/controller-manager.conf
      type: FileOrCreate
    name: kubeconfig
```

---

## 5. kube-scheduler

```yaml
kube_scheduler:
  ä½œç”¨:
    - ä¸ºæ–°åˆ›å»ºçš„Podé€‰æ‹©èŠ‚ç‚¹
    - è€ƒè™‘èµ„æºéœ€æ±‚ã€çº¦æŸã€äº²å’Œæ€§
    - å®ç°å…¬å¹³è°ƒåº¦
  
  è°ƒåº¦æµç¨‹:
    1. é¢„é€‰ (Predicate):
      - è¿‡æ»¤ä¸ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹
      - æ£€æŸ¥èµ„æºæ˜¯å¦å……è¶³
      - æ£€æŸ¥èŠ‚ç‚¹é€‰æ‹©å™¨
      - æ£€æŸ¥æ±¡ç‚¹/å®¹å¿
    
    2. ä¼˜é€‰ (Priority):
      - å¯¹é¢„é€‰èŠ‚ç‚¹æ‰“åˆ†
      - èµ„æºå¹³è¡¡
      - é•œåƒæœ¬åœ°æ€§
      - äº²å’Œæ€§/åäº²å’Œæ€§
    
    3. ç»‘å®š (Bind):
      - é€‰æ‹©å¾—åˆ†æœ€é«˜çš„èŠ‚ç‚¹
      - æ›´æ–°etcd
  
  è°ƒåº¦ç­–ç•¥:
    èµ„æºè°ƒåº¦:
      - CPUè¯·æ±‚/é™åˆ¶
      - å†…å­˜è¯·æ±‚/é™åˆ¶
      - ä¸´æ—¶å­˜å‚¨
      - æ‰©å±•èµ„æº (GPU)
    
    äº²å’Œæ€§è°ƒåº¦:
      NodeAffinity: èŠ‚ç‚¹äº²å’Œæ€§
      PodAffinity: Podäº²å’Œæ€§
      PodAntiAffinity: Podåäº²å’Œæ€§
    
    æ±¡ç‚¹å’Œå®¹å¿:
      Taint: èŠ‚ç‚¹æ‹’ç»Pod
      Toleration: Podå®¹å¿æ±¡ç‚¹
    
    æ‹“æ‰‘åŸŸ:
      - æ•…éšœåŸŸ (zone)
      - ä¸»æœºåŸŸ (hostname)
      - è‡ªå®šä¹‰åŸŸ
  
  é…ç½®å‚æ•°:
    åŸºç¡€é…ç½®:
      --kubeconfig: kubeconfigæ–‡ä»¶
      --leader-elect: Leaderé€‰ä¸¾
      --bind-address: ç›‘å¬åœ°å€
    
    è°ƒåº¦é…ç½®:
      --config: è°ƒåº¦å™¨é…ç½®æ–‡ä»¶
      --feature-gates: åŠŸèƒ½å¼€å…³
```

**Scheduleré…ç½®ç¤ºä¾‹**:

```yaml
# scheduler-config.yaml
apiVersion: kubescheduler.config.k8s.io/v1
kind: KubeSchedulerConfiguration
clientConnection:
  kubeconfig: /etc/kubernetes/scheduler.conf
leaderElection:
  leaderElect: true
profiles:
- schedulerName: default-scheduler
  plugins:
    # é¢„é€‰æ’ä»¶
    filter:
      enabled:
      - name: NodeResourcesFit
      - name: NodeAffinity
      - name: PodTopologySpread
      - name: TaintToleration
    # ä¼˜é€‰æ’ä»¶
    score:
      enabled:
      - name: NodeResourcesBalancedAllocation
        weight: 1
      - name: ImageLocality
        weight: 1
      - name: InterPodAffinity
        weight: 1
```

---

## 6. kubelet

```yaml
kubelet:
  ä½œç”¨:
    - èŠ‚ç‚¹ä»£ç†
    - ç®¡ç†Podå’Œå®¹å™¨
    - ä¸ŠæŠ¥èŠ‚ç‚¹å’ŒPodçŠ¶æ€
    - å®¹å™¨å¥åº·æ£€æŸ¥
  
  æ ¸å¿ƒåŠŸèƒ½:
    Podç®¡ç†:
      - æ¥æ”¶PodSpec
      - åˆ›å»º/åˆ é™¤å®¹å™¨
      - æŒ‚è½½å·
      - ç½‘ç»œé…ç½®
    
    å®¹å™¨ç”Ÿå‘½å‘¨æœŸ:
      - å¯åŠ¨å®¹å™¨
      - åœæ­¢å®¹å™¨
      - é‡å¯å¤±è´¥å®¹å™¨
      - æ‰§è¡Œç”Ÿå‘½å‘¨æœŸé’©å­
    
    å¥åº·æ£€æŸ¥:
      Liveness Probe: å­˜æ´»æ¢é’ˆ
      Readiness Probe: å°±ç»ªæ¢é’ˆ
      Startup Probe: å¯åŠ¨æ¢é’ˆ
    
    èµ„æºç®¡ç†:
      - èµ„æºé¢„ç•™
      - Pod QoS
      - èµ„æºé™åˆ¶
      - é©±é€ç­–ç•¥
    
    å·ç®¡ç†:
      - æŒ‚è½½å·
      - å·æ¸…ç†
      - Secret/ConfigMap
  
  é…ç½®å‚æ•°:
    åŸºç¡€é…ç½®:
      --config: kubeleté…ç½®æ–‡ä»¶
      --kubeconfig: kubeconfigæ–‡ä»¶
      --container-runtime-endpoint: CRIç«¯ç‚¹
    
    èŠ‚ç‚¹é…ç½®:
      --hostname-override: è¦†ç›–ä¸»æœºå
      --node-ip: èŠ‚ç‚¹IP
      --node-labels: èŠ‚ç‚¹æ ‡ç­¾
    
    èµ„æºé…ç½®:
      --kube-reserved: Kubernetesç»„ä»¶é¢„ç•™èµ„æº
      --system-reserved: ç³»ç»Ÿè¿›ç¨‹é¢„ç•™èµ„æº
      --eviction-hard: ç¡¬é©±é€é˜ˆå€¼
      --eviction-soft: è½¯é©±é€é˜ˆå€¼
    
    ç½‘ç»œé…ç½®:
      --network-plugin: ç½‘ç»œæ’ä»¶
      --cni-conf-dir: CNIé…ç½®ç›®å½•
      --cni-bin-dir: CNIäºŒè¿›åˆ¶ç›®å½•
```

**Kubeleté…ç½®**:

```yaml
# /var/lib/kubelet/config.yaml
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: 0.0.0.0
port: 10250
readOnlyPort: 0
authentication:
  anonymous:
    enabled: false
  webhook:
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt
authorization:
  mode: Webhook
cgroupDriver: systemd
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local
containerLogMaxSize: 10Mi
containerLogMaxFiles: 5
# èµ„æºé¢„ç•™
kubeReserved:
  cpu: "500m"
  memory: "1Gi"
  ephemeral-storage: "1Gi"
systemReserved:
  cpu: "500m"
  memory: "1Gi"
  ephemeral-storage: "1Gi"
# é©±é€ç­–ç•¥
evictionHard:
  memory.available: "100Mi"
  nodefs.available: "10%"
  nodefs.inodesFree: "5%"
  imagefs.available: "15%"
evictionSoft:
  memory.available: "200Mi"
  nodefs.available: "15%"
evictionSoftGracePeriod:
  memory.available: "1m30s"
  nodefs.available: "2m"
# èµ„æºç®¡ç†
maxPods: 110
podPidsLimit: -1
# å®¹å™¨è¿è¡Œæ—¶
containerRuntimeEndpoint: unix:///var/run/containerd/containerd.sock
```

---

## 7. kube-proxy

```yaml
kube_proxy:
  ä½œç”¨:
    - å®ç°ServiceæŠ½è±¡
    - è´Ÿè½½å‡è¡¡
    - ç½‘ç»œä»£ç†
  
  ä»£ç†æ¨¡å¼:
    userspace (å·²åºŸå¼ƒ):
      - ç”¨æˆ·ç©ºé—´ä»£ç†
      - æ€§èƒ½å·®
      - ä¸æ¨è
    
    iptables:
      - åŸºäºiptablesè§„åˆ™
      - éšæœºè´Ÿè½½å‡è¡¡
      - æ€§èƒ½ä¸­ç­‰
      - é»˜è®¤æ¨¡å¼
    
    ipvs (æ¨è):
      - åŸºäºå†…æ ¸IPVS
      - æ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•
      - æ€§èƒ½æœ€å¥½
      - æ¨èç”Ÿäº§ç¯å¢ƒ
  
  è´Ÿè½½å‡è¡¡ç®—æ³• (IPVSæ¨¡å¼):
    rr: Round Robin (è½®è¯¢)
    lc: Least Connection (æœ€å°‘è¿æ¥)
    dh: Destination Hashing
    sh: Source Hashing
    sed: Shortest Expected Delay
    nq: Never Queue
  
  é…ç½®å‚æ•°:
    --proxy-mode: ä»£ç†æ¨¡å¼ (iptables/ipvs)
    --cluster-cidr: é›†ç¾¤Pod CIDR
    --kubeconfig: kubeconfigæ–‡ä»¶
    --ipvs-scheduler: IPVSè°ƒåº¦ç®—æ³•
```

**Kube-proxyé…ç½® (IPVSæ¨¡å¼)**:

```yaml
# /var/lib/kube-proxy/config.yaml
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
bindAddress: 0.0.0.0
clientConnection:
  kubeconfig: /var/lib/kube-proxy/kubeconfig.conf
clusterCIDR: 10.244.0.0/16
mode: ipvs
ipvs:
  scheduler: rr
  syncPeriod: 30s
  minSyncPeriod: 5s
iptables:
  masqueradeAll: false
  masqueradeBit: 14
  minSyncPeriod: 0s
  syncPeriod: 30s
```

```bash
# å¯ç”¨IPVSæ¨¡å—
modprobe ip_vs
modprobe ip_vs_rr
modprobe ip_vs_wrr
modprobe ip_vs_sh
modprobe nf_conntrack

# éªŒè¯IPVSè§„åˆ™
ipvsadm -Ln
```

---

## 8. ç»„ä»¶é€šä¿¡ä¸è®¤è¯

```yaml
Component_Communication:
  é€šä¿¡æ–¹å¼:
    kubectl -> API Server:
      - TLSåŠ å¯†
      - å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯
      - æˆ–Bearer Token
    
    kubelet -> API Server:
      - TLSåŠ å¯†
      - å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯
      - åŒå‘è®¤è¯
    
    API Server -> kubelet:
      - TLSåŠ å¯†
      - API Serverä½œä¸ºå®¢æˆ·ç«¯
      - kubeletéªŒè¯è¯·æ±‚
    
    API Server -> etcd:
      - TLSåŠ å¯†
      - åŒå‘è¯ä¹¦è®¤è¯
      - å®¢æˆ·ç«¯è¯ä¹¦
  
  è¯ä¹¦ç®¡ç†:
    è¯ä¹¦ç±»å‹:
      - CAè¯ä¹¦: é›†ç¾¤æ ¹è¯ä¹¦
      - API Serverè¯ä¹¦
      - Kubeletè¯ä¹¦
      - etcdè¯ä¹¦
      - Front Proxyè¯ä¹¦
      - Service Accountå¯†é’¥å¯¹
    
    è¯ä¹¦è·¯å¾„:
      /etc/kubernetes/pki/:
        - ca.crt / ca.key
        - apiserver.crt / apiserver.key
        - apiserver-kubelet-client.crt/key
        - front-proxy-ca.crt / front-proxy-ca.key
        - front-proxy-client.crt/key
        - sa.pub / sa.key
      
      /etc/kubernetes/pki/etcd/:
        - ca.crt / ca.key
        - server.crt / server.key
        - peer.crt / peer.key
        - healthcheck-client.crt/key
        - apiserver-etcd-client.crt/key
    
    è¯ä¹¦ç»­æœŸ:
      # æŸ¥çœ‹è¯ä¹¦è¿‡æœŸæ—¶é—´
      kubeadm certs check-expiration
      
      # ç»­æœŸæ‰€æœ‰è¯ä¹¦
      kubeadm certs renew all
      
      # ç»­æœŸç‰¹å®šè¯ä¹¦
      kubeadm certs renew apiserver
```

---

## 9. ç»„ä»¶ç›‘æ§ä¸æ—¥å¿—

```bash
# ========================================
# ç»„ä»¶ç›‘æ§
# ========================================

# æŸ¥çœ‹ç»„ä»¶çŠ¶æ€
kubectl get componentstatuses

# æŸ¥çœ‹API Serveræ—¥å¿—
journalctl -u kube-apiserver -f

# æŸ¥çœ‹Controller Manageræ—¥å¿—
kubectl logs -n kube-system kube-controller-manager-master01

# æŸ¥çœ‹Scheduleræ—¥å¿—
kubectl logs -n kube-system kube-scheduler-master01

# æŸ¥çœ‹kubeletæ—¥å¿—
journalctl -u kubelet -f

# æŸ¥çœ‹kube-proxyæ—¥å¿—
kubectl logs -n kube-system kube-proxy-xxxxx

# ========================================
# Prometheusç›‘æ§
# ========================================

# API ServeræŒ‡æ ‡
curl -k https://localhost:6443/metrics

# Controller ManageræŒ‡æ ‡
curl -k https://localhost:10257/metrics

# ScheduleræŒ‡æ ‡
curl -k https://localhost:10259/metrics

# KubeletæŒ‡æ ‡
curl -k https://localhost:10250/metrics

# Kube-proxyæŒ‡æ ‡
curl http://localhost:10256/metrics
```

---

## 10. æ€§èƒ½è°ƒä¼˜

```yaml
Performance_Tuning:
  API Server:
    å¹¶å‘ä¼˜åŒ–:
      --max-requests-inflight=800
      --max-mutating-requests-inflight=400
    
    Watchç¼“å­˜:
      --watch-cache-sizes: è°ƒæ•´Watchç¼“å­˜å¤§å°
    
    etcdä¼˜åŒ–:
      --etcd-compaction-interval: å‹ç¼©é—´éš”
  
  etcd:
    å­˜å‚¨ä¼˜åŒ–:
      --quota-backend-bytes=8GB  # å¢åŠ å­˜å‚¨é…é¢
      å®šæœŸå‹ç¼©å’Œç¢ç‰‡æ•´ç†
    
    ç½‘ç»œä¼˜åŒ–:
      --heartbeat-interval=100ms
      --election-timeout=1000ms
      ä½¿ç”¨SSDå­˜å‚¨
      ä¸“ç”¨ç½‘ç»œ
  
  Kubelet:
    å¹¶å‘ä¼˜åŒ–:
      --max-pods=110  # æ¯èŠ‚ç‚¹æœ€å¤§Podæ•°
      --pod-max-pids=-1  # Podè¿›ç¨‹æ•°é™åˆ¶
    
    é•œåƒæ‹‰å–:
      --serialize-image-pulls=false  # å¹¶è¡Œæ‹‰å–
      --image-pull-progress-deadline=2m
    
    é©±é€ä¼˜åŒ–:
      åˆç†è®¾ç½®evictioné˜ˆå€¼
      é¢„ç•™è¶³å¤Ÿèµ„æº
  
  Kube-proxy:
    IPVSæ¨¡å¼:
      mode: ipvs
      å¯ç”¨conntrackè°ƒä¼˜
    
    å†…æ ¸å‚æ•°:
      net.ipv4.ip_forward=1
      net.bridge.bridge-nf-call-iptables=1
      net.ipv4.conf.all.forwarding=1
      net.netfilter.nf_conntrack_max=1000000
```

---

## ç›¸å…³æ–‡æ¡£

- [Kubernetesé›†ç¾¤éƒ¨ç½²](01_é›†ç¾¤éƒ¨ç½².md)
- [Kubernetesåº”ç”¨éƒ¨ç½²](03_åº”ç”¨éƒ¨ç½².md)
- [Kubernetesèµ„æºç®¡ç†](04_èµ„æºç®¡ç†.md)
- [Kubernetesæ•…éšœæ’æŸ¥](05_æ•…éšœæ’æŸ¥.md)
- [Kubernetesé«˜å¯ç”¨æ¶æ„](../../01_è™šæ‹ŸåŒ–éƒ¨ç½²/05_é«˜å¯ç”¨å®¹ç¾/02_Kubernetesé«˜å¯ç”¨æ¶æ„.md)

---

**æ›´æ–°æ—¶é—´**: 2025-10-19  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
