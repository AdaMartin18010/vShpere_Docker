# Kubernetesåº”ç”¨éƒ¨ç½²

> **è¿”å›**: [Kuberneteséƒ¨ç½²ç›®å½•](README.md) | [å®¹å™¨åŒ–éƒ¨ç½²é¦–é¡µ](../README.md) | [éƒ¨ç½²æŒ‡å—é¦–é¡µ](../../00_ç´¢å¼•å¯¼èˆª/README.md)

---

## ğŸ“‹ ç›®å½•

- [Kubernetesåº”ç”¨éƒ¨ç½²](#kubernetesåº”ç”¨éƒ¨ç½²)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. Podè¯¦è§£](#1-podè¯¦è§£)
  - [2. Deployment](#2-deployment)
  - [3. StatefulSet](#3-statefulset)
  - [4. DaemonSet](#4-daemonset)
  - [5. Jobä¸CronJob](#5-jobä¸cronjob)
  - [6. Service](#6-service)
  - [7. Ingress](#7-ingress)
  - [8. ConfigMapä¸Secret](#8-configmapä¸secret)
  - [9. æŒä¹…åŒ–å­˜å‚¨](#9-æŒä¹…åŒ–å­˜å‚¨)
  - [10. åº”ç”¨éƒ¨ç½²æœ€ä½³å®è·µ](#10-åº”ç”¨éƒ¨ç½²æœ€ä½³å®è·µ)
  - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## 1. Podè¯¦è§£

```yaml
Pod_Overview:
  å®šä¹‰:
    - Kubernetesæœ€å°éƒ¨ç½²å•å…ƒ
    - ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„é›†åˆ
    - å…±äº«ç½‘ç»œå’Œå­˜å‚¨
    - åŒç”Ÿå…±æ­»
  
  Podç”Ÿå‘½å‘¨æœŸ:
    Pending: ç­‰å¾…è°ƒåº¦æˆ–æ‹‰å–é•œåƒ
    Running: è‡³å°‘ä¸€ä¸ªå®¹å™¨è¿è¡Œä¸­
    Succeeded: æ‰€æœ‰å®¹å™¨æˆåŠŸç»ˆæ­¢
    Failed: è‡³å°‘ä¸€ä¸ªå®¹å™¨å¤±è´¥
    Unknown: çŠ¶æ€æœªçŸ¥
  
  å®¹å™¨ç±»å‹:
    Initå®¹å™¨:
      - åˆå§‹åŒ–ä»»åŠ¡
      - ä¸²è¡Œæ‰§è¡Œ
      - å¿…é¡»æˆåŠŸå®Œæˆ
    
    ä¸»å®¹å™¨:
      - åº”ç”¨å®¹å™¨
      - å¹¶è¡Œè¿è¡Œ
      - Podçš„ä¸»è¦åŠŸèƒ½
    
    Sidecarå®¹å™¨:
      - è¾…åŠ©å®¹å™¨
      - æ—¥å¿—æ”¶é›†
      - ä»£ç†
      - ç›‘æ§
  
  å®¹å™¨æ¢é’ˆ:
    Liveness Probe (å­˜æ´»æ¢é’ˆ):
      - æ£€æµ‹å®¹å™¨æ˜¯å¦å­˜æ´»
      - å¤±è´¥åˆ™é‡å¯å®¹å™¨
    
    Readiness Probe (å°±ç»ªæ¢é’ˆ):
      - æ£€æµ‹å®¹å™¨æ˜¯å¦å°±ç»ª
      - å¤±è´¥åˆ™ä»Serviceç§»é™¤
    
    Startup Probe (å¯åŠ¨æ¢é’ˆ):
      - æ£€æµ‹å®¹å™¨æ˜¯å¦å¯åŠ¨
      - ä¿æŠ¤æ…¢å¯åŠ¨å®¹å™¨
  
  æ¢é’ˆç±»å‹:
    HTTP GET:
      - HTTPè¯·æ±‚æ£€æŸ¥
      - è¿”å›200-399ä¸ºæˆåŠŸ
    
    TCP Socket:
      - TCPè¿æ¥æ£€æŸ¥
      - è¿æ¥æˆåŠŸä¸ºæˆåŠŸ
    
    Exec:
      - æ‰§è¡Œå‘½ä»¤
      - é€€å‡ºç 0ä¸ºæˆåŠŸ
```

**Podå®Œæ•´ç¤ºä¾‹**:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: myapp
  namespace: default
  labels:
    app: myapp
    version: v1
  annotations:
    description: "My application pod"
spec:
  # Initå®¹å™¨
  initContainers:
  - name: init-mydb
    image: busybox:1.28
    command: ['sh', '-c', 'until nslookup mydb; do echo waiting for mydb; sleep 2; done;']
  
  # ä¸»å®¹å™¨
  containers:
  - name: myapp
    image: myapp:v1.0
    imagePullPolicy: IfNotPresent
    
    # ç«¯å£
    ports:
    - containerPort: 8080
      name: http
      protocol: TCP
    
    # ç¯å¢ƒå˜é‡
    env:
    - name: DB_HOST
      value: "mysql"
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: db-secret
          key: password
    
    # èµ„æºé™åˆ¶
    resources:
      requests:
        cpu: "500m"
        memory: "512Mi"
      limits:
        cpu: "1000m"
        memory: "1Gi"
    
    # å­˜æ´»æ¢é’ˆ
    livenessProbe:
      httpGet:
        path: /health
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 3
    
    # å°±ç»ªæ¢é’ˆ
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
      successThreshold: 1
      failureThreshold: 3
    
    # å¯åŠ¨æ¢é’ˆ
    startupProbe:
      httpGet:
        path: /startup
        port: 8080
      initialDelaySeconds: 0
      periodSeconds: 10
      timeoutSeconds: 3
      failureThreshold: 30
    
    # ç”Ÿå‘½å‘¨æœŸé’©å­
    lifecycle:
      postStart:
        exec:
          command: ["/bin/sh", "-c", "echo Hello from postStart > /usr/share/message"]
      preStop:
        exec:
          command: ["/bin/sh", "-c", "nginx -s quit; while killall -0 nginx; do sleep 1; done"]
    
    # å·æŒ‚è½½
    volumeMounts:
    - name: config
      mountPath: /etc/config
      readOnly: true
    - name: data
      mountPath: /data
  
  # Sidecarå®¹å™¨
  - name: log-collector
    image: fluent/fluentd:v1.14
    volumeMounts:
    - name: varlog
      mountPath: /var/log
  
  # å·
  volumes:
  - name: config
    configMap:
      name: myapp-config
  - name: data
    persistentVolumeClaim:
      claimName: myapp-pvc
  - name: varlog
    emptyDir: {}
  
  # è°ƒåº¦ç›¸å…³
  nodeSelector:
    disktype: ssd
  
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
            - node01
            - node02
  
  tolerations:
  - key: "key1"
    operator: "Equal"
    value: "value1"
    effect: "NoSchedule"
  
  # å®‰å…¨ä¸Šä¸‹æ–‡
  securityContext:
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 2000
  
  # é‡å¯ç­–ç•¥
  restartPolicy: Always  # Always, OnFailure, Never
  
  # DNSç­–ç•¥
  dnsPolicy: ClusterFirst
  
  # æœåŠ¡è´¦å·
  serviceAccountName: myapp-sa
  
  # é•œåƒæ‹‰å–å¯†é’¥
  imagePullSecrets:
  - name: regcred
```

---

## 2. Deployment

```yaml
Deployment_Overview:
  å®šä¹‰:
    - æ— çŠ¶æ€åº”ç”¨éƒ¨ç½²
    - å£°æ˜å¼æ›´æ–°
    - æ»šåŠ¨æ›´æ–°
    - ç‰ˆæœ¬å›æ»š
  
  åŠŸèƒ½:
    å‰¯æœ¬ç®¡ç†:
      - ç»´æŠ¤æŒ‡å®šå‰¯æœ¬æ•°
      - è‡ªåŠ¨æ›¿æ¢å¤±è´¥Pod
    
    æ»šåŠ¨æ›´æ–°:
      - é€æ­¥æ›¿æ¢æ—§Pod
      - é›¶åœæœºæ›´æ–°
      - å¯é…ç½®æ›´æ–°ç­–ç•¥
    
    ç‰ˆæœ¬å›æ»š:
      - ä¿ç•™å†å²ç‰ˆæœ¬
      - å¿«é€Ÿå›æ»š
      - ç‰ˆæœ¬å†å²æŸ¥è¯¢
  
  æ›´æ–°ç­–ç•¥:
    RollingUpdate (æ»šåŠ¨æ›´æ–°):
      maxSurge: è¶…å‡ºæœŸæœ›å‰¯æœ¬æ•°çš„æœ€å¤§å€¼
      maxUnavailable: ä¸å¯ç”¨å‰¯æœ¬çš„æœ€å¤§å€¼
    
    Recreate (é‡å»º):
      - å…ˆåˆ é™¤æ‰€æœ‰æ—§Pod
      - å†åˆ›å»ºæ–°Pod
      - ä¼šæœ‰åœæœºæ—¶é—´
```

**Deploymentç¤ºä¾‹**:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  namespace: default
  labels:
    app: nginx
spec:
  # å‰¯æœ¬æ•°
  replicas: 3
  
  # é€‰æ‹©å™¨
  selector:
    matchLabels:
      app: nginx
  
  # æ›´æ–°ç­–ç•¥
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # æœ€å¤šè¶…å‡º1ä¸ªPod
      maxUnavailable: 1  # æœ€å¤š1ä¸ªä¸å¯ç”¨
  
  # ç‰ˆæœ¬å†å²é™åˆ¶
  revisionHistoryLimit: 10
  
  # Podæ¨¡æ¿
  template:
    metadata:
      labels:
        app: nginx
        version: v1.21
    spec:
      containers:
      - name: nginx
        image: nginx:1.21-alpine
        ports:
        - containerPort: 80
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 250m
            memory: 256Mi
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
```

**Deploymentç®¡ç†å‘½ä»¤**:

```bash
# åˆ›å»ºDeployment
kubectl create deployment nginx --image=nginx:1.21 --replicas=3

# æˆ–ä½¿ç”¨YAML
kubectl apply -f deployment.yaml

# æŸ¥çœ‹Deployment
kubectl get deployments
kubectl describe deployment nginx-deployment

# æŸ¥çœ‹ReplicaSet
kubectl get rs

# æŸ¥çœ‹Pods
kubectl get pods -l app=nginx

# æ‰©ç¼©å®¹
kubectl scale deployment nginx-deployment --replicas=5

# è‡ªåŠ¨æ‰©ç¼©å®¹
kubectl autoscale deployment nginx-deployment --min=3 --max=10 --cpu-percent=80

# æ›´æ–°é•œåƒ
kubectl set image deployment/nginx-deployment nginx=nginx:1.22

# æŸ¥çœ‹æ›´æ–°çŠ¶æ€
kubectl rollout status deployment/nginx-deployment

# æŸ¥çœ‹æ›´æ–°å†å²
kubectl rollout history deployment/nginx-deployment

# å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/nginx-deployment

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
kubectl rollout undo deployment/nginx-deployment --to-revision=2

# æš‚åœ/æ¢å¤æ›´æ–°
kubectl rollout pause deployment/nginx-deployment
kubectl rollout resume deployment/nginx-deployment

# é‡å¯Deployment
kubectl rollout restart deployment/nginx-deployment

# åˆ é™¤Deployment
kubectl delete deployment nginx-deployment
```

---

## 3. StatefulSet

```yaml
StatefulSet_Overview:
  å®šä¹‰:
    - æœ‰çŠ¶æ€åº”ç”¨éƒ¨ç½²
    - ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨
    - ç¨³å®šçš„ç½‘ç»œæ ‡è¯†
    - æœ‰åºéƒ¨ç½²å’Œæ‰©å±•
  
  ç‰¹æ€§:
    ç¨³å®šæ ‡è¯†:
      - å›ºå®šPodåç§°: <statefulset-name>-<ordinal>
      - å›ºå®šhostname
      - å›ºå®šDNSåŸŸå
    
    æœ‰åºæ“ä½œ:
      - æŒ‰é¡ºåºéƒ¨ç½² (0, 1, 2...)
      - æŒ‰é€†åºåˆ é™¤ (2, 1, 0...)
      - æ»šåŠ¨æ›´æ–°é¡ºåºå¯æ§
    
    æŒä¹…åŒ–å­˜å‚¨:
      - volumeClaimTemplates
      - æ¯ä¸ªPodç‹¬ç«‹PVC
      - PVCç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äºPod
  
  é€‚ç”¨åœºæ™¯:
    - æ•°æ®åº“ (MySQL, PostgreSQL, MongoDB)
    - æ¶ˆæ¯é˜Ÿåˆ— (Kafka, RabbitMQ)
    - åˆ†å¸ƒå¼å­˜å‚¨ (Ceph, HDFS)
    - æœ‰çŠ¶æ€ä¸­é—´ä»¶
```

**StatefulSetç¤ºä¾‹ - MySQLä¸»ä»**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: mysql
  labels:
    app: mysql
spec:
  ports:
  - port: 3306
    name: mysql
  clusterIP: None  # Headless Service
  selector:
    app: mysql
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
spec:
  serviceName: mysql
  replicas: 3
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      initContainers:
      - name: init-mysql
        image: mysql:8.0
        command:
        - bash
        - "-c"
        - |
          set -ex
          # ä»Podåºå·ç”Ÿæˆserver-id
          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
          ordinal=${BASH_REMATCH[1]}
          echo [mysqld] > /mnt/conf.d/server-id.cnf
          echo server-id=$((100 + $ordinal)) >> /mnt/conf.d/server-id.cnf
          # ä¸»èŠ‚ç‚¹é…ç½®
          if [[ $ordinal -eq 0 ]]; then
            cp /mnt/config-map/primary.cnf /mnt/conf.d/
          else
            cp /mnt/config-map/replica.cnf /mnt/conf.d/
          fi
        volumeMounts:
        - name: conf
          mountPath: /mnt/conf.d
        - name: config-map
          mountPath: /mnt/config-map
      
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: password
        ports:
        - containerPort: 3306
          name: mysql
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
        - name: conf
          mountPath: /etc/mysql/conf.d
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 1000m
            memory: 2Gi
        livenessProbe:
          exec:
            command: ["mysqladmin", "ping"]
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command: ["mysql", "-h", "127.0.0.1", "-e", "SELECT 1"]
          initialDelaySeconds: 5
          periodSeconds: 2
      
      volumes:
      - name: conf
        emptyDir: {}
      - name: config-map
        configMap:
          name: mysql-config
  
  # æŒä¹…åŒ–å·å£°æ˜æ¨¡æ¿
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "fast"
      resources:
        requests:
          storage: 10Gi
```

**StatefulSetç®¡ç†**:

```bash
# åˆ›å»ºStatefulSet
kubectl apply -f statefulset.yaml

# æŸ¥çœ‹StatefulSet
kubectl get statefulsets
kubectl get sts  # ç®€å†™

# æŸ¥çœ‹Pods (æŒ‰åºå·å‘½å)
kubectl get pods -l app=mysql
# mysql-0
# mysql-1
# mysql-2

# æŸ¥çœ‹PVC
kubectl get pvc
# data-mysql-0
# data-mysql-1
# data-mysql-2

# æ‰©å®¹ (æœ‰åº)
kubectl scale sts mysql --replicas=5

# ç¼©å®¹ (é€†åº)
kubectl scale sts mysql --replicas=2

# æ›´æ–°é•œåƒ
kubectl set image sts/mysql mysql=mysql:8.0.32

# åˆ†åŒºæ›´æ–° (åªæ›´æ–°åºå·>=partitionçš„Pod)
kubectl patch sts mysql -p '{"spec":{"updateStrategy":{"rollingUpdate":{"partition":2}}}}'

# åˆ é™¤StatefulSet (ä¿ç•™PVC)
kubectl delete sts mysql --cascade=orphan

# åˆ é™¤StatefulSet (åˆ é™¤Podsä½†ä¿ç•™PVC)
kubectl delete sts mysql --cascade=background

# å®Œå…¨åˆ é™¤
kubectl delete sts mysql
kubectl delete pvc -l app=mysql
```

---

## 4. DaemonSet

```yaml
DaemonSet_Overview:
  å®šä¹‰:
    - æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªPod
    - èŠ‚ç‚¹å¢åŠ æ—¶è‡ªåŠ¨éƒ¨ç½²
    - èŠ‚ç‚¹åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†
  
  é€‚ç”¨åœºæ™¯:
    - èŠ‚ç‚¹ç›‘æ§ (Node Exporter, Datadog Agent)
    - æ—¥å¿—æ”¶é›† (Fluentd, Filebeat)
    - å­˜å‚¨å®ˆæŠ¤è¿›ç¨‹ (Ceph, GlusterFS)
    - ç½‘ç»œæ’ä»¶ (Calico, Cilium)
  
  æ›´æ–°ç­–ç•¥:
    RollingUpdate: æ»šåŠ¨æ›´æ–°
    OnDelete: æ‰‹åŠ¨åˆ é™¤åæ›´æ–°
```

**DaemonSetç¤ºä¾‹ - Node Exporter**:

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-exporter
  namespace: monitoring
  labels:
    app: node-exporter
spec:
  selector:
    matchLabels:
      app: node-exporter
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app: node-exporter
    spec:
      hostNetwork: true
      hostPID: true
      hostIPC: true
      
      # èŠ‚ç‚¹é€‰æ‹©å™¨
      nodeSelector:
        kubernetes.io/os: linux
      
      # å®¹å¿æ‰€æœ‰æ±¡ç‚¹
      tolerations:
      - operator: Exists
      
      containers:
      - name: node-exporter
        image: prom/node-exporter:v1.6.1
        args:
        - --path.procfs=/host/proc
        - --path.sysfs=/host/sys
        - --path.rootfs=/host/root
        - --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)
        ports:
        - containerPort: 9100
          name: metrics
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 250m
            memory: 256Mi
        volumeMounts:
        - name: proc
          mountPath: /host/proc
          readOnly: true
        - name: sys
          mountPath: /host/sys
          readOnly: true
        - name: root
          mountPath: /host/root
          readOnly: true
      
      volumes:
      - name: proc
        hostPath:
          path: /proc
      - name: sys
        hostPath:
          path: /sys
      - name: root
        hostPath:
          path: /
```

---

## 5. Jobä¸CronJob

```yaml
Job_CronJob_Overview:
  Job:
    å®šä¹‰: ä¸€æ¬¡æ€§ä»»åŠ¡
    
    ç‰¹æ€§:
      - ç¡®ä¿PodæˆåŠŸå®Œæˆ
      - å¤±è´¥é‡è¯•
      - å¹¶è¡Œæ‰§è¡Œ
      - è‡ªåŠ¨æ¸…ç†
    
    å®Œæˆæ¨¡å¼:
      - éå¹¶è¡Œ: å•ä¸ªPod
      - å›ºå®šå®Œæˆæ¬¡æ•°: completions=N
      - å·¥ä½œé˜Ÿåˆ—: parallelism=N
  
  CronJob:
    å®šä¹‰: å®šæ—¶ä»»åŠ¡
    
    ç‰¹æ€§:
      - Cronè¡¨è¾¾å¼
      - è‡ªåŠ¨åˆ›å»ºJob
      - å†å²é™åˆ¶
      - å¹¶å‘ç­–ç•¥
    
    å¹¶å‘ç­–ç•¥:
      Allow: å…è®¸å¹¶å‘
      Forbid: ç¦æ­¢å¹¶å‘
      Replace: æ›¿æ¢æ—§Job
```

**Jobç¤ºä¾‹**:

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: pi
spec:
  # å®Œæˆæ¬¡æ•°
  completions: 5
  # å¹¶è¡Œæ•°
  parallelism: 2
  # é‡è¯•æ¬¡æ•°
  backoffLimit: 4
  # TTL (å®Œæˆåè‡ªåŠ¨åˆ é™¤)
  ttlSecondsAfterFinished: 100
  
  template:
    spec:
      containers:
      - name: pi
        image: perl:5.34
        command: ["perl", "-Mbignum=bpi", "-wle", "print bpi(2000)"]
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
      restartPolicy: Never  # æˆ–OnFailure
```

**CronJobç¤ºä¾‹ - æ•°æ®åº“å¤‡ä»½**:

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mysql-backup
spec:
  # Cronè¡¨è¾¾å¼: æ¯å¤©å‡Œæ™¨2ç‚¹
  schedule: "0 2 * * *"
  
  # å¹¶å‘ç­–ç•¥
  concurrencyPolicy: Forbid
  
  # ä¿ç•™å†å²
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  
  # å¯åŠ¨æˆªæ­¢æ—¶é—´
  startingDeadlineSeconds: 300
  
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: mysql-backup
            image: mysql:8.0
            env:
            - name: MYSQL_HOST
              value: "mysql"
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secret
                  key: password
            command:
            - /bin/bash
            - -c
            - |
              set -e
              BACKUP_FILE="/backup/mysql-backup-$(date +%Y%m%d-%H%M%S).sql"
              mysqldump -h $MYSQL_HOST -u root -p$MYSQL_ROOT_PASSWORD --all-databases > $BACKUP_FILE
              echo "Backup completed: $BACKUP_FILE"
            volumeMounts:
            - name: backup
              mountPath: /backup
          volumes:
          - name: backup
            persistentVolumeClaim:
              claimName: backup-pvc
          restartPolicy: OnFailure
```

---

## 6. Service

```yaml
Service_Overview:
  å®šä¹‰:
    - æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡
    - ç¨³å®šçš„ç½‘ç»œç«¯ç‚¹
    - è‡ªåŠ¨æ›´æ–°Endpoints
  
  ç±»å‹:
    ClusterIP (é»˜è®¤):
      - é›†ç¾¤å†…éƒ¨è®¿é—®
      - åˆ†é…ClusterIP
      - é€‚åˆå†…éƒ¨æœåŠ¡
    
    NodePort:
      - èŠ‚ç‚¹ç«¯å£è®¿é—®
      - 30000-32767
      - å¤–éƒ¨å¯è®¿é—®
    
    LoadBalancer:
      - äº‘å‚å•†è´Ÿè½½å‡è¡¡å™¨
      - è‡ªåŠ¨åˆ†é…å¤–éƒ¨IP
      - é€‚åˆäº‘ç¯å¢ƒ
    
    ExternalName:
      - DNS CNAMEè®°å½•
      - å¤–éƒ¨æœåŠ¡æ˜ å°„
    
    Headless (ClusterIP: None):
      - æ— ClusterIP
      - ç›´æ¥è¿”å›Pod IP
      - é€‚åˆStatefulSet
```

**Serviceç¤ºä¾‹**:

```yaml
# ClusterIP Service
apiVersion: v1
kind: Service
metadata:
  name: myapp-service
spec:
  type: ClusterIP
  selector:
    app: myapp
  ports:
  - name: http
    protocol: TCP
    port: 80        # Serviceç«¯å£
    targetPort: 8080  # Podç«¯å£
  sessionAffinity: ClientIP  # ä¼šè¯äº²å’Œæ€§
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800

---
# NodePort Service
apiVersion: v1
kind: Service
metadata:
  name: myapp-nodeport
spec:
  type: NodePort
  selector:
    app: myapp
  ports:
  - port: 80
    targetPort: 8080
    nodePort: 30080  # å¯é€‰ï¼Œä¸æŒ‡å®šåˆ™è‡ªåŠ¨åˆ†é…

---
# LoadBalancer Service
apiVersion: v1
kind: Service
metadata:
  name: myapp-lb
spec:
  type: LoadBalancer
  selector:
    app: myapp
  ports:
  - port: 80
    targetPort: 8080
  loadBalancerSourceRanges:
  - 10.0.0.0/8  # IPç™½åå•

---
# Headless Service
apiVersion: v1
kind: Service
metadata:
  name: mysql
spec:
  clusterIP: None
  selector:
    app: mysql
  ports:
  - port: 3306
```

**Serviceç®¡ç†å‘½ä»¤**:

```bash
# åˆ›å»ºService
kubectl expose deployment nginx --port=80 --type=NodePort

# æŸ¥çœ‹Service
kubectl get svc
kubectl describe svc myapp-service

# æŸ¥çœ‹Endpoints
kubectl get endpoints myapp-service

# æµ‹è¯•Service
kubectl run test-pod --image=busybox:1.28 -it --rm -- sh
# wget -qO- http://myapp-service

# åˆ é™¤Service
kubectl delete svc myapp-service
```

---

## 7. Ingress

```yaml
Ingress_Overview:
  å®šä¹‰:
    - HTTP/HTTPSè·¯ç”±è§„åˆ™
    - ä¸ƒå±‚è´Ÿè½½å‡è¡¡
    - åŸŸåè·¯ç”±
    - TLSç»ˆæ­¢
  
  Ingress Controller:
    - Nginx Ingress Controller (æ¨è)
    - Traefik
    - HAProxy
    - Kong
    - Istio Gateway
  
  åŠŸèƒ½:
    - åŸºäºåŸŸåè·¯ç”±
    - åŸºäºè·¯å¾„è·¯ç”±
    - TLS/SSL
    - é‡å®šå‘
    - é‡å†™
    - é™æµ
    - è®¤è¯
```

**Ingressç¤ºä¾‹**:

```yaml
# å®‰è£…Nginx Ingress Controller
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml

---
# ç®€å•Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: simple-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
  - host: myapp.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: myapp-service
            port:
              number: 80

---
# å¤šåŸŸåIngress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: multi-host-ingress
spec:
  ingressClassName: nginx
  rules:
  - host: app1.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app1-service
            port:
              number: 80
  - host: app2.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app2-service
            port:
              number: 80

---
# è·¯å¾„è·¯ç”±Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: path-based-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  ingressClassName: nginx
  rules:
  - host: myapp.example.com
    http:
      paths:
      - path: /api(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 8080
      - path: /web(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: web-service
            port:
              number: 80

---
# TLS Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tls-ingress
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - myapp.example.com
    secretName: myapp-tls-secret
  rules:
  - host: myapp.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: myapp-service
            port:
              number: 80
```

**åˆ›å»ºTLSè¯ä¹¦**:

```bash
# ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout tls.key -out tls.crt \
  -subj "/CN=myapp.example.com/O=myapp"

# åˆ›å»ºSecret
kubectl create secret tls myapp-tls-secret \
  --key tls.key \
  --cert tls.crt
```

---

## 8. ConfigMapä¸Secret

```yaml
ConfigMap_Secret_Overview:
  ConfigMap:
    ç”¨é€”: éæ•æ„Ÿé…ç½®
    
    ä½¿ç”¨æ–¹å¼:
      - ç¯å¢ƒå˜é‡
      - å‘½ä»¤è¡Œå‚æ•°
      - é…ç½®æ–‡ä»¶å·
  
  Secret:
    ç”¨é€”: æ•æ„Ÿä¿¡æ¯ (å¯†ç ã€Tokenã€è¯ä¹¦)
    
    ç±»å‹:
      Opaque: é€šç”¨Secret (base64ç¼–ç )
      kubernetes.io/dockerconfigjson: é•œåƒæ‹‰å–å‡­è¯
      kubernetes.io/tls: TLSè¯ä¹¦
      kubernetes.io/service-account-token: SA Token
    
    ä½¿ç”¨æ–¹å¼:
      - ç¯å¢ƒå˜é‡
      - é…ç½®æ–‡ä»¶å·
      - imagePullSecrets
```

**ConfigMapç¤ºä¾‹**:

```yaml
# åˆ›å»ºConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  # é”®å€¼å¯¹
  database_url: "mysql://db:3306/myapp"
  log_level: "info"
  
  # é…ç½®æ–‡ä»¶
  app.conf: |
    server {
      listen 80;
      server_name localhost;
      location / {
        root /usr/share/nginx/html;
        index index.html;
      }
    }
  
  config.json: |
    {
      "apiVersion": "v1",
      "kind": "Config",
      "server": "https://api.example.com"
    }
```

```bash
# ä»æ–‡ä»¶åˆ›å»º
kubectl create configmap app-config --from-file=app.conf

# ä»ç›®å½•åˆ›å»º
kubectl create configmap app-config --from-file=config/

# ä»å­—é¢å€¼åˆ›å»º
kubectl create configmap app-config \
  --from-literal=database_url=mysql://db:3306 \
  --from-literal=log_level=info
```

**Secretç¤ºä¾‹**:

```yaml
# Opaque Secret
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
type: Opaque
data:
  username: YWRtaW4=  # admin (base64)
  password: cGFzc3dvcmQxMjM=  # password123 (base64)

---
# Docker Registry Secret
apiVersion: v1
kind: Secret
metadata:
  name: regcred
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: eyJhdXRocyI6eyJodHRwczovL2luZGV4LmRvY2tlci5pby92MS8iOnsidXNlcm5hbWUiOiJ1c2VyIiwicGFzc3dvcmQiOiJwYXNzd29yZCJ9fX0=

---
# TLS Secret
apiVersion: v1
kind: Secret
metadata:
  name: tls-secret
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTi...
  tls.key: LS0tLS1CRUdJTi...
```

```bash
# åˆ›å»ºOpaque Secret
kubectl create secret generic db-secret \
  --from-literal=username=admin \
  --from-literal=password=password123

# åˆ›å»ºDocker Registry Secret
kubectl create secret docker-registry regcred \
  --docker-server=https://index.docker.io/v1/ \
  --docker-username=user \
  --docker-password=password \
  --docker-email=user@example.com

# åˆ›å»ºTLS Secret
kubectl create secret tls tls-secret \
  --cert=tls.crt \
  --key=tls.key
```

**ä½¿ç”¨ConfigMapå’ŒSecret**:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: myapp
spec:
  containers:
  - name: myapp
    image: myapp:v1.0
    
    # ä½¿ç”¨ConfigMapä½œä¸ºç¯å¢ƒå˜é‡
    env:
    - name: DATABASE_URL
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: database_url
    
    # ä½¿ç”¨Secretä½œä¸ºç¯å¢ƒå˜é‡
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: db-secret
          key: password
    
    # æŒ‚è½½ConfigMapä¸ºå·
    volumeMounts:
    - name: config-volume
      mountPath: /etc/config
    
    # æŒ‚è½½Secretä¸ºå·
    - name: secret-volume
      mountPath: /etc/secret
      readOnly: true
  
  volumes:
  - name: config-volume
    configMap:
      name: app-config
      items:
      - key: app.conf
        path: app.conf
  
  - name: secret-volume
    secret:
      secretName: db-secret
  
  # ä½¿ç”¨é•œåƒæ‹‰å–Secret
  imagePullSecrets:
  - name: regcred
```

---

## 9. æŒä¹…åŒ–å­˜å‚¨

```yaml
Persistent_Storage_Overview:
  PersistentVolume (PV):
    - é›†ç¾¤çº§åˆ«èµ„æº
    - ç®¡ç†å‘˜åˆ›å»º
    - ç‹¬ç«‹äºPodç”Ÿå‘½å‘¨æœŸ
  
  PersistentVolumeClaim (PVC):
    - å‘½åç©ºé—´çº§åˆ«èµ„æº
    - ç”¨æˆ·ç”³è¯·å­˜å‚¨
    - ç»‘å®šåˆ°PV
  
  StorageClass:
    - åŠ¨æ€ä¾›åº”
    - å­˜å‚¨ç±»åˆ«
    - ä¸åŒæ€§èƒ½ç­‰çº§
  
  è®¿é—®æ¨¡å¼:
    ReadWriteOnce (RWO): å•èŠ‚ç‚¹è¯»å†™
    ReadOnlyMany (ROX): å¤šèŠ‚ç‚¹åªè¯»
    ReadWriteMany (RWX): å¤šèŠ‚ç‚¹è¯»å†™
  
  å›æ”¶ç­–ç•¥:
    Retain: ä¿ç•™
    Delete: åˆ é™¤
    Recycle: å›æ”¶ (å·²åºŸå¼ƒ)
```

**PVå’ŒPVCç¤ºä¾‹**:

```yaml
# PersistentVolume
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nfs
spec:
  capacity:
    storage: 10Gi
  accessModes:
  - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: nfs
  nfs:
    server: 192.168.1.100
    path: /data/nfs

---
# PersistentVolumeClaim
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-app
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: fast

---
# ä½¿ç”¨PVCçš„Pod
apiVersion: v1
kind: Pod
metadata:
  name: app-with-pvc
spec:
  containers:
  - name: app
    image: myapp:v1.0
    volumeMounts:
    - name: data
      mountPath: /data
  volumes:
  - name: data
    persistentVolumeClaim:
      claimName: pvc-app
```

**StorageClassç¤ºä¾‹**:

```yaml
# NFS StorageClass
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs
provisioner: nfs-client
parameters:
  archiveOnDelete: "false"

---
# Local Path StorageClass
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-path
provisioner: rancher.io/local-path
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Delete

---
# Rook-Ceph StorageClass
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: rook-ceph-block
provisioner: rook-ceph.rbd.csi.ceph.com
parameters:
  clusterID: rook-ceph
  pool: replicapool
  imageFormat: "2"
  imageFeatures: layering
  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
reclaimPolicy: Delete
allowVolumeExpansion: true
```

---

## 10. åº”ç”¨éƒ¨ç½²æœ€ä½³å®è·µ

```yaml
Deployment_Best_Practices:
  èµ„æºç®¡ç†:
    âœ… è®¾ç½®requestså’Œlimits:
      resources:
        requests:
          cpu: "500m"
          memory: "512Mi"
        limits:
          cpu: "1000m"
          memory: "1Gi"
    
    âœ… ä½¿ç”¨HPAè‡ªåŠ¨æ‰©ç¼©å®¹:
      kubectl autoscale deployment myapp --min=3 --max=10 --cpu-percent=80
  
  å¥åº·æ£€æŸ¥:
    âœ… é…ç½®Liveness Probe:
      livenessProbe:
        httpGet:
          path: /health
          port: 8080
        initialDelaySeconds: 30
    
    âœ… é…ç½®Readiness Probe:
      readinessProbe:
        httpGet:
          path: /ready
          port: 8080
        initialDelaySeconds: 5
  
  æ›´æ–°ç­–ç•¥:
    âœ… ä½¿ç”¨æ»šåŠ¨æ›´æ–°:
      strategy:
        type: RollingUpdate
        rollingUpdate:
          maxSurge: 1
          maxUnavailable: 0
    
    âœ… ä¿ç•™æ›´æ–°å†å²:
      revisionHistoryLimit: 10
  
  é…ç½®ç®¡ç†:
    âœ… ä½¿ç”¨ConfigMap:
      - å¤–éƒ¨åŒ–é…ç½®
      - ç¯å¢ƒç‰¹å®šé…ç½®
    
    âœ… ä½¿ç”¨Secret:
      - æ•æ„Ÿä¿¡æ¯åŠ å¯†
      - ä¸è¦æäº¤åˆ°Git
  
  æ ‡ç­¾å’Œæ³¨è§£:
    âœ… ä½¿ç”¨æ ‡å‡†æ ‡ç­¾:
      labels:
        app.kubernetes.io/name: myapp
        app.kubernetes.io/version: v1.0
        app.kubernetes.io/component: backend
        app.kubernetes.io/part-of: myproject
    
    âœ… ä½¿ç”¨æœ‰æ„ä¹‰çš„æ³¨è§£:
      annotations:
        description: "My application"
        owner: "team@example.com"
  
  å®‰å…¨:
    âœ… ä½¿ç”¨érootç”¨æˆ·:
      securityContext:
        runAsUser: 1000
        runAsNonRoot: true
    
    âœ… åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ:
      securityContext:
        readOnlyRootFilesystem: true
    
    âœ… é™åˆ¶èƒ½åŠ›:
      securityContext:
        capabilities:
          drop:
          - ALL
          add:
          - NET_BIND_SERVICE
  
  ç½‘ç»œ:
    âœ… ä½¿ç”¨NetworkPolicy:
      - é™åˆ¶Podé—´é€šä¿¡
      - æœ€å°æƒé™åŸåˆ™
    
    âœ… ä½¿ç”¨Ingress:
      - ç»Ÿä¸€å…¥å£
      - TLSç»ˆæ­¢
  
  ç›‘æ§å’Œæ—¥å¿—:
    âœ… æš´éœ²metricsç«¯ç‚¹:
      - Prometheusæ ¼å¼
      - /metricsè·¯å¾„
    
    âœ… ç»“æ„åŒ–æ—¥å¿—:
      - JSONæ ¼å¼
      - æ ‡å‡†è¾“å‡º/é”™è¯¯
```

---

## ç›¸å…³æ–‡æ¡£

- [Kubernetesé›†ç¾¤éƒ¨ç½²](01_é›†ç¾¤éƒ¨ç½².md)
- [Kubernetesæ ¸å¿ƒç»„ä»¶](02_æ ¸å¿ƒç»„ä»¶.md)
- [Kubernetesèµ„æºç®¡ç†](04_èµ„æºç®¡ç†.md)
- [Kubernetesæ•…éšœæ’æŸ¥](05_æ•…éšœæ’æŸ¥.md)
- [å®¹å™¨ç½‘ç»œé…ç½®](../03_å®¹å™¨ç½‘ç»œ/README.md)
- [å®¹å™¨å­˜å‚¨é…ç½®](../04_å®¹å™¨å­˜å‚¨/README.md)

---

**æ›´æ–°æ—¶é—´**: 2025-10-19  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
