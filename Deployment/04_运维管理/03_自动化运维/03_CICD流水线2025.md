# CI/CDæµæ°´çº¿ (2025)

**æ›´æ–°æ—¥æœŸ**: 2025-10-20  
**ç‰ˆæœ¬**: v2.0  
**çŠ¶æ€**: âœ… **2025æ ‡å‡†å¯¹é½å®Œæˆ**

---

## ç›®å½•

- [CI/CDæµæ°´çº¿ (2025)](#cicdæµæ°´çº¿-2025)
  - [ç›®å½•](#ç›®å½•)
  - [äº‘åŸç”ŸCI/CDæ¦‚è¿°](#äº‘åŸç”Ÿcicdæ¦‚è¿°)
    - [ä¼ ç»Ÿ vs äº‘åŸç”Ÿ CI/CD](#ä¼ ç»Ÿ-vs-äº‘åŸç”Ÿ-cicd)
    - [2025 CI/CDè¶‹åŠ¿](#2025-cicdè¶‹åŠ¿)
  - [GitHub Actions (2025)](#github-actions-2025)
    - [GitHub Actionsæ¦‚è¿°](#github-actionsæ¦‚è¿°)
    - [å·¥ä½œæµåŸºç¡€](#å·¥ä½œæµåŸºç¡€)
    - [å®¹å™¨é•œåƒæ„å»ºä¸æ¨é€](#å®¹å™¨é•œåƒæ„å»ºä¸æ¨é€)
    - [GitHub Actions 2025æ–°ç‰¹æ€§](#github-actions-2025æ–°ç‰¹æ€§)
      - [1. Larger Runners (æ›´å¤§çš„Runner)](#1-larger-runners-æ›´å¤§çš„runner)
      - [2. ARM64 Runners](#2-arm64-runners)
      - [3. Reusable Workflows (å¯å¤ç”¨å·¥ä½œæµ)](#3-reusable-workflows-å¯å¤ç”¨å·¥ä½œæµ)
      - [4. OIDC Token (æ— å¯†é’¥äº‘è®¿é—®)](#4-oidc-token-æ— å¯†é’¥äº‘è®¿é—®)
  - [GitLab CI/CD (17.x)](#gitlab-cicd-17x)
    - [GitLab CI/CDæ¦‚è¿°](#gitlab-cicdæ¦‚è¿°)
    - [Pipelineé…ç½®](#pipelineé…ç½®)
    - [GitLab CI/CD 17.xæ–°ç‰¹æ€§](#gitlab-cicd-17xæ–°ç‰¹æ€§)
      - [1. CI/CD Catalog (ç»„ä»¶å¸‚åœº)](#1-cicd-catalog-ç»„ä»¶å¸‚åœº)
      - [2. åŠ¨æ€å­æµæ°´çº¿](#2-åŠ¨æ€å­æµæ°´çº¿)
      - [3. åˆå¹¶è¯·æ±‚å®¡æ‰¹è§„åˆ™](#3-åˆå¹¶è¯·æ±‚å®¡æ‰¹è§„åˆ™)
      - [4. Value Streamåˆ†æ](#4-value-streamåˆ†æ)
  - [Tekton Pipelines](#tekton-pipelines)
    - [Tektonæ¦‚è¿°](#tektonæ¦‚è¿°)
    - [Tektonæ ¸å¿ƒèµ„æº](#tektonæ ¸å¿ƒèµ„æº)
    - [Tekton Pipelineç¤ºä¾‹](#tekton-pipelineç¤ºä¾‹)
    - [Tekton Triggers](#tekton-triggers)
  - [é•œåƒå®‰å…¨æ‰«æ](#é•œåƒå®‰å…¨æ‰«æ)
    - [Trivyæ‰«æ](#trivyæ‰«æ)
    - [SBOMç”Ÿæˆ](#sbomç”Ÿæˆ)
    - [é•œåƒç­¾å](#é•œåƒç­¾å)
  - [ç­–ç•¥éªŒè¯ (Policy-as-Code)](#ç­–ç•¥éªŒè¯-policy-as-code)
    - [Conftestç­–ç•¥éªŒè¯](#conftestç­–ç•¥éªŒè¯)
    - [OPA Gatekeeperé›†æˆ](#opa-gatekeeperé›†æˆ)
  - [GitOpså·¥ä½œæµ](#gitopså·¥ä½œæµ)
    - [ArgoCDè‡ªåŠ¨åŒ–éƒ¨ç½²](#argocdè‡ªåŠ¨åŒ–éƒ¨ç½²)
    - [Flux CD](#flux-cd)
    - [Kustomizeé…ç½®ç®¡ç†](#kustomizeé…ç½®ç®¡ç†)
  - [é«˜çº§éƒ¨ç½²ç­–ç•¥](#é«˜çº§éƒ¨ç½²ç­–ç•¥)
    - [é‡‘ä¸é›€éƒ¨ç½² (Canary)](#é‡‘ä¸é›€éƒ¨ç½²-canary)
    - [è“ç»¿éƒ¨ç½² (Blue-Green)](#è“ç»¿éƒ¨ç½²-blue-green)
    - [æ¸è¿›å¼äº¤ä»˜ (Progressive Delivery)](#æ¸è¿›å¼äº¤ä»˜-progressive-delivery)
  - [å®¹å™¨åŒ–æ„å»º](#å®¹å™¨åŒ–æ„å»º)
    - [BuildKité«˜çº§ç‰¹æ€§](#buildkité«˜çº§ç‰¹æ€§)
    - [Kanikoæ— ç‰¹æƒæ„å»º](#kanikoæ— ç‰¹æƒæ„å»º)
    - [å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–](#å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–)
  - [CI/CDå®‰å…¨æœ€ä½³å®è·µ](#cicdå®‰å…¨æœ€ä½³å®è·µ)
    - [ä¾›åº”é“¾å®‰å…¨](#ä¾›åº”é“¾å®‰å…¨)
    - [å¯†é’¥ç®¡ç†](#å¯†é’¥ç®¡ç†)
    - [å·¥ä½œæµå®‰å…¨](#å·¥ä½œæµå®‰å…¨)
  - [å¤šäº‘CI/CD](#å¤šäº‘cicd)
    - [è·¨äº‘éƒ¨ç½²ç­–ç•¥](#è·¨äº‘éƒ¨ç½²ç­–ç•¥)
    - [æ··åˆäº‘CI/CD](#æ··åˆäº‘cicd)
  - [ç›‘æ§ä¸å¯è§‚æµ‹æ€§](#ç›‘æ§ä¸å¯è§‚æµ‹æ€§)
    - [æµæ°´çº¿æŒ‡æ ‡](#æµæ°´çº¿æŒ‡æ ‡)
    - [å¤±è´¥åˆ†æ](#å¤±è´¥åˆ†æ)
  - [ç”Ÿäº§å®è·µæ¡ˆä¾‹](#ç”Ÿäº§å®è·µæ¡ˆä¾‹)
    - [å¾®æœåŠ¡CI/CD](#å¾®æœåŠ¡cicd)
    - [å•ä½“åº”ç”¨è¿ç§»](#å•ä½“åº”ç”¨è¿ç§»)
    - [å¤šç¯å¢ƒç®¡ç†](#å¤šç¯å¢ƒç®¡ç†)
  - [æ€»ç»“](#æ€»ç»“)
    - [æŠ€æœ¯é€‰å‹æŒ‡å—](#æŠ€æœ¯é€‰å‹æŒ‡å—)
    - [2025 CI/CDæœ€ä½³å®è·µ](#2025-cicdæœ€ä½³å®è·µ)
  - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## äº‘åŸç”ŸCI/CDæ¦‚è¿°

### ä¼ ç»Ÿ vs äº‘åŸç”Ÿ CI/CD

| ç»´åº¦ | ä¼ ç»ŸCI/CD | äº‘åŸç”ŸCI/CD |
|------|----------|------------|
| **æ„å»ºç¯å¢ƒ** | VM/ç‰©ç†æœº | å®¹å™¨/Pod |
| **éƒ¨ç½²ç›®æ ‡** | VM/è£¸é‡‘å± | Kubernetes |
| **é…ç½®ç®¡ç†** | Ansible/Chef | Kustomize/Helm |
| **éƒ¨ç½²æ–¹å¼** | Push (CIæ¨é€) | Pull (GitOpsæ‹‰å–) |
| **å›æ»š** | æ‰‹åŠ¨/è„šæœ¬ | Git Revertè‡ªåŠ¨ |
| **ç›‘æ§** | åº”ç”¨ç›‘æ§ | å…¨é“¾è·¯å¯è§‚æµ‹æ€§ |
| **å®‰å…¨** | é•œåƒæ‰«æ | SBOM+ç­¾å+ç­–ç•¥ |

---

### 2025 CI/CDè¶‹åŠ¿

```text
1. âœ… GitOpsä¸»æµåŒ–
   - ArgoCDã€Fluxå¹¿æ³›é‡‡ç”¨
   - å£°æ˜å¼åŸºç¡€è®¾æ–½

2. âœ… ä¾›åº”é“¾å®‰å…¨æ ‡å‡†åŒ–
   - SBOMå¿…éœ€
   - SLSAæ¡†æ¶
   - é•œåƒç­¾å (Cosign)

3. âœ… Policy-as-Code
   - OPA/Conftestç­–ç•¥éªŒè¯
   - è‡ªåŠ¨åŒ–åˆè§„æ£€æŸ¥

4. âœ… eBPFå¯è§‚æµ‹æ€§
   - Pixieã€Tetragoné›†æˆ
   - é›¶ä¾µå…¥æ€§èƒ½åˆ†æ

5. âœ… æ¸è¿›å¼äº¤ä»˜
   - Argo Rollouts
   - Flaggeré‡‘ä¸é›€
   - æµé‡æ¸è¿›åˆ‡æ¢
```

---

## GitHub Actions (2025)

### GitHub Actionsæ¦‚è¿°

**GitHub Actions** æ˜¯ GitHub åŸç”Ÿçš„ CI/CD å¹³å°ã€‚

**å®˜ç½‘**: https://github.com/features/actions

**æ ¸å¿ƒä¼˜åŠ¿**:

```text
âœ… ä¸GitHubæ·±åº¦é›†æˆ
âœ… ä¸°å¯Œçš„Marketplaceç”Ÿæ€
âœ… å¹¶å‘æ‰§è¡Œ (çŸ©é˜µç­–ç•¥)
âœ… å¤šæ¶æ„æ”¯æŒ (x86/ARM)
âœ… è‡ªæ‰˜ç®¡Runner
```

---

### å·¥ä½œæµåŸºç¡€

**.github/workflows/ci.yml**:

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linters
        run: |
          npm run lint
          npm run format-check

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  build:
    name: Build and Push Image
    needs: [lint, test, security-scan]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
          provenance: true
          sbom: true
```

---

### å®¹å™¨é•œåƒæ„å»ºä¸æ¨é€

**å¤šå¹³å°æ„å»º**:

```yaml
- name: Build Multi-Platform Image
  uses: docker/build-push-action@v5
  with:
    context: .
    platforms: linux/amd64,linux/arm64,linux/arm/v7
    push: true
    tags: |
      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
```

**BuildKitç¼“å­˜**:

```yaml
- name: Build with Cache
  uses: docker/build-push-action@v5
  with:
    context: .
    push: true
    tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
    cache-from: type=gha
    cache-to: type=gha,mode=max
```

---

### GitHub Actions 2025æ–°ç‰¹æ€§

#### 1. Larger Runners (æ›´å¤§çš„Runner)

```yaml
jobs:
  build-large:
    runs-on: ubuntu-latest-4-cores  # 4æ ¸8GB
    # æˆ–
    runs-on: ubuntu-latest-8-cores  # 8æ ¸16GB
    # æˆ–
    runs-on: ubuntu-latest-16-cores # 16æ ¸32GB
```

#### 2. ARM64 Runners

```yaml
jobs:
  build-arm:
    runs-on: ubuntu-latest-arm  # ARM64æ¶æ„
```

#### 3. Reusable Workflows (å¯å¤ç”¨å·¥ä½œæµ)

**.github/workflows/reusable-build.yml**:

```yaml
name: Reusable Build

on:
  workflow_call:
    inputs:
      node-version:
        required: true
        type: string
    secrets:
      NPM_TOKEN:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
      
      - run: npm ci
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - run: npm run build
```

**è°ƒç”¨å¯å¤ç”¨å·¥ä½œæµ**:

```yaml
jobs:
  call-build:
    uses: ./.github/workflows/reusable-build.yml
    with:
      node-version: '20'
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
```

#### 4. OIDC Token (æ— å¯†é’¥äº‘è®¿é—®)

```yaml
jobs:
  deploy-aws:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # OIDC token
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789:role/GitHubActions
          aws-region: us-east-1
      
      - name: Deploy to EKS
        run: |
          aws eks update-kubeconfig --name my-cluster
          kubectl apply -f k8s/
```

---

## GitLab CI/CD (17.x)

### GitLab CI/CDæ¦‚è¿°

**GitLab CI/CD** æ˜¯ GitLab é›†æˆçš„ CI/CD å¹³å°ã€‚

**å®˜ç½‘**: https://docs.gitlab.com/ee/ci/

**æ ¸å¿ƒä¼˜åŠ¿**:

```text
âœ… å®Œæ•´DevOpså¹³å° (Git + CI/CD + Registry + K8s)
âœ… è‡ªåŠ¨DevOps
âœ… å®‰å…¨æ‰«æé›†æˆ (SAST/DAST)
âœ… å¤šRunneræ¶æ„
âœ… ä¼ä¸šçº§åŠŸèƒ½ (å®¡æ‰¹æµã€åˆè§„æ€§)
```

---

### Pipelineé…ç½®

**.gitlab-ci.yml**:

```yaml
stages:
  - build
  - test
  - scan
  - deploy

variables:
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_TLS_VERIFY: 1
  DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA

# æ„å»ºé•œåƒ
build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --pull -t $IMAGE .
    - docker push $IMAGE
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# å•å…ƒæµ‹è¯•
test:unit:
  stage: test
  image: node:20-alpine
  cache:
    paths:
      - node_modules/
  script:
    - npm ci
    - npm test
  coverage: '/^Statements\s+:\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

# å®‰å…¨æ‰«æ
scan:trivy:
  stage: scan
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - trivy image --exit-code 1 --severity CRITICAL,HIGH $IMAGE
  allow_failure: true

# SBOMç”Ÿæˆ
scan:sbom:
  stage: scan
  image:
    name: anchore/syft:latest
    entrypoint: [""]
  script:
    - syft packages $IMAGE -o cyclonedx-json > sbom.json
  artifacts:
    reports:
      cyclonedx: sbom.json

# SASTæ‰«æ
sast:
  stage: scan
  variables:
    SAST_EXCLUDED_PATHS: "spec, test, tests, tmp"
include:
  - template: Security/SAST.gitlab-ci.yml

# éƒ¨ç½²åˆ°Kubernetes
deploy:production:
  stage: deploy
  image: bitnami/kubectl:latest
  environment:
    name: production
    kubernetes:
      namespace: production
  script:
    - kubectl set image deployment/myapp myapp=$IMAGE
    - kubectl rollout status deployment/myapp
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual  # æ‰‹åŠ¨è§¦å‘
```

---

### GitLab CI/CD 17.xæ–°ç‰¹æ€§

#### 1. CI/CD Catalog (ç»„ä»¶å¸‚åœº)

```yaml
include:
  - component: gitlab.com/components/docker-build:1.0.0
    inputs:
      image-name: myapp
      dockerfile: Dockerfile
```

#### 2. åŠ¨æ€å­æµæ°´çº¿

```yaml
generate-pipeline:
  stage: build
  script:
    - echo "include:" > pipeline.yml
    - for service in $(ls services/); do
        echo "  - local: services/$service/.gitlab-ci.yml" >> pipeline.yml;
      done
  artifacts:
    paths:
      - pipeline.yml

trigger-pipeline:
  stage: deploy
  trigger:
    include:
      - artifact: pipeline.yml
        job: generate-pipeline
```

#### 3. åˆå¹¶è¯·æ±‚å®¡æ‰¹è§„åˆ™

```yaml
rules:
  - if: $CI_MERGE_REQUEST_ID
    when: manual
    allow_failure: false
    needs:
      - sast
      - trivy-scan
```

#### 4. Value Streamåˆ†æ

GitLab 17.x å†…ç½® **Value Stream Analytics**ï¼Œå¯è§†åŒ– DevOps æ•ˆç‡ï¼š

- Lead Time (ä»éœ€æ±‚åˆ°éƒ¨ç½²)
- Cycle Time (ä»£ç å¼€å‘åˆ°åˆå¹¶)
- Deployment Frequency
- Change Failure Rate

---

## Tekton Pipelines

### Tektonæ¦‚è¿°

**Tekton** æ˜¯ Kubernetes åŸç”Ÿçš„ CI/CD æ¡†æ¶ï¼Œæ˜¯ **CD Foundation** é¡¹ç›®ã€‚

**å®˜ç½‘**: https://tekton.dev/

**æ ¸å¿ƒä¼˜åŠ¿**:

```text
âœ… KubernetesåŸç”Ÿ (CRD)
âœ… å¯ç§»æ¤æ€§ (è·¨å¹³å°)
âœ… å¯æ‰©å±•æ€§ (è‡ªå®šä¹‰Task)
âœ… äº‘æ— å…³
âœ… å£°æ˜å¼é…ç½®
```

---

### Tektonæ ¸å¿ƒèµ„æº

```text
1. Task: ç‹¬ç«‹çš„æ„å»ºæ­¥éª¤
2. Pipeline: Taskçš„ç¼–æ’
3. PipelineRun: Pipelineçš„æ‰§è¡Œå®ä¾‹
4. TaskRun: Taskçš„æ‰§è¡Œå®ä¾‹
5. Trigger: äº‹ä»¶è§¦å‘å™¨
```

---

### Tekton Pipelineç¤ºä¾‹

**å®‰è£…Tekton**:

```bash
# å®‰è£…Tekton Pipelines
kubectl apply -f https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml

# å®‰è£…Tekton Triggers
kubectl apply -f https://storage.googleapis.com/tekton-releases/triggers/latest/release.yaml

# å®‰è£…Tekton Dashboard
kubectl apply -f https://storage.googleapis.com/tekton-releases/dashboard/latest/release.yaml

# éªŒè¯
kubectl get pods -n tekton-pipelines
```

**Taskå®šä¹‰** (`task-build.yaml`):

```yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-docker-image
spec:
  params:
  - name: image
    type: string
    description: Reference of the image to build
  - name: dockerfile
    type: string
    description: Path to the Dockerfile
    default: ./Dockerfile
  
  workspaces:
  - name: source
    description: The git repo source
  
  results:
  - name: IMAGE_DIGEST
    description: Digest of the built image
  
  steps:
  - name: build-and-push
    image: gcr.io/kaniko-project/executor:latest
    args:
    - --dockerfile=$(params.dockerfile)
    - --context=$(workspaces.source.path)
    - --destination=$(params.image)
    - --digest-file=/tekton/results/IMAGE_DIGEST
    securityContext:
      runAsUser: 0
```

**Pipelineå®šä¹‰** (`pipeline.yaml`):

```yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: build-and-deploy
spec:
  params:
  - name: repo-url
    type: string
    description: Git repository URL
  - name: image
    type: string
    description: Image reference
  
  workspaces:
  - name: shared-workspace
  
  tasks:
  # 1. Cloneæºä»£ç 
  - name: fetch-source
    taskRef:
      name: git-clone
      kind: ClusterTask
    params:
    - name: url
      value: $(params.repo-url)
    - name: revision
      value: main
    workspaces:
    - name: output
      workspace: shared-workspace
  
  # 2. è¿è¡Œæµ‹è¯•
  - name: run-tests
    taskRef:
      name: npm-test
    runAfter:
    - fetch-source
    workspaces:
    - name: source
      workspace: shared-workspace
  
  # 3. æ„å»ºé•œåƒ
  - name: build-image
    taskRef:
      name: build-docker-image
    runAfter:
    - run-tests
    params:
    - name: image
      value: $(params.image)
    workspaces:
    - name: source
      workspace: shared-workspace
  
  # 4. å®‰å…¨æ‰«æ
  - name: scan-image
    taskRef:
      name: trivy-scan
    runAfter:
    - build-image
    params:
    - name: image
      value: $(params.image)
  
  # 5. éƒ¨ç½²åˆ°Kubernetes
  - name: deploy
    taskRef:
      name: kubectl-deploy
    runAfter:
    - scan-image
    params:
    - name: image
      value: $(params.image)
```

**PipelineRunå®šä¹‰** (`pipelinerun.yaml`):

```yaml
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: build-and-deploy-run
spec:
  pipelineRef:
    name: build-and-deploy
  params:
  - name: repo-url
    value: https://github.com/example/myapp.git
  - name: image
    value: gcr.io/my-project/myapp:latest
  workspaces:
  - name: shared-workspace
    volumeClaimTemplate:
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
```

---

### Tekton Triggers

**EventListener** (ç›‘å¬GitHub Webhook):

```yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: github-listener
spec:
  serviceAccountName: tekton-triggers-sa
  triggers:
  - name: github-push
    interceptors:
    - ref:
        name: github
      params:
      - name: secretRef
        value:
          secretName: github-webhook-secret
          secretKey: token
      - name: eventTypes
        value:
        - push
    bindings:
    - ref: github-push-binding
    template:
      ref: pipeline-template
---
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: github-push-binding
spec:
  params:
  - name: gitrevision
    value: $(body.head_commit.id)
  - name: gitrepositoryurl
    value: $(body.repository.clone_url)
---
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: pipeline-template
spec:
  params:
  - name: gitrevision
  - name: gitrepositoryurl
  resourcetemplates:
  - apiVersion: tekton.dev/v1
    kind: PipelineRun
    metadata:
      generateName: build-and-deploy-
    spec:
      pipelineRef:
        name: build-and-deploy
      params:
      - name: repo-url
        value: $(tt.params.gitrepositoryurl)
      workspaces:
      - name: shared-workspace
        volumeClaimTemplate:
          spec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
```

---

## é•œåƒå®‰å…¨æ‰«æ

### Trivyæ‰«æ

**åœ¨CI/CDä¸­é›†æˆTrivy**:

```yaml
# GitHub Actions
- name: Run Trivy Scanner
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: 'myregistry.com/myapp:${{ github.sha }}'
    format: 'sarif'
    output: 'trivy-results.sarif'
    severity: 'CRITICAL,HIGH'
    exit-code: '1'  # å‘ç°æ¼æ´åˆ™å¤±è´¥

# GitLab CI
trivy-scan:
  image: aquasec/trivy:latest
  script:
    - trivy image --exit-code 1 --severity CRITICAL,HIGH $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
```

---

### SBOMç”Ÿæˆ

**ä½¿ç”¨Syftç”ŸæˆSBOM**:

```yaml
# GitHub Actions
- name: Generate SBOM
  uses: anchore/sbom-action@v0
  with:
    image: myregistry.com/myapp:${{ github.sha }}
    format: cyclonedx-json
    output-file: sbom.json

- name: Upload SBOM
  uses: actions/upload-artifact@v4
  with:
    name: sbom
    path: sbom.json
```

**ä½¿ç”¨Syft CLI**:

```bash
# ç”ŸæˆSBOM
syft packages myregistry.com/myapp:latest -o cyclonedx-json > sbom.json

# ç”Ÿæˆå¤šç§æ ¼å¼
syft packages myregistry.com/myapp:latest -o spdx-json > sbom-spdx.json
```

---

### é•œåƒç­¾å

**ä½¿ç”¨Cosignç­¾åé•œåƒ**:

```yaml
# GitHub Actions
- name: Install Cosign
  uses: sigstore/cosign-installer@v3

- name: Sign Image
  run: |
    cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}
  env:
    COSIGN_EXPERIMENTAL: "true"  # æ— å¯†é’¥ç­¾å

# éªŒè¯ç­¾å
- name: Verify Signature
  run: |
    cosign verify ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}
  env:
    COSIGN_EXPERIMENTAL: "true"
```

---

## ç­–ç•¥éªŒè¯ (Policy-as-Code)

### Conftestç­–ç•¥éªŒè¯

**å®‰è£…Conftest**:

```bash
# ä¸‹è½½Conftest
curl -L -o conftest https://github.com/open-policy-agent/conftest/releases/latest/download/conftest-linux-amd64
chmod +x conftest
sudo mv conftest /usr/local/bin/
```

**Regoç­–ç•¥** (`policy/docker.rego`):

```rego
package main

import rego.v1

deny contains msg if {
    input[i].Cmd == "from"
    val := input[i].Value
    contains(val[i], "latest")
    msg := "Do not use 'latest' tag for base images"
}

deny contains msg if {
    input[i].Cmd == "run"
    val := input[i].Value
    contains(val[i], "sudo")
    msg := "Do not use 'sudo' in Dockerfile"
}

deny contains msg if {
    input[i].Cmd == "user"
    val := input[i].Value
    val[i] == "root"
    msg := "Do not run as root user"
}
```

**åœ¨CIä¸­éªŒè¯**:

```yaml
# GitHub Actions
- name: Test Dockerfile with Conftest
  run: |
    conftest test Dockerfile

# GitLab CI
conftest:
  image: openpolicyagent/conftest:latest
  script:
    - conftest test Dockerfile
```

---

### OPA Gatekeeperé›†æˆ

**éªŒè¯Kubernetes manifests**:

```rego
# policy/kubernetes.rego
package main

import rego.v1

deny contains msg if {
    input.kind == "Deployment"
    not input.spec.template.spec.securityContext.runAsNonRoot
    msg := "Deployments must set runAsNonRoot: true"
}

deny contains msg if {
    input.kind == "Deployment"
    container := input.spec.template.spec.containers[_]
    not container.resources.limits.memory
    msg := sprintf("Container '%s' must set memory limits", [container.name])
}
```

**åœ¨CIä¸­éªŒè¯**:

```yaml
- name: Validate K8s Manifests
  run: |
    conftest test k8s/ --policy policy/
```

---

## GitOpså·¥ä½œæµ

### ArgoCDè‡ªåŠ¨åŒ–éƒ¨ç½²

**å®‰è£…ArgoCD**:

```bash
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# è·å–åˆå§‹å¯†ç 
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

# ç«¯å£è½¬å‘
kubectl port-forward svc/argocd-server -n argocd 8080:443
```

**Applicationå®šä¹‰**:

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: myapp
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  
  source:
    repoURL: https://github.com/example/myapp-config.git
    targetRevision: HEAD
    path: k8s/overlays/production
    
    # Kustomizeé…ç½®
    kustomize:
      version: v5.0.0
      images:
      - name: myapp
        newTag: v1.2.3
  
  destination:
    server: https://kubernetes.default.svc
    namespace: production
  
  syncPolicy:
    automated:
      prune: true      # è‡ªåŠ¨åˆ é™¤ä¸éœ€è¦çš„èµ„æº
      selfHeal: true   # è‡ªåŠ¨åŒæ­¥åå·®
      allowEmpty: false
    
    syncOptions:
    - CreateNamespace=true
    - PrunePropagationPolicy=foreground
    
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
```

**Image Updater** (è‡ªåŠ¨æ›´æ–°é•œåƒ):

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: myapp
  annotations:
    argocd-image-updater.argoproj.io/image-list: myapp=gcr.io/my-project/myapp
    argocd-image-updater.argoproj.io/myapp.update-strategy: semver
    argocd-image-updater.argoproj.io/myapp.allow-tags: regexp:^v1\\..*
spec:
  # ... åŒä¸Š
```

---

### Flux CD

**å®‰è£…Flux**:

```bash
# å®‰è£…Flux CLI
curl -s https://fluxcd.io/install.sh | sudo bash

# Bootstrap Fluxåˆ°é›†ç¾¤
flux bootstrap github \
  --owner=my-github-org \
  --repository=my-fleet \
  --branch=main \
  --path=clusters/production \
  --personal
```

**GitRepositoryå®šä¹‰**:

```yaml
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: myapp
  namespace: flux-system
spec:
  interval: 1m
  url: https://github.com/example/myapp-config
  ref:
    branch: main
```

**Kustomizationå®šä¹‰**:

```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: myapp
  namespace: flux-system
spec:
  interval: 5m
  path: ./k8s/production
  prune: true
  sourceRef:
    kind: GitRepository
    name: myapp
  healthChecks:
  - apiVersion: apps/v1
    kind: Deployment
    name: myapp
    namespace: production
```

**ImageRepository** (é•œåƒè‡ªåŠ¨æ›´æ–°):

```yaml
apiVersion: image.toolkit.fluxcd.io/v1beta2
kind: ImageRepository
metadata:
  name: myapp
  namespace: flux-system
spec:
  image: gcr.io/my-project/myapp
  interval: 1m
---
apiVersion: image.toolkit.fluxcd.io/v1beta2
kind: ImagePolicy
metadata:
  name: myapp
  namespace: flux-system
spec:
  imageRepositoryRef:
    name: myapp
  policy:
    semver:
      range: 1.x.x
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImageUpdateAutomation
metadata:
  name: myapp
  namespace: flux-system
spec:
  interval: 1m
  sourceRef:
    kind: GitRepository
    name: myapp
  git:
    checkout:
      ref:
        branch: main
    commit:
      author:
        email: fluxcd@example.com
        name: Flux CD
      messageTemplate: 'Update image to {{range .Updated.Images}}{{println .}}{{end}}'
    push:
      branch: main
  update:
    path: ./k8s/production
    strategy: Setters
```

---

### Kustomizeé…ç½®ç®¡ç†

**ç›®å½•ç»“æ„**:

```text
k8s/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â””â”€â”€ configmap.yaml
â””â”€â”€ overlays/
    â”œâ”€â”€ dev/
    â”‚   â”œâ”€â”€ kustomization.yaml
    â”‚   â””â”€â”€ patches/
    â”‚       â””â”€â”€ deployment-patch.yaml
    â”œâ”€â”€ staging/
    â”‚   â””â”€â”€ kustomization.yaml
    â””â”€â”€ production/
        â”œâ”€â”€ kustomization.yaml
        â””â”€â”€ patches/
            â””â”€â”€ deployment-patch.yaml
```

**base/kustomization.yaml**:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- deployment.yaml
- service.yaml
- configmap.yaml

commonLabels:
  app: myapp
  managed-by: kustomize

images:
- name: myapp
  newName: gcr.io/my-project/myapp
  newTag: latest
```

**overlays/production/kustomization.yaml**:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

bases:
- ../../base

namespace: production

replicas:
- name: myapp
  count: 5

images:
- name: myapp
  newTag: v1.2.3

patches:
- path: patches/deployment-patch.yaml

configMapGenerator:
- name: myapp-config
  behavior: merge
  literals:
  - ENV=production
  - LOG_LEVEL=info

resources:
- hpa.yaml
- pdb.yaml
```

---

## é«˜çº§éƒ¨ç½²ç­–ç•¥

### é‡‘ä¸é›€éƒ¨ç½² (Canary)

**ä½¿ç”¨Argo Rollouts**:

**å®‰è£…Argo Rollouts**:

```bash
kubectl create namespace argo-rollouts
kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml

# å®‰è£…kubectl plugin
curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
chmod +x kubectl-argo-rollouts-linux-amd64
sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts
```

**Rolloutå®šä¹‰**:

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: myapp
spec:
  replicas: 10
  strategy:
    canary:
      steps:
      - setWeight: 20      # 20%æµé‡åˆ°æ–°ç‰ˆæœ¬
      - pause: {duration: 1m}
      - setWeight: 40
      - pause: {duration: 1m}
      - setWeight: 60
      - pause: {duration: 1m}
      - setWeight: 80
      - pause: {duration: 1m}
      
      # è‡ªåŠ¨æ¨è¿›æ¡ä»¶
      canaryAnalysis:
        templates:
        - templateName: success-rate
        args:
        - name: service-name
          value: myapp
      
      # æµé‡ç®¡ç† (Istio)
      trafficRouting:
        istio:
          virtualService:
            name: myapp
            routes:
            - primary
  
  revisionHistoryLimit: 2
  
  selector:
    matchLabels:
      app: myapp
  
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: gcr.io/my-project/myapp:v2.0.0
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
```

**AnalysisTemplate** (æŒ‡æ ‡åˆ†æ):

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    initialDelay: 1m
    interval: 1m
    successCondition: result[0] >= 0.95
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.monitoring:9090
        query: |
          sum(rate(
            http_requests_total{service="{{args.service-name}}",status=~"2.."}[1m]
          )) /
          sum(rate(
            http_requests_total{service="{{args.service-name}}"}[1m]
          ))
```

---

### è“ç»¿éƒ¨ç½² (Blue-Green)

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: myapp
spec:
  replicas: 5
  strategy:
    blueGreen:
      activeService: myapp-active
      previewService: myapp-preview
      autoPromotionEnabled: false
      scaleDownDelaySeconds: 300
      
      # è‡ªåŠ¨æ¨è¿›æ¡ä»¶
      prePromotionAnalysis:
        templates:
        - templateName: smoke-tests
      
      # æ¨è¿›ååˆ†æ
      postPromotionAnalysis:
        templates:
        - templateName: success-rate
  
  selector:
    matchLabels:
      app: myapp
  
  template:
    # ... åŒä¸Š
```

**æ‰‹åŠ¨æ¨è¿›**:

```bash
# æŸ¥çœ‹çŠ¶æ€
kubectl argo rollouts get rollout myapp

# æ¨è¿›åˆ°ç¨³å®šç‰ˆæœ¬
kubectl argo rollouts promote myapp

# å›æ»š
kubectl argo rollouts undo myapp
```

---

### æ¸è¿›å¼äº¤ä»˜ (Progressive Delivery)

**ä½¿ç”¨Flagger** (ä¸Istio/Linkerdé›†æˆ):

**å®‰è£…Flagger**:

```bash
kubectl apply -k github.com/fluxcd/flagger//kustomize/istio
```

**Canaryå®šä¹‰**:

```yaml
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: myapp
  namespace: production
spec:
  # deployment reference
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: myapp
  
  # HPA reference (optional)
  autoscalerRef:
    apiVersion: autoscaling/v2
    kind: HorizontalPodAutoscaler
    name: myapp
  
  service:
    port: 8080
    targetPort: 8080
    name: myapp
  
  analysis:
    interval: 1m
    threshold: 5
    maxWeight: 50
    stepWeight: 10
    
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: 99
      interval: 1m
    
    - name: request-duration
      thresholdRange:
        max: 500
      interval: 1m
    
    webhooks:
    - name: load-test
      url: http://flagger-loadtester/
      timeout: 5s
      metadata:
        type: cmd
        cmd: "hey -z 1m -q 10 -c 2 http://myapp-canary:8080/"
```

---

## å®¹å™¨åŒ–æ„å»º

### BuildKité«˜çº§ç‰¹æ€§

**å¯ç”¨BuildKit**:

```bash
export DOCKER_BUILDKIT=1
docker build .
```

**å¤šé˜¶æ®µç¼“å­˜**:

```dockerfile
# syntax=docker/dockerfile:1.4

FROM node:20-alpine AS deps
WORKDIR /app
COPY package*.json ./
RUN --mount=type=cache,target=/root/.npm \
    npm ci --only=production

FROM node:20-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN --mount=type=cache,target=/root/.npm \
    npm ci
COPY . .
RUN npm run build

FROM node:20-alpine
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY --from=build /app/dist ./dist
CMD ["node", "dist/index.js"]
```

**SecretæŒ‚è½½** (ä¸æ³„éœ²åˆ°é•œåƒ):

```dockerfile
# syntax=docker/dockerfile:1.4

FROM alpine
RUN --mount=type=secret,id=github_token \
    apk add git && \
    git clone https://$(cat /run/secrets/github_token)@github.com/private/repo.git
```

```bash
docker build --secret id=github_token,src=./token.txt .
```

---

### Kanikoæ— ç‰¹æƒæ„å»º

**åœ¨Kubernetesä¸­ä½¿ç”¨Kaniko**:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: kaniko
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    args:
    - --dockerfile=/workspace/Dockerfile
    - --context=dir:///workspace
    - --destination=gcr.io/my-project/myapp:latest
    - --cache=true
    - --cache-repo=gcr.io/my-project/cache
    volumeMounts:
    - name: source
      mountPath: /workspace
    - name: docker-config
      mountPath: /kaniko/.docker/
  restartPolicy: Never
  volumes:
  - name: source
    persistentVolumeClaim:
      claimName: workspace-pvc
  - name: docker-config
    secret:
      secretName: docker-config
```

**Tekton Taskä½¿ç”¨Kaniko**:

```yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: kaniko-build
spec:
  params:
  - name: IMAGE
    description: Name (reference) of the image to build.
  workspaces:
  - name: source
  steps:
  - name: build-and-push
    image: gcr.io/kaniko-project/executor:v1.19.0
    args:
    - --dockerfile=$(workspaces.source.path)/Dockerfile
    - --context=$(workspaces.source.path)
    - --destination=$(params.IMAGE)
    - --cache=true
    - --cache-ttl=24h
```

---

### å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–

**ä¼˜åŒ–å‰**:

```dockerfile
FROM node:20
WORKDIR /app
COPY . .
RUN npm install
RUN npm run build
CMD ["node", "dist/index.js"]
```

**ä¼˜åŒ–å**:

```dockerfile
# syntax=docker/dockerfile:1.4

# 1. ä¾èµ–å®‰è£…é˜¶æ®µ (ç”Ÿäº§ä¾èµ–)
FROM node:20-alpine AS deps
WORKDIR /app
COPY package*.json ./
RUN --mount=type=cache,target=/root/.npm \
    npm ci --only=production

# 2. æ„å»ºé˜¶æ®µ
FROM node:20-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN --mount=type=cache,target=/root/.npm \
    npm ci
COPY . .
RUN npm run build

# 3. è¿è¡Œé˜¶æ®µ (æœ€å°é•œåƒ)
FROM node:20-alpine
RUN apk add --no-cache dumb-init
USER node
WORKDIR /app
COPY --chown=node:node --from=deps /app/node_modules ./node_modules
COPY --chown=node:node --from=build /app/dist ./dist
ENTRYPOINT ["dumb-init", "--"]
CMD ["node", "dist/index.js"]
```

**ä¼˜åŒ–æ•ˆæœ**:

```text
ä¼˜åŒ–å‰: 1.2GB
ä¼˜åŒ–å: 150MB

ä¼˜åŒ–ç‚¹:
âœ… ä½¿ç”¨alpineåŸºç¡€é•œåƒ
âœ… å¤šé˜¶æ®µæ„å»ºï¼Œåªå¤åˆ¶å¿…è¦æ–‡ä»¶
âœ… ç§»é™¤æ„å»ºå·¥å…·å’ŒdevDependencies
âœ… BuildKitç¼“å­˜åŠ é€Ÿæ„å»º
âœ… érootç”¨æˆ·è¿è¡Œ
âœ… ä½¿ç”¨dumb-initå¤„ç†ä¿¡å·
```

---

## CI/CDå®‰å…¨æœ€ä½³å®è·µ

### ä¾›åº”é“¾å®‰å…¨

**SLSAæ¡†æ¶**:

```text
SLSA Level 3 è¦æ±‚:
âœ… å¯éªŒè¯çš„æºä»£ç  (Gitç­¾åcommit)
âœ… å¯éªŒè¯çš„æ„å»º (Provenance)
âœ… ä¸å¯ç¯¡æ”¹çš„æ„å»ºç¯å¢ƒ
âœ… å¯†é’¥ç®¡ç† (OIDC)
âœ… SBOMç”Ÿæˆ
âœ… é•œåƒç­¾å (Cosign)
```

**GitHub Actionså®ç°SLSA**:

```yaml
name: SLSA Level 3 Build

on: push

permissions:
  contents: read
  packages: write
  id-token: write  # OIDC

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - uses: docker/setup-buildx-action@v3
      
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:${{ github.sha }}
          provenance: true  # SLSA Provenance
          sbom: true        # SBOMç”Ÿæˆ
      
      - name: Sign Image
        run: |
          cosign sign --yes ghcr.io/${{ github.repository }}@${{ steps.build.outputs.digest }}
        env:
          COSIGN_EXPERIMENTAL: "true"
```

---

### å¯†é’¥ç®¡ç†

**ä½¿ç”¨å¤–éƒ¨å¯†é’¥ç®¡ç†**:

```yaml
# GitHub Actions with Vault
- name: Import Secrets from Vault
  uses: hashicorp/vault-action@v2
  with:
    url: https://vault.example.com
    method: jwt
    role: github-actions
    secrets: |
      secret/data/prod/database username | DB_USER ;
      secret/data/prod/database password | DB_PASS

# GitLab CI with Vault
deploy:
  image: vault:latest
  secrets:
    DATABASE_PASSWORD:
      vault: production/database/password@secret
      file: false
```

**OIDCæ— å¯†é’¥è®¿é—®äº‘èµ„æº** (å·²åœ¨GitHub Actions 2025æ–°ç‰¹æ€§ä¸­å±•ç¤º)

---

### å·¥ä½œæµå®‰å…¨

**æœ€ä½³å®è·µChecklist**:

```text
âœ… ä½¿ç”¨å›ºå®šç‰ˆæœ¬çš„Actions (v1è€Œä¸æ˜¯@main)
âœ… Reviewç¬¬ä¸‰æ–¹Actionsæºä»£ç 
âœ… æœ€å°æƒé™ (permissions: contents: read)
âœ… ä¸åœ¨æ—¥å¿—ä¸­è¾“å‡ºå¯†é’¥ (set-output â†’ GITHUB_OUTPUT)
âœ… ä½¿ç”¨approved actionsåˆ—è¡¨
âœ… å®šæœŸæ›´æ–°ä¾èµ– (Dependabot)
âœ… Code scanning (CodeQL)
âœ… Secret scanning
âœ… å®¡è®¡æ—¥å¿—ç›‘æ§
âœ… åˆ†æ”¯ä¿æŠ¤è§„åˆ™
```

**åˆ†æ”¯ä¿æŠ¤è§„åˆ™**:

```yaml
# .github/branch-protection.yml
branches:
  - name: main
    protection:
      required_status_checks:
        strict: true
        contexts:
          - lint
          - test
          - security-scan
      required_pull_request_reviews:
        required_approving_review_count: 2
        dismiss_stale_reviews: true
        require_code_owner_reviews: true
      restrictions:
        teams:
          - platform-team
      enforce_admins: true
      required_linear_history: true
      allow_force_pushes: false
      allow_deletions: false
```

---

## å¤šäº‘CI/CD

### è·¨äº‘éƒ¨ç½²ç­–ç•¥

**å¤šé›†ç¾¤GitOps** (ArgoCD):

```yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: myapp
spec:
  generators:
  - list:
      elements:
      - cluster: aws-us-east-1
        url: https://kubernetes.aws.example.com
        env: production
      - cluster: gcp-us-central1
        url: https://kubernetes.gcp.example.com
        env: production
      - cluster: azure-eastus
        url: https://kubernetes.azure.example.com
        env: production
  
  template:
    metadata:
      name: 'myapp-{{cluster}}'
    spec:
      project: default
      source:
        repoURL: https://github.com/example/myapp-config.git
        targetRevision: HEAD
        path: k8s/overlays/{{env}}
      destination:
        server: '{{url}}'
        namespace: production
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
```

---

### æ··åˆäº‘CI/CD

**Terraformå¤šäº‘éƒ¨ç½²**:

```hcl
# providers.tf
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
    google = {
      source  = "hashicorp/google"
      version = "~> 5.0"
    }
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0"
    }
  }
}

# aws.tf
provider "aws" {
  region = "us-east-1"
}

resource "aws_eks_cluster" "main" {
  name     = "myapp-aws"
  role_arn = aws_iam_role.eks.arn
  # ...
}

# gcp.tf
provider "google" {
  project = "my-project"
  region  = "us-central1"
}

resource "google_container_cluster" "main" {
  name     = "myapp-gcp"
  location = "us-central1"
  # ...
}

# azure.tf
provider "azurerm" {
  features {}
}

resource "azurerm_kubernetes_cluster" "main" {
  name                = "myapp-azure"
  location            = "East US"
  resource_group_name = azurerm_resource_group.main.name
  # ...
}
```

---

## ç›‘æ§ä¸å¯è§‚æµ‹æ€§

### æµæ°´çº¿æŒ‡æ ‡

**Prometheusç›‘æ§GitLab CI**:

```yaml
# GitLab Runner Prometheus Exporter
global:
  scrape_interval: 15s

scrape_configs:
- job_name: 'gitlab-runner'
  static_configs:
  - targets: ['gitlab-runner:9252']

# å…³é”®æŒ‡æ ‡
gitlab_runner_jobs_total{state="running"}
gitlab_runner_jobs_total{state="success"}
gitlab_runner_jobs_total{state="failed"}
gitlab_runner_job_duration_seconds
```

**Grafana Dashboard**:

```json
{
  "dashboard": {
    "title": "CI/CD Pipeline Metrics",
    "panels": [
      {
        "title": "Success Rate",
        "targets": [
          {
            "expr": "sum(rate(gitlab_runner_jobs_total{state=\"success\"}[5m])) / sum(rate(gitlab_runner_jobs_total[5m]))"
          }
        ]
      },
      {
        "title": "Build Duration (p95)",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(gitlab_runner_job_duration_seconds_bucket[5m]))"
          }
        ]
      }
    ]
  }
}
```

---

### å¤±è´¥åˆ†æ

**è‡ªåŠ¨å¤±è´¥åˆ†æ**:

```yaml
# GitHub Actions - å¤±è´¥æ—¶æ”¶é›†è¯Šæ–­ä¿¡æ¯
- name: Collect Diagnostics on Failure
  if: failure()
  run: |
    kubectl get pods -A
    kubectl describe pod $POD_NAME
    kubectl logs $POD_NAME --previous
    docker ps -a
    docker logs $CONTAINER_ID
  
- name: Upload Diagnostics
  if: failure()
  uses: actions/upload-artifact@v4
  with:
    name: diagnostics-${{ github.run_id }}
    path: |
      /tmp/diagnostics/
      kubectl-output.log
```

---

## ç”Ÿäº§å®è·µæ¡ˆä¾‹

### å¾®æœåŠ¡CI/CD

**Monorepoç»“æ„**:

```text
myapp/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ .gitlab-ci.yml
â”‚   â”‚   â””â”€â”€ k8s/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ .gitlab-ci.yml
â”‚   â”‚   â””â”€â”€ k8s/
â”‚   â””â”€â”€ frontend/
â”‚       â”œâ”€â”€ Dockerfile
â”‚       â”œâ”€â”€ .gitlab-ci.yml
â”‚       â””â”€â”€ k8s/
â””â”€â”€ .gitlab-ci.yml  # ä¸»æµæ°´çº¿
```

**ä¸»æµæ°´çº¿** (`.gitlab-ci.yml`):

```yaml
stages:
  - trigger

trigger-services:
  stage: trigger
  script:
    - |
      for service in $(git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA | cut -d'/' -f1-2 | sort -u); do
        if [ -f "$service/.gitlab-ci.yml" ]; then
          echo "Triggering pipeline for $service"
          curl -X POST \
            -F token=$CI_JOB_TOKEN \
            -F ref=$CI_COMMIT_REF_NAME \
            -F "variables[SERVICE]=$service" \
            https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/trigger/pipeline
        fi
      done
```

---

### å•ä½“åº”ç”¨è¿ç§»

**æ¸è¿›å¼å®¹å™¨åŒ–**:

```yaml
# Phase 1: æ„å»ºå®¹å™¨é•œåƒ
build-container:
  stage: build
  script:
    - docker build -t myapp:$CI_COMMIT_SHA .
    - docker push myapp:$CI_COMMIT_SHA

# Phase 2: é‡‘ä¸é›€éƒ¨ç½² (5%æµé‡)
deploy-canary:
  stage: deploy
  script:
    - kubectl apply -f k8s/canary/
    - kubectl set image deployment/myapp-canary myapp=myapp:$CI_COMMIT_SHA
  environment:
    name: production-canary
    url: https://canary.example.com

# Phase 3: å…¨é‡éƒ¨ç½²
deploy-production:
  stage: deploy
  when: manual
  script:
    - kubectl set image deployment/myapp myapp=myapp:$CI_COMMIT_SHA
  environment:
    name: production
    url: https://example.com
```

---

### å¤šç¯å¢ƒç®¡ç†

**ç¯å¢ƒéš”ç¦»ç­–ç•¥**:

```yaml
# .github/workflows/deploy.yml
name: Deploy to Environment

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options:
          - dev
          - staging
          - production
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to ${{ inputs.environment }}
        run: |
          kubectl config use-context ${{ secrets.K8S_CLUSTER }}
          kubectl apply -k k8s/overlays/${{ inputs.environment }}
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
```

---

## æ€»ç»“

### æŠ€æœ¯é€‰å‹æŒ‡å—

```text
åœºæ™¯1: GitHubæ‰˜ç®¡é¡¹ç›®
â†’ GitHub Actions
  ç†ç”±: æ·±åº¦é›†æˆã€ç®€å•æ˜“ç”¨ã€Marketplaceç”Ÿæ€

åœºæ™¯2: GitLabæ‰˜ç®¡é¡¹ç›®
â†’ GitLab CI/CD
  ç†ç”±: å®Œæ•´DevOpså¹³å°ã€å†…ç½®å®‰å…¨æ‰«æ

åœºæ™¯3: KubernetesåŸç”ŸCI/CD
â†’ Tekton Pipelines
  ç†ç”±: äº‘æ— å…³ã€å¯ç§»æ¤ã€å¯æ‰©å±•

åœºæ™¯4: GitOpséƒ¨ç½²
â†’ ArgoCD (åŠŸèƒ½ä¸°å¯Œ) æˆ– Flux (è½»é‡)
  ç†ç”±: å£°æ˜å¼ã€è‡ªåŠ¨åŒæ­¥ã€Gitä½œä¸ºå”¯ä¸€äº‹å®æ¥æº

åœºæ™¯5: æ¸è¿›å¼äº¤ä»˜
â†’ Argo Rollouts + Flagger
  ç†ç”±: é‡‘ä¸é›€éƒ¨ç½²ã€è‡ªåŠ¨åŒ–æ¨è¿›ã€æŒ‡æ ‡åˆ†æ
```

---

### 2025 CI/CDæœ€ä½³å®è·µ

```text
âœ… ä¾›åº”é“¾å®‰å…¨
   - SBOMç”Ÿæˆ (Syft)
   - é•œåƒç­¾å (Cosign)
   - SLSAæ¡†æ¶

âœ… Policy-as-Code
   - Conftestç­–ç•¥éªŒè¯
   - OPA Gatekeeper

âœ… GitOps
   - ArgoCD/Flux
   - Gitä½œä¸ºå”¯ä¸€äº‹å®æ¥æº
   - è‡ªåŠ¨åŒæ­¥ä¸ä¿®å¤

âœ… æ¸è¿›å¼äº¤ä»˜
   - é‡‘ä¸é›€éƒ¨ç½²
   - è‡ªåŠ¨åŒ–æ¨è¿›
   - æŒ‡æ ‡é©±åŠ¨

âœ… å®‰å…¨æ‰«æ
   - Trivyæ¼æ´æ‰«æ
   - SAST/DAST
   - ä¾èµ–æ£€æŸ¥

âœ… æ— ç‰¹æƒæ„å»º
   - Kaniko
   - BuildKitå®‰å…¨ç‰¹æ€§

âœ… å¯è§‚æµ‹æ€§
   - æµæ°´çº¿æŒ‡æ ‡
   - å¤±è´¥åˆ†æ
   - åˆ†å¸ƒå¼è¿½è¸ª
```

---

## ç›¸å…³æ–‡æ¡£

**æœ¬æ¨¡å—æ–‡æ¡£**:

- [Ansibleè‡ªåŠ¨åŒ–](01_Ansibleè‡ªåŠ¨åŒ–.md)
- [TerraformåŸºç¡€è®¾æ–½å³ä»£ç ](02_TerraformåŸºç¡€è®¾æ–½å³ä»£ç .md)

**ç›¸å…³æ¨¡å—**:

- [å®¹å™¨åŒ–éƒ¨ç½²](../../02_å®¹å™¨åŒ–éƒ¨ç½²/README.md)
- [ç›‘æ§å‘Šè­¦](../../04_è¿ç»´ç®¡ç†/01_ç›‘æ§å‘Šè­¦/README.md)

**å¤–éƒ¨èµ„æº**:

- [GitHub Actionsæ–‡æ¡£](https://docs.github.com/en/actions)
- [GitLab CI/CDæ–‡æ¡£](https://docs.gitlab.com/ee/ci/)
- [Tektonå®˜æ–¹æ–‡æ¡£](https://tekton.dev/docs/)
- [ArgoCDå®˜æ–¹æ–‡æ¡£](https://argo-cd.readthedocs.io/)
- [Flux CDå®˜æ–¹æ–‡æ¡£](https://fluxcd.io/docs/)

---

**æ›´æ–°æ—¶é—´**: 2025-10-20  
**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**çŠ¶æ€**: âœ… **2025æ ‡å‡†å¯¹é½å®Œæˆ**

**ğŸš€ æœ¬æ–‡æ¡£å…¨é¢è¦†ç›–2025å¹´äº‘åŸç”ŸCI/CDæŠ€æœ¯æ ˆï¼ğŸš€**-
