# å‘Šè­¦ç®¡ç†

> **è¿”å›**: [ç›‘æ§å‘Šè­¦é¦–é¡µ](README.md) | [è¿ç»´ç®¡ç†é¦–é¡µ](../README.md) | [éƒ¨ç½²æŒ‡å—é¦–é¡µ](../../00_ç´¢å¼•å¯¼èˆª/README.md)

---

## ğŸ“‹ ç›®å½•

- [å‘Šè­¦ç®¡ç†](#å‘Šè­¦ç®¡ç†)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. Alertmanageræ¶æ„](#1-alertmanageræ¶æ„)
    - [1.1 éƒ¨ç½²é…ç½®](#11-éƒ¨ç½²é…ç½®)
    - [1.2 Alertmanageré…ç½®](#12-alertmanageré…ç½®)
  - [2. å‘Šè­¦è§„åˆ™](#2-å‘Šè­¦è§„åˆ™)
    - [2.1 åŸºç¡€è®¾æ–½å‘Šè­¦](#21-åŸºç¡€è®¾æ–½å‘Šè­¦)
    - [2.2 Kuberneteså‘Šè­¦](#22-kuberneteså‘Šè­¦)
    - [2.3 åº”ç”¨å‘Šè­¦](#23-åº”ç”¨å‘Šè­¦)
  - [3. é€šçŸ¥è·¯ç”±](#3-é€šçŸ¥è·¯ç”±)
    - [3.1 åˆ†çº§è·¯ç”±](#31-åˆ†çº§è·¯ç”±)
    - [3.2 é™é»˜è§„åˆ™](#32-é™é»˜è§„åˆ™)
  - [4. å‘Šè­¦æœ€ä½³å®è·µ](#4-å‘Šè­¦æœ€ä½³å®è·µ)
    - [4.1 å‘Šè­¦è®¾è®¡åŸåˆ™](#41-å‘Šè­¦è®¾è®¡åŸåˆ™)
    - [4.2 å‘Šè­¦æ¨¡æ¿](#42-å‘Šè­¦æ¨¡æ¿)
    - [4.3 Runbookç¼–å†™](#43-runbookç¼–å†™)
    - [4.4 å‘Šè­¦æ”¶æ•›](#44-å‘Šè­¦æ”¶æ•›)

---

## 1. Alertmanageræ¶æ„

### 1.1 éƒ¨ç½²é…ç½®

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: monitoring
spec:
  replicas: 3
  selector:
    matchLabels:
      app: alertmanager
  template:
    metadata:
      labels:
        app: alertmanager
    spec:
      containers:
      - name: alertmanager
        image: prom/alertmanager:v0.26.0
        args:
        - '--config.file=/etc/alertmanager/alertmanager.yml'
        - '--storage.path=/alertmanager'
        - '--cluster.listen-address=0.0.0.0:9094'
        - '--cluster.peer=alertmanager-0.alertmanager:9094'
        - '--cluster.peer=alertmanager-1.alertmanager:9094'
        - '--cluster.peer=alertmanager-2.alertmanager:9094'
        ports:
        - containerPort: 9093
        - containerPort: 9094
        volumeMounts:
        - name: config
          mountPath: /etc/alertmanager
        - name: data
          mountPath: /alertmanager
      volumes:
      - name: config
        configMap:
          name: alertmanager-config
      - name: data
        emptyDir: {}
```

### 1.2 Alertmanageré…ç½®

```yaml
global:
  resolve_timeout: 5m
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alertmanager@example.com'
  smtp_auth_username: 'your-email@gmail.com'
  smtp_auth_password: 'your-password'

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'
  routes:
  - match:
      severity: critical
    receiver: 'critical-team'
    continue: true
  - match:
      severity: warning
    receiver: 'warning-team'

receivers:
- name: 'default'
  email_configs:
  - to: 'team@example.com'
    headers:
      Subject: '[Monitoring] {{ .GroupLabels.alertname }}'

- name: 'critical-team'
  email_configs:
  - to: 'oncall@example.com'
  slack_configs:
  - api_url: 'https://hooks.slack.com/services/xxx'
    channel: '#critical-alerts'
    title: '{{ .GroupLabels.alertname }}'
    text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
  webhook_configs:
  - url: 'http://pagerduty-webhook:8080/alert'

- name: 'warning-team'
  slack_configs:
  - api_url: 'https://hooks.slack.com/services/yyy'
    channel: '#warnings'

inhibit_rules:
- source_match:
    severity: 'critical'
  target_match:
    severity: 'warning'
  equal: ['alertname', 'instance']
```

---

## 2. å‘Šè­¦è§„åˆ™

### 2.1 åŸºç¡€è®¾æ–½å‘Šè­¦

```yaml
groups:
- name: infrastructure_alerts
  interval: 30s
  rules:
  # èŠ‚ç‚¹çŠ¶æ€
  - alert: NodeDown
    expr: up{job="node-exporter"} == 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "èŠ‚ç‚¹ {{ $labels.instance }} ç¦»çº¿"
      description: "èŠ‚ç‚¹å·²ç¦»çº¿è¶…è¿‡5åˆ†é’Ÿ"

  # CPUå‘Šè­¦
  - alert: HighCPUUsage
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "{{ $labels.instance }} CPUä½¿ç”¨ç‡è¿‡é«˜"
      description: "å½“å‰CPUä½¿ç”¨ç‡: {{ $value | humanize }}%"

  # å†…å­˜å‘Šè­¦
  - alert: HighMemoryUsage
    expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "{{ $labels.instance }} å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
      description: "å½“å‰å†…å­˜ä½¿ç”¨ç‡: {{ $value | humanize }}%"

  # ç£ç›˜å‘Šè­¦
  - alert: DiskSpaceLow
    expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "{{ $labels.instance }} ç£ç›˜ç©ºé—´ä¸è¶³"
      description: "æŒ‚è½½ç‚¹ {{ $labels.mountpoint }} ä½¿ç”¨ç‡: {{ $value | humanize }}%"

  - alert: DiskSpaceCritical
    expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 95
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "{{ $labels.instance }} ç£ç›˜ç©ºé—´ä¸¥é‡ä¸è¶³"
      description: "æŒ‚è½½ç‚¹ {{ $labels.mountpoint }} ä½¿ç”¨ç‡: {{ $value | humanize }}%"
```

### 2.2 Kuberneteså‘Šè­¦

```yaml
groups:
- name: kubernetes_alerts
  rules:
  # Podé‡å¯
  - alert: PodRestarting
    expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} é¢‘ç¹é‡å¯"
      description: "è¿‡å»15åˆ†é’Ÿé‡å¯ {{ $value }} æ¬¡"

  # PodçŠ¶æ€å¼‚å¸¸
  - alert: PodNotReady
    expr: kube_pod_status_phase{phase!="Running",phase!="Succeeded"} > 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} çŠ¶æ€å¼‚å¸¸"
      description: "å½“å‰çŠ¶æ€: {{ $labels.phase }}"

  # Deploymentå‰¯æœ¬æ•°ä¸è¶³
  - alert: DeploymentReplicasMismatch
    expr: kube_deployment_spec_replicas != kube_deployment_status_replicas_available
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} å‰¯æœ¬æ•°å¼‚å¸¸"
      description: "æœŸæœ›: {{ $labels.spec_replicas }}, å®é™…: {{ $labels.status_replicas_available }}"

  # HPAè¾¾åˆ°ä¸Šé™
  - alert: HPAMaxedOut
    expr: kube_horizontalpodautoscaler_status_current_replicas == kube_horizontalpodautoscaler_spec_max_replicas
    for: 15m
    labels:
      severity: warning
    annotations:
      summary: "HPA {{ $labels.namespace }}/{{ $labels.horizontalpodautoscaler }} è¾¾åˆ°æœ€å¤§å‰¯æœ¬æ•°"
      description: "å½“å‰å‰¯æœ¬æ•°: {{ $value }}"
```

### 2.3 åº”ç”¨å‘Šè­¦

```yaml
groups:
- name: application_alerts
  rules:
  # HTTPé”™è¯¯ç‡
  - alert: HighErrorRate
    expr: |
      rate(http_requests_total{status=~"5.."}[5m]) / 
      rate(http_requests_total[5m]) * 100 > 5
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "æœåŠ¡ {{ $labels.service }} é”™è¯¯ç‡è¿‡é«˜"
      description: "å½“å‰5xxé”™è¯¯ç‡: {{ $value | humanize }}%"

  # HTTPå»¶è¿Ÿ
  - alert: HighLatency
    expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) > 1
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "æœåŠ¡ {{ $labels.service }} å»¶è¿Ÿè¿‡é«˜"
      description: "P99å»¶è¿Ÿ: {{ $value | humanize }}s"

  # æ•°æ®åº“è¿æ¥æ± 
  - alert: DBConnectionPoolHigh
    expr: db_connection_pool_usage > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜"
      description: "å½“å‰ä½¿ç”¨ç‡: {{ $value }}%"
```

---

## 3. é€šçŸ¥è·¯ç”±

### 3.1 åˆ†çº§è·¯ç”±

```yaml
route:
  receiver: 'default'
  group_by: ['alertname', 'cluster']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  
  routes:
  # Criticalå‘Šè­¦
  - match:
      severity: critical
    receiver: 'pagerduty'
    group_wait: 0s
    repeat_interval: 5m
    routes:
    - match:
        team: platform
      receiver: 'platform-oncall'
    - match:
        team: application
      receiver: 'app-oncall'
  
  # Warningå‘Šè­¦
  - match:
      severity: warning
    receiver: 'slack-warnings'
    repeat_interval: 4h
  
  # ç‰¹å®šæœåŠ¡å‘Šè­¦
  - match_re:
      service: ^(user|order|payment)$
    receiver: 'business-team'
    repeat_interval: 1h
```

### 3.2 é™é»˜è§„åˆ™

```yaml
# é€šè¿‡amtoolå‘½ä»¤é™é»˜
amtool silence add \
  alertname=HighCPUUsage \
  instance=node-1 \
  --comment="è®¡åˆ’ç»´æŠ¤" \
  --duration=2h

# é€šè¿‡APIé™é»˜
curl -X POST http://alertmanager:9093/api/v2/silences \
  -H 'Content-Type: application/json' \
  -d '{
    "matchers": [{
      "name": "alertname",
      "value": "HighCPUUsage"
    }],
    "startsAt": "2024-01-01T00:00:00Z",
    "endsAt": "2024-01-01T02:00:00Z",
    "comment": "è®¡åˆ’ç»´æŠ¤",
    "createdBy": "admin"
  }'
```

---

## 4. å‘Šè­¦æœ€ä½³å®è·µ

### 4.1 å‘Šè­¦è®¾è®¡åŸåˆ™

**5ä¸ªåŸåˆ™**:

1. **å¯æ“ä½œæ€§**: å‘Šè­¦å¿…é¡»éœ€è¦äººå·¥å¹²é¢„
2. **å¯è¯Šæ–­æ€§**: æä¾›è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
3. **é¿å…å™ªéŸ³**: é¿å…è¯¯æŠ¥å’Œé‡å¤å‘Šè­¦
4. **åˆ†çº§åˆç†**: æ ¹æ®å½±å“ç¨‹åº¦åˆ†çº§
5. **åŠæ—¶æœ‰æ•ˆ**: åœ¨é—®é¢˜ä¸¥é‡å‰å‘Šè­¦

**SREå››å¤§é»„é‡‘ä¿¡å·**:

| ä¿¡å· | æŒ‡æ ‡ç¤ºä¾‹ | å‘Šè­¦é˜ˆå€¼ |
|-----|---------|---------|
| **å»¶è¿Ÿ** | `http_request_duration_seconds` | P99 > 1s |
| **æµé‡** | `http_requests_total` | QPSä¸‹é™50% |
| **é”™è¯¯** | `http_requests_total{status=~"5.."}` | é”™è¯¯ç‡ > 5% |
| **é¥±å’Œåº¦** | `node_cpu_seconds_total` | CPU > 90% |

### 4.2 å‘Šè­¦æ¨¡æ¿

**å‘Šè­¦æ ‡é¢˜æ¨¡æ¿**:

```yaml
annotations:
  summary: |
    [{{ $labels.severity }}] {{ $labels.alertname }} on {{ $labels.instance }}
  description: |
    {{ $labels.alertname }} è§¦å‘
    
    é›†ç¾¤: {{ $labels.cluster }}
    å‘½åç©ºé—´: {{ $labels.namespace }}
    å®ä¾‹: {{ $labels.instance }}
    
    å½“å‰å€¼: {{ $value }}
    
    Runbook: https://wiki.example.com/runbooks/{{ $labels.alertname }}
```

### 4.3 Runbookç¼–å†™

**å‘Šè­¦å¤„ç†æ‰‹å†Œ**:

```markdown
# HighCPUUsageå‘Šè­¦å¤„ç†

## ä¸¥é‡ç¨‹åº¦
Warning

## å‘Šè­¦å«ä¹‰
èŠ‚ç‚¹CPUä½¿ç”¨ç‡æŒç»­è¶…è¿‡90%

## å½±å“
å¯èƒ½å¯¼è‡´åº”ç”¨å“åº”å˜æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ

## æ’æŸ¥æ­¥éª¤
1. æŸ¥çœ‹topå‘½ä»¤ç¡®è®¤é«˜CPUè¿›ç¨‹
    ```bash
    ssh {{ $labels.instance }}
    top -o %CPU
    ```

2. æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸è¿›ç¨‹

    ```bash
    ps aux | sort -nrk 3,3 | head -10
    ```

3. æŸ¥çœ‹Kubernetes Podèµ„æºä½¿ç”¨

    ```bash
    kubectl top pod -A
    ```

## è§£å†³æ–¹æ¡ˆ

- çŸ­æœŸ: æ‰©å®¹Podå‰¯æœ¬æ•°æˆ–å¢åŠ èµ„æºé™åˆ¶
- é•¿æœŸ: ä¼˜åŒ–åº”ç”¨ä»£ç æˆ–å‡çº§èŠ‚ç‚¹è§„æ ¼

```

### 4.4 å‘Šè­¦æ”¶æ•›

**æ—¶é—´çª—å£èšåˆ**:

```yaml
group_by: ['alertname', 'cluster', 'service']
group_wait: 30s        # ç­‰å¾…30sèšåˆåŒç»„å‘Šè­¦
group_interval: 5m     # æ¯5åˆ†é’Ÿå‘é€ä¸€æ¬¡èšåˆå‘Šè­¦
repeat_interval: 4h    # 4å°æ—¶åé‡å¤å‘é€
```

**å‘Šè­¦æŠ‘åˆ¶**:

```yaml
inhibit_rules:
# èŠ‚ç‚¹ç¦»çº¿æ—¶æŠ‘åˆ¶è¯¥èŠ‚ç‚¹çš„æ‰€æœ‰å…¶ä»–å‘Šè­¦
- source_match:
    alertname: 'NodeDown'
  target_match_re:
    alertname: '.*'
  equal: ['instance']

# Criticalå‘Šè­¦æŠ‘åˆ¶Warningå‘Šè­¦
- source_match:
    severity: 'critical'
  target_match:
    severity: 'warning'
  equal: ['alertname', 'instance']
```

---

**æ›´æ–°æ—¶é—´**: 2025-10-19  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… å®Œæˆ
