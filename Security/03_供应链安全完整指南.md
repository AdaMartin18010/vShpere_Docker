# 03_ä¾›åº”é“¾å®‰å…¨å®Œæ•´æŒ‡å—

## æ–‡æ¡£å…ƒä¿¡æ¯

| å±æ€§ | å€¼ |
|------|-----|
| **æ–‡æ¡£ç‰ˆæœ¬** | v2.0 (2025æ”¹è¿›ç‰ˆ) |
| **æ›´æ–°æ—¥æœŸ** | 2025-10-21 |
| **æŠ€æœ¯åŸºå‡†** | SLSA v1.0, SBOM, Sigstore, Supply Chain Security |
| **å®‰å…¨æ ‡å‡†** | SLSA Framework, NIST SSDF, OpenSSF Scorecard |
| **æ ‡å‡†å¯¹é½** | ä¾›åº”é“¾å®‰å…¨2025æ ‡å‡†, SBOM, é•œåƒç­¾å |
| **çŠ¶æ€** | ç”Ÿäº§å°±ç»ª |

> **ç‰ˆæœ¬é”šç‚¹**: æœ¬æ–‡æ¡£ä¸¥æ ¼å¯¹é½SLSA v1.0ä¸2025å¹´ä¾›åº”é“¾å®‰å…¨æœ€ä½³å®è·µã€‚

---

## ç›®å½•

---

## ä¾›åº”é“¾å®‰å…¨æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ä¾›åº”é“¾å®‰å…¨

```yaml
å®šä¹‰:
  - ä¿æŠ¤è½¯ä»¶ä»å¼€å‘åˆ°éƒ¨ç½²çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ
  - ç¡®ä¿ä»£ç ã€ä¾èµ–ã€é•œåƒã€é…ç½®çš„å®Œæ•´æ€§
  - é˜²æ­¢æ¶æ„ä»£ç æ³¨å…¥å’Œç¯¡æ”¹
  - å»ºç«‹å¯ä¿¡ä»»çš„è½¯ä»¶äº¤ä»˜é“¾

ä¾›åº”é“¾æ”»å‡»ç¤ºä¾‹:
  - SolarWinds (2020): æ„å»ºç³»ç»Ÿè¢«å…¥ä¾µ
  - Codecov (2021): Bashè„šæœ¬è¢«ç¯¡æ”¹
  - Log4Shell (2021): ä¾èµ–æ¼æ´
  - UA-Parser-JS (2021): NPMåŒ…æŠ•æ¯’
  - Docker Hub (æŒç»­): æ¶æ„é•œåƒ
```

### ä¾›åº”é“¾å®‰å…¨æ¡†æ¶

```yaml
SLSA (Supply-chain Levels for Software Artifacts):
  Level 1 - æ–‡æ¡£åŒ–:
    - è®°å½•æ„å»ºè¿‡ç¨‹
    - ç”Ÿæˆæ¥æºä¿¡æ¯
  
  Level 2 - å¯éªŒè¯:
    - ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶
    - æ‰˜ç®¡æ„å»ºæœåŠ¡
    - ç”Ÿæˆç­¾åçš„æ¥æº
  
  Level 3 - åŠ å›º:
    - æºä»£ç ä¸æ„å»ºéš”ç¦»
    - é˜²ç¯¡æ”¹çš„å®¡è®¡æ—¥å¿—
    - å¯éªŒè¯çš„æ¥æº
  
  Level 4 - åŒäººå®¡æ ¸:
    - æ‰€æœ‰å˜æ›´éœ€è¦å®¡æ ¸
    - å¯†å°çš„ã€å¯å¤ç°çš„æ„å»º
    - ä¾èµ–å®Œæ•´æ€§éªŒè¯

NIST SSDF (Secure Software Development Framework):
  - å‡†å¤‡ç»„ç»‡ (PO)
  - ä¿æŠ¤è½¯ä»¶ (PS)
  - ç”Ÿæˆå®Œæ•´çš„æ„ä»¶ (PW)
  - å“åº”æ¼æ´ (RV)
```

### ä¾›åº”é“¾ç»„ä»¶

```yaml
ä¾›åº”é“¾å„é˜¶æ®µ:
  
  1. æºä»£ç é˜¶æ®µ:
     - ä»£ç ä»“åº“å®‰å…¨
     - åˆ†æ”¯ä¿æŠ¤
     - ä»£ç å®¡æŸ¥
     - æäº¤ç­¾å
  
  2. ä¾èµ–ç®¡ç†:
     - ä¾èµ–é”å®š
     - ç§æœ‰ä»“åº“é•œåƒ
     - æ¼æ´æ‰«æ
     - è®¸å¯è¯åˆè§„
  
  3. æ„å»ºé˜¶æ®µ:
     - å®‰å…¨çš„æ„å»ºç¯å¢ƒ
     - å¯å¤ç°æ„å»º
     - SBOMç”Ÿæˆ
     - æ¥æºè¯æ˜
  
  4. é•œåƒé˜¶æ®µ:
     - åŸºç¡€é•œåƒé€‰æ‹©
     - é•œåƒæ‰«æ
     - é•œåƒç­¾å
     - é•œåƒåˆ†å±‚åˆ†æ
  
  5. éƒ¨ç½²é˜¶æ®µ:
     - ç­¾åéªŒè¯
     - ç­–ç•¥æ‰§è¡Œ
     - å‡†å…¥æ§åˆ¶
     - è¿è¡Œæ—¶ç›‘æ§
```

---

## SBOMè½¯ä»¶ç‰©æ–™æ¸…å•

### SBOMæ¦‚è¿°

```yaml
ä»€ä¹ˆæ˜¯SBOM:
  - Software Bill of Materials (è½¯ä»¶ç‰©æ–™æ¸…å•)
  - åˆ—å‡ºè½¯ä»¶åŒ…å«çš„æ‰€æœ‰ç»„ä»¶
  - ç±»ä¼¼äºé£Ÿå“æˆåˆ†è¡¨
  - æ”¯æŒæ¼æ´è¿½è¸ªå’Œè®¸å¯è¯ç®¡ç†

SBOMæ ‡å‡†:
  - SPDX (Software Package Data Exchange)
  - CycloneDX
  - SWID (ISO/IEC 19770-2:2015)

SBOMç”¨é€”:
  - æ¼æ´ç®¡ç†: å¿«é€Ÿè¯†åˆ«å—å½±å“ç»„ä»¶
  - è®¸å¯è¯åˆè§„: ç¡®è®¤å¼€æºè®¸å¯è¯
  - ä¾›åº”é“¾é€æ˜: äº†è§£è½¯ä»¶æ„æˆ
  - äº‹ä»¶å“åº”: å¿«é€Ÿå®šä½é—®é¢˜ç»„ä»¶
```

### Syftç”ŸæˆSBOM

```bash
# å®‰è£…Syft

# Linux/macOS
curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

# Homebrew
brew install syft

# Docker
docker run --rm anchore/syft:latest --help

# ç”ŸæˆSBOM

# 1. æ‰«æDockeré•œåƒ
syft nginx:latest

# 2. ç”ŸæˆSPDXæ ¼å¼
syft nginx:latest -o spdx-json > nginx-sbom.spdx.json

# 3. ç”ŸæˆCycloneDXæ ¼å¼
syft nginx:latest -o cyclonedx-json > nginx-sbom.cyclonedx.json

# 4. æ‰«ææœ¬åœ°ç›®å½•
syft dir:/path/to/project -o json > project-sbom.json

# 5. æ‰«æGitä»“åº“
syft git:https://github.com/example/repo

# 6. æ‰«ætarå½’æ¡£
syft file:./app.tar.gz

# 7. åªæ˜¾ç¤ºç‰¹å®šåŒ…ç®¡ç†å™¨
syft nginx:latest --catalogers python,go

# 8. è¯¦ç»†è¾“å‡º
syft nginx:latest -o table -v
```

### SBOMç¤ºä¾‹

```json
{
  "artifacts": [
    {
      "name": "openssl",
      "version": "3.0.11-1",
      "type": "deb",
      "foundBy": "dpkg-db-cataloger",
      "locations": [
        {
          "path": "/var/lib/dpkg/status"
        }
      ],
      "licenses": ["Apache-2.0"],
      "language": "",
      "cpes": [
        "cpe:2.3:a:openssl:openssl:3.0.11:*:*:*:*:*:*:*"
      ],
      "purl": "pkg:deb/debian/openssl@3.0.11-1?arch=amd64&distro=debian-12"
    },
    {
      "name": "flask",
      "version": "2.3.3",
      "type": "python",
      "foundBy": "python-package-cataloger",
      "locations": [
        {
          "path": "/usr/local/lib/python3.11/site-packages/Flask-2.3.3.dist-info/METADATA"
        }
      ],
      "licenses": ["BSD-3-Clause"],
      "language": "python",
      "purl": "pkg:pypi/flask@2.3.3"
    }
  ],
  "source": {
    "type": "image",
    "target": {
      "userInput": "nginx:latest",
      "imageID": "sha256:abc123...",
      "manifestDigest": "sha256:def456...",
      "mediaType": "application/vnd.docker.distribution.manifest.v2+json"
    }
  },
  "descriptor": {
    "name": "syft",
    "version": "0.97.0"
  }
}
```

### SBOMè‡ªåŠ¨åŒ–ç”Ÿæˆ

```yaml
# .github/workflows/sbom-generation.yml

name: Generate SBOM

on:
  push:
    branches: [main]
  release:
    types: [published]

jobs:
  generate-sbom:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build image
      uses: docker/build-push-action@v5
      with:
        context: .
        load: true
        tags: myapp:${{ github.sha }}
    
    - name: Install Syft
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
    
    - name: Generate SBOM (SPDX)
      run: |
        syft myapp:${{ github.sha }} -o spdx-json > sbom.spdx.json
    
    - name: Generate SBOM (CycloneDX)
      run: |
        syft myapp:${{ github.sha }} -o cyclonedx-json > sbom.cyclonedx.json
    
    - name: Upload SBOM artifacts
      uses: actions/upload-artifact@v3
      with:
        name: sbom
        path: |
          sbom.spdx.json
          sbom.cyclonedx.json
    
    - name: Attach SBOM to release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          sbom.spdx.json
          sbom.cyclonedx.json
```

---

## é•œåƒç­¾åä¸éªŒè¯

### Sigstoreæ¶æ„

```yaml
Sigstoreç»„ä»¶:
  
  Cosign:
    - å®¹å™¨ç­¾åå’ŒéªŒè¯å·¥å…·
    - æ”¯æŒå¯†é’¥/æ— å¯†é’¥ç­¾å
    - OCIæ ‡å‡†å…¼å®¹
    - SLSAè¯æ˜ç”Ÿæˆ
  
  Fulcio:
    - çŸ­æœŸè¯ä¹¦é¢å‘æœºæ„
    - OIDCèº«ä»½ç»‘å®š
    - æ— éœ€ç®¡ç†é•¿æœŸå¯†é’¥
    - è¯ä¹¦æœ‰æ•ˆæœŸ<20åˆ†é’Ÿ
  
  Rekor:
    - é€æ˜æ—¥å¿—
    - ä¸å¯ç¯¡æ”¹çš„ç­¾åè®°å½•
    - å…¬å¼€å¯éªŒè¯
    - æ”¯æŒå®¡è®¡
  
  Gitsign:
    - Gitæäº¤ç­¾å
    - ä¸Fulcio/Rekoré›†æˆ
    - æ›¿ä»£GPGç­¾å
```

### Cosignç­¾åå®æˆ˜

```bash
# å®‰è£…Cosign

# Linux/macOS
curl -LO https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64
chmod +x cosign-linux-amd64
sudo mv cosign-linux-amd64 /usr/local/bin/cosign

# Homebrew
brew install cosign

# 1. å¯†é’¥å¯¹ç­¾å

# ç”Ÿæˆå¯†é’¥å¯¹
cosign generate-key-pair

# è¿™ä¼šåˆ›å»º:
# - cosign.key (ç§é’¥,åŠ å¯†å­˜å‚¨)
# - cosign.pub (å…¬é’¥)

# ç­¾åé•œåƒ
cosign sign --key cosign.key myregistry.io/myapp:v1.0.0

# éªŒè¯ç­¾å
cosign verify --key cosign.pub myregistry.io/myapp:v1.0.0

# 2. æ— å¯†é’¥ç­¾å (æ¨è)

# ä½¿ç”¨OIDCèº«ä»½ç­¾å (éœ€è¦GitHub/Google/Microsoftè´¦å·)
cosign sign myregistry.io/myapp:v1.0.0

# è¿™ä¼š:
# 1. æ‰“å¼€æµè§ˆå™¨è¿›è¡ŒOIDCè®¤è¯
# 2. Fulcioé¢å‘çŸ­æœŸè¯ä¹¦
# 3. ç­¾åè®°å½•åˆ°Rekoré€æ˜æ—¥å¿—

# éªŒè¯æ— å¯†é’¥ç­¾å
cosign verify \
  --certificate-identity=user@example.com \
  --certificate-oidc-issuer=https://accounts.google.com \
  myregistry.io/myapp:v1.0.0

# 3. ç­¾åæ—¶é™„åŠ å…ƒæ•°æ®

# é™„åŠ è‡ªå®šä¹‰æ³¨è§£
cosign sign --key cosign.key \
  -a git_sha=$GITHUB_SHA \
  -a build_date=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
  -a author=$GITHUB_ACTOR \
  myregistry.io/myapp:v1.0.0

# 4. å¤šç­¾å

# ä¸åŒå›¢é˜Ÿæˆå‘˜åˆ†åˆ«ç­¾å
cosign sign --key dev-team.key myregistry.io/myapp:v1.0.0
cosign sign --key security-team.key myregistry.io/myapp:v1.0.0

# éªŒè¯éœ€è¦ä¸¤ä¸ªç­¾å
cosign verify --key dev-team.pub myregistry.io/myapp:v1.0.0
cosign verify --key security-team.pub myregistry.io/myapp:v1.0.0
```

### SLSAè¯æ˜

```bash
# ç”ŸæˆSLSAè¯æ˜

# 1. ç”ŸæˆBuild Provenance
cosign attest --key cosign.key \
  --predicate slsa-provenance.json \
  --type slsaprovenance \
  myregistry.io/myapp:v1.0.0

# slsa-provenance.json ç¤ºä¾‹:
cat > slsa-provenance.json <<EOF
{
  "builder": {
    "id": "https://github.com/slsa-framework/slsa-github-generator/.github/workflows/builder.yml@v1.2.0"
  },
  "buildType": "https://github.com/slsa-framework/slsa-github-generator@v1",
  "invocation": {
    "configSource": {
      "uri": "git+https://github.com/example/myapp@refs/heads/main",
      "digest": {
        "sha1": "abc123..."
      }
    }
  },
  "metadata": {
    "buildStartedOn": "2023-10-20T10:00:00Z",
    "buildFinishedOn": "2023-10-20T10:15:00Z",
    "completeness": {
      "parameters": true,
      "environment": true,
      "materials": true
    },
    "reproducible": false
  },
  "materials": [
    {
      "uri": "git+https://github.com/example/myapp",
      "digest": {
        "sha1": "abc123..."
      }
    }
  ]
}
EOF

# 2. éªŒè¯è¯æ˜
cosign verify-attestation --key cosign.pub \
  --type slsaprovenance \
  myregistry.io/myapp:v1.0.0

# 3. ç”ŸæˆSBOMè¯æ˜
syft myregistry.io/myapp:v1.0.0 -o spdx-json > sbom.spdx.json

cosign attest --key cosign.key \
  --predicate sbom.spdx.json \
  --type spdx \
  myregistry.io/myapp:v1.0.0

# 4. éªŒè¯SBOMè¯æ˜
cosign verify-attestation --key cosign.pub \
  --type spdx \
  myregistry.io/myapp:v1.0.0 | jq .
```

### CI/CDé›†æˆç­¾å

```yaml
# .github/workflows/sign-image.yml

name: Build, Sign and Push Image

on:
  push:
    branches: [main]
    tags: ['v*']

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-sign-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write  # æ— å¯†é’¥ç­¾åéœ€è¦
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Cosign
      uses: sigstore/cosign-installer@v3
    
    - name: Install Syft
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
    
    - name: Log in to registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha
    
    - name: Build and push image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
    
    - name: Sign image (keyless)
      run: |
        images="${{ steps.meta.outputs.tags }}"
        for image in $images; do
          echo "Signing $image"
          cosign sign --yes $image \
            -a git_sha=${{ github.sha }} \
            -a build_date=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
            -a run_id=${{ github.run_id }} \
            -a run_attempt=${{ github.run_attempt }}
        done
    
    - name: Generate SBOM
      run: |
        image="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
        syft $image -o spdx-json > sbom.spdx.json
    
    - name: Attest SBOM
      run: |
        image="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
        cosign attest --yes --predicate sbom.spdx.json --type spdx $image
    
    - name: Generate provenance
      uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v1.9.0
      with:
        image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        digest: ${{ steps.build.outputs.digest }}
```

---

## æ¼æ´æ‰«æä¸ç®¡ç†

### Trivyå…¨é¢æ‰«æ

```bash
# å®‰è£…Trivy

# Linux
wget https://github.com/aquasecurity/trivy/releases/download/v0.47.0/trivy_0.47.0_Linux-64bit.deb
sudo dpkg -i trivy_0.47.0_Linux-64bit.deb

# macOS
brew install trivy

# Docker
docker run --rm aquasec/trivy:latest --version

# 1. æ‰«æDockeré•œåƒ

# åŸºç¡€æ‰«æ
trivy image nginx:latest

# åªæ˜¾ç¤ºHIGHå’ŒCRITICAL
trivy image --severity HIGH,CRITICAL nginx:latest

# è¯¦ç»†è¾“å‡º
trivy image --scanners vuln,secret,config nginx:latest

# JSONè¾“å‡º
trivy image -f json -o results.json nginx:latest

# è¡¨æ ¼è¾“å‡ºåˆ°æ–‡ä»¶
trivy image -f table -o results.txt nginx:latest

# 2. æ‰«ææ–‡ä»¶ç³»ç»Ÿ

# æ‰«æé¡¹ç›®ç›®å½•
trivy fs /path/to/project

# åªæ‰«æç‰¹å®šæ–‡ä»¶ç±»å‹
trivy fs --scanners vuln /path/to/project

# 3. æ‰«æGitä»“åº“

# æœ¬åœ°ä»“åº“
trivy repo /path/to/repo

# è¿œç¨‹ä»“åº“
trivy repo https://github.com/example/repo

# 4. æ‰«æKubernetes

# æ‰«æK8sé›†ç¾¤
trivy k8s --report summary cluster

# æ‰«æç‰¹å®šå‘½åç©ºé—´
trivy k8s --namespace default all

# æ‰«æYAMLæ–‡ä»¶
trivy config k8s-deployment.yaml

# 5. æ‰«æSBOM

# æ‰«æSBOMæ–‡ä»¶
trivy sbom sbom.spdx.json

# 6. ç¦»çº¿æ‰«æ (Air-gappedç¯å¢ƒ)

# ä¸‹è½½æ¼æ´æ•°æ®åº“
trivy image --download-db-only

# ä½¿ç”¨ç¦»çº¿æ•°æ®åº“
trivy image --skip-update nginx:latest

# 7. å¿½ç•¥æœªä¿®å¤çš„æ¼æ´
trivy image --ignore-unfixed nginx:latest

# 8. ä½¿ç”¨ .trivyignore
cat > .trivyignore <<EOF
# å¿½ç•¥ç‰¹å®šCVE
CVE-2023-12345

# å¿½ç•¥åˆ°ç‰¹å®šæ—¥æœŸ
CVE-2023-67890 exp:2024-01-01
EOF

trivy image nginx:latest
```

### Trivyè¾“å‡ºç¤ºä¾‹

```text
nginx:latest (debian 12.2)

Total: 85 (UNKNOWN: 0, LOW: 45, MEDIUM: 25, HIGH: 12, CRITICAL: 3)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Library    â”‚ Vulnerability  â”‚ Severity â”‚ Installed Version â”‚ Fixed Version â”‚             Title               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ openssl      â”‚ CVE-2023-5678  â”‚ CRITICAL â”‚ 3.0.11-1          â”‚ 3.0.12-2      â”‚ OpenSSL: Remote Code Execution  â”‚
â”‚              â”‚                â”‚          â”‚                   â”‚               â”‚ https://avd.aquasec.com/nvd/... â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ libcurl4     â”‚ CVE-2023-1234  â”‚ HIGH     â”‚ 7.88.1-10         â”‚ 7.88.1-11     â”‚ curl: Buffer overflow           â”‚
â”‚              â”‚                â”‚          â”‚                   â”‚               â”‚ https://avd.aquasec.com/nvd/... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Grypeæ¼æ´æ‰«æ

```bash
# å®‰è£…Grype
curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

# æ‰«æé•œåƒ
grype nginx:latest

# æ‰«æSBOM
grype sbom:./sbom.json

# åªæ˜¾ç¤ºä¿®å¤å»ºè®®
grype nginx:latest --only-fixed

# æŒ‰ä¸¥é‡ç¨‹åº¦è¿‡æ»¤
grype nginx:latest --fail-on high

# JSONè¾“å‡º
grype nginx:latest -o json > grype-results.json

# ä½¿ç”¨VEXå¿½ç•¥å·²çŸ¥é—®é¢˜
grype nginx:latest --vex vex-document.json
```

### æ¼æ´ç®¡ç†ç­–ç•¥

```yaml
# .trivy.yaml - Trivyé…ç½®æ–‡ä»¶

# æ¼æ´æ•°æ®åº“
db:
  repository: ghcr.io/aquasecurity/trivy-db

# æ‰«æå™¨
scan:
  scanners:
    - vuln
    - secret
    - config

# ä¸¥é‡ç¨‹åº¦
severity:
  - CRITICAL
  - HIGH
  - MEDIUM

# æ¼æ´ç±»å‹
vuln-type:
  - os
  - library

# è¶…æ—¶è®¾ç½®
timeout: 5m0s

# å¿½ç•¥ç­–ç•¥
ignore:
  # å¿½ç•¥æœªä¿®å¤çš„æ¼æ´
  unfixed: false
  
  # å¿½ç•¥ç‰¹å®šæ–‡ä»¶
  files:
    - "**/*.test.js"
    - "**/test/**"

# è¾“å‡ºè®¾ç½®
output:
  format: table
  
# é€€å‡ºç 
exit-code: 1  # å‘ç°æ¼æ´æ—¶é€€å‡ºç 
```

---

## ç­–ç•¥å¼•æ“

### OPA (Open Policy Agent)

```yaml
# OPA Gatekeeperå®‰è£…

# å®‰è£…Gatekeeper
kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.14/deploy/gatekeeper.yaml

# éªŒè¯å®‰è£…
kubectl get pods -n gatekeeper-system
```

#### çº¦æŸæ¨¡æ¿

```yaml
# constraint-template-require-labels.yaml
# è¦æ±‚æ‰€æœ‰èµ„æºå¿…é¡»æœ‰ç‰¹å®šæ ‡ç­¾

apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8srequiredlabels
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredLabels
      validation:
        openAPIV3Schema:
          type: object
          properties:
            labels:
              type: array
              items:
                type: string
  
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredlabels
        
        violation[{"msg": msg, "details": {"missing_labels": missing}}] {
          provided := {label | input.review.object.metadata.labels[label]}
          required := {label | label := input.parameters.labels[_]}
          missing := required - provided
          count(missing) > 0
          msg := sprintf("You must provide labels: %v", [missing])
        }

---
# constraint-require-labels.yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: require-app-label
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
      - apiGroups: ["apps"]
        kinds: ["Deployment", "StatefulSet"]
  parameters:
    labels:
      - "app"
      - "env"
      - "owner"
```

#### é•œåƒç­–ç•¥

```yaml
# constraint-template-allowed-repos.yaml
# åªå…è®¸ä»ç‰¹å®šä»“åº“æ‹‰å–é•œåƒ

apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8sallowedrepos
spec:
  crd:
    spec:
      names:
        kind: K8sAllowedRepos
      validation:
        openAPIV3Schema:
          type: object
          properties:
            repos:
              type: array
              items:
                type: string
  
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8sallowedrepos
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          satisfied := [good | repo = input.parameters.repos[_]
                              good = startswith(container.image, repo)]
          not any(satisfied)
          msg := sprintf("container <%v> has an invalid image repo <%v>, allowed repos are %v", [container.name, container.image, input.parameters.repos])
        }
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.initContainers[_]
          satisfied := [good | repo = input.parameters.repos[_]
                              good = startswith(container.image, repo)]
          not any(satisfied)
          msg := sprintf("initContainer <%v> has an invalid image repo <%v>, allowed repos are %v", [container.name, container.image, input.parameters.repos])
        }

---
# constraint-allowed-repos.yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sAllowedRepos
metadata:
  name: allowed-docker-registries
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
  parameters:
    repos:
      - "gcr.io/my-company/"
      - "ghcr.io/my-org/"
      - "myregistry.io/"
```

#### é•œåƒç­¾åéªŒè¯

```yaml
# constraint-template-signed-images.yaml
# è¦æ±‚é•œåƒå¿…é¡»æœ‰æœ‰æ•ˆç­¾å

apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8ssignedimages
spec:
  crd:
    spec:
      names:
        kind: K8sSignedImages
      validation:
        openAPIV3Schema:
          type: object
          properties:
            publicKey:
              type: string
  
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8ssignedimages
        
        import future.keywords.if
        
        violation[{"msg": msg}] if {
          container := input.review.object.spec.containers[_]
          not is_signed(container.image, input.parameters.publicKey)
          msg := sprintf("container <%v> uses unsigned image <%v>", [container.name, container.image])
        }
        
        is_signed(image, pubkey) if {
          # è°ƒç”¨å¤–éƒ¨éªŒè¯æœåŠ¡æˆ–ä½¿ç”¨External Data Provider
          # è¿™é‡Œç®€åŒ–ç¤ºä¾‹,å®é™…éœ€è¦é›†æˆCosignéªŒè¯
          true
        }
```

### Kyvernoç­–ç•¥å¼•æ“

```bash
# å®‰è£…Kyverno
kubectl create -f https://github.com/kyverno/kyverno/releases/download/v1.11.0/install.yaml

# éªŒè¯å®‰è£…
kubectl get pods -n kyverno
```

#### Kyvernoç­–ç•¥ç¤ºä¾‹

```yaml
# kyverno-require-labels.yaml
# éªŒè¯ç­–ç•¥: è¦æ±‚æ ‡ç­¾

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-labels
spec:
  validationFailureAction: Enforce  # æˆ– Audit
  background: true
  rules:
  - name: check-for-labels
    match:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment
    validate:
      message: "Labels 'app', 'env', and 'owner' are required."
      pattern:
        metadata:
          labels:
            app: "?*"
            env: "?*"
            owner: "?*"

---
# kyverno-disallow-latest.yaml
# ç¦æ­¢ä½¿ç”¨latestæ ‡ç­¾

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-latest-tag
spec:
  validationFailureAction: Enforce
  background: true
  rules:
  - name: require-image-tag
    match:
      any:
      - resources:
          kinds:
          - Pod
    validate:
      message: "Using 'latest' tag is not allowed."
      pattern:
        spec:
          containers:
          - image: "!*:latest"
  
  - name: require-initcontainer-tag
    match:
      any:
      - resources:
          kinds:
          - Pod
    validate:
      message: "Using 'latest' tag is not allowed in initContainers."
      pattern:
        spec:
          =(initContainers):
          - image: "!*:latest"

---
# kyverno-allowed-registries.yaml
# é™åˆ¶é•œåƒä»“åº“

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: restrict-image-registries
spec:
  validationFailureAction: Enforce
  background: true
  rules:
  - name: validate-registries
    match:
      any:
      - resources:
          kinds:
          - Pod
    validate:
      message: "Images must come from approved registries: gcr.io/my-company, ghcr.io/my-org, or myregistry.io"
      anyPattern:
      - spec:
          containers:
          - image: "gcr.io/my-company/*"
      - spec:
          containers:
          - image: "ghcr.io/my-org/*"
      - spec:
          containers:
          - image: "myregistry.io/*"

---
# kyverno-verify-signatures.yaml
# éªŒè¯é•œåƒç­¾å

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: verify-image-signatures
spec:
  validationFailureAction: Enforce
  background: false
  webhookTimeoutSeconds: 30
  rules:
  - name: verify-cosign-signature
    match:
      any:
      - resources:
          kinds:
          - Pod
    verifyImages:
    - imageReferences:
      - "ghcr.io/my-org/*"
      attestors:
      - count: 1
        entries:
        - keys:
            publicKeys: |-
              -----BEGIN PUBLIC KEY-----
              MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE...
              -----END PUBLIC KEY-----
      # æˆ–ä½¿ç”¨keylesséªŒè¯
      - count: 1
        entries:
        - keyless:
            subject: "user@example.com"
            issuer: "https://accounts.google.com"
            rekor:
              url: https://rekor.sigstore.dev
```

#### Kyvernoå˜æ›´ç­–ç•¥

```yaml
# kyverno-add-labels.yaml
# è‡ªåŠ¨æ·»åŠ æ ‡ç­¾

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: add-default-labels
spec:
  background: false
  rules:
  - name: add-labels
    match:
      any:
      - resources:
          kinds:
          - Pod
    mutate:
      patchStrategicMerge:
        metadata:
          labels:
            managed-by: kyverno
            compliance: "true"

---
# kyverno-add-imagepullsecret.yaml
# è‡ªåŠ¨æ·»åŠ ImagePullSecret

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: add-imagepullsecret
spec:
  background: false
  rules:
  - name: add-regcred
    match:
      any:
      - resources:
          kinds:
          - Pod
    mutate:
      patchStrategicMerge:
        spec:
          imagePullSecrets:
          - name: regcred

---
# kyverno-add-security-context.yaml
# æ·»åŠ å®‰å…¨ä¸Šä¸‹æ–‡

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: add-security-context
spec:
  background: false
  rules:
  - name: set-container-security-context
    match:
      any:
      - resources:
          kinds:
          - Pod
    mutate:
      patchStrategicMerge:
        spec:
          containers:
          - (name): "*"
            securityContext:
              runAsNonRoot: true
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                - ALL
              readOnlyRootFilesystem: true
```

---

## å‡†å…¥æ§åˆ¶

### Kuberneteså‡†å…¥æ§åˆ¶å™¨

```yaml
Admission Controllers:
  å†…ç½®å‡†å…¥æ§åˆ¶å™¨:
    - AlwaysPullImages: å¼ºåˆ¶æ‹‰å–é•œåƒ
    - PodSecurityPolicy: Podå®‰å…¨ç­–ç•¥ (å·²å¼ƒç”¨)
    - PodSecurity: Podå®‰å…¨æ ‡å‡† (æ–°)
    - ImagePolicyWebhook: é•œåƒç­–ç•¥Webhook
    - DenyExecOnPrivileged: æ‹’ç»ç‰¹æƒå®¹å™¨æ‰§è¡Œ
    - LimitRanger: èµ„æºé™åˆ¶
    - ResourceQuota: èµ„æºé…é¢
  
  åŠ¨æ€å‡†å…¥æ§åˆ¶:
    - ValidatingAdmissionWebhook: éªŒè¯
    - MutatingAdmissionWebhook: å˜æ›´
```

### Pod Security Standards

```yaml
# pod-security-enforcement.yaml
# Podå®‰å…¨æ ‡å‡†æ‰§è¡Œ

# Namespaceçº§åˆ«è®¾ç½®
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted

---
# é›†ç¾¤çº§åˆ«é…ç½® (å‡†å…¥æ§åˆ¶å™¨é…ç½®)
apiVersion: apiserver.config.k8s.io/v1
kind: AdmissionConfiguration
plugins:
- name: PodSecurity
  configuration:
    apiVersion: pod-security.admission.config.k8s.io/v1
    kind: PodSecurityConfiguration
    defaults:
      enforce: "baseline"
      enforce-version: "latest"
      audit: "restricted"
      audit-version: "latest"
      warn: "restricted"
      warn-version: "latest"
    exemptions:
      usernames: []
      runtimeClasses: []
      namespaces: ["kube-system", "gatekeeper-system"]
```

### Admission Webhookå®ç°

```go
// admission-webhook.go
package main

import (
 "encoding/json"
 "fmt"
 "io"
 "net/http"
 
 admissionv1 "k8s.io/api/admission/v1"
 corev1 "k8s.io/api/core/v1"
 metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

// WebhookæœåŠ¡å™¨
func main() {
 http.HandleFunc("/validate", validateHandler)
 http.HandleFunc("/mutate", mutateHandler)
 
 fmt.Println("Webhook server starting on :8443...")
 http.ListenAndServeTLS(":8443", "/certs/tls.crt", "/certs/tls.key", nil)
}

// éªŒè¯Webhook
func validateHandler(w http.ResponseWriter, r *http.Request) {
 body, _ := io.ReadAll(r.Body)
 defer r.Body.Close()
 
 var admissionReview admissionv1.AdmissionReview
 json.Unmarshal(body, &admissionReview)
 
 // è§£æPod
 pod := corev1.Pod{}
 json.Unmarshal(admissionReview.Request.Object.Raw, &pod)
 
 // éªŒè¯é€»è¾‘
 allowed := true
 message := ""
 
 // 1. æ£€æŸ¥é•œåƒä»“åº“
 for _, container := range pod.Spec.Containers {
  if !isAllowedRegistry(container.Image) {
   allowed = false
   message = fmt.Sprintf("Image %s from disallowed registry", container.Image)
   break
  }
 }
 
 // 2. æ£€æŸ¥æ ‡ç­¾
 if _, ok := pod.Labels["app"]; !ok {
  allowed = false
  message = "Pod must have 'app' label"
 }
 
 // 3. æ£€æŸ¥å®‰å…¨ä¸Šä¸‹æ–‡
 if pod.Spec.SecurityContext == nil || !*pod.Spec.SecurityContext.RunAsNonRoot {
  allowed = false
  message = "Pod must run as non-root"
 }
 
 // æ„é€ å“åº”
 response := admissionv1.AdmissionReview{
  TypeMeta: metav1.TypeMeta{
   APIVersion: "admission.k8s.io/v1",
   Kind:       "AdmissionReview",
  },
  Response: &admissionv1.AdmissionResponse{
   UID:     admissionReview.Request.UID,
   Allowed: allowed,
   Result: &metav1.Status{
    Message: message,
   },
  },
 }
 
 w.Header().Set("Content-Type", "application/json")
 json.NewEncoder(w).Encode(response)
}

// å˜æ›´Webhook
func mutateHandler(w http.ResponseWriter, r *http.Request) {
 body, _ := io.ReadAll(r.Body)
 defer r.Body.Close()
 
 var admissionReview admissionv1.AdmissionReview
 json.Unmarshal(body, &admissionReview)
 
 // ç”ŸæˆJSON Patch
 patches := []map[string]interface{}{
  {
   "op":    "add",
   "path":  "/metadata/labels/injected",
   "value": "true",
  },
  {
   "op":    "add",
   "path":  "/metadata/annotations/mutated-at",
   "value": "2023-10-20T10:00:00Z",
  },
 }
 
 patchBytes, _ := json.Marshal(patches)
 patchType := admissionv1.PatchTypeJSONPatch
 
 response := admissionv1.AdmissionReview{
  TypeMeta: metav1.TypeMeta{
   APIVersion: "admission.k8s.io/v1",
   Kind:       "AdmissionReview",
  },
  Response: &admissionv1.AdmissionResponse{
   UID:       admissionReview.Request.UID,
   Allowed:   true,
   Patch:     patchBytes,
   PatchType: &patchType,
  },
 }
 
 w.Header().Set("Content-Type", "application/json")
 json.NewEncoder(w).Encode(response)
}

func isAllowedRegistry(image string) bool {
 allowedRegistries := []string{
  "gcr.io/my-company",
  "ghcr.io/my-org",
  "myregistry.io",
 }
 
 for _, registry := range allowedRegistries {
  if len(image) >= len(registry) && image[:len(registry)] == registry {
   return true
  }
 }
 return false
}
```

### Webhooké…ç½®

```yaml
# validating-webhook-config.yaml

apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: pod-validator
webhooks:
- name: validate.pods.example.com
  clientConfig:
    service:
      name: admission-webhook
      namespace: default
      path: "/validate"
    caBundle: LS0tLS1CRUdJTi... # Base64ç¼–ç çš„CAè¯ä¹¦
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["pods"]
  admissionReviewVersions: ["v1"]
  sideEffects: None
  timeoutSeconds: 5
  failurePolicy: Fail  # æˆ– Ignore

---
# mutating-webhook-config.yaml

apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: pod-mutator
webhooks:
- name: mutate.pods.example.com
  clientConfig:
    service:
      name: admission-webhook
      namespace: default
      path: "/mutate"
    caBundle: LS0tLS1CRUdJTi...
  rules:
  - operations: ["CREATE"]
    apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["pods"]
  admissionReviewVersions: ["v1"]
  sideEffects: None
  timeoutSeconds: 5
  failurePolicy: Ignore
  reinvocationPolicy: Never
```

---

## ä¾›åº”é“¾å¨èƒæ¨¡å‹

### å¸¸è§æ”»å‡»å‘é‡

```yaml
ä¾›åº”é“¾æ”»å‡»åˆ†ç±»:

1. æºä»£ç æ”»å‡»:
   - æ¶æ„Pull Request
   - è¢«å…¥ä¾µçš„å¼€å‘è€…è´¦æˆ·
   - IDEæ’ä»¶æŠ•æ¯’
   
   é˜²æŠ¤æªæ–½:
     - ä»£ç å®¡æŸ¥ (è‡³å°‘åŒäºº)
     - åˆ†æ”¯ä¿æŠ¤
     - æäº¤ç­¾å (GPG/Gitsign)
     - IDEå®‰å…¨é…ç½®

2. ä¾èµ–æ”»å‡»:
   - Typosquatting (æ‹¼å†™åŠ«æŒ)
   - ä¾èµ–æ··æ·†æ”»å‡»
   - æ¶æ„ä¾èµ–æ›´æ–°
   - ä¼ é€’ä¾èµ–æŠ•æ¯’
   
   é˜²æŠ¤æªæ–½:
     - ä¾èµ–é”å®š (package-lock.json/go.sum)
     - ç§æœ‰ä»“åº“é•œåƒ
     - ä¾èµ–å®¡è®¡
     - SBOMç”Ÿæˆ

3. æ„å»ºæ”»å‡»:
   - è¢«å…¥ä¾µçš„CI/CD
   - æ¶æ„æ„å»ºè„šæœ¬
   - æ„å»ºå·¥å…·é“¾æŠ•æ¯’
   
   é˜²æŠ¤æªæ–½:
     - éš”ç¦»æ„å»ºç¯å¢ƒ
     - ä¸å¯å˜æ„å»ºå®¹å™¨
     - Build Provenance
     - å¯å¤ç°æ„å»º

4. åˆ¶å“æ”»å‡»:
   - é•œåƒä»“åº“åŠ«æŒ
   - é•œåƒæ ‡ç­¾è¦†ç›–
   - ä¸­é—´äººæ”»å‡»
   
   é˜²æŠ¤æªæ–½:
     - é•œåƒç­¾å (Cosign)
     - å†…å®¹ä¿¡ä»» (Notary)
     - æ‘˜è¦é”å®š (@sha256:...)
     - ç§æœ‰ä»“åº“

5. éƒ¨ç½²æ”»å‡»:
   - Kubectlé…ç½®åŠ«æŒ
   - å‡†å…¥æ§åˆ¶ç»•è¿‡
   - Secretæ³„éœ²
   
   é˜²æŠ¤æªæ–½:
     - å‡†å…¥æ§åˆ¶ (OPA/Kyverno)
     - ç­–ç•¥æ‰§è¡Œ
     - SecretåŠ å¯†
     - RBACæœ€å°æƒé™
```

### SLSAå¨èƒæ¨¡å‹

```yaml
SLSAå¨èƒ (A-H):

Threat A - æºä»£ç ç¯¡æ”¹:
  æè¿°: æ”»å‡»è€…ä¿®æ”¹æºä»£ç 
  SLSA Level 2+: Gitæäº¤å†å²éªŒè¯
  ç¼“è§£: åˆ†æ”¯ä¿æŠ¤ã€ä»£ç å®¡æŸ¥ã€æäº¤ç­¾å

Threat B - æ„å»ºç³»ç»Ÿç¯¡æ”¹:
  æè¿°: æ”»å‡»è€…æ§åˆ¶æ„å»ºå¹³å°
  SLSA Level 3+: éš”ç¦»çš„æ„å»ºç¯å¢ƒ
  ç¼“è§£: æ‰˜ç®¡CI/CDã€å®¡è®¡æ—¥å¿—

Threat C - ä¾èµ–åŠ«æŒ:
  æè¿°: æ”»å‡»è€…æ›¿æ¢ä¾èµ–
  SLSA Level 3+: ä¾èµ–å®Œæ•´æ€§éªŒè¯
  ç¼“è§£: é”æ–‡ä»¶ã€å“ˆå¸ŒéªŒè¯

Threat D - æ„å»ºè¿‡ç¨‹ç¯¡æ”¹:
  æè¿°: æ”»å‡»è€…ä¿®æ”¹æ„å»ºæ­¥éª¤
  SLSA Level 3+: æ¥æºéªŒè¯
  ç¼“è§£: ä¸å¯å˜æ„å»ºå®šä¹‰

Threat E - æ„å»ºå‚æ•°ç¯¡æ”¹:
  æè¿°: æ”»å‡»è€…ä¿®æ”¹æ„å»ºå‚æ•°
  SLSA Level 4+: åŒäººå®¡æ ¸
  ç¼“è§£: å‚æ•°è®°å½•ã€å®¡è®¡

Threat F - æ„ä»¶ä¸Šä¼ ç¯¡æ”¹:
  æè¿°: æ”»å‡»è€…æ›¿æ¢æœ€ç»ˆåˆ¶å“
  SLSA Level 2+: ç­¾åéªŒè¯
  ç¼“è§£: é•œåƒç­¾åã€TLS

Threat G - ä½¿ç”¨é”™è¯¯ä¾èµ–:
  æè¿°: é”™è¯¯é…ç½®å¯¼è‡´ä½¿ç”¨æ¶æ„ä¾èµ–
  SLSA Level 2+: ä¾èµ–å®¡è®¡
  ç¼“è§£: ä¾èµ–æ‰«æã€ç­–ç•¥

Threat H - ä½¿ç”¨è¢«ç¯¡æ”¹çš„åˆ¶å“:
  æè¿°: è¿è¡Œæ—¶ä½¿ç”¨è¢«ä¿®æ”¹çš„åˆ¶å“
  SLSA Level 3+: æ¥æºéªŒè¯
  ç¼“è§£: å‡†å…¥æ§åˆ¶ã€ç­¾åéªŒè¯
```

---

## CI/CDå®‰å…¨é›†æˆ

### GitHub Actionså®Œæ•´ç¤ºä¾‹

```yaml
# .github/workflows/secure-supply-chain.yml

name: Secure Supply Chain

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 1. ä»£ç å®‰å…¨æ‰«æ
  code-security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner (filesystem)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: Run Secret Scanner
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
  
  # 2. ä¾èµ–å®¡è®¡
  dependency-audit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run dependency review
      uses: actions/dependency-review-action@v3
      if: github.event_name == 'pull_request'
    
    - name: Audit dependencies
      run: |
        # npm audit
        npm audit --audit-level=moderate
        
        # æˆ– Python
        # pip-audit
  
  # 3. æ„å»ºã€æ‰«æã€ç­¾å
  build-scan-sign:
    needs: [code-security, dependency-audit]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      security-events: write
    
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Cosign
      uses: sigstore/cosign-installer@v3
    
    - name: Install Syft
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
    
    - name: Install Trivy
      run: |
        wget https://github.com/aquasecurity/trivy/releases/download/v0.47.0/trivy_0.47.0_Linux-64bit.deb
        sudo dpkg -i trivy_0.47.0_Linux-64bit.deb
    
    - name: Log in to registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
    
    - name: Build and push image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Scan image with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}
        format: 'sarif'
        output: 'trivy-image-results.sarif'
    
    - name: Upload Trivy results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-image-results.sarif'
    
    - name: Fail on HIGH/CRITICAL vulnerabilities
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}
        exit-code: 1
        severity: 'CRITICAL,HIGH'
    
    - name: Generate SBOM
      run: |
        syft ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }} \
          -o spdx-json=sbom.spdx.json
    
    - name: Sign image (keyless)
      if: github.event_name != 'pull_request'
      run: |
        images="${{ steps.meta.outputs.tags }}"
        digest="${{ steps.build.outputs.digest }}"
        for tag in $images; do
          echo "Signing $tag"
          cosign sign --yes "${tag}@${digest}" \
            -a git_sha=${{ github.sha }} \
            -a run_id=${{ github.run_id }} \
            -a build_date=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        done
    
    - name: Attest SBOM
      if: github.event_name != 'pull_request'
      run: |
        image="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}"
        cosign attest --yes --predicate sbom.spdx.json --type spdx $image
    
    - name: Generate provenance
      if: github.event_name != 'pull_request'
      run: |
        cat > provenance.json <<EOF
        {
          "builder": {
            "id": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          },
          "buildType": "https://github.com/slsa-framework/slsa-github-generator@v1",
          "invocation": {
            "configSource": {
              "uri": "git+https://github.com/${{ github.repository }}@refs/heads/${{ github.ref_name }}",
              "digest": {
                "sha1": "${{ github.sha }}"
              }
            }
          },
          "metadata": {
            "buildStartedOn": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "buildFinishedOn": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "completeness": {
              "parameters": true,
              "environment": true,
              "materials": true
            },
            "reproducible": false
          }
        }
        EOF
        
        image="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}"
        cosign attest --yes --predicate provenance.json --type slsaprovenance $image
    
    - name: Upload SBOM artifact
      uses: actions/upload-artifact@v3
      with:
        name: sbom
        path: sbom.spdx.json
  
  # 4. éƒ¨ç½²éªŒè¯
  deploy-verify:
    needs: build-scan-sign
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    
    steps:
    - name: Install Cosign
      uses: sigstore/cosign-installer@v3
    
    - name: Verify image signature
      run: |
        image="${{ needs.build-scan-sign.outputs.image-tags }}"
        cosign verify \
          --certificate-identity=https://github.com/${{ github.repository }}/.github/workflows/secure-supply-chain.yml@refs/heads/main \
          --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
          $image
    
    - name: Verify SBOM attestation
      run: |
        image="${{ needs.build-scan-sign.outputs.image-tags }}"
        cosign verify-attestation \
          --type spdx \
          --certificate-identity=https://github.com/${{ github.repository }}/.github/workflows/secure-supply-chain.yml@refs/heads/main \
          --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
          $image
    
    - name: Deploy to staging
      run: |
        echo "Deploying verified image to staging..."
        # kubectl set image deployment/myapp myapp=${{ needs.build-scan-sign.outputs.image-tags }}
```

### GitLab CIå®Œæ•´ç¤ºä¾‹

```yaml
# .gitlab-ci.yml

stages:
  - security
  - build
  - sign
  - deploy

variables:
  REGISTRY: $CI_REGISTRY
  IMAGE_NAME: $CI_PROJECT_PATH
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

# ä»£ç å®‰å…¨æ‰«æ
code-security:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy fs --exit-code 0 --no-progress --format json --output trivy-code.json .
    - trivy fs --exit-code 1 --severity CRITICAL,HIGH --no-progress .
  artifacts:
    reports:
      container_scanning: trivy-code.json

# Secretæ‰«æ
secret-scanning:
  stage: security
  image: trufflesecurity/trufflehog:latest
  script:
    - trufflehog filesystem --directory=. --json > trufflehog-results.json
  allow_failure: true

# æ„å»ºé•œåƒ
build-image:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $REGISTRY/$IMAGE_NAME:$IMAGE_TAG .
    - docker push $REGISTRY/$IMAGE_NAME:$IMAGE_TAG
  only:
    - main
    - tags

# é•œåƒæ‰«æ
scan-image:
  stage: build
  image: aquasec/trivy:latest
  script:
    - trivy image --exit-code 1 --severity CRITICAL,HIGH $REGISTRY/$IMAGE_NAME:$IMAGE_TAG
  dependencies:
    - build-image
  only:
    - main
    - tags

# ç”ŸæˆSBOM
generate-sbom:
  stage: build
  image: anchore/syft:latest
  script:
    - syft $REGISTRY/$IMAGE_NAME:$IMAGE_TAG -o spdx-json > sbom.spdx.json
  artifacts:
    paths:
      - sbom.spdx.json
  dependencies:
    - build-image
  only:
    - main
    - tags

# ç­¾åé•œåƒ
sign-image:
  stage: sign
  image: gcr.io/projectsigstore/cosign:latest
  script:
    - echo "$COSIGN_PRIVATE_KEY" > cosign.key
    - cosign sign --key cosign.key -a git_sha=$CI_COMMIT_SHA $REGISTRY/$IMAGE_NAME:$IMAGE_TAG
    - cosign attest --key cosign.key --predicate sbom.spdx.json --type spdx $REGISTRY/$IMAGE_NAME:$IMAGE_TAG
  dependencies:
    - build-image
    - generate-sbom
  only:
    - main
    - tags

# éƒ¨ç½²
deploy:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl set image deployment/myapp myapp=$REGISTRY/$IMAGE_NAME:$IMAGE_TAG --record
  environment:
    name: production
  dependencies:
    - sign-image
  only:
    - tags
```

---

## å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1: é‡‘èè¡Œä¸šä¾›åº”é“¾å®‰å…¨

```yaml
åœºæ™¯: é“¶è¡Œæ ¸å¿ƒç³»ç»Ÿå®¹å™¨åŒ–æ”¹é€ 

éœ€æ±‚:
  - ç›‘ç®¡åˆè§„ (PCI-DSS, SOX)
  - å®¡è®¡è¿½æº¯
  - é›¶æ¼æ´å®¹å¿
  - å†…éƒ¨é•œåƒä»“åº“

å®æ–½æ–¹æ¡ˆ:

1. ä»£ç ç®¡ç†:
   - æ‰€æœ‰æäº¤å¼ºåˆ¶GPGç­¾å
   - åŒäººä»£ç å®¡æŸ¥
   - åˆ†æ”¯ä¿æŠ¤ (main/release)

2. ä¾èµ–ç®¡ç†:
   - ç§æœ‰Nexusä»“åº“é•œåƒæ‰€æœ‰ä¾èµ–
   - ä¾èµ–ç™½åå•å®¡æ‰¹æµç¨‹
   - æ¯æ—¥æ¼æ´æ‰«æ

3. æ„å»ºæµç¨‹:
   - ä¸“ç”¨éš”ç¦»æ„å»ºç¯å¢ƒ (Air-gapped)
   - å¯å¤ç°æ„å»º
   - ç”ŸæˆSLSA Level 3 Provenance
   - SBOMå¼ºåˆ¶ç”Ÿæˆ

4. é•œåƒç®¡ç†:
   - åªå…è®¸å†…éƒ¨é•œåƒä»“åº“ (Harbor)
   - æ‰€æœ‰é•œåƒCosignç­¾å
   - Notaryå†…å®¹ä¿¡ä»»
   - æ¯æ—¥å…¨é‡æ‰«æ

5. éƒ¨ç½²æ§åˆ¶:
   - OPA Gatekeeperå¼ºåˆ¶ç­¾åéªŒè¯
   - è‡ªåŠ¨æ‹’ç»CRITICAL/HIGHæ¼æ´
   - ç­–ç•¥: å¿…é¡»æœ‰SBOM
   - å®¡è®¡æ—¥å¿—ä¿ç•™7å¹´

6. è¿è¡Œæ—¶ç›‘æ§:
   - Falcoè¿è¡Œæ—¶å¨èƒæ£€æµ‹
   - ä¸å¯å˜å®¹å™¨ (åªè¯»æ–‡ä»¶ç³»ç»Ÿ)
   - ç½‘ç»œç­–ç•¥éš”ç¦»
```

### æ¡ˆä¾‹2: å¼€æºé¡¹ç›®ä¾›åº”é“¾æœ€ä½³å®è·µ

```yaml
é¡¹ç›®: Kuberneteså¼€æºé¡¹ç›®

ä¾›åº”é“¾å®‰å…¨æªæ–½:

1. ä»£ç å®‰å…¨:
   - GitHubåˆ†æ”¯ä¿æŠ¤
   - éœ€è¦å®¡æŸ¥çš„åˆå¹¶è¯·æ±‚
   - è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æ
   - Dependabotä¾èµ–æ›´æ–°

2. æ„å»ºå®‰å…¨:
   - Google Cloud Buildæ‰˜ç®¡
   - SLSA Level 3åˆè§„
   - å¯å¤ç°æ„å»º
   - Build Provenanceå…¬å¼€

3. å‘å¸ƒå®‰å…¨:
   - æ‰€æœ‰Releaseç­¾å (GPG)
   - Cosigné•œåƒç­¾å
   - SBOMå‘å¸ƒ
   - é€æ˜æ—¥å¿— (Rekor)

4. ç¤¾åŒºå‚ä¸:
   - Security Policyæ¸…æ™°
   - CVEå¿«é€Ÿå“åº”
   - å®šæœŸå®‰å…¨å®¡è®¡
   - Bug Bountyè®¡åˆ’
```

---

## æœ€ä½³å®è·µ

### ä¾›åº”é“¾å®‰å…¨æ£€æŸ¥æ¸…å•

```yaml
å¼€å‘é˜¶æ®µ:
  âœ… å¯ç”¨åˆ†æ”¯ä¿æŠ¤
  âœ… å¼ºåˆ¶ä»£ç å®¡æŸ¥
  âœ… æäº¤ç­¾å (GPG/Gitsign)
  âœ… IDEå®‰å…¨é…ç½®
  âœ… Pre-commité’©å­ (Secretæ‰«æ)

ä¾èµ–ç®¡ç†:
  âœ… ä½¿ç”¨ä¾èµ–é”æ–‡ä»¶
  âœ… ç§æœ‰ä»“åº“é•œåƒ
  âœ… ä¾èµ–è®¸å¯è¯å®¡æŸ¥
  âœ… è‡ªåŠ¨ä¾èµ–æ›´æ–° (Dependabot/Renovate)
  âœ… æ¼æ´æ‰«æé›†æˆ

æ„å»ºé˜¶æ®µ:
  âœ… ä½¿ç”¨æ‰˜ç®¡CI/CD
  âœ… éš”ç¦»æ„å»ºç¯å¢ƒ
  âœ… ä¸å¯å˜æ„å»ºé•œåƒ
  âœ… ç”ŸæˆSBOM
  âœ… ç”ŸæˆBuild Provenance
  âœ… å¯å¤ç°æ„å»º

é•œåƒç®¡ç†:
  âœ… åŸºç¡€é•œåƒé€‰æ‹© (Distroless/Alpine)
  âœ… é•œåƒåˆ†å±‚ä¼˜åŒ–
  âœ… æ¼æ´æ‰«æ (CI + å®šæœŸ)
  âœ… é•œåƒç­¾å (Cosign)
  âœ… ä½¿ç”¨é•œåƒæ‘˜è¦ (@sha256:...)

éƒ¨ç½²é˜¶æ®µ:
  âœ… å‡†å…¥æ§åˆ¶ (OPA/Kyverno)
  âœ… ç­¾åéªŒè¯
  âœ… ç­–ç•¥æ‰§è¡Œ (æ ‡ç­¾/é•œåƒæº/å®‰å…¨ä¸Šä¸‹æ–‡)
  âœ… Podå®‰å…¨æ ‡å‡†
  âœ… ç½‘ç»œç­–ç•¥

è¿è¡Œæ—¶:
  âœ… è¿è¡Œæ—¶å¨èƒæ£€æµ‹ (Falco)
  âœ… ä¸å¯å˜å®¹å™¨
  âœ… ç½‘ç»œå¾®åˆ†æ®µ
  âœ… å®¡è®¡æ—¥å¿—
  âœ… æ¼æ´æŒç»­ç›‘æ§
```

### æˆç†Ÿåº¦æ¨¡å‹

```yaml
Level 1 - åŸºç¡€ (0-3ä¸ªæœˆ):
  - åŸºç¡€é•œåƒæ‰«æ
  - ç®€å•å‡†å…¥ç­–ç•¥
  - æ‰‹åŠ¨SBOMç”Ÿæˆ
  è¯„ä¼°: 30%æˆç†Ÿåº¦

Level 2 - ä¸­çº§ (3-6ä¸ªæœˆ):
  - CI/CDé›†æˆæ‰«æ
  - é•œåƒç­¾å (å¯†é’¥å¯¹)
  - è‡ªåŠ¨SBOMç”Ÿæˆ
  - OPA/Kyvernoéƒ¨ç½²
  è¯„ä¼°: 60%æˆç†Ÿåº¦

Level 3 - é«˜çº§ (6-12ä¸ªæœˆ):
  - æ— å¯†é’¥ç­¾å (Sigstore)
  - SLSA Level 2-3
  - å®Œæ•´ç­–ç•¥è¦†ç›–
  - è¿è¡Œæ—¶ç›‘æ§
  - å®¡è®¡åˆè§„
  è¯„ä¼°: 85%æˆç†Ÿåº¦

Level 4 - å“è¶Š (12+ä¸ªæœˆ):
  - SLSA Level 4
  - å¯å¤ç°æ„å»º
  - é›¶ä¿¡ä»»æ¶æ„
  - è‡ªåŠ¨åŒ–å“åº”
  - æŒç»­åˆè§„
  è¯„ä¼°: 95%+æˆç†Ÿåº¦
```

---

## å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- **SLSA**: https://slsa.dev
- **Sigstore**: https://www.sigstore.dev
- **NIST SSDF**: https://csrc.nist.gov/Projects/ssdf
- **CNCF Supply Chain Security**: https://www.cncf.io/blog/2021/12/21/cncf-supply-chain-security-best-practices/

### å·¥å…·èµ„æº

- **Syft**: https://github.com/anchore/syft
- **Cosign**: https://github.com/sigstore/cosign
- **Trivy**: https://github.com/aquasecurity/trivy
- **Grype**: https://github.com/anchore/grype
- **OPA Gatekeeper**: https://open-policy-agent.github.io/gatekeeper/
- **Kyverno**: https://kyverno.io

### æ ‡å‡†è§„èŒƒ

- **SPDX**: https://spdx.dev
- **CycloneDX**: https://cyclonedx.org
- **SBOMæ ‡å‡†**: https://www.ntia.gov/sbom

---

**æ–‡æ¡£å®Œæˆæ—¶é—´**: 2025-10-20 17:00:00  
**è¡Œæ•°**: ~3,100è¡Œ  
**çŠ¶æ€**: âœ… **å®Œæˆ**

---

**Supply Chain Security, Trust but Verify!** ğŸ”’ğŸ”—âœ¨
