# äº‘åŸç”Ÿå®¹å™¨åŒ–å®è·µæ¡ˆä¾‹ä¸æœ€ä½³å®è·µï¼ˆ2025ç‰ˆï¼‰

> **æ–‡æ¡£å®šä½**: ç”Ÿäº§çº§å®¹å™¨åŒ–å®è·µã€Kubernetesè½åœ°ç»éªŒã€DevOpsæœ€ä½³å®è·µ  
> **å¯¹æ ‡æ°´å¹³**: CNCFæ¡ˆä¾‹ç ”ç©¶ + è¡Œä¸šæœ€ä½³å®è·µ + ä¼ä¸šçº§å®æˆ˜ç»éªŒ  
> **æ›´æ–°æ—¥æœŸ**: 2025å¹´10æœˆ20æ—¥

---

## ğŸ“‹ ç›®å½•

- [äº‘åŸç”Ÿå®¹å™¨åŒ–å®è·µæ¡ˆä¾‹ä¸æœ€ä½³å®è·µï¼ˆ2025ç‰ˆï¼‰](#äº‘åŸç”Ÿå®¹å™¨åŒ–å®è·µæ¡ˆä¾‹ä¸æœ€ä½³å®è·µ2025ç‰ˆ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ç¬¬ä¸€éƒ¨åˆ†ï¼šå®¹å™¨åŒ–è¿ç§»å®è·µ](#ç¬¬ä¸€éƒ¨åˆ†å®¹å™¨åŒ–è¿ç§»å®è·µ)
    - [1.1 å¤§å‹ç”µå•†å¹³å°å®¹å™¨åŒ–è¿ç§»æ¡ˆä¾‹](#11-å¤§å‹ç”µå•†å¹³å°å®¹å™¨åŒ–è¿ç§»æ¡ˆä¾‹)
      - [1.1.1 è¿ç§»å‰ç°çŠ¶](#111-è¿ç§»å‰ç°çŠ¶)
      - [1.1.2 è¿ç§»ç­–ç•¥](#112-è¿ç§»ç­–ç•¥)
      - [1.1.3 æŠ€æœ¯æ¶æ„](#113-æŠ€æœ¯æ¶æ„)
      - [1.1.4 å®æ–½è¿‡ç¨‹](#114-å®æ–½è¿‡ç¨‹)
      - [1.1.5 é¡¹ç›®æˆæœ](#115-é¡¹ç›®æˆæœ)
  - [ç¬¬äºŒéƒ¨åˆ†ï¼šKubernetesç”Ÿäº§å®è·µ](#ç¬¬äºŒéƒ¨åˆ†kubernetesç”Ÿäº§å®è·µ)
    - [2.1 ç”Ÿäº§çº§K8sé›†ç¾¤æœ€ä½³é…ç½®](#21-ç”Ÿäº§çº§k8sé›†ç¾¤æœ€ä½³é…ç½®)
      - [2.1.1 Control Planeé«˜å¯ç”¨](#211-control-planeé«˜å¯ç”¨)
      - [2.1.2 èŠ‚ç‚¹é…ç½®è§„èŒƒ](#212-èŠ‚ç‚¹é…ç½®è§„èŒƒ)
    - [2.2 èµ„æºç®¡ç†æœ€ä½³å®è·µ](#22-èµ„æºç®¡ç†æœ€ä½³å®è·µ)
      - [2.2.1 Resource Quota](#221-resource-quota)
      - [2.2.2 LimitRange](#222-limitrange)
    - [2.3 å­˜å‚¨ç®¡ç†å®è·µ](#23-å­˜å‚¨ç®¡ç†å®è·µ)
      - [2.3.1 StorageClassé…ç½®](#231-storageclassé…ç½®)
  - [ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¾®æœåŠ¡æ¶æ„å®è·µ](#ç¬¬ä¸‰éƒ¨åˆ†å¾®æœåŠ¡æ¶æ„å®è·µ)
    - [3.1 Service Meshå®è·µï¼ˆIstioï¼‰](#31-service-meshå®è·µistio)
      - [3.1.1 æµé‡ç®¡ç†](#311-æµé‡ç®¡ç†)
      - [3.1.2 æ–­è·¯å™¨ä¸é‡è¯•](#312-æ–­è·¯å™¨ä¸é‡è¯•)
  - [ç¬¬å››éƒ¨åˆ†ï¼šCI/CDæœ€ä½³å®è·µ](#ç¬¬å››éƒ¨åˆ†cicdæœ€ä½³å®è·µ)
    - [4.1 GitOpså·¥ä½œæµï¼ˆArgoCDï¼‰](#41-gitopså·¥ä½œæµargocd)
    - [4.2 å¤šç¯å¢ƒç®¡ç†ï¼ˆKustomizeï¼‰](#42-å¤šç¯å¢ƒç®¡ç†kustomize)
  - [ç¬¬äº”éƒ¨åˆ†ï¼šå¯è§‚æµ‹æ€§æœ€ä½³å®è·µ](#ç¬¬äº”éƒ¨åˆ†å¯è§‚æµ‹æ€§æœ€ä½³å®è·µ)
    - [5.1 ç»Ÿä¸€ç›‘æ§æ ˆ](#51-ç»Ÿä¸€ç›‘æ§æ ˆ)
    - [5.2 å‘Šè­¦è§„åˆ™](#52-å‘Šè­¦è§„åˆ™)
  - [ç¬¬å…­éƒ¨åˆ†ï¼šå®‰å…¨åŠ å›ºå®è·µ](#ç¬¬å…­éƒ¨åˆ†å®‰å…¨åŠ å›ºå®è·µ)
    - [6.1 Pod Security Standardså®æ–½](#61-pod-security-standardså®æ–½)
    - [6.2 Network Policy](#62-network-policy)
  - [ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæˆæœ¬ä¼˜åŒ–å®è·µ](#ç¬¬ä¸ƒéƒ¨åˆ†æˆæœ¬ä¼˜åŒ–å®è·µ)
    - [7.1 èµ„æºrightsizing](#71-èµ„æºrightsizing)
    - [7.2 Spotå®ä¾‹ä½¿ç”¨](#72-spotå®ä¾‹ä½¿ç”¨)
  - [ç¬¬å…«éƒ¨åˆ†ï¼šæ•…éšœæ¡ˆä¾‹ä¸è§£å†³æ–¹æ¡ˆ](#ç¬¬å…«éƒ¨åˆ†æ•…éšœæ¡ˆä¾‹ä¸è§£å†³æ–¹æ¡ˆ)
    - [8.1 å…¸å‹æ•…éšœæ¡ˆä¾‹](#81-å…¸å‹æ•…éšœæ¡ˆä¾‹)
      - [æ¡ˆä¾‹1: etcdæ€§èƒ½é—®é¢˜](#æ¡ˆä¾‹1-etcdæ€§èƒ½é—®é¢˜)
      - [æ¡ˆä¾‹2: OOM Killé¢‘ç¹](#æ¡ˆä¾‹2-oom-killé¢‘ç¹)
  - [æ€»ç»“ä¸å»ºè®®](#æ€»ç»“ä¸å»ºè®®)
    - [å…³é”®æˆåŠŸå› ç´ ](#å…³é”®æˆåŠŸå› ç´ )
    - [å¸¸è§é™·é˜±](#å¸¸è§é™·é˜±)
  - [å‚è€ƒæ–‡çŒ®](#å‚è€ƒæ–‡çŒ®)

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šå®¹å™¨åŒ–è¿ç§»å®è·µ

### 1.1 å¤§å‹ç”µå•†å¹³å°å®¹å™¨åŒ–è¿ç§»æ¡ˆä¾‹

**ä¼ä¸šèƒŒæ™¯**:

- **è¡Œä¸š**: ç”µå•†é›¶å”®
- **è§„æ¨¡**: æ—¥æ´»1000ä¸‡+ç”¨æˆ·
- **åº”ç”¨**: 300+å¾®æœåŠ¡ï¼Œ1000+å®ä¾‹
- **æŠ€æœ¯æ ˆ**: Java Spring Boot, Node.js, Python

#### 1.1.1 è¿ç§»å‰ç°çŠ¶

**ç—›ç‚¹åˆ†æ**:

| ç»´åº¦ | é—®é¢˜ | å½±å“ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| **éƒ¨ç½²æ•ˆç‡** | æ‰‹åŠ¨éƒ¨ç½²ï¼Œè€—æ—¶2-4å°æ—¶ | å‘å¸ƒé¢‘ç‡ä½ | â­â­â­â­â­ |
| **èµ„æºåˆ©ç”¨** | è™šæ‹Ÿæœºåˆ©ç”¨ç‡<30% | æˆæœ¬é«˜ | â­â­â­â­ |
| **æ‰©å®¹é€Ÿåº¦** | æ–°å¢å®ä¾‹éœ€30åˆ†é’Ÿ+ | åº”å¯¹æµé‡å›°éš¾ | â­â­â­â­â­ |
| **ç¯å¢ƒä¸€è‡´æ€§** | å¼€å‘/æµ‹è¯•/ç”Ÿäº§å·®å¼‚å¤§ | æ•…éšœç‡é«˜ | â­â­â­â­ |
| **ç›‘æ§å‘Šè­¦** | åˆ†æ•£å¼ç›‘æ§ï¼Œä¸å®Œæ•´ | é—®é¢˜å®šä½æ…¢ | â­â­â­ |

#### 1.1.2 è¿ç§»ç­–ç•¥

**åˆ†é˜¶æ®µè¿ç§»è·¯çº¿å›¾**:

```mermaid
graph LR
    A[ç¬¬ä¸€é˜¶æ®µ<br/>3ä¸ªæœˆ] --> A1[æŠ€æœ¯é€‰å‹]
    A --> A2[POCéªŒè¯]
    A --> A3[å›¢é˜ŸåŸ¹è®­]
    
    B[ç¬¬äºŒé˜¶æ®µ<br/>6ä¸ªæœˆ] --> B1[åŸºç¡€è®¾æ–½å»ºè®¾]
    B --> B2[CI/CDæ­å»º]
    B --> B3[ç›‘æ§å‘Šè­¦]
    
    C[ç¬¬ä¸‰é˜¶æ®µ<br/>9ä¸ªæœˆ] --> C1[æ— çŠ¶æ€åº”ç”¨è¿ç§»<br/>80%åº”ç”¨]
    C --> C2[æ•°æ®åº“å®¹å™¨åŒ–<br/>20%åº”ç”¨]
    C --> C3[æœ‰çŠ¶æ€åº”ç”¨è¿ç§»]
    
    D[ç¬¬å››é˜¶æ®µ<br/>3ä¸ªæœˆ] --> D1[å…¨é‡åˆ‡æ¢]
    D --> D2[ä¼˜åŒ–è°ƒä¼˜]
    D --> D3[è€ç³»ç»Ÿä¸‹çº¿]
    
    A --> B
    B --> C
    C --> D
    
    style A fill:#9f9,stroke:#333,stroke-width:2px
    style C fill:#9cf,stroke:#333,stroke-width:2px
    style D fill:#f99,stroke:#333,stroke-width:2px
```

#### 1.1.3 æŠ€æœ¯æ¶æ„

**ç›®æ ‡æ¶æ„**:

| å±‚æ¬¡ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ | å¤‡æ³¨ |
|------|---------|------|------|
| **åº”ç”¨å±‚** | Spring Cloudå¾®æœåŠ¡ | 300+å¾®æœåŠ¡ | æ‹†åˆ†å |
| **ç¼–æ’å±‚** | Kubernetes 1.30 | 3é›†ç¾¤ (dev/staging/prod) | è‡ªå»º |
| **å®¹å™¨è¿è¡Œæ—¶** | containerd | æ›¿ä»£Docker | æ€§èƒ½æ›´å¥½ |
| **ç½‘ç»œ** | Cilium | eBPFåŠ é€Ÿ | é«˜æ€§èƒ½ |
| **å­˜å‚¨** | Longhorn | äº‘åŸç”Ÿå­˜å‚¨ | åˆ†å¸ƒå¼ |
| **Service Mesh** | Istio | mTLS + æµé‡ç®¡ç† | æ¸è¿›å¼ |
| **ç›‘æ§** | Prometheus + Grafana | ç»Ÿä¸€å¯è§‚æµ‹ | CNCFæ ‡å‡† |
| **æ—¥å¿—** | Loki | ä½æˆæœ¬æ—¥å¿— | é›†æˆGrafana |
| **è¿½è¸ª** | Tempo | åˆ†å¸ƒå¼è¿½è¸ª | OpenTelemetry |
| **CI/CD** | GitLab CI + ArgoCD | GitOps | è‡ªåŠ¨åŒ– |

#### 1.1.4 å®æ–½è¿‡ç¨‹

**Phase 1: POCéªŒè¯ (3ä¸ªæœˆ)**:

**ç›®æ ‡**: éªŒè¯æŠ€æœ¯å¯è¡Œæ€§

**æ­¥éª¤**:

1. **æŠ€æœ¯é€‰å‹**:

   ```yaml
   # è¯„ä¼°çŸ©é˜µ
   è¯„ä¼°ç»´åº¦:
     - æˆç†Ÿåº¦: Kubernetes (âœ…)
     - ç¤¾åŒºæ”¯æŒ: CNCFç”Ÿæ€ (âœ…)
     - å›¢é˜ŸæŠ€èƒ½: Java/Spring Cloud (âœ…)
     - æˆæœ¬: å¼€æºä¼˜å…ˆ (âœ…)
   ```

2. **POCç¯å¢ƒæ­å»º**:
   - 3èŠ‚ç‚¹K8sé›†ç¾¤ (devç¯å¢ƒ)
   - è¿ç§»3ä¸ªå…¸å‹åº”ç”¨:
     - æ— çŠ¶æ€WebæœåŠ¡
     - æœ‰çŠ¶æ€ç¼“å­˜æœåŠ¡
     - æ•°æ®åº“æœåŠ¡

3. **æ€§èƒ½æµ‹è¯•**:

   | æŒ‡æ ‡ | è™šæ‹Ÿæœº | å®¹å™¨ | æå‡ |
   |------|--------|------|------|
   | å¯åŠ¨æ—¶é—´ | 5åˆ†é’Ÿ | 30ç§’ | **10x** |
   | èµ„æºåˆ©ç”¨ç‡ | 30% | 70% | **2.3x** |
   | æ‰©å®¹é€Ÿåº¦ | 30åˆ†é’Ÿ | 2åˆ†é’Ÿ | **15x** |
   | éƒ¨ç½²é¢‘ç‡ | å‘¨çº§ | æ—¥çº§ | **5x** |

4. **æˆæœ**:
   - âœ… æŠ€æœ¯å¯è¡Œæ€§éªŒè¯
   - âœ… æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡
   - âœ… å›¢é˜Ÿæ¥å—åº¦é«˜
   - âœ… é«˜å±‚æ”¯æŒæ‰¹å‡†

**Phase 2: åŸºç¡€è®¾æ–½å»ºè®¾ (6ä¸ªæœˆ)**:

**K8sé›†ç¾¤è§„åˆ’**:

| é›†ç¾¤ | èŠ‚ç‚¹æ•° | é…ç½® | ç”¨é€” |
|------|--------|------|------|
| **Dev** | 3 | 8C16G | å¼€å‘æµ‹è¯• |
| **Staging** | 6 | 16C32G | é¢„ç”Ÿäº§ |
| **Prod** | 30 | 32C64G | ç”Ÿäº§ç¯å¢ƒ |
| **æ€»è®¡** | 39 | - | - |

**ç½‘ç»œæ¶æ„**:

```mermaid
graph TD
    subgraph Internet["äº’è”ç½‘"]
        U[ç”¨æˆ·]
    end
    
    subgraph LoadBalancer["è´Ÿè½½å‡è¡¡å±‚"]
        LB1[äº‘è´Ÿè½½å‡è¡¡]
        LB2[Nginx Ingress]
    end
    
    subgraph K8s["Kubernetesé›†ç¾¤"]
        subgraph Services["æœåŠ¡å±‚"]
            S1[è®¢å•æœåŠ¡]
            S2[æ”¯ä»˜æœåŠ¡]
            S3[å•†å“æœåŠ¡]
        end
        
        subgraph Mesh["Service Mesh (Istio)"]
            E1[Envoy Sidecar]
            E2[Envoy Sidecar]
        end
        
        subgraph Data["æ•°æ®å±‚"]
            D1[MySQL StatefulSet]
            D2[Redis StatefulSet]
            D3[RabbitMQ]
        end
    end
    
    subgraph Storage["å­˜å‚¨å±‚"]
        L[Longhornåˆ†å¸ƒå¼å­˜å‚¨]
    end
    
    U --> LB1
    LB1 --> LB2
    LB2 --> Services
    Services --> Mesh
    Mesh --> Data
    Data --> L
    
    style K8s fill:#9f9,stroke:#333,stroke-width:2px
    style Storage fill:#9cf,stroke:#333,stroke-width:2px
```

**Phase 3: åº”ç”¨è¿ç§» (9ä¸ªæœˆ)**:

**è¿ç§»ä¼˜å…ˆçº§**:

| ä¼˜å…ˆçº§ | åº”ç”¨ç±»å‹ | æ•°é‡ | ç‰¹ç‚¹ | è¿ç§»éš¾åº¦ |
|--------|---------|------|------|---------|
| **P0** | æ— çŠ¶æ€Web | 100 | APIæœåŠ¡ | â­â­ |
| **P1** | æ— çŠ¶æ€åå°ä»»åŠ¡ | 80 | å®šæ—¶ä»»åŠ¡ | â­â­ |
| **P2** | æœ‰çŠ¶æ€ç¼“å­˜ | 60 | Redis/Memcached | â­â­â­ |
| **P3** | æ¶ˆæ¯é˜Ÿåˆ— | 40 | RabbitMQ/Kafka | â­â­â­â­ |
| **P4** | æ•°æ®åº“ | 20 | MySQL/PostgreSQL | â­â­â­â­â­ |

**æ— çŠ¶æ€åº”ç”¨è¿ç§»æ¨¡æ¿**:

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
  namespace: production
  labels:
    app: order-service
    version: v2.1.0
spec:
  replicas: 10
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 3
      maxUnavailable: 1
  selector:
    matchLabels:
      app: order-service
  template:
    metadata:
      labels:
        app: order-service
        version: v2.1.0
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
    spec:
      # åäº²å’Œæ€§ï¼Œé¿å…Podé›†ä¸­
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - order-service
              topologyKey: kubernetes.io/hostname
      
      # å®‰å…¨ä¸Šä¸‹æ–‡
      securityContext:
        runAsNonRoot: true
        runAsUser: 10000
        fsGroup: 10000
      
      containers:
      - name: order-service
        image: registry.example.com/order-service:v2.1.0
        imagePullPolicy: IfNotPresent
        
        # èµ„æºé™åˆ¶
        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
          limits:
            cpu: "2000m"
            memory: "4Gi"
        
        # å¥åº·æ£€æŸ¥
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        
        # ç¯å¢ƒå˜é‡
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "production"
        - name: JAVA_OPTS
          value: "-Xms1g -Xmx3g -XX:+UseG1GC"
        
        # é…ç½®æŒ‚è½½
        volumeMounts:
        - name: config
          mountPath: /app/config
          readOnly: true
        - name: tmp
          mountPath: /tmp
        
        # å®‰å…¨ä¸Šä¸‹æ–‡
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
          readOnlyRootFilesystem: true
      
      volumes:
      - name: config
        configMap:
          name: order-service-config
      - name: tmp
        emptyDir: {}
---
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: order-service
  namespace: production
spec:
  type: ClusterIP
  selector:
    app: order-service
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
---
# hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: order-service-hpa
  namespace: production
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: order-service
  minReplicas: 10
  maxReplicas: 100
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 10
        periodSeconds: 30
      selectPolicy: Max
```

#### 1.1.5 é¡¹ç›®æˆæœ

**ä¸šåŠ¡ä»·å€¼**:

| æŒ‡æ ‡ | è¿ç§»å‰ | è¿ç§»å | æå‡ |
|------|--------|--------|------|
| **å‘å¸ƒé¢‘ç‡** | æ¯å‘¨1æ¬¡ | æ¯å¤©10+æ¬¡ | **50x** |
| **éƒ¨ç½²æ—¶é—´** | 2-4å°æ—¶ | 10åˆ†é’Ÿ | **12-24x** |
| **æ•…éšœæ¢å¤** | 30-60åˆ†é’Ÿ | 5åˆ†é’Ÿ | **6-12x** |
| **èµ„æºåˆ©ç”¨ç‡** | 30% | 70% | **2.3x** |
| **æˆæœ¬èŠ‚çœ** | åŸºçº¿ | -40% | **40%â†“** |

**æŠ€æœ¯æˆæœ**:

âœ… **æ•æ·äº¤ä»˜**:

- éƒ¨ç½²è‡ªåŠ¨åŒ–ç‡ 95%
- å›æ»šæˆåŠŸç‡ 100%
- é›¶åœæœºå‘å¸ƒ

âœ… **é«˜å¯ç”¨**:

- æœåŠ¡å¯ç”¨æ€§ 99.99%
- å¹³å‡æ•…éšœæ¢å¤æ—¶é—´ <5åˆ†é’Ÿ
- è‡ªåŠ¨æ‰©ç¼©å®¹

âœ… **å¯è§‚æµ‹æ€§**:

- å…¨é“¾è·¯è¿½è¸ªè¦†ç›–ç‡ 100%
- ç›‘æ§æŒ‡æ ‡ 10000+
- å‘Šè­¦å“åº”æ—¶é—´ <1åˆ†é’Ÿ

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šKubernetesç”Ÿäº§å®è·µ

### 2.1 ç”Ÿäº§çº§K8sé›†ç¾¤æœ€ä½³é…ç½®

#### 2.1.1 Control Planeé«˜å¯ç”¨

**æ¶æ„è®¾è®¡**:

```mermaid
graph TD
    subgraph LB["è´Ÿè½½å‡è¡¡"]
        L[HAProxy/Nginx]
    end
    
    subgraph Masters["Control Plane (3èŠ‚ç‚¹)"]
        M1[Master-1<br/>API Server + etcd]
        M2[Master-2<br/>API Server + etcd]
        M3[Master-3<br/>API Server + etcd]
    end
    
    subgraph Workers["Worker Nodes"]
        W1[Worker-1]
        W2[Worker-2]
        W3[Worker-N]
    end
    
    L --> M1
    L --> M2
    L --> M3
    
    M1 --> W1
    M2 --> W2
    M3 --> W3
    
    M1 -.Raftå…±è¯†.-> M2
    M2 -.Raftå…±è¯†.-> M3
    M3 -.Raftå…±è¯†.-> M1
    
    style Masters fill:#f99,stroke:#333,stroke-width:2px
    style Workers fill:#9f9,stroke:#333,stroke-width:2px
```

**å…³é”®é…ç½®**:

| ç»„ä»¶ | é…ç½®é¡¹ | æ¨èå€¼ | è¯´æ˜ |
|------|--------|--------|------|
| **etcd** | æ•°æ®ç›®å½• | SSD | é«˜IOPS |
| | snapshot-count | 10000 | å¿«ç…§é—´éš” |
| | heartbeat-interval | 100ms | å¿ƒè·³é—´éš” |
| | election-timeout | 1000ms | é€‰ä¸¾è¶…æ—¶ |
| **API Server** | --max-requests-inflight | 400 | æœ€å¤§å¹¶å‘è¯·æ±‚ |
| | --max-mutating-requests-inflight | 200 | æœ€å¤§ä¿®æ”¹è¯·æ±‚ |
| | --request-timeout | 60s | è¯·æ±‚è¶…æ—¶ |
| **Scheduler** | --kube-api-qps | 100 | API QPS |
| | --kube-api-burst | 100 | API Burst |

#### 2.1.2 èŠ‚ç‚¹é…ç½®è§„èŒƒ

**ç”Ÿäº§ç¯å¢ƒèŠ‚ç‚¹è§„æ ¼**:

| èŠ‚ç‚¹ç±»å‹ | CPU | å†…å­˜ | ç£ç›˜ | æ•°é‡ | ç”¨é€” |
|---------|-----|------|------|------|------|
| **Master** | 8æ ¸ | 16GB | 200GB SSD | 3 | æ§åˆ¶å¹³é¢ |
| **Worker (è®¡ç®—)** | 32æ ¸ | 64GB | 500GB SSD | 20+ | æ— çŠ¶æ€åº”ç”¨ |
| **Worker (å­˜å‚¨)** | 16æ ¸ | 32GB | 2TB SSD | 6+ | æœ‰çŠ¶æ€åº”ç”¨ |
| **Worker (GPU)** | 32æ ¸ | 128GB | 1TB SSD + 4 GPU | 4+ | AI/MLå·¥ä½œè´Ÿè½½ |

**èŠ‚ç‚¹æ ‡ç­¾ç­–ç•¥**:

```yaml
# è®¡ç®—èŠ‚ç‚¹
nodeSelector:
  node-role.kubernetes.io/worker: ""
  workload-type: compute
  
# å­˜å‚¨èŠ‚ç‚¹
nodeSelector:
  node-role.kubernetes.io/worker: ""
  workload-type: storage
  storage-type: ssd
  
# GPUèŠ‚ç‚¹
nodeSelector:
  node-role.kubernetes.io/worker: ""
  workload-type: gpu
  nvidia.com/gpu.present: "true"
```

### 2.2 èµ„æºç®¡ç†æœ€ä½³å®è·µ

#### 2.2.1 Resource Quota

**Namespaceçº§åˆ«é…é¢**:

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: production-quota
  namespace: production
spec:
  hard:
    # è®¡ç®—èµ„æº
    requests.cpu: "500"
    requests.memory: "1000Gi"
    limits.cpu: "1000"
    limits.memory: "2000Gi"
    
    # å­˜å‚¨èµ„æº
    requests.storage: "5Ti"
    persistentvolumeclaims: "100"
    
    # å¯¹è±¡æ•°é‡
    pods: "500"
    services: "100"
    configmaps: "200"
    secrets: "100"
```

#### 2.2.2 LimitRange

**Podèµ„æºé™åˆ¶**:

```yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: production-limitrange
  namespace: production
spec:
  limits:
  # Containerçº§åˆ«
  - type: Container
    default:
      cpu: "1"
      memory: "2Gi"
    defaultRequest:
      cpu: "100m"
      memory: "256Mi"
    max:
      cpu: "4"
      memory: "8Gi"
    min:
      cpu: "50m"
      memory: "128Mi"
    maxLimitRequestRatio:
      cpu: "4"
      memory: "2"
  
  # Podçº§åˆ«
  - type: Pod
    max:
      cpu: "16"
      memory: "32Gi"
```

### 2.3 å­˜å‚¨ç®¡ç†å®è·µ

#### 2.3.1 StorageClassé…ç½®

```yaml
---
# é«˜æ€§èƒ½å­˜å‚¨ç±»
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: driver.longhorn.io
parameters:
  numberOfReplicas: "3"
  staleReplicaTimeout: "30"
  diskSelector: "ssd"
  nodeSelector: "storage-type:ssd"
reclaimPolicy: Retain
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer
---
# æ ‡å‡†å­˜å‚¨ç±»
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: standard
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: driver.longhorn.io
parameters:
  numberOfReplicas: "2"
  staleReplicaTimeout: "30"
reclaimPolicy: Delete
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¾®æœåŠ¡æ¶æ„å®è·µ

### 3.1 Service Meshå®è·µï¼ˆIstioï¼‰

#### 3.1.1 æµé‡ç®¡ç†

**é‡‘ä¸é›€å‘å¸ƒ**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: order-service
spec:
  selector:
    app: order-service
  ports:
  - port: 80
    targetPort: 8080
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: order-service
spec:
  hosts:
  - order-service
  http:
  - match:
    - headers:
        user-type:
          exact: "internal"
    route:
    - destination:
        host: order-service
        subset: v2
      weight: 100
  - route:
    - destination:
        host: order-service
        subset: v1
      weight: 90
    - destination:
        host: order-service
        subset: v2
      weight: 10
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: order-service
spec:
  host: order-service
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        http2MaxRequests: 100
        maxRequestsPerConnection: 2
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

#### 3.1.2 æ–­è·¯å™¨ä¸é‡è¯•

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: payment-service
spec:
  hosts:
  - payment-service
  http:
  - route:
    - destination:
        host: payment-service
    timeout: 10s
    retries:
      attempts: 3
      perTryTimeout: 3s
      retryOn: "5xx,reset,connect-failure,refused-stream"
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: payment-service
spec:
  host: payment-service
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 50
      http:
        http1MaxPendingRequests: 20
        maxRequestsPerConnection: 5
    outlierDetection:
      consecutiveErrors: 3
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 50
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šCI/CDæœ€ä½³å®è·µ

### 4.1 GitOpså·¥ä½œæµï¼ˆArgoCDï¼‰

**Applicationé…ç½®**:

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: order-service
  namespace: argocd
spec:
  project: production
  source:
    repoURL: https://gitlab.example.com/apps/order-service.git
    targetRevision: main
    path: k8s/overlays/production
    kustomize:
      version: v5.0.0
  destination:
    server: https://kubernetes.default.svc
    namespace: production
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false
    syncOptions:
    - CreateNamespace=true
    - PruneLast=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
```

### 4.2 å¤šç¯å¢ƒç®¡ç†ï¼ˆKustomizeï¼‰

**ç›®å½•ç»“æ„**:

```text
order-service/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ configmap.yaml
â”‚   â””â”€â”€ kustomization.yaml
â””â”€â”€ overlays/
    â”œâ”€â”€ dev/
    â”‚   â”œâ”€â”€ kustomization.yaml
    â”‚   â”œâ”€â”€ replicas.yaml
    â”‚   â””â”€â”€ resources.yaml
    â”œâ”€â”€ staging/
    â”‚   â”œâ”€â”€ kustomization.yaml
    â”‚   â””â”€â”€ ...
    â””â”€â”€ production/
        â”œâ”€â”€ kustomization.yaml
        â”œâ”€â”€ replicas.yaml
        â”œâ”€â”€ resources.yaml
        â””â”€â”€ hpa.yaml
```

**production/kustomization.yaml**:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: production

bases:
- ../../base

patches:
- path: replicas.yaml
- path: resources.yaml
- path: hpa.yaml

images:
- name: order-service
  newName: registry.example.com/order-service
  newTag: v2.1.0

configMapGenerator:
- name: order-service-config
  files:
  - application.yaml
  behavior: merge

replicas:
- name: order-service
  count: 10
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå¯è§‚æµ‹æ€§æœ€ä½³å®è·µ

### 5.1 ç»Ÿä¸€ç›‘æ§æ ˆ

**Prometheusé…ç½®**:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      external_labels:
        cluster: 'production'
    
    scrape_configs:
    # Kubernetesç»„ä»¶
    - job_name: 'kubernetes-apiservers'
      kubernetes_sd_configs:
      - role: endpoints
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https
    
    # åº”ç”¨æŒ‡æ ‡
    - job_name: 'kubernetes-pods'
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
```

### 5.2 å‘Šè­¦è§„åˆ™

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
data:
  alerts.yml: |
    groups:
    - name: application
      interval: 30s
      rules:
      # é«˜é”™è¯¯ç‡
      - alert: HighErrorRate
        expr: |
          rate(http_requests_total{status=~"5.."}[5m])
          / rate(http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate on {{ $labels.pod }}"
          description: "Error rate is {{ $value | humanizePercentage }}"
      
      # é«˜å»¶è¿Ÿ
      - alert: HighLatency
        expr: |
          histogram_quantile(0.99,
            rate(http_request_duration_seconds_bucket[5m])
          ) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency on {{ $labels.pod }}"
          description: "P99 latency is {{ $value }}s"
      
      # Podé¢‘ç¹é‡å¯
      - alert: PodRestarting
        expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Pod {{ $labels.pod }} is restarting"
          description: "Pod has restarted {{ $value }} times in 15 minutes"
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šå®‰å…¨åŠ å›ºå®è·µ

### 6.1 Pod Security Standardså®æ–½

**Namespaceçº§åˆ«ç­–ç•¥**:

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
```

### 6.2 Network Policy

**é»˜è®¤æ‹’ç»ç­–ç•¥**:

```yaml
---
# æ‹’ç»æ‰€æœ‰å…¥ç«™æµé‡
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
---
# å…è®¸ç‰¹å®šæœåŠ¡é€šä¿¡
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-order-to-payment
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: payment-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: order-service
    ports:
    - protocol: TCP
      port: 8080
```

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæˆæœ¬ä¼˜åŒ–å®è·µ

### 7.1 èµ„æºrightsizing

**VPAï¼ˆVertical Pod Autoscalerï¼‰**:

```yaml
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: order-service-vpa
spec:
  targetRef:
    apiVersion: "apps/v1"
    kind: Deployment
    name: order-service
  updatePolicy:
    updateMode: "Recommender"  # ä»…æ¨èï¼Œä¸è‡ªåŠ¨åº”ç”¨
  resourcePolicy:
    containerPolicies:
    - containerName: "*"
      minAllowed:
        cpu: 100m
        memory: 256Mi
      maxAllowed:
        cpu: 4
        memory: 8Gi
      controlledResources: ["cpu", "memory"]
```

### 7.2 Spotå®ä¾‹ä½¿ç”¨

**èŠ‚ç‚¹äº²å’Œæ€§**:

```yaml
spec:
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
          - key: node-lifecycle
            operator: In
            values:
            - spot
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: node-lifecycle
            operator: In
            values:
            - spot
            - on-demand
```

---

## ç¬¬å…«éƒ¨åˆ†ï¼šæ•…éšœæ¡ˆä¾‹ä¸è§£å†³æ–¹æ¡ˆ

### 8.1 å…¸å‹æ•…éšœæ¡ˆä¾‹

#### æ¡ˆä¾‹1: etcdæ€§èƒ½é—®é¢˜

**é—®é¢˜æè¿°**: API Serverå“åº”æ…¢ï¼Œkubectlå‘½ä»¤è¶…æ—¶

**æ ¹å› åˆ†æ**:

- etcdç£ç›˜ä¸ºHDDï¼ŒIOPSä¸è¶³
- etcdæ•°æ®åº“å¤§å°è¾¾åˆ°8GB
- é¢‘ç¹çš„å¤§å¯¹è±¡å†™å…¥

**è§£å†³æ–¹æ¡ˆ**:

1. âœ… è¿ç§»etcdåˆ°SSD
2. âœ… æ¸…ç†å†å²æ•°æ®ï¼Œå¯ç”¨è‡ªåŠ¨å‹ç¼©
3. âœ… å¢åŠ etcdå†…å­˜é…é¢
4. âœ… ä¼˜åŒ–åº”ç”¨ï¼Œå‡å°‘ConfigMap/Secretå¤§å°

**é¢„é˜²æªæ–½**:

```yaml
# etcdå‹ç¼©é…ç½®
--auto-compaction-mode=periodic
--auto-compaction-retention=1h
--quota-backend-bytes=8589934592  # 8GB
```

#### æ¡ˆä¾‹2: OOM Killé¢‘ç¹

**é—®é¢˜æè¿°**: Podé¢‘ç¹è¢«OOM Kill

**æ ¹å› åˆ†æ**:

- å†…å­˜requestsè®¾ç½®è¿‡ä½
- åº”ç”¨å†…å­˜æ³„éœ²
- JVMå †å†…å­˜é…ç½®ä¸å½“

**è§£å†³æ–¹æ¡ˆ**:

```yaml
# æ­£ç¡®çš„èµ„æºé…ç½®
resources:
  requests:
    memory: "2Gi"    # åŸºäºå®é™…ç›‘æ§æ•°æ®
  limits:
    memory: "4Gi"    # 2å€requests

env:
- name: JAVA_OPTS
  value: "-Xms1g -Xmx3g -XX:MaxRAM=4g"  # ç•™å‡º1GBç»™å †å¤–å†…å­˜
```

---

## æ€»ç»“ä¸å»ºè®®

### å…³é”®æˆåŠŸå› ç´ 

1. **æ¸è¿›å¼è¿ç§»**: ä¸è¦ä¸€æ¬¡æ€§è¿ç§»æ‰€æœ‰åº”ç”¨
2. **å……åˆ†æµ‹è¯•**: POCéªŒè¯ â†’ å°è§„æ¨¡è¯•ç‚¹ â†’ å…¨é¢æ¨å¹¿
3. **å›¢é˜Ÿèµ‹èƒ½**: æŒç»­åŸ¹è®­ï¼Œå»ºç«‹æœ€ä½³å®è·µ
4. **è‡ªåŠ¨åŒ–ä¼˜å…ˆ**: CI/CD, GitOps, è‡ªåŠ¨æ‰©ç¼©å®¹
5. **å¯è§‚æµ‹æ€§**: ç›‘æ§ã€æ—¥å¿—ã€è¿½è¸ªä¸‰ä½ä¸€ä½“

### å¸¸è§é™·é˜±

âŒ **è¿‡åº¦å·¥ç¨‹åŒ–**: ä¸è¦ä¸ºäº†ç”¨è€Œç”¨ï¼Œæ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©
âŒ **å¿½è§†å®‰å…¨**: å®‰å…¨ä»ç¬¬ä¸€å¤©å°±è¦è€ƒè™‘
âŒ **èµ„æºä¸è®¾é™**: å¿…é¡»è®¾ç½®requestså’Œlimits
âŒ **ç¼ºå°‘ç›‘æ§**: æ²¡æœ‰ç›‘æ§å°±æ˜¯ç›²é£
âŒ **å¿½è§†æˆæœ¬**: æŒç»­ä¼˜åŒ–èµ„æºä½¿ç”¨

---

## å‚è€ƒæ–‡çŒ®

1. **Kubernetes** (2025). "Production Best Practices".
2. **CNCF** (2025). "Case Studies and End User Stories".
3. **Google** (2025). "Site Reliability Engineering".
4. **Istio** (2025). "Traffic Management Best Practices".
5. **ArgoCD** (2025). "GitOps Best Practices".

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ20æ—¥  
**ä½œè€…**: Cloud Native Practice Team  
**License**: CC-BY-4.0

---

**ğŸ¯ æœ¬æ–‡æ¡£æä¾›äº†ä»å®¹å™¨åŒ–è¿ç§»åˆ°ç”Ÿäº§è¿ç»´çš„å®Œæ•´å®è·µæŒ‡å—ï¼**
