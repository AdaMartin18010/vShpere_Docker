# æµé‡ç®¡ç†ä¸ç°åº¦å‘å¸ƒ

## ç›®å½•

- [æµé‡ç®¡ç†ä¸ç°åº¦å‘å¸ƒ](#æµé‡ç®¡ç†ä¸ç°åº¦å‘å¸ƒ)
  - [ç›®å½•](#ç›®å½•)
  - [1. æµé‡ç®¡ç†æ¦‚è¿°](#1-æµé‡ç®¡ç†æ¦‚è¿°)
    - [1.1 æµé‡ç®¡ç†çš„é‡è¦æ€§](#11-æµé‡ç®¡ç†çš„é‡è¦æ€§)
    - [1.2 å‘å¸ƒç­–ç•¥å¯¹æ¯”](#12-å‘å¸ƒç­–ç•¥å¯¹æ¯”)
    - [1.3 æœåŠ¡ç½‘æ ¼ä¼˜åŠ¿](#13-æœåŠ¡ç½‘æ ¼ä¼˜åŠ¿)
  - [2. é‡‘ä¸é›€å‘å¸ƒ](#2-é‡‘ä¸é›€å‘å¸ƒ)
    - [2.1 é‡‘ä¸é›€å‘å¸ƒåŸç†](#21-é‡‘ä¸é›€å‘å¸ƒåŸç†)
    - [2.2 Istioé‡‘ä¸é›€å‘å¸ƒ](#22-istioé‡‘ä¸é›€å‘å¸ƒ)
      - [2.2.1 åŸºç¡€é‡‘ä¸é›€](#221-åŸºç¡€é‡‘ä¸é›€)
      - [2.2.2 ç›‘æ§é‡‘ä¸é›€](#222-ç›‘æ§é‡‘ä¸é›€)
    - [2.3 Linkerdé‡‘ä¸é›€å‘å¸ƒ](#23-linkerdé‡‘ä¸é›€å‘å¸ƒ)
    - [2.4 æ¸è¿›å¼é‡‘ä¸é›€](#24-æ¸è¿›å¼é‡‘ä¸é›€)
      - [2.4.1 æ‰‹åŠ¨æ¸è¿›å¼](#241-æ‰‹åŠ¨æ¸è¿›å¼)
    - [2.5 è‡ªåŠ¨åŒ–é‡‘ä¸é›€](#25-è‡ªåŠ¨åŒ–é‡‘ä¸é›€)
      - [2.5.1 ä½¿ç”¨Flagger](#251-ä½¿ç”¨flagger)
      - [2.5.2 Flaggerå·¥ä½œæµç¨‹](#252-flaggerå·¥ä½œæµç¨‹)
  - [3. è“ç»¿éƒ¨ç½²](#3-è“ç»¿éƒ¨ç½²)
    - [3.1 è“ç»¿éƒ¨ç½²åŸç†](#31-è“ç»¿éƒ¨ç½²åŸç†)
    - [3.2 Istioè“ç»¿éƒ¨ç½²](#32-istioè“ç»¿éƒ¨ç½²)
    - [3.3 Linkerdè“ç»¿éƒ¨ç½²](#33-linkerdè“ç»¿éƒ¨ç½²)
    - [3.4 å¿«é€Ÿå›æ»š](#34-å¿«é€Ÿå›æ»š)
  - [4. A/Bæµ‹è¯•](#4-abæµ‹è¯•)
    - [4.1 A/Bæµ‹è¯•åŸç†](#41-abæµ‹è¯•åŸç†)
    - [4.2 åŸºäºHeaderçš„A/Bæµ‹è¯•](#42-åŸºäºheaderçš„abæµ‹è¯•)
    - [4.3 åŸºäºç”¨æˆ·çš„A/Bæµ‹è¯•](#43-åŸºäºç”¨æˆ·çš„abæµ‹è¯•)
    - [4.4 A/Bæµ‹è¯•æŒ‡æ ‡æ”¶é›†](#44-abæµ‹è¯•æŒ‡æ ‡æ”¶é›†)
  - [5. æµé‡é•œåƒ](#5-æµé‡é•œåƒ)
    - [5.1 æµé‡é•œåƒåŸç†](#51-æµé‡é•œåƒåŸç†)
    - [5.2 Istioæµé‡é•œåƒ](#52-istioæµé‡é•œåƒ)
    - [5.3 æµé‡é•œåƒå®æˆ˜](#53-æµé‡é•œåƒå®æˆ˜)
  - [6. æ•…éšœæ³¨å…¥](#6-æ•…éšœæ³¨å…¥)
    - [6.1 æ•…éšœæ³¨å…¥çš„ä»·å€¼](#61-æ•…éšœæ³¨å…¥çš„ä»·å€¼)
    - [6.2 å»¶è¿Ÿæ³¨å…¥](#62-å»¶è¿Ÿæ³¨å…¥)
    - [6.3 é”™è¯¯æ³¨å…¥](#63-é”™è¯¯æ³¨å…¥)
    - [6.4 æ··æ²Œå·¥ç¨‹å®è·µ](#64-æ··æ²Œå·¥ç¨‹å®è·µ)
  - [7. ç†”æ–­ä¸é™çº§](#7-ç†”æ–­ä¸é™çº§)
    - [7.1 ç†”æ–­å™¨æ¨¡å¼](#71-ç†”æ–­å™¨æ¨¡å¼)
    - [7.2 Istioç†”æ–­é…ç½®](#72-istioç†”æ–­é…ç½®)
    - [7.3 æœåŠ¡é™çº§](#73-æœåŠ¡é™çº§)
    - [7.4 è¶…æ—¶ä¸é‡è¯•](#74-è¶…æ—¶ä¸é‡è¯•)
  - [8. æµé‡ç®¡ç†å®æˆ˜](#8-æµé‡ç®¡ç†å®æˆ˜)
    - [8.1 ç”µå•†å¤§ä¿ƒåœºæ™¯](#81-ç”µå•†å¤§ä¿ƒåœºæ™¯)
    - [8.2 å¾®æœåŠ¡å‡çº§åœºæ™¯](#82-å¾®æœåŠ¡å‡çº§åœºæ™¯)
    - [8.3 å¤šç‰ˆæœ¬å…±å­˜](#83-å¤šç‰ˆæœ¬å…±å­˜)
  - [9. æœ€ä½³å®è·µ](#9-æœ€ä½³å®è·µ)
  - [10. æ€»ç»“](#10-æ€»ç»“)
    - [10.1 æµé‡ç®¡ç†æ ¸å¿ƒä»·å€¼](#101-æµé‡ç®¡ç†æ ¸å¿ƒä»·å€¼)
    - [10.2 Istio vs Linkerdæµé‡ç®¡ç†å¯¹æ¯”](#102-istio-vs-linkerdæµé‡ç®¡ç†å¯¹æ¯”)
    - [10.3 æœªæ¥å±•æœ›](#103-æœªæ¥å±•æœ›)
  - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [æœ¬æ¨¡å—ç›¸å…³](#æœ¬æ¨¡å—ç›¸å…³)
    - [å…¶ä»–æ¨¡å—ç›¸å…³](#å…¶ä»–æ¨¡å—ç›¸å…³)

---

## 1. æµé‡ç®¡ç†æ¦‚è¿°

### 1.1 æµé‡ç®¡ç†çš„é‡è¦æ€§

```yaml
æµé‡ç®¡ç†çš„æ ¸å¿ƒä»·å€¼:

1. é™ä½å‘å¸ƒé£é™©:
   âœ… æ¸è¿›å¼å‘å¸ƒ
   âœ… å¿«é€Ÿå›æ»š
   âœ… å½±å“æœ€å°åŒ–
   âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯

2. æå‡ç”¨æˆ·ä½“éªŒ:
   âœ… é›¶åœæœºéƒ¨ç½²
   âœ… æ— æ„ŸçŸ¥å‡çº§
   âœ… ä¸ªæ€§åŒ–è·¯ç”±
   âœ… æ€§èƒ½ä¼˜åŒ–

3. å¢å¼ºç³»ç»Ÿå¼¹æ€§:
   âœ… æ•…éšœéš”ç¦»
   âœ… è‡ªåŠ¨ç†”æ–­
   âœ… æœåŠ¡é™çº§
   âœ… å®¹é”™èƒ½åŠ›

4. æ”¯æŒåˆ›æ–°å®éªŒ:
   âœ… A/Bæµ‹è¯•
   âœ… åŠŸèƒ½å¼€å…³
   âœ… ç°åº¦å‘å¸ƒ
   âœ… å¤šç‰ˆæœ¬æµ‹è¯•

5. å¯è§‚æµ‹æ€§:
   âœ… æµé‡å¯è§†åŒ–
   âœ… å®æ—¶ç›‘æ§
   âœ… æ€§èƒ½å¯¹æ¯”
   âœ… é—®é¢˜å®šä½
```

### 1.2 å‘å¸ƒç­–ç•¥å¯¹æ¯”

```yaml
ä¸»æµå‘å¸ƒç­–ç•¥å¯¹æ¯”:

æ»šåŠ¨æ›´æ–° (Rolling Update):
  åŸç†: é€ä¸ªæ›¿æ¢æ—§ç‰ˆæœ¬Pod
  ä¼˜ç‚¹:
    âœ… KubernetesåŸç”Ÿæ”¯æŒ
    âœ… ç®€å•æ˜“ç”¨
  ç¼ºç‚¹:
    âŒ æ–°æ—§ç‰ˆæœ¬å…±å­˜
    âŒ å›æ»šæ…¢
    âŒ æµé‡æ¯”ä¾‹éš¾ä»¥ç²¾ç¡®æ§åˆ¶
  é€‚ç”¨: ç®€å•åº”ç”¨å‡çº§

è“ç»¿éƒ¨ç½² (Blue-Green):
  åŸç†: éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼Œæµé‡ä¸€æ¬¡æ€§åˆ‡æ¢
  ä¼˜ç‚¹:
    âœ… æ–°ç‰ˆæœ¬å……åˆ†æµ‹è¯•
    âœ… åˆ‡æ¢å¿«é€Ÿ
    âœ… å›æ»šå¿«é€Ÿ
  ç¼ºç‚¹:
    âŒ èµ„æºæ¶ˆè€—2å€
    âŒ æ•°æ®åº“å…¼å®¹æ€§è¦æ±‚é«˜
    âŒ ä¸€æ¬¡æ€§åˆ‡æ¢é£é™©è¾ƒå¤§
  é€‚ç”¨: å…³é”®æœåŠ¡å‡çº§

é‡‘ä¸é›€å‘å¸ƒ (Canary):
  åŸç†: æ–°ç‰ˆæœ¬é€æ­¥å¢åŠ æµé‡æ¯”ä¾‹
  ä¼˜ç‚¹:
    âœ… é£é™©å¯æ§
    âœ… æ¸è¿›å¼éªŒè¯
    âœ… çµæ´»è°ƒæ•´
  ç¼ºç‚¹:
    âŒ å‘å¸ƒå‘¨æœŸè¾ƒé•¿
    âŒ ç›‘æ§è¦æ±‚é«˜
    âŒ é…ç½®ç›¸å¯¹å¤æ‚
  é€‚ç”¨: ç”Ÿäº§ç¯å¢ƒå¸¸ç”¨ç­–ç•¥

A/Bæµ‹è¯•:
  åŸç†: ä¸åŒç”¨æˆ·ç¾¤ä½“ä½¿ç”¨ä¸åŒç‰ˆæœ¬
  ä¼˜ç‚¹:
    âœ… ç²¾å‡†å¯¹æ¯”
    âœ… æ•°æ®é©±åŠ¨
    âœ… æ”¯æŒå¤šç‰ˆæœ¬å¹¶è¡Œ
  ç¼ºç‚¹:
    âŒ éœ€è¦æµé‡æ ‡è¯†
    âŒ æ•°æ®åˆ†æå¤æ‚
    âŒ é•¿æœŸç»´æŠ¤å¤šç‰ˆæœ¬
  é€‚ç”¨: æ–°åŠŸèƒ½éªŒè¯

æœåŠ¡ç½‘æ ¼ä¼˜åŠ¿:
  âœ… ç»Ÿä¸€å®ç°å„ç§ç­–ç•¥
  âœ… æ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç 
  âœ… ç²¾ç¡®æµé‡æ§åˆ¶
  âœ… å®æ—¶ç›‘æ§æŒ‡æ ‡
  âœ… å¿«é€Ÿæ•…éšœæ¢å¤
```

### 1.3 æœåŠ¡ç½‘æ ¼ä¼˜åŠ¿

```yaml
æœåŠ¡ç½‘æ ¼æµé‡ç®¡ç†ä¼˜åŠ¿:

ä¼ ç»Ÿæ–¹å¼ vs æœåŠ¡ç½‘æ ¼:

ä¼ ç»Ÿæ–¹å¼:
  âŒ ä»£ç çº§åˆ«å®ç°
  âŒ æ¯ä¸ªæœåŠ¡ç‹¬ç«‹å®ç°
  âŒ é…ç½®åˆ†æ•£
  âŒ ä¸€è‡´æ€§éš¾ä¿è¯
  âŒ å‡çº§å›°éš¾

æœåŠ¡ç½‘æ ¼:
  âœ… åŸºç¡€è®¾æ–½å±‚å®ç°
  âœ… ç»Ÿä¸€ç®¡ç†
  âœ… å£°æ˜å¼é…ç½®
  âœ… å…¨å±€ä¸€è‡´
  âœ… æ— éœ€ä¿®æ”¹ä»£ç 

å…·ä½“ä¼˜åŠ¿:

1. ç²¾ç¡®æµé‡æ§åˆ¶:
   - åŸºäºæƒé‡
   - åŸºäºHeader
   - åŸºäºæ¥æº
   - åŸºäºç›®æ ‡

2. ä¸°å¯Œè·¯ç”±è§„åˆ™:
   - è·¯å¾„åŒ¹é…
   - HeaderåŒ¹é…
   - æŸ¥è¯¢å‚æ•°åŒ¹é…
   - CookieåŒ¹é…

3. é«˜çº§åŠŸèƒ½:
   - æµé‡é•œåƒ
   - æ•…éšœæ³¨å…¥
   - è¶…æ—¶é‡è¯•
   - ç†”æ–­é™çº§

4. å¯è§‚æµ‹æ€§:
   - å®æ—¶æµé‡ç›‘æ§
   - è¯·æ±‚æˆåŠŸç‡
   - å»¶è¿Ÿç»Ÿè®¡
   - æµé‡æ‹“æ‰‘å›¾
```

---

## 2. é‡‘ä¸é›€å‘å¸ƒ

### 2.1 é‡‘ä¸é›€å‘å¸ƒåŸç†

```yaml
é‡‘ä¸é›€å‘å¸ƒ (Canary Deployment):

åç§°ç”±æ¥:
  - çŸ¿å·¥ç”¨é‡‘ä¸é›€æ£€æµ‹æ¯’æ°”
  - é‡‘ä¸é›€å…ˆè¿›å…¥çŸ¿äº•ï¼Œå¦‚æœå®‰å…¨ï¼ŒçŸ¿å·¥å†è¿›å…¥
  - è½¯ä»¶å‘å¸ƒä¸­ï¼Œæ–°ç‰ˆæœ¬å…ˆç»™å°‘é‡ç”¨æˆ·ï¼ŒéªŒè¯å®‰å…¨åå…¨é‡å‘å¸ƒ

åŸç†:
  1. éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼ˆé‡‘ä¸é›€ç‰ˆæœ¬ï¼‰
  2. å¯¼å…¥å°‘é‡æµé‡ï¼ˆ5%-10%ï¼‰
  3. ç›‘æ§å…³é”®æŒ‡æ ‡ï¼ˆé”™è¯¯ç‡ã€å»¶è¿Ÿã€ä¸šåŠ¡æŒ‡æ ‡ï¼‰
  4. å¦‚æœæ­£å¸¸ï¼Œé€æ­¥å¢åŠ æµé‡ï¼ˆ20% â†’ 50% â†’ 100%ï¼‰
  5. å¦‚æœå¼‚å¸¸ï¼Œå¿«é€Ÿå›æ»š

æ¸è¿›å¼å‘å¸ƒé˜¶æ®µ:
  é˜¶æ®µ1: 5%  â†’ éªŒè¯åŸºæœ¬åŠŸèƒ½
  é˜¶æ®µ2: 10% â†’ æ‰©å¤§éªŒè¯èŒƒå›´
  é˜¶æ®µ3: 25% â†’ éªŒè¯è´Ÿè½½èƒ½åŠ›
  é˜¶æ®µ4: 50% â†’ åŠæ•°éªŒè¯
  é˜¶æ®µ5: 100% â†’ å…¨é‡å‘å¸ƒ

ç›‘æ§æŒ‡æ ‡:
  - é”™è¯¯ç‡ (5xx)
  - å“åº”æ—¶é—´ (P95, P99)
  - æˆåŠŸç‡
  - ä¸šåŠ¡æŒ‡æ ‡ (è®¢å•é‡ã€æ”¯ä»˜æˆåŠŸç‡ç­‰)

å†³ç­–æ ‡å‡†:
  âœ… ç»§ç»­: æŒ‡æ ‡æ­£å¸¸æˆ–ä¼˜äºæ—§ç‰ˆæœ¬
  â¸ï¸  æš‚åœ: æŒ‡æ ‡å¼‚å¸¸ä½†æœªè¶…é˜ˆå€¼
  âŒ å›æ»š: æŒ‡æ ‡ä¸¥é‡å¼‚å¸¸
```

### 2.2 Istioé‡‘ä¸é›€å‘å¸ƒ

#### 2.2.1 åŸºç¡€é‡‘ä¸é›€

```yaml
# éƒ¨ç½²v1å’Œv2ç‰ˆæœ¬
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-service-v1
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-service
      version: v1
  template:
    metadata:
      labels:
        app: my-service
        version: v1
    spec:
      containers:
      - name: app
        image: myapp:v1
        ports:
        - containerPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-service-v2
spec:
  replicas: 1  # é‡‘ä¸é›€ç‰ˆæœ¬ï¼Œå‰¯æœ¬æ•°å°‘
  selector:
    matchLabels:
      app: my-service
      version: v2
  template:
    metadata:
      labels:
        app: my-service
        version: v2
    spec:
      containers:
      - name: app
        image: myapp:v2
        ports:
        - containerPort: 8080
---
# Service (æŒ‡å‘æ‰€æœ‰ç‰ˆæœ¬)
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app: my-service  # ä¸æŒ‡å®šversionï¼ŒåŒ…å«æ‰€æœ‰ç‰ˆæœ¬
  ports:
  - port: 8080
    targetPort: 8080
---
# DestinationRule (å®šä¹‰ç‰ˆæœ¬å­é›†)
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: my-service
spec:
  host: my-service
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
# VirtualService (æµé‡åˆ†é…: 90% v1, 10% v2)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service
spec:
  hosts:
  - my-service
  http:
  - route:
    - destination:
        host: my-service
        subset: v1
      weight: 90
    - destination:
        host: my-service
        subset: v2
      weight: 10
```

#### 2.2.2 ç›‘æ§é‡‘ä¸é›€

```bash
# ç›‘æ§v1å’Œv2çš„æµé‡
watch -n 1 'kubectl exec -it deploy/fortio -c fortio -- \
  fortio load -c 10 -qps 100 -t 60s http://my-service:8080'

# æŸ¥çœ‹v1å’Œv2çš„è¯·æ±‚åˆ†å¸ƒ
istioctl dashboard prometheus
# æŸ¥è¯¢: sum(rate(istio_requests_total[1m])) by (destination_version)

# æŸ¥çœ‹æˆåŠŸç‡
sum(rate(istio_requests_total{response_code=~"2.*"}[1m])) by (destination_version)
/
sum(rate(istio_requests_total[1m])) by (destination_version)

# æŸ¥çœ‹å»¶è¿Ÿ
histogram_quantile(0.99,
  sum(rate(istio_request_duration_milliseconds_bucket[1m])) by (le, destination_version)
)
```

### 2.3 Linkerdé‡‘ä¸é›€å‘å¸ƒ

```yaml
# Linkerdä½¿ç”¨TrafficSplitå®ç°é‡‘ä¸é›€

# åˆ›å»ºä¸¤ä¸ªService (v1å’Œv2)
apiVersion: v1
kind: Service
metadata:
  name: my-service-v1
spec:
  selector:
    app: my-service
    version: v1
  ports:
  - port: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: my-service-v2
spec:
  selector:
    app: my-service
    version: v2
  ports:
  - port: 8080
---
# TrafficSplit (90% v1, 10% v2)
apiVersion: split.smi-spec.io/v1alpha2
kind: TrafficSplit
metadata:
  name: my-service-split
spec:
  service: my-service  # æ ¹æœåŠ¡
  backends:
  - service: my-service-v1
    weight: 900  # 90%
  - service: my-service-v2
    weight: 100  # 10%
```

```bash
# ç›‘æ§Linkerdé‡‘ä¸é›€
linkerd viz stat deploy/my-service-v1
linkerd viz stat deploy/my-service-v2

# å®æ—¶æŸ¥çœ‹æµé‡
linkerd viz tap svc/my-service

# æŸ¥çœ‹æˆåŠŸç‡å¯¹æ¯”
linkerd viz stat deploy -l app=my-service
```

### 2.4 æ¸è¿›å¼é‡‘ä¸é›€

#### 2.4.1 æ‰‹åŠ¨æ¸è¿›å¼

```bash
# é˜¶æ®µ1: 10% é‡‘ä¸é›€
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service
spec:
  hosts:
  - my-service
  http:
  - route:
    - destination:
        host: my-service
        subset: v1
      weight: 90
    - destination:
        host: my-service
        subset: v2
      weight: 10
EOF

# ç­‰å¾…å¹¶ç›‘æ§...
sleep 300  # 5åˆ†é’Ÿ

# æ£€æŸ¥v2çš„æŒ‡æ ‡
kubectl exec deploy/prometheus -c prometheus -- \
  promtool query instant http://localhost:9090 \
  'sum(rate(istio_requests_total{destination_version="v2",response_code=~"5.*"}[5m])) / sum(rate(istio_requests_total{destination_version="v2"}[5m]))'

# å¦‚æœé”™è¯¯ç‡<1%ï¼Œç»§ç»­å¢åŠ æµé‡
# é˜¶æ®µ2: 25% é‡‘ä¸é›€
kubectl patch virtualservice my-service --type=merge -p '
spec:
  http:
  - route:
    - destination:
        host: my-service
        subset: v1
      weight: 75
    - destination:
        host: my-service
        subset: v2
      weight: 25
'

# ç­‰å¾…å¹¶ç›‘æ§...
sleep 300

# é˜¶æ®µ3: 50% é‡‘ä¸é›€
kubectl patch virtualservice my-service --type=merge -p '
spec:
  http:
  - route:
    - destination:
        host: my-service
        subset: v1
      weight: 50
    - destination:
        host: my-service
        subset: v2
      weight: 50
'

# ç­‰å¾…å¹¶ç›‘æ§...
sleep 300

# é˜¶æ®µ4: 100% v2
kubectl patch virtualservice my-service --type=merge -p '
spec:
  http:
  - route:
    - destination:
        host: my-service
        subset: v2
      weight: 100
'
```

### 2.5 è‡ªåŠ¨åŒ–é‡‘ä¸é›€

#### 2.5.1 ä½¿ç”¨Flagger

```yaml
# Flaggeræ˜¯CNCFé¡¹ç›®ï¼Œæ”¯æŒè‡ªåŠ¨åŒ–æ¸è¿›å¼å‘å¸ƒ

# å®‰è£…Flagger
kubectl apply -k github.com/fluxcd/flagger//kustomize/istio

# åˆ›å»ºCanaryèµ„æº
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: my-service
  namespace: default
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: my-service

  service:
    port: 8080

  analysis:
    # é‡‘ä¸é›€å‘å¸ƒé—´éš”
    interval: 1m

    # é‡‘ä¸é›€å‘å¸ƒé˜ˆå€¼
    threshold: 5

    # æœ€å¤§æµé‡æƒé‡
    maxWeight: 50

    # æµé‡å¢åŠ æ­¥é•¿
    stepWeight: 10

    # æŒ‡æ ‡æ£€æŸ¥
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: 99
      interval: 1m

    - name: request-duration
      thresholdRange:
        max: 500
      interval: 1m

    # Webhooké€šçŸ¥
    webhooks:
    - name: load-test
      url: http://flagger-loadtester/
      timeout: 5s
      metadata:
        cmd: "hey -z 1m -q 10 -c 2 http://my-service:8080/"
```

#### 2.5.2 Flaggerå·¥ä½œæµç¨‹

```yaml
Flaggerè‡ªåŠ¨åŒ–é‡‘ä¸é›€æµç¨‹:

1. æ£€æµ‹æ–°ç‰ˆæœ¬:
   - ç›‘æ§Deploymentå˜æ›´
   - åˆ›å»ºé‡‘ä¸é›€Deployment

2. åˆå§‹åŒ–:
   - åˆ›å»ºé‡‘ä¸é›€Service
   - é…ç½®0% æµé‡

3. æ¸è¿›å¼å¢åŠ :
   - 10% â†’ æ£€æŸ¥æŒ‡æ ‡
   - 20% â†’ æ£€æŸ¥æŒ‡æ ‡
   - 30% â†’ æ£€æŸ¥æŒ‡æ ‡
   - 40% â†’ æ£€æŸ¥æŒ‡æ ‡
   - 50% â†’ æ£€æŸ¥æŒ‡æ ‡

4. å†³ç­–:
   æˆåŠŸ: æå‡ä¸ºä¸»ç‰ˆæœ¬ï¼Œåˆ é™¤æ—§ç‰ˆæœ¬
   å¤±è´¥: å›æ»šåˆ°æ—§ç‰ˆæœ¬ï¼Œåˆ é™¤é‡‘ä¸é›€

5. é€šçŸ¥:
   - Slacké€šçŸ¥
   - Webhookå›è°ƒ
   - æŒ‡æ ‡è®°å½•

é…ç½®ç¤ºä¾‹:
  interval: 1m        # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  threshold: 5        # è¿ç»­5æ¬¡æˆåŠŸæ‰å¢åŠ æµé‡
  maxWeight: 50       # æœ€å¤§50%æµé‡
  stepWeight: 10      # æ¯æ¬¡å¢åŠ 10%
```

---

## 3. è“ç»¿éƒ¨ç½²

### 3.1 è“ç»¿éƒ¨ç½²åŸç†

```yaml
è“ç»¿éƒ¨ç½² (Blue-Green Deployment):

åŸç†:
  - åŒæ—¶è¿è¡Œè“(Blue)å’Œç»¿(Green)ä¸¤ä¸ªç¯å¢ƒ
  - è“ç¯å¢ƒ: å½“å‰ç”Ÿäº§ç‰ˆæœ¬
  - ç»¿ç¯å¢ƒ: æ–°ç‰ˆæœ¬
  - æµé‡ç¬é—´ä»è“åˆ‡æ¢åˆ°ç»¿
  - å¦‚æœ‰é—®é¢˜ï¼Œå¿«é€Ÿåˆ‡å›è“

æµç¨‹:
  1. è“ç¯å¢ƒè¿è¡Œv1ï¼Œæ‰¿è½½100%æµé‡
  2. éƒ¨ç½²ç»¿ç¯å¢ƒv2ï¼Œä¸æ¥æ”¶æµé‡
  3. åœ¨ç»¿ç¯å¢ƒè¿›è¡Œå……åˆ†æµ‹è¯•
  4. æµé‡åˆ‡æ¢: 100%è“ â†’ 100%ç»¿
  5. è§‚å¯Ÿç»¿ç¯å¢ƒè¿è¡ŒçŠ¶å†µ
  6. å¦‚æœæ­£å¸¸ï¼Œé”€æ¯è“ç¯å¢ƒ
  7. å¦‚æœå¼‚å¸¸ï¼Œåˆ‡å›è“ç¯å¢ƒ

ä¼˜åŠ¿:
  âœ… é›¶åœæœºéƒ¨ç½²
  âœ… å¿«é€Ÿåˆ‡æ¢ (ç§’çº§)
  âœ… å¿«é€Ÿå›æ»š (ç§’çº§)
  âœ… æ–°ç‰ˆæœ¬å……åˆ†æµ‹è¯•
  âœ… é£é™©å¯æ§

åŠ£åŠ¿:
  âŒ èµ„æºæ¶ˆè€—2å€
  âŒ æ•°æ®åº“å…¼å®¹æ€§è¦æ±‚é«˜
  âŒ ä¸æ”¯æŒæ¸è¿›å¼éªŒè¯

é€‚ç”¨åœºæ™¯:
  âœ… å…³é”®æœåŠ¡å‡çº§
  âœ… å¤§ç‰ˆæœ¬å‘å¸ƒ
  âœ… éœ€è¦å¿«é€Ÿå›æ»š
  âœ… èµ„æºå……è¶³
```

### 3.2 Istioè“ç»¿éƒ¨ç½²

```yaml
# è“ç¯å¢ƒ (v1, å½“å‰ç”Ÿäº§)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-service-blue
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-service
      version: blue
  template:
    metadata:
      labels:
        app: my-service
        version: blue
    spec:
      containers:
      - name: app
        image: myapp:v1
        ports:
        - containerPort: 8080
---
# ç»¿ç¯å¢ƒ (v2, æ–°ç‰ˆæœ¬)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-service-green
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-service
      version: green
  template:
    metadata:
      labels:
        app: my-service
        version: green
    spec:
      containers:
      - name: app
        image: myapp:v2
        ports:
        - containerPort: 8080
---
# DestinationRule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: my-service
spec:
  host: my-service
  subsets:
  - name: blue
    labels:
      version: blue
  - name: green
    labels:
      version: green
---
# VirtualService - åˆå§‹çŠ¶æ€: 100%è“
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service
spec:
  hosts:
  - my-service
  http:
  - route:
    - destination:
        host: my-service
        subset: blue
      weight: 100
```

```bash
# æµ‹è¯•ç»¿ç¯å¢ƒ (ä¸å½±å“ç”Ÿäº§æµé‡)
kubectl run test-pod --rm -it --image=curlimages/curl -- sh
curl http://my-service-green:8080

# åˆ‡æ¢åˆ°ç»¿ç¯å¢ƒ
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service
spec:
  hosts:
  - my-service
  http:
  - route:
    - destination:
        host: my-service
        subset: green
      weight: 100
EOF

# ç›‘æ§ç»¿ç¯å¢ƒ
watch -n 1 'kubectl top pod -l version=green'

# å¦‚æœæœ‰é—®é¢˜ï¼Œç«‹å³å›æ»šåˆ°è“ç¯å¢ƒ
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service
spec:
  hosts:
  - my-service
  http:
  - route:
    - destination:
        host: my-service
        subset: blue
      weight: 100
EOF
```

### 3.3 Linkerdè“ç»¿éƒ¨ç½²

```yaml
# è“ç»¿éƒ¨ç½² - Linkerdæ–¹å¼

# åˆ›å»ºè“ç»¿ä¸¤ä¸ªService
apiVersion: v1
kind: Service
metadata:
  name: my-service-blue
spec:
  selector:
    app: my-service
    version: blue
  ports:
  - port: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: my-service-green
spec:
  selector:
    app: my-service
    version: green
  ports:
  - port: 8080
---
# TrafficSplit - åˆå§‹: 100%è“
apiVersion: split.smi-spec.io/v1alpha2
kind: TrafficSplit
metadata:
  name: my-service-split
spec:
  service: my-service
  backends:
  - service: my-service-blue
    weight: 1000  # 100%
  - service: my-service-green
    weight: 0     # 0%
```

```bash
# åˆ‡æ¢åˆ°ç»¿ç¯å¢ƒ
kubectl patch trafficsplit my-service-split --type=merge -p '
spec:
  backends:
  - service: my-service-blue
    weight: 0
  - service: my-service-green
    weight: 1000
'

# ç›‘æ§
linkerd viz stat deploy/my-service-green

# å›æ»šåˆ°è“ç¯å¢ƒ
kubectl patch trafficsplit my-service-split --type=merge -p '
spec:
  backends:
  - service: my-service-blue
    weight: 1000
  - service: my-service-green
    weight: 0
'
```

### 3.4 å¿«é€Ÿå›æ»š

```bash
# è„šæœ¬åŒ–å¿«é€Ÿå›æ»š

#!/bin/bash
# rollback.sh

set -e

SERVICE_NAME="my-service"
ROLLBACK_VERSION="blue"  # æˆ– "green"

echo "Rolling back $SERVICE_NAME to $ROLLBACK_VERSION..."

# Istioæ–¹å¼
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: $SERVICE_NAME
spec:
  hosts:
  - $SERVICE_NAME
  http:
  - route:
    - destination:
        host: $SERVICE_NAME
        subset: $ROLLBACK_VERSION
      weight: 100
EOF

echo "Rollback completed!"

# éªŒè¯
kubectl get virtualservice $SERVICE_NAME -o yaml | grep subset

# é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
curl -X POST https://hooks.slack.com/services/YOUR/WEBHOOK/URL \
  -H 'Content-Type: application/json' \
  -d "{\"text\":\"ğŸ”´ Rollback executed: $SERVICE_NAME â†’ $ROLLBACK_VERSION\"}"
```

---

## 4. A/Bæµ‹è¯•

### 4.1 A/Bæµ‹è¯•åŸç†

```yaml
A/Bæµ‹è¯• (A/B Testing):

å®šä¹‰:
  - ä¹Ÿç§°ä¸ºåˆ†æµæµ‹è¯•æˆ–å¯¹ç…§æµ‹è¯•
  - åŒæ—¶è¿è¡ŒAå’ŒBä¸¤ä¸ªç‰ˆæœ¬
  - ä¸åŒç”¨æˆ·ç¾¤ä½“ä½¿ç”¨ä¸åŒç‰ˆæœ¬
  - é€šè¿‡æ•°æ®å¯¹æ¯”è¯„ä¼°ç‰ˆæœ¬ä¼˜åŠ£

ä¸é‡‘ä¸é›€çš„åŒºåˆ«:
  é‡‘ä¸é›€: åŸºäºé£é™©æ§åˆ¶ï¼Œæ¸è¿›å¼å¢åŠ æµé‡
  A/Bæµ‹è¯•: åŸºäºæ•ˆæœå¯¹æ¯”ï¼Œé•¿æœŸå¹¶è¡Œæµ‹è¯•

æµç¨‹:
  1. å®šä¹‰æµ‹è¯•ç›®æ ‡ (è½¬åŒ–ç‡ã€ç‚¹å‡»ç‡ç­‰)
  2. è®¾è®¡A/Bä¸¤ä¸ªç‰ˆæœ¬
  3. å®šä¹‰ç”¨æˆ·åˆ†ç»„ç­–ç•¥
  4. éƒ¨ç½²A/Bç‰ˆæœ¬
  5. æ”¶é›†æµ‹è¯•æ•°æ®
  6. ç»Ÿè®¡åˆ†æ
  7. é€‰æ‹©æœ€ä¼˜ç‰ˆæœ¬

åˆ†ç»„ç­–ç•¥:
  - åŸºäºç”¨æˆ·ID (å“ˆå¸Œå–æ¨¡)
  - åŸºäºåœ°ç†ä½ç½®
  - åŸºäºè®¾å¤‡ç±»å‹
  - åŸºäºç”¨æˆ·å±æ€§ (VIP/æ™®é€š)
  - åŸºäºCookie/Header

æŒ‡æ ‡:
  - ä¸šåŠ¡æŒ‡æ ‡: è½¬åŒ–ç‡ã€ç‚¹å‡»ç‡ã€è´­ä¹°ç‡
  - æŠ€æœ¯æŒ‡æ ‡: å“åº”æ—¶é—´ã€é”™è¯¯ç‡
  - ç”¨æˆ·æŒ‡æ ‡: åœç•™æ—¶é—´ã€è·³å‡ºç‡
```

### 4.2 åŸºäºHeaderçš„A/Bæµ‹è¯•

```yaml
# Istioå®ç°åŸºäºHeaderçš„A/Bæµ‹è¯•

# DestinationRuleå®šä¹‰ç‰ˆæœ¬
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: my-service
spec:
  host: my-service
  subsets:
  - name: version-a
    labels:
      version: v1
  - name: version-b
    labels:
      version: v2
---
# VirtualServiceå®ç°A/Bè·¯ç”±
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service
spec:
  hosts:
  - my-service
  http:
  # è§„åˆ™1: Chromeç”¨æˆ· â†’ ç‰ˆæœ¬B
  - match:
    - headers:
        user-agent:
          regex: ".*Chrome.*"
    route:
    - destination:
        host: my-service
        subset: version-b

  # è§„åˆ™2: VIPç”¨æˆ· â†’ ç‰ˆæœ¬B
  - match:
    - headers:
        x-user-type:
          exact: "vip"
    route:
    - destination:
        host: my-service
        subset: version-b

  # è§„åˆ™3: é»˜è®¤ â†’ ç‰ˆæœ¬A
  - route:
    - destination:
        host: my-service
        subset: version-a
```

### 4.3 åŸºäºç”¨æˆ·çš„A/Bæµ‹è¯•

```yaml
# åŸºäºç”¨æˆ·IDçš„A/Bæµ‹è¯•

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service-ab-test
spec:
  hosts:
  - my-service
  http:
  # è§„åˆ™1: ç”¨æˆ·IDä¸ºå¶æ•° â†’ ç‰ˆæœ¬B
  - match:
    - headers:
        x-user-id:
          regex: ".*[02468]$"  # ä»¥å¶æ•°ç»“å°¾
    route:
    - destination:
        host: my-service
        subset: version-b

  # è§„åˆ™2: ç”¨æˆ·IDä¸ºå¥‡æ•° â†’ ç‰ˆæœ¬A
  - match:
    - headers:
        x-user-id:
          regex: ".*[13579]$"  # ä»¥å¥‡æ•°ç»“å°¾
    route:
    - destination:
        host: my-service
        subset: version-a

  # è§„åˆ™3: æ— ç”¨æˆ·IDï¼ˆæ–°ç”¨æˆ·ï¼‰â†’ 50/50åˆ†æµ
  - route:
    - destination:
        host: my-service
        subset: version-a
      weight: 50
    - destination:
        host: my-service
        subset: version-b
      weight: 50
```

```python
# åº”ç”¨å±‚è®¾ç½®ç”¨æˆ·ID (Python Flaskç¤ºä¾‹)
from flask import Flask, request, make_response
import hashlib

app = Flask(__name__)

@app.before_request
def set_user_id():
    user_id = request.cookies.get('user_id')
    if not user_id:
        # åŸºäºIPç”Ÿæˆä¸€è‡´çš„ç”¨æˆ·ID
        user_id = hashlib.md5(request.remote_addr.encode()).hexdigest()[:8]

    # è®¾ç½®åˆ°Headerï¼Œä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡
    request.headers.environ['HTTP_X_USER_ID'] = user_id

@app.after_request
def save_user_id(response):
    if not request.cookies.get('user_id'):
        user_id = request.headers.get('x-user-id')
        response.set_cookie('user_id', user_id, max_age=365*24*3600)
    return response
```

### 4.4 A/Bæµ‹è¯•æŒ‡æ ‡æ”¶é›†

```yaml
# åœ¨åº”ç”¨ä¸­æ·»åŠ ç‰ˆæœ¬æ ‡ç­¾ï¼Œä¾¿äºæ•°æ®åˆ†æ
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-service-v2
spec:
  template:
    metadata:
      labels:
        version: v2
    spec:
      containers:
      - name: app
        image: myapp:v2
        env:
        - name: VERSION
          value: "v2"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
```

```python
# åº”ç”¨å±‚è®°å½•A/Bæµ‹è¯•æŒ‡æ ‡
from prometheus_client import Counter, Histogram
import os

VERSION = os.environ.get('VERSION', 'unknown')

# ä¸šåŠ¡æŒ‡æ ‡
button_clicks = Counter(
    'button_clicks_total',
    'Total button clicks',
    ['version', 'button_name']
)

purchase_total = Counter(
    'purchase_total',
    'Total purchases',
    ['version']
)

page_load_time = Histogram(
    'page_load_seconds',
    'Page load time',
    ['version']
)

# è®°å½•äº‹ä»¶
@app.route('/api/click')
def handle_click():
    button_name = request.args.get('button')
    button_clicks.labels(version=VERSION, button_name=button_name).inc()
    return jsonify({"status": "ok"})

@app.route('/api/purchase')
def handle_purchase():
    purchase_total.labels(version=VERSION).inc()
    return jsonify({"status": "ok"})
```

```promql
# PrometheusæŸ¥è¯¢A/Bæµ‹è¯•ç»“æœ

# ç‰ˆæœ¬Aå’ŒBçš„ç‚¹å‡»ç‡å¯¹æ¯”
sum(rate(button_clicks_total{button_name="buy_now"}[1h])) by (version)

# ç‰ˆæœ¬Aå’ŒBçš„è½¬åŒ–ç‡å¯¹æ¯”
sum(rate(purchase_total[1h])) by (version)
/
sum(rate(http_requests_total[1h])) by (version)

# ç‰ˆæœ¬Aå’ŒBçš„å¹³å‡é¡µé¢åŠ è½½æ—¶é—´
sum(rate(page_load_seconds_sum[1h])) by (version)
/
sum(rate(page_load_seconds_count[1h])) by (version)
```

---

## 5. æµé‡é•œåƒ

### 5.1 æµé‡é•œåƒåŸç†

```yaml
æµé‡é•œåƒ (Traffic Mirroring / Shadowing):

å®šä¹‰:
  - å°†ç”Ÿäº§æµé‡å®æ—¶å¤åˆ¶åˆ°æ–°ç‰ˆæœ¬
  - æ–°ç‰ˆæœ¬å¤„ç†è¯·æ±‚ä½†ä¸è¿”å›å“åº”ç»™ç”¨æˆ·
  - ç”¨æˆ·ä»ç„¶æ¥æ”¶æ—§ç‰ˆæœ¬çš„å“åº”
  - ä¹Ÿç§°ä¸º"å½±å­æµé‡"æˆ–"Dark Launch"

ä»·å€¼:
  âœ… çœŸå®æµé‡æµ‹è¯•
  âœ… é›¶é£é™©éªŒè¯
  âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•
  âœ… è´Ÿè½½æµ‹è¯•
  âœ… æ•°æ®æ¨¡å¼éªŒè¯

æµç¨‹:
  1. éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼ˆé•œåƒç‰ˆæœ¬ï¼‰
  2. é…ç½®æµé‡é•œåƒ
  3. ç”Ÿäº§æµé‡ â†’ æ—§ç‰ˆæœ¬ï¼ˆè¿”å›ç»™ç”¨æˆ·ï¼‰
  4. ç”Ÿäº§æµé‡ â†’ æ–°ç‰ˆæœ¬ï¼ˆä¸è¿”å›ï¼Œä»…è®°å½•ï¼‰
  5. ç›‘æ§æ–°ç‰ˆæœ¬è¡¨ç°
  6. éªŒè¯é€šè¿‡åæ­£å¼å‘å¸ƒ

ä½¿ç”¨åœºæ™¯:
  - æ–°ç®—æ³•éªŒè¯
  - æ€§èƒ½æµ‹è¯•
  - æ•°æ®å…¼å®¹æ€§æµ‹è¯•
  - è´Ÿè½½èƒ½åŠ›éªŒè¯
  - Bugå‘ç°

æ³¨æ„äº‹é¡¹:
  âš ï¸  é•œåƒæµé‡ä¸è¿”å›ç»™ç”¨æˆ·
  âš ï¸  ä¸è¦æœ‰å‰¯ä½œç”¨æ“ä½œï¼ˆå†™æ•°æ®åº“ï¼‰
  âš ï¸  èµ„æºæ¶ˆè€—å¢åŠ 
  âš ï¸  ç›‘æ§é•œåƒæœåŠ¡çš„é”™è¯¯
```

### 5.2 Istioæµé‡é•œåƒ

```yaml
# Istioæµé‡é•œåƒé…ç½®

# éƒ¨ç½²v1ï¼ˆç”Ÿäº§ï¼‰å’Œv2ï¼ˆé•œåƒï¼‰
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-service-v1
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-service
      version: v1
  template:
    metadata:
      labels:
        app: my-service
        version: v1
    spec:
      containers:
      - name: app
        image: myapp:v1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-service-v2
spec:
  replicas: 1  # é•œåƒç‰ˆæœ¬ï¼Œå‰¯æœ¬æ•°å¯ä»¥è¾ƒå°‘
  selector:
    matchLabels:
      app: my-service
      version: v2
  template:
    metadata:
      labels:
        app: my-service
        version: v2
    spec:
      containers:
      - name: app
        image: myapp:v2
---
# DestinationRule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: my-service
spec:
  host: my-service
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
# VirtualServiceé…ç½®æµé‡é•œåƒ
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service
spec:
  hosts:
  - my-service
  http:
  - route:
    - destination:
        host: my-service
        subset: v1
      weight: 100
    mirror:
      host: my-service
      subset: v2
    mirrorPercentage:
      value: 100.0  # é•œåƒ100%æµé‡
```

### 5.3 æµé‡é•œåƒå®æˆ˜

```bash
# éƒ¨ç½²æµé‡é•œåƒé…ç½®
kubectl apply -f mirror-config.yaml

# ç›‘æ§v1ï¼ˆç”Ÿäº§ç‰ˆæœ¬ï¼‰
watch -n 1 'kubectl exec deploy/prometheus -c prometheus -- \
  promtool query instant http://localhost:9090 \
  "sum(rate(istio_requests_total{destination_version=\"v1\"}[1m]))"'

# ç›‘æ§v2ï¼ˆé•œåƒç‰ˆæœ¬ï¼‰
watch -n 1 'kubectl exec deploy/prometheus -c prometheus -- \
  promtool query instant http://localhost:9090 \
  "sum(rate(istio_requests_total{destination_version=\"v2\"}[1m]))"'

# å¯¹æ¯”v1å’Œv2çš„é”™è¯¯ç‡
# v1é”™è¯¯ç‡
sum(rate(istio_requests_total{destination_version="v1",response_code=~"5.*"}[1m]))
/
sum(rate(istio_requests_total{destination_version="v1"}[1m]))

# v2é”™è¯¯ç‡
sum(rate(istio_requests_total{destination_version="v2",response_code=~"5.*"}[1m]))
/
sum(rate(istio_requests_total{destination_version="v2"}[1m]))

# å¯¹æ¯”v1å’Œv2çš„å»¶è¿Ÿ
histogram_quantile(0.99,
  sum(rate(istio_request_duration_milliseconds_bucket[1m])) by (le, destination_version)
)

# å¦‚æœv2è¡¨ç°è‰¯å¥½ï¼Œåˆ‡æ¢æµé‡
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service
spec:
  hosts:
  - my-service
  http:
  - route:
    - destination:
        host: my-service
        subset: v2
      weight: 100
EOF
```

---

## 6. æ•…éšœæ³¨å…¥

### 6.1 æ•…éšœæ³¨å…¥çš„ä»·å€¼

```yaml
æ•…éšœæ³¨å…¥ (Fault Injection):

å®šä¹‰:
  - äººä¸ºåœ¨ç³»ç»Ÿä¸­æ³¨å…¥æ•…éšœ
  - æµ‹è¯•ç³»ç»Ÿçš„å®¹é”™èƒ½åŠ›
  - éªŒè¯ç†”æ–­ã€é‡è¯•ã€é™çº§ç­‰æœºåˆ¶

ä»·å€¼:
  âœ… æµ‹è¯•ç³»ç»Ÿå¼¹æ€§
  âœ… å‘ç°éšè—é—®é¢˜
  âœ… éªŒè¯æ•…éšœå¤„ç†
  âœ… æ··æ²Œå·¥ç¨‹å®è·µ
  âœ… æå‡ç³»ç»Ÿå¯é æ€§

æ•…éšœç±»å‹:
  1. å»¶è¿Ÿæ³¨å…¥ (Delay):
     - æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
     - æ¨¡æ‹Ÿæ…¢æŸ¥è¯¢
     - æµ‹è¯•è¶…æ—¶æœºåˆ¶

  2. é”™è¯¯æ³¨å…¥ (Abort):
     - æ¨¡æ‹ŸHTTPé”™è¯¯ (500ã€503)
     - æµ‹è¯•é”™è¯¯å¤„ç†
     - æµ‹è¯•é‡è¯•æœºåˆ¶

  3. ä¸¢åŒ…æ³¨å…¥:
     - æ¨¡æ‹Ÿç½‘ç»œä¸ç¨³å®š
     - æµ‹è¯•è¿æ¥æ¢å¤

ä½¿ç”¨åœºæ™¯:
  - å‹åŠ›æµ‹è¯•
  - æ··æ²Œå·¥ç¨‹
  - æ•…éšœæ¼”ç»ƒ
  - å®¹é”™éªŒè¯
```

### 6.2 å»¶è¿Ÿæ³¨å…¥

```yaml
# Istioå»¶è¿Ÿæ³¨å…¥

# åœºæ™¯: æ¨¡æ‹Ÿæ•°æ®åº“æ…¢æŸ¥è¯¢
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: database-delay
spec:
  hosts:
  - database
  http:
  - fault:
      delay:
        percentage:
          value: 50.0  # 50%çš„è¯·æ±‚
        fixedDelay: 5s  # å»¶è¿Ÿ5ç§’
    route:
    - destination:
        host: database
---
# åœºæ™¯: å¯¹ç‰¹å®šç”¨æˆ·æ³¨å…¥å»¶è¿Ÿï¼ˆæµ‹è¯•ç”¨æˆ·ï¼‰
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service-delay
spec:
  hosts:
  - my-service
  http:
  - match:
    - headers:
        x-user-type:
          exact: "tester"
    fault:
      delay:
        percentage:
          value: 100.0
        fixedDelay: 3s
    route:
    - destination:
        host: my-service
  - route:
    - destination:
        host: my-service
```

### 6.3 é”™è¯¯æ³¨å…¥

```yaml
# Istioé”™è¯¯æ³¨å…¥

# åœºæ™¯1: 50%è¯·æ±‚è¿”å›503é”™è¯¯
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service-abort
spec:
  hosts:
  - my-service
  http:
  - fault:
      abort:
        percentage:
          value: 50.0
        httpStatus: 503
    route:
    - destination:
        host: my-service
---
# åœºæ™¯2: å¯¹ç‰¹å®šè·¯å¾„æ³¨å…¥é”™è¯¯
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: api-abort
spec:
  hosts:
  - api-service
  http:
  - match:
    - uri:
        prefix: "/api/experimental"
    fault:
      abort:
        percentage:
          value: 10.0
        httpStatus: 500
    route:
    - destination:
        host: api-service
  - route:
    - destination:
        host: api-service
---
# åœºæ™¯3: åŒæ—¶æ³¨å…¥å»¶è¿Ÿå’Œé”™è¯¯
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: chaos-test
spec:
  hosts:
  - my-service
  http:
  - fault:
      delay:
        percentage:
          value: 30.0
        fixedDelay: 2s
      abort:
        percentage:
          value: 10.0
        httpStatus: 503
    route:
    - destination:
        host: my-service
```

### 6.4 æ··æ²Œå·¥ç¨‹å®è·µ

```yaml
# ä½¿ç”¨LitmusChaosè¿›è¡Œæ··æ²Œå·¥ç¨‹

# å®‰è£…LitmusChaos
kubectl apply -f https://litmuschaos.github.io/litmus/litmus-operator-v3.0.0.yaml

# åˆ›å»ºæ··æ²Œå®éªŒ
apiVersion: litmuschaos.io/v1alpha1
kind: ChaosEngine
metadata:
  name: nginx-chaos
  namespace: default
spec:
  appinfo:
    appns: default
    applabel: 'app=nginx'
    appkind: deployment
  chaosServiceAccount: litmus-admin
  experiments:
  - name: pod-delete
    spec:
      components:
        env:
        - name: TOTAL_CHAOS_DURATION
          value: '60'
        - name: CHAOS_INTERVAL
          value: '10'
        - name: FORCE
          value: 'false'

  - name: pod-network-latency
    spec:
      components:
        env:
        - name: NETWORK_LATENCY
          value: '2000'  # 2ç§’å»¶è¿Ÿ
        - name: TOTAL_CHAOS_DURATION
          value: '60'

  - name: pod-cpu-hog
    spec:
      components:
        env:
        - name: CPU_CORES
          value: '1'
        - name: TOTAL_CHAOS_DURATION
          value: '60'
```

---

## 7. ç†”æ–­ä¸é™çº§

### 7.1 ç†”æ–­å™¨æ¨¡å¼

```yaml
ç†”æ–­å™¨æ¨¡å¼ (Circuit Breaker Pattern):

çŠ¶æ€æœº:
  1. Closed (å…³é—­):
     - æ­£å¸¸çŠ¶æ€ï¼Œè¯·æ±‚æ­£å¸¸é€šè¿‡
     - ç»Ÿè®¡é”™è¯¯ç‡

  2. Open (æ‰“å¼€):
     - é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼
     - å¿«é€Ÿå¤±è´¥ï¼Œä¸è°ƒç”¨æœåŠ¡
     - ç›´æ¥è¿”å›é”™è¯¯æˆ–é™çº§å“åº”

  3. Half-Open (åŠå¼€):
     - ä¸€æ®µæ—¶é—´åï¼Œå°è¯•å°‘é‡è¯·æ±‚
     - å¦‚æœæˆåŠŸï¼Œè½¬ä¸ºClosed
     - å¦‚æœå¤±è´¥ï¼Œç»§ç»­Open

å‚æ•°:
  - é”™è¯¯é˜ˆå€¼: è§¦å‘ç†”æ–­çš„é”™è¯¯ç‡æˆ–é”™è¯¯æ¬¡æ•°
  - è¶…æ—¶æ—¶é—´: ç­‰å¾…å“åº”çš„æœ€å¤§æ—¶é—´
  - ç†”æ–­æ—¶é—´: OpençŠ¶æ€æŒç»­æ—¶é—´
  - åŠå¼€è¯·æ±‚æ•°: Half-Openæ—¶çš„æµ‹è¯•è¯·æ±‚æ•°

ä»·å€¼:
  âœ… å¿«é€Ÿå¤±è´¥
  âœ… é˜²æ­¢çº§è”æ•…éšœ
  âœ… ä¿æŠ¤ä¸‹æ¸¸æœåŠ¡
  âœ… è‡ªåŠ¨æ¢å¤
```

### 7.2 Istioç†”æ–­é…ç½®

```yaml
# Istio DestinationRuleç†”æ–­é…ç½®

apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: my-service
spec:
  host: my-service
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100  # æœ€å¤§è¿æ¥æ•°
      http:
        http1MaxPendingRequests: 50  # HTTP/1.1æœ€å¤§ç­‰å¾…è¯·æ±‚æ•°
        http2MaxRequests: 100         # HTTP/2æœ€å¤§è¯·æ±‚æ•°
        maxRequestsPerConnection: 2   # æ¯è¿æ¥æœ€å¤§è¯·æ±‚æ•°

    outlierDetection:
      consecutiveErrors: 5            # è¿ç»­é”™è¯¯5æ¬¡
      interval: 30s                    # æ£€æŸ¥é—´éš”30ç§’
      baseEjectionTime: 30s            # é©±é€æ—¶é—´30ç§’
      maxEjectionPercent: 50           # æœ€å¤šé©±é€50%çš„å®ä¾‹
      minHealthPercent: 50             # æœ€å°‘ä¿æŒ50%å¥åº·å®ä¾‹
```

```yaml
# å®Œæ•´çš„ç†”æ–­é…ç½®ç¤ºä¾‹

apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: database-circuit-breaker
spec:
  host: database
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 10
        connectTimeout: 30ms
      http:
        http1MaxPendingRequests: 1
        maxRequestsPerConnection: 1

    outlierDetection:
      consecutiveGatewayErrors: 3     # è¿ç»­ç½‘å…³é”™è¯¯3æ¬¡
      consecutive5xxErrors: 3          # è¿ç»­5xxé”™è¯¯3æ¬¡
      interval: 10s                    # æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
      baseEjectionTime: 30s            # é©±é€30ç§’
      maxEjectionPercent: 100          # æœ€å¤šé©±é€100%
      minHealthPercent: 0              # å…è®¸å…¨éƒ¨é©±é€
```

### 7.3 æœåŠ¡é™çº§

```yaml
# æœåŠ¡é™çº§ç­–ç•¥

# åœºæ™¯1: ä¸»æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œè·¯ç”±åˆ°é™çº§æœåŠ¡
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service-with-fallback
spec:
  hosts:
  - my-service
  http:
  - route:
    - destination:
        host: my-service
        subset: primary
    timeout: 3s
    retries:
      attempts: 2
      perTryTimeout: 1s
    fault:
      abort:
        httpStatus: 503
        percentage:
          value: 50
---
# Envoy Filterå®ç°é™çº§
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: fallback-response
spec:
  workloadSelector:
    labels:
      app: gateway
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.fault
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.http.fault.v3.HTTPFault
          abort:
            http_status: 503
            percentage:
              numerator: 0
              denominator: HUNDRED
```

```python
# åº”ç”¨å±‚é™çº§å®ç°
from functools import wraps
import requests

def fallback_on_error(fallback_func):
    """é™çº§è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            try:
                return func(*args, **kwargs)
            except Exception as e:
                print(f"Error: {e}, falling back...")
                return fallback_func(*args, **kwargs)
        return wrapper
    return decorator

# é™çº§å‡½æ•°
def get_recommendations_fallback(user_id):
    """æ¨èæœåŠ¡é™çº§ï¼šè¿”å›é»˜è®¤æ¨è"""
    return {
        "recommendations": [
            {"id": 1, "name": "çƒ­é—¨å•†å“1"},
            {"id": 2, "name": "çƒ­é—¨å•†å“2"},
        ],
        "source": "fallback"
    }

# ä¸»å‡½æ•°
@fallback_on_error(get_recommendations_fallback)
def get_recommendations(user_id):
    """è·å–ä¸ªæ€§åŒ–æ¨è"""
    response = requests.get(
        f"http://recommendation-service/api/recommend/{user_id}",
        timeout=1
    )
    response.raise_for_status()
    return response.json()
```

### 7.4 è¶…æ—¶ä¸é‡è¯•

```yaml
# Istioè¶…æ—¶å’Œé‡è¯•é…ç½®

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service
spec:
  hosts:
  - my-service
  http:
  - route:
    - destination:
        host: my-service

    # è¶…æ—¶é…ç½®
    timeout: 10s

    # é‡è¯•é…ç½®
    retries:
      attempts: 3                     # é‡è¯•3æ¬¡
      perTryTimeout: 2s               # æ¯æ¬¡å°è¯•è¶…æ—¶2ç§’
      retryOn: 5xx,reset,connect-failure,refused-stream
```

```yaml
# é«˜çº§é‡è¯•ç­–ç•¥

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: advanced-retry
spec:
  hosts:
  - my-service
  http:
  - route:
    - destination:
        host: my-service
    timeout: 10s
    retries:
      attempts: 3
      perTryTimeout: 2s
      retryOn: 5xx,reset,connect-failure
      retryRemoteLocalities: true  # é‡è¯•åˆ°å…¶ä»–åœ°åŸŸçš„å®ä¾‹
```

---

## 8. æµé‡ç®¡ç†å®æˆ˜

### 8.1 ç”µå•†å¤§ä¿ƒåœºæ™¯

```yaml
# ç”µå•†å¤§ä¿ƒå®Œæ•´æµé‡ç®¡ç†æ–¹æ¡ˆ

# 1. æ ¸å¿ƒæœåŠ¡å¤šå‰¯æœ¬ + ç†”æ–­
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
spec:
  replicas: 20  # å¤§ä¿ƒæœŸé—´æ‰©å®¹
  template:
    metadata:
      labels:
        app: order-service
        version: v1
    spec:
      containers:
      - name: order
        image: order-service:v1
        resources:
          requests:
            cpu: "500m"
            memory: "512Mi"
          limits:
            cpu: "2000m"
            memory: "2Gi"
---
# 2. ç†”æ–­ä¿æŠ¤
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: order-service
spec:
  host: order-service
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 1000
      http:
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 10
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
---
# 3. è¶…æ—¶å’Œé‡è¯•
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: order-service
spec:
  hosts:
  - order-service
  http:
  - route:
    - destination:
        host: order-service
    timeout: 5s
    retries:
      attempts: 2
      perTryTimeout: 2s
      retryOn: 5xx,reset
---
# 4. éå…³é”®æœåŠ¡é™çº§
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: recommendation-service
spec:
  hosts:
  - recommendation-service
  http:
  - fault:
      abort:
        percentage:
          value: 80.0  # å¤§ä¿ƒæœŸé—´80%è¯·æ±‚ç›´æ¥è¿”å›ç©º
        httpStatus: 204
    route:
    - destination:
        host: recommendation-service
```

### 8.2 å¾®æœåŠ¡å‡çº§åœºæ™¯

```yaml
# å¾®æœåŠ¡å‡çº§å®Œæ•´æµç¨‹

# é˜¶æ®µ1: éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼ˆ0%æµé‡ï¼‰
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-service-v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: my-service
      version: v2
  template:
    metadata:
      labels:
        app: my-service
        version: v2
    spec:
      containers:
      - name: app
        image: myapp:v2
---
# é˜¶æ®µ2: æµé‡é•œåƒéªŒè¯
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service-mirror
spec:
  hosts:
  - my-service
  http:
  - route:
    - destination:
        host: my-service
        subset: v1
      weight: 100
    mirror:
      host: my-service
      subset: v2
    mirrorPercentage:
      value: 100.0
# ç›‘æ§v2çš„è¡¨ç°...

# é˜¶æ®µ3: 5%é‡‘ä¸é›€
kubectl patch virtualservice my-service --type=merge -p '
spec:
  http:
  - route:
    - destination:
        host: my-service
        subset: v1
      weight: 95
    - destination:
        host: my-service
        subset: v2
      weight: 5
'

# é˜¶æ®µ4: 20%é‡‘ä¸é›€
# é˜¶æ®µ5: 50%é‡‘ä¸é›€
# é˜¶æ®µ6: 100% v2
```

### 8.3 å¤šç‰ˆæœ¬å…±å­˜

```yaml
# åœºæ™¯ï¼šåŒæ—¶ç»´æŠ¤v1ã€v2ã€v3ä¸‰ä¸ªç‰ˆæœ¬

# éƒ¨ç½²ä¸‰ä¸ªç‰ˆæœ¬
# v1: ç¨³å®šç‰ˆï¼ˆè€ç”¨æˆ·ï¼‰
# v2: æ ‡å‡†ç‰ˆï¼ˆæ–°ç”¨æˆ·ï¼‰
# v3: å®éªŒç‰ˆï¼ˆå†…éƒ¨æµ‹è¯•ï¼‰

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-service-multi-version
spec:
  hosts:
  - my-service
  http:
  # è§„åˆ™1: å†…éƒ¨å‘˜å·¥ â†’ v3
  - match:
    - headers:
        x-user-type:
          exact: "internal"
    route:
    - destination:
        host: my-service
        subset: v3

  # è§„åˆ™2: VIPè€ç”¨æˆ· â†’ v1ï¼ˆä¿æŒç¨³å®šï¼‰
  - match:
    - headers:
        x-user-type:
          exact: "vip"
        x-registration-date:
          regex: "^202[0-3].*"  # 2020-2023æ³¨å†Œ
    route:
    - destination:
        host: my-service
        subset: v1

  # è§„åˆ™3: æ–°ç”¨æˆ· â†’ v2
  - match:
    - headers:
        x-registration-date:
          regex: "^202[4-5].*"  # 2024-2025æ³¨å†Œ
    route:
    - destination:
        host: my-service
        subset: v2

  # è§„åˆ™4: é»˜è®¤ â†’ v2ï¼ˆ70%ï¼‰+ v3ï¼ˆ30%ï¼‰
  - route:
    - destination:
        host: my-service
        subset: v2
      weight: 70
    - destination:
        host: my-service
        subset: v3
      weight: 30
```

---

## 9. æœ€ä½³å®è·µ

```yaml
æµé‡ç®¡ç†æœ€ä½³å®è·µ:

å‘å¸ƒç­–ç•¥é€‰æ‹©:
  1. æ—¥å¸¸è¿­ä»£:
     âœ… é‡‘ä¸é›€å‘å¸ƒï¼ˆ5% â†’ 10% â†’ 25% â†’ 50% â†’ 100%ï¼‰
     âœ… è‡ªåŠ¨åŒ–ï¼ˆFlaggerï¼‰
     âœ… åŸºäºæŒ‡æ ‡çš„è‡ªåŠ¨å†³ç­–

  2. å¤§ç‰ˆæœ¬å‡çº§:
     âœ… å…ˆæµé‡é•œåƒéªŒè¯
     âœ… å†è“ç»¿éƒ¨ç½²
     âœ… å¿«é€Ÿå›æ»šæœºåˆ¶

  3. æ–°åŠŸèƒ½éªŒè¯:
     âœ… A/Bæµ‹è¯•
     âœ… é•¿æœŸå¹¶è¡Œ
     âœ… æ•°æ®é©±åŠ¨å†³ç­–

  4. ç´§æ€¥ä¿®å¤:
     âœ… è“ç»¿éƒ¨ç½²
     âœ… å¿«é€Ÿåˆ‡æ¢
     âœ… ç«‹å³å›æ»šèƒ½åŠ›

ç›‘æ§æŒ‡æ ‡:
  1. æŠ€æœ¯æŒ‡æ ‡:
     âœ… é”™è¯¯ç‡ (<1%)
     âœ… P99å»¶è¿Ÿ (<500ms)
     âœ… æˆåŠŸç‡ (>99.9%)
     âœ… QPSè¶‹åŠ¿

  2. ä¸šåŠ¡æŒ‡æ ‡:
     âœ… è®¢å•é‡
     âœ… æ”¯ä»˜æˆåŠŸç‡
     âœ… ç”¨æˆ·æ´»è·ƒåº¦
     âœ… è½¬åŒ–ç‡

  3. å¯¹æ¯”åˆ†æ:
     âœ… æ–°æ—§ç‰ˆæœ¬å¯¹æ¯”
     âœ… åŒæ¯”ç¯æ¯”
     âœ… å¼‚å¸¸æ£€æµ‹

å›æ»šç­–ç•¥:
  1. è‡ªåŠ¨å›æ»š:
     - é”™è¯¯ç‡ > 5%
     - P99å»¶è¿Ÿ > 1s
     - æˆåŠŸç‡ < 95%

  2. æ‰‹åŠ¨å›æ»š:
     - ä¸šåŠ¡æŒ‡æ ‡å¼‚å¸¸
     - ç”¨æˆ·æŠ•è¯‰å¢åŠ 
     - å‘ç°ä¸¥é‡bug

  3. å›æ»šé€Ÿåº¦:
     âœ… è“ç»¿: ç§’çº§
     âœ… é‡‘ä¸é›€: åˆ†é’Ÿçº§
     âœ… æ»šåŠ¨: è¾ƒæ…¢

ç†”æ–­é…ç½®:
  1. å…³é”®æœåŠ¡:
     - consecutiveErrors: 3
     - interval: 10s
     - baseEjectionTime: 30s

  2. ä¸€èˆ¬æœåŠ¡:
     - consecutiveErrors: 5
     - interval: 30s
     - baseEjectionTime: 60s

  3. éå…³é”®æœåŠ¡:
     - å¯ä»¥æ›´å®½æ¾
     - æˆ–ç›´æ¥é™çº§

è¶…æ—¶é…ç½®:
  1. å¿«é€ŸæœåŠ¡ (ç¼“å­˜ã€é…ç½®):
     - timeout: 1s
     - retries: 2

  2. ä¸€èˆ¬æœåŠ¡ (API):
     - timeout: 3s
     - retries: 2

  3. æ…¢æœåŠ¡ (æŠ¥è¡¨ã€å¤§æŸ¥è¯¢):
     - timeout: 30s
     - retries: 0

æ•…éšœæ¼”ç»ƒ:
  âœ… å®šæœŸæ³¨å…¥æ•…éšœ
  âœ… éªŒè¯ç†”æ–­æœºåˆ¶
  âœ… éªŒè¯é™çº§ç­–ç•¥
  âœ… éªŒè¯ç›‘æ§å‘Šè­¦
  âœ… éªŒè¯å›æ»šæµç¨‹
```

---

## 10. æ€»ç»“

### 10.1 æµé‡ç®¡ç†æ ¸å¿ƒä»·å€¼

```yaml
æœåŠ¡ç½‘æ ¼æµé‡ç®¡ç†ä»·å€¼:

1. é™ä½é£é™©:
   âœ… æ¸è¿›å¼å‘å¸ƒ
   âœ… å¿«é€Ÿå›æ»š
   âœ… æ•…éšœéš”ç¦»
   âœ… å½±å“èŒƒå›´å¯æ§

2. æå‡æ•ˆç‡:
   âœ… æ— éœ€ä¿®æ”¹ä»£ç 
   âœ… ç»Ÿä¸€ç®¡ç†
   âœ… è‡ªåŠ¨åŒ–å‘å¸ƒ
   âœ… é…ç½®å³ä»£ç 

3. å¢å¼ºå¼¹æ€§:
   âœ… è‡ªåŠ¨ç†”æ–­
   âœ… æœåŠ¡é™çº§
   âœ… è¶…æ—¶é‡è¯•
   âœ… è´Ÿè½½å‡è¡¡

4. æ”¯æŒåˆ›æ–°:
   âœ… A/Bæµ‹è¯•
   âœ… ç°åº¦å‘å¸ƒ
   âœ… å¤šç‰ˆæœ¬å¹¶è¡Œ
   âœ… å¿«é€Ÿè¿­ä»£

5. å¯è§‚æµ‹æ€§:
   âœ… å®æ—¶ç›‘æ§
   âœ… æµé‡å¯è§†åŒ–
   âœ… æ€§èƒ½å¯¹æ¯”
   âœ… é—®é¢˜å®šä½
```

### 10.2 Istio vs Linkerdæµé‡ç®¡ç†å¯¹æ¯”

```yaml
Istioæµé‡ç®¡ç†:
  ä¼˜åŠ¿:
    âœ… åŠŸèƒ½æœ€å…¨é¢
    âœ… VirtualServiceå¼ºå¤§
    âœ… æµé‡é•œåƒæ”¯æŒ
    âœ… æ•…éšœæ³¨å…¥ä¸°å¯Œ
    âœ… ç†”æ–­é…ç½®ç»†ç²’åº¦

  é€‚ç”¨:
    - å¤æ‚æµé‡è·¯ç”±
    - é«˜çº§æ•…éšœæ³¨å…¥
    - ç»†ç²’åº¦ç†”æ–­æ§åˆ¶

Linkerdæµé‡ç®¡ç†:
  ä¼˜åŠ¿:
    âœ… ç®€å•æ˜“ç”¨
    âœ… TrafficSplitæ ‡å‡†
    âœ… æ€§èƒ½ä¼˜ç§€
    âœ… å¼€ç®±å³ç”¨

  é™åˆ¶:
    âŒ ä¸æ”¯æŒæµé‡é•œåƒ
    âŒ ä¸æ”¯æŒæ•…éšœæ³¨å…¥
    âŒ ç†”æ–­é…ç½®æœ‰é™

  é€‚ç”¨:
    - ç®€å•æµé‡åˆ†å‰²
    - é‡‘ä¸é›€å‘å¸ƒ
    - è“ç»¿éƒ¨ç½²
    - æ€§èƒ½æ•æ„Ÿåœºæ™¯

é€‰æ‹©å»ºè®®:
  - éœ€è¦é«˜çº§åŠŸèƒ½ â†’ Istio
  - è¿½æ±‚ç®€å•æ€§èƒ½ â†’ Linkerd
  - å¯ä»¥æ··åˆä½¿ç”¨
```

### 10.3 æœªæ¥å±•æœ›

```yaml
æµé‡ç®¡ç†è¶‹åŠ¿:

1. AI/MLé©±åŠ¨:
   - æ™ºèƒ½æµé‡è°ƒåº¦
   - è‡ªåŠ¨å¼‚å¸¸æ£€æµ‹
   - æ™ºèƒ½å›æ»šå†³ç­–
   - é¢„æµ‹æ€§æ‰©ç¼©å®¹

2. æ›´ç»†ç²’åº¦:
   - è¯·æ±‚çº§åˆ«è·¯ç”±
   - ç”¨æˆ·çº§åˆ«æ§åˆ¶
   - å®æ—¶åŠ¨æ€è°ƒæ•´

3. æ›´è‡ªåŠ¨åŒ–:
   - GitOpsé›†æˆ
   - è‡ªåŠ¨åŒ–é‡‘ä¸é›€
   - è‡ªåŠ¨åŒ–å›æ»š
   - é›¶äººå·¥å¹²é¢„

4. å¤šäº‘ç»Ÿä¸€:
   - è·¨äº‘æµé‡ç®¡ç†
   - ç»Ÿä¸€æµé‡ç­–ç•¥
   - å…¨å±€è´Ÿè½½å‡è¡¡

5. æ€§èƒ½ä¼˜åŒ–:
   - eBPFåŠ é€Ÿ
   - Ambient Mesh
   - æ›´ä½å»¶è¿Ÿ
   - æ›´é«˜åå
```

---

**æœ¬ç« å®Œæˆï¼** âœ…

**ä¸‹ä¸€ç« é¢„å‘Š**: [06_å¯è§‚æµ‹æ€§ä¸ç›‘æ§](./06_å¯è§‚æµ‹æ€§ä¸ç›‘æ§.md)

**ç›¸å…³ç« èŠ‚**:

- [02_Istioæ·±åº¦è§£æ](./02_Istioæ·±åº¦è§£æ.md)
- [03_Linkerdè½»é‡çº§æœåŠ¡ç½‘æ ¼](./03_Linkerdè½»é‡çº§æœåŠ¡ç½‘æ ¼.md)
- [04_æœåŠ¡ç½‘æ ¼å®‰å…¨](./04_æœåŠ¡ç½‘æ ¼å®‰å…¨.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-19
**ä½œè€…**: vSphere & Container Technology Team
**å­—æ•°**: çº¦15,000å­—
**ä»£ç ç¤ºä¾‹**: 45+ä¸ª

---

## ç›¸å…³æ–‡æ¡£

### æœ¬æ¨¡å—ç›¸å…³

- [æœåŠ¡ç½‘æ ¼æ¦‚è¿°ä¸æ¶æ„](./01_æœåŠ¡ç½‘æ ¼æ¦‚è¿°ä¸æ¶æ„.md) - æœåŠ¡ç½‘æ ¼æ¦‚è¿°ä¸æ¶æ„
- [Istioæ·±åº¦è§£æ](./02_Istioæ·±åº¦è§£æ.md) - Istioæ·±åº¦è§£æ
- [Linkerdè½»é‡çº§æœåŠ¡ç½‘æ ¼](./03_Linkerdè½»é‡çº§æœåŠ¡ç½‘æ ¼.md) - Linkerdè½»é‡çº§æœåŠ¡ç½‘æ ¼
- [æœåŠ¡ç½‘æ ¼å®‰å…¨](./04_æœåŠ¡ç½‘æ ¼å®‰å…¨.md) - æœåŠ¡ç½‘æ ¼å®‰å…¨
- [å¯è§‚æµ‹æ€§ä¸ç›‘æ§](./06_å¯è§‚æµ‹æ€§ä¸ç›‘æ§.md) - å¯è§‚æµ‹æ€§ä¸ç›‘æ§
- [å¤šé›†ç¾¤æœåŠ¡ç½‘æ ¼](./07_å¤šé›†ç¾¤æœåŠ¡ç½‘æ ¼.md) - å¤šé›†ç¾¤æœåŠ¡ç½‘æ ¼
- [æœåŠ¡ç½‘æ ¼æ€§èƒ½ä¼˜åŒ–ä¸æ•…éšœæ’æŸ¥](./08_æœåŠ¡ç½‘æ ¼æ€§èƒ½ä¼˜åŒ–ä¸æ•…éšœæ’æŸ¥.md) - æ€§èƒ½ä¼˜åŒ–ä¸æ•…éšœæ’æŸ¥
- [README.md](./README.md) - æœ¬æ¨¡å—å¯¼èˆª

### å…¶ä»–æ¨¡å—ç›¸å…³

- [KubernetesæŠ€æœ¯è¯¦è§£](../03_KubernetesæŠ€æœ¯è¯¦è§£/README.md) - KubernetesæŠ€æœ¯ä½“ç³»
- [KubernetesæœåŠ¡å‘ç°](../03_KubernetesæŠ€æœ¯è¯¦è§£/03_æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡.md) - K8sæœåŠ¡å‘ç°
- [å®¹å™¨ç¼–æ’æŠ€æœ¯](../04_å®¹å™¨ç¼–æ’æŠ€æœ¯/README.md) - å®¹å™¨ç¼–æ’æŠ€æœ¯
- [å®¹å™¨ç›‘æ§æŠ€æœ¯](../06_å®¹å™¨ç›‘æ§ä¸è¿ç»´/01_å®¹å™¨ç›‘æ§æŠ€æœ¯.md) - å®¹å™¨ç›‘æ§æŠ€æœ¯

---

**æœ€åæ›´æ–°**: 2025å¹´11æœˆ11æ—¥
**ç»´æŠ¤çŠ¶æ€**: æŒç»­æ›´æ–°
