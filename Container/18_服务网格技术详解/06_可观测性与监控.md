# å¯è§‚æµ‹æ€§ä¸ç›‘æ§

## ç›®å½•

- [å¯è§‚æµ‹æ€§ä¸ç›‘æ§](#å¯è§‚æµ‹æ€§ä¸ç›‘æ§)
  - [ç›®å½•](#ç›®å½•)
  - [1. å¯è§‚æµ‹æ€§æ¦‚è¿°](#1-å¯è§‚æµ‹æ€§æ¦‚è¿°)
    - [1.1 å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±](#11-å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±)
    - [1.2 æœåŠ¡ç½‘æ ¼å¯è§‚æµ‹æ€§ä¼˜åŠ¿](#12-æœåŠ¡ç½‘æ ¼å¯è§‚æµ‹æ€§ä¼˜åŠ¿)
    - [1.3 å¯è§‚æµ‹æ€§æ¶æ„](#13-å¯è§‚æµ‹æ€§æ¶æ„)
  - [2. Prometheusç›‘æ§](#2-prometheusç›‘æ§)
    - [2.1 Prometheusæ¶æ„](#21-prometheusæ¶æ„)
    - [2.2 Istio Prometheusé›†æˆ](#22-istio-prometheusé›†æˆ)
      - [2.2.1 éƒ¨ç½²Prometheus](#221-éƒ¨ç½²prometheus)
      - [2.2.2 Istioæš´éœ²çš„æŒ‡æ ‡](#222-istioæš´éœ²çš„æŒ‡æ ‡)
    - [2.3 Linkerd Prometheusé›†æˆ](#23-linkerd-prometheusé›†æˆ)
    - [2.4 å…³é”®æŒ‡æ ‡](#24-å…³é”®æŒ‡æ ‡)
    - [2.5 PromQLæŸ¥è¯¢](#25-promqlæŸ¥è¯¢)
  - [3. Jaegeråˆ†å¸ƒå¼è¿½è¸ª](#3-jaegeråˆ†å¸ƒå¼è¿½è¸ª)
    - [3.1 åˆ†å¸ƒå¼è¿½è¸ªåŸç†](#31-åˆ†å¸ƒå¼è¿½è¸ªåŸç†)
    - [3.2 Istio Jaegeré›†æˆ](#32-istio-jaegeré›†æˆ)
    - [3.3 è¿½è¸ªåˆ†æ](#33-è¿½è¸ªåˆ†æ)
    - [3.4 æ€§èƒ½ä¼˜åŒ–](#34-æ€§èƒ½ä¼˜åŒ–)
  - [4. Grafanaå¯è§†åŒ–](#4-grafanaå¯è§†åŒ–)
    - [4.1 Grafana Dashboard](#41-grafana-dashboard)
    - [4.2 Istio Dashboard](#42-istio-dashboard)
    - [4.3 Linkerd Dashboard](#43-linkerd-dashboard)
    - [4.4 è‡ªå®šä¹‰Dashboard](#44-è‡ªå®šä¹‰dashboard)
  - [5. Lokiæ—¥å¿—èšåˆ](#5-lokiæ—¥å¿—èšåˆ)
    - [5.1 Lokiæ¶æ„](#51-lokiæ¶æ„)
    - [5.2 æ—¥å¿—æ”¶é›†](#52-æ—¥å¿—æ”¶é›†)
    - [5.3 æ—¥å¿—æŸ¥è¯¢](#53-æ—¥å¿—æŸ¥è¯¢)
    - [5.4 æ—¥å¿—å…³è”](#54-æ—¥å¿—å…³è”)
  - [6. OpenTelemetryæ ‡å‡†](#6-opentelemetryæ ‡å‡†)
    - [6.1 OpenTelemetryæ¦‚è¿°](#61-opentelemetryæ¦‚è¿°)
    - [6.2 æœåŠ¡ç½‘æ ¼é›†æˆ](#62-æœåŠ¡ç½‘æ ¼é›†æˆ)
    - [6.3 ç»Ÿä¸€å¯è§‚æµ‹æ€§](#63-ç»Ÿä¸€å¯è§‚æµ‹æ€§)
  - [7. SLI/SLO/SLA](#7-slislosla)
    - [7.1 æ¦‚å¿µä¸åŒºåˆ«](#71-æ¦‚å¿µä¸åŒºåˆ«)
    - [7.2 å®šä¹‰SLI](#72-å®šä¹‰sli)
    - [7.3 è®¾ç½®SLO](#73-è®¾ç½®slo)
    - [7.4 é”™è¯¯é¢„ç®—](#74-é”™è¯¯é¢„ç®—)
  - [8. å‘Šè­¦é…ç½®](#8-å‘Šè­¦é…ç½®)
    - [8.1 Alertmanageré…ç½®](#81-alertmanageré…ç½®)
    - [8.2 å‘Šè­¦è§„åˆ™](#82-å‘Šè­¦è§„åˆ™)
    - [8.3 é€šçŸ¥é›†æˆ](#83-é€šçŸ¥é›†æˆ)
    - [8.4 å‘Šè­¦æœ€ä½³å®è·µ](#84-å‘Šè­¦æœ€ä½³å®è·µ)
  - [9. å¯è§‚æµ‹æ€§å®æˆ˜](#9-å¯è§‚æµ‹æ€§å®æˆ˜)
    - [9.1 å®Œæ•´å¯è§‚æµ‹æ€§æ ˆ](#91-å®Œæ•´å¯è§‚æµ‹æ€§æ ˆ)
    - [9.2 æ•…éšœæ’æŸ¥æ¡ˆä¾‹](#92-æ•…éšœæ’æŸ¥æ¡ˆä¾‹)
    - [9.3 æ€§èƒ½åˆ†ææ¡ˆä¾‹](#93-æ€§èƒ½åˆ†ææ¡ˆä¾‹)
  - [10. æ€»ç»“](#10-æ€»ç»“)
    - [10.1 å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±](#101-å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±)
    - [10.2 æœåŠ¡ç½‘æ ¼å¯è§‚æµ‹æ€§ä¼˜åŠ¿](#102-æœåŠ¡ç½‘æ ¼å¯è§‚æµ‹æ€§ä¼˜åŠ¿)
    - [10.3 æœ€ä½³å®è·µæ€»ç»“](#103-æœ€ä½³å®è·µæ€»ç»“)
    - [10.4 å·¥å…·å¯¹æ¯”](#104-å·¥å…·å¯¹æ¯”)
    - [10.5 æœªæ¥å±•æœ›](#105-æœªæ¥å±•æœ›)

---

## 1. å¯è§‚æµ‹æ€§æ¦‚è¿°

### 1.1 å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±

```yaml
å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±:

1. Metrics (æŒ‡æ ‡):
   å®šä¹‰: æ—¶é—´åºåˆ—æ•°æ®ï¼Œé‡åŒ–ç³»ç»ŸçŠ¶æ€
   
   ç±»å‹:
     - Counter (è®¡æ•°å™¨): ç´¯è®¡å€¼ï¼ˆè¯·æ±‚æ•°ã€é”™è¯¯æ•°ï¼‰
     - Gauge (æµ‹é‡å€¼): ç¬æ—¶å€¼ï¼ˆCPUã€å†…å­˜ã€æ´»è·ƒè¿æ¥æ•°ï¼‰
     - Histogram (ç›´æ–¹å›¾): åˆ†å¸ƒæƒ…å†µï¼ˆå»¶è¿Ÿåˆ†å¸ƒï¼‰
     - Summary (æ‘˜è¦): ç™¾åˆ†ä½æ•°ï¼ˆP50ã€P95ã€P99ï¼‰
   
   ä»·å€¼:
     âœ… å®æ—¶ç›‘æ§
     âœ… è¶‹åŠ¿åˆ†æ
     âœ… å‘Šè­¦è§¦å‘
     âœ… å®¹é‡è§„åˆ’
   
   ç¤ºä¾‹:
     - è¯·æ±‚æˆåŠŸç‡
     - è¯·æ±‚å»¶è¿Ÿ
     - ååé‡
     - é”™è¯¯ç‡

2. Tracing (è¿½è¸ª):
   å®šä¹‰: è¯·æ±‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å®Œæ•´è·¯å¾„
   
   æ¦‚å¿µ:
     - Trace (è·Ÿè¸ª): å®Œæ•´çš„è¯·æ±‚é“¾è·¯
     - Span (è·¨åº¦): å•ä¸ªæ“ä½œï¼ˆæœåŠ¡è°ƒç”¨ï¼‰
     - Parent/Child Span: çˆ¶å­å…³ç³»
   
   ä»·å€¼:
     âœ… è°ƒç”¨é“¾å¯è§†åŒ–
     âœ… æ€§èƒ½ç“¶é¢ˆå®šä½
     âœ… ä¾èµ–å…³ç³»åˆ†æ
     âœ… æ•…éšœæ ¹å› åˆ†æ
   
   ç¤ºä¾‹:
     - ç”¨æˆ·è¯·æ±‚ â†’ Gateway â†’ Service A â†’ Service B â†’ Database
     - æ¯ä¸ªç¯èŠ‚çš„è€—æ—¶
     - è°ƒç”¨å…³ç³»å›¾

3. Logging (æ—¥å¿—):
   å®šä¹‰: äº‹ä»¶çš„ç¦»æ•£è®°å½•
   
   ç±»å‹:
     - åº”ç”¨æ—¥å¿—: ä¸šåŠ¡é€»è¾‘æ—¥å¿—
     - è®¿é—®æ—¥å¿—: HTTPè¯·æ±‚æ—¥å¿—
     - ç³»ç»Ÿæ—¥å¿—: åŸºç¡€è®¾æ–½æ—¥å¿—
     - å®¡è®¡æ—¥å¿—: å®‰å…¨å®¡è®¡æ—¥å¿—
   
   ä»·å€¼:
     âœ… è¯¦ç»†ä¸Šä¸‹æ–‡
     âœ… é—®é¢˜è¯Šæ–­
     âœ… å®¡è®¡è¿½è¸ª
     âœ… å®‰å…¨åˆ†æ
   
   ç¤ºä¾‹:
     - é”™è¯¯å †æ ˆ
     - è¯·æ±‚è¯¦æƒ…
     - ç”¨æˆ·æ“ä½œ
     - ç³»ç»Ÿäº‹ä»¶

ä¸‰è€…å…³ç³»:
  Metrics: å‘Šè¯‰ä½ "æœ‰é—®é¢˜"ï¼ˆWhatï¼‰
  Tracing: å‘Šè¯‰ä½ "é—®é¢˜åœ¨å“ª"ï¼ˆWhereï¼‰
  Logging: å‘Šè¯‰ä½ "é—®é¢˜è¯¦æƒ…"ï¼ˆWhyï¼‰

å®Œæ•´æµç¨‹:
  1. Metricså‘ç°å¼‚å¸¸ï¼ˆè¯·æ±‚æˆåŠŸç‡ä¸‹é™ï¼‰
  2. Tracingå®šä½é—®é¢˜æœåŠ¡ï¼ˆService Bæ…¢ï¼‰
  3. LoggingæŸ¥çœ‹è¯¦ç»†é”™è¯¯ï¼ˆæ•°æ®åº“è¿æ¥è¶…æ—¶ï¼‰
```

### 1.2 æœåŠ¡ç½‘æ ¼å¯è§‚æµ‹æ€§ä¼˜åŠ¿

```yaml
æœåŠ¡ç½‘æ ¼ vs ä¼ ç»Ÿæ–¹å¼:

ä¼ ç»Ÿæ–¹å¼:
  âŒ æ¯ä¸ªæœåŠ¡ç‹¬ç«‹å®ç°
  âŒ æŒ‡æ ‡æ ¼å¼ä¸ä¸€è‡´
  âŒ éš¾ä»¥å…³è”
  âŒ ä¾µå…¥å¼åŸ‹ç‚¹
  âŒ ç»´æŠ¤æˆæœ¬é«˜

æœåŠ¡ç½‘æ ¼:
  âœ… è‡ªåŠ¨é‡‡é›†
  âœ… ç»Ÿä¸€æ ¼å¼
  âœ… è‡ªåŠ¨å…³è”
  âœ… éä¾µå…¥å¼
  âœ… å¼€ç®±å³ç”¨

æœåŠ¡ç½‘æ ¼å¯è§‚æµ‹æ€§ä¼˜åŠ¿:

1. è‡ªåŠ¨æŒ‡æ ‡é‡‡é›†:
   âœ… Sidecarè‡ªåŠ¨é‡‡é›†
   âœ… æ— éœ€ä¿®æ”¹ä»£ç 
   âœ… æ ‡å‡†åŒ–æŒ‡æ ‡
   âœ… å…¨å±€ä¸€è‡´

2. åˆ†å¸ƒå¼è¿½è¸ª:
   âœ… è‡ªåŠ¨æ³¨å…¥Trace Header
   âœ… å®Œæ•´è°ƒç”¨é“¾
   âœ… æ€§èƒ½åˆ†æ
   âœ… ä¾èµ–å…³ç³»å›¾

3. è®¿é—®æ—¥å¿—:
   âœ… ç»Ÿä¸€æ ¼å¼
   âœ… ä¸°å¯Œä¸Šä¸‹æ–‡
   âœ… è‡ªåŠ¨æ”¶é›†
   âœ… ç»“æ„åŒ–æ—¥å¿—

4. æ‹“æ‰‘å¯è§†åŒ–:
   âœ… æœåŠ¡ä¾èµ–å›¾
   âœ… å®æ—¶æµé‡
   âœ… å¥åº·çŠ¶æ€
   âœ… æ€§èƒ½çƒ­å›¾

5. ç»Ÿä¸€ç®¡ç†:
   âœ… é›†ä¸­é…ç½®
   âœ… ç»Ÿä¸€æŸ¥è¯¢
   âœ… å…³è”åˆ†æ
   âœ… ä¸€ç«™å¼å¹³å°
```

### 1.3 å¯è§‚æµ‹æ€§æ¶æ„

```yaml
æœåŠ¡ç½‘æ ¼å¯è§‚æµ‹æ€§æ¶æ„:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº”ç”¨ä¸æœåŠ¡                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Service A â”‚  â”‚Service B â”‚  â”‚Service C â”‚  â”‚Service D â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚             â”‚             â”‚             â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Sidecar  â”‚  â”‚ Sidecar  â”‚  â”‚ Sidecar  â”‚  â”‚ Sidecar  â”‚  â”‚
â”‚  â”‚  Proxy   â”‚  â”‚  Proxy   â”‚  â”‚  Proxy   â”‚  â”‚  Proxy   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚             â”‚
        â”‚ Metrics     â”‚ Traces      â”‚ Logs        â”‚
        â–¼             â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é‡‡é›†ä¸å­˜å‚¨å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Prometheusâ”‚  â”‚  Jaeger  â”‚  â”‚   Loki   â”‚  â”‚  Other   â”‚  â”‚
â”‚  â”‚  (æŒ‡æ ‡)  â”‚  â”‚  (è¿½è¸ª)  â”‚  â”‚  (æ—¥å¿—)  â”‚  â”‚          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚             â”‚
        â–¼             â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¯è§†åŒ–ä¸å‘Šè­¦å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Grafana                          â”‚  â”‚
â”‚  â”‚  - ç»Ÿä¸€å¯è§†åŒ–                                        â”‚  â”‚
â”‚  â”‚  - å¤šæ•°æ®æº                                          â”‚  â”‚
â”‚  â”‚  â”‚  - Dashboard                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                 Alertmanager                        â”‚  â”‚
â”‚  â”‚  - å‘Šè­¦èšåˆ                                          â”‚  â”‚
â”‚  â”‚  - é€šçŸ¥è·¯ç”±                                          â”‚  â”‚
â”‚  â”‚  - æŠ‘åˆ¶ä¸é™é»˜                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•°æ®æµ:
  1. Sidecaré‡‡é›†æŒ‡æ ‡ã€è¿½è¸ªã€æ—¥å¿—
  2. æ•°æ®å‘é€åˆ°å¯¹åº”å­˜å‚¨ï¼ˆPrometheus/Jaeger/Lokiï¼‰
  3. Grafanaç»Ÿä¸€æŸ¥è¯¢å’Œå¯è§†åŒ–
  4. Alertmanagerå¤„ç†å‘Šè­¦å’Œé€šçŸ¥

å…³é”®ç»„ä»¶:
  - Envoy/Linkerd Proxy: æ•°æ®é‡‡é›†
  - Prometheus: æŒ‡æ ‡å­˜å‚¨
  - Jaeger: è¿½è¸ªå­˜å‚¨
  - Loki: æ—¥å¿—èšåˆ
  - Grafana: ç»Ÿä¸€å¯è§†åŒ–
  - Alertmanager: å‘Šè­¦ç®¡ç†
```

---

## 2. Prometheusç›‘æ§

### 2.1 Prometheusæ¶æ„

```yaml
Prometheusæ¶æ„:

æ ¸å¿ƒç»„ä»¶:
  1. Prometheus Server:
     - æ•°æ®é‡‡é›†ï¼ˆPullæ¨¡å¼ï¼‰
     - æ—¶é—´åºåˆ—æ•°æ®åº“
     - PromQLæŸ¥è¯¢å¼•æ“
  
  2. Exporters:
     - æš´éœ²æŒ‡æ ‡çš„HTTPç«¯ç‚¹
     - /metrics
  
  3. Pushgateway:
     - çŸ­æœŸä»»åŠ¡æŒ‡æ ‡æ¨é€
     - Pushæ¨¡å¼æ”¯æŒ
  
  4. Alertmanager:
     - å‘Šè­¦å¤„ç†
     - é€šçŸ¥è·¯ç”±
  
  5. Service Discovery:
     - Kubernetes SD
     - Consul SD
     - é™æ€é…ç½®

æ•°æ®æ¨¡å‹:
  <metric name>{<label name>=<label value>, ...} value timestamp
  
  ç¤ºä¾‹:
  istio_requests_total{
    destination_service="my-service",
    destination_version="v1",
    response_code="200"
  } 1234 1634567890

ç‰¹ç‚¹:
  âœ… å¤šç»´æ•°æ®æ¨¡å‹
  âœ… å¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€ï¼ˆPromQLï¼‰
  âœ… é«˜æ•ˆå­˜å‚¨
  âœ… æ‹‰å–æ¨¡å¼ï¼ˆPullï¼‰
  âœ… æœåŠ¡å‘ç°
```

### 2.2 Istio Prometheusé›†æˆ

#### 2.2.1 éƒ¨ç½²Prometheus

```yaml
# ä½¿ç”¨Istio addonéƒ¨ç½²Prometheus
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.21/samples/addons/prometheus.yaml

# è®¿é—®Prometheus
kubectl port-forward -n istio-system svc/prometheus 9090:9090

# æµè§ˆå™¨è®¿é—®: http://localhost:9090
```

#### 2.2.2 Istioæš´éœ²çš„æŒ‡æ ‡

```yaml
Istioæ ¸å¿ƒæŒ‡æ ‡:

1. è¯·æ±‚æŒ‡æ ‡:
   istio_requests_total: è¯·æ±‚æ€»æ•°
   istio_request_duration_milliseconds: è¯·æ±‚å»¶è¿Ÿ
   istio_request_bytes: è¯·æ±‚å¤§å°
   istio_response_bytes: å“åº”å¤§å°

2. TCPæŒ‡æ ‡:
   istio_tcp_connections_opened_total: TCPè¿æ¥æ‰“å¼€
   istio_tcp_connections_closed_total: TCPè¿æ¥å…³é—­
   istio_tcp_sent_bytes_total: å‘é€å­—èŠ‚æ•°
   istio_tcp_received_bytes_total: æ¥æ”¶å­—èŠ‚æ•°

3. PilotæŒ‡æ ‡:
   pilot_xds_pushes: é…ç½®æ¨é€æ¬¡æ•°
   pilot_proxy_convergence_time: é…ç½®æ”¶æ•›æ—¶é—´

4. GalleyæŒ‡æ ‡:
   galley_validation_passed: éªŒè¯é€šè¿‡æ•°
   galley_validation_failed: éªŒè¯å¤±è´¥æ•°

æ ‡ç­¾ç»´åº¦:
  - source_workload: æºå·¥ä½œè´Ÿè½½
  - destination_workload: ç›®æ ‡å·¥ä½œè´Ÿè½½
  - source_version: æºç‰ˆæœ¬
  - destination_version: ç›®æ ‡ç‰ˆæœ¬
  - response_code: å“åº”ç 
  - connection_security_policy: mTLSçŠ¶æ€
```

### 2.3 Linkerd Prometheusé›†æˆ

```yaml
# Linkerdå†…ç½®Prometheus

# å®‰è£…Linkerd Vizï¼ˆåŒ…å«Prometheusï¼‰
linkerd viz install | kubectl apply -f -

# è®¿é—®Prometheus
linkerd viz dashboard

# æˆ–ç›´æ¥è®¿é—®
kubectl port-forward -n linkerd-viz svc/prometheus 9090:9090
```

```yaml
Linkerdæ ¸å¿ƒæŒ‡æ ‡:

1. é»„é‡‘æŒ‡æ ‡:
   request_total: è¯·æ±‚æ€»æ•°
   response_total: å“åº”æ€»æ•°
   response_latency_ms: å“åº”å»¶è¿Ÿ
   
2. æˆåŠŸç‡:
   success_rate = 
     sum(response_total{classification="success"}) 
     / 
     sum(response_total)

3. æµé‡æŒ‡æ ‡:
   inbound_http_requests_total
   outbound_http_requests_total

4. TCPæŒ‡æ ‡:
   tcp_open_connections
   tcp_read_bytes_total
   tcp_write_bytes_total

æ ‡ç­¾ç»´åº¦:
  - namespace
  - deployment
  - pod
  - direction (inbound/outbound)
  - tls (true/false)
```

### 2.4 å…³é”®æŒ‡æ ‡

```yaml
ç”Ÿäº§ç¯å¢ƒå…³é”®æŒ‡æ ‡:

1. å››å¤§é»„é‡‘ä¿¡å· (Google SRE):
   
   a. Latency (å»¶è¿Ÿ):
      P50å»¶è¿Ÿ: ä¸­ä½æ•°
      P95å»¶è¿Ÿ: 95%è¯·æ±‚
      P99å»¶è¿Ÿ: 99%è¯·æ±‚
      
   b. Traffic (æµé‡):
      QPS (Queries Per Second)
      RPS (Requests Per Second)
      
   c. Errors (é”™è¯¯):
      é”™è¯¯ç‡ = é”™è¯¯è¯·æ±‚æ•° / æ€»è¯·æ±‚æ•°
      5xxé”™è¯¯ç‡
      4xxé”™è¯¯ç‡
      
   d. Saturation (é¥±å’Œåº¦):
      CPUä½¿ç”¨ç‡
      å†…å­˜ä½¿ç”¨ç‡
      è¿æ¥æ•°

2. REDæŒ‡æ ‡ (Rate, Errors, Duration):
   Rate: è¯·æ±‚é€Ÿç‡
   Errors: é”™è¯¯ç‡
   Duration: å»¶è¿Ÿåˆ†å¸ƒ

3. USEæŒ‡æ ‡ (Utilization, Saturation, Errors):
   Utilization: èµ„æºä½¿ç”¨ç‡
   Saturation: èµ„æºé¥±å’Œåº¦
   Errors: é”™è¯¯æ•°

4. æœåŠ¡ç½‘æ ¼ç‰¹å®šæŒ‡æ ‡:
   mTLSè¦†ç›–ç‡
   é…ç½®æ¨é€å»¶è¿Ÿ
   Sidecarèµ„æºæ¶ˆè€—
   è¿æ¥æ± çŠ¶æ€
```

### 2.5 PromQLæŸ¥è¯¢

```promql
# 1. æˆåŠŸç‡æŸ¥è¯¢
sum(rate(istio_requests_total{response_code=~"2.*"}[5m])) 
/ 
sum(rate(istio_requests_total[5m])) * 100

# 2. P99å»¶è¿ŸæŸ¥è¯¢
histogram_quantile(0.99, 
  sum(rate(istio_request_duration_milliseconds_bucket[5m])) 
  by (le, destination_service)
)

# 3. QPSæŸ¥è¯¢
sum(rate(istio_requests_total[1m])) by (destination_service)

# 4. é”™è¯¯ç‡æŸ¥è¯¢
sum(rate(istio_requests_total{response_code=~"5.*"}[5m])) 
/ 
sum(rate(istio_requests_total[5m])) * 100

# 5. æŒ‰ç‰ˆæœ¬å¯¹æ¯”å»¶è¿Ÿ
histogram_quantile(0.95,
  sum(rate(istio_request_duration_milliseconds_bucket[5m])) 
  by (le, destination_version)
)

# 6. mTLSä½¿ç”¨ç‡
sum(istio_requests_total{connection_security_policy="mutual_tls"}) 
/ 
sum(istio_requests_total) * 100

# 7. Top 5æ…¢æœåŠ¡
topk(5, 
  histogram_quantile(0.99,
    sum(rate(istio_request_duration_milliseconds_bucket[5m])) 
    by (le, destination_service)
  )
)

# 8. æœåŠ¡é—´æµé‡
sum(rate(istio_requests_total[1m])) 
by (source_workload, destination_workload)

# 9. CPUä½¿ç”¨ç‡
sum(rate(container_cpu_usage_seconds_total[5m])) 
by (pod) * 100

# 10. å†…å­˜ä½¿ç”¨
container_memory_working_set_bytes / 1024 / 1024
```

---

## 3. Jaegeråˆ†å¸ƒå¼è¿½è¸ª

### 3.1 åˆ†å¸ƒå¼è¿½è¸ªåŸç†

```yaml
åˆ†å¸ƒå¼è¿½è¸ªåŸç†:

æ ¸å¿ƒæ¦‚å¿µ:

1. Trace (è·Ÿè¸ª):
   - å®Œæ•´çš„è¯·æ±‚é“¾è·¯
   - å”¯ä¸€Trace ID
   - åŒ…å«å¤šä¸ªSpan

2. Span (è·¨åº¦):
   - å•ä¸ªæ“ä½œæˆ–æœåŠ¡è°ƒç”¨
   - å”¯ä¸€Span ID
   - çˆ¶Span IDï¼ˆParent IDï¼‰
   - å¼€å§‹æ—¶é—´
   - æŒç»­æ—¶é—´
   - Tagsï¼ˆæ ‡ç­¾ï¼‰
   - Logsï¼ˆæ—¥å¿—äº‹ä»¶ï¼‰

3. Context Propagation (ä¸Šä¸‹æ–‡ä¼ æ’­):
   - HTTP Headersä¼ é€’Traceä¿¡æ¯
   - æ ‡å‡†Headers:
     - x-request-id
     - x-b3-traceid
     - x-b3-spanid
     - x-b3-parentspanid
     - x-b3-sampled
     - x-b3-flags

ç¤ºä¾‹Trace:

User Request
  â”‚
  â””â”€> Gateway (Span 1, 100ms)
        â”‚
        â”œâ”€> Service A (Span 2, 50ms)
        â”‚     â”‚
        â”‚     â””â”€> Database (Span 3, 30ms)
        â”‚
        â””â”€> Service B (Span 4, 40ms)
              â”‚
              â””â”€> Cache (Span 5, 10ms)

Trace ID: abc123
Spans:
  - Span 1: Gateway, 100ms, parent=null
  - Span 2: Service A, 50ms, parent=Span 1
  - Span 3: Database, 30ms, parent=Span 2
  - Span 4: Service B, 40ms, parent=Span 1
  - Span 5: Cache, 10ms, parent=Span 4

é‡‡æ ·ç­–ç•¥:
  - Always: 100%é‡‡æ ·
  - Never: 0%é‡‡æ ·
  - Probabilistic: æ¦‚ç‡é‡‡æ ·ï¼ˆ1%, 10%ï¼‰
  - Rate Limiting: é™é€Ÿé‡‡æ ·ï¼ˆ100 traces/sï¼‰
```

### 3.2 Istio Jaegeré›†æˆ

```yaml
# éƒ¨ç½²Jaeger
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.21/samples/addons/jaeger.yaml

# é…ç½®Istioå¯ç”¨è¿½è¸ª
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  meshConfig:
    enableTracing: true
    defaultConfig:
      tracing:
        sampling: 100.0  # 100%é‡‡æ ·ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®1-10%ï¼‰
        zipkin:
          address: jaeger-collector.istio-system.svc:9411

# è®¿é—®Jaeger UI
kubectl port-forward -n istio-system svc/jaeger-query 16686:16686

# æµè§ˆå™¨è®¿é—®: http://localhost:16686
```

```yaml
# åº”ç”¨éœ€è¦ä¼ æ’­Trace Headers

# Python Flaskç¤ºä¾‹
from flask import Flask, request
import requests

app = Flask(__name__)

# éœ€è¦ä¼ æ’­çš„Headers
TRACE_HEADERS = [
    'x-request-id',
    'x-b3-traceid',
    'x-b3-spanid',
    'x-b3-parentspanid',
    'x-b3-sampled',
    'x-b3-flags',
    'x-ot-span-context'
]

@app.route('/api/users')
def get_users():
    # æå–Trace Headers
    headers = {}
    for header in TRACE_HEADERS:
        if header in request.headers:
            headers[header] = request.headers[header]
    
    # è°ƒç”¨ä¸‹æ¸¸æœåŠ¡ï¼Œä¼ é€’Headers
    response = requests.get(
        'http://user-service/users',
        headers=headers
    )
    
    return response.json()
```

### 3.3 è¿½è¸ªåˆ†æ

```yaml
Jaegerè¿½è¸ªåˆ†æ:

1. æŸ¥çœ‹Trace:
   - é€‰æ‹©Service
   - è®¾ç½®æ—¶é—´èŒƒå›´
   - ç­›é€‰Tags
   - æŸ¥çœ‹Traceåˆ—è¡¨

2. Traceè¯¦æƒ…:
   - å®Œæ•´è°ƒç”¨é“¾
   - æ¯ä¸ªSpançš„è€—æ—¶
   - æ—¶é—´ç€‘å¸ƒå›¾
   - Tagså’ŒLogs

3. æ€§èƒ½åˆ†æ:
   - è¯†åˆ«æ…¢Span
   - æ‰¾å‡ºç“¶é¢ˆæœåŠ¡
   - åˆ†æä¸²è¡Œ/å¹¶è¡Œè°ƒç”¨
   - ä¼˜åŒ–æœºä¼š

4. ä¾èµ–å…³ç³»:
   - Service Graph
   - æœåŠ¡ä¾èµ–å›¾
   - è°ƒç”¨é¢‘ç‡
   - é”™è¯¯ç‡

5. å¼‚å¸¸è¿½è¸ª:
   - é”™è¯¯Spanæ ‡è®°
   - é”™è¯¯å †æ ˆ
   - é”™è¯¯ä¼ æ’­è·¯å¾„
```

### 3.4 æ€§èƒ½ä¼˜åŒ–

```yaml
è¿½è¸ªæ€§èƒ½ä¼˜åŒ–:

1. é‡‡æ ·ç‡è°ƒæ•´:
   ç”Ÿäº§ç¯å¢ƒå»ºè®®:
     - é«˜æµé‡æœåŠ¡: 1-5%
     - ä¸­æµé‡æœåŠ¡: 10%
     - ä½æµé‡æœåŠ¡: 100%
   
   åŸå› :
     - é™ä½å­˜å‚¨å‹åŠ›
     - å‡å°‘ç½‘ç»œå¼€é”€
     - ä¿æŒæ€§èƒ½

2. è‡ªé€‚åº”é‡‡æ ·:
   apiVersion: install.istio.io/v1alpha1
   kind: IstioOperator
   spec:
     meshConfig:
       defaultConfig:
         tracing:
           sampling: 1.0  # åŸºç¡€é‡‡æ ·ç‡1%
           custom_tags:
             user_type:
               header:
                 name: x-user-type
           # é‡è¦ç”¨æˆ·100%é‡‡æ ·
           # æ™®é€šç”¨æˆ·1%é‡‡æ ·

3. å¼‚æ­¥ä¸ŠæŠ¥:
   - ä½¿ç”¨å¼‚æ­¥å®¢æˆ·ç«¯
   - æ‰¹é‡ä¸ŠæŠ¥
   - æœ¬åœ°ç¼“å†²

4. å­˜å‚¨ä¼˜åŒ–:
   - è®¾ç½®TTLï¼ˆTime To Liveï¼‰
   - å®šæœŸæ¸…ç†æ—§æ•°æ®
   - ä½¿ç”¨Elasticsearché›†ç¾¤
```

---

## 4. Grafanaå¯è§†åŒ–

### 4.1 Grafana Dashboard

```yaml
# éƒ¨ç½²Grafana
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.21/samples/addons/grafana.yaml

# è®¿é—®Grafana
kubectl port-forward -n istio-system svc/grafana 3000:3000

# æµè§ˆå™¨è®¿é—®: http://localhost:3000
# é»˜è®¤ç”¨æˆ·å/å¯†ç : admin/admin
```

```yaml
Grafanaæ ¸å¿ƒåŠŸèƒ½:

1. æ•°æ®æºç®¡ç†:
   - Prometheus
   - Jaeger
   - Loki
   - Elasticsearch
   - InfluxDB

2. Dashboard:
   - é¢„ç½®Dashboard
   - è‡ªå®šä¹‰Dashboard
   - å˜é‡æ”¯æŒ
   - æ¨¡æ¿åŒ–

3. å‘Šè­¦:
   - å¯è§†åŒ–å‘Šè­¦è§„åˆ™
   - å¤šç§é€šçŸ¥æ¸ é“
   - å‘Šè­¦å†å²

4. é¢æ¿ç±»å‹:
   - Graph (å›¾è¡¨)
   - Stat (ç»Ÿè®¡)
   - Gauge (ä»ªè¡¨ç›˜)
   - Table (è¡¨æ ¼)
   - Heatmap (çƒ­å›¾)
   - Logs (æ—¥å¿—)
```

### 4.2 Istio Dashboard

```yaml
Istioé¢„ç½®Dashboard:

1. Istio Mesh Dashboard:
   - å…¨å±€æµé‡æ¦‚è§ˆ
   - æˆåŠŸç‡
   - QPS
   - P50/P95/P99å»¶è¿Ÿ

2. Istio Service Dashboard:
   - å•æœåŠ¡è¯¦æƒ…
   - å…¥ç«™/å‡ºç«™æµé‡
   - å®¢æˆ·ç«¯/æœåŠ¡ç«¯æŒ‡æ ‡
   - ç‰ˆæœ¬å¯¹æ¯”

3. Istio Workload Dashboard:
   - å·¥ä½œè´Ÿè½½è¯¦æƒ…
   - CPU/å†…å­˜ä½¿ç”¨
   - ç½‘ç»œæµé‡
   - è¯·æ±‚æŒ‡æ ‡

4. Istio Performance Dashboard:
   - æ§åˆ¶å¹³é¢æ€§èƒ½
   - PilotæŒ‡æ ‡
   - é…ç½®æ¨é€å»¶è¿Ÿ
   - Envoyæ€§èƒ½

5. Istio Wasm Extension Dashboard:
   - WebAssemblyæ‰©å±•æŒ‡æ ‡
   - æ‰§è¡Œæ—¶é—´
   - å†…å­˜ä½¿ç”¨
```

### 4.3 Linkerd Dashboard

```yaml
# Linkerd Dashboardï¼ˆå†…ç½®Grafanaï¼‰
linkerd viz dashboard

# æˆ–ç›´æ¥è®¿é—®Grafana
kubectl port-forward -n linkerd-viz svc/grafana 3000:3000
```

```yaml
Linkerdé¢„ç½®Dashboard:

1. Linkerd Top Line:
   - å…¨å±€æˆåŠŸç‡
   - å…¨å±€RPS
   - å…¨å±€P95/P99å»¶è¿Ÿ

2. Linkerd Deployment:
   - éƒ¨ç½²çº§åˆ«æŒ‡æ ‡
   - æˆåŠŸç‡è¶‹åŠ¿
   - æµé‡è¶‹åŠ¿
   - å»¶è¿Ÿè¶‹åŠ¿

3. Linkerd Pod:
   - Podçº§åˆ«æŒ‡æ ‡
   - èµ„æºä½¿ç”¨
   - ç½‘ç»œæµé‡
   - TCPæŒ‡æ ‡

4. Linkerd Authority:
   - æœåŠ¡é—´æµé‡
   - è·¯ç”±æŒ‡æ ‡
   - mTLSçŠ¶æ€

5. Linkerd Namespace:
   - å‘½åç©ºé—´çº§åˆ«æ±‡æ€»
   - æˆåŠŸç‡
   - æµé‡åˆ†å¸ƒ
```

### 4.4 è‡ªå®šä¹‰Dashboard

```json
// Grafana Dashboard JSONç¤ºä¾‹
{
  "dashboard": {
    "title": "æœåŠ¡ç½‘æ ¼è‡ªå®šä¹‰ç›‘æ§",
    "panels": [
      {
        "id": 1,
        "title": "æœåŠ¡æˆåŠŸç‡",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(istio_requests_total{response_code=~\"2.*\"}[5m])) / sum(rate(istio_requests_total[5m])) * 100"
          }
        ]
      },
      {
        "id": 2,
        "title": "P99å»¶è¿Ÿ",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.99, sum(rate(istio_request_duration_milliseconds_bucket[5m])) by (le, destination_service))"
          }
        ]
      },
      {
        "id": 3,
        "title": "QPS",
        "type": "stat",
        "targets": [
          {
            "expr": "sum(rate(istio_requests_total[1m]))"
          }
        ]
      },
      {
        "id": 4,
        "title": "é”™è¯¯ç‡",
        "type": "gauge",
        "targets": [
          {
            "expr": "sum(rate(istio_requests_total{response_code=~\"5.*\"}[5m])) / sum(rate(istio_requests_total[5m])) * 100"
          }
        ],
        "thresholds": [
          {"value": 0, "color": "green"},
          {"value": 1, "color": "yellow"},
          {"value": 5, "color": "red"}
        ]
      }
    ]
  }
}
```

```yaml
# Dashboardæœ€ä½³å®è·µ

1. å±‚æ¬¡åŒ–ç›‘æ§:
   - L1: å…¨å±€æ¦‚è§ˆï¼ˆMeshçº§åˆ«ï¼‰
   - L2: æœåŠ¡çº§åˆ«
   - L3: å·¥ä½œè´Ÿè½½çº§åˆ«
   - L4: Podçº§åˆ«

2. å…³é”®æŒ‡æ ‡ä¼˜å…ˆ:
   - æˆåŠŸç‡ï¼ˆæœ€é‡è¦ï¼‰
   - å»¶è¿Ÿï¼ˆP95/P99ï¼‰
   - QPS/RPS
   - é”™è¯¯ç‡

3. ä½¿ç”¨å˜é‡:
   - Namespaceå˜é‡
   - Serviceå˜é‡
   - Versionå˜é‡
   - æ—¶é—´èŒƒå›´å˜é‡

4. å‘Šè­¦å¯è§†åŒ–:
   - é˜ˆå€¼çº¿
   - é¢œè‰²ç¼–ç 
   - å‘Šè­¦çŠ¶æ€é¢æ¿

5. é“¾æ¥å…³è”:
   - Dashboardé—´è·³è½¬
   - Jaegerè¿½è¸ªé“¾æ¥
   - æ—¥å¿—é“¾æ¥
```

---

## 5. Lokiæ—¥å¿—èšåˆ

### 5.1 Lokiæ¶æ„

```yaml
Lokiæ¶æ„:

æ ¸å¿ƒç»„ä»¶:

1. Promtail (æ—¥å¿—é‡‡é›†å™¨):
   - å‘ç°Pod
   - é‡‡é›†æ—¥å¿—
   - æ ‡ç­¾æå–
   - æ¨é€åˆ°Loki

2. Loki (æ—¥å¿—å­˜å‚¨):
   - æ—¥å¿—ç´¢å¼•ï¼ˆä»…ç´¢å¼•æ ‡ç­¾ï¼‰
   - æ—¥å¿—å­˜å‚¨
   - æŸ¥è¯¢API

3. Grafana (æŸ¥è¯¢ç•Œé¢):
   - LogQLæŸ¥è¯¢
   - æ—¥å¿—æµè§ˆ
   - ä¸Metricså…³è”

ç‰¹ç‚¹:
  âœ… åªç´¢å¼•æ ‡ç­¾ï¼ˆé™ä½æˆæœ¬ï¼‰
  âœ… ä½¿ç”¨ä¸Prometheusç›¸åŒçš„æ ‡ç­¾
  âœ… LogQLæŸ¥è¯¢è¯­è¨€
  âœ… ä¸Grafanaæ·±åº¦é›†æˆ
  âœ… æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
```

### 5.2 æ—¥å¿—æ”¶é›†

```yaml
# éƒ¨ç½²Loki Stack
kubectl apply -f https://raw.githubusercontent.com/grafana/loki/main/production/ksonnet/loki-stack/loki-stack.yaml

# æˆ–ä½¿ç”¨Helm
helm repo add grafana https://grafana.github.io/helm-charts
helm install loki grafana/loki-stack \
  --set promtail.enabled=true \
  --set grafana.enabled=true
```

```yaml
# Promtailé…ç½®ç¤ºä¾‹
apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: loki
data:
  promtail.yaml: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: http://loki:3100/loki/api/v1/push

    scrape_configs:
      # Kubernetes Podæ—¥å¿—
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
        
        relabel_configs:
          # æå–Podæ ‡ç­¾
          - source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app
          - source_labels: [__meta_kubernetes_pod_label_version]
            target_label: version
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          
          # æ–‡ä»¶è·¯å¾„
          - source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
            target_label: __path__
            separator: /
            replacement: /var/log/pods/*$1/*.log

      # Envoyè®¿é—®æ—¥å¿—
      - job_name: envoy-access-log
        kubernetes_sd_configs:
          - role: pod
        
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_container_name]
            action: keep
            regex: istio-proxy
          
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
```

### 5.3 æ—¥å¿—æŸ¥è¯¢

```logql
# LogQLæŸ¥è¯¢ç¤ºä¾‹

# 1. æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„æ—¥å¿—
{app="my-service"}

# 2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
{app="my-service"} |= "error"

# 3. æŸ¥çœ‹HTTP 500é”™è¯¯
{app="my-service"} | json | status_code="500"

# 4. æ­£åˆ™è¿‡æ»¤
{app="my-service"} |~ "ERROR|WARN"

# 5. æ’é™¤ç‰¹å®šæ—¥å¿—
{app="my-service"} != "health check"

# 6. èšåˆæŸ¥è¯¢ï¼ˆQPSï¼‰
rate({app="my-service"}[1m])

# 7. é”™è¯¯ç‡
sum(rate({app="my-service"} |= "error"[5m])) 
/ 
sum(rate({app="my-service"}[5m]))

# 8. Top 10é”™è¯¯
topk(10, 
  sum by (error_message) (
    count_over_time({app="my-service"} |= "error" [1h])
  )
)

# 9. å»¶è¿Ÿç»Ÿè®¡
quantile_over_time(0.99, 
  {app="my-service"} | json | unwrap latency [5m]
)

# 10. å¤šæ ‡ç­¾æŸ¥è¯¢
{namespace="prod", app="my-service", version="v2"}
```

### 5.4 æ—¥å¿—å…³è”

```yaml
æ—¥å¿—ä¸Metrics/Traceså…³è”:

1. Trace IDå…³è”:
   # æ—¥å¿—ä¸­åŒ…å«Trace ID
   {app="my-service"} | json | trace_id="abc123"
   
   # åœ¨Grafanaä¸­:
   - Metricså‘ç°å¼‚å¸¸
   - ç‚¹å‡»TraceæŸ¥çœ‹è°ƒç”¨é“¾
   - ç‚¹å‡»SpanæŸ¥çœ‹å¯¹åº”æ—¥å¿—
   - ä¸€é”®è·³è½¬

2. æ—¶é—´å…³è”:
   # åœ¨Grafanaä¸­é€‰æ‹©æ—¶é—´èŒƒå›´
   # è‡ªåŠ¨åŒæ­¥Metricsã€Tracesã€Logs
   
3. æ ‡ç­¾å…³è”:
   # ä½¿ç”¨ç›¸åŒçš„æ ‡ç­¾
   - namespace
   - app
   - version
   - pod
   
   # Prometheusæ ‡ç­¾
   istio_requests_total{destination_service="my-service"}
   
   # Lokiæ ‡ç­¾
   {app="my-service"}
   
   # ä¸€è‡´æ€§ä¿è¯å…³è”

4. å‘Šè­¦å…³è”:
   # å‘Šè­¦è§¦å‘æ—¶
   - æ˜¾ç¤ºMetricså›¾è¡¨
   - æ˜¾ç¤ºç›¸å…³Traces
   - æ˜¾ç¤ºé”™è¯¯æ—¥å¿—
   - ä¸€é”®æ•…éšœæ’æŸ¥
```

---

## 6. OpenTelemetryæ ‡å‡†

### 6.1 OpenTelemetryæ¦‚è¿°

```yaml
OpenTelemetry (OTel):

å®šä¹‰:
  - CNCFé¡¹ç›®
  - ç»Ÿä¸€çš„å¯è§‚æµ‹æ€§æ ‡å‡†
  - åˆå¹¶OpenTracingå’ŒOpenCensus
  - ä¾›åº”å•†ä¸­ç«‹

æ ¸å¿ƒç»„ä»¶:

1. API/SDK:
   - åº”ç”¨ç¨‹åºé›†æˆ
   - å¤šè¯­è¨€æ”¯æŒï¼ˆJavaã€Pythonã€Goã€Node.js...ï¼‰
   - Metricsã€Tracesã€Logs

2. Collector:
   - æ•°æ®æ¥æ”¶
   - æ•°æ®å¤„ç†
   - æ•°æ®å¯¼å‡º
   - å¤šåè®®æ”¯æŒ

3. Protocol (OTLP):
   - ç»Ÿä¸€åè®®
   - gRPC/HTTP
   - é«˜æ•ˆä¼ è¾“

ä¼˜åŠ¿:
  âœ… ç»Ÿä¸€æ ‡å‡†
  âœ… ä¾›åº”å•†ä¸­ç«‹
  âœ… è‡ªåŠ¨åŒ–Instrumentation
  âœ… å¤šåç«¯æ”¯æŒ
  âœ… ç¤¾åŒºæ´»è·ƒ
```

### 6.2 æœåŠ¡ç½‘æ ¼é›†æˆ

```yaml
# éƒ¨ç½²OpenTelemetry Collector
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: istio-system
data:
  config.yaml: |
    receivers:
      # Zipkinåè®®ï¼ˆIstioé»˜è®¤ï¼‰
      zipkin:
        endpoint: 0.0.0.0:9411
      
      # OTLPåè®®
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      # æ‰¹å¤„ç†
      batch:
        timeout: 10s
        send_batch_size: 1024
      
      # é‡‡æ ·
      probabilistic_sampler:
        sampling_percentage: 10

    exporters:
      # å¯¼å‡ºåˆ°Jaeger
      jaeger:
        endpoint: jaeger-collector:14250
        tls:
          insecure: true
      
      # å¯¼å‡ºåˆ°Prometheus
      prometheus:
        endpoint: 0.0.0.0:8889
      
      # å¯¼å‡ºåˆ°Loki
      loki:
        endpoint: http://loki:3100/loki/api/v1/push

    service:
      pipelines:
        traces:
          receivers: [zipkin, otlp]
          processors: [batch, probabilistic_sampler]
          exporters: [jaeger]
        
        metrics:
          receivers: [otlp]
          processors: [batch]
          exporters: [prometheus]

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: otel-collector
  namespace: istio-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: otel-collector
  template:
    metadata:
      labels:
        app: otel-collector
    spec:
      containers:
      - name: otel-collector
        image: otel/opentelemetry-collector:0.91.0
        args:
          - "--config=/etc/otel-collector-config.yaml"
        volumeMounts:
        - name: config
          mountPath: /etc/otel-collector-config.yaml
          subPath: config.yaml
        ports:
        - containerPort: 9411  # Zipkin
        - containerPort: 4317  # OTLP gRPC
        - containerPort: 4318  # OTLP HTTP
        - containerPort: 8889  # Prometheus
      volumes:
      - name: config
        configMap:
          name: otel-collector-config
```

```yaml
# Istioé…ç½®ä½¿ç”¨OpenTelemetry Collector
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  meshConfig:
    enableTracing: true
    defaultConfig:
      tracing:
        sampling: 100.0
        zipkin:
          address: otel-collector.istio-system.svc:9411
```

### 6.3 ç»Ÿä¸€å¯è§‚æµ‹æ€§

```yaml
OpenTelemetryç»Ÿä¸€å¯è§‚æµ‹æ€§:

ä¼˜åŠ¿:

1. ç»Ÿä¸€é‡‡é›†:
   âœ… Metricsã€Tracesã€Logsç»Ÿä¸€API
   âœ… è‡ªåŠ¨å…³è”
   âœ… ä¸€è‡´çš„æ ‡ç­¾

2. çµæ´»å¯¼å‡º:
   âœ… å¤šåç«¯æ”¯æŒ
   - Prometheus
   - Jaeger
   - Zipkin
   - Elasticsearch
   - Datadog
   - New Relic
   - äº‘å‚å•†ï¼ˆAWS X-Rayã€Google Cloud Traceï¼‰

3. ä¾›åº”å•†ä¸­ç«‹:
   âœ… é¿å…ä¾›åº”å•†é”å®š
   âœ… è‡ªç”±åˆ‡æ¢åç«¯
   âœ… å¤šåç«¯å¹¶è¡Œ

4. è‡ªåŠ¨åŒ–Instrumentation:
   âœ… æ— éœ€ä¿®æ”¹ä»£ç 
   âœ… è‡ªåŠ¨æ³¨å…¥
   âœ… å¤šè¯­è¨€æ”¯æŒ

æ¶æ„:

Application (auto-instrumented)
    â”‚
    â”‚ OTLP
    â–¼
OpenTelemetry Collector
    â”‚
    â”œâ”€> Jaeger (Traces)
    â”œâ”€> Prometheus (Metrics)
    â”œâ”€> Loki (Logs)
    â”œâ”€> Elasticsearch (All)
    â””â”€> Cloud Providers
```

---

## 7. SLI/SLO/SLA

### 7.1 æ¦‚å¿µä¸åŒºåˆ«

```yaml
SLI/SLO/SLAæ¦‚å¿µ:

1. SLI (Service Level Indicator) - æœåŠ¡çº§åˆ«æŒ‡æ ‡:
   å®šä¹‰: é‡åŒ–æœåŠ¡è´¨é‡çš„æŒ‡æ ‡
   
   ç¤ºä¾‹:
     - è¯·æ±‚æˆåŠŸç‡
     - P95å»¶è¿Ÿ
     - å¯ç”¨æ€§
     - ååé‡
   
   è¡¨è¾¾:
     æˆåŠŸç‡ SLI = æˆåŠŸè¯·æ±‚æ•° / æ€»è¯·æ±‚æ•°

2. SLO (Service Level Objective) - æœåŠ¡çº§åˆ«ç›®æ ‡:
   å®šä¹‰: SLIçš„ç›®æ ‡å€¼
   
   ç¤ºä¾‹:
     - æˆåŠŸç‡ â‰¥ 99.9%
     - P95å»¶è¿Ÿ â‰¤ 500ms
     - å¯ç”¨æ€§ â‰¥ 99.95%
   
   è¡¨è¾¾:
     "è¿‡å»30å¤©ï¼ŒæˆåŠŸç‡â‰¥99.9%"

3. SLA (Service Level Agreement) - æœåŠ¡çº§åˆ«åè®®:
   å®šä¹‰: ä¸å®¢æˆ·çš„æ­£å¼åˆåŒ
   
   åŒ…å«:
     - SLOç›®æ ‡
     - æµ‹é‡æ–¹æ³•
     - è¿ååæœï¼ˆèµ”å¿ï¼‰
   
   ç¤ºä¾‹:
     "æœˆåº¦å¯ç”¨æ€§â‰¥99.9%ï¼Œå¦åˆ™èµ”å¿10%è´¹ç”¨"

å…³ç³»:
  SLI âŠ‚ SLO âŠ‚ SLA
  
  SLI: æµ‹é‡ä»€ä¹ˆ
  SLO: ç›®æ ‡æ˜¯å¤šå°‘
  SLA: è¿åäº†æ€ä¹ˆåŠ
```

### 7.2 å®šä¹‰SLI

```yaml
å¸¸è§SLIå®šä¹‰:

1. å¯ç”¨æ€§ SLI:
   æˆåŠŸç‡ = æˆåŠŸè¯·æ±‚æ•° / æ€»è¯·æ±‚æ•°
   
   PromQL:
   sum(rate(istio_requests_total{response_code=~"2.*|3.*"}[1h])) 
   / 
   sum(rate(istio_requests_total[1h]))

2. å»¶è¿Ÿ SLI:
   P95å»¶è¿Ÿ < 500ms
   
   PromQL:
   histogram_quantile(0.95,
     sum(rate(istio_request_duration_milliseconds_bucket[5m])) 
     by (le)
   ) < 500

3. ååé‡ SLI:
   QPS â‰¥ 1000
   
   PromQL:
   sum(rate(istio_requests_total[1m])) >= 1000

4. é”™è¯¯ç‡ SLI:
   é”™è¯¯ç‡ < 0.1%
   
   PromQL:
   sum(rate(istio_requests_total{response_code=~"5.*"}[5m])) 
   / 
   sum(rate(istio_requests_total[5m])) < 0.001
```

### 7.3 è®¾ç½®SLO

```yaml
SLOè®¾ç½®ç¤ºä¾‹:

æœåŠ¡: æ”¯ä»˜æœåŠ¡
SLI: æˆåŠŸç‡
SLO: 99.9% (30å¤©)

è®¡ç®—:
  30å¤© = 43,200åˆ†é’Ÿ
  å…è®¸æ•…éšœæ—¶é—´ = 43,200 * (1 - 0.999) = 43.2åˆ†é’Ÿ

Prometheus Recording Rule:
```

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-slo-rules
  namespace: istio-system
data:
  slo-rules.yaml: |
    groups:
      - name: slo
        interval: 30s
        rules:
          # æˆåŠŸç‡ SLI
          - record: sli:request_success_rate:ratio
            expr: |
              sum(rate(istio_requests_total{response_code=~"2.*"}[5m]))
              /
              sum(rate(istio_requests_total[5m]))
          
          # P95å»¶è¿Ÿ SLI
          - record: sli:request_latency_p95:milliseconds
            expr: |
              histogram_quantile(0.95,
                sum(rate(istio_request_duration_milliseconds_bucket[5m])) 
                by (le)
              )
          
          # SLOå‘Šè­¦ï¼ˆæˆåŠŸç‡<99.9%ï¼‰
          - alert: SLOViolation_SuccessRate
            expr: sli:request_success_rate:ratio < 0.999
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "æˆåŠŸç‡ä½äºSLO"
              description: "å½“å‰æˆåŠŸç‡: {{ $value | humanizePercentage }}"
          
          # SLOå‘Šè­¦ï¼ˆP95å»¶è¿Ÿ>500msï¼‰
          - alert: SLOViolation_Latency
            expr: sli:request_latency_p95:milliseconds > 500
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "P95å»¶è¿Ÿè¶…è¿‡SLO"
              description: "å½“å‰P95å»¶è¿Ÿ: {{ $value }}ms"
```

### 7.4 é”™è¯¯é¢„ç®—

```yaml
é”™è¯¯é¢„ç®— (Error Budget):

å®šä¹‰:
  å…è®¸çš„æ•…éšœæ—¶é—´æˆ–å¤±è´¥è¯·æ±‚æ•°

è®¡ç®—:
  é”™è¯¯é¢„ç®— = 1 - SLO
  
  SLO = 99.9%
  é”™è¯¯é¢„ç®— = 0.1% = 1 - 99.9%

ç¤ºä¾‹:
  30å¤©SLO = 99.9%
  æ€»æ—¶é—´ = 30 * 24 * 60 = 43,200åˆ†é’Ÿ
  é”™è¯¯é¢„ç®— = 43,200 * 0.001 = 43.2åˆ†é’Ÿ

ç”¨é€”:

1. å‘å¸ƒå†³ç­–:
   é”™è¯¯é¢„ç®—å……è¶³ â†’ å¯ä»¥å‘å¸ƒæ–°åŠŸèƒ½
   é”™è¯¯é¢„ç®—è€—å°½ â†’ æš‚åœå‘å¸ƒï¼Œä¿®å¤ç¨³å®šæ€§

2. å¹³è¡¡åˆ›æ–°ä¸ç¨³å®š:
   âœ… 100% SLO = æ²¡æœ‰åˆ›æ–°ç©ºé—´
   âœ… 99.9% SLO = 0.1%é”™è¯¯é¢„ç®—å¯ç”¨äºå®éªŒ

3. ç›‘æ§é”™è¯¯é¢„ç®—æ¶ˆè€—:
```

```promql
# é”™è¯¯é¢„ç®—æ¶ˆè€—ç‡
(1 - sli:request_success_rate:ratio) / 0.001

# é”™è¯¯é¢„ç®—å‰©ä½™ï¼ˆåŸºäº30å¤©ï¼‰
1 - (
  sum(increase(istio_requests_total{response_code!~"2.*"}[30d]))
  /
  sum(increase(istio_requests_total[30d]))
) / 0.001

# é”™è¯¯é¢„ç®—å‰©ä½™å¤©æ•°
(
  1 - (
    sum(increase(istio_requests_total{response_code!~"2.*"}[30d]))
    /
    sum(increase(istio_requests_total[30d]))
  ) / 0.001
) * 30
```

```yaml
é”™è¯¯é¢„ç®—ç­–ç•¥:

1. ç»¿è‰²ï¼ˆ>75%å‰©ä½™ï¼‰:
   âœ… æ­£å¸¸å‘å¸ƒ
   âœ… å¯ä»¥å®éªŒæ–°åŠŸèƒ½
   âœ… æ€§èƒ½ä¼˜åŒ–

2. é»„è‰²ï¼ˆ25%-75%å‰©ä½™ï¼‰:
   âš ï¸ è°¨æ…å‘å¸ƒ
   âš ï¸ å¢åŠ æµ‹è¯•
   âš ï¸ å…³æ³¨ç›‘æ§

3. çº¢è‰²ï¼ˆ<25%å‰©ä½™ï¼‰:
   ğŸš« æš‚åœå‘å¸ƒ
   ğŸš« åªä¿®å¤Bug
   ğŸš« å›æ»šå¯ç–‘æ›´æ”¹
   ğŸš« ä¸“æ³¨ç¨³å®šæ€§
```

---

## 8. å‘Šè­¦é…ç½®

### 8.1 Alertmanageré…ç½®

```yaml
# Alertmanager ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: istio-system
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      
      # Slacké…ç½®
      slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

    # è·¯ç”±è§„åˆ™
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s        # ç­‰å¾…10ç§’èšåˆå‘Šè­¦
      group_interval: 10s    # èšåˆåå‘Šè­¦é—´éš”
      repeat_interval: 12h   # é‡å¤å‘Šè­¦é—´éš”
      
      receiver: 'default'
      
      routes:
        # ä¸¥é‡å‘Šè­¦ â†’ Slack + PagerDuty
        - match:
            severity: critical
          receiver: 'critical-alerts'
          continue: true
        
        # è­¦å‘Š â†’ Slack
        - match:
            severity: warning
          receiver: 'warning-alerts'
        
        # ä¿¡æ¯ â†’ é‚®ä»¶
        - match:
            severity: info
          receiver: 'info-alerts'

    # æŠ‘åˆ¶è§„åˆ™
    inhibit_rules:
      # å¦‚æœæœ‰criticalå‘Šè­¦ï¼ŒæŠ‘åˆ¶warningå‘Šè­¦
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'service']

    receivers:
      - name: 'default'
        slack_configs:
          - channel: '#alerts'
            title: '{{ .GroupLabels.alertname }}'
            text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}\n{{ end }}'

      - name: 'critical-alerts'
        slack_configs:
          - channel: '#critical-alerts'
            title: 'ğŸš¨ Critical Alert'
            text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}\n{{ end }}'
        pagerduty_configs:
          - service_key: 'YOUR_PAGERDUTY_KEY'

      - name: 'warning-alerts'
        slack_configs:
          - channel: '#warnings'
            title: 'âš ï¸ Warning Alert'
            text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}\n{{ end }}'

      - name: 'info-alerts'
        email_configs:
          - to: 'team@example.com'
            from: 'alertmanager@example.com'
            smarthost: 'smtp.gmail.com:587'
            auth_username: 'alertmanager@example.com'
            auth_password: 'your-password'
```

### 8.2 å‘Šè­¦è§„åˆ™

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerts
  namespace: istio-system
data:
  alerts.yaml: |
    groups:
      - name: service-mesh-alerts
        rules:
          # 1. æˆåŠŸç‡ä½
          - alert: HighErrorRate
            expr: |
              (
                sum(rate(istio_requests_total{response_code=~"5.*"}[5m])) 
                / 
                sum(rate(istio_requests_total[5m]))
              ) > 0.05
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "æœåŠ¡é”™è¯¯ç‡è¿‡é«˜"
              description: "{{ $labels.destination_service }} é”™è¯¯ç‡: {{ $value | humanizePercentage }}"

          # 2. å»¶è¿Ÿè¿‡é«˜
          - alert: HighLatency
            expr: |
              histogram_quantile(0.99,
                sum(rate(istio_request_duration_milliseconds_bucket[5m])) 
                by (le, destination_service)
              ) > 1000
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "æœåŠ¡å»¶è¿Ÿè¿‡é«˜"
              description: "{{ $labels.destination_service }} P99å»¶è¿Ÿ: {{ $value }}ms"

          # 3. QPSå¼‚å¸¸ä¸‹é™
          - alert: QPSDropped
            expr: |
              (
                sum(rate(istio_requests_total[5m])) 
                / 
                sum(rate(istio_requests_total[5m] offset 1h))
              ) < 0.5
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "QPSå¼‚å¸¸ä¸‹é™"
              description: "QPSä¸‹é™è¶…è¿‡50%"

          # 4. Piloté…ç½®æ¨é€å»¶è¿Ÿ
          - alert: PilotPushLatencyHigh
            expr: |
              histogram_quantile(0.99, 
                sum(rate(pilot_proxy_convergence_time_bucket[5m])) by (le)
              ) > 10000
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Piloté…ç½®æ¨é€å»¶è¿Ÿè¿‡é«˜"
              description: "P99é…ç½®æ¨é€å»¶è¿Ÿ: {{ $value }}ms"

          # 5. mTLSè¦†ç›–ç‡ä½
          - alert: LowMTLSCoverage
            expr: |
              (
                sum(istio_requests_total{connection_security_policy="mutual_tls"})
                /
                sum(istio_requests_total)
              ) < 0.95
            for: 15m
            labels:
              severity: info
            annotations:
              summary: "mTLSè¦†ç›–ç‡ä½äº95%"
              description: "å½“å‰mTLSè¦†ç›–ç‡: {{ $value | humanizePercentage }}"

          # 6. Podé‡å¯é¢‘ç¹
          - alert: PodRestartingFrequently
            expr: |
              rate(kube_pod_container_status_restarts_total[15m]) > 0.1
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Podé¢‘ç¹é‡å¯"
              description: "{{ $labels.pod }} é‡å¯ç‡: {{ $value }}/åˆ†é’Ÿ"

          # 7. Sidecarèµ„æºæ¶ˆè€—è¿‡é«˜
          - alert: SidecarHighMemory
            expr: |
              container_memory_working_set_bytes{container="istio-proxy"} 
              / 
              1024 / 1024 > 500
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "Sidecarå†…å­˜ä½¿ç”¨è¿‡é«˜"
              description: "{{ $labels.pod }} Sidecarå†…å­˜: {{ $value }}MB"
```

### 8.3 é€šçŸ¥é›†æˆ

```yaml
å‘Šè­¦é€šçŸ¥æ¸ é“:

1. Slack:
   slack_configs:
     - api_url: 'https://hooks.slack.com/services/...'
       channel: '#alerts'
       title: '{{ .GroupLabels.alertname }}'
       text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

2. Email:
   email_configs:
     - to: 'team@example.com'
       from: 'alertmanager@example.com'
       smarthost: 'smtp.gmail.com:587'
       auth_username: 'user'
       auth_password: 'password'
       headers:
         Subject: 'Alert: {{ .GroupLabels.alertname }}'

3. PagerDuty:
   pagerduty_configs:
     - service_key: 'YOUR_SERVICE_KEY'
       description: '{{ .GroupLabels.alertname }}'

4. Webhook:
   webhook_configs:
     - url: 'http://your-webhook-service/alert'
       send_resolved: true

5. ä¼ä¸šå¾®ä¿¡:
   wechat_configs:
     - corp_id: 'YOUR_CORP_ID'
       agent_id: 'YOUR_AGENT_ID'
       to_user: '@all'
       api_secret: 'YOUR_API_SECRET'
```

### 8.4 å‘Šè­¦æœ€ä½³å®è·µ

```yaml
å‘Šè­¦æœ€ä½³å®è·µ:

1. å¯æ“ä½œæ€§:
   âŒ å·®: "æœåŠ¡æœ‰é—®é¢˜"
   âœ… å¥½: "è®¢å•æœåŠ¡P99å»¶è¿Ÿ1200msï¼Œè¶…è¿‡SLO 500msï¼Œæ£€æŸ¥æ•°æ®åº“è¿æ¥æ± "

2. é¿å…å‘Šè­¦ç–²åŠ³:
   - åˆç†è®¾ç½®é˜ˆå€¼
   - èšåˆç›¸å…³å‘Šè­¦
   - è®¾ç½®æŠ‘åˆ¶è§„åˆ™
   - å®šæœŸreviewå‘Šè­¦

3. åˆ†çº§å‘Šè­¦:
   Critical: éœ€è¦ç«‹å³è¡ŒåŠ¨ï¼ˆé¡µé¢çº§å‘Šè­¦ï¼‰
   Warning: éœ€è¦å…³æ³¨ï¼ˆSlackï¼‰
   Info: ä»…è®°å½•ï¼ˆé‚®ä»¶ï¼‰

4. å‘Šè­¦ä¸Šä¸‹æ–‡:
   âœ… å½“å‰å€¼
   âœ… SLOç›®æ ‡
   âœ… Runbooké“¾æ¥
   âœ… Dashboardé“¾æ¥
   âœ… ç›¸å…³æœåŠ¡

5. è‡ªæ„ˆæœºåˆ¶:
   - è‡ªåŠ¨æ‰©å®¹
   - è‡ªåŠ¨é‡å¯
   - è‡ªåŠ¨é™çº§
   - å‘Šè­¦åç¡®è®¤æ•ˆæœ
```

---

## 9. å¯è§‚æµ‹æ€§å®æˆ˜

### 9.1 å®Œæ•´å¯è§‚æµ‹æ€§æ ˆ

```bash
#!/bin/bash
# ä¸€é”®éƒ¨ç½²å®Œæ•´å¯è§‚æµ‹æ€§æ ˆ

# 1. éƒ¨ç½²Prometheus
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.21/samples/addons/prometheus.yaml

# 2. éƒ¨ç½²Jaeger
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.21/samples/addons/jaeger.yaml

# 3. éƒ¨ç½²Grafana
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.21/samples/addons/grafana.yaml

# 4. éƒ¨ç½²Kialiï¼ˆå¯é€‰ï¼‰
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.21/samples/addons/kiali.yaml

# 5. éƒ¨ç½²Loki Stack
helm repo add grafana https://grafana.github.io/helm-charts
helm install loki grafana/loki-stack \
  --namespace loki --create-namespace \
  --set promtail.enabled=true \
  --set grafana.enabled=false

# 6. é…ç½®Grafanaæ•°æ®æº
kubectl apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: istio-system
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
      
      - name: Jaeger
        type: jaeger
        access: proxy
        url: http://jaeger-query:16686
      
      - name: Loki
        type: loki
        access: proxy
        url: http://loki.loki:3100
EOF

# 7. ç­‰å¾…æ‰€æœ‰Podå°±ç»ª
kubectl wait --for=condition=ready pod -l app=prometheus -n istio-system --timeout=300s
kubectl wait --for=condition=ready pod -l app=jaeger -n istio-system --timeout=300s
kubectl wait --for=condition=ready pod -l app=grafana -n istio-system --timeout=300s

# 8. è®¿é—®æœåŠ¡
echo "Prometheus: http://localhost:9090"
kubectl port-forward -n istio-system svc/prometheus 9090:9090 &

echo "Jaeger: http://localhost:16686"
kubectl port-forward -n istio-system svc/jaeger-query 16686:16686 &

echo "Grafana: http://localhost:3000 (admin/admin)"
kubectl port-forward -n istio-system svc/grafana 3000:3000 &

echo "å¯è§‚æµ‹æ€§æ ˆéƒ¨ç½²å®Œæˆï¼"
```

### 9.2 æ•…éšœæ’æŸ¥æ¡ˆä¾‹

```yaml
æ¡ˆä¾‹1: æœåŠ¡å»¶è¿Ÿçªå¢

æ­¥éª¤1: Metricså‘ç°é—®é¢˜
  - Grafana Dashboardæ˜¾ç¤ºP99å»¶è¿Ÿä»100msçªå¢åˆ°2000ms
  - æ—¶é—´ç‚¹: 14:32

æ­¥éª¤2: ç¡®å®šé—®é¢˜èŒƒå›´
  PromQL:
  histogram_quantile(0.99,
    sum(rate(istio_request_duration_milliseconds_bucket[5m])) 
    by (le, destination_service)
  )
  
  ç»“æœ: order-service P99å»¶è¿Ÿå¼‚å¸¸

æ­¥éª¤3: Jaegerè¿½è¸ªåˆ†æ
  - é€‰æ‹©order-service
  - æ—¶é—´èŒƒå›´: 14:30-14:35
  - æ’åº: Duration (é™åº)
  
  å‘ç°:
    - order-service â†’ database-serviceè€—æ—¶1800ms
    - æ­£å¸¸æƒ…å†µåº”è¯¥<50ms

æ­¥éª¤4: æŸ¥çœ‹æ—¥å¿—
  LogQL:
  {app="database-service"} |= "error" | json
  
  å‘ç°:
    - 14:32å¼€å§‹å¤§é‡"connection timeout"é”™è¯¯
    - æ•°æ®åº“è¿æ¥æ± è€—å°½

æ­¥éª¤5: æ ¹å› åˆ†æ
  PromQL:
  sum(rate(istio_requests_total{destination_service="database-service"}[1m]))
  
  å‘ç°:
    - QPSä»100çªå¢åˆ°1000
    - è§¦å‘åŸå› : è¥é”€æ´»åŠ¨å¼€å§‹

æ­¥éª¤6: è§£å†³æ–¹æ¡ˆ
  - ç«‹å³æ‰©å®¹database-service: 3 â†’ 10å‰¯æœ¬
  - å¢åŠ æ•°æ®åº“è¿æ¥æ± å¤§å°
  - å¯ç”¨ç†”æ–­ä¿æŠ¤

æ­¥éª¤7: éªŒè¯
  - 5åˆ†é’ŸåP99å»¶è¿Ÿæ¢å¤åˆ°150ms
  - é”™è¯¯ç‡ä»5%é™åˆ°0.1%
  - å‘Šè­¦è§£é™¤

æ€»è€—æ—¶: 15åˆ†é’Ÿ
```

```yaml
æ¡ˆä¾‹2: é—´æ­‡æ€§503é”™è¯¯

æ­¥éª¤1: å‘Šè­¦è§¦å‘
  - HighErrorRateå‘Šè­¦
  - payment-service 503é”™è¯¯ç‡2%
  - é—´æ­‡æ€§å‘ç”Ÿ

æ­¥éª¤2: Metricsåˆ†æ
  PromQL:
  sum(rate(istio_requests_total{
    destination_service="payment-service",
    response_code="503"
  }[1m])) by (destination_version)
  
  å‘ç°:
    - ä»…v2ç‰ˆæœ¬æœ‰503
    - v1ç‰ˆæœ¬æ­£å¸¸

æ­¥éª¤3: Traceåˆ†æ
  - ç­›é€‰response_code=503
  - æŸ¥çœ‹v2ç‰ˆæœ¬Traces
  
  å‘ç°:
    - 503å‘ç”Ÿåœ¨payment-service â†’ redis-serviceè°ƒç”¨
    - é”™è¯¯: "connection refused"

æ­¥éª¤4: æ—¥å¿—æŸ¥çœ‹
  LogQL:
  {app="payment-service", version="v2"} |= "redis"
  
  å‘ç°:
    - v2ç‰ˆæœ¬Redisåœ°å€é…ç½®é”™è¯¯
    - redis-service.default â†’ redis-service.prod

æ­¥éª¤5: è§£å†³
  - ä¿®å¤ConfigMapä¸­Redisåœ°å€
  - æ»šåŠ¨é‡å¯v2ç‰ˆæœ¬

æ­¥éª¤6: éªŒè¯
  - 503é”™è¯¯ç‡é™ä¸º0
  - v2ç‰ˆæœ¬æˆåŠŸç‡æ¢å¤99.9%

æ ¹å› : é…ç½®é”™è¯¯
æ€»è€—æ—¶: 10åˆ†é’Ÿ
```

### 9.3 æ€§èƒ½åˆ†ææ¡ˆä¾‹

```yaml
æ¡ˆä¾‹3: èµ„æºä¼˜åŒ–

ç›®æ ‡: é™ä½Sidecarèµ„æºæ¶ˆè€—

æ­¥éª¤1: å½“å‰çŠ¶æ€è¯„ä¼°
  PromQL:
  # CPUä½¿ç”¨
  sum(rate(container_cpu_usage_seconds_total{container="istio-proxy"}[5m])) 
  by (pod)
  
  # å†…å­˜ä½¿ç”¨
  container_memory_working_set_bytes{container="istio-proxy"} / 1024 / 1024
  
  å‘ç°:
    - æ¯ä¸ªSidecar CPU: 200m
    - æ¯ä¸ªSidecarå†…å­˜: 250MB
    - é›†ç¾¤100ä¸ªPod, æ€»æ¶ˆè€—: 20 CPU, 25GBå†…å­˜

æ­¥éª¤2: è¿½è¸ªé‡‡æ ·ç‡ä¼˜åŒ–
  å½“å‰: 100%é‡‡æ ·
  ä¼˜åŒ–: 1%é‡‡æ ·ï¼ˆé«˜æµé‡æœåŠ¡ï¼‰
  
  é…ç½®:
  apiVersion: install.istio.io/v1alpha1
  kind: IstioOperator
  spec:
    meshConfig:
      defaultConfig:
        tracing:
          sampling: 1.0  # 1%

æ­¥éª¤3: è®¿é—®æ—¥å¿—ä¼˜åŒ–
  å…³é—­è¯¦ç»†è®¿é—®æ—¥å¿—ï¼Œä»…ä¿ç•™é”™è¯¯æ—¥å¿—
  
  é…ç½®:
  apiVersion: telemetry.istio.io/v1alpha1
  kind: Telemetry
  metadata:
    name: mesh-logging
  spec:
    accessLogging:
      - providers:
        - name: envoy
        filter:
          expression: response.code >= 400

æ­¥éª¤4: Metricsè¿‡æ»¤
  ä»…é‡‡é›†å…³é”®æŒ‡æ ‡
  
  é…ç½®:
  apiVersion: telemetry.istio.io/v1alpha1
  kind: Telemetry
  metadata:
    name: mesh-metrics
  spec:
    metrics:
      - providers:
        - name: prometheus
        dimensions:
          request_protocol: request.protocol
          response_code: response.code
        tags_to_remove:
          - request_host
          - source_principal
          - destination_principal

æ­¥éª¤5: ç»“æœéªŒè¯
  PromQL:
  # ä¼˜åŒ–åCPU
  sum(rate(container_cpu_usage_seconds_total{container="istio-proxy"}[5m])) 
  by (pod)
  
  # ä¼˜åŒ–åå†…å­˜
  container_memory_working_set_bytes{container="istio-proxy"} / 1024 / 1024
  
  ç»“æœ:
    - CPU: 200m â†’ 50m (é™ä½75%)
    - å†…å­˜: 250MB â†’ 100MB (é™ä½60%)
    - é›†ç¾¤æ€»èŠ‚çœ: 15 CPU, 15GBå†…å­˜

æ­¥éª¤6: æ€§èƒ½éªŒè¯
  PromQL:
  histogram_quantile(0.99,
    sum(rate(istio_request_duration_milliseconds_bucket[5m])) 
    by (le)
  )
  
  ç»“æœ:
    - P99å»¶è¿Ÿ: ä¼˜åŒ–å‰150ms, ä¼˜åŒ–å145ms
    - æ€§èƒ½æ— æ˜æ˜¾å½±å“

æ€»ç»“:
  âœ… èµ„æºæ¶ˆè€—é™ä½70%
  âœ… æ€§èƒ½æ— æ˜æ˜¾å½±å“
  âœ… å¹´èŠ‚çœæˆæœ¬: $50,000+
```

---

## 10. æ€»ç»“

### 10.1 å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±

```yaml
Metrics (æŒ‡æ ‡):
  å·¥å…·: Prometheus + Grafana
  ä»·å€¼: âœ… å®æ—¶ç›‘æ§, âœ… è¶‹åŠ¿åˆ†æ, âœ… å‘Šè­¦è§¦å‘
  æ ¸å¿ƒ: å››å¤§é»„é‡‘ä¿¡å·ï¼ˆLatencyã€Trafficã€Errorsã€Saturationï¼‰

Tracing (è¿½è¸ª):
  å·¥å…·: Jaeger + OpenTelemetry
  ä»·å€¼: âœ… è°ƒç”¨é“¾å¯è§†åŒ–, âœ… æ€§èƒ½ç“¶é¢ˆå®šä½, âœ… ä¾èµ–å…³ç³»åˆ†æ
  æ ¸å¿ƒ: Traceã€Spanã€Context Propagation

Logging (æ—¥å¿—):
  å·¥å…·: Loki + Promtail
  ä»·å€¼: âœ… è¯¦ç»†ä¸Šä¸‹æ–‡, âœ… é—®é¢˜è¯Šæ–­, âœ… å®¡è®¡è¿½è¸ª
  æ ¸å¿ƒ: ç»“æ„åŒ–æ—¥å¿—ã€æ ‡ç­¾ç´¢å¼•ã€å…³è”æŸ¥è¯¢
```

### 10.2 æœåŠ¡ç½‘æ ¼å¯è§‚æµ‹æ€§ä¼˜åŠ¿

```yaml
è‡ªåŠ¨åŒ–:
  âœ… æ— éœ€ä¿®æ”¹ä»£ç 
  âœ… Sidecarè‡ªåŠ¨é‡‡é›†
  âœ… ç»Ÿä¸€æ ‡å‡†æ ¼å¼

å…¨é¢æ€§:
  âœ… L7 HTTP/gRPCæŒ‡æ ‡
  âœ… L4 TCPæŒ‡æ ‡
  âœ… mTLSçŠ¶æ€
  âœ… æ‹“æ‰‘å…³ç³»

å…³è”æ€§:
  âœ… Metrics â†’ Traces â†’ Logs
  âœ… ç»Ÿä¸€æ ‡ç­¾ä½“ç³»
  âœ… ä¸€é”®æ•…éšœæ’æŸ¥

æ ‡å‡†åŒ–:
  âœ… Prometheusæ ‡å‡†
  âœ… OpenTelemetryæ ‡å‡†
  âœ… ä¾›åº”å•†ä¸­ç«‹
```

### 10.3 æœ€ä½³å®è·µæ€»ç»“

```yaml
1. SLI/SLOé©±åŠ¨:
   âœ… å®šä¹‰æ¸…æ™°çš„SLI
   âœ… è®¾ç½®åˆç†çš„SLO
   âœ… ç›‘æ§é”™è¯¯é¢„ç®—
   âœ… åŸºäºæ•°æ®å†³ç­–

2. åˆ†å±‚ç›‘æ§:
   L1: å…¨å±€Meshç›‘æ§
   L2: æœåŠ¡çº§åˆ«ç›‘æ§
   L3: å·¥ä½œè´Ÿè½½ç›‘æ§
   L4: Pod/Containerç›‘æ§

3. å‘Šè­¦ç­–ç•¥:
   âœ… å¯æ“ä½œæ€§
   âœ… é¿å…ç–²åŠ³
   âœ… åˆ†çº§å¤„ç†
   âœ… è‡ªæ„ˆæœºåˆ¶

4. æ€§èƒ½ä¼˜åŒ–:
   âœ… é‡‡æ ·ç‡è°ƒæ•´ï¼ˆ1-10%ï¼‰
   âœ… æ—¥å¿—è¿‡æ»¤
   âœ… Metricsç²¾ç®€
   âœ… èµ„æºé™åˆ¶

5. æ•…éšœæ’æŸ¥:
   âœ… Metricså‘ç°é—®é¢˜
   âœ… Tracingå®šä½ç“¶é¢ˆ
   âœ… LoggingæŸ¥çœ‹è¯¦æƒ…
   âœ… å¿«é€Ÿæ ¹å› åˆ†æ
```

### 10.4 å·¥å…·å¯¹æ¯”

```yaml
Istioå¯è§‚æµ‹æ€§:
  ä¼˜åŠ¿:
    âœ… åŠŸèƒ½ä¸°å¯Œ
    âœ… æ·±åº¦é›†æˆ
    âœ… Envoyå¼ºå¤§
  
  åŠ£åŠ¿:
    âŒ èµ„æºæ¶ˆè€—é«˜
    âŒ é…ç½®å¤æ‚
  
  é€‚ç”¨:
    - å¤§å‹ä¼ä¸š
    - å¤æ‚åœºæ™¯
    - æ·±åº¦å®šåˆ¶

Linkerdå¯è§‚æµ‹æ€§:
  ä¼˜åŠ¿:
    âœ… è½»é‡çº§
    âœ… å¼€ç®±å³ç”¨
    âœ… é»„é‡‘æŒ‡æ ‡
  
  åŠ£åŠ¿:
    âŒ åŠŸèƒ½ç›¸å¯¹ç®€å•
    âŒ å¯å®šåˆ¶æ€§ä½
  
  é€‚ç”¨:
    - ä¸­å°å‹ä¼ä¸š
    - å¿«é€Ÿä¸Šæ‰‹
    - èµ„æºå—é™

OpenTelemetry:
  ä¼˜åŠ¿:
    âœ… ç»Ÿä¸€æ ‡å‡†
    âœ… ä¾›åº”å•†ä¸­ç«‹
    âœ… ç¤¾åŒºæ´»è·ƒ
  
  é€‚ç”¨:
    - å¤šäº‘ç¯å¢ƒ
    - é¿å…é”å®š
    - æœªæ¥è¶‹åŠ¿
```

### 10.5 æœªæ¥å±•æœ›

```yaml
è¶‹åŠ¿:

1. eBPFå¯è§‚æµ‹æ€§:
   - æ›´ä½å¼€é”€
   - å†…æ ¸çº§åˆ«é‡‡é›†
   - æ— éœ€Sidecar

2. AIOps:
   - å¼‚å¸¸æ£€æµ‹
   - æ ¹å› åˆ†æ
   - è‡ªåŠ¨ä¿®å¤

3. æˆæœ¬ä¼˜åŒ–:
   - æ™ºèƒ½é‡‡æ ·
   - æ•°æ®å‹ç¼©
   - è¾¹ç¼˜è®¡ç®—

4. ç»Ÿä¸€å¯è§‚æµ‹æ€§å¹³å°:
   - ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆ
   - è‡ªåŠ¨å…³è”
   - æ™ºèƒ½å‘Šè­¦
```

---

**ç›¸å…³ç« èŠ‚**:

- [02_Istioæ·±åº¦è§£æ](./02_Istioæ·±åº¦è§£æ.md)
- [03_Linkerdè½»é‡çº§æœåŠ¡ç½‘æ ¼](./03_Linkerdè½»é‡çº§æœåŠ¡ç½‘æ ¼.md)
- [04_æœåŠ¡ç½‘æ ¼å®‰å…¨](./04_æœåŠ¡ç½‘æ ¼å®‰å…¨.md)
- [05_æµé‡ç®¡ç†ä¸ç°åº¦å‘å¸ƒ](./05_æµé‡ç®¡ç†ä¸ç°åº¦å‘å¸ƒ.md)

**ä¸‹ä¸€ç« **: [07_å¤šé›†ç¾¤æœåŠ¡ç½‘æ ¼](./07_å¤šé›†ç¾¤æœåŠ¡ç½‘æ ¼.md)

---

**å®Œæˆæ—¥æœŸ**: 2025-10-19  
**ç‰ˆæœ¬**: v1.0  
**ä½œè€…**: æœåŠ¡ç½‘æ ¼æŠ€æœ¯ä¸“å®¶å›¢é˜Ÿ

**Tags**: `#ServiceMesh` `#Observability` `#Prometheus` `#Jaeger` `#Grafana` `#Loki` `#OpenTelemetry` `#SLO` `#Monitoring`
