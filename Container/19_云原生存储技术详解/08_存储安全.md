# 08 - 存储安全

**作者**: 云原生存储专家团队  
**创建日期**: 2025-10-19  
**最后更新**: 2025-10-19  
**版本**: v1.0

---

## 📋 本章导航

- [08 - 存储安全](#08---存储安全)
  - [📋 本章导航](#-本章导航)
  - [1. 加密](#1-加密)
    - [1.1 静态数据加密](#11-静态数据加密)
    - [1.2 传输加密](#12-传输加密)
    - [1.3 密钥管理](#13-密钥管理)
  - [2. 访问控制](#2-访问控制)
    - [2.1 Kubernetes RBAC](#21-kubernetes-rbac)
    - [2.2 Ceph认证](#22-ceph认证)
  - [3. 网络安全](#3-网络安全)
    - [3.1 网络隔离](#31-网络隔离)
    - [3.2 NetworkPolicy](#32-networkpolicy)
  - [4. 审计与合规](#4-审计与合规)
    - [4.1 审计日志](#41-审计日志)
    - [4.2 合规标准](#42-合规标准)
  - [5. 最佳实践](#5-最佳实践)
  - [6. 总结](#6-总结)

---

## 1. 加密

### 1.1 静态数据加密

**Kubernetes Secrets加密**:

```yaml
# 启用etcd加密
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
- resources:
  - secrets
  providers:
  - aescbc:
      keys:
      - name: key1
        secret: <BASE64_ENCODED_SECRET>
  - identity: {}
```

**Ceph加密**:

```yaml
# RBD加密 (LUKS)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: rook-ceph-block-encrypted
provisioner: rook-ceph.rbd.csi.ceph.com
parameters:
  clusterID: rook-ceph
  pool: replicapool
  encrypted: "true"
  encryptionKMSID: vault
```

**云存储加密**:

```yaml
# AWS EBS加密
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ebs-encrypted
provisioner: ebs.csi.aws.com
parameters:
  type: gp3
  encrypted: "true"
  kmsKeyId: arn:aws:kms:us-east-1:123456789012:key/xxxx

---
# Azure Disk加密
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: azure-disk-encrypted
provisioner: disk.csi.azure.com
parameters:
  skuName: Premium_LRS
  encrypted: "true"
  diskEncryptionSetID: /subscriptions/.../diskEncryptionSets/myDES
```

---

### 1.2 传输加密

**Ceph mTLS**:

```yaml
# Ceph配置
[global]
ms_client_mode = secure
ms_cluster_mode = secure
ms_service_mode = secure
ms_mon_service_mode = secure
ms_mon_cluster_mode = secure
```

**StorageClass TLS**:

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: secure-storage
provisioner: rook-ceph.rbd.csi.ceph.com
parameters:
  ...
  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
mountOptions:
- sec=sys  # NFS安全模式
```

---

### 1.3 密钥管理

**HashiCorp Vault集成**:

```yaml
# Vault KMS
apiVersion: v1
kind: ConfigMap
metadata:
  name: csi-kms-config
  namespace: rook-ceph
data:
  config.json: |
    {
      "vault": {
        "VAULT_ADDR": "https://vault.example.com:8200",
        "VAULT_BACKEND_PATH": "rook",
        "VAULT_CACERT": "/etc/vault/ca.crt",
        "VAULT_TLS_SERVER_NAME": "vault.example.com",
        "VAULT_CLIENT_CERT": "/etc/vault/client.crt",
        "VAULT_CLIENT_KEY": "/etc/vault/client.key"
      }
    }
```

---

## 2. 访问控制

### 2.1 Kubernetes RBAC

**存储RBAC**:

```yaml
# StorageClass管理员
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: storage-admin
rules:
- apiGroups: ["storage.k8s.io"]
  resources: ["storageclasses"]
  verbs: ["*"]
- apiGroups: [""]
  resources: ["persistentvolumes"]
  verbs: ["*"]

---
# PVC用户
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pvc-user
  namespace: myapp
rules:
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["get", "list", "create", "delete"]

---
# 绑定
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pvc-user-binding
  namespace: myapp
subjects:
- kind: User
  name: john
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: pvc-user
  apiGroup: rbac.authorization.k8s.io
```

---

### 2.2 Ceph认证

**Ceph CephX认证**:

```bash
# 创建Ceph用户
ceph auth get-or-create client.myapp \
  mon 'allow r' \
  osd 'allow rw pool=myapp-pool' \
  -o /etc/ceph/ceph.client.myapp.keyring

# 查看用户权限
ceph auth get client.myapp

# 限制访问
ceph auth caps client.myapp \
  mon 'allow r' \
  osd 'allow rw pool=myapp-pool, allow r pool=shared-pool'
```

---

## 3. 网络安全

### 3.1 网络隔离

**Ceph网络隔离**:

```yaml
# Rook CephCluster网络配置
apiVersion: ceph.rook.io/v1
kind: CephCluster
metadata:
  name: rook-ceph
  namespace: rook-ceph
spec:
  network:
    provider: host
    selectors:
      public: "10.0.1.0/24"    # 前端网络
      cluster: "10.0.2.0/24"   # 后端网络
```

---

### 3.2 NetworkPolicy

**存储NetworkPolicy**:

```yaml
# 限制访问Ceph
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ceph-network-policy
  namespace: rook-ceph
spec:
  podSelector:
    matchLabels:
      app: rook-ceph-osd
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: rook-ceph
    - namespaceSelector:
        matchLabels:
          storage-access: "true"
    ports:
    - protocol: TCP
      port: 6800-7300  # Ceph OSD端口
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: rook-ceph
    ports:
    - protocol: TCP
      port: 6800-7300
```

---

## 4. 审计与合规

### 4.1 审计日志

**Kubernetes审计**:

```yaml
# 审计策略
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
# 记录PV/PVC操作
- level: RequestResponse
  resources:
  - group: ""
    resources: ["persistentvolumes", "persistentvolumeclaims"]
  verbs: ["create", "delete", "patch", "update"]

# 记录StorageClass操作
- level: RequestResponse
  resources:
  - group: "storage.k8s.io"
    resources: ["storageclasses"]
  verbs: ["*"]
```

**Ceph审计**:

```bash
# 启用Ceph审计
ceph config set mgr mgr/telemetry/enabled true

# 查看审计日志
ceph log last 100

# Ceph操作日志
tail -f /var/log/ceph/ceph.audit.log
```

---

### 4.2 合规标准

**存储合规要求**:

```yaml
PCI DSS (支付卡):
  ✅ 加密静态数据
  ✅ 加密传输数据
  ✅ 访问控制 (RBAC)
  ✅ 审计日志
  ✅ 定期备份
  ✅ 密钥管理

HIPAA (医疗):
  ✅ 数据加密
  ✅ 访问审计
  ✅ 数据完整性
  ✅ 备份与恢复
  ✅ 灾难恢复计划

GDPR (隐私):
  ✅ 数据加密
  ✅ 访问控制
  ✅ 数据删除 (right to be forgotten)
  ✅ 数据可移植性
  ✅ 审计日志

ISO 27001:
  ✅ 信息安全管理体系 (ISMS)
  ✅ 风险评估
  ✅ 安全控制
  ✅ 持续改进
```

---

## 5. 最佳实践

```yaml
加密:
  ✅ 默认启用静态数据加密
  ✅ 使用云KMS管理密钥
  ✅ 定期轮换密钥
  ✅ 传输加密 (TLS)

访问控制:
  ✅ 最小权限原则
  ✅ RBAC精细化
  ✅ 定期审查权限
  ✅ 使用ServiceAccount

网络安全:
  ✅ 网络隔离 (前后端分离)
  ✅ NetworkPolicy限制访问
  ✅ 私有网络
  ✅ 防火墙规则

审计:
  ✅ 启用审计日志
  ✅ 集中日志管理
  ✅ 实时告警
  ✅ 定期审查

备份:
  ✅ 加密备份
  ✅ 异地备份
  ✅ 定期恢复演练
  ✅ 访问控制

合规:
  ✅ 了解合规要求
  ✅ 定期审计
  ✅ 文档记录
  ✅ 培训
```

---

## 6. 总结

```yaml
核心知识:
  ✅ 加密 (静态/传输/密钥管理)
  ✅ 访问控制 (RBAC/CephX)
  ✅ 网络安全 (隔离/NetworkPolicy)
  ✅ 审计与合规 (日志/标准)
  ✅ 最佳实践

代码示例:
  - 加密配置 (Kubernetes/Ceph/云)
  - RBAC规则
  - NetworkPolicy
  - 审计策略
  - 30+配置

安全层次:
  L1: 物理安全 (数据中心)
  L2: 网络安全 (隔离/防火墙)
  L3: 系统安全 (OS加固)
  L4: 应用安全 (RBAC/加密)
  L5: 数据安全 (加密/备份)
  L6: 审计与合规 (日志/监控)
```

---

**完成日期**: 2025-10-19  
**版本**: v1.0  
**作者**: 云原生存储专家团队

**Tags**: `#Security` `#Encryption` `#RBAC` `#Compliance` `#CloudNativeStorage`
