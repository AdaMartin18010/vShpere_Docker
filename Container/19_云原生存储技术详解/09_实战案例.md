# 09 - å®æˆ˜æ¡ˆä¾‹

**ä½œè€…**: äº‘åŸç”Ÿå­˜å‚¨ä¸“å®¶å›¢é˜Ÿ  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-19  
**æœ€åæ›´æ–°**: 2025-10-19  
**ç‰ˆæœ¬**: v1.0

---

## ğŸ“‹ æœ¬ç« å¯¼èˆª

- [09 - å®æˆ˜æ¡ˆä¾‹](#09---å®æˆ˜æ¡ˆä¾‹)
  - [ğŸ“‹ æœ¬ç« å¯¼èˆª](#-æœ¬ç« å¯¼èˆª)
  - [1. MySQLé«˜å¯ç”¨](#1-mysqlé«˜å¯ç”¨)
  - [2. PostgreSQLé›†ç¾¤](#2-postgresqlé›†ç¾¤)
  - [3. MongoDBå‰¯æœ¬é›†](#3-mongodbå‰¯æœ¬é›†)
  - [4. KafkaæŒä¹…åŒ–](#4-kafkaæŒä¹…åŒ–)
  - [5. ElasticSearché›†ç¾¤](#5-elasticsearché›†ç¾¤)
  - [6. RedisæŒä¹…åŒ–](#6-redisæŒä¹…åŒ–)
  - [7. æ€»ç»“](#7-æ€»ç»“)

---

## 1. MySQLé«˜å¯ç”¨

**MySQL StatefulSet + Ceph RBD**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: mysql
spec:
  ports:
  - port: 3306
  clusterIP: None
  selector:
    app: mysql

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
spec:
  serviceName: mysql
  replicas: 3
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: password
        ports:
        - containerPort: 3306
          name: mysql
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
        - name: config
          mountPath: /etc/mysql/conf.d
      volumes:
      - name: config
        configMap:
          name: mysql-config
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: rook-ceph-block
      resources:
        requests:
          storage: 100Gi

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-config
data:
  my.cnf: |
    [mysqld]
    server-id=1
    log-bin=mysql-bin
    binlog_format=ROW
    gtid_mode=ON
    enforce_gtid_consistency=ON
    max_connections=1000
    innodb_buffer_pool_size=2G
```

---

## 2. PostgreSQLé›†ç¾¤

**PostgreSQL Operator + Ceph**:

```yaml
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: postgres-cluster
spec:
  teamId: "myteam"
  volume:
    size: 100Gi
    storageClass: rook-ceph-block
  numberOfInstances: 3
  users:
    admin:
    - superuser
    - createdb
  databases:
    mydb: admin
  postgresql:
    version: "15"
    parameters:
      shared_buffers: "2GB"
      effective_cache_size: "6GB"
      maintenance_work_mem: "512MB"
      checkpoint_completion_target: "0.9"
      wal_buffers: "16MB"
      default_statistics_target: "100"
      random_page_cost: "1.1"
      effective_io_concurrency: "200"
      work_mem: "10MB"
      min_wal_size: "1GB"
      max_wal_size: "4GB"
  patroni:
    initdb:
      encoding: "UTF8"
      locale: "en_US.UTF-8"
      data-checksums: "true"
    pg_hba:
    - hostssl all all 0.0.0.0/0 md5
    - host    all all 0.0.0.0/0 md5
```

---

## 3. MongoDBå‰¯æœ¬é›†

**MongoDB ReplicaSet**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: mongodb
spec:
  ports:
  - port: 27017
  clusterIP: None
  selector:
    app: mongodb

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
spec:
  serviceName: mongodb
  replicas: 3
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
      - name: mongodb
        image: mongo:7.0
        command:
        - mongod
        - --replSet
        - rs0
        - --bind_ip_all
        ports:
        - containerPort: 27017
        volumeMounts:
        - name: data
          mountPath: /data/db
        resources:
          requests:
            cpu: "1"
            memory: "2Gi"
          limits:
            cpu: "2"
            memory: "4Gi"
      - name: sidecar
        image: cvallance/mongo-k8s-sidecar:latest
        env:
        - name: MONGO_SIDECAR_POD_LABELS
          value: "app=mongodb"
        - name: KUBE_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: rook-ceph-block
      resources:
        requests:
          storage: 100Gi
```

---

## 4. KafkaæŒä¹…åŒ–

**Kafka + ZooKeeper**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: kafka
spec:
  ports:
  - port: 9092
    name: kafka
  clusterIP: None
  selector:
    app: kafka

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka
spec:
  serviceName: kafka
  replicas: 3
  selector:
    matchLabels:
      app: kafka
  template:
    metadata:
      labels:
        app: kafka
    spec:
      containers:
      - name: kafka
        image: confluentinc/cp-kafka:7.5.0
        ports:
        - containerPort: 9092
        env:
        - name: KAFKA_ZOOKEEPER_CONNECT
          value: "zookeeper:2181"
        - name: KAFKA_ADVERTISED_LISTENERS
          value: "PLAINTEXT://$(POD_NAME).kafka:9092"
        - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
          value: "3"
        - name: KAFKA_LOG_RETENTION_HOURS
          value: "168"
        - name: KAFKA_LOG_SEGMENT_BYTES
          value: "1073741824"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        volumeMounts:
        - name: data
          mountPath: /var/lib/kafka/data
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: rook-ceph-block
      resources:
        requests:
          storage: 200Gi
```

---

## 5. ElasticSearché›†ç¾¤

**Elasticsearch + Ceph**:

```yaml
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: elasticsearch
spec:
  version: 8.10.0
  nodeSets:
  - name: master
    count: 3
    config:
      node.roles: ["master"]
    volumeClaimTemplates:
    - metadata:
        name: elasticsearch-data
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 50Gi
        storageClassName: rook-ceph-block
  - name: data
    count: 3
    config:
      node.roles: ["data", "ingest"]
    volumeClaimTemplates:
    - metadata:
        name: elasticsearch-data
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 500Gi
        storageClassName: rook-ceph-block
```

---

## 6. RedisæŒä¹…åŒ–

**Redis Cluster**:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-config
data:
  redis.conf: |
    cluster-enabled yes
    cluster-config-file /data/nodes.conf
    cluster-node-timeout 5000
    appendonly yes
    appendfilename "appendonly.aof"
    appendfsync everysec
    save 900 1
    save 300 10
    save 60 10000

---
apiVersion: v1
kind: Service
metadata:
  name: redis
spec:
  ports:
  - port: 6379
    name: client
  - port: 16379
    name: gossip
  clusterIP: None
  selector:
    app: redis

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
spec:
  serviceName: redis
  replicas: 6
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7.2
        command:
        - redis-server
        - /conf/redis.conf
        ports:
        - containerPort: 6379
          name: client
        - containerPort: 16379
          name: gossip
        volumeMounts:
        - name: data
          mountPath: /data
        - name: conf
          mountPath: /conf
      volumes:
      - name: conf
        configMap:
          name: redis-config
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: rook-ceph-block
      resources:
        requests:
          storage: 50Gi
```

---

## 7. æ€»ç»“

```yaml
å®æˆ˜æ¡ˆä¾‹è¦†ç›–:
  âœ… MySQLé«˜å¯ç”¨ (StatefulSet + Ceph)
  âœ… PostgreSQLé›†ç¾¤ (Operator)
  âœ… MongoDBå‰¯æœ¬é›† (StatefulSet)
  âœ… KafkaæŒä¹…åŒ– (StatefulSet)
  âœ… ElasticSearché›†ç¾¤ (Operator)
  âœ… Redisé›†ç¾¤ (StatefulSet)

å…³é”®é…ç½®:
  - StatefulSet (æœ‰çŠ¶æ€åº”ç”¨)
  - PVC (æŒä¹…åŒ–å­˜å‚¨)
  - StorageClass (Ceph RBD)
  - Service (ç½‘ç»œè®¿é—®)
  - ConfigMap (é…ç½®)
  - Secret (æ•æ„Ÿä¿¡æ¯)

æœ€ä½³å®è·µ:
  âœ… ä½¿ç”¨Operator (ç®€åŒ–ç®¡ç†)
  âœ… StatefulSet (ç¨³å®šæ ‡è¯†)
  âœ… volumeClaimTemplates (åŠ¨æ€PVC)
  âœ… èµ„æºé™åˆ¶ (requests/limits)
  âœ… å¥åº·æ£€æŸ¥ (liveness/readiness)
  âœ… å¤‡ä»½ç­–ç•¥ (Velero)
```

---

**å®Œæˆæ—¥æœŸ**: 2025-10-19  
**ç‰ˆæœ¬**: v1.0  
**ä½œè€…**: äº‘åŸç”Ÿå­˜å‚¨ä¸“å®¶å›¢é˜Ÿ

**Tags**: `#Practical` `#Database` `#StatefulSet` `#Production` `#CloudNativeStorage`
