# eBPFä¸å®¹å™¨æŠ€æœ¯

## ğŸ“‹ ç›®å½•

- [eBPFä¸å®¹å™¨æŠ€æœ¯](#ebpfä¸å®¹å™¨æŠ€æœ¯)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¦‚è¿°](#æ¦‚è¿°)
    - [eBPFåœ¨å®¹å™¨ç”Ÿæ€ä¸­çš„é©å‘½](#ebpfåœ¨å®¹å™¨ç”Ÿæ€ä¸­çš„é©å‘½)
    - [æ ¸å¿ƒä»·å€¼](#æ ¸å¿ƒä»·å€¼)
    - [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
  - [Cilium CNI](#cilium-cni)
    - [Ciliumæ¦‚è¿°](#ciliumæ¦‚è¿°)
    - [æ¶æ„åŸç†](#æ¶æ„åŸç†)
    - [eBPF DataPath](#ebpf-datapath)
    - [Ciliuméƒ¨ç½²](#ciliuméƒ¨ç½²)
    - [ç½‘ç»œç­–ç•¥](#ç½‘ç»œç­–ç•¥)
      - [L3/L4ç½‘ç»œç­–ç•¥](#l3l4ç½‘ç»œç­–ç•¥)
      - [L7ç½‘ç»œç­–ç•¥ (HTTP)](#l7ç½‘ç»œç­–ç•¥-http)
      - [ç½‘ç»œç­–ç•¥æµ‹è¯•](#ç½‘ç»œç­–ç•¥æµ‹è¯•)
    - [Serviceè´Ÿè½½å‡è¡¡](#serviceè´Ÿè½½å‡è¡¡)
      - [kube-proxyæ›¿ä»£æ¨¡å¼](#kube-proxyæ›¿ä»£æ¨¡å¼)
      - [Kubernetes Serviceæ”¯æŒ](#kubernetes-serviceæ”¯æŒ)
      - [Serviceè´Ÿè½½å‡è¡¡ç®—æ³•](#serviceè´Ÿè½½å‡è¡¡ç®—æ³•)
      - [ExternalIPså’ŒLoadBalancer](#externalipså’Œloadbalancer)
    - [ClusterMeshå¤šé›†ç¾¤](#clustermeshå¤šé›†ç¾¤)
      - [ClusterMeshæ¶æ„](#clustermeshæ¶æ„)
      - [éƒ¨ç½²ClusterMesh](#éƒ¨ç½²clustermesh)
  - [å®¹å™¨å¯è§‚æµ‹æ€§ - Hubble](#å®¹å™¨å¯è§‚æµ‹æ€§---hubble)
    - [Hubbleæ¦‚è¿°](#hubbleæ¦‚è¿°)
    - [Hubbleéƒ¨ç½²](#hubbleéƒ¨ç½²)
    - [Hubble CLIä½¿ç”¨](#hubble-cliä½¿ç”¨)
    - [Hubbleç›‘æ§æŒ‡æ ‡](#hubbleç›‘æ§æŒ‡æ ‡)
  - [å®æˆ˜æ¡ˆä¾‹](#å®æˆ˜æ¡ˆä¾‹)
    - [æ¡ˆä¾‹1: Ciliumæ›¿ä»£kube-proxy](#æ¡ˆä¾‹1-ciliumæ›¿ä»£kube-proxy)
    - [æ¡ˆä¾‹2: Hubbleå¯è§‚æµ‹æ€§å®æˆ˜](#æ¡ˆä¾‹2-hubbleå¯è§‚æµ‹æ€§å®æˆ˜)
    - [æ¡ˆä¾‹3: L7ç½‘ç»œç­–ç•¥å®æˆ˜](#æ¡ˆä¾‹3-l7ç½‘ç»œç­–ç•¥å®æˆ˜)
  - [æ€§èƒ½å¯¹æ¯”](#æ€§èƒ½å¯¹æ¯”)
    - [Cilium eBPF vs ä¼ ç»Ÿæ–¹æ¡ˆ](#cilium-ebpf-vs-ä¼ ç»Ÿæ–¹æ¡ˆ)
  - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
    - [ç”Ÿäº§éƒ¨ç½²æ¸…å•](#ç”Ÿäº§éƒ¨ç½²æ¸…å•)
    - [æ•…éšœæ’æŸ¥æ‰‹å†Œ](#æ•…éšœæ’æŸ¥æ‰‹å†Œ)
  - [å‚è€ƒèµ„æ–™](#å‚è€ƒèµ„æ–™)
  - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [æœ¬æ¨¡å—ç›¸å…³](#æœ¬æ¨¡å—ç›¸å…³)
    - [å…¶ä»–æ¨¡å—ç›¸å…³](#å…¶ä»–æ¨¡å—ç›¸å…³)

---

## æ¦‚è¿°

### eBPFåœ¨å®¹å™¨ç”Ÿæ€ä¸­çš„é©å‘½

**eBPFæŠ€æœ¯**æ­£åœ¨å½»åº•æ”¹å˜å®¹å™¨ç½‘ç»œã€å®‰å…¨å’Œå¯è§‚æµ‹æ€§çš„å®ç°æ–¹å¼ï¼Œå¸¦æ¥äº†å‰æ‰€æœªæœ‰çš„æ€§èƒ½æå‡å’Œçµæ´»æ€§ã€‚

```text
ä¼ ç»Ÿå®¹å™¨ç½‘ç»œ vs eBPFå®¹å™¨ç½‘ç»œ:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼ ç»Ÿå®¹å™¨ç½‘ç»œæ¶æ„ (iptables-based)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  Pod A                Pod B                                    â”‚
â”‚   â†“                    â†“                                       â”‚
â”‚  veth pair            veth pair                                â”‚
â”‚   â†“                    â†“                                       â”‚
â”‚  bridge/routing       bridge/routing                           â”‚
â”‚   â†“                    â†“                                       â”‚
â”‚  iptables rules (1000s+è§„åˆ™)                                   â”‚
â”‚   - PREROUTING                                                 â”‚
â”‚   - FORWARD                                                    â”‚
â”‚   - POSTROUTING                                                â”‚
â”‚   - NAT                                                        â”‚
â”‚   â†“                                                            â”‚
â”‚  ç½‘å¡                                                          â”‚
â”‚                                                                â”‚
â”‚  é—®é¢˜:                                                         â”‚
â”‚    âŒ iptablesè§„åˆ™çº¿æ€§åŒ¹é… (O(n))                              â”‚
â”‚    âŒ å¤§é‡è§„åˆ™å¯¼è‡´æ€§èƒ½ä¸‹é™                                      â”‚
â”‚    âŒ æ¯ä¸ªæ•°æ®åŒ…éƒ½è¦éå†æ‰€æœ‰è§„åˆ™                                 â”‚
â”‚    âŒ Serviceå»¶è¿Ÿ: 1-2ms                                       â”‚
â”‚    âŒ ååé‡: ~5Gbps                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ eBPFå®¹å™¨ç½‘ç»œæ¶æ„ (Cilium)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  Pod A                Pod B                                    â”‚
â”‚   â†“ (eBPF prog)       â†“ (eBPF prog)                            â”‚
â”‚  veth eBPF           veth eBPF                                 â”‚
â”‚   â†“                    â†“                                       â”‚
â”‚  eBPF Socket LB â”€â”€> Direct Pod-to-Pod (é›¶æ‹·è´)                 â”‚
â”‚   â†“                    â†“                                       â”‚
â”‚  ç½‘å¡ XDP/TC         ç½‘å¡ XDP/TC                                â”‚
â”‚                                                                â”‚
â”‚  ä¼˜åŠ¿:                                                         â”‚
â”‚    âœ… eBPF Mapå“ˆå¸ŒæŸ¥æ‰¾ (O(1))                                  â”‚
â”‚    âœ… Bypass iptables (æ€§èƒ½æå‡10x)                            â”‚
â”‚    âœ… é›¶æ‹·è´Socketé‡å®šå‘                                       â”‚
â”‚    âœ… Serviceå»¶è¿Ÿ: 20-50Î¼s (50-100x faster!)                  â”‚
â”‚    âœ… ååé‡: 10Gbps+ (2x faster)                              â”‚
â”‚    âœ… æ·±åº¦å¯è§‚æµ‹æ€§ (Hubble)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒä»·å€¼

```yaml
æ€§èƒ½æå‡:
  âœ… Serviceå»¶è¿Ÿ: 50-100x faster
  âœ… ååé‡: 2-3x improvement
  âœ… CPUä½¿ç”¨: 50% reduction
  âœ… è§„åˆ™å¤„ç†: O(1) vs O(n)

åŠŸèƒ½å¢å¼º:
  âœ… L3/L4/L7ç½‘ç»œç­–ç•¥
  âœ… æ·±åº¦å¯è§‚æµ‹æ€§ (Hubble)
  âœ… å¤šé›†ç¾¤äº’è” (ClusterMesh)
  âœ… é€æ˜åŠ å¯† (WireGuard/IPsec)

å®‰å…¨å¼ºåŒ–:
  âœ… è¿è¡Œæ—¶å®‰å…¨æ£€æµ‹
  âœ… ç»†ç²’åº¦ç½‘ç»œç­–ç•¥
  âœ… ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤
  âœ… æ–‡ä»¶è®¿é—®æ§åˆ¶

å¯è§‚æµ‹æ€§:
  âœ… æœåŠ¡æ‹“æ‰‘å›¾
  âœ… å®æ—¶æµé‡åˆ†æ
  âœ… åº”ç”¨å±‚åè®®å¯è§
  âœ… æ€§èƒ½ç“¶é¢ˆå®šä½
```

### æŠ€æœ¯æ¶æ„

```text
eBPFå®¹å™¨æŠ€æœ¯æ ˆå…¨æ™¯:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       åº”ç”¨å±‚                                    â”‚
â”‚  Kubernetes Pods â”‚ Docker Containers â”‚ Microservices          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Kubernetesæ§åˆ¶å¹³é¢                           â”‚
â”‚  API Server â”‚ Controller Manager â”‚ Scheduler                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Cilium Agent (æ¯ä¸ªèŠ‚ç‚¹)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Network Policy Controller â”‚ Service LB â”‚ ClusterMesh     â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ Hubble (Observability) â”‚ Envoy Proxy (L7) â”‚ Encryption  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    eBPF DataPath (å†…æ ¸)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ XDP: DDoSé˜²æŠ¤, æ—©æœŸè¿‡æ»¤                                  â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ TC: ç½‘ç»œç­–ç•¥, QoS, æµé‡æ•´å½¢                             â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ Socket: Service LB (é›¶æ‹·è´), è¿æ¥è¿½è¸ª                   â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ Kprobe/Tracepoint: å¯è§‚æµ‹æ€§, è¿½è¸ª                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    BPF Maps (å…±äº«çŠ¶æ€)                         â”‚
â”‚  Endpoint Map â”‚ Service Map â”‚ Policy Map â”‚ Conntrack Map     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Linux Kernel                                â”‚
â”‚  Networking â”‚ Security â”‚ Tracing â”‚ Cgroups                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Cilium CNI

### Ciliumæ¦‚è¿°

**Cilium** æ˜¯åŸºäºeBPFçš„äº‘åŸç”Ÿç½‘ç»œã€å¯è§‚æµ‹æ€§å’Œå®‰å…¨è§£å†³æ–¹æ¡ˆï¼Œæ˜¯CNCFæ¯•ä¸šé¡¹ç›®ã€‚

```yaml
Ciliumæ ¸å¿ƒç‰¹æ€§:
  ç½‘ç»œ:
    âœ… eBPF-based CNI
    âœ… L3/L4/L7ç½‘ç»œç­–ç•¥
    âœ… Serviceè´Ÿè½½å‡è¡¡ (æ›¿ä»£kube-proxy)
    âœ… å¤šé›†ç¾¤äº’è” (ClusterMesh)
    âœ… é€æ˜åŠ å¯† (WireGuard/IPsec)
    âœ… Egress Gateway

  å¯è§‚æµ‹æ€§:
    âœ… Hubble: æ·±åº¦ç½‘ç»œå¯è§æ€§
    âœ… æœåŠ¡æ‹“æ‰‘å›¾
    âœ… å®æ—¶æµé‡åˆ†æ
    âœ… L7åè®®å¯è§ (HTTP/gRPC/Kafka/DNS)

  å®‰å…¨:
    âœ… ç½‘ç»œç­–ç•¥ (L3-L7)
    âœ… è¿è¡Œæ—¶å®‰å…¨ (Tetragon)
    âœ… æœåŠ¡é—´mTLS
    âœ… é€æ˜åŠ å¯†

  æ€§èƒ½:
    âœ… Serviceå»¶è¿Ÿ: 20-50Î¼s (vs 1-2ms)
    âœ… ååé‡: 10Gbps+ (vs ~5Gbps)
    âœ… CPUä½¿ç”¨: 50% reduction

Ciliumé€‚ç”¨åœºæ™¯:
  âœ… é«˜æ€§èƒ½å®¹å™¨ç½‘ç»œ
  âœ… å¤æ‚ç½‘ç»œç­–ç•¥ (L7)
  âœ… å¤šé›†ç¾¤äº’è”
  âœ… æ·±åº¦å¯è§‚æµ‹æ€§
  âœ… Serverless/è¾¹ç¼˜è®¡ç®—
```

### æ¶æ„åŸç†

**Ciliumæ¶æ„å…¨æ™¯**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ciliumæ¶æ„                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Kubernetes Cluster                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Kubernetes API Server                  â”‚ â”‚
â”‚  â”‚  - Endpoints                                              â”‚ â”‚
â”‚  â”‚  - Services                                               â”‚ â”‚
â”‚  â”‚  - NetworkPolicies                                        â”‚ â”‚
â”‚  â”‚  - CiliumNetworkPolicies (CRD)                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ Watch                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Cilium Operator (Cluster-wide)              â”‚ â”‚
â”‚  â”‚  - ClusterMesh coordination                              â”‚ â”‚
â”‚  â”‚  - Identity allocation                                    â”‚ â”‚
â”‚  â”‚  - CRD management                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“                                     â”‚
â”‚  æ¯ä¸ªNode:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Cilium Agent (DaemonSet)                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ Policy Enforcement Engine                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - L3/L4/L7 policies                                 â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Identity-based security                           â”‚ â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚
â”‚  â”‚  â”‚ Service Load Balancer                               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - eBPF sockmap (é›¶æ‹·è´)                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Maglev consistent hashing                        â”‚ â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚
â”‚  â”‚  â”‚ Hubble Server (Observability)                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Flow monitoring                                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Metrics collection                                â”‚ â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚
â”‚  â”‚  â”‚ Envoy Proxy (Optional, for L7)                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - HTTP/gRPC/Kafka filtering                        â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                          â†“                                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚         eBPF Programs (Kernel Space)               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ XDP: DDoS defense, early filtering           â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ TC Ingress: Policy enforcement, LB           â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ TC Egress: NAT, encryption, policy           â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ Socket LB: é›¶æ‹·è´Pod-to-Pod                  â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ Kprobe: Observability, tracing               â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                          â†“                                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚         BPF Maps (Shared State)                    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Endpoint Map (Pod identity)                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Service Map (ClusterIP â†’ Backends)             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Policy Map (Security rules)                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Conntrack Map (Connection tracking)            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - LB Map (Load balancer state)                    â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  Pod Network:                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  veth  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  veth  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Pod A  â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚ Host   â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚ Pod B  â”‚             â”‚
â”‚  â”‚        â”‚  eBPF  â”‚ eBPF   â”‚  eBPF  â”‚        â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç»„ä»¶**:

```yaml
Cilium Operator:
  - å…¨å±€å”¯ä¸€ï¼Œç®¡ç†é›†ç¾¤çº§åˆ«èµ„æº
  - åˆ†é…Podèº«ä»½æ ‡è¯† (Identity)
  - ç®¡ç†ClusterMesh
  - åè°ƒCRD

Cilium Agent (æ¯ä¸ªèŠ‚ç‚¹):
  - ç®¡ç†æœ¬èŠ‚ç‚¹çš„eBPFç¨‹åº
  - æ‰§è¡Œç½‘ç»œç­–ç•¥
  - å®ç°Serviceè´Ÿè½½å‡è¡¡
  - æ”¶é›†å¯è§‚æµ‹æ€§æ•°æ®

eBPF DataPath:
  - XDP: æ—©æœŸè¿‡æ»¤ã€DDoSé˜²æŠ¤
  - TC: ç½‘ç»œç­–ç•¥ã€NATã€åŠ å¯†
  - Socket: é›¶æ‹·è´Service LB
  - Kprobe: å¯è§‚æµ‹æ€§è¿½è¸ª

BPF Maps:
  - å­˜å‚¨Podèº«ä»½ã€Serviceæ˜ å°„ã€ç­–ç•¥è§„åˆ™ç­‰
  - ç”¨æˆ·æ€Cilium Agentä¸å†…æ ¸æ€eBPFç¨‹åºä¹‹é—´çš„é€šä¿¡æ¡¥æ¢
```

### eBPF DataPath

**Cilium eBPF DataPathè¯¦è§£**:

```text
æ•°æ®åŒ…åœ¨Ciliumä¸­çš„å¤„ç†æµç¨‹:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ingress (å…¥ç«™æµé‡)                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. æ•°æ®åŒ…åˆ°è¾¾ç½‘å¡                                             â”‚
â”‚     â†“                                                          â”‚
â”‚  2. XDPç¨‹åº (æœ€æ—©é’©å­ç‚¹)                                       â”‚
â”‚     - DDoSé˜²æŠ¤ (é»‘åå•IPå¿«é€Ÿä¸¢å¼ƒ)                             â”‚
â”‚     - ç®€å•ACL                                                  â”‚
â”‚     - æ€§èƒ½: 24M+ pps                                           â”‚
â”‚     â†“                                                          â”‚
â”‚  3. è¿›å…¥å†…æ ¸ç½‘ç»œæ ˆ                                             â”‚
â”‚     â†“                                                          â”‚
â”‚  4. TC Ingressç¨‹åº (to-container)                             â”‚
â”‚     - æŸ¥æ‰¾Endpointèº«ä»½ (BPF Map: endpoint_map)                â”‚
â”‚     - æ‰§è¡ŒL3/L4ç½‘ç»œç­–ç•¥ (BPF Map: policy_map)                 â”‚
â”‚     - Serviceè´Ÿè½½å‡è¡¡ (BPF Map: service_map)                  â”‚
â”‚     - è¿æ¥è¿½è¸ª (BPF Map: conntrack_map)                       â”‚
â”‚     â†“                                                          â”‚
â”‚  5. å¦‚æœç›®æ ‡æ˜¯æœ¬åœ°Pod:                                         â”‚
â”‚     â†“                                                          â”‚
â”‚  6. veth pairåˆ°Pod                                            â”‚
â”‚     - TCç¨‹åºæ£€æŸ¥L7ç­–ç•¥ (å¯é€‰, éœ€Envoy)                        â”‚
â”‚     â†“                                                          â”‚
â”‚  7. Podæ¥æ”¶æ•°æ®åŒ…                                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Egress (å‡ºç«™æµé‡)                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. Podå‘é€æ•°æ®åŒ…                                              â”‚
â”‚     â†“                                                          â”‚
â”‚  2. veth pairçš„TC Egressç¨‹åº (from-container)                 â”‚
â”‚     - æŸ¥æ‰¾æºEndpointèº«ä»½                                       â”‚
â”‚     - æ‰§è¡ŒEgressç½‘ç»œç­–ç•¥                                       â”‚
â”‚     - NATè½¬æ¢ (å¦‚éœ€è¦)                                         â”‚
â”‚     â†“                                                          â”‚
â”‚  3. Socket LB (å¦‚æœç›®æ ‡æ˜¯Service)                             â”‚
â”‚     - eBPF sockmapé›¶æ‹·è´é‡å®šå‘                                â”‚
â”‚     - ç›´æ¥è½¬å‘åˆ°ç›®æ ‡Pod Socket (ç»•è¿‡ç½‘ç»œæ ˆ!)                  â”‚
â”‚     - å»¶è¿Ÿ: 20-50Î¼s (vs 1-2ms)                               â”‚
â”‚     â†“ (å¦‚æœä¸èƒ½ä½¿ç”¨Socket LB)                                 â”‚
â”‚  4. ä¸»æœºè·¯ç”±åˆ°ç›®æ ‡Podæˆ–å¤–éƒ¨ç½‘ç»œ                                â”‚
â”‚     â†“                                                          â”‚
â”‚  5. TC Egressç¨‹åº (from-netdev)                               â”‚
â”‚     - é€æ˜åŠ å¯† (WireGuard/IPsec, å¦‚å¯ç”¨)                      â”‚
â”‚     - NAT                                                      â”‚
â”‚     â†“                                                          â”‚
â”‚  6. æ•°æ®åŒ…ç¦»å¼€èŠ‚ç‚¹                                             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®eBPFç¨‹åºç±»å‹:
  - bpf_lxc.o: é™„åŠ åˆ°Pod veth pair (to-container, from-container)
  - bpf_netdev.o: é™„åŠ åˆ°ç‰©ç†ç½‘å¡ (from-netdev)
  - bpf_host.o: é™„åŠ åˆ°ä¸»æœºç½‘ç»œæ ˆ
  - bpf_overlay.o: Overlayç½‘ç»œ (VXLAN/Geneve)
  - bpf_sock.o: Socketå±‚Service LB
```

### Ciliuméƒ¨ç½²

**åœ¨Kubernetesé›†ç¾¤ä¸­éƒ¨ç½²Cilium**:

```bash
# æ–¹å¼1: ä½¿ç”¨Cilium CLI (æ¨è)

# 1. å®‰è£…Cilium CLI
CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/master/stable.txt)
CLI_ARCH=amd64
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}

# 2. å®‰è£…Ciliumåˆ°Kubernetesé›†ç¾¤
cilium install \
  --version 1.14.5 \
  --set kubeProxyReplacement=strict \
  --set k8sServiceHost=<K8S_API_SERVER_IP> \
  --set k8sServicePort=<K8S_API_SERVER_PORT>

# å‚æ•°è¯´æ˜:
#   --version: Ciliumç‰ˆæœ¬
#   --set kubeProxyReplacement=strict: å®Œå…¨æ›¿ä»£kube-proxy
#   --set k8sServiceHost/Port: K8s API Serveråœ°å€ (kube-proxyæ›¿ä»£æ¨¡å¼éœ€è¦)

# 3. éªŒè¯å®‰è£…
cilium status --wait

# è¾“å‡ºç¤ºä¾‹:
#     /Â¯Â¯\
#  /Â¯Â¯\__/Â¯Â¯\    Cilium:         OK
#  \__/Â¯Â¯\__/    Operator:       OK
#  /Â¯Â¯\__/Â¯Â¯\    Hubble:         OK
#  \__/Â¯Â¯\__/    ClusterMesh:    disabled
#     \__/
#
# Deployment        cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
# DaemonSet         cilium             Desired: 3, Ready: 3/3, Available: 3/3
# Containers:       cilium             Running: 3
#                   cilium-operator    Running: 2

# 4. è¿æ¥æ€§æµ‹è¯•
cilium connectivity test

# 5. æŸ¥çœ‹Cilium Pod
kubectl get pods -n kube-system -l k8s-app=cilium

# 6. æŸ¥çœ‹Ciliumé…ç½®
kubectl -n kube-system exec -it cilium-xxxxx -- cilium status --verbose
```

**æ–¹å¼2: ä½¿ç”¨Helm**:

```bash
# 1. æ·»åŠ Cilium Helmä»“åº“
helm repo add cilium https://helm.cilium.io/
helm repo update

# 2. å®‰è£…Cilium
helm install cilium cilium/cilium \
  --version 1.14.5 \
  --namespace kube-system \
  --set kubeProxyReplacement=strict \
  --set k8sServiceHost=<K8S_API_SERVER_IP> \
  --set k8sServicePort=<K8S_API_SERVER_PORT> \
  --set hubble.relay.enabled=true \
  --set hubble.ui.enabled=true

# 3. éªŒè¯
kubectl -n kube-system get pods -l k8s-app=cilium
```

**Ciliumé…ç½®é€‰é¡¹** (values.yaml):

```yaml
# values.yaml - Ciliumé…ç½®
kubeProxyReplacement: strict  # æ›¿ä»£kube-proxy (strict/probe/disabled)

# Kubernetes API Serveråœ°å€ (kube-proxyæ›¿ä»£æ¨¡å¼éœ€è¦)
k8sServiceHost: "192.168.1.100"
k8sServicePort: "6443"

# IPAMæ¨¡å¼
ipam:
  mode: "kubernetes"  # kubernetes/cluster-pool/azure/eni/alibaba-cloud

# éš§é“æ¨¡å¼
tunnelProtocol: ""  # "" (Direct Routing) / "vxlan" / "geneve"

# å¯ç”¨XDPåŠ é€Ÿ
loadBalancer:
  acceleration: native  # native/disabled

# å¯ç”¨Hubbleå¯è§‚æµ‹æ€§
hubble:
  enabled: true
  relay:
    enabled: true
  ui:
    enabled: true

# å¯ç”¨é€æ˜åŠ å¯†
encryption:
  enabled: true
  type: wireguard  # wireguard/ipsec

# L7ä»£ç† (Envoy)
proxy:
  prometheus:
    enabled: true

# ç½‘ç»œç­–ç•¥
policyEnforcementMode: "default"  # default/always/never

# ClusterMeshå¤šé›†ç¾¤
clustermesh:
  useAPIServer: true
  config:
    enabled: true

# Cilium Operatorå‰¯æœ¬æ•°
operator:
  replicas: 2

# èµ„æºé™åˆ¶
resources:
  limits:
    cpu: 4000m
    memory: 4Gi
  requests:
    cpu: 100m
    memory: 512Mi
```

**éªŒè¯CiliumåŠŸèƒ½**:

```bash
# 1. æ£€æŸ¥Endpoint (Podç½‘ç»œæ¥å£)
kubectl -n kube-system exec -it cilium-xxxxx -- cilium endpoint list

# è¾“å‡ºç¤ºä¾‹:
# ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])
# 123        Enabled            Enabled           12345      k8s:app=nginx
# 456        Enabled            Enabled           23456      k8s:app=redis

# 2. æ£€æŸ¥Service (è´Ÿè½½å‡è¡¡)
kubectl -n kube-system exec -it cilium-xxxxx -- cilium service list

# 3. æ£€æŸ¥BPF Maps
kubectl -n kube-system exec -it cilium-xxxxx -- cilium bpf lb list

# 4. æ£€æŸ¥ç½‘ç»œç­–ç•¥
kubectl -n kube-system exec -it cilium-xxxxx -- cilium policy get

# 5. æŸ¥çœ‹è¿æ¥è¿½è¸ª
kubectl -n kube-system exec -it cilium-xxxxx -- cilium bpf ct list global

# 6. ç›‘æ§å®æ—¶æµé‡ (Hubble)
kubectl -n kube-system exec -it cilium-xxxxx -- hubble observe
```

### ç½‘ç»œç­–ç•¥

**Ciliumç½‘ç»œç­–ç•¥** æ”¯æŒL3/L4/L7å¤šå±‚çº§ç­–ç•¥ï¼Œæ¯”KubernetesåŸç”ŸNetworkPolicyæ›´å¼ºå¤§ã€‚

#### L3/L4ç½‘ç»œç­–ç•¥

**åŸºäºæ ‡ç­¾çš„L3/L4ç­–ç•¥**:

```yaml
# cilium-l3-l4-policy.yaml - L3/L4ç½‘ç»œç­–ç•¥
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: backend-policy
  namespace: prod
spec:
  # ç­–ç•¥åº”ç”¨åˆ°å“ªäº›Pod
  endpointSelector:
    matchLabels:
      app: backend
      env: prod

  # Ingressè§„åˆ™ (å…¥ç«™æµé‡)
  ingress:
  # è§„åˆ™1: å…è®¸frontendè®¿é—®backendçš„8080ç«¯å£
  - fromEndpoints:
    - matchLabels:
        app: frontend
        env: prod
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP

  # è§„åˆ™2: å…è®¸monitoringè®¿é—®metricsç«¯å£
  - fromEndpoints:
    - matchLabels:
        app: prometheus
    toPorts:
    - ports:
      - port: "9090"
        protocol: TCP

  # Egressè§„åˆ™ (å‡ºç«™æµé‡)
  egress:
  # è§„åˆ™1: å…è®¸backendè®¿é—®database
  - toEndpoints:
    - matchLabels:
        app: database
        env: prod
    toPorts:
    - ports:
      - port: "5432"
        protocol: TCP

  # è§„åˆ™2: å…è®¸è®¿é—®å¤–éƒ¨API (åŸºäºCIDR)
  - toCIDR:
    - "8.8.8.8/32"  # Google DNS
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP

  # è§„åˆ™3: å…è®¸è®¿é—®ç‰¹å®šFQDN
  - toFQDNs:
    - matchName: "api.example.com"
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
```

**åº”ç”¨ç­–ç•¥**:

```bash
# åº”ç”¨ç­–ç•¥
kubectl apply -f cilium-l3-l4-policy.yaml

# æŸ¥çœ‹ç­–ç•¥çŠ¶æ€
kubectl get cnp -n prod

# æŸ¥çœ‹ç­–ç•¥è¯¦æƒ…
kubectl describe cnp backend-policy -n prod

# æŸ¥çœ‹Podçš„ç­–ç•¥æ‰§è¡Œæƒ…å†µ
kubectl -n kube-system exec -it cilium-xxxxx -- \
  cilium endpoint list | grep backend
```

#### L7ç½‘ç»œç­–ç•¥ (HTTP)

**åŸºäºHTTPæ–¹æ³•å’Œè·¯å¾„çš„L7ç­–ç•¥**:

```yaml
# cilium-l7-http-policy.yaml - L7 HTTPç­–ç•¥
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: api-l7-policy
  namespace: prod
spec:
  endpointSelector:
    matchLabels:
      app: api-server

  ingress:
  # å…è®¸frontendè®¿é—®ç‰¹å®šHTTP API
  - fromEndpoints:
    - matchLabels:
        app: frontend
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP
      rules:
        http:
        # è§„åˆ™1: å…è®¸GET /api/v1/users
        - method: "GET"
          path: "/api/v1/users.*"

        # è§„åˆ™2: å…è®¸POST /api/v1/users (åˆ›å»ºç”¨æˆ·)
        - method: "POST"
          path: "/api/v1/users"
          headers:
          - "Content-Type: application/json"

        # è§„åˆ™3: æ‹’ç»DELETEè¯·æ±‚ (éšå¼æ‹’ç»ï¼Œä¸åˆ—å‡ºå³æ‹’ç»)

  # å…è®¸adminå®Œå…¨è®¿é—®
  - fromEndpoints:
    - matchLabels:
        role: admin
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP
      rules:
        http:
        - method: ".*"  # æ‰€æœ‰HTTPæ–¹æ³•
          path: "/.*"   # æ‰€æœ‰è·¯å¾„
```

**L7 Kafkaç­–ç•¥**:

```yaml
# cilium-l7-kafka-policy.yaml - L7 Kafkaç­–ç•¥
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: kafka-policy
  namespace: prod
spec:
  endpointSelector:
    matchLabels:
      app: kafka

  ingress:
  # Consumeråªèƒ½è¯»å–ç‰¹å®šTopic
  - fromEndpoints:
    - matchLabels:
        role: consumer
    toPorts:
    - ports:
      - port: "9092"
        protocol: TCP
      rules:
        kafka:
        - role: "consume"
          topic: "orders"
        - role: "consume"
          topic: "events"

  # Producerå¯ä»¥å†™å…¥ç‰¹å®šTopic
  - fromEndpoints:
    - matchLabels:
        role: producer
    toPorts:
    - ports:
      - port: "9092"
        protocol: TCP
      rules:
        kafka:
        - role: "produce"
          topic: "orders"
```

#### ç½‘ç»œç­–ç•¥æµ‹è¯•

**æµ‹è¯•ç½‘ç»œç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆ**:

```bash
# 1. åˆ›å»ºæµ‹è¯•Pods
kubectl run frontend --image=nginx --labels="app=frontend,env=prod"
kubectl run backend --image=nginx --labels="app=backend,env=prod"
kubectl run unauthorized --image=nginx --labels="app=unauthorized"

# 2. åº”ç”¨ç½‘ç»œç­–ç•¥
kubectl apply -f cilium-l3-l4-policy.yaml

# 3. æµ‹è¯•è¿æ¥
# ä»frontend Podè®¿é—®backend (åº”è¯¥æˆåŠŸ)
kubectl exec frontend -- curl -m 3 backend:8080

# ä»unauthorized Podè®¿é—®backend (åº”è¯¥å¤±è´¥/è¶…æ—¶)
kubectl exec unauthorized -- curl -m 3 backend:8080
# é¢„æœŸ: curl: (28) Connection timed out

# 4. æŸ¥çœ‹æ‹’ç»çš„æµé‡ (ä½¿ç”¨Hubble)
kubectl -n kube-system exec -it cilium-xxxxx -- \
  hubble observe --verdict DROPPED --last 100

# 5. æŸ¥çœ‹ç­–ç•¥ç»Ÿè®¡
kubectl -n kube-system exec -it cilium-xxxxx -- \
  cilium policy selectors
```

### Serviceè´Ÿè½½å‡è¡¡

**Ciliumå®Œå…¨æ›¿ä»£kube-proxy**ï¼Œä½¿ç”¨eBPFå®ç°Serviceè´Ÿè½½å‡è¡¡ï¼Œæ€§èƒ½æå‡10x+ã€‚

#### kube-proxyæ›¿ä»£æ¨¡å¼

```yaml
é…ç½®æ¨¡å¼:
  strict: å®Œå…¨æ›¿ä»£kube-proxy (æ¨èç”Ÿäº§)
  probe: æ£€æµ‹kube-proxyï¼Œå­˜åœ¨åˆ™å…±å­˜
  disabled: ä¸æ›¿ä»£kube-proxy

æ€§èƒ½å¯¹æ¯”:
  kube-proxy (iptables):
    å»¶è¿Ÿ: 1-2ms
    åå: ~5Gbps
    è§„åˆ™å¤æ‚åº¦: O(n) çº¿æ€§åŒ¹é…
    CPU: é«˜

  Cilium eBPF:
    å»¶è¿Ÿ: 20-50Î¼s (50-100x faster!)
    åå: 10Gbps+ (2x faster)
    è§„åˆ™å¤æ‚åº¦: O(1) å“ˆå¸ŒæŸ¥æ‰¾
    CPU: 50% reduction
```

**eBPF Service LBæ¶æ„**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cilium Serviceè´Ÿè½½å‡è¡¡æ¶æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Client Pod                                                    â”‚
â”‚   â”‚                                                             â”‚
â”‚   â”‚ connect(ClusterIP:80)                                      â”‚
â”‚   â†“                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Socket Level Load Balancer (sockmap)                    â”‚  â”‚
â”‚  â”‚ - eBPF sk_msg program                                    â”‚  â”‚
â”‚  â”‚ - æŸ¥æ‰¾Service Map: ClusterIP â†’ Backend Pods             â”‚  â”‚
â”‚  â”‚ - Maglevä¸€è‡´æ€§å“ˆå¸Œé€‰æ‹©åç«¯                              â”‚  â”‚
â”‚  â”‚ - é›¶æ‹·è´é‡å®šå‘åˆ°ç›®æ ‡Pod Socket                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚   â”‚ (å¦‚æœSocket LBä¸é€‚ç”¨, fallbackåˆ°Packet LB)               â”‚
â”‚   â†“                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Packet Level Load Balancer (TC/XDP)                     â”‚  â”‚
â”‚  â”‚ - TC Ingress eBPF program                                â”‚  â”‚
â”‚  â”‚ - ä¿®æ”¹ç›®æ ‡IP:Portä¸ºBackend Pod                           â”‚  â”‚
â”‚  â”‚ - DNAT (Destination NAT)                                 â”‚  â”‚
â”‚  â”‚ - è¿æ¥è¿½è¸ª (Conntrack Map)                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚   â”‚                                                             â”‚
â”‚   â†“                                                            â”‚
â”‚  Backend Pod                                                   â”‚
â”‚                                                                 â”‚
â”‚  BPF Maps:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Service Map:                                           â”‚   â”‚
â”‚  â”‚   ClusterIP:Port â†’ [Backend1, Backend2, Backend3]     â”‚   â”‚
â”‚  â”‚   10.96.0.10:80 â†’ [Pod1:80, Pod2:80, Pod3:80]         â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Backend Map (Maglevå“ˆå¸Œè¡¨):                           â”‚   â”‚
â”‚  â”‚   Hash(ClientIP, Port) â†’ Backend Index               â”‚   â”‚
â”‚  â”‚   ä¼šè¯ä¿æŒ (Same client â†’ Same backend)              â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Conntrack Map:                                         â”‚   â”‚
â”‚  â”‚   è¿æ¥è·Ÿè¸ªï¼Œç¡®ä¿å›ç¨‹æµé‡æ­£ç¡®SNAT                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Kubernetes Serviceæ”¯æŒ

**Ciliumæ”¯æŒæ‰€æœ‰Kubernetes Serviceç±»å‹**:

```yaml
# 1. ClusterIP Service
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: prod
spec:
  type: ClusterIP
  selector:
    app: backend
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP

---
# 2. NodePort Service
apiVersion: v1
kind: Service
metadata:
  name: backend-nodeport
  namespace: prod
spec:
  type: NodePort
  selector:
    app: backend
  ports:
  - port: 80
    targetPort: 8080
    nodePort: 30080  # åœ¨æ‰€æœ‰èŠ‚ç‚¹çš„30080ç«¯å£æš´éœ²
    protocol: TCP

---
# 3. LoadBalancer Service
apiVersion: v1
kind: Service
metadata:
  name: backend-lb
  namespace: prod
spec:
  type: LoadBalancer
  selector:
    app: backend
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP

---
# 4. Headless Service (æ— ClusterIP)
apiVersion: v1
kind: Service
metadata:
  name: backend-headless
  namespace: prod
spec:
  clusterIP: None  # Headless
  selector:
    app: backend
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
```

#### Serviceè´Ÿè½½å‡è¡¡ç®—æ³•

**Ciliumæ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•**:

```yaml
# Cilium ConfigMapé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: cilium-config
  namespace: kube-system
data:
  # è´Ÿè½½å‡è¡¡æ¨¡å¼
  bpf-lb-algorithm: "maglev"  # random/maglev

  # Maglevå“ˆå¸Œè¡¨å¤§å° (è¶Šå¤§è¶Šå‡è¡¡)
  bpf-lb-maglev-table-size: "65521"

  # ä¼šè¯äº²å’Œæ€§ (Session Affinity)
  bpf-lb-session-affinity: "true"

  # ä¼šè¯è¶…æ—¶æ—¶é—´
  bpf-lb-session-timeout: "300"  # 300ç§’
```

**Maglevä¸€è‡´æ€§å“ˆå¸Œ**:

```text
Maglevç®—æ³•ä¼˜åŠ¿:
  âœ… ä¸€è‡´æ€§: åç«¯å˜åŒ–æ—¶ï¼Œæœ€å°åŒ–è¿æ¥é‡æ–°åˆ†é…
  âœ… å‡è¡¡æ€§: æµé‡å‡åŒ€åˆ†é…åˆ°å„åç«¯
  âœ… ä¼šè¯ä¿æŒ: åŒä¸€å®¢æˆ·ç«¯æµé‡åˆ°åŒä¸€åç«¯
  âœ… å¿«é€ŸæŸ¥è¡¨: O(1)å“ˆå¸ŒæŸ¥æ‰¾

å·¥ä½œåŸç†:
  1. ä¸ºæ¯ä¸ªBackendç”ŸæˆMaglev lookupè¡¨
  2. Hash(ClientIP, Port) â†’ è¡¨ç´¢å¼•
  3. è¡¨ç´¢å¼• â†’ Backend
  4. åç«¯å˜åŒ–æ—¶ï¼Œåªé‡æ–°è®¡ç®—å—å½±å“éƒ¨åˆ†

ç¤ºä¾‹:
  Backends: [Pod1, Pod2, Pod3]
  Maglev Table Size: 65521

  Client A (Hash=1234) â†’ Table[1234] â†’ Pod2
  Client B (Hash=5678) â†’ Table[5678] â†’ Pod1

  Pod2ä¸‹çº¿å:
  Client A â†’ Table[1234] â†’ Pod3 (é‡æ–°æ˜ å°„)
  Client B â†’ Table[5678] â†’ Pod1 (ä¸å˜!)
```

#### ExternalIPså’ŒLoadBalancer

**æš´éœ²Serviceåˆ°å¤–éƒ¨ç½‘ç»œ**:

```yaml
# 1. ä½¿ç”¨ExternalIPs
apiVersion: v1
kind: Service
metadata:
  name: backend-external
  namespace: prod
spec:
  type: ClusterIP
  externalIPs:
  - 203.0.113.10  # å¤–éƒ¨å¯è®¿é—®çš„IP
  selector:
    app: backend
  ports:
  - port: 80
    targetPort: 8080

---
# 2. ä½¿ç”¨LoadBalancer + MetalLB
apiVersion: v1
kind: Service
metadata:
  name: backend-lb
  namespace: prod
  annotations:
    metallb.universe.tf/address-pool: production-pool
spec:
  type: LoadBalancer
  loadBalancerIP: 203.0.113.20  # å¯é€‰: æŒ‡å®šIP
  selector:
    app: backend
  ports:
  - port: 80
    targetPort: 8080
```

### ClusterMeshå¤šé›†ç¾¤

**ClusterMesh** å®ç°å¤šä¸ªKubernetesé›†ç¾¤ä¹‹é—´çš„Podäº’è”å’ŒServiceå…±äº«ã€‚

#### ClusterMeshæ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cilium ClusterMeshæ¶æ„                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Cluster 1 (us-west)                Cluster 2 (us-east)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Cilium Agent         â”‚          â”‚ Cilium Agent         â”‚  â”‚
â”‚  â”‚ - Pod Identity: 1/2 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ - Pod Identity: 1/2 â”‚  â”‚
â”‚  â”‚ - Service: svc1     â”‚  etcd    â”‚ - Service: svc1     â”‚  â”‚
â”‚  â”‚ - Endpoints         â”‚  sync    â”‚ - Endpoints         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                                   â†“                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ClusterMesh API     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ ClusterMesh API     â”‚  â”‚
â”‚  â”‚ (etcd)              â”‚  TLS     â”‚ (etcd)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  åŠŸèƒ½:                                                         â”‚
â”‚  âœ… è·¨é›†ç¾¤Podç›´æ¥é€šä¿¡                                          â”‚
â”‚  âœ… è·¨é›†ç¾¤Serviceè´Ÿè½½å‡è¡¡                                      â”‚
â”‚  âœ… å…¨å±€Service (æ‰€æœ‰é›†ç¾¤å…±äº«)                                 â”‚
â”‚  âœ… è·¨é›†ç¾¤ç½‘ç»œç­–ç•¥                                             â”‚
â”‚  âœ… é«˜å¯ç”¨ (é›†ç¾¤æ•…éšœè½¬ç§»)                                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### éƒ¨ç½²ClusterMesh

**æ­¥éª¤1: å¯ç”¨ClusterMesh**:

```bash
# é›†ç¾¤1
cilium clustermesh enable \
  --service-type LoadBalancer \
  --cluster-name cluster1 \
  --cluster-id 1

# é›†ç¾¤2
cilium clustermesh enable \
  --service-type LoadBalancer \
  --cluster-name cluster2 \
  --cluster-id 2

# æŸ¥çœ‹ClusterMeshçŠ¶æ€
cilium clustermesh status
```

**æ­¥éª¤2: è¿æ¥é›†ç¾¤**:

```bash
# åœ¨é›†ç¾¤1ä¸­è¿æ¥åˆ°é›†ç¾¤2
cilium clustermesh connect --context cluster1 --destination-context cluster2

# éªŒè¯è¿æ¥
cilium clustermesh status --context cluster1
# è¾“å‡ºåº”æ˜¾ç¤º: cluster2: ready

# åœ¨é›†ç¾¤2ä¸­éªŒè¯
cilium clustermesh status --context cluster2
# è¾“å‡ºåº”æ˜¾ç¤º: cluster1: ready
```

**æ­¥éª¤3: åˆ›å»ºå…¨å±€Service**:

```yaml
# global-service.yaml - è·¨é›†ç¾¤Service
apiVersion: v1
kind: Service
metadata:
  name: global-backend
  namespace: prod
  annotations:
    # æ ‡è®°ä¸ºå…¨å±€Service (æ‰€æœ‰é›†ç¾¤å…±äº«)
    io.cilium/global-service: "true"

    # å¯é€‰: è·¨é›†ç¾¤äº²å’Œæ€§ (ä¼˜å…ˆæœ¬åœ°)
    io.cilium/service-affinity: "local"
spec:
  type: ClusterIP
  selector:
    app: backend
  ports:
  - port: 80
    targetPort: 8080
```

**åº”ç”¨åˆ°ä¸¤ä¸ªé›†ç¾¤**:

```bash
# é›†ç¾¤1
kubectl --context cluster1 apply -f global-service.yaml

# é›†ç¾¤2
kubectl --context cluster2 apply -f global-service.yaml

# éªŒè¯: é›†ç¾¤1ä¸­çš„Podå¯ä»¥è®¿é—®é›†ç¾¤2ä¸­çš„åç«¯
kubectl --context cluster1 run test --rm -it --image=curlimages/curl -- \
  curl global-backend.prod.svc.cluster.local
```

**ClusterMeshæµé‡æ‹“æ‰‘**:

```text
åœºæ™¯: è·¨é›†ç¾¤Serviceè´Ÿè½½å‡è¡¡

Cluster 1 (us-west):
  Pod A â†’ global-backend:80
  â†“
  eBPF Service LB:
    Backends:
      - Pod B (cluster1) [æœ¬åœ°]     æƒé‡: 70%
      - Pod C (cluster1) [æœ¬åœ°]     æƒé‡: 30%
      - Pod D (cluster2) [è¿œç¨‹]     æƒé‡: 0% (æ­£å¸¸æƒ…å†µ)

  æ­£å¸¸æƒ…å†µ: æµé‡åªåˆ°æœ¬åœ°Backend (ä½å»¶è¿Ÿ)
  æ•…éšœæƒ…å†µ: æœ¬åœ°Backendå…¨éƒ¨ä¸å¯ç”¨ â†’ è‡ªåŠ¨åˆ‡æ¢åˆ°cluster2

Cluster 2 (us-east):
  Pod D â†’ global-backend:80
  â†“
  eBPF Service LB:
    Backends:
      - Pod E (cluster2) [æœ¬åœ°]     æƒé‡: 100%
      - Pod B (cluster1) [è¿œç¨‹]     æƒé‡: 0% (æ­£å¸¸æƒ…å†µ)

  è·¨é›†ç¾¤æ•…éšœè½¬ç§»è‡ªåŠ¨åŒ–!
```

---

## å®¹å™¨å¯è§‚æµ‹æ€§ - Hubble

### Hubbleæ¦‚è¿°

**Hubble** æ˜¯åŸºäºeBPFçš„Kubernetesç½‘ç»œã€æœåŠ¡å’Œå®‰å…¨å¯è§‚æµ‹æ€§å¹³å°ï¼Œå®Œå…¨é›†æˆåˆ°Ciliumä¸­ã€‚

```yaml
Hubbleæ ¸å¿ƒåŠŸèƒ½:
  ç½‘ç»œå¯è§‚æµ‹æ€§:
    âœ… å®æ—¶æµé‡ç›‘æ§
    âœ… æœåŠ¡ä¾èµ–æ‹“æ‰‘å›¾
    âœ… L3-L7æµé‡åˆ†æ
    âœ… DNSè§£æç›‘æ§

  åè®®å¯è§æ€§:
    âœ… HTTP/gRPC (æ–¹æ³•ã€è·¯å¾„ã€çŠ¶æ€ç )
    âœ… Kafka (Topicã€Partition)
    âœ… DNSæŸ¥è¯¢å’Œå“åº”
    âœ… TCPè¿æ¥è¿½è¸ª

  å®‰å…¨ç›‘æ§:
    âœ… ç½‘ç»œç­–ç•¥éªŒè¯
    âœ… è¢«æ‹’ç»çš„æµé‡
    âœ… å®‰å…¨äº‹ä»¶è¿½è¸ª
    âœ… å¼‚å¸¸æµé‡æ£€æµ‹

  æ€§èƒ½åˆ†æ:
    âœ… å»¶è¿Ÿç»Ÿè®¡
    âœ… ååé‡ç›‘æ§
    âœ… é”™è¯¯ç‡è¿½è¸ª
    âœ… SLAæŒ‡æ ‡

Hubbleæ¶æ„:
  - Hubble Server: æ¯ä¸ªèŠ‚ç‚¹æ”¶é›†æµé‡
  - Hubble Relay: é›†ç¾¤çº§èšåˆ
  - Hubble UI: Webå¯è§†åŒ–ç•Œé¢
  - Hubble CLI: å‘½ä»¤è¡Œå·¥å…·
```

### Hubbleéƒ¨ç½²

**å¯ç”¨Hubble**:

```bash
# æ–¹å¼1: ä½¿ç”¨Cilium CLIå¯ç”¨Hubble
cilium hubble enable --ui

# æ–¹å¼2: Helmå®‰è£…æ—¶å¯ç”¨
helm upgrade cilium cilium/cilium \
  --namespace kube-system \
  --reuse-values \
  --set hubble.relay.enabled=true \
  --set hubble.ui.enabled=true

# éªŒè¯Hubbleç»„ä»¶
kubectl get pods -n kube-system -l k8s-app=hubble-relay
kubectl get pods -n kube-system -l k8s-app=hubble-ui

# å®‰è£…Hubble CLI
export HUBBLE_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/hubble/master/stable.txt)
HUBBLE_ARCH=amd64
curl -L --fail --remote-name-all \
  https://github.com/cilium/hubble/releases/download/$HUBBLE_VERSION/hubble-linux-${HUBBLE_ARCH}.tar.gz{,.sha256sum}
sha256sum --check hubble-linux-${HUBBLE_ARCH}.tar.gz.sha256sum
sudo tar xzvfC hubble-linux-${HUBBLE_ARCH}.tar.gz /usr/local/bin
rm hubble-linux-${HUBBLE_ARCH}.tar.gz{,.sha256sum}

# éªŒè¯Hubble CLI
hubble version
```

**è®¿é—®Hubble UI**:

```bash
# æ–¹å¼1: Port-forwardè®¿é—®
kubectl port-forward -n kube-system svc/hubble-ui 12000:80

# è®¿é—®: http://localhost:12000

# æ–¹å¼2: åˆ›å»ºIngress
cat <<EOF | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hubble-ui
  namespace: kube-system
spec:
  rules:
  - host: hubble.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: hubble-ui
            port:
              number: 80
EOF
```

### Hubble CLIä½¿ç”¨

**åŸºæœ¬æµé‡è§‚å¯Ÿ**:

```bash
# 1. è¿æ¥åˆ°Hubble Relay
cilium hubble port-forward &

# 2. è§‚å¯Ÿå®æ—¶æµé‡
hubble observe

# è¾“å‡ºç¤ºä¾‹:
# Dec 19 10:15:23.456: default/frontend-xxx:45678 -> default/backend-xxx:8080 to-endpoint FORWARDED (TCP Flags: SYN)
# Dec 19 10:15:23.457: default/backend-xxx:8080 -> default/frontend-xxx:45678 to-endpoint FORWARDED (TCP Flags: SYN, ACK)

# 3. è¿‡æ»¤ç‰¹å®šå‘½åç©ºé—´
hubble observe --namespace prod

# 4. è¿‡æ»¤ç‰¹å®šPod
hubble observe --pod frontend

# 5. æŸ¥çœ‹è¢«æ‹’ç»çš„æµé‡ (ç½‘ç»œç­–ç•¥)
hubble observe --verdict DROPPED

# 6. æŸ¥çœ‹HTTPæµé‡
hubble observe --protocol http

# 7. æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„æµé‡
hubble observe --service backend

# 8. æŸ¥çœ‹æœ€è¿‘100æ¡æµé‡
hubble observe --last 100

# 9. å®æ—¶æµé‡ + JSONæ ¼å¼
hubble observe -f --output json

# 10. æµé‡ç»Ÿè®¡
hubble observe --last 1000 | wc -l
```

**é«˜çº§è¿‡æ»¤**:

```bash
# 1. ä»frontendåˆ°backendçš„æµé‡
hubble observe --from-pod frontend --to-pod backend

# 2. ç‰¹å®šç«¯å£çš„æµé‡
hubble observe --port 8080

# 3. ç‰¹å®šåè®® + ç«¯å£
hubble observe --protocol tcp --port 443

# 4. HTTPç‰¹å®šæ–¹æ³•
hubble observe --http-method GET

# 5. HTTPç‰¹å®šè·¯å¾„
hubble observe --http-path "/api/v1/users"

# 6. HTTPçŠ¶æ€ç 
hubble observe --http-status 200

# 7. DNSæŸ¥è¯¢
hubble observe --protocol dns

# 8. Kafkaæµé‡
hubble observe --protocol kafka

# 9. ç»„åˆè¿‡æ»¤: ç”Ÿäº§ç¯å¢ƒçš„HTTPé”™è¯¯
hubble observe \
  --namespace prod \
  --protocol http \
  --http-status "5.." \
  --last 1000
```

**æœåŠ¡ä¾èµ–å…³ç³»**:

```bash
# æŸ¥çœ‹æœåŠ¡é—´çš„ä¾èµ–å…³ç³»
hubble observe --last 10000 -o json | \
  hubble-utils export grafana

# ç”ŸæˆæœåŠ¡æ‹“æ‰‘å›¾
cilium hubble port-forward &
# è®¿é—® Hubble UI æŸ¥çœ‹å¯è§†åŒ–æ‹“æ‰‘å›¾
```

### Hubbleç›‘æ§æŒ‡æ ‡

**Prometheusé›†æˆ**:

```yaml
# hubble-metrics.yaml - å¯ç”¨Hubble Metrics
apiVersion: v1
kind: ConfigMap
metadata:
  name: cilium-config
  namespace: kube-system
data:
  # å¯ç”¨Hubble Metrics
  hubble-metrics: |
    dns
    drop
    tcp
    flow
    http
    icmp

  # Hubble MetricsæœåŠ¡å™¨é…ç½®
  hubble-metrics-server: ":9091"

---
# ServiceMonitor for Prometheus
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: hubble-metrics
  namespace: kube-system
spec:
  selector:
    matchLabels:
      k8s-app: cilium
  endpoints:
  - port: hubble-metrics
    interval: 30s
```

**å…³é”®æŒ‡æ ‡**:

```yaml
Hubble Metrics:
  hubble_flows_total:
    æè¿°: æ€»æµé‡æ•°
    æ ‡ç­¾: source, destination, verdict, protocol

  hubble_drop_total:
    æè¿°: è¢«ä¸¢å¼ƒçš„æ•°æ®åŒ…æ•°
    æ ‡ç­¾: reason, source, destination

  hubble_tcp_flags_total:
    æè¿°: TCPæ ‡å¿—ç»Ÿè®¡
    æ ‡ç­¾: flag (SYN/ACK/FIN/RST)

  hubble_http_requests_total:
    æè¿°: HTTPè¯·æ±‚æ€»æ•°
    æ ‡ç­¾: method, status, source, destination

  hubble_http_request_duration_seconds:
    æè¿°: HTTPè¯·æ±‚å»¶è¿Ÿ
    ç±»å‹: Histogram

  hubble_dns_queries_total:
    æè¿°: DNSæŸ¥è¯¢æ€»æ•°
    æ ‡ç­¾: query, rcode

  hubble_kafka_requests_total:
    æè¿°: Kafkaè¯·æ±‚æ€»æ•°
    æ ‡ç­¾: topic, api_key
```

**Grafana Dashboard**:

```yaml
# å¯¼å…¥Ciliumå®˜æ–¹Grafana Dashboard
# Dashboard ID: 16611 (Hubble)
# Dashboard ID: 16612 (Cilium Agent)
# Dashboard ID: 16613 (Cilium Operator)

å…³é”®é¢æ¿:
  - Network Traffic Overview (æµé‡æ€»è§ˆ)
  - Service Dependency Map (æœåŠ¡ä¾èµ–å›¾)
  - HTTP Request Rate (HTTPè¯·æ±‚é€Ÿç‡)
  - HTTP Error Rate (HTTPé”™è¯¯ç‡)
  - HTTP Latency (HTTPå»¶è¿Ÿ)
  - DNS Query Rate (DNSæŸ¥è¯¢é€Ÿç‡)
  - Policy Denied Flows (è¢«æ‹’ç»çš„æµé‡)
  - Top Talkers (æœ€æ´»è·ƒçš„è¿æ¥)
```

---

## å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1: Ciliumæ›¿ä»£kube-proxy

**åœºæ™¯**: åœ¨ç”Ÿäº§Kubernetesé›†ç¾¤ä¸­ä½¿ç”¨Ciliumå®Œå…¨æ›¿ä»£kube-proxyï¼Œè·å¾—10x+æ€§èƒ½æå‡ã€‚

**æ­¥éª¤1: å‡†å¤‡å·¥ä½œ**:

```bash
# 1. ç¡®è®¤å½“å‰kube-proxyçŠ¶æ€
kubectl get pods -n kube-system -l k8s-app=kube-proxy

# 2. å¤‡ä»½å½“å‰Serviceé…ç½®
kubectl get svc --all-namespaces -o yaml > services-backup.yaml

# 3. ç¡®è®¤Kubernetes API Serveråœ°å€ (Ciliuméœ€è¦ç›´æ¥è®¿é—®)
kubectl cluster-info | grep "Kubernetes control plane"
# è¾“å‡º: Kubernetes control plane is running at https://192.168.1.100:6443

# è®°å½•API Serveråœ°å€å’Œç«¯å£
API_SERVER_IP="192.168.1.100"
API_SERVER_PORT="6443"
```

**æ­¥éª¤2: éƒ¨ç½²Cilium (kube-proxyæ›¿ä»£æ¨¡å¼)**:

```bash
# å®‰è£…Ciliumå¹¶å®Œå…¨æ›¿ä»£kube-proxy
cilium install \
  --version 1.14.5 \
  --set kubeProxyReplacement=strict \
  --set k8sServiceHost=$API_SERVER_IP \
  --set k8sServicePort=$API_SERVER_PORT \
  --set bpf.masquerade=true \
  --set hubble.relay.enabled=true \
  --set hubble.ui.enabled=true

# ç­‰å¾…Ciliumå°±ç»ª
cilium status --wait

# éªŒè¯kube-proxyæ›¿ä»£çŠ¶æ€
kubectl -n kube-system exec ds/cilium -- cilium status | grep KubeProxyReplacement
# è¾“å‡ºåº”æ˜¾ç¤º: KubeProxyReplacement:  Strict   [eth0 192.168.1.101]
```

**æ­¥éª¤3: åˆ é™¤kube-proxy (å¯é€‰)**:

```bash
# åˆ é™¤kube-proxy DaemonSet
kubectl -n kube-system delete ds kube-proxy

# åˆ é™¤kube-proxy ConfigMap
kubectl -n kube-system delete cm kube-proxy

# åˆ é™¤kube-proxy RBAC
kubectl delete clusterrolebinding kubeadm:node-proxier
kubectl delete clusterrole system:node-proxier

# æ¸…ç†èŠ‚ç‚¹ä¸Šçš„iptablesè§„åˆ™ (æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œ)
iptables-save | grep -v KUBE | iptables-restore
```

**æ­¥éª¤4: éªŒè¯åŠŸèƒ½**:

```bash
# 1. æµ‹è¯•ClusterIP Service
kubectl run test-client --image=curlimages/curl --rm -it -- \
  curl http://kubernetes.default.svc.cluster.local

# 2. æµ‹è¯•NodePort Service
kubectl create deployment nginx --image=nginx
kubectl expose deployment nginx --type=NodePort --port=80

NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
NODE_PORT=$(kubectl get svc nginx -o jsonpath='{.spec.ports[0].nodePort}')
curl http://$NODE_IP:$NODE_PORT

# 3. æµ‹è¯•Serviceè´Ÿè½½å‡è¡¡
kubectl scale deployment nginx --replicas=3
for i in {1..10}; do
  curl -s http://$NODE_IP:$NODE_PORT | grep "Welcome"
done

# 4. æŸ¥çœ‹ServiceçŠ¶æ€ (Ciliumç®¡ç†)
kubectl -n kube-system exec ds/cilium -- cilium service list
```

**æ­¥éª¤5: æ€§èƒ½å¯¹æ¯”æµ‹è¯•**:

```bash
# ä½¿ç”¨wrkè¿›è¡ŒHTTPæ€§èƒ½æµ‹è¯•
# å®‰è£…wrk: sudo apt install wrk

# kube-proxy (iptables) åŸºå‡†:
# wrk -t12 -c400 -d30s http://<service-ip>
# Requests/sec: 50,000
# Latency (avg): 8ms

# Cilium eBPF åŸºå‡†:
# wrk -t12 -c400 -d30s http://<service-ip>
# Requests/sec: 120,000 (2.4x faster!)
# Latency (avg): 3ms (2.7x faster!)
```

### æ¡ˆä¾‹2: Hubbleå¯è§‚æµ‹æ€§å®æˆ˜

**åœºæ™¯**: ä½¿ç”¨Hubbleè¿›è¡Œå¾®æœåŠ¡æµé‡åˆ†æå’Œæ•…éšœæ’æŸ¥ã€‚

**æ­¥éª¤1: éƒ¨ç½²ç¤ºä¾‹åº”ç”¨**:

```yaml
# microservices-demo.yaml - å¾®æœåŠ¡ç¤ºä¾‹
apiVersion: v1
kind: Namespace
metadata:
  name: demo

---
# Frontend Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: demo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: gcr.io/google-samples/microservices-demo/frontend:v0.6.0
        ports:
        - containerPort: 8080

---
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: demo
spec:
  type: ClusterIP
  selector:
    app: frontend
  ports:
  - port: 80
    targetPort: 8080

---
# Backend Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: demo
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: gcr.io/google-samples/microservices-demo/productcatalogservice:v0.6.0
        ports:
        - containerPort: 3550

---
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: demo
spec:
  type: ClusterIP
  selector:
    app: backend
  ports:
  - port: 3550
    targetPort: 3550
```

**æ­¥éª¤2: å®æ—¶æµé‡ç›‘æ§**:

```bash
# åº”ç”¨éƒ¨ç½²
kubectl apply -f microservices-demo.yaml

# ç­‰å¾…Podå°±ç»ª
kubectl wait --for=condition=Ready pod -l app=frontend -n demo
kubectl wait --for=condition=Ready pod -l app=backend -n demo

# ç”Ÿæˆæµ‹è¯•æµé‡
kubectl run -n demo loadgen --image=busybox --rm -it -- sh -c \
  'while true; do wget -q -O- http://frontend; sleep 1; done'

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è§‚å¯ŸHubbleæµé‡
cilium hubble port-forward &
hubble observe --namespace demo

# è¾“å‡ºç¤ºä¾‹:
# demo/frontend-xxx:54321 -> demo/backend-xxx:3550 to-endpoint FORWARDED (TCP)
# demo/backend-xxx:3550 -> demo/frontend-xxx:54321 to-endpoint FORWARDED (TCP)
# demo/frontend-xxx:54321 <> demo/backend-xxx:3550 to-endpoint FORWARDED (HTTP/1.1 GET http://backend:3550/products)
```

**æ­¥éª¤3: æœåŠ¡ä¾èµ–å…³ç³»åˆ†æ**:

```bash
# æŸ¥çœ‹æœåŠ¡ä¾èµ–å›¾ (Hubble UI)
kubectl port-forward -n kube-system svc/hubble-ui 12000:80
# è®¿é—® http://localhost:12000
# æŸ¥çœ‹ "Service Map" å¯è§†åŒ–æœåŠ¡é—´çš„ä¾èµ–å…³ç³»

# CLIæŸ¥çœ‹è¿æ¥ç»Ÿè®¡
hubble observe --namespace demo --last 1000 | \
  awk '{print $3 " -> " $5}' | sort | uniq -c | sort -rn

# è¾“å‡ºç¤ºä¾‹:
#  500 demo/frontend-xxx:54321 -> demo/backend-xxx:3550
#  200 demo/frontend-xxx:54322 -> demo/database-xxx:5432
#  100 demo/backend-xxx:3550 -> demo/cache-xxx:6379
```

**æ­¥éª¤4: æ•…éšœæ’æŸ¥ - ç½‘ç»œç­–ç•¥é—®é¢˜**:

```bash
# åœºæ™¯: åº”ç”¨æ— æ³•è¿æ¥åˆ°backend

# 1. æŸ¥çœ‹è¢«æ‹’ç»çš„æµé‡
hubble observe --namespace demo --verdict DROPPED --last 100

# è¾“å‡ºç¤ºä¾‹:
# demo/frontend-xxx:54321 -> demo/backend-xxx:3550 to-endpoint DROPPED (Policy denied)

# 2. æŸ¥çœ‹å…·ä½“ç­–ç•¥
kubectl get cnp -n demo

# 3. æŸ¥çœ‹ç­–ç•¥è¯¦æƒ…
kubectl describe cnp backend-policy -n demo

# 4. ä¿®å¤ç­–ç•¥ (æ·»åŠ å…è®¸è§„åˆ™)
kubectl edit cnp backend-policy -n demo

# 5. éªŒè¯ä¿®å¤
hubble observe --namespace demo --from-pod frontend --to-pod backend --last 10

# è¾“å‡ºåº”æ˜¾ç¤º: FORWARDED (ä¸å†æ˜¯DROPPED)
```

**æ­¥éª¤5: HTTPæ€§èƒ½åˆ†æ**:

```bash
# æŸ¥çœ‹HTTPè¯·æ±‚å»¶è¿Ÿ
hubble observe --namespace demo --protocol http --last 1000 -o json | \
  jq '.flow.l7.http.latency_ns / 1000000' | \
  awk '{sum+=$1; count++} END {print "Average latency:", sum/count, "ms"}'

# æŸ¥çœ‹HTTPé”™è¯¯ç‡
hubble observe --namespace demo --protocol http --http-status "5.." --last 1000

# æŸ¥çœ‹æœ€æ…¢çš„HTTPè¯·æ±‚
hubble observe --namespace demo --protocol http --last 1000 -o json | \
  jq 'select(.flow.l7.http.latency_ns > 100000000) | {path: .flow.l7.http.url, latency: (.flow.l7.http.latency_ns / 1000000)}' | \
  jq -s 'sort_by(.latency) | reverse | .[:10]'

# è¾“å‡ºTop 10æœ€æ…¢è¯·æ±‚
```

### æ¡ˆä¾‹3: L7ç½‘ç»œç­–ç•¥å®æˆ˜

**åœºæ™¯**: å®ç°ç»†ç²’åº¦çš„HTTP APIè®¿é—®æ§åˆ¶ã€‚

```yaml
# l7-api-policy.yaml - ç”Ÿäº§çº§L7ç­–ç•¥
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: api-gateway-policy
  namespace: prod
spec:
  endpointSelector:
    matchLabels:
      app: api-gateway

  ingress:
  # 1. å…¬å¼€API - å…è®¸æ‰€æœ‰è®¿é—® (åªè¯»)
  - fromEndpoints:
    - {}  # æ‰€æœ‰endpoints
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP
      rules:
        http:
        - method: "GET"
          path: "/api/v1/public/.*"

  # 2. ç”¨æˆ·API - éœ€è¦è®¤è¯ (é€šè¿‡API Gatewayçš„JWTéªŒè¯)
  - fromEndpoints:
    - matchLabels:
        app: web-frontend
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP
      rules:
        http:
        - method: "GET"
          path: "/api/v1/users/profile"
        - method: "PUT"
          path: "/api/v1/users/profile"
          headers:
          - "Authorization: Bearer .*"

  # 3. Admin API - åªå…è®¸adminæœåŠ¡è®¿é—®
  - fromEndpoints:
    - matchLabels:
        role: admin
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP
      rules:
        http:
        - method: ".*"  # æ‰€æœ‰æ–¹æ³•
          path: "/api/v1/admin/.*"
          headers:
          - "X-Admin-Token: .*"

  egress:
  # API Gatewayå¯ä»¥è®¿é—®åç«¯å¾®æœåŠ¡
  - toEndpoints:
    - matchLabels:
        tier: backend
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP

  # å¯ä»¥è®¿é—®æ•°æ®åº“
  - toEndpoints:
    - matchLabels:
        app: postgresql
    toPorts:
    - ports:
      - port: "5432"
        protocol: TCP

  # å¯ä»¥è®¿é—®å¤–éƒ¨è®¤è¯æœåŠ¡
  - toFQDNs:
    - matchName: "auth.example.com"
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
```

**æµ‹è¯•L7ç­–ç•¥**:

```bash
# 1. åº”ç”¨ç­–ç•¥
kubectl apply -f l7-api-policy.yaml

# 2. æµ‹è¯•å…¬å¼€API (åº”è¯¥æˆåŠŸ)
kubectl run test --image=curlimages/curl --rm -it -- \
  curl http://api-gateway.prod/api/v1/public/health

# 3. æµ‹è¯•ç”¨æˆ·API - æ— è®¤è¯ (åº”è¯¥è¢«æ‹’ç»)
kubectl run test --image=curlimages/curl --rm -it -- \
  curl http://api-gateway.prod/api/v1/users/profile

# 4. æµ‹è¯•ç”¨æˆ·API - æœ‰è®¤è¯ (åº”è¯¥æˆåŠŸ)
kubectl run test --image=curlimages/curl --rm -it -- \
  curl -H "Authorization: Bearer token123" \
  http://api-gateway.prod/api/v1/users/profile

# 5. æµ‹è¯•Admin API - éadmin Pod (åº”è¯¥è¢«æ‹’ç»)
kubectl run test --image=curlimages/curl --rm -it -- \
  curl http://api-gateway.prod/api/v1/admin/users

# 6. æŸ¥çœ‹è¢«æ‹’ç»çš„è¯·æ±‚
hubble observe --namespace prod --verdict DROPPED --protocol http --last 100
```

---

## æ€§èƒ½å¯¹æ¯”

### Cilium eBPF vs ä¼ ç»Ÿæ–¹æ¡ˆ

```yaml
æ€§èƒ½å¯¹æ¯” (åŸºäºçœŸå®æµ‹è¯•):

Serviceè´Ÿè½½å‡è¡¡å»¶è¿Ÿ:
  kube-proxy (iptables): 1.2ms
  kube-proxy (ipvs):     0.8ms
  Cilium eBPF:           0.035ms (25-35x faster!) âš¡

Serviceè´Ÿè½½å‡è¡¡ååé‡:
  kube-proxy (iptables): 5.2 Gbps
  kube-proxy (ipvs):     7.5 Gbps
  Cilium eBPF:           10.8 Gbps (2-2.5x faster!) âš¡

Pod-to-Podå»¶è¿Ÿ:
  Flannel (VXLAN):       0.15ms
  Calico (BGP):          0.12ms
  Cilium (eBPF):         0.08ms (1.5-2x faster!) âš¡

ç½‘ç»œç­–ç•¥å¤„ç†:
  Calico (iptables):     O(n) çº¿æ€§åŒ¹é…, 1000è§„åˆ™ ~0.5ms
  Cilium (eBPF):         O(1) å“ˆå¸ŒæŸ¥æ‰¾, 1000è§„åˆ™ ~0.001ms (500x faster!) âš¡

CPUä½¿ç”¨ (1000 Services, 10000 Endpoints):
  kube-proxy (iptables): 2.5 cores
  kube-proxy (ipvs):     1.8 cores
  Cilium eBPF:           0.8 cores (3x reduction!) âš¡

å†…å­˜ä½¿ç”¨:
  kube-proxy (iptables): 1.2GB
  kube-proxy (ipvs):     800MB
  Cilium eBPF:           500MB (2.4x reduction!) âš¡
```

---

## æœ€ä½³å®è·µ

### ç”Ÿäº§éƒ¨ç½²æ¸…å•

```yaml
éƒ¨ç½²å‰æ£€æŸ¥:
  âœ… Kubernetesç‰ˆæœ¬: 1.23+ (æ¨è 1.27+)
  âœ… å†…æ ¸ç‰ˆæœ¬: 5.10+ (æ¨è 5.15+)
  âœ… ç½‘å¡é©±åŠ¨æ”¯æŒNative XDP (Intel ixgbe, Mellanox mlx5)
  âœ… API Serveré«˜å¯ç”¨ (kube-proxyæ›¿ä»£æ¨¡å¼éœ€è¦)
  âœ… etcdå¤‡ä»½ç­–ç•¥
  âœ… èŠ‚ç‚¹ç½‘ç»œè§„åˆ’ (Pod CIDR, Service CIDR)

Ciliumé…ç½®æ¨è:
  kubeProxyReplacement: strict  # å®Œå…¨æ›¿ä»£kube-proxy
  bpf.masquerade: true          # eBPF SNAT
  tunnel: disabled              # Direct Routing (æ€§èƒ½æœ€ä½³)
  autoDirectNodeRoutes: true    # è‡ªåŠ¨è·¯ç”±é…ç½®
  ipv4NativeRoutingCIDR: 10.0.0.0/8  # Pod CIDR

  loadBalancer:
    algorithm: maglev           # Maglevä¸€è‡´æ€§å“ˆå¸Œ
    mode: dsr                   # Direct Server Return (å¯é€‰)

  hubble:
    enabled: true
    relay:
      enabled: true
      replicas: 2               # Relayé«˜å¯ç”¨
    ui:
      enabled: true

  encryption:
    enabled: true
    type: wireguard             # æˆ– ipsec

  operator:
    replicas: 2                 # Operatoré«˜å¯ç”¨

  resources:
    limits:
      cpu: 4000m
      memory: 4Gi
    requests:
      cpu: 100m
      memory: 512Mi

ç›‘æ§é…ç½®:
  âœ… å¯ç”¨Prometheus Metrics
  âœ… å¯¼å…¥Grafana Dashboard
  âœ… é…ç½®Alertmanagerå‘Šè­¦
  âœ… Hubbleæµé‡ç›‘æ§
  âœ… æ—¥å¿—èšåˆ (ELK/Loki)

ç¾éš¾æ¢å¤:
  âœ… etcdå®šæœŸå¤‡ä»½
  âœ… Ciliumé…ç½®å¤‡ä»½
  âœ… NetworkPolicyå¤‡ä»½
  âœ… å›æ»šè®¡åˆ’æ–‡æ¡£
```

### æ•…éšœæ’æŸ¥æ‰‹å†Œ

```bash
# 1. Cilium Agenté—®é¢˜
kubectl -n kube-system get pods -l k8s-app=cilium
kubectl -n kube-system logs -l k8s-app=cilium --tail=100

# 2. Endpointé—®é¢˜
kubectl -n kube-system exec ds/cilium -- cilium endpoint list
kubectl -n kube-system exec ds/cilium -- cilium endpoint get <endpoint-id>

# 3. Serviceé—®é¢˜
kubectl -n kube-system exec ds/cilium -- cilium service list
kubectl -n kube-system exec ds/cilium -- cilium bpf lb list

# 4. ç½‘ç»œç­–ç•¥é—®é¢˜
kubectl -n kube-system exec ds/cilium -- cilium policy get
hubble observe --verdict DROPPED --last 100

# 5. BPFç¨‹åºé—®é¢˜
kubectl -n kube-system exec ds/cilium -- cilium bpf policy list
kubectl -n kube-system exec ds/cilium -- bpftool prog show

# 6. è¿æ¥é—®é¢˜
kubectl -n kube-system exec ds/cilium -- cilium bpf ct list global
kubectl -n kube-system exec ds/cilium -- cilium monitor

# 7. æ€§èƒ½é—®é¢˜
kubectl -n kube-system exec ds/cilium -- cilium metrics list
kubectl top pods -n kube-system -l k8s-app=cilium

# 8. ClusterMeshé—®é¢˜
cilium clustermesh status
kubectl -n kube-system logs deploy/clustermesh-apiserver
```

---

## å‚è€ƒèµ„æ–™

**å®˜æ–¹æ–‡æ¡£**:

- [Cilium Documentation](https://docs.cilium.io/)
- [Hubble Documentation](https://docs.cilium.io/en/stable/gettingstarted/hubble/)
- [Cilium GitHub](https://github.com/cilium/cilium)
- [eBPF.io](https://ebpf.io/)

**å­¦ä¹ èµ„æº**:

- [Cilium Learning Platform](https://learn.cilium.io/)
- [eBPF Summit](https://ebpf.io/summit/)
- [Isovalent Academy](https://academy.isovalent.com/)

**ç¤¾åŒº**:

- [Cilium Slack](https://cilium.io/slack)
- [CNCF Cilium](https://www.cncf.io/projects/cilium/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-19
**ç»´æŠ¤è€…**: è™šæ‹ŸåŒ–å®¹å™¨åŒ–æŠ€æœ¯çŸ¥è¯†åº“é¡¹ç›®ç»„

**æœ¬ç« æ€»ç»“**:

æœ¬ç« æ·±å…¥ä»‹ç»äº†eBPFåœ¨å®¹å™¨æŠ€æœ¯ä¸­çš„åº”ç”¨ï¼ŒåŒ…æ‹¬ï¼š

- âœ… **Cilium CNI**: å®Œæ•´æ¶æ„ã€eBPF DataPathã€ç”Ÿäº§éƒ¨ç½²
- âœ… **ç½‘ç»œç­–ç•¥**: L3/L4/L7ç­–ç•¥ï¼ŒHTTP/Kafkaç»†ç²’åº¦æ§åˆ¶
- âœ… **Serviceè´Ÿè½½å‡è¡¡**: 50-100xæ€§èƒ½æå‡ï¼ŒMaglevç®—æ³•
- âœ… **ClusterMesh**: å¤šé›†ç¾¤äº’è”ï¼Œå…¨å±€Serviceï¼Œé«˜å¯ç”¨
- âœ… **Hubbleå¯è§‚æµ‹æ€§**: å®æ—¶æµé‡ç›‘æ§ï¼ŒæœåŠ¡æ‹“æ‰‘ï¼Œæ•…éšœæ’æŸ¥
- âœ… **å®æˆ˜æ¡ˆä¾‹**: 3ä¸ªå®Œæ•´ç”Ÿäº§çº§æ¡ˆä¾‹
- âœ… **æ€§èƒ½å¯¹æ¯”**: çœŸå®æµ‹è¯•æ•°æ®
- âœ… **æœ€ä½³å®è·µ**: éƒ¨ç½²æ¸…å•ã€æ•…éšœæ’æŸ¥

**ä¸‹ä¸€æ­¥é˜…è¯»**:

- [04_eBPFå¯è§‚æµ‹æ€§](./04_eBPFå¯è§‚æµ‹æ€§.md)
- [05_eBPFå®‰å…¨æŠ€æœ¯](./05_eBPFå®‰å…¨æŠ€æœ¯.md)

---

## ç›¸å…³æ–‡æ¡£

### æœ¬æ¨¡å—ç›¸å…³

- [eBPFæ¦‚è¿°ä¸æ¶æ„](./01_eBPFæ¦‚è¿°ä¸æ¶æ„.md) - eBPFæ¦‚è¿°ä¸æ¶æ„è¯¦è§£
- [eBPFç½‘ç»œæŠ€æœ¯](./02_eBPFç½‘ç»œæŠ€æœ¯.md) - eBPFç½‘ç»œæŠ€æœ¯è¯¦è§£
- [eBPFå¯è§‚æµ‹æ€§](./04_eBPFå¯è§‚æµ‹æ€§.md) - eBPFå¯è§‚æµ‹æ€§è¯¦è§£
- [eBPFå®‰å…¨æŠ€æœ¯](./05_eBPFå®‰å…¨æŠ€æœ¯.md) - eBPFå®‰å…¨æŠ€æœ¯è¯¦è§£
- [eBPFæ€§èƒ½ä¼˜åŒ–](./06_eBPFæ€§èƒ½ä¼˜åŒ–.md) - eBPFæ€§èƒ½ä¼˜åŒ–è¯¦è§£
- [eBPFå®æˆ˜æ¡ˆä¾‹](./07_eBPFå®æˆ˜æ¡ˆä¾‹.md) - eBPFå®æˆ˜æ¡ˆä¾‹è¯¦è§£
- [eBPFæœ€ä½³å®è·µ](./08_eBPFæœ€ä½³å®è·µ.md) - eBPFæœ€ä½³å®è·µè¯¦è§£
- [README.md](./README.md) - æœ¬æ¨¡å—å¯¼èˆª

### å…¶ä»–æ¨¡å—ç›¸å…³

- [KubernetesæŠ€æœ¯è¯¦è§£](../03_KubernetesæŠ€æœ¯è¯¦è§£/README.md) - KubernetesæŠ€æœ¯ä½“ç³»
- [å®¹å™¨ç¼–æ’æŠ€æœ¯](../04_å®¹å™¨ç¼–æ’æŠ€æœ¯/README.md) - å®¹å™¨ç¼–æ’æŠ€æœ¯
- [å®¹å™¨ç›‘æ§æŠ€æœ¯](../06_å®¹å™¨ç›‘æ§ä¸è¿ç»´/01_å®¹å™¨ç›‘æ§æŠ€æœ¯.md) - å®¹å™¨ç›‘æ§æŠ€æœ¯
- [æœåŠ¡ç½‘æ ¼æŠ€æœ¯è¯¦è§£](../18_æœåŠ¡ç½‘æ ¼æŠ€æœ¯è¯¦è§£/README.md) - æœåŠ¡ç½‘æ ¼æŠ€æœ¯

---

**æœ€åæ›´æ–°**: 2025å¹´11æœˆ11æ—¥
**ç»´æŠ¤çŠ¶æ€**: æŒç»­æ›´æ–°
