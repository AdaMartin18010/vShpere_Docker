# 05 工作流编排（Scheduling & Orchestration）

## 目标

- 提供 Windows 计划任务与 Linux cron 的最小可复现实例
- 统一输出证据（CSV/JSON/日志/哈希/manifest）便于审计

## 证据与目录结构（统一约定）

```text
artifacts/
  YYYY-MM-DD/
    evidence.log            # 运行日志（含开始/结束时间、调用摘要、错误）
    manifest.json           # 元数据清单（变更单、脚本版本、哈希）
    manifest.sha256         # 清单哈希
    *.csv / *.json          # 各类导出资产/事件/配置
```

manifest.json（示例）：

```json
{
  "run_id": "2025-09-18T02:00:00Z",
  "change_id": "CHG-2025-0918-001",
  "script_version": "daily_audit.ps1@v1.2.0",
  "artifacts": [
    { "path": "hosts.csv", "sha256": "<hash>" },
    { "path": "tasks-yesterday.csv", "sha256": "<hash>" }
  ],
  "retention_days": 180,
  "status": "success"
}
```

## Windows 计划任务

```powershell
$action = New-ScheduledTaskAction -Execute 'pwsh.exe' -Argument '-File .\daily_audit.ps1'
$trigger = New-ScheduledTaskTrigger -Daily -At 02:00
Register-ScheduledTask -TaskName 'vSphereDailyAudit' -Action $action -Trigger $trigger -RunLevel Highest
```

示例 `daily_audit.ps1`（片段）：

```powershell
Start-Transcript -Path automation_run.log -Append
try {
  Connect-VIServer vcenter.example.com | Out-Null
  Get-VMHost | Select Name, Version, Build | Export-Csv hosts.csv -NoTypeInformation
  Get-Task -Start (Get-Date).AddDays(-1) | Export-Csv tasks-yesterday.csv -NoTypeInformation
  $date = Get-Date -Format 'yyyy-MM-dd'
  New-Item -ItemType Directory -Force -Path "artifacts/$date" | Out-Null
  foreach ($f in 'hosts.csv','tasks-yesterday.csv') {
    if (Test-Path $f) {
      Get-FileHash -Algorithm SHA256 $f | Select Hash | Set-Content "artifacts/$date/$f.sha256"
      Move-Item $f "artifacts/$date/"
    }
  }
  $manifest = @{ run_id = (Get-Date).ToString('s'); change_id = $env:CHANGE_ID; script_version = 'daily_audit.ps1@v1.2.0'; artifacts = @(); retention_days = 180; status = 'success' }
  foreach ($f in 'hosts.csv','tasks-yesterday.csv') {
    $p = "artifacts/$date/$f"
    if (Test-Path $p) {
      $h = (Get-FileHash -Algorithm SHA256 $p).Hash
      $manifest.artifacts += @{ path = $f; sha256 = $h }
    }
  }
  $mf = "artifacts/$date/manifest.json"
  $manifest | ConvertTo-Json -Depth 5 | Set-Content $mf -Encoding UTF8
  (Get-FileHash -Algorithm SHA256 $mf).Hash | Set-Content "artifacts/$date/manifest.sha256"
}
finally {
  Stop-Transcript | Out-Null
}
```

## Linux cron

```bash
crontab -e
# 每日 02:00 执行并输出到日志
0 2 * * * /usr/bin/pwsh -File /opt/vsphere/daily_audit.ps1 >> /opt/vsphere/automation.log 2>&1
```

健康检查（可选）：

```bash
# 确认最近一次运行时间不早于 26 小时
test $(date +%s) -lt $(($(stat -c%Y /opt/vsphere/automation.log) + 26*3600)) || echo "cron delay detected" >&2
```

## 工作流蓝图（示例）

- 批量基线巡检 → 生成差异报告 → 推送合规模块
- 成本优化迁移 → 按标签筛选低优先级 VM → 窗口迁移
- 证据流水线 → 资产/事件导出 → 归档与哈希 → manifest 生成

## 参考

- `01_自动化基础.md`、`02_PowerCLI技术.md`、`04_API集成开发.md`

## 故障处理与回滚（新增）

- 连接失败：验证 DNS/NTP/证书；脚本中捕获异常并记录 `$Error[0]` 至 evidence.log
- 导出失败：逐步降级为查询较小窗口；必要时标记 `status=partial`
- 回滚：仅读操作无回滚；若包含 Day-2 变更，需记录变更单并提供逆操作脚本引用

## 保留与合规（新增）

- 保留期：默认 180 天，可在环境变量 `RETENTION_DAYS` 中覆盖
- 目录轮转：按日期目录，定期压缩到长期存储；保留哈希与 manifest
