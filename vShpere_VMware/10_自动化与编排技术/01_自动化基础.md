# 01 自动化基础（Foundations of Automation）

## 目标

- 建立适用于 vSphere 的自动化方法论与实践框架（可复现）
- 定义最小可用工具链：PowerShell/PowerCLI、REST API、计划任务
- 输出标准化工件：CSV/JSON、manifest、SHA256 校验与留存目录

## 方法论（最小闭环）

1. 版本化与评审：脚本纳入 Git；PR 审批；关联变更单（TicketId）
2. 参数化与环境隔离：使用参数文件/变量；区分 Dev/Prod 输出目录
3. 最小权限：只读/运维分权；避免明文密码（凭据库/凭据管理器）
4. 可审计输出：统一落盘 CSV/JSON + `.sha256` + `manifest.json`
5. 调度与告警：计划任务/CI 定时；失败自动告警；回滚脚本同行

## 前置条件

- PowerShell 7+（或 Windows PowerShell 5.1+）
- VMware.PowerCLI 模块（可离线导入）
- vCenter 可达，具备只读或最小必要权限账号

## 快速开始（可执行）

```powershell
# 1) 连接 vCenter（建议凭据安全存储）
Connect-VIServer -Server vcenter.example.com

# 2) 导出资产清单
Get-VMHost | Select-Object Name, Version, Build |
  Export-Csv hosts.csv -NoTypeInformation
Get-VM | Select-Object Name, PowerState, NumCpu, MemoryMB |
  Export-Csv vms.csv -NoTypeInformation

# 3) 生成哈希并归档
$date = Get-Date -Format 'yyyy-MM-dd'
New-Item -ItemType Directory -Force -Path "artifacts/$date" | Out-Null
Get-FileHash -Algorithm SHA256 hosts.csv | Select Hash | Set-Content "artifacts/$date/hosts.csv.sha256"
Get-FileHash -Algorithm SHA256 vms.csv   | Select Hash | Set-Content "artifacts/$date/vms.csv.sha256"
Move-Item hosts.csv "artifacts/$date/"
Move-Item vms.csv   "artifacts/$date/"

# 4) 生成 manifest.json（简版）
$manifest = [pscustomobject]@{
  generatedAt   = (Get-Date).ToString('s')
  generatedBy   = 'PowerCLI'
  retentionDays = 180
  artifacts     = @(
    @{ name = 'hosts.csv'; sha256 = (Get-Content "artifacts/$date/hosts.csv.sha256").Trim() },
    @{ name = 'vms.csv';   sha256 = (Get-Content "artifacts/$date/vms.csv.sha256").Trim() }
  )
} | ConvertTo-Json -Depth 5
$manifest | Set-Content "artifacts/$date/manifest.json"
```

## 计划任务（Windows）

```powershell
$action = New-ScheduledTaskAction -Execute 'pwsh.exe' -Argument '-File .\\daily_audit.ps1'
$trigger = New-ScheduledTaskTrigger -Daily -At 02:00
Register-ScheduledTask -TaskName 'vSphereDailyAudit' -Action $action -Trigger $trigger -RunLevel Highest
```

示例 `daily_audit.ps1`（与上文导出步骤一致），输出统一归档至 `artifacts/$date/`。

## 安全与合规要点

- 不在脚本中硬编码口令；使用凭据管理器或企业密码库
- 记录 TicketId 与执行人；产出哈希与 manifest 以支持审计
- 对关键证据使用不可变留存（WORM/快照只读）

## 参考

- `../09_安全与合规管理/Checklist_基线清单.md`
- `../09_安全与合规管理/Runbook_审计与变更操作.md`
- `../09_安全与合规管理/Templates_证据与对标映射.md`
