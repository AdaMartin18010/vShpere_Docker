# 网络安全管理与微隔离（NSX 最佳实践）

## 目录

- [网络安全管理与微隔离（NSX 最佳实践）](#网络安全管理与微隔离nsx-最佳实践)
  - [目录](#目录)
  - [1. 目标](#1-目标)
  - [2. 设计原则](#2-设计原则)
  - [3. 微隔离步骤（示例）](#3-微隔离步骤示例)
  - [4. 策略样例（伪）](#4-策略样例伪)
  - [5. 日志与证据](#5-日志与证据)
  - [6. 变更与回滚](#6-变更与回滚)
  - [7. 交叉链接](#7-交叉链接)
  - [8. 前置条件与版本兼容（新增）](#8-前置条件与版本兼容新增)
  - [9. 常见陷阱与案例（新增）](#9-常见陷阱与案例新增)

## 1. 目标

- 提供 NSX 基于意图的安全策略与微隔离落地方法，覆盖分段、标签、策略与证据

## 2. 设计原则

- 零信任分段：按环境、功能、敏感度分区（如 env/tier/app）
- 标签优先：以标签驱动安全组与策略（避免硬编码IP）
- 最小权限：默认拒绝，按服务白名单放行；临时放行需时限与审计

## 3. 微隔离步骤（示例）

1) 资产与流量盘点：业务拓扑与端口清单、东西向流量基线
2) 标签体系：`env=prod|dev`、`tier=web|app|db`、`app=<name>`
3) 安全组：基于标签动态收敛对象（VM/Segment）
4) 分布式防火墙策略：自上而下（环境→层次→应用特例），默认拒绝
5) 例外与临时策略：变更单驱动，含到期自动回收

## 4. 策略样例（伪）

```text
Section: Prod-Tier
  Rule: Allow-Web-to-App
    Source: tag(env=prod,tier=web)
    Destination: tag(env=prod,tier=app)
    Service: HTTP/HTTPS
    Action: Allow (Log)

  Rule: Allow-App-to-DB
    Source: tag(env=prod,tier=app)
    Destination: tag(env=prod,tier=db)
    Service: 3306/TCP
    Action: Allow (Log)

  Rule: Default-Deny
    Source: Any
    Destination: Any
    Service: Any
    Action: Drop (Log)
```

## 5. 日志与证据

- 启用规则命中日志，输出到集中日志/Siem；保留 ≥90 天
- 每次发布导出策略快照与命中 Top-N，归档 `artifacts/`（含 SHA256 与 manifest）

## 6. 变更与回滚

- 变更单驱动策略发布；预检命中影响评估；失败自动回滚到上版本策略集

## 7. 交叉链接

- `../09_安全与合规管理/Checklist_基线清单.md`
- `../10_自动化与编排技术/03_vRealize Automation.md`（标签与约束一致）

### 7.1 与 K8s NetworkPolicy 的策略映射（新增）

- 术语对齐：NSX 标签/安全组 ↔ K8s Label/NamespaceSelector；DFW 规则 ↔ NetworkPolicy 规则。
- 映射建议：
  - 环境与层次：`env/tier/app` 标签在 vSphere/Tanzu/K8s 保持一致。
  - 东西向允许清单：NSX `Allow-Web-to-App` ↔ K8s `from: podSelector: tier=web`。
  - 默认拒绝：NSX Default-Deny ↔ K8s `policyTypes: [Ingress,Egress]` 且空白名单。
- 证据目录：K8s 策略与审计请归档至 `artifacts/YYYY-MM-DD/runtime/policies/`、`runtime/audit/`，结构参见 `../09_安全与合规管理/Artifacts_Index.md`。

## 8. 前置条件与版本兼容（新增）

- NSX 版本与 vCenter/ESXi 兼容矩阵确认通过
- 标签/命名规范一致：env/tier/app 必须与 vSphere/Tanzu 一致
- 日志与审计：DFW 命中日志转发已启用，集中存储可达

## 9. 常见陷阱与案例（新增）

- 默认拒绝前未放行必要基础服务（DNS/NTP/身份），导致应用中断
- 标签不一致导致策略未命中：规范不一致或拼写错误
- 临时放行未设置到期：长期遗留造成面策略失效，需自动回收
